Directory structure:
â””â”€â”€ learnhouse-learnhouse/
    â”œâ”€â”€ README.md
    â”œâ”€â”€ CONTRIBUTING.md
    â”œâ”€â”€ Dockerfile
    â”œâ”€â”€ LICENSE
    â”œâ”€â”€ package.json
    â”œâ”€â”€ pnpm-lock.yaml
    â”œâ”€â”€ pnpm-workspace.yaml
    â”œâ”€â”€ turbo.json
    â”œâ”€â”€ .dockerignore
    â”œâ”€â”€ .npmrc
    â”œâ”€â”€ apps/
    â”‚   â”œâ”€â”€ api/
    â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”œâ”€â”€ alembic.ini
    â”‚   â”‚   â”œâ”€â”€ app.py
    â”‚   â”‚   â”œâ”€â”€ cli.py
    â”‚   â”‚   â”œâ”€â”€ docker-entrypoint.sh
    â”‚   â”‚   â”œâ”€â”€ Dockerfile
    â”‚   â”‚   â”œâ”€â”€ pyproject.toml
    â”‚   â”‚   â”œâ”€â”€ config/
    â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ config.py
    â”‚   â”‚   â”‚   â””â”€â”€ config.yaml
    â”‚   â”‚   â”œâ”€â”€ content/
    â”‚   â”‚   â”‚   â””â”€â”€ __init__.py
    â”‚   â”‚   â”œâ”€â”€ migrations/
    â”‚   â”‚   â”‚   â”œâ”€â”€ env.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ script.py.mako
    â”‚   â”‚   â”‚   â”œâ”€â”€ orgconfigs/
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ orgconfigs_migrations.py
    â”‚   â”‚   â”‚   â””â”€â”€ versions/
    â”‚   â”‚   â”‚       â”œâ”€â”€ 0314ec7791e1_payments.py
    â”‚   â”‚   â”‚       â”œâ”€â”€ 040ccb1d456e_add_thumbnail_image_to_orgs.py
    â”‚   â”‚   â”‚       â”œâ”€â”€ 4a88b680263c_multi_contributors.py
    â”‚   â”‚   â”‚       â”œâ”€â”€ 6295e05ff7d0_enum_updates.py
    â”‚   â”‚   â”‚       â”œâ”€â”€ 83b6d9d6f57a_org_ids_cascades.py
    â”‚   â”‚   â”‚       â”œâ”€â”€ 87a621284ae4_organizations_new_model.py
    â”‚   â”‚   â”‚       â”œâ”€â”€ 9e031a0358d1_video_thumbnails.py
    â”‚   â”‚   â”‚       â”œâ”€â”€ a5afa69dd917_activity_details.py
    â”‚   â”‚   â”‚       â”œâ”€â”€ adb944cc8bec_add_users_details_and_profile.py
    â”‚   â”‚   â”‚       â”œâ”€â”€ cb2029aadc2d_cloud_changes.py
    â”‚   â”‚   â”‚       â”œâ”€â”€ d8bc71595932_add_reference_for_assignmenttasks.py
    â”‚   â”‚   â”‚       â”œâ”€â”€ df2981bf24dd_initial_migration.py
    â”‚   â”‚   â”‚       â””â”€â”€ eb10d15465b3_org_scripts.py
    â”‚   â”‚   â””â”€â”€ src/
    â”‚   â”‚       â”œâ”€â”€ __init__.py
    â”‚   â”‚       â”œâ”€â”€ router.py
    â”‚   â”‚       â”œâ”€â”€ core/
    â”‚   â”‚       â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚       â”‚   â””â”€â”€ events/
    â”‚   â”‚       â”‚       â”œâ”€â”€ __init__.py
    â”‚   â”‚       â”‚       â”œâ”€â”€ autoinstall.py
    â”‚   â”‚       â”‚       â”œâ”€â”€ content.py
    â”‚   â”‚       â”‚       â”œâ”€â”€ database.py
    â”‚   â”‚       â”‚       â”œâ”€â”€ events.py
    â”‚   â”‚       â”‚       â””â”€â”€ logs.py
    â”‚   â”‚       â”œâ”€â”€ db/
    â”‚   â”‚       â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ collections.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ collections_courses.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ organization_config.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ organizations.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ resource_authors.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ roles.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ trail_runs.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ trail_steps.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ trails.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ user_organizations.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ usergroup_resources.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ usergroup_user.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ usergroups.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ users.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ courses/
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ activities.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ assignments.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ blocks.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ certifications.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ chapter_activities.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ chapters.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ course_chapters.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ course_updates.py
    â”‚   â”‚       â”‚   â”‚   â””â”€â”€ courses.py
    â”‚   â”‚       â”‚   â””â”€â”€ payments/
    â”‚   â”‚       â”‚       â”œâ”€â”€ payments.py
    â”‚   â”‚       â”‚       â”œâ”€â”€ payments_courses.py
    â”‚   â”‚       â”‚       â”œâ”€â”€ payments_products.py
    â”‚   â”‚       â”‚       â””â”€â”€ payments_users.py
    â”‚   â”‚       â”œâ”€â”€ routers/
    â”‚   â”‚       â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ auth.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ dev.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ health.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ orgs.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ roles.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ search.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ trail.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ usergroups.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ users.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ utils.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ ai/
    â”‚   â”‚       â”‚   â”‚   â””â”€â”€ ai.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ courses/
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ assignments.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ certifications.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ chapters.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ collections.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ courses.py
    â”‚   â”‚       â”‚   â”‚   â””â”€â”€ activities/
    â”‚   â”‚       â”‚   â”‚       â”œâ”€â”€ activities.py
    â”‚   â”‚       â”‚   â”‚       â””â”€â”€ blocks.py
    â”‚   â”‚       â”‚   â””â”€â”€ ee/
    â”‚   â”‚       â”‚       â”œâ”€â”€ cloud_internal.py
    â”‚   â”‚       â”‚       â””â”€â”€ payments.py
    â”‚   â”‚       â”œâ”€â”€ security/
    â”‚   â”‚       â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ auth.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ courses_security.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ file_validation.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ security.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ features_utils/
    â”‚   â”‚       â”‚   â”‚   â””â”€â”€ usage.py
    â”‚   â”‚       â”‚   â””â”€â”€ rbac/
    â”‚   â”‚       â”‚       â”œâ”€â”€ rbac.py
    â”‚   â”‚       â”‚       â””â”€â”€ utils.py
    â”‚   â”‚       â”œâ”€â”€ services/
    â”‚   â”‚       â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ ai/
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ ai.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ base.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ init.py
    â”‚   â”‚       â”‚   â”‚   â””â”€â”€ schemas/
    â”‚   â”‚       â”‚   â”‚       â””â”€â”€ ai.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ auth/
    â”‚   â”‚       â”‚   â”‚   â””â”€â”€ utils.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ blocks/
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ block_types/
    â”‚   â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ imageBlock/
    â”‚   â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ imageBlock.py
    â”‚   â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ pdfBlock/
    â”‚   â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ pdfBlock.py
    â”‚   â”‚       â”‚   â”‚   â”‚   â””â”€â”€ videoBlock/
    â”‚   â”‚       â”‚   â”‚   â”‚       â””â”€â”€ videoBlock.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ schemas/
    â”‚   â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ blocks.py
    â”‚   â”‚       â”‚   â”‚   â”‚   â””â”€â”€ files.py
    â”‚   â”‚       â”‚   â”‚   â””â”€â”€ utils/
    â”‚   â”‚       â”‚   â”‚       â””â”€â”€ upload_files.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ courses/
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ certifications.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ chapters.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ collections.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ contributors.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ courses.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ thumbnails.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ updates.py
    â”‚   â”‚       â”‚   â”‚   â””â”€â”€ activities/
    â”‚   â”‚       â”‚   â”‚       â”œâ”€â”€ activities.py
    â”‚   â”‚       â”‚   â”‚       â”œâ”€â”€ pdf.py
    â”‚   â”‚       â”‚   â”‚       â”œâ”€â”€ utils.py
    â”‚   â”‚       â”‚   â”‚       â”œâ”€â”€ video.py
    â”‚   â”‚       â”‚   â”‚       â””â”€â”€ uploads/
    â”‚   â”‚       â”‚   â”‚           â”œâ”€â”€ pdfs.py
    â”‚   â”‚       â”‚   â”‚           â”œâ”€â”€ sub_file.py
    â”‚   â”‚       â”‚   â”‚           â”œâ”€â”€ tasks_ref_files.py
    â”‚   â”‚       â”‚   â”‚           â””â”€â”€ videos.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ dev/
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚       â”‚   â”‚   â””â”€â”€ dev.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ email/
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚       â”‚   â”‚   â””â”€â”€ utils.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ explore/
    â”‚   â”‚       â”‚   â”‚   â””â”€â”€ explore.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ health/
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚       â”‚   â”‚   â””â”€â”€ health.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ orgs/
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ invites.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ join.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ orgs.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ uploads.py
    â”‚   â”‚       â”‚   â”‚   â””â”€â”€ users.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ payments/
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ payments_access.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ payments_config.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ payments_courses.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ payments_customers.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ payments_products.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ payments_stripe.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ payments_users.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ utils/
    â”‚   â”‚       â”‚   â”‚   â”‚   â””â”€â”€ stripe_utils.py
    â”‚   â”‚       â”‚   â”‚   â””â”€â”€ webhooks/
    â”‚   â”‚       â”‚   â”‚       â””â”€â”€ payments_webhooks.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ roles/
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚       â”‚   â”‚   â””â”€â”€ roles.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ search/
    â”‚   â”‚       â”‚   â”‚   â””â”€â”€ search.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ setup/
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚       â”‚   â”‚   â””â”€â”€ setup.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ trail/
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚       â”‚   â”‚   â””â”€â”€ trail.py
    â”‚   â”‚       â”‚   â”œâ”€â”€ users/
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ avatars.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ emails.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ password_reset.py
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ usergroups.py
    â”‚   â”‚       â”‚   â”‚   â””â”€â”€ users.py
    â”‚   â”‚       â”‚   â””â”€â”€ utils/
    â”‚   â”‚       â”‚       â”œâ”€â”€ link_preview.py
    â”‚   â”‚       â”‚       â””â”€â”€ upload_content.py
    â”‚   â”‚       â””â”€â”€ tests/
    â”‚   â”‚           â”œâ”€â”€ __init__.py
    â”‚   â”‚           â”œâ”€â”€ conftest.py
    â”‚   â”‚           â”œâ”€â”€ security/
    â”‚   â”‚           â”‚   â”œâ”€â”€ README.md
    â”‚   â”‚           â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚           â”‚   â”œâ”€â”€ test_auth.py
    â”‚   â”‚           â”‚   â”œâ”€â”€ test_features_utils.py
    â”‚   â”‚           â”‚   â”œâ”€â”€ test_rbac.py
    â”‚   â”‚           â”‚   â”œâ”€â”€ test_rbac_utils.py
    â”‚   â”‚           â”‚   â”œâ”€â”€ test_security.py
    â”‚   â”‚           â”‚   â””â”€â”€ test_security_all.py
    â”‚   â”‚           â””â”€â”€ utils/
    â”‚   â”‚               â”œâ”€â”€ __init__.py
    â”‚   â”‚               â””â”€â”€ init_data_for_tests.py
    â”‚   â””â”€â”€ web/
    â”‚       â”œâ”€â”€ README.md
    â”‚       â”œâ”€â”€ components.json
    â”‚       â”œâ”€â”€ docker-entrypoint.sh
    â”‚       â”œâ”€â”€ Dockerfile
    â”‚       â”œâ”€â”€ eslint.config.mjs
    â”‚       â”œâ”€â”€ instrumentation.ts
    â”‚       â”œâ”€â”€ next.config.js
    â”‚       â”œâ”€â”€ package.json
    â”‚       â”œâ”€â”€ postcss.config.js
    â”‚       â”œâ”€â”€ proxy.ts
    â”‚       â”œâ”€â”€ server-wrapper.js
    â”‚       â”œâ”€â”€ tailwind.config.js
    â”‚       â”œâ”€â”€ tsconfig.json
    â”‚       â”œâ”€â”€ .prettierrc.yaml
    â”‚       â”œâ”€â”€ app/
    â”‚       â”‚   â”œâ”€â”€ global-error.tsx
    â”‚       â”‚   â”œâ”€â”€ layout.tsx
    â”‚       â”‚   â”œâ”€â”€ not-found.tsx
    â”‚       â”‚   â”œâ”€â”€ api/
    â”‚       â”‚   â”‚   â”œâ”€â”€ auth/
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ [...nextauth]/
    â”‚       â”‚   â”‚   â”‚       â””â”€â”€ route.ts
    â”‚       â”‚   â”‚   â”œâ”€â”€ health/
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ route.ts
    â”‚       â”‚   â”‚   â”œâ”€â”€ revalidate/
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ route.ts
    â”‚       â”‚   â”‚   â””â”€â”€ sitemap/
    â”‚       â”‚   â”‚       â””â”€â”€ route.ts
    â”‚       â”‚   â”œâ”€â”€ auth/
    â”‚       â”‚   â”‚   â”œâ”€â”€ layout.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ options.ts
    â”‚       â”‚   â”‚   â”œâ”€â”€ forgot/
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ forgot.tsx
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ login/
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ login.tsx
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ reset/
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ reset.tsx
    â”‚       â”‚   â”‚   â””â”€â”€ signup/
    â”‚       â”‚   â”‚       â”œâ”€â”€ InviteOnlySignUp.tsx
    â”‚       â”‚   â”‚       â”œâ”€â”€ OpenSignup.tsx
    â”‚       â”‚   â”‚       â”œâ”€â”€ page.tsx
    â”‚       â”‚   â”‚       â””â”€â”€ signup.tsx
    â”‚       â”‚   â”œâ”€â”€ editor/
    â”‚       â”‚   â”‚   â”œâ”€â”€ main.ts
    â”‚       â”‚   â”‚   â””â”€â”€ course/
    â”‚       â”‚   â”‚       â””â”€â”€ [courseid]/
    â”‚       â”‚   â”‚           â””â”€â”€ activity/
    â”‚       â”‚   â”‚               â””â”€â”€ [activityuuid]/
    â”‚       â”‚   â”‚                   â””â”€â”€ edit/
    â”‚       â”‚   â”‚                       â”œâ”€â”€ loading.tsx
    â”‚       â”‚   â”‚                       â””â”€â”€ page.tsx
    â”‚       â”‚   â”œâ”€â”€ home/
    â”‚       â”‚   â”‚   â”œâ”€â”€ home.tsx
    â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
    â”‚       â”‚   â”œâ”€â”€ orgs/
    â”‚       â”‚   â”‚   â””â”€â”€ [orgslug]/
    â”‚       â”‚   â”‚       â”œâ”€â”€ layout.tsx
    â”‚       â”‚   â”‚       â”œâ”€â”€ (withmenu)/
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ error.tsx
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ layout.tsx
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ loading.tsx
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ page.tsx
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ certificates/
    â”‚       â”‚   â”‚       â”‚   â”‚   â””â”€â”€ [uuid]/
    â”‚       â”‚   â”‚       â”‚   â”‚       â””â”€â”€ verify/
    â”‚       â”‚   â”‚       â”‚   â”‚           â””â”€â”€ page.tsx
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ collection/
    â”‚       â”‚   â”‚       â”‚   â”‚   â””â”€â”€ [collectionid]/
    â”‚       â”‚   â”‚       â”‚   â”‚       â”œâ”€â”€ error.tsx
    â”‚       â”‚   â”‚       â”‚   â”‚       â”œâ”€â”€ loading.tsx
    â”‚       â”‚   â”‚       â”‚   â”‚       â””â”€â”€ page.tsx
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ collections/
    â”‚       â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ loading.tsx
    â”‚       â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
    â”‚       â”‚   â”‚       â”‚   â”‚   â””â”€â”€ new/
    â”‚       â”‚   â”‚       â”‚   â”‚       â””â”€â”€ page.tsx
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ course/
    â”‚       â”‚   â”‚       â”‚   â”‚   â””â”€â”€ [courseuuid]/
    â”‚       â”‚   â”‚       â”‚   â”‚       â”œâ”€â”€ course.tsx
    â”‚       â”‚   â”‚       â”‚   â”‚       â”œâ”€â”€ error.tsx
    â”‚       â”‚   â”‚       â”‚   â”‚       â”œâ”€â”€ page.tsx
    â”‚       â”‚   â”‚       â”‚   â”‚       â””â”€â”€ activity/
    â”‚       â”‚   â”‚       â”‚   â”‚           â””â”€â”€ [activityid]/
    â”‚       â”‚   â”‚       â”‚   â”‚               â”œâ”€â”€ error.tsx
    â”‚       â”‚   â”‚       â”‚   â”‚               â”œâ”€â”€ loading.tsx
    â”‚       â”‚   â”‚       â”‚   â”‚               â””â”€â”€ page.tsx
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ courses/
    â”‚       â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ courses.tsx
    â”‚       â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ error.tsx
    â”‚       â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ loading.tsx
    â”‚       â”‚   â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ search/
    â”‚       â”‚   â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ trail/
    â”‚       â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
    â”‚       â”‚   â”‚       â”‚   â”‚   â””â”€â”€ trail.tsx
    â”‚       â”‚   â”‚       â”‚   â””â”€â”€ user/
    â”‚       â”‚   â”‚       â”‚       â””â”€â”€ [username]/
    â”‚       â”‚   â”‚       â”‚           â”œâ”€â”€ page.tsx
    â”‚       â”‚   â”‚       â”‚           â””â”€â”€ UserProfileClient.tsx
    â”‚       â”‚   â”‚       â””â”€â”€ dash/
    â”‚       â”‚   â”‚           â”œâ”€â”€ ClientAdminLayout.tsx
    â”‚       â”‚   â”‚           â”œâ”€â”€ layout.tsx
    â”‚       â”‚   â”‚           â”œâ”€â”€ page.tsx
    â”‚       â”‚   â”‚           â”œâ”€â”€ assignments/
    â”‚       â”‚   â”‚           â”‚   â”œâ”€â”€ page.tsx
    â”‚       â”‚   â”‚           â”‚   â””â”€â”€ [assignmentuuid]/
    â”‚       â”‚   â”‚           â”‚       â”œâ”€â”€ page.tsx
    â”‚       â”‚   â”‚           â”‚       â”œâ”€â”€ _components/
    â”‚       â”‚   â”‚           â”‚       â”‚   â”œâ”€â”€ Tasks.tsx
    â”‚       â”‚   â”‚           â”‚       â”‚   â”œâ”€â”€ Modals/
    â”‚       â”‚   â”‚           â”‚       â”‚   â”‚   â””â”€â”€ NewTaskModal.tsx
    â”‚       â”‚   â”‚           â”‚       â”‚   â””â”€â”€ TaskEditor/
    â”‚       â”‚   â”‚           â”‚       â”‚       â”œâ”€â”€ TaskEditor.tsx
    â”‚       â”‚   â”‚           â”‚       â”‚       â””â”€â”€ Subs/
    â”‚       â”‚   â”‚           â”‚       â”‚           â”œâ”€â”€ AssignmentTaskContentEdit.tsx
    â”‚       â”‚   â”‚           â”‚       â”‚           â”œâ”€â”€ AssignmentTaskGeneralEdit.tsx
    â”‚       â”‚   â”‚           â”‚       â”‚           â””â”€â”€ TaskTypes/
    â”‚       â”‚   â”‚           â”‚       â”‚               â”œâ”€â”€ TaskFileObject.tsx
    â”‚       â”‚   â”‚           â”‚       â”‚               â”œâ”€â”€ TaskFormObject.tsx
    â”‚       â”‚   â”‚           â”‚       â”‚               â””â”€â”€ TaskQuizObject.tsx
    â”‚       â”‚   â”‚           â”‚       â””â”€â”€ subpages/
    â”‚       â”‚   â”‚           â”‚           â”œâ”€â”€ AssignmentEditorSubPage.tsx
    â”‚       â”‚   â”‚           â”‚           â”œâ”€â”€ AssignmentSubmissionsSubPage.tsx
    â”‚       â”‚   â”‚           â”‚           â””â”€â”€ Modals/
    â”‚       â”‚   â”‚           â”‚               â””â”€â”€ EvaluateAssignment.tsx
    â”‚       â”‚   â”‚           â”œâ”€â”€ courses/
    â”‚       â”‚   â”‚           â”‚   â”œâ”€â”€ client.tsx
    â”‚       â”‚   â”‚           â”‚   â”œâ”€â”€ page.tsx
    â”‚       â”‚   â”‚           â”‚   â””â”€â”€ course/
    â”‚       â”‚   â”‚           â”‚       â””â”€â”€ [courseuuid]/
    â”‚       â”‚   â”‚           â”‚           â””â”€â”€ [subpage]/
    â”‚       â”‚   â”‚           â”‚               â””â”€â”€ page.tsx
    â”‚       â”‚   â”‚           â”œâ”€â”€ documentation/
    â”‚       â”‚   â”‚           â”‚   â”œâ”€â”€ layout.tsx
    â”‚       â”‚   â”‚           â”‚   â””â”€â”€ rights/
    â”‚       â”‚   â”‚           â”‚       â””â”€â”€ page.tsx
    â”‚       â”‚   â”‚           â”œâ”€â”€ org/
    â”‚       â”‚   â”‚           â”‚   â””â”€â”€ settings/
    â”‚       â”‚   â”‚           â”‚       â””â”€â”€ [subpage]/
    â”‚       â”‚   â”‚           â”‚           â””â”€â”€ page.tsx
    â”‚       â”‚   â”‚           â”œâ”€â”€ payments/
    â”‚       â”‚   â”‚           â”‚   â””â”€â”€ [subpage]/
    â”‚       â”‚   â”‚           â”‚       â””â”€â”€ page.tsx
    â”‚       â”‚   â”‚           â”œâ”€â”€ user-account/
    â”‚       â”‚   â”‚           â”‚   â”œâ”€â”€ owned/
    â”‚       â”‚   â”‚           â”‚   â”‚   â””â”€â”€ page.tsx
    â”‚       â”‚   â”‚           â”‚   â””â”€â”€ settings/
    â”‚       â”‚   â”‚           â”‚       â””â”€â”€ [subpage]/
    â”‚       â”‚   â”‚           â”‚           â””â”€â”€ page.tsx
    â”‚       â”‚   â”‚           â””â”€â”€ users/
    â”‚       â”‚   â”‚               â””â”€â”€ settings/
    â”‚       â”‚   â”‚                   â””â”€â”€ [subpage]/
    â”‚       â”‚   â”‚                       â””â”€â”€ page.tsx
    â”‚       â”‚   â””â”€â”€ payments/
    â”‚       â”‚       â””â”€â”€ stripe/
    â”‚       â”‚           â””â”€â”€ connect/
    â”‚       â”‚               â””â”€â”€ oauth/
    â”‚       â”‚                   â””â”€â”€ page.tsx
    â”‚       â”œâ”€â”€ components/
    â”‚       â”‚   â”œâ”€â”€ Contexts/
    â”‚       â”‚   â”‚   â”œâ”€â”€ CourseContext.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ LHSessionContext.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ OrgContext.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ AI/
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ AIChatBotContext.tsx
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ AIEditorContext.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Assignments/
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ AssignmentContext.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ AssignmentsTaskContext.tsx
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ AssignmentSubmissionContext.tsx
    â”‚       â”‚   â”‚   â””â”€â”€ Editor/
    â”‚       â”‚   â”‚       â””â”€â”€ EditorContext.tsx
    â”‚       â”‚   â”œâ”€â”€ Dashboard/
    â”‚       â”‚   â”‚   â”œâ”€â”€ Menus/
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ DashLeftMenu.tsx
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ DashMobileMenu.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Misc/
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ BreadCrumbs.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ CourseOverviewTop.tsx
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ SaveState.tsx
    â”‚       â”‚   â”‚   â””â”€â”€ Pages/
    â”‚       â”‚   â”‚       â”œâ”€â”€ Course/
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ EditCourseAccess/
    â”‚       â”‚   â”‚       â”‚   â”‚   â””â”€â”€ EditCourseAccess.tsx
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ EditCourseCertification/
    â”‚       â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ CertificatePreview.tsx
    â”‚       â”‚   â”‚       â”‚   â”‚   â””â”€â”€ EditCourseCertification.tsx
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ EditCourseContributors/
    â”‚       â”‚   â”‚       â”‚   â”‚   â””â”€â”€ EditCourseContributors.tsx
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ EditCourseGeneral/
    â”‚       â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ CustomSelect.tsx
    â”‚       â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ EditCourseGeneral.tsx
    â”‚       â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ LearningItemsList.tsx
    â”‚       â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ ThumbnailUpdate.tsx
    â”‚       â”‚   â”‚       â”‚   â”‚   â””â”€â”€ UnsplashImagePicker.tsx
    â”‚       â”‚   â”‚       â”‚   â””â”€â”€ EditCourseStructure/
    â”‚       â”‚   â”‚       â”‚       â”œâ”€â”€ EditCourseStructure.tsx
    â”‚       â”‚   â”‚       â”‚       â”œâ”€â”€ Buttons/
    â”‚       â”‚   â”‚       â”‚       â”‚   â””â”€â”€ NewActivityButton.tsx
    â”‚       â”‚   â”‚       â”‚       â””â”€â”€ DraggableElements/
    â”‚       â”‚   â”‚       â”‚           â”œâ”€â”€ ActivityElement.tsx
    â”‚       â”‚   â”‚       â”‚           â””â”€â”€ ChapterElement.tsx
    â”‚       â”‚   â”‚       â”œâ”€â”€ Org/
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ OrgEditGeneral/
    â”‚       â”‚   â”‚       â”‚   â”‚   â””â”€â”€ OrgEditGeneral.tsx
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ OrgEditImages/
    â”‚       â”‚   â”‚       â”‚   â”‚   â””â”€â”€ OrgEditImages.tsx
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ OrgEditLanding/
    â”‚       â”‚   â”‚       â”‚   â”‚   â””â”€â”€ landing_types.ts
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ OrgEditOther/
    â”‚       â”‚   â”‚       â”‚   â”‚   â””â”€â”€ OrgEditOther.tsx
    â”‚       â”‚   â”‚       â”‚   â””â”€â”€ OrgEditSocials/
    â”‚       â”‚   â”‚       â”‚       â””â”€â”€ OrgEditSocials.tsx
    â”‚       â”‚   â”‚       â”œâ”€â”€ Payments/
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ PaymentsConfigurationPage.tsx
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ PaymentsCustomersPage.tsx
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ PaymentsProductPage.tsx
    â”‚       â”‚   â”‚       â”‚   â””â”€â”€ SubComponents/
    â”‚       â”‚   â”‚       â”‚       â”œâ”€â”€ CreateProductForm.tsx
    â”‚       â”‚   â”‚       â”‚       â”œâ”€â”€ LinkCourseModal.tsx
    â”‚       â”‚   â”‚       â”‚       â””â”€â”€ ProductLinkedCourses.tsx
    â”‚       â”‚   â”‚       â”œâ”€â”€ UserAccount/
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ UserEditGeneral/
    â”‚       â”‚   â”‚       â”‚   â”‚   â””â”€â”€ UserEditGeneral.tsx
    â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ UserEditPassword/
    â”‚       â”‚   â”‚       â”‚   â”‚   â””â”€â”€ UserEditPassword.tsx
    â”‚       â”‚   â”‚       â”‚   â””â”€â”€ UserProfile/
    â”‚       â”‚   â”‚       â”‚       â”œâ”€â”€ UserProfile.tsx
    â”‚       â”‚   â”‚       â”‚       â””â”€â”€ UserProfileBuilder.tsx
    â”‚       â”‚   â”‚       â””â”€â”€ Users/
    â”‚       â”‚   â”‚           â”œâ”€â”€ OrgAccess/
    â”‚       â”‚   â”‚           â”‚   â””â”€â”€ OrgAccess.tsx
    â”‚       â”‚   â”‚           â”œâ”€â”€ OrgRoles/
    â”‚       â”‚   â”‚           â”‚   â””â”€â”€ OrgRoles.tsx
    â”‚       â”‚   â”‚           â”œâ”€â”€ OrgUserGroups/
    â”‚       â”‚   â”‚           â”‚   â””â”€â”€ OrgUserGroups.tsx
    â”‚       â”‚   â”‚           â”œâ”€â”€ OrgUsers/
    â”‚       â”‚   â”‚           â”‚   â””â”€â”€ OrgUsers.tsx
    â”‚       â”‚   â”‚           â””â”€â”€ OrgUsersAdd/
    â”‚       â”‚   â”‚               â””â”€â”€ OrgUsersAdd.tsx
    â”‚       â”‚   â”œâ”€â”€ Footer/
    â”‚       â”‚   â”‚   â””â”€â”€ Footer.tsx
    â”‚       â”‚   â”œâ”€â”€ Hooks/
    â”‚       â”‚   â”‚   â”œâ”€â”€ useAdminStatus.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ useCourseRights.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ useFeatureFlag.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ useGetAIFeatures.tsx
    â”‚       â”‚   â”‚   â””â”€â”€ usePaymentsEnabled.tsx
    â”‚       â”‚   â”œâ”€â”€ Landings/
    â”‚       â”‚   â”‚   â”œâ”€â”€ LandingClassic.tsx
    â”‚       â”‚   â”‚   â””â”€â”€ LandingCustom.tsx
    â”‚       â”‚   â”œâ”€â”€ Objects/
    â”‚       â”‚   â”‚   â”œâ”€â”€ ContentPlaceHolder.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ MiniInfoTooltip.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ UserAvatar.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ UserProfilePopup.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Watermark.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Activities/
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ AI/
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ AIActivityAsk.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ Assignment/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AssignmentBoxUI.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ AssignmentStudentActivity.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ DocumentPdf/
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ DocumentPdf.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ DynamicCanva/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CustomHeadingExtenstion.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DynamicCanva.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TableOfContents.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ AI/
    â”‚       â”‚   â”‚   â”‚   â”‚       â””â”€â”€ AICanvaToolkit.tsx
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ Video/
    â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ LearnHousePlayer.tsx
    â”‚       â”‚   â”‚   â”‚       â””â”€â”€ Video.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Courses/
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ CourseActions/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CourseActionsMobile.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CoursePaidOptions.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CoursesActions.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ PaidCourseActivityDisclaimer.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ CourseAuthors/
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ CourseAuthors.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ CourseProgress/
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ CourseProgress.tsx
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ CourseUpdates/
    â”‚       â”‚   â”‚   â”‚       â””â”€â”€ CourseUpdates.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Editor/
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ Editor.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ EditorConf.ts
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ EditorWrapper.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ FileUploadBlock.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ AI/
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ AIEditorToolkit.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ Extensions/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Badges/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Badges.ts
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ BadgesExtension.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Buttons/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Buttons.ts
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ButtonsExtension.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Callout/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Info/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ InfoCallout.ts
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ InfoCalloutComponent.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Warning/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ WarningCallout.ts
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚       â””â”€â”€ WarningCalloutComponent.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EmbedObjects/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EmbedObjects.ts
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ EmbedObjectsComponent.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Flipcard/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Flipcard.ts
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ FlipcardExtension.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Image/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ImageBlock.ts
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ImageBlockComponent.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MathEquation/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MathEquationBlock.ts
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ MathEquationBlockComponent.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ NoTextInput/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ NoTextInput.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PDF/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PDFBlock.ts
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ PDFBlockComponent.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Quiz/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ QuizBlock.ts
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ QuizBlockComponent.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Scenarios/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Scenarios.ts
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ScenariosExtension.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ScenariosModal.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Users/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ UserBlock.ts
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ UserBlockComponent.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Video/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ VideoBlock.ts
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ VideoBlockComponent.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ WebPreview/
    â”‚       â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ WebPreview.ts
    â”‚       â”‚   â”‚   â”‚   â”‚       â””â”€â”€ WebPreviewComponent.tsx
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ Toolbar/
    â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ LinkInputTooltip.tsx
    â”‚       â”‚   â”‚   â”‚       â””â”€â”€ ToolbarButtons.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Loaders/
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ PageLoading.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Menus/
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ OrgMenu.tsx
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ OrgMenuLinks.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Modals/
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ Activities/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Assignments/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ EditAssignmentModal.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Create/
    â”‚       â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ NewActivity.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚       â””â”€â”€ NewActivityModal/
    â”‚       â”‚   â”‚   â”‚   â”‚           â”œâ”€â”€ AssignmentActivityModal.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚           â”œâ”€â”€ DocumentActivityModal.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚           â”œâ”€â”€ DynamicActivityModal.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚           â””â”€â”€ VideoActivityModal.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ Chapters/
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ NewChapter.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ Course/
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Create/
    â”‚       â”‚   â”‚   â”‚   â”‚       â””â”€â”€ CreateCourse.tsx
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ Dash/
    â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ EditCourseAccess/
    â”‚       â”‚   â”‚   â”‚       â”‚   â””â”€â”€ LinkToUserGroup.tsx
    â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ OrgAccess/
    â”‚       â”‚   â”‚   â”‚       â”‚   â””â”€â”€ OrgInviteCodeGenerate.tsx
    â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ OrgRoles/
    â”‚       â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ AddRole.tsx
    â”‚       â”‚   â”‚   â”‚       â”‚   â””â”€â”€ EditRole.tsx
    â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ OrgUserGroups/
    â”‚       â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ AddUserGroup.tsx
    â”‚       â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ EditUserGroup.tsx
    â”‚       â”‚   â”‚   â”‚       â”‚   â””â”€â”€ ManageUsers.tsx
    â”‚       â”‚   â”‚   â”‚       â””â”€â”€ OrgUsers/
    â”‚       â”‚   â”‚   â”‚           â””â”€â”€ RolesUpdate.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Onboarding/
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ Onboarding.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Search/
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ SearchBar.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ StyledElements/
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ Buttons/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ NewCollectionButton.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ NewCourseButton.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ ConfirmationModal/
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ConfirmationModal.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ Error/
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Error.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ Form/
    â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Form.tsx
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ TagInput.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ Info/
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Info.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ Modal/
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Modal.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ Titles/
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ TypeOfContentTitle.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ Toast/
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Toast.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ Tooltip/
    â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Tooltip.tsx
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ Wrappers/
    â”‚       â”‚   â”‚   â”‚       â””â”€â”€ GeneralWrapper.tsx
    â”‚       â”‚   â”‚   â””â”€â”€ Thumbnails/
    â”‚       â”‚   â”‚       â”œâ”€â”€ CollectionThumbnail.tsx
    â”‚       â”‚   â”‚       â”œâ”€â”€ CourseThumbnail.tsx
    â”‚       â”‚   â”‚       â””â”€â”€ CourseThumbnailLanding.tsx
    â”‚       â”‚   â”œâ”€â”€ OrgScripts/
    â”‚       â”‚   â”‚   â””â”€â”€ OrgScripts.tsx
    â”‚       â”‚   â”œâ”€â”€ Pages/
    â”‚       â”‚   â”‚   â”œâ”€â”€ Activity/
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ ActivityBreadcrumbs.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ ActivityChapterDropdown.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ ActivityNavigation.tsx
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ CourseEndView.tsx
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ FixedActivitySecondaryBar.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Certificate/
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ CertificatePage.tsx
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ CertificateVerificationPage.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ CourseEdit/
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ Draggables/
    â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ Activity.tsx
    â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ Chapter.tsx
    â”‚       â”‚   â”‚   â”‚       â””â”€â”€ data.ts
    â”‚       â”‚   â”‚   â”œâ”€â”€ Courses/
    â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ ActivityIndicators.tsx
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ CourseBreadcrumbs.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Payments/
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ UnconfiguredPaymentsDisclaimer.tsx
    â”‚       â”‚   â”‚   â””â”€â”€ Trail/
    â”‚       â”‚   â”‚       â”œâ”€â”€ TrailCourseElement.tsx
    â”‚       â”‚   â”‚       â””â”€â”€ UserCertificates.tsx
    â”‚       â”‚   â”œâ”€â”€ Security/
    â”‚       â”‚   â”‚   â”œâ”€â”€ AdminAuthorization.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ AuthenticatedClientElement.tsx
    â”‚       â”‚   â”‚   â””â”€â”€ HeaderProfileBox.tsx
    â”‚       â”‚   â”œâ”€â”€ ui/
    â”‚       â”‚   â”‚   â”œâ”€â”€ alert.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ badge.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ button.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ checkbox.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ dialog.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ dropdown-menu.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ hover-card.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ input.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ label.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ select.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ switch.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ table.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ tabs.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ textarea.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ toggle-group.tsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ toggle.tsx
    â”‚       â”‚   â”‚   â””â”€â”€ tooltip.tsx
    â”‚       â”‚   â””â”€â”€ Utils/
    â”‚       â”‚       â”œâ”€â”€ ClientComp.tsx
    â”‚       â”‚       â””â”€â”€ libs/
    â”‚       â”‚           â””â”€â”€ styled-registry.tsx
    â”‚       â”œâ”€â”€ hooks/
    â”‚       â”‚   â”œâ”€â”€ useContributorStatus.ts
    â”‚       â”‚   â””â”€â”€ useDebounce.ts
    â”‚       â”œâ”€â”€ lib/
    â”‚       â”‚   â”œâ”€â”€ constants.ts
    â”‚       â”‚   â”œâ”€â”€ file-validation.ts
    â”‚       â”‚   â””â”€â”€ utils.ts
    â”‚       â”œâ”€â”€ services/
    â”‚       â”‚   â”œâ”€â”€ ai/
    â”‚       â”‚   â”‚   â””â”€â”€ ai.ts
    â”‚       â”‚   â”œâ”€â”€ auth/
    â”‚       â”‚   â”‚   â””â”€â”€ auth.ts
    â”‚       â”‚   â”œâ”€â”€ blocks/
    â”‚       â”‚   â”‚   â”œâ”€â”€ Image/
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ images.ts
    â”‚       â”‚   â”‚   â”œâ”€â”€ Pdf/
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ pdf.ts
    â”‚       â”‚   â”‚   â”œâ”€â”€ Quiz/
    â”‚       â”‚   â”‚   â”‚   â””â”€â”€ quiz.ts
    â”‚       â”‚   â”‚   â””â”€â”€ Video/
    â”‚       â”‚   â”‚       â””â”€â”€ video.ts
    â”‚       â”‚   â”œâ”€â”€ config/
    â”‚       â”‚   â”‚   â””â”€â”€ config.ts
    â”‚       â”‚   â”œâ”€â”€ courses/
    â”‚       â”‚   â”‚   â”œâ”€â”€ activities.ts
    â”‚       â”‚   â”‚   â”œâ”€â”€ activity.ts
    â”‚       â”‚   â”‚   â”œâ”€â”€ assignments.ts
    â”‚       â”‚   â”‚   â”œâ”€â”€ certifications.ts
    â”‚       â”‚   â”‚   â”œâ”€â”€ chapters.ts
    â”‚       â”‚   â”‚   â”œâ”€â”€ collections.ts
    â”‚       â”‚   â”‚   â”œâ”€â”€ courses.ts
    â”‚       â”‚   â”‚   â””â”€â”€ updates.ts
    â”‚       â”‚   â”œâ”€â”€ media/
    â”‚       â”‚   â”‚   â””â”€â”€ media.ts
    â”‚       â”‚   â”œâ”€â”€ organizations/
    â”‚       â”‚   â”‚   â”œâ”€â”€ invites.ts
    â”‚       â”‚   â”‚   â””â”€â”€ orgs.ts
    â”‚       â”‚   â”œâ”€â”€ payments/
    â”‚       â”‚   â”‚   â”œâ”€â”€ payments.ts
    â”‚       â”‚   â”‚   â””â”€â”€ products.ts
    â”‚       â”‚   â”œâ”€â”€ roles/
    â”‚       â”‚   â”‚   â””â”€â”€ roles.ts
    â”‚       â”‚   â”œâ”€â”€ search/
    â”‚       â”‚   â”‚   â””â”€â”€ search.ts
    â”‚       â”‚   â”œâ”€â”€ settings/
    â”‚       â”‚   â”‚   â”œâ”€â”€ org.ts
    â”‚       â”‚   â”‚   â”œâ”€â”€ password.ts
    â”‚       â”‚   â”‚   â””â”€â”€ profile.ts
    â”‚       â”‚   â”œâ”€â”€ usergroups/
    â”‚       â”‚   â”‚   â””â”€â”€ usergroups.ts
    â”‚       â”‚   â”œâ”€â”€ users/
    â”‚       â”‚   â”‚   â””â”€â”€ users.ts
    â”‚       â”‚   â””â”€â”€ utils/
    â”‚       â”‚       â”œâ”€â”€ health.ts
    â”‚       â”‚       â”œâ”€â”€ react/
    â”‚       â”‚       â”‚   â””â”€â”€ middlewares/
    â”‚       â”‚       â”‚       â””â”€â”€ views.ts
    â”‚       â”‚       â””â”€â”€ ts/
    â”‚       â”‚           â””â”€â”€ requests.ts
    â”‚       â”œâ”€â”€ styles/
    â”‚       â”‚   â””â”€â”€ globals.css
    â”‚       â””â”€â”€ types/
    â”‚           â”œâ”€â”€ next-auth.d.ts
    â”‚           â””â”€â”€ react-plyr.d.ts
    â”œâ”€â”€ extra/
    â”‚   â”œâ”€â”€ nginx.conf
    â”‚   â””â”€â”€ start.sh
    â””â”€â”€ .github/
        â”œâ”€â”€ ISSUE_TEMPLATE/
        â”‚   â”œâ”€â”€ bug.yml
        â”‚   â”œâ”€â”€ config.yml
        â”‚   â”œâ”€â”€ team.yml
        â”‚   â””â”€â”€ verified.yml
        â””â”€â”€ workflows/
            â”œâ”€â”€ api-lint.yaml
            â”œâ”€â”€ api-tests.yaml
            â”œâ”€â”€ docker-build.yaml
            â””â”€â”€ web-lint.yaml

================================================
FILE: README.md
================================================
<p align="center">
  <a href="https://learnhouse.app">
    <img src=".github/images/readme.png" height="300">
  </a>
</p>

LearnHouse is an open source platform that makes it easy for anyone to provide world-class educational content and it offers a variety of content types : Dynamic Pages, Videos, Documents & more..

## Progress

ğŸš§ LearnHouse is still on development (beta), as we reach stability we will release a stable version and add more features.

## Roadmap

We prioritize issues depending on the most requested features from our users, please help us prioritize issues by commenting on them and sharing your thoughts 

[ğŸš¢ LearnHouse General Roadmap](https://www.learnhouse.app/roadmap)

## Overview

![image](https://docs.learnhouse.app/img/pages/features.png)

- ğŸ“„âœ¨Dynamic notion-like Blocks-based Courses & editor
- ğŸï¸ Easy to use
- ğŸ‘¥ Multi-Organization
- ğŸ“¹ Supports Uploadable Videos and external videos like YouTube
- ğŸ“„ Supports documents like PDF
- ğŸ‘¨â€ğŸ“ Users & Groups Management
- ğŸ™‹ Quizzes
- ğŸ± Course Collections
- ğŸ‘Ÿ Course Progress
- ğŸ›œ Course Updates
- ğŸ’¬ Discussions
- âœ¨ LearnHouse AI : The Teachers and Students copilot
- ğŸ‘ª Multiplayer Course edition
- More to come

## Community

Please visit our [Discord](https://discord.gg/CMyZjjYZ6x) community ğŸ‘‹

## Contributing

Thank you for you interest ğŸ’–, here is how you can help :

- [Getting Started](/CONTRIBUTING.md)
- [Developers Quick start](https://docs.learnhouse.app/setup-dev-environment)
- [Submit a bug report](https://github.com/learnhouse/learnhouse/issues/new?assignees=&labels=bug%2Ctriage&projects=&template=bug.yml&title=%5BBug%5D%3A+)
- [Check good first issues & Help Wanted](https://github.com/learnhouse/learnhouse/issues?q=is%3Aopen+is%3Aissue+label%3A%22good+first+issue%22+label%3A%22help+wanted%22)
- Spread the word and share the project with your friends

## Documentation

- [Overview](https://docs.learnhouse.app)
- [Developers](https://docs.learnhouse.app/setup-dev-environment)

## Get started 

### Get a local ready copy of LearnHouse

TLDR: Run `docker-compose up -d` and inspect the logs, should be ready to go in less than 2 mins

- [Self Hosting](https://docs.learnhouse.app/self-hosting/hosting-guide)

### Set-up a Development Environment 

- [Detailed Guide](https://docs.learnhouse.app/setup-dev-environment)

## Tech

LearnHouse uses a number of open source projects to work properly:

- **Next.js** (14 with the App Directory) - The React Framework
- **TailwindCSS** - Styling
- **Radix UI** - Accessible UI Components
- **Tiptap** - An editor framework and headless wrapper around ProseMirror
- **FastAPI** - A high performance, async API framework for Python
- **YJS** - Shared data types for building collaborative software
- **PostgreSQL** - SQL Database
- **Redis** - In-Memory Database
- **React** - duh

## LearnHouse University

<a href="https://university.learnhouse.io">
<img width="208" alt="lh_univ" src="https://github.com/learnhouse/learnhouse/assets/29493708/72a892cd-7c5a-4437-9130-ff1682a10b24">
</a>

Learn about LearnHouse and how to use it, using LearnHouse


## A word

Learnhouse is made with ğŸ’œ, from the UI to the features it is carefully designed to make students and teachers lives easier and make education software more enjoyable.

Thank you and have fun using/developing/testing LearnHouse !



================================================
FILE: CONTRIBUTING.md
================================================
# Contributing to LearnHouse

## Backend Codebase

### Tech

- **FastAPI** - A high performance, async API framework for Python
- **Pydantic** - Data validation and settings management using Python type annotations.
- **Ruff** - An extremely fast Python linter, written in Rust.
- **Motor** - the async Python driver for MongoDB and Tornado or asyncio
- **Uvicorn** - an ASGI web server implementation for Python.

### Get started

Use the Docker Image available in `./Dockerfile`

> Make sure your container runtime has at least 4GB of RAM allocated, as default settings may vary by tool.

    docker-compose up -d

Initiate a dev environment, please check the official guide [here](https://docs.learnhouse.app/setup-dev-environment)

## Frontend Codebase

### Tech

- **Next.js** (13 with the App Directory) - The React Framework
- **TailwindCSS** - Styling
- **Radix UI** - Accessible UI Components
- **Tiptap** - An editor framework and headless wrapper around ProseMirror
- **YJS** - Shared data types for building collaborative software
- **PostgreSQL** - SQL Database
- **React** - duh

### Get started

Use the Docker Image available in `front/Dockerfile`, or install the frontend package on your computer for greater performance.

#### Start the Backend server first

You need to have the backend running, to initiate a dev environment please check the official guide [here](https://docs.learnhouse.app/setup-dev-environment)

#### Environment Files

Please check if you initiated your `.env` files, here is a [guide](https://docs.learnhouse.app/setup-dev-environment) on how to do it.

#### Install the frontend package

    npm i

#### Run in Dev environment

    npm run dev

## Submitting Contributions

This project follows [GitHub's standard forking model](https://guides.github.com/activities/forking/). Please fork the project to submit pull requests.

### Submitting a bug/fix

- Start an issue [here](https://github.com/learnhouse/learnhouse/issues) to report the bug.
- Please include a detailed description of the bug and how it can be reproduced.
- Someone from the team will review the issue and will give you a go ahead.

### Submitting a feature / idea

- Start a Discussion [here](https://github.com/learnhouse/learnhouse/discussions/categories/ideas) to propose your idea and how it should be implemented.
- Someone from the team will review your idea and will give you a go ahead.
- Start an issue & link the discussion to it.
- Clone your fork locally
- Create a new branch and make your commits
- Push your commits to your forked repo
- Make a Pull request
- Code will be added after review



================================================
FILE: Dockerfile
================================================
# Base image for Python backend
FROM python:3.12.3-slim-bookworm AS base

# Install Nginx, curl, and build-essential
RUN apt update && apt install -y nginx curl build-essential \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && rm /etc/nginx/sites-enabled/default

# Install Node tools
RUN curl -fsSL https://deb.nodesource.com/setup_21.x | bash - \
    && apt-get install -y nodejs \
    && npm install -g pm2

# Frontend Build - Using Node.js Alpine for better performance
FROM node:22-alpine AS frontend-base

# Install dependencies only when needed
FROM frontend-base AS frontend-deps
# Check https://github.com/nodejs/docker-node/tree/b4117f9333da4138b03a546ec926ef50a31506c3#nodealpine to understand why libc6-compat might be needed.
RUN apk update && apk add --no-cache libc6-compat && rm -rf /var/cache/apk/*
WORKDIR /app

# Install dependencies based on the preferred package manager
COPY apps/web/package.json apps/web/pnpm-lock.yaml* ./
RUN \
  if [ -f pnpm-lock.yaml ]; then corepack enable pnpm && pnpm i --frozen-lockfile; \
  else echo "Lockfile not found." && exit 1; \
  fi

# Rebuild the source code only when needed
FROM frontend-base AS frontend-builder
WORKDIR /app
COPY --from=frontend-deps /app/node_modules ./node_modules
COPY apps/web .



# Next.js collects completely anonymous telemetry data about general usage.
# Learn more here: https://nextjs.org/telemetry
# Uncomment the following line in case you want to disable telemetry during the build.
# ENV NEXT_TELEMETRY_DISABLED 1

# Remove .env files from the final image
# This is a good practice to avoid leaking sensitive data
# Learn more about it in the Next.js documentation: https://nextjs.org/docs/basic-features/environment-variables
RUN rm -f .env*

RUN \
  if [ -f pnpm-lock.yaml ]; then corepack enable pnpm && pnpm run build; \
  else echo "Lockfile not found." && exit 1; \
  fi

# Production image, copy all the files and run next
FROM frontend-base AS frontend-runner
WORKDIR /app

# Install curl for health checks
RUN apk update && apk add --no-cache curl && rm -rf /var/cache/apk/*

ENV NODE_ENV=production
# Uncomment the following line in case you want to disable telemetry during runtime.
# ENV NEXT_TELEMETRY_DISABLED 1

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=frontend-builder /app/public ./public

# Set the correct permission for prerender cache
RUN mkdir .next
RUN chown nextjs:nodejs .next

# Automatically leverage output traces to reduce image size
# https://nextjs.org/docs/advanced-features/output-file-tracing
COPY --from=frontend-builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=frontend-builder --chown=nextjs:nodejs /app/.next/static ./.next/static

# Copy server wrapper for runtime environment variable injection
COPY --chown=nextjs:nodejs apps/web/server-wrapper.js ./
RUN chmod +x server-wrapper.js

# Final image combining frontend and backend
FROM base AS runner

# Copy the frontend standalone build
COPY --from=frontend-runner /app /app/web

# Backend Build
WORKDIR /app/api
COPY ./apps/api/uv.lock ./
COPY ./apps/api/pyproject.toml ./
RUN pip install --upgrade pip \
    && pip install uv \
    && uv sync
COPY ./apps/api ./

# Install curl and netcat for health checks and service waiting
RUN apt-get update && apt-get install -y curl netcat-openbsd && rm -rf /var/lib/apt/lists/*

# Run the backend
WORKDIR /app
COPY ./extra/nginx.conf /etc/nginx/conf.d/default.conf
ENV PORT=8000 LEARNHOUSE_PORT=9000 HOSTNAME=0.0.0.0

# Copy entrypoint scripts
COPY ./apps/api/docker-entrypoint.sh /app/api/docker-entrypoint.sh
RUN chmod +x /app/api/docker-entrypoint.sh

COPY ./extra/start.sh /app/start.sh
RUN chmod +x /app/start.sh

# Expose ports
EXPOSE 80 9000

CMD ["sh", "/app/start.sh"]


================================================
FILE: LICENSE
================================================
                    GNU AFFERO GENERAL PUBLIC LICENSE
                       Version 3, 19 November 2007

 Copyright (C) 2007 Free Software Foundation, Inc. <https://fsf.org/>
 Everyone is permitted to copy and distribute verbatim copies
 of this license document, but changing it is not allowed.

                            Preamble

  The GNU Affero General Public License is a free, copyleft license for
software and other kinds of works, specifically designed to ensure
cooperation with the community in the case of network server software.

  The licenses for most software and other practical works are designed
to take away your freedom to share and change the works.  By contrast,
our General Public Licenses are intended to guarantee your freedom to
share and change all versions of a program--to make sure it remains free
software for all its users.

  When we speak of free software, we are referring to freedom, not
price.  Our General Public Licenses are designed to make sure that you
have the freedom to distribute copies of free software (and charge for
them if you wish), that you receive source code or can get it if you
want it, that you can change the software or use pieces of it in new
free programs, and that you know you can do these things.

  Developers that use our General Public Licenses protect your rights
with two steps: (1) assert copyright on the software, and (2) offer
you this License which gives you legal permission to copy, distribute
and/or modify the software.

  A secondary benefit of defending all users' freedom is that
improvements made in alternate versions of the program, if they
receive widespread use, become available for other developers to
incorporate.  Many developers of free software are heartened and
encouraged by the resulting cooperation.  However, in the case of
software used on network servers, this result may fail to come about.
The GNU General Public License permits making a modified version and
letting the public access it on a server without ever releasing its
source code to the public.

  The GNU Affero General Public License is designed specifically to
ensure that, in such cases, the modified source code becomes available
to the community.  It requires the operator of a network server to
provide the source code of the modified version running there to the
users of that server.  Therefore, public use of a modified version, on
a publicly accessible server, gives the public access to the source
code of the modified version.

  An older license, called the Affero General Public License and
published by Affero, was designed to accomplish similar goals.  This is
a different license, not a version of the Affero GPL, but Affero has
released a new version of the Affero GPL which permits relicensing under
this license.

  The precise terms and conditions for copying, distribution and
modification follow.

                       TERMS AND CONDITIONS

  0. Definitions.

  "This License" refers to version 3 of the GNU Affero General Public License.

  "Copyright" also means copyright-like laws that apply to other kinds of
works, such as semiconductor masks.

  "The Program" refers to any copyrightable work licensed under this
License.  Each licensee is addressed as "you".  "Licensees" and
"recipients" may be individuals or organizations.

  To "modify" a work means to copy from or adapt all or part of the work
in a fashion requiring copyright permission, other than the making of an
exact copy.  The resulting work is called a "modified version" of the
earlier work or a work "based on" the earlier work.

  A "covered work" means either the unmodified Program or a work based
on the Program.

  To "propagate" a work means to do anything with it that, without
permission, would make you directly or secondarily liable for
infringement under applicable copyright law, except executing it on a
computer or modifying a private copy.  Propagation includes copying,
distribution (with or without modification), making available to the
public, and in some countries other activities as well.

  To "convey" a work means any kind of propagation that enables other
parties to make or receive copies.  Mere interaction with a user through
a computer network, with no transfer of a copy, is not conveying.

  An interactive user interface displays "Appropriate Legal Notices"
to the extent that it includes a convenient and prominently visible
feature that (1) displays an appropriate copyright notice, and (2)
tells the user that there is no warranty for the work (except to the
extent that warranties are provided), that licensees may convey the
work under this License, and how to view a copy of this License.  If
the interface presents a list of user commands or options, such as a
menu, a prominent item in the list meets this criterion.

  1. Source Code.

  The "source code" for a work means the preferred form of the work
for making modifications to it.  "Object code" means any non-source
form of a work.

  A "Standard Interface" means an interface that either is an official
standard defined by a recognized standards body, or, in the case of
interfaces specified for a particular programming language, one that
is widely used among developers working in that language.

  The "System Libraries" of an executable work include anything, other
than the work as a whole, that (a) is included in the normal form of
packaging a Major Component, but which is not part of that Major
Component, and (b) serves only to enable use of the work with that
Major Component, or to implement a Standard Interface for which an
implementation is available to the public in source code form.  A
"Major Component", in this context, means a major essential component
(kernel, window system, and so on) of the specific operating system
(if any) on which the executable work runs, or a compiler used to
produce the work, or an object code interpreter used to run it.

  The "Corresponding Source" for a work in object code form means all
the source code needed to generate, install, and (for an executable
work) run the object code and to modify the work, including scripts to
control those activities.  However, it does not include the work's
System Libraries, or general-purpose tools or generally available free
programs which are used unmodified in performing those activities but
which are not part of the work.  For example, Corresponding Source
includes interface definition files associated with source files for
the work, and the source code for shared libraries and dynamically
linked subprograms that the work is specifically designed to require,
such as by intimate data communication or control flow between those
subprograms and other parts of the work.

  The Corresponding Source need not include anything that users
can regenerate automatically from other parts of the Corresponding
Source.

  The Corresponding Source for a work in source code form is that
same work.

  2. Basic Permissions.

  All rights granted under this License are granted for the term of
copyright on the Program, and are irrevocable provided the stated
conditions are met.  This License explicitly affirms your unlimited
permission to run the unmodified Program.  The output from running a
covered work is covered by this License only if the output, given its
content, constitutes a covered work.  This License acknowledges your
rights of fair use or other equivalent, as provided by copyright law.

  You may make, run and propagate covered works that you do not
convey, without conditions so long as your license otherwise remains
in force.  You may convey covered works to others for the sole purpose
of having them make modifications exclusively for you, or provide you
with facilities for running those works, provided that you comply with
the terms of this License in conveying all material for which you do
not control copyright.  Those thus making or running the covered works
for you must do so exclusively on your behalf, under your direction
and control, on terms that prohibit them from making any copies of
your copyrighted material outside their relationship with you.

  Conveying under any other circumstances is permitted solely under
the conditions stated below.  Sublicensing is not allowed; section 10
makes it unnecessary.

  3. Protecting Users' Legal Rights From Anti-Circumvention Law.

  No covered work shall be deemed part of an effective technological
measure under any applicable law fulfilling obligations under article
11 of the WIPO copyright treaty adopted on 20 December 1996, or
similar laws prohibiting or restricting circumvention of such
measures.

  When you convey a covered work, you waive any legal power to forbid
circumvention of technological measures to the extent such circumvention
is effected by exercising rights under this License with respect to
the covered work, and you disclaim any intention to limit operation or
modification of the work as a means of enforcing, against the work's
users, your or third parties' legal rights to forbid circumvention of
technological measures.

  4. Conveying Verbatim Copies.

  You may convey verbatim copies of the Program's source code as you
receive it, in any medium, provided that you conspicuously and
appropriately publish on each copy an appropriate copyright notice;
keep intact all notices stating that this License and any
non-permissive terms added in accord with section 7 apply to the code;
keep intact all notices of the absence of any warranty; and give all
recipients a copy of this License along with the Program.

  You may charge any price or no price for each copy that you convey,
and you may offer support or warranty protection for a fee.

  5. Conveying Modified Source Versions.

  You may convey a work based on the Program, or the modifications to
produce it from the Program, in the form of source code under the
terms of section 4, provided that you also meet all of these conditions:

    a) The work must carry prominent notices stating that you modified
    it, and giving a relevant date.

    b) The work must carry prominent notices stating that it is
    released under this License and any conditions added under section
    7.  This requirement modifies the requirement in section 4 to
    "keep intact all notices".

    c) You must license the entire work, as a whole, under this
    License to anyone who comes into possession of a copy.  This
    License will therefore apply, along with any applicable section 7
    additional terms, to the whole of the work, and all its parts,
    regardless of how they are packaged.  This License gives no
    permission to license the work in any other way, but it does not
    invalidate such permission if you have separately received it.

    d) If the work has interactive user interfaces, each must display
    Appropriate Legal Notices; however, if the Program has interactive
    interfaces that do not display Appropriate Legal Notices, your
    work need not make them do so.

  A compilation of a covered work with other separate and independent
works, which are not by their nature extensions of the covered work,
and which are not combined with it such as to form a larger program,
in or on a volume of a storage or distribution medium, is called an
"aggregate" if the compilation and its resulting copyright are not
used to limit the access or legal rights of the compilation's users
beyond what the individual works permit.  Inclusion of a covered work
in an aggregate does not cause this License to apply to the other
parts of the aggregate.

  6. Conveying Non-Source Forms.

  You may convey a covered work in object code form under the terms
of sections 4 and 5, provided that you also convey the
machine-readable Corresponding Source under the terms of this License,
in one of these ways:

    a) Convey the object code in, or embodied in, a physical product
    (including a physical distribution medium), accompanied by the
    Corresponding Source fixed on a durable physical medium
    customarily used for software interchange.

    b) Convey the object code in, or embodied in, a physical product
    (including a physical distribution medium), accompanied by a
    written offer, valid for at least three years and valid for as
    long as you offer spare parts or customer support for that product
    model, to give anyone who possesses the object code either (1) a
    copy of the Corresponding Source for all the software in the
    product that is covered by this License, on a durable physical
    medium customarily used for software interchange, for a price no
    more than your reasonable cost of physically performing this
    conveying of source, or (2) access to copy the
    Corresponding Source from a network server at no charge.

    c) Convey individual copies of the object code with a copy of the
    written offer to provide the Corresponding Source.  This
    alternative is allowed only occasionally and noncommercially, and
    only if you received the object code with such an offer, in accord
    with subsection 6b.

    d) Convey the object code by offering access from a designated
    place (gratis or for a charge), and offer equivalent access to the
    Corresponding Source in the same way through the same place at no
    further charge.  You need not require recipients to copy the
    Corresponding Source along with the object code.  If the place to
    copy the object code is a network server, the Corresponding Source
    may be on a different server (operated by you or a third party)
    that supports equivalent copying facilities, provided you maintain
    clear directions next to the object code saying where to find the
    Corresponding Source.  Regardless of what server hosts the
    Corresponding Source, you remain obligated to ensure that it is
    available for as long as needed to satisfy these requirements.

    e) Convey the object code using peer-to-peer transmission, provided
    you inform other peers where the object code and Corresponding
    Source of the work are being offered to the general public at no
    charge under subsection 6d.

  A separable portion of the object code, whose source code is excluded
from the Corresponding Source as a System Library, need not be
included in conveying the object code work.

  A "User Product" is either (1) a "consumer product", which means any
tangible personal property which is normally used for personal, family,
or household purposes, or (2) anything designed or sold for incorporation
into a dwelling.  In determining whether a product is a consumer product,
doubtful cases shall be resolved in favor of coverage.  For a particular
product received by a particular user, "normally used" refers to a
typical or common use of that class of product, regardless of the status
of the particular user or of the way in which the particular user
actually uses, or expects or is expected to use, the product.  A product
is a consumer product regardless of whether the product has substantial
commercial, industrial or non-consumer uses, unless such uses represent
the only significant mode of use of the product.

  "Installation Information" for a User Product means any methods,
procedures, authorization keys, or other information required to install
and execute modified versions of a covered work in that User Product from
a modified version of its Corresponding Source.  The information must
suffice to ensure that the continued functioning of the modified object
code is in no case prevented or interfered with solely because
modification has been made.

  If you convey an object code work under this section in, or with, or
specifically for use in, a User Product, and the conveying occurs as
part of a transaction in which the right of possession and use of the
User Product is transferred to the recipient in perpetuity or for a
fixed term (regardless of how the transaction is characterized), the
Corresponding Source conveyed under this section must be accompanied
by the Installation Information.  But this requirement does not apply
if neither you nor any third party retains the ability to install
modified object code on the User Product (for example, the work has
been installed in ROM).

  The requirement to provide Installation Information does not include a
requirement to continue to provide support service, warranty, or updates
for a work that has been modified or installed by the recipient, or for
the User Product in which it has been modified or installed.  Access to a
network may be denied when the modification itself materially and
adversely affects the operation of the network or violates the rules and
protocols for communication across the network.

  Corresponding Source conveyed, and Installation Information provided,
in accord with this section must be in a format that is publicly
documented (and with an implementation available to the public in
source code form), and must require no special password or key for
unpacking, reading or copying.

  7. Additional Terms.

  "Additional permissions" are terms that supplement the terms of this
License by making exceptions from one or more of its conditions.
Additional permissions that are applicable to the entire Program shall
be treated as though they were included in this License, to the extent
that they are valid under applicable law.  If additional permissions
apply only to part of the Program, that part may be used separately
under those permissions, but the entire Program remains governed by
this License without regard to the additional permissions.

  When you convey a copy of a covered work, you may at your option
remove any additional permissions from that copy, or from any part of
it.  (Additional permissions may be written to require their own
removal in certain cases when you modify the work.)  You may place
additional permissions on material, added by you to a covered work,
for which you have or can give appropriate copyright permission.

  Notwithstanding any other provision of this License, for material you
add to a covered work, you may (if authorized by the copyright holders of
that material) supplement the terms of this License with terms:

    a) Disclaiming warranty or limiting liability differently from the
    terms of sections 15 and 16 of this License; or

    b) Requiring preservation of specified reasonable legal notices or
    author attributions in that material or in the Appropriate Legal
    Notices displayed by works containing it; or

    c) Prohibiting misrepresentation of the origin of that material, or
    requiring that modified versions of such material be marked in
    reasonable ways as different from the original version; or

    d) Limiting the use for publicity purposes of names of licensors or
    authors of the material; or

    e) Declining to grant rights under trademark law for use of some
    trade names, trademarks, or service marks; or

    f) Requiring indemnification of licensors and authors of that
    material by anyone who conveys the material (or modified versions of
    it) with contractual assumptions of liability to the recipient, for
    any liability that these contractual assumptions directly impose on
    those licensors and authors.

  All other non-permissive additional terms are considered "further
restrictions" within the meaning of section 10.  If the Program as you
received it, or any part of it, contains a notice stating that it is
governed by this License along with a term that is a further
restriction, you may remove that term.  If a license document contains
a further restriction but permits relicensing or conveying under this
License, you may add to a covered work material governed by the terms
of that license document, provided that the further restriction does
not survive such relicensing or conveying.

  If you add terms to a covered work in accord with this section, you
must place, in the relevant source files, a statement of the
additional terms that apply to those files, or a notice indicating
where to find the applicable terms.

  Additional terms, permissive or non-permissive, may be stated in the
form of a separately written license, or stated as exceptions;
the above requirements apply either way.

  8. Termination.

  You may not propagate or modify a covered work except as expressly
provided under this License.  Any attempt otherwise to propagate or
modify it is void, and will automatically terminate your rights under
this License (including any patent licenses granted under the third
paragraph of section 11).

  However, if you cease all violation of this License, then your
license from a particular copyright holder is reinstated (a)
provisionally, unless and until the copyright holder explicitly and
finally terminates your license, and (b) permanently, if the copyright
holder fails to notify you of the violation by some reasonable means
prior to 60 days after the cessation.

  Moreover, your license from a particular copyright holder is
reinstated permanently if the copyright holder notifies you of the
violation by some reasonable means, this is the first time you have
received notice of violation of this License (for any work) from that
copyright holder, and you cure the violation prior to 30 days after
your receipt of the notice.

  Termination of your rights under this section does not terminate the
licenses of parties who have received copies or rights from you under
this License.  If your rights have been terminated and not permanently
reinstated, you do not qualify to receive new licenses for the same
material under section 10.

  9. Acceptance Not Required for Having Copies.

  You are not required to accept this License in order to receive or
run a copy of the Program.  Ancillary propagation of a covered work
occurring solely as a consequence of using peer-to-peer transmission
to receive a copy likewise does not require acceptance.  However,
nothing other than this License grants you permission to propagate or
modify any covered work.  These actions infringe copyright if you do
not accept this License.  Therefore, by modifying or propagating a
covered work, you indicate your acceptance of this License to do so.

  10. Automatic Licensing of Downstream Recipients.

  Each time you convey a covered work, the recipient automatically
receives a license from the original licensors, to run, modify and
propagate that work, subject to this License.  You are not responsible
for enforcing compliance by third parties with this License.

  An "entity transaction" is a transaction transferring control of an
organization, or substantially all assets of one, or subdividing an
organization, or merging organizations.  If propagation of a covered
work results from an entity transaction, each party to that
transaction who receives a copy of the work also receives whatever
licenses to the work the party's predecessor in interest had or could
give under the previous paragraph, plus a right to possession of the
Corresponding Source of the work from the predecessor in interest, if
the predecessor has it or can get it with reasonable efforts.

  You may not impose any further restrictions on the exercise of the
rights granted or affirmed under this License.  For example, you may
not impose a license fee, royalty, or other charge for exercise of
rights granted under this License, and you may not initiate litigation
(including a cross-claim or counterclaim in a lawsuit) alleging that
any patent claim is infringed by making, using, selling, offering for
sale, or importing the Program or any portion of it.

  11. Patents.

  A "contributor" is a copyright holder who authorizes use under this
License of the Program or a work on which the Program is based.  The
work thus licensed is called the contributor's "contributor version".

  A contributor's "essential patent claims" are all patent claims
owned or controlled by the contributor, whether already acquired or
hereafter acquired, that would be infringed by some manner, permitted
by this License, of making, using, or selling its contributor version,
but do not include claims that would be infringed only as a
consequence of further modification of the contributor version.  For
purposes of this definition, "control" includes the right to grant
patent sublicenses in a manner consistent with the requirements of
this License.

  Each contributor grants you a non-exclusive, worldwide, royalty-free
patent license under the contributor's essential patent claims, to
make, use, sell, offer for sale, import and otherwise run, modify and
propagate the contents of its contributor version.

  In the following three paragraphs, a "patent license" is any express
agreement or commitment, however denominated, not to enforce a patent
(such as an express permission to practice a patent or covenant not to
sue for patent infringement).  To "grant" such a patent license to a
party means to make such an agreement or commitment not to enforce a
patent against the party.

  If you convey a covered work, knowingly relying on a patent license,
and the Corresponding Source of the work is not available for anyone
to copy, free of charge and under the terms of this License, through a
publicly available network server or other readily accessible means,
then you must either (1) cause the Corresponding Source to be so
available, or (2) arrange to deprive yourself of the benefit of the
patent license for this particular work, or (3) arrange, in a manner
consistent with the requirements of this License, to extend the patent
license to downstream recipients.  "Knowingly relying" means you have
actual knowledge that, but for the patent license, your conveying the
covered work in a country, or your recipient's use of the covered work
in a country, would infringe one or more identifiable patents in that
country that you have reason to believe are valid.

  If, pursuant to or in connection with a single transaction or
arrangement, you convey, or propagate by procuring conveyance of, a
covered work, and grant a patent license to some of the parties
receiving the covered work authorizing them to use, propagate, modify
or convey a specific copy of the covered work, then the patent license
you grant is automatically extended to all recipients of the covered
work and works based on it.

  A patent license is "discriminatory" if it does not include within
the scope of its coverage, prohibits the exercise of, or is
conditioned on the non-exercise of one or more of the rights that are
specifically granted under this License.  You may not convey a covered
work if you are a party to an arrangement with a third party that is
in the business of distributing software, under which you make payment
to the third party based on the extent of your activity of conveying
the work, and under which the third party grants, to any of the
parties who would receive the covered work from you, a discriminatory
patent license (a) in connection with copies of the covered work
conveyed by you (or copies made from those copies), or (b) primarily
for and in connection with specific products or compilations that
contain the covered work, unless you entered into that arrangement,
or that patent license was granted, prior to 28 March 2007.

  Nothing in this License shall be construed as excluding or limiting
any implied license or other defenses to infringement that may
otherwise be available to you under applicable patent law.

  12. No Surrender of Others' Freedom.

  If conditions are imposed on you (whether by court order, agreement or
otherwise) that contradict the conditions of this License, they do not
excuse you from the conditions of this License.  If you cannot convey a
covered work so as to satisfy simultaneously your obligations under this
License and any other pertinent obligations, then as a consequence you may
not convey it at all.  For example, if you agree to terms that obligate you
to collect a royalty for further conveying from those to whom you convey
the Program, the only way you could satisfy both those terms and this
License would be to refrain entirely from conveying the Program.

  13. Remote Network Interaction; Use with the GNU General Public License.

  Notwithstanding any other provision of this License, if you modify the
Program, your modified version must prominently offer all users
interacting with it remotely through a computer network (if your version
supports such interaction) an opportunity to receive the Corresponding
Source of your version by providing access to the Corresponding Source
from a network server at no charge, through some standard or customary
means of facilitating copying of software.  This Corresponding Source
shall include the Corresponding Source for any work covered by version 3
of the GNU General Public License that is incorporated pursuant to the
following paragraph.

  Notwithstanding any other provision of this License, you have
permission to link or combine any covered work with a work licensed
under version 3 of the GNU General Public License into a single
combined work, and to convey the resulting work.  The terms of this
License will continue to apply to the part which is the covered work,
but the work with which it is combined will remain governed by version
3 of the GNU General Public License.

  14. Revised Versions of this License.

  The Free Software Foundation may publish revised and/or new versions of
the GNU Affero General Public License from time to time.  Such new versions
will be similar in spirit to the present version, but may differ in detail to
address new problems or concerns.

  Each version is given a distinguishing version number.  If the
Program specifies that a certain numbered version of the GNU Affero General
Public License "or any later version" applies to it, you have the
option of following the terms and conditions either of that numbered
version or of any later version published by the Free Software
Foundation.  If the Program does not specify a version number of the
GNU Affero General Public License, you may choose any version ever published
by the Free Software Foundation.

  If the Program specifies that a proxy can decide which future
versions of the GNU Affero General Public License can be used, that proxy's
public statement of acceptance of a version permanently authorizes you
to choose that version for the Program.

  Later license versions may give you additional or different
permissions.  However, no additional obligations are imposed on any
author or copyright holder as a result of your choosing to follow a
later version.

  15. Disclaimer of Warranty.

  THERE IS NO WARRANTY FOR THE PROGRAM, TO THE EXTENT PERMITTED BY
APPLICABLE LAW.  EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT
HOLDERS AND/OR OTHER PARTIES PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY
OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO,
THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
PURPOSE.  THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE PROGRAM
IS WITH YOU.  SHOULD THE PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF
ALL NECESSARY SERVICING, REPAIR OR CORRECTION.

  16. Limitation of Liability.

  IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MODIFIES AND/OR CONVEYS
THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES, INCLUDING ANY
GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING OUT OF THE
USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED TO LOSS OF
DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY YOU OR THIRD
PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER PROGRAMS),
EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE POSSIBILITY OF
SUCH DAMAGES.

  17. Interpretation of Sections 15 and 16.

  If the disclaimer of warranty and limitation of liability provided
above cannot be given local legal effect according to their terms,
reviewing courts shall apply local law that most closely approximates
an absolute waiver of all civil liability in connection with the
Program, unless a warranty or assumption of liability accompanies a
copy of the Program in return for a fee.

                     END OF TERMS AND CONDITIONS

            How to Apply These Terms to Your New Programs

  If you develop a new program, and you want it to be of the greatest
possible use to the public, the best way to achieve this is to make it
free software which everyone can redistribute and change under these terms.

  To do so, attach the following notices to the program.  It is safest
to attach them to the start of each source file to most effectively
state the exclusion of warranty; and each file should have at least
the "copyright" line and a pointer to where the full notice is found.

    <one line to give the program's name and a brief idea of what it does.>
    Copyright (C) <year>  <name of author>

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published
    by the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.

Also add information on how to contact you by electronic and paper mail.

  If your software can interact with users remotely through a computer
network, you should also make sure that it provides a way for users to
get its source.  For example, if your program is a web application, its
interface could display a "Source" link that leads users to an archive
of the code.  There are many ways you could offer source, and different
solutions will be better for different programs; see section 13 for the
specific requirements.

  You should also get your employer (if you work as a programmer) or school,
if any, to sign a "copyright disclaimer" for the program, if necessary.
For more information on this, and how to apply and follow the GNU AGPL, see
<https://www.gnu.org/licenses/>.



================================================
FILE: package.json
================================================
{
  "private": true,
  "scripts": {
    "build": "turbo run build",
    "start": "turbo run start",
    "dev": "turbo run dev",
    "lint": "turbo run lint",
    "format": "prettier --write \"**/*.{ts,tsx,md}\""
  },
  "devDependencies": {
    "eslint": "^8.57.0",
    "prettier": "^3.3.3",
    "turbo": "^1.13.4"
  },
  "packageManager": "pnpm@9.0.6"
}



================================================
FILE: pnpm-lock.yaml
================================================
lockfileVersion: '9.0'

settings:
  autoInstallPeers: true
  excludeLinksFromLockfile: false

importers:

  .:
    devDependencies:
      eslint:
        specifier: ^8.57.0
        version: 8.57.0
      prettier:
        specifier: ^3.3.3
        version: 3.3.3
      turbo:
        specifier: ^1.13.4
        version: 1.13.4

packages:

  '@eslint-community/eslint-utils@4.4.0':
    resolution: {integrity: sha512-1/sA4dwrzBAyeUoQ6oxahHKmrZvsnLCg4RfxW3ZFGGmQkSNQPFNLV9CUEFQP1x9EYXHTo5p6xdhZM1Ne9p/AfA==}
    engines: {node: ^12.22.0 || ^14.17.0 || >=16.0.0}
    peerDependencies:
      eslint: ^6.0.0 || ^7.0.0 || >=8.0.0

  '@eslint-community/regexpp@4.10.0':
    resolution: {integrity: sha512-Cu96Sd2By9mCNTx2iyKOmq10v22jUVQv0lQnlGNy16oE9589yE+QADPbrMGCkA51cKZSg3Pu/aTJVTGfL/qjUA==}
    engines: {node: ^12.0.0 || ^14.0.0 || >=16.0.0}

  '@eslint/eslintrc@2.1.4':
    resolution: {integrity: sha512-269Z39MS6wVJtsoUl10L60WdkhJVdPG24Q4eZTH3nnF6lpvSShEK3wQjDX9JRWAUPvPh7COouPpU9IrqaZFvtQ==}
    engines: {node: ^12.22.0 || ^14.17.0 || >=16.0.0}

  '@eslint/js@8.57.0':
    resolution: {integrity: sha512-Ys+3g2TaW7gADOJzPt83SJtCDhMjndcDMFVQ/Tj9iA1BfJzFKD9mAUXT3OenpuPHbI6P/myECxRJrofUsDx/5g==}
    engines: {node: ^12.22.0 || ^14.17.0 || >=16.0.0}

  '@humanwhocodes/config-array@0.11.14':
    resolution: {integrity: sha512-3T8LkOmg45BV5FICb15QQMsyUSWrQ8AygVfC7ZG32zOalnqrilm018ZVCw0eapXux8FtA33q8PSRSstjee3jSg==}
    engines: {node: '>=10.10.0'}

  '@humanwhocodes/module-importer@1.0.1':
    resolution: {integrity: sha512-bxveV4V8v5Yb4ncFTT3rPSgZBOpCkjfK0y4oVVVJwIuDVBRMDXrPyXRL988i5ap9m9bnyEEjWfm5WkBmtffLfA==}
    engines: {node: '>=12.22'}

  '@humanwhocodes/object-schema@2.0.3':
    resolution: {integrity: sha512-93zYdMES/c1D69yZiKDBj0V24vqNzB/koF26KPaagAfd3P/4gUlh3Dys5ogAK+Exi9QyzlD8x/08Zt7wIKcDcA==}

  '@nodelib/fs.scandir@2.1.5':
    resolution: {integrity: sha512-vq24Bq3ym5HEQm2NKCr3yXDwjc7vTsEThRDnkp2DK9p1uqLR+DHurm/NOTo0KG7HYHU7eppKZj3MyqYuMBf62g==}
    engines: {node: '>= 8'}

  '@nodelib/fs.stat@2.0.5':
    resolution: {integrity: sha512-RkhPPp2zrqDAQA/2jNhnztcPAlv64XdhIp7a7454A5ovI7Bukxgt7MX7udwAu3zg1DcpPU0rz3VV1SeaqvY4+A==}
    engines: {node: '>= 8'}

  '@nodelib/fs.walk@1.2.8':
    resolution: {integrity: sha512-oGB+UxlgWcgQkgwo8GcEGwemoTFt3FIO9ababBmaGwXIoBKZ+GTy0pP185beGg7Llih/NSHSV2XAs1lnznocSg==}
    engines: {node: '>= 8'}

  '@ungap/structured-clone@1.2.0':
    resolution: {integrity: sha512-zuVdFrMJiuCDQUMCzQaD6KL28MjnqqN8XnAqiEq9PNm/hCPTSGfrXCOfwj1ow4LFb/tNymJPwsNbVePc1xFqrQ==}

  acorn-jsx@5.3.2:
    resolution: {integrity: sha512-rq9s+JNhf0IChjtDXxllJ7g41oZk5SlXtp0LHwyA5cejwn7vKmKp4pPri6YEePv2PU65sAsegbXtIinmDFDXgQ==}
    peerDependencies:
      acorn: ^6.0.0 || ^7.0.0 || ^8.0.0

  acorn@8.11.3:
    resolution: {integrity: sha512-Y9rRfJG5jcKOE0CLisYbojUjIrIEE7AGMzA/Sm4BslANhbS+cDMpgBdcPT91oJ7OuJ9hYJBx59RjbhxVnrF8Xg==}
    engines: {node: '>=0.4.0'}
    hasBin: true

  ajv@6.12.6:
    resolution: {integrity: sha512-j3fVLgvTo527anyYyJOGTYJbG+vnnQYvE0m5mmkc1TK+nxAppkCLMIL0aZ4dblVCNoGShhm+kzE4ZUykBoMg4g==}

  ansi-regex@5.0.1:
    resolution: {integrity: sha512-quJQXlTSUGL2LH9SUXo8VwsY4soanhgo6LNSm84E1LBcE8s3O0wpdiRzyR9z/ZZJMlMWv37qOOb9pdJlMUEKFQ==}
    engines: {node: '>=8'}

  ansi-styles@4.3.0:
    resolution: {integrity: sha512-zbB9rCJAT1rbjiVDb2hqKFHNYLxgtk8NURxZ3IZwD3F6NtxbXZQCnnSi1Lkx+IDohdPlFp222wVALIheZJQSEg==}
    engines: {node: '>=8'}

  argparse@2.0.1:
    resolution: {integrity: sha512-8+9WqebbFzpX9OR+Wa6O29asIogeRMzcGtAINdpMHHyAg10f05aSFVBbcEqGf/PXw1EjAZ+q2/bEBg3DvurK3Q==}

  balanced-match@1.0.2:
    resolution: {integrity: sha512-3oSeUO0TMV67hN1AmbXsK4yaqU7tjiHlbxRDZOpH0KW9+CeX4bRAaX0Anxt0tx2MrpRpWwQaPwIlISEJhYU5Pw==}

  brace-expansion@1.1.11:
    resolution: {integrity: sha512-iCuPHDFgrHX7H2vEI/5xpz07zSHB00TpugqhmYtVmMO6518mCuRMoOYFldEBl0g187ufozdaHgWKcYFb61qGiA==}

  callsites@3.1.0:
    resolution: {integrity: sha512-P8BjAsXvZS+VIDUI11hHCQEv74YT67YUi5JJFNWIqL235sBmjX4+qx9Muvls5ivyNENctx46xQLQ3aTuE7ssaQ==}
    engines: {node: '>=6'}

  chalk@4.1.2:
    resolution: {integrity: sha512-oKnbhFyRIXpUuez8iBMmyEa4nbj4IOQyuhc/wy9kY7/WVPcwIO9VA668Pu8RkO7+0G76SLROeyw9CpQ061i4mA==}
    engines: {node: '>=10'}

  color-convert@2.0.1:
    resolution: {integrity: sha512-RRECPsj7iu/xb5oKYcsFHSppFNnsj/52OVTRKb4zP5onXwVF3zVmmToNcOfGC+CRDpfK/U584fMg38ZHCaElKQ==}
    engines: {node: '>=7.0.0'}

  color-name@1.1.4:
    resolution: {integrity: sha512-dOy+3AuW3a2wNbZHIuMZpTcgjGuLU/uBL/ubcZF9OXbDo8ff4O8yVp5Bf0efS8uEoYo5q4Fx7dY9OgQGXgAsQA==}

  concat-map@0.0.1:
    resolution: {integrity: sha512-/Srv4dswyQNBfohGpz9o6Yb3Gz3SrUDqBH5rTuhGR7ahtlbYKnVxw2bCFMRljaA7EXHaXZ8wsHdodFvbkhKmqg==}

  cross-spawn@7.0.3:
    resolution: {integrity: sha512-iRDPJKUPVEND7dHPO8rkbOnPpyDygcDFtWjpeWNCgy8WP2rXcxXL8TskReQl6OrB2G7+UJrags1q15Fudc7G6w==}
    engines: {node: '>= 8'}

  debug@4.3.5:
    resolution: {integrity: sha512-pt0bNEmneDIvdL1Xsd9oDQ/wrQRkXDT4AUWlNZNPKvW5x/jyO9VFXkJUP07vQ2upmw5PlaITaPKc31jK13V+jg==}
    engines: {node: '>=6.0'}
    peerDependencies:
      supports-color: '*'
    peerDependenciesMeta:
      supports-color:
        optional: true

  deep-is@0.1.4:
    resolution: {integrity: sha512-oIPzksmTg4/MriiaYGO+okXDT7ztn/w3Eptv/+gSIdMdKsJo0u4CfYNFJPy+4SKMuCqGw2wxnA+URMg3t8a/bQ==}

  doctrine@3.0.0:
    resolution: {integrity: sha512-yS+Q5i3hBf7GBkd4KG8a7eBNNWNGLTaEwwYWUijIYM7zrlYDM0BFXHjjPWlWZ1Rg7UaddZeIDmi9jF3HmqiQ2w==}
    engines: {node: '>=6.0.0'}

  escape-string-regexp@4.0.0:
    resolution: {integrity: sha512-TtpcNJ3XAzx3Gq8sWRzJaVajRs0uVxA2YAkdb1jm2YkPz4G6egUFAyA3n5vtEIZefPk5Wa4UXbKuS5fKkJWdgA==}
    engines: {node: '>=10'}

  eslint-scope@7.2.2:
    resolution: {integrity: sha512-dOt21O7lTMhDM+X9mB4GX+DZrZtCUJPL/wlcTqxyrx5IvO0IYtILdtrQGQp+8n5S0gwSVmOf9NQrjMOgfQZlIg==}
    engines: {node: ^12.22.0 || ^14.17.0 || >=16.0.0}

  eslint-visitor-keys@3.4.3:
    resolution: {integrity: sha512-wpc+LXeiyiisxPlEkUzU6svyS1frIO3Mgxj1fdy7Pm8Ygzguax2N3Fa/D/ag1WqbOprdI+uY6wMUl8/a2G+iag==}
    engines: {node: ^12.22.0 || ^14.17.0 || >=16.0.0}

  eslint@8.57.0:
    resolution: {integrity: sha512-dZ6+mexnaTIbSBZWgou51U6OmzIhYM2VcNdtiTtI7qPNZm35Akpr0f6vtw3w1Kmn5PYo+tZVfh13WrhpS6oLqQ==}
    engines: {node: ^12.22.0 || ^14.17.0 || >=16.0.0}
    hasBin: true

  espree@9.6.1:
    resolution: {integrity: sha512-oruZaFkjorTpF32kDSI5/75ViwGeZginGGy2NoOSg3Q9bnwlnmDm4HLnkl0RE3n+njDXR037aY1+x58Z/zFdwQ==}
    engines: {node: ^12.22.0 || ^14.17.0 || >=16.0.0}

  esquery@1.5.0:
    resolution: {integrity: sha512-YQLXUplAwJgCydQ78IMJywZCceoqk1oH01OERdSAJc/7U2AylwjhSCLDEtqwg811idIS/9fIU5GjG73IgjKMVg==}
    engines: {node: '>=0.10'}

  esrecurse@4.3.0:
    resolution: {integrity: sha512-KmfKL3b6G+RXvP8N1vr3Tq1kL/oCFgn2NYXEtqP8/L3pKapUA4G8cFVaoF3SU323CD4XypR/ffioHmkti6/Tag==}
    engines: {node: '>=4.0'}

  estraverse@5.3.0:
    resolution: {integrity: sha512-MMdARuVEQziNTeJD8DgMqmhwR11BRQ/cBP+pLtYdSTnf3MIO8fFeiINEbX36ZdNlfU/7A9f3gUw49B3oQsvwBA==}
    engines: {node: '>=4.0'}

  esutils@2.0.3:
    resolution: {integrity: sha512-kVscqXk4OCp68SZ0dkgEKVi6/8ij300KBWTJq32P/dYeWTSwK41WyTxalN1eRmA5Z9UU/LX9D7FWSmV9SAYx6g==}
    engines: {node: '>=0.10.0'}

  fast-deep-equal@3.1.3:
    resolution: {integrity: sha512-f3qQ9oQy9j2AhBe/H9VC91wLmKBCCU/gDOnKNAYG5hswO7BLKj09Hc5HYNz9cGI++xlpDCIgDaitVs03ATR84Q==}

  fast-json-stable-stringify@2.1.0:
    resolution: {integrity: sha512-lhd/wF+Lk98HZoTCtlVraHtfh5XYijIjalXck7saUtuanSDyLMxnHhSXEDJqHxD7msR8D0uCmqlkwjCV8xvwHw==}

  fast-levenshtein@2.0.6:
    resolution: {integrity: sha512-DCXu6Ifhqcks7TZKY3Hxp3y6qphY5SJZmrWMDrKcERSOXWQdMhU9Ig/PYrzyw/ul9jOIyh0N4M0tbC5hodg8dw==}

  fastq@1.17.1:
    resolution: {integrity: sha512-sRVD3lWVIXWg6By68ZN7vho9a1pQcN/WBFaAAsDDFzlJjvoGx0P8z7V1t72grFJfJhu3YPZBuu25f7Kaw2jN1w==}

  file-entry-cache@6.0.1:
    resolution: {integrity: sha512-7Gps/XWymbLk2QLYK4NzpMOrYjMhdIxXuIvy2QBsLE6ljuodKvdkWs/cpyJJ3CVIVpH0Oi1Hvg1ovbMzLdFBBg==}
    engines: {node: ^10.12.0 || >=12.0.0}

  find-up@5.0.0:
    resolution: {integrity: sha512-78/PXT1wlLLDgTzDs7sjq9hzz0vXD+zn+7wypEe4fXQxCmdmqfGsEPQxmiCSQI3ajFV91bVSsvNtrJRiW6nGng==}
    engines: {node: '>=10'}

  flat-cache@3.2.0:
    resolution: {integrity: sha512-CYcENa+FtcUKLmhhqyctpclsq7QF38pKjZHsGNiSQF5r4FtoKDWabFDl3hzaEQMvT1LHEysw5twgLvpYYb4vbw==}
    engines: {node: ^10.12.0 || >=12.0.0}

  flatted@3.3.1:
    resolution: {integrity: sha512-X8cqMLLie7KsNUDSdzeN8FYK9rEt4Dt67OsG/DNGnYTSDBG4uFAJFBnUeiV+zCVAvwFy56IjM9sH51jVaEhNxw==}

  fs.realpath@1.0.0:
    resolution: {integrity: sha512-OO0pH2lK6a0hZnAdau5ItzHPI6pUlvI7jMVnxUQRtw4owF2wk8lOSabtGDCTP4Ggrg2MbGnWO9X8K1t4+fGMDw==}

  glob-parent@6.0.2:
    resolution: {integrity: sha512-XxwI8EOhVQgWp6iDL+3b0r86f4d6AX6zSU55HfB4ydCEuXLXc5FcYeOu+nnGftS4TEju/11rt4KJPTMgbfmv4A==}
    engines: {node: '>=10.13.0'}

  glob@7.2.3:
    resolution: {integrity: sha512-nFR0zLpU2YCaRxwoCJvL6UvCH2JFyFVIvwTLsIf21AuHlMskA1hhTdk+LlYJtOlYt9v6dvszD2BGRqBL+iQK9Q==}
    deprecated: Glob versions prior to v9 are no longer supported

  globals@13.24.0:
    resolution: {integrity: sha512-AhO5QUcj8llrbG09iWhPU2B204J1xnPeL8kQmVorSsy+Sjj1sk8gIyh6cUocGmH4L0UuhAJy+hJMRA4mgA4mFQ==}
    engines: {node: '>=8'}

  graphemer@1.4.0:
    resolution: {integrity: sha512-EtKwoO6kxCL9WO5xipiHTZlSzBm7WLT627TqC/uVRd0HKmq8NXyebnNYxDoBi7wt8eTWrUrKXCOVaFq9x1kgag==}

  has-flag@4.0.0:
    resolution: {integrity: sha512-EykJT/Q1KjTWctppgIAgfSO0tKVuZUjhgMr17kqTumMl6Afv3EISleU7qZUzoXDFTAHTDC4NOoG/ZxU3EvlMPQ==}
    engines: {node: '>=8'}

  ignore@5.3.1:
    resolution: {integrity: sha512-5Fytz/IraMjqpwfd34ke28PTVMjZjJG2MPn5t7OE4eUCUNf8BAa7b5WUS9/Qvr6mwOQS7Mk6vdsMno5he+T8Xw==}
    engines: {node: '>= 4'}

  import-fresh@3.3.0:
    resolution: {integrity: sha512-veYYhQa+D1QBKznvhUHxb8faxlrwUnxseDAbAp457E0wLNio2bOSKnjYDhMj+YiAq61xrMGhQk9iXVk5FzgQMw==}
    engines: {node: '>=6'}

  imurmurhash@0.1.4:
    resolution: {integrity: sha512-JmXMZ6wuvDmLiHEml9ykzqO6lwFbof0GG4IkcGaENdCRDDmMVnny7s5HsIgHCbaq0w2MyPhDqkhTUgS2LU2PHA==}
    engines: {node: '>=0.8.19'}

  inflight@1.0.6:
    resolution: {integrity: sha512-k92I/b08q4wvFscXCLvqfsHCrjrF7yiXsQuIVvVE7N82W3+aqpzuUdBbfhWcy/FZR3/4IgflMgKLOsvPDrGCJA==}
    deprecated: This module is not supported, and leaks memory. Do not use it. Check out lru-cache if you want a good and tested way to coalesce async requests by a key value, which is much more comprehensive and powerful.

  inherits@2.0.4:
    resolution: {integrity: sha512-k/vGaX4/Yla3WzyMCvTQOXYeIHvqOKtnqBduzTHpzpQZzAskKMhZ2K+EnBiSM9zGSoIFeMpXKxa4dYeZIQqewQ==}

  is-extglob@2.1.1:
    resolution: {integrity: sha512-SbKbANkN603Vi4jEZv49LeVJMn4yGwsbzZworEoyEiutsN3nJYdbO36zfhGJ6QEDpOZIFkDtnq5JRxmvl3jsoQ==}
    engines: {node: '>=0.10.0'}

  is-glob@4.0.3:
    resolution: {integrity: sha512-xelSayHH36ZgE7ZWhli7pW34hNbNl8Ojv5KVmkJD4hBdD3th8Tfk9vYasLM+mXWOZhFkgZfxhLSnrwRr4elSSg==}
    engines: {node: '>=0.10.0'}

  is-path-inside@3.0.3:
    resolution: {integrity: sha512-Fd4gABb+ycGAmKou8eMftCupSir5lRxqf4aD/vd0cD2qc4HL07OjCeuHMr8Ro4CoMaeCKDB0/ECBOVWjTwUvPQ==}
    engines: {node: '>=8'}

  isexe@2.0.0:
    resolution: {integrity: sha512-RHxMLp9lnKHGHRng9QFhRCMbYAcVpn69smSGcq3f36xjgVVWThj4qqLbTLlq7Ssj8B+fIQ1EuCEGI2lKsyQeIw==}

  js-yaml@4.1.0:
    resolution: {integrity: sha512-wpxZs9NoxZaJESJGIZTyDEaYpl0FKSA+FB9aJiyemKhMwkxQg63h4T1KJgUGHpTqPDNRcmmYLugrRjJlBtWvRA==}
    hasBin: true

  json-buffer@3.0.1:
    resolution: {integrity: sha512-4bV5BfR2mqfQTJm+V5tPPdf+ZpuhiIvTuAB5g8kcrXOZpTT/QwwVRWBywX1ozr6lEuPdbHxwaJlm9G6mI2sfSQ==}

  json-schema-traverse@0.4.1:
    resolution: {integrity: sha512-xbbCH5dCYU5T8LcEhhuh7HJ88HXuW3qsI3Y0zOZFKfZEHcpWiHU/Jxzk629Brsab/mMiHQti9wMP+845RPe3Vg==}

  json-stable-stringify-without-jsonify@1.0.1:
    resolution: {integrity: sha512-Bdboy+l7tA3OGW6FjyFHWkP5LuByj1Tk33Ljyq0axyzdk9//JSi2u3fP1QSmd1KNwq6VOKYGlAu87CisVir6Pw==}

  keyv@4.5.4:
    resolution: {integrity: sha512-oxVHkHR/EJf2CNXnWxRLW6mg7JyCCUcG0DtEGmL2ctUo1PNTin1PUil+r/+4r5MpVgC/fn1kjsx7mjSujKqIpw==}

  levn@0.4.1:
    resolution: {integrity: sha512-+bT2uH4E5LGE7h/n3evcS/sQlJXCpIp6ym8OWJ5eV6+67Dsql/LaaT7qJBAt2rzfoa/5QBGBhxDix1dMt2kQKQ==}
    engines: {node: '>= 0.8.0'}

  locate-path@6.0.0:
    resolution: {integrity: sha512-iPZK6eYjbxRu3uB4/WZ3EsEIMJFMqAoopl3R+zuq0UjcAm/MO6KCweDgPfP3elTztoKP3KtnVHxTn2NHBSDVUw==}
    engines: {node: '>=10'}

  lodash.merge@4.6.2:
    resolution: {integrity: sha512-0KpjqXRVvrYyCsX1swR/XTK0va6VQkQM6MNo7PqW77ByjAhoARA8EfrP1N4+KlKj8YS0ZUCtRT/YUuhyYDujIQ==}

  minimatch@3.1.2:
    resolution: {integrity: sha512-J7p63hRiAjw1NDEww1W7i37+ByIrOWO5XQQAzZ3VOcL0PNybwpfmV/N05zFAzwQ9USyEcX6t3UO+K5aqBQOIHw==}

  ms@2.1.2:
    resolution: {integrity: sha512-sGkPx+VjMtmA6MX27oA4FBFELFCZZ4S4XqeGOXCv68tT+jb3vk/RyaKWP0PTKyWtmLSM0b+adUTEvbs1PEaH2w==}

  natural-compare@1.4.0:
    resolution: {integrity: sha512-OWND8ei3VtNC9h7V60qff3SVobHr996CTwgxubgyQYEpg290h9J0buyECNNJexkFm5sOajh5G116RYA1c8ZMSw==}

  once@1.4.0:
    resolution: {integrity: sha512-lNaJgI+2Q5URQBkccEKHTQOPaXdUxnZZElQTZY0MFUAuaEqe1E+Nyvgdz/aIyNi6Z9MzO5dv1H8n58/GELp3+w==}

  optionator@0.9.4:
    resolution: {integrity: sha512-6IpQ7mKUxRcZNLIObR0hz7lxsapSSIYNZJwXPGeF0mTVqGKFIXj1DQcMoT22S3ROcLyY/rz0PWaWZ9ayWmad9g==}
    engines: {node: '>= 0.8.0'}

  p-limit@3.1.0:
    resolution: {integrity: sha512-TYOanM3wGwNGsZN2cVTYPArw454xnXj5qmWF1bEoAc4+cU/ol7GVh7odevjp1FNHduHc3KZMcFduxU5Xc6uJRQ==}
    engines: {node: '>=10'}

  p-locate@5.0.0:
    resolution: {integrity: sha512-LaNjtRWUBY++zB5nE/NwcaoMylSPk+S+ZHNB1TzdbMJMny6dynpAGt7X/tl/QYq3TIeE6nxHppbo2LGymrG5Pw==}
    engines: {node: '>=10'}

  parent-module@1.0.1:
    resolution: {integrity: sha512-GQ2EWRpQV8/o+Aw8YqtfZZPfNRWZYkbidE9k5rpl/hC3vtHHBfGm2Ifi6qWV+coDGkrUKZAxE3Lot5kcsRlh+g==}
    engines: {node: '>=6'}

  path-exists@4.0.0:
    resolution: {integrity: sha512-ak9Qy5Q7jYb2Wwcey5Fpvg2KoAc/ZIhLSLOSBmRmygPsGwkVVt0fZa0qrtMz+m6tJTAHfZQ8FnmB4MG4LWy7/w==}
    engines: {node: '>=8'}

  path-is-absolute@1.0.1:
    resolution: {integrity: sha512-AVbw3UJ2e9bq64vSaS9Am0fje1Pa8pbGqTTsmXfaIiMpnr5DlDhfJOuLj9Sf95ZPVDAUerDfEk88MPmPe7UCQg==}
    engines: {node: '>=0.10.0'}

  path-key@3.1.1:
    resolution: {integrity: sha512-ojmeN0qd+y0jszEtoY48r0Peq5dwMEkIlCOu6Q5f41lfkswXuKtYrhgoTpLnyIcHm24Uhqx+5Tqm2InSwLhE6Q==}
    engines: {node: '>=8'}

  prelude-ls@1.2.1:
    resolution: {integrity: sha512-vkcDPrRZo1QZLbn5RLGPpg/WmIQ65qoWWhcGKf/b5eplkkarX0m9z8ppCat4mlOqUsWpyNuYgO3VRyrYHSzX5g==}
    engines: {node: '>= 0.8.0'}

  prettier@3.3.3:
    resolution: {integrity: sha512-i2tDNA0O5IrMO757lfrdQZCc2jPNDVntV0m/+4whiDfWaTKfMNgR7Qz0NAeGz/nRqF4m5/6CLzbP4/liHt12Ew==}
    engines: {node: '>=14'}
    hasBin: true

  punycode@2.3.1:
    resolution: {integrity: sha512-vYt7UD1U9Wg6138shLtLOvdAu+8DsC/ilFtEVHcH+wydcSpNE20AfSOduf6MkRFahL5FY7X1oU7nKVZFtfq8Fg==}
    engines: {node: '>=6'}

  queue-microtask@1.2.3:
    resolution: {integrity: sha512-NuaNSa6flKT5JaSYQzJok04JzTL1CA6aGhv5rfLW3PgqA+M2ChpZQnAC8h8i4ZFkBS8X5RqkDBHA7r4hej3K9A==}

  resolve-from@4.0.0:
    resolution: {integrity: sha512-pb/MYmXstAkysRFx8piNI1tGFNQIFA3vkE3Gq4EuA1dF6gHp/+vgZqsCGJapvy8N3Q+4o7FwvquPJcnZ7RYy4g==}
    engines: {node: '>=4'}

  reusify@1.0.4:
    resolution: {integrity: sha512-U9nH88a3fc/ekCF1l0/UP1IosiuIjyTh7hBvXVMHYgVcfGvt897Xguj2UOLDeI5BG2m7/uwyaLVT6fbtCwTyzw==}
    engines: {iojs: '>=1.0.0', node: '>=0.10.0'}

  rimraf@3.0.2:
    resolution: {integrity: sha512-JZkJMZkAGFFPP2YqXZXPbMlMBgsxzE8ILs4lMIX/2o0L9UBw9O/Y3o6wFw/i9YLapcUJWwqbi3kdxIPdC62TIA==}
    deprecated: Rimraf versions prior to v4 are no longer supported
    hasBin: true

  run-parallel@1.2.0:
    resolution: {integrity: sha512-5l4VyZR86LZ/lDxZTR6jqL8AFE2S0IFLMP26AbjsLVADxHdhB/c0GUsH+y39UfCi3dzz8OlQuPmnaJOMoDHQBA==}

  shebang-command@2.0.0:
    resolution: {integrity: sha512-kHxr2zZpYtdmrN1qDjrrX/Z1rR1kG8Dx+gkpK1G4eXmvXswmcE1hTWBWYUzlraYw1/yZp6YuDY77YtvbN0dmDA==}
    engines: {node: '>=8'}

  shebang-regex@3.0.0:
    resolution: {integrity: sha512-7++dFhtcx3353uBaq8DDR4NuxBetBzC7ZQOhmTQInHEd6bSrXdiEyzCvG07Z44UYdLShWUyXt5M/yhz8ekcb1A==}
    engines: {node: '>=8'}

  strip-ansi@6.0.1:
    resolution: {integrity: sha512-Y38VPSHcqkFrCpFnQ9vuSXmquuv5oXOKpGeT6aGrr3o3Gc9AlVa6JBfUSOCnbxGGZF+/0ooI7KrPuUSztUdU5A==}
    engines: {node: '>=8'}

  strip-json-comments@3.1.1:
    resolution: {integrity: sha512-6fPc+R4ihwqP6N/aIv2f1gMH8lOVtWQHoqC4yK6oSDVVocumAsfCqjkXnqiYMhmMwS/mEHLp7Vehlt3ql6lEig==}
    engines: {node: '>=8'}

  supports-color@7.2.0:
    resolution: {integrity: sha512-qpCAvRl9stuOHveKsn7HncJRvv501qIacKzQlO/+Lwxc9+0q2wLyv4Dfvt80/DPn2pqOBsJdDiogXGR9+OvwRw==}
    engines: {node: '>=8'}

  text-table@0.2.0:
    resolution: {integrity: sha512-N+8UisAXDGk8PFXP4HAzVR9nbfmVJ3zYLAWiTIoqC5v5isinhr+r5uaO8+7r3BMfuNIufIsA7RdpVgacC2cSpw==}

  turbo-darwin-64@1.13.4:
    resolution: {integrity: sha512-A0eKd73R7CGnRinTiS7txkMElg+R5rKFp9HV7baDiEL4xTG1FIg/56Vm7A5RVgg8UNgG2qNnrfatJtb+dRmNdw==}
    cpu: [x64]
    os: [darwin]

  turbo-darwin-arm64@1.13.4:
    resolution: {integrity: sha512-eG769Q0NF6/Vyjsr3mKCnkG/eW6dKMBZk6dxWOdrHfrg6QgfkBUk0WUUujzdtVPiUIvsh4l46vQrNVd9EOtbyA==}
    cpu: [arm64]
    os: [darwin]

  turbo-linux-64@1.13.4:
    resolution: {integrity: sha512-Bq0JphDeNw3XEi+Xb/e4xoKhs1DHN7OoLVUbTIQz+gazYjigVZvtwCvgrZI7eW9Xo1eOXM2zw2u1DGLLUfmGkQ==}
    cpu: [x64]
    os: [linux]

  turbo-linux-arm64@1.13.4:
    resolution: {integrity: sha512-BJcXw1DDiHO/okYbaNdcWN6szjXyHWx9d460v6fCHY65G8CyqGU3y2uUTPK89o8lq/b2C8NK0yZD+Vp0f9VoIg==}
    cpu: [arm64]
    os: [linux]

  turbo-windows-64@1.13.4:
    resolution: {integrity: sha512-OFFhXHOFLN7A78vD/dlVuuSSVEB3s9ZBj18Tm1hk3aW1HTWTuAw0ReN6ZNlVObZUHvGy8d57OAGGxf2bT3etQw==}
    cpu: [x64]
    os: [win32]

  turbo-windows-arm64@1.13.4:
    resolution: {integrity: sha512-u5A+VOKHswJJmJ8o8rcilBfU5U3Y1TTAfP9wX8bFh8teYF1ghP0EhtMRLjhtp6RPa+XCxHHVA2CiC3gbh5eg5g==}
    cpu: [arm64]
    os: [win32]

  turbo@1.13.4:
    resolution: {integrity: sha512-1q7+9UJABuBAHrcC4Sxp5lOqYS5mvxRrwa33wpIyM18hlOCpRD/fTJNxZ0vhbMcJmz15o9kkVm743mPn7p6jpQ==}
    hasBin: true

  type-check@0.4.0:
    resolution: {integrity: sha512-XleUoc9uwGXqjWwXaUTZAmzMcFZ5858QA2vvx1Ur5xIcixXIP+8LnFDgRplU30us6teqdlskFfu+ae4K79Ooew==}
    engines: {node: '>= 0.8.0'}

  type-fest@0.20.2:
    resolution: {integrity: sha512-Ne+eE4r0/iWnpAxD852z3A+N0Bt5RN//NjJwRd2VFHEmrywxf5vsZlh4R6lixl6B+wz/8d+maTSAkN1FIkI3LQ==}
    engines: {node: '>=10'}

  uri-js@4.4.1:
    resolution: {integrity: sha512-7rKUyy33Q1yc98pQ1DAmLtwX109F7TIfWlW1Ydo8Wl1ii1SeHieeh0HHfPeL2fMXK6z0s8ecKs9frCuLJvndBg==}

  which@2.0.2:
    resolution: {integrity: sha512-BLI3Tl1TW3Pvl70l3yq3Y64i+awpwXqsGBYWkkqMtnbXgrMD+yj7rhW0kuEDxzJaYXGjEW5ogapKNMEKNMjibA==}
    engines: {node: '>= 8'}
    hasBin: true

  word-wrap@1.2.5:
    resolution: {integrity: sha512-BN22B5eaMMI9UMtjrGd5g5eCYPpCPDUy0FJXbYsaT5zYxjFOckS53SQDE3pWkVoWpHXVb3BrYcEN4Twa55B5cA==}
    engines: {node: '>=0.10.0'}

  wrappy@1.0.2:
    resolution: {integrity: sha512-l4Sp/DRseor9wL6EvV2+TuQn63dMkPjZ/sp9XkghTEbV9KlPS1xUsZ3u7/IQO4wxtcFB4bgpQPRcR3QCvezPcQ==}

  yocto-queue@0.1.0:
    resolution: {integrity: sha512-rVksvsnNCdJ/ohGc6xgPwyN8eheCxsiLM8mxuE/t/mOVqJewPuO1miLpTHQiRgTKCLexL4MeAFVagts7HmNZ2Q==}
    engines: {node: '>=10'}

snapshots:

  '@eslint-community/eslint-utils@4.4.0(eslint@8.57.0)':
    dependencies:
      eslint: 8.57.0
      eslint-visitor-keys: 3.4.3

  '@eslint-community/regexpp@4.10.0': {}

  '@eslint/eslintrc@2.1.4':
    dependencies:
      ajv: 6.12.6
      debug: 4.3.5
      espree: 9.6.1
      globals: 13.24.0
      ignore: 5.3.1
      import-fresh: 3.3.0
      js-yaml: 4.1.0
      minimatch: 3.1.2
      strip-json-comments: 3.1.1
    transitivePeerDependencies:
      - supports-color

  '@eslint/js@8.57.0': {}

  '@humanwhocodes/config-array@0.11.14':
    dependencies:
      '@humanwhocodes/object-schema': 2.0.3
      debug: 4.3.5
      minimatch: 3.1.2
    transitivePeerDependencies:
      - supports-color

  '@humanwhocodes/module-importer@1.0.1': {}

  '@humanwhocodes/object-schema@2.0.3': {}

  '@nodelib/fs.scandir@2.1.5':
    dependencies:
      '@nodelib/fs.stat': 2.0.5
      run-parallel: 1.2.0

  '@nodelib/fs.stat@2.0.5': {}

  '@nodelib/fs.walk@1.2.8':
    dependencies:
      '@nodelib/fs.scandir': 2.1.5
      fastq: 1.17.1

  '@ungap/structured-clone@1.2.0': {}

  acorn-jsx@5.3.2(acorn@8.11.3):
    dependencies:
      acorn: 8.11.3

  acorn@8.11.3: {}

  ajv@6.12.6:
    dependencies:
      fast-deep-equal: 3.1.3
      fast-json-stable-stringify: 2.1.0
      json-schema-traverse: 0.4.1
      uri-js: 4.4.1

  ansi-regex@5.0.1: {}

  ansi-styles@4.3.0:
    dependencies:
      color-convert: 2.0.1

  argparse@2.0.1: {}

  balanced-match@1.0.2: {}

  brace-expansion@1.1.11:
    dependencies:
      balanced-match: 1.0.2
      concat-map: 0.0.1

  callsites@3.1.0: {}

  chalk@4.1.2:
    dependencies:
      ansi-styles: 4.3.0
      supports-color: 7.2.0

  color-convert@2.0.1:
    dependencies:
      color-name: 1.1.4

  color-name@1.1.4: {}

  concat-map@0.0.1: {}

  cross-spawn@7.0.3:
    dependencies:
      path-key: 3.1.1
      shebang-command: 2.0.0
      which: 2.0.2

  debug@4.3.5:
    dependencies:
      ms: 2.1.2

  deep-is@0.1.4: {}

  doctrine@3.0.0:
    dependencies:
      esutils: 2.0.3

  escape-string-regexp@4.0.0: {}

  eslint-scope@7.2.2:
    dependencies:
      esrecurse: 4.3.0
      estraverse: 5.3.0

  eslint-visitor-keys@3.4.3: {}

  eslint@8.57.0:
    dependencies:
      '@eslint-community/eslint-utils': 4.4.0(eslint@8.57.0)
      '@eslint-community/regexpp': 4.10.0
      '@eslint/eslintrc': 2.1.4
      '@eslint/js': 8.57.0
      '@humanwhocodes/config-array': 0.11.14
      '@humanwhocodes/module-importer': 1.0.1
      '@nodelib/fs.walk': 1.2.8
      '@ungap/structured-clone': 1.2.0
      ajv: 6.12.6
      chalk: 4.1.2
      cross-spawn: 7.0.3
      debug: 4.3.5
      doctrine: 3.0.0
      escape-string-regexp: 4.0.0
      eslint-scope: 7.2.2
      eslint-visitor-keys: 3.4.3
      espree: 9.6.1
      esquery: 1.5.0
      esutils: 2.0.3
      fast-deep-equal: 3.1.3
      file-entry-cache: 6.0.1
      find-up: 5.0.0
      glob-parent: 6.0.2
      globals: 13.24.0
      graphemer: 1.4.0
      ignore: 5.3.1
      imurmurhash: 0.1.4
      is-glob: 4.0.3
      is-path-inside: 3.0.3
      js-yaml: 4.1.0
      json-stable-stringify-without-jsonify: 1.0.1
      levn: 0.4.1
      lodash.merge: 4.6.2
      minimatch: 3.1.2
      natural-compare: 1.4.0
      optionator: 0.9.4
      strip-ansi: 6.0.1
      text-table: 0.2.0
    transitivePeerDependencies:
      - supports-color

  espree@9.6.1:
    dependencies:
      acorn: 8.11.3
      acorn-jsx: 5.3.2(acorn@8.11.3)
      eslint-visitor-keys: 3.4.3

  esquery@1.5.0:
    dependencies:
      estraverse: 5.3.0

  esrecurse@4.3.0:
    dependencies:
      estraverse: 5.3.0

  estraverse@5.3.0: {}

  esutils@2.0.3: {}

  fast-deep-equal@3.1.3: {}

  fast-json-stable-stringify@2.1.0: {}

  fast-levenshtein@2.0.6: {}

  fastq@1.17.1:
    dependencies:
      reusify: 1.0.4

  file-entry-cache@6.0.1:
    dependencies:
      flat-cache: 3.2.0

  find-up@5.0.0:
    dependencies:
      locate-path: 6.0.0
      path-exists: 4.0.0

  flat-cache@3.2.0:
    dependencies:
      flatted: 3.3.1
      keyv: 4.5.4
      rimraf: 3.0.2

  flatted@3.3.1: {}

  fs.realpath@1.0.0: {}

  glob-parent@6.0.2:
    dependencies:
      is-glob: 4.0.3

  glob@7.2.3:
    dependencies:
      fs.realpath: 1.0.0
      inflight: 1.0.6
      inherits: 2.0.4
      minimatch: 3.1.2
      once: 1.4.0
      path-is-absolute: 1.0.1

  globals@13.24.0:
    dependencies:
      type-fest: 0.20.2

  graphemer@1.4.0: {}

  has-flag@4.0.0: {}

  ignore@5.3.1: {}

  import-fresh@3.3.0:
    dependencies:
      parent-module: 1.0.1
      resolve-from: 4.0.0

  imurmurhash@0.1.4: {}

  inflight@1.0.6:
    dependencies:
      once: 1.4.0
      wrappy: 1.0.2

  inherits@2.0.4: {}

  is-extglob@2.1.1: {}

  is-glob@4.0.3:
    dependencies:
      is-extglob: 2.1.1

  is-path-inside@3.0.3: {}

  isexe@2.0.0: {}

  js-yaml@4.1.0:
    dependencies:
      argparse: 2.0.1

  json-buffer@3.0.1: {}

  json-schema-traverse@0.4.1: {}

  json-stable-stringify-without-jsonify@1.0.1: {}

  keyv@4.5.4:
    dependencies:
      json-buffer: 3.0.1

  levn@0.4.1:
    dependencies:
      prelude-ls: 1.2.1
      type-check: 0.4.0

  locate-path@6.0.0:
    dependencies:
      p-locate: 5.0.0

  lodash.merge@4.6.2: {}

  minimatch@3.1.2:
    dependencies:
      brace-expansion: 1.1.11

  ms@2.1.2: {}

  natural-compare@1.4.0: {}

  once@1.4.0:
    dependencies:
      wrappy: 1.0.2

  optionator@0.9.4:
    dependencies:
      deep-is: 0.1.4
      fast-levenshtein: 2.0.6
      levn: 0.4.1
      prelude-ls: 1.2.1
      type-check: 0.4.0
      word-wrap: 1.2.5

  p-limit@3.1.0:
    dependencies:
      yocto-queue: 0.1.0

  p-locate@5.0.0:
    dependencies:
      p-limit: 3.1.0

  parent-module@1.0.1:
    dependencies:
      callsites: 3.1.0

  path-exists@4.0.0: {}

  path-is-absolute@1.0.1: {}

  path-key@3.1.1: {}

  prelude-ls@1.2.1: {}

  prettier@3.3.3: {}

  punycode@2.3.1: {}

  queue-microtask@1.2.3: {}

  resolve-from@4.0.0: {}

  reusify@1.0.4: {}

  rimraf@3.0.2:
    dependencies:
      glob: 7.2.3

  run-parallel@1.2.0:
    dependencies:
      queue-microtask: 1.2.3

  shebang-command@2.0.0:
    dependencies:
      shebang-regex: 3.0.0

  shebang-regex@3.0.0: {}

  strip-ansi@6.0.1:
    dependencies:
      ansi-regex: 5.0.1

  strip-json-comments@3.1.1: {}

  supports-color@7.2.0:
    dependencies:
      has-flag: 4.0.0

  text-table@0.2.0: {}

  turbo-darwin-64@1.13.4:
    optional: true

  turbo-darwin-arm64@1.13.4:
    optional: true

  turbo-linux-64@1.13.4:
    optional: true

  turbo-linux-arm64@1.13.4:
    optional: true

  turbo-windows-64@1.13.4:
    optional: true

  turbo-windows-arm64@1.13.4:
    optional: true

  turbo@1.13.4:
    optionalDependencies:
      turbo-darwin-64: 1.13.4
      turbo-darwin-arm64: 1.13.4
      turbo-linux-64: 1.13.4
      turbo-linux-arm64: 1.13.4
      turbo-windows-64: 1.13.4
      turbo-windows-arm64: 1.13.4

  type-check@0.4.0:
    dependencies:
      prelude-ls: 1.2.1

  type-fest@0.20.2: {}

  uri-js@4.4.1:
    dependencies:
      punycode: 2.3.1

  which@2.0.2:
    dependencies:
      isexe: 2.0.0

  word-wrap@1.2.5: {}

  wrappy@1.0.2: {}

  yocto-queue@0.1.0: {}



================================================
FILE: pnpm-workspace.yaml
================================================
packages:
  - "apps/*"
  - "packages/*"



================================================
FILE: turbo.json
================================================
{
  "$schema": "https://turbo.build/schema.json",
  "globalDependencies": ["**/.env.*local"],
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": [".next/**", "!.next/cache/**"]
    },
    "lint": {},
    "start": {
      "dependsOn": ["^build"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    }
  }
}



================================================
FILE: .dockerignore
================================================
# Dependencies
node_modules
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# Production builds
.next
out
dist
build

# Environment files
.env
.env.local
.env.development.local
.env.test.local
.env.production.local

# IDE files
.vscode
.idea
*.swp
*.swo

# OS files
.DS_Store
Thumbs.db

# Git
.git
.gitignore

# Docker
Dockerfile
.dockerignore
docker-compose.yml

# Logs
logs
*.log

# Runtime data
pids
*.pid
*.seed
*.pid.lock

# Coverage directory used by tools like istanbul
coverage
*.lcov

# nyc test coverage
.nyc_output

# Dependency directories
jspm_packages/

# Optional npm cache directory
.npm

# Optional eslint cache
.eslintcache

# Microbundle cache
.rpt2_cache/
.rts2_cache_cjs/
.rts2_cache_es/
.rts2_cache_umd/

# Optional REPL history
.node_repl_history

# Output of 'npm pack'
*.tgz

# Yarn Integrity file
.yarn-integrity

# parcel-bundler cache (https://parceljs.org/)
.cache
.parcel-cache

# Next.js build output
.next

# Nuxt.js build / generate output
.nuxt
dist

# Storybook build outputs
.out
.storybook-out

# Temporary folders
tmp/
temp/

# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
env/
venv/
ENV/
env.bak/
venv.bak/
.pytest_cache/
.coverage
htmlcov/
.tox/
.cache
nosetests.xml
coverage.xml
*.cover
.hypothesis/

# Database
*.db
*.sqlite3

# Media files (can be large)
uploads/
media/

# Documentation
README.md
docs/
*.md 


================================================
FILE: .npmrc
================================================
shared-workspace-lockfile=false
package-manager-strict=false


================================================
FILE: apps/api/__init__.py
================================================
[Empty file]


================================================
FILE: apps/api/alembic.ini
================================================
# A generic, single database configuration.

[alembic]
# path to migration scripts
# Use forward slashes (/) also on windows to provide an os agnostic path
script_location = migrations

# template used to generate migration file names; The default value is %%(rev)s_%%(slug)s
# Uncomment the line below if you want the files to be prepended with date and time
# see https://alembic.sqlalchemy.org/en/latest/tutorial.html#editing-the-ini-file
# for all available tokens
# file_template = %%(year)d_%%(month).2d_%%(day).2d_%%(hour).2d%%(minute).2d-%%(rev)s_%%(slug)s

# sys.path path, will be prepended to sys.path if present.
# defaults to the current working directory.
prepend_sys_path = .

# timezone to use when rendering the date within the migration file
# as well as the filename.
# If specified, requires the python>=3.9 or backports.zoneinfo library.
# Any required deps can installed by adding `alembic[tz]` to the pip requirements
# string value is passed to ZoneInfo()
# leave blank for localtime
# timezone =

# max length of characters to apply to the "slug" field
# truncate_slug_length = 40

# set to 'true' to run the environment during
# the 'revision' command, regardless of autogenerate
# revision_environment = false

# set to 'true' to allow .pyc and .pyo files without
# a source .py file to be detected as revisions in the
# versions/ directory
# sourceless = false

# version location specification; This defaults
# to migrations/versions.  When using multiple version
# directories, initial revisions must be specified with --version-path.
# The path separator used here should be the separator specified by "version_path_separator" below.
# version_locations = %(here)s/bar:%(here)s/bat:migrations/versions

# version path separator; As mentioned above, this is the character used to split
# version_locations. The default within new alembic.ini files is "os", which uses os.pathsep.
# If this key is omitted entirely, it falls back to the legacy behavior of splitting on spaces and/or commas.
# Valid values for version_path_separator are:
#
# version_path_separator = :
# version_path_separator = ;
# version_path_separator = space
version_path_separator = os  # Use os.pathsep. Default configuration used for new projects.

# set to 'true' to search source files recursively
# in each "version_locations" directory
# new in Alembic version 1.10
# recursive_version_locations = false

# the output encoding used when revision files
# are written from script.py.mako
# output_encoding = utf-8

sqlalchemy.url = postgresql://learnhouse:learnhouse@localhost:5432/learnhouse


[post_write_hooks]
# post_write_hooks defines scripts or Python functions that are run
# on newly generated revision scripts.  See the documentation for further
# detail and examples

# format using "black" - use the console_scripts runner, against the "black" entrypoint
# hooks = black
# black.type = console_scripts
# black.entrypoint = black
# black.options = -l 79 REVISION_SCRIPT_FILENAME

# lint with attempts to fix using "ruff" - use the exec runner, execute a binary
# hooks = ruff
# ruff.type = exec
# ruff.executable = %(here)s/.venv/bin/ruff
# ruff.options = --fix REVISION_SCRIPT_FILENAME

# Logging configuration
[loggers]
keys = root,sqlalchemy,alembic

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = WARN
handlers = console
qualname =

[logger_sqlalchemy]
level = WARN
handlers =
qualname = sqlalchemy.engine

[logger_alembic]
level = INFO
handlers =
qualname = alembic

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(levelname)-5.5s [%(name)s] %(message)s
datefmt = %H:%M:%S



================================================
FILE: apps/api/app.py
================================================
import uvicorn
import logfire
from fastapi import FastAPI, Request
from config.config import LearnHouseConfig, get_learnhouse_config
from src.core.events.events import shutdown_app, startup_app
from src.router import v1_router
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
from fastapi.staticfiles import StaticFiles
from fastapi_jwt_auth.exceptions import AuthJWTException
from fastapi.middleware.gzip import GZipMiddleware


########################
# Pre-Alpha Version 0.1.0
# Author: @swve
# (c) LearnHouse 2022
########################

# Get LearnHouse Config
learnhouse_config: LearnHouseConfig = get_learnhouse_config()

# Global Config
app = FastAPI(
    title=learnhouse_config.site_name,
    description=learnhouse_config.site_description,
    docs_url="/docs" if learnhouse_config.general_config.development_mode else None,
    redoc_url="/redoc" if learnhouse_config.general_config.development_mode else None,
    version="0.1.0",
)

app.add_middleware(
    CORSMiddleware,
    allow_origin_regex=learnhouse_config.hosting_config.allowed_regexp,
    allow_methods=["*"],
    allow_credentials=True,
    allow_headers=["*"],
)

# Only enable logfire if explicitly configured
if learnhouse_config.general_config.logfire_enabled:
    logfire.configure(console=False, service_name=learnhouse_config.site_name,)
    logfire.instrument_fastapi(app)
    # Instrument database after logfire is configured
    from src.core.events.database import engine
    logfire.instrument_sqlalchemy(engine=engine)

# Gzip Middleware (will add brotli later)
app.add_middleware(GZipMiddleware, minimum_size=1000)


# Events
app.add_event_handler("startup", startup_app(app))
app.add_event_handler("shutdown", shutdown_app(app))


# JWT Exception Handler
@app.exception_handler(AuthJWTException)
def authjwt_exception_handler(request: Request, exc: AuthJWTException):
    return JSONResponse(
        status_code=exc.status_code,  # type: ignore
        content={"detail": exc.message},  # type: ignore
    )


# Static Files
app.mount("/content", StaticFiles(directory="content"), name="content")

# Global Routes
app.include_router(v1_router)


if __name__ == "__main__":
    uvicorn.run(
        "app:app",
        host="0.0.0.0",
        port=learnhouse_config.hosting_config.port,
        reload=learnhouse_config.general_config.development_mode,
    )


# General Routes
@app.get("/")
async def root():
    return {"Message": "Welcome to LearnHouse âœ¨"}



================================================
FILE: apps/api/cli.py
================================================
import os
from typing import Annotated
from pydantic import EmailStr
from sqlalchemy import create_engine
from sqlmodel import SQLModel, Session
import typer
from config.config import get_learnhouse_config
from src.db.organizations import OrganizationCreate
from src.db.users import UserCreate
from src.services.setup.setup import (
    install_create_organization,
    install_create_organization_user,
    install_default_elements,
)

cli = typer.Typer()

@cli.command()
def install(
    short: Annotated[bool, typer.Option(help="Install with predefined values")] = False
):
    # Get the database session
    learnhouse_config = get_learnhouse_config()
    engine = create_engine(
        learnhouse_config.database_config.sql_connection_string, echo=False, pool_pre_ping=True  # type: ignore
    )
    SQLModel.metadata.create_all(engine)

    db_session = Session(engine)

    if short:
        # Install the default elements
        print("Installing default elements...")
        install_default_elements(db_session)
        print("Default elements installed âœ…")

        # Create the Organization
        print("Creating default organization...")
        org = OrganizationCreate(
            name="Default Organization",
            description="Default Organization",
            slug="default",
            email="",
            logo_image="",
            thumbnail_image="",
            about="",
            label="",
        )
        install_create_organization(org, db_session)
        print("Default organization created âœ…")

        # Create Organization User
        print("Creating default organization user...")
        # Use email from environment variable if provided, otherwise default to "admin@school.dev"
        email = os.environ.get("LEARNHOUSE_INITIAL_ADMIN_EMAIL", "admin@school.dev")
        # Require password from environment variable
        password = os.environ.get("LEARNHOUSE_INITIAL_ADMIN_PASSWORD")
        if not password:
            print("âŒ Error: LEARNHOUSE_INITIAL_ADMIN_PASSWORD environment variable is required")
            print("Please set LEARNHOUSE_INITIAL_ADMIN_PASSWORD environment variable before running installation.")
            raise typer.Exit(code=1)
        print("Using password from LEARNHOUSE_INITIAL_ADMIN_PASSWORD environment variable")
        if email != "admin@school.dev":
            print(f"Using email from LEARNHOUSE_INITIAL_ADMIN_EMAIL environment variable: {email}")
        user = UserCreate(
            username="admin", email=EmailStr(email), password=password
        )
        install_create_organization_user(user, "default", db_session)
        print("Default organization user created âœ…")

        # Show the user how to login
        print("Installation completed âœ…")
        print("")
        print("Login with the following credentials:")
        print("email: " + email)
        print("password: (the password you set in LEARNHOUSE_INITIAL_ADMIN_PASSWORD)")
        print("âš ï¸ Remember to change the password after logging in âš ï¸")

    else:
        # Install the default elements
        print("Installing default elements...")
        install_default_elements(db_session)
        print("Default elements installed âœ…")

        # Create the Organization
        print("Creating your organization...")
        orgname = typer.prompt("What's shall we call your organization?")
        slug = typer.prompt(
            "What's the slug for your organization? (e.g. school, acme)"
        )
        org = OrganizationCreate(
            name=orgname,
            description="Default Organization",
            slug=slug.lower(),
            email="",
            logo_image="",
            thumbnail_image="",
            about="",
            label="",
        )
        install_create_organization(org, db_session)
        print(orgname + " Organization created âœ…")

        # Create Organization User
        print("Creating your organization user...")
        username = typer.prompt("What's the username for the user?")
        email = typer.prompt("What's the email for the user?")
        password = typer.prompt("What's the password for the user?", hide_input=True)
        user = UserCreate(username=username, email=EmailStr(email), password=password)
        install_create_organization_user(user, slug, db_session)
        print(username + " user created âœ…")

        # Show the user how to login
        print("Installation completed âœ…")
        print("")
        print("Login with the following credentials:")
        print("email: " + email)
        print("password: The password you entered")




@cli.command()
def main():
    cli()


if __name__ == "__main__":
    cli()



================================================
FILE: apps/api/docker-entrypoint.sh
================================================
#!/bin/bash
set -e

# Backend entrypoint script
# This script waits for dependencies and starts the FastAPI application

# Function to wait for a service to be ready
wait_for_service() {
    local host=$1
    local port=$2
    local service_name=$3
    local max_attempts=30
    local attempt=1

    echo "Waiting for ${service_name} to be ready at ${host}:${port}..."
    
    while [ $attempt -le $max_attempts ]; do
        if nc -z "$host" "$port" 2>/dev/null || timeout 1 bash -c "cat < /dev/null > /dev/tcp/$host/$port" 2>/dev/null; then
            echo "${service_name} is ready!"
            return 0
        fi
        echo "Attempt ${attempt}/${max_attempts}: ${service_name} not ready, waiting 2 seconds..."
        sleep 2
        attempt=$((attempt + 1))
    done

    echo "Error: ${service_name} did not become ready in time"
    exit 1
}

# Extract host and port from connection strings if provided
if [ -n "$LEARNHOUSE_SQL_CONNECTION_STRING" ]; then
    # Extract host and port from postgresql://user:pass@host:port/db
    DB_HOST=$(echo "$LEARNHOUSE_SQL_CONNECTION_STRING" | sed -n 's/.*@\([^:]*\):\([0-9]*\)\/.*/\1/p')
    DB_PORT=$(echo "$LEARNHOUSE_SQL_CONNECTION_STRING" | sed -n 's/.*@\([^:]*\):\([0-9]*\)\/.*/\2/p')
    
    if [ -z "$DB_PORT" ]; then
        DB_PORT=5432
    fi
    
    if [ -n "$DB_HOST" ]; then
        wait_for_service "$DB_HOST" "$DB_PORT" "PostgreSQL"
    fi
fi

if [ -n "$LEARNHOUSE_REDIS_CONNECTION_STRING" ]; then
    # Extract host and port from redis://host:port/db or redis://host:port
    REDIS_HOST=$(echo "$LEARNHOUSE_REDIS_CONNECTION_STRING" | sed -n 's|redis://\([^:/]*\):\([0-9]*\).*|\1|p')
    REDIS_PORT=$(echo "$LEARNHOUSE_REDIS_CONNECTION_STRING" | sed -n 's|redis://\([^:/]*\):\([0-9]*\).*|\2|p')
    
    if [ -z "$REDIS_PORT" ]; then
        REDIS_PORT=6379
    fi
    
    if [ -z "$REDIS_HOST" ]; then
        # Try default format redis://host:port
        REDIS_HOST=$(echo "$LEARNHOUSE_REDIS_CONNECTION_STRING" | sed -n 's|redis://\([^:/]*\).*|\1|p')
    fi
    
    if [ -n "$REDIS_HOST" ]; then
        wait_for_service "$REDIS_HOST" "$REDIS_PORT" "Redis"
    fi
fi

# Set Python environment variables
export PYTHONUNBUFFERED=1
export PYTHONIOENCODING=utf-8

# Get port from config or use default
PORT=${LEARNHOUSE_PORT:-9000}
HOST=${HOSTNAME:-0.0.0.0}

echo "Starting LearnHouse backend on ${HOST}:${PORT}..."

# Start the FastAPI application
exec uv run uvicorn app:app --host "$HOST" --port "$PORT"




================================================
FILE: apps/api/Dockerfile
================================================
FROM python:3.12-slim-bookworm

# Install curl and netcat for health checks and service waiting
RUN apt-get update && apt-get install -y curl netcat-openbsd && rm -rf /var/lib/apt/lists/*

COPY --from=ghcr.io/astral-sh/uv:0.9.7 /uv /uvx /bin/

# Copy the project into the image
ADD . /app

# Sync the project into a new environment, using the frozen lockfile
WORKDIR /app
RUN uv sync --frozen

# Copy entrypoint script
COPY docker-entrypoint.sh ./
RUN chmod +x docker-entrypoint.sh

# Expose port
EXPOSE 9000

# Health check endpoint
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:9000/api/v1/health || exit 1

# Use entrypoint script
ENTRYPOINT ["./docker-entrypoint.sh"]


================================================
FILE: apps/api/pyproject.toml
================================================
[project]
description = "Learnhouse Backend"
name = "learnhouse-api"
version = "0.1.0"
requires-python = ">=3.12.3,<3.13.0"
authors = [
    {name = "Badr B. (swve)"}
]
dependencies = [
    "boto3>=1.34.79",
    "botocore>=1.34.93",
    "faker>=30.1.0",
    "fastapi>=0.115.0",
    "fastapi-jwt-auth>=0.5.0",
    "httpx>=0.27.0",
    "openai>=1.50.2",
    "passlib>=1.7.4",
    "psycopg2-binary>=2.9.9",
    "pydantic[email]>=1.8.0,<2.0.0",
    "pytest>=8.2.2",
    "pytest-cov>=4.1.0",
    "python-dotenv>=1.0.0",
    "python-multipart>=0.0.9",
    "pyyaml>=6.0.1",
    "redis>=5.0.7",
    "requests>=2.32.3",
    "resend>=2.4.0",
    "sqlmodel>=0.0.19",
    "tiktoken>=0.7.0",
    "uvicorn==0.30.1",
    "typer>=0.12.5",
    "alembic>=1.13.2",
    "alembic-postgresql-enum>=1.2.0",
    "sqlalchemy-utils>=0.41.2",
    "stripe>=11.1.1",
    "python-jose>=3.3.0",
    "logfire[sqlalchemy]>=3.8.0",
    "beautifulsoup4>=4.13.4",
    "pytest-asyncio>=1.1.0",
]

[tool.ruff]
lint.ignore = ["E501", "E712"]

[tool.pytest.ini_options]
asyncio_mode = "auto"
asyncio_default_fixture_loop_scope = "function"
markers = [
    "asyncio: mark test as async",
]
filterwarnings = [
    "ignore::DeprecationWarning",
    "ignore::UserWarning",
    "ignore:.*crypt.*deprecated.*",
    "ignore:.*utcnow.*deprecated.*",
    "ignore:.*obj.dict.*deprecated.*",
    "ignore:.*Instrumentation will have no effect.*",
    "ignore:.*handler names should be lower-case.*",
]



================================================
FILE: apps/api/config/__init__.py
================================================
[Empty file]


================================================
FILE: apps/api/config/config.py
================================================
import os
import yaml
from typing import Literal, Optional
from pydantic import BaseModel
from dotenv import load_dotenv


class CookieConfig(BaseModel):
    domain: str


class GeneralConfig(BaseModel):
    development_mode: bool
    logfire_enabled: bool


class SecurityConfig(BaseModel):
    auth_jwt_secret_key: str


class AIConfig(BaseModel):
    openai_api_key: str | None
    is_ai_enabled: bool | None


class S3ApiConfig(BaseModel):
    bucket_name: str | None
    endpoint_url: str | None


class ContentDeliveryConfig(BaseModel):
    type: Literal["filesystem", "s3api"]
    s3api: S3ApiConfig


class HostingConfig(BaseModel):
    domain: str
    ssl: bool
    port: int
    use_default_org: bool
    allowed_origins: list
    allowed_regexp: str
    self_hosted: bool
    cookie_config: CookieConfig
    content_delivery: ContentDeliveryConfig


class MailingConfig(BaseModel):
    resend_api_key: str
    system_email_address: str


class DatabaseConfig(BaseModel):
    sql_connection_string: Optional[str]


class RedisConfig(BaseModel):
    redis_connection_string: Optional[str]


class InternalStripeConfig(BaseModel):
    stripe_secret_key: str | None
    stripe_publishable_key: str | None
    stripe_webhook_standard_secret: str | None
    stripe_webhook_connect_secret: str | None
    stripe_client_id: str | None


class InternalPaymentsConfig(BaseModel):
    stripe: InternalStripeConfig


class LearnHouseConfig(BaseModel):
    site_name: str
    site_description: str
    contact_email: str
    general_config: GeneralConfig
    hosting_config: HostingConfig
    database_config: DatabaseConfig
    redis_config: RedisConfig
    security_config: SecurityConfig
    ai_config: AIConfig
    mailing_config: MailingConfig
    payments_config: InternalPaymentsConfig


def get_learnhouse_config() -> LearnHouseConfig:

    load_dotenv()

    # Get the YAML file
    yaml_path = os.path.join(os.path.dirname(__file__), "config.yaml")

    # Load the YAML file
    with open(yaml_path, "r") as f:
        yaml_config = yaml.safe_load(f)
    
    # Ensure yaml_config is not None (defensive programming)
    if yaml_config is None:
        yaml_config = {}

    # General Config

    # Development Mode
    env_development_mode_str = os.environ.get("LEARNHOUSE_DEVELOPMENT_MODE", "None")
    if env_development_mode_str != "None":
        env_development_mode = env_development_mode_str.lower() in ("true", "1", "yes")
    else:
        env_development_mode = None
    development_mode = (
        env_development_mode
        if env_development_mode is not None
        else yaml_config.get("general", {}).get("development_mode")
    )

    # Logfire config
    env_logfire_enabled = os.environ.get("LEARNHOUSE_LOGFIRE_ENABLED", "None")
    logfire_enabled = (
        env_logfire_enabled.lower() == "true" if env_logfire_enabled != "None"
        else yaml_config.get("general", {}).get("logfire_enabled", False)
    )

    # Security Config
    env_auth_jwt_secret_key = os.environ.get("LEARNHOUSE_AUTH_JWT_SECRET_KEY")
    auth_jwt_secret_key = env_auth_jwt_secret_key or yaml_config.get(
        "security", {}
    ).get("auth_jwt_secret_key")

    # Check if environment variables are defined
    env_site_name = os.environ.get("LEARNHOUSE_SITE_NAME")
    env_site_description = os.environ.get("LEARNHOUSE_SITE_DESCRIPTION")
    env_contact_email = os.environ.get("LEARNHOUSE_CONTACT_EMAIL")
    env_domain = os.environ.get("LEARNHOUSE_DOMAIN")
    os.environ.get("LEARNHOUSE_PORT")
    env_ssl = os.environ.get("LEARNHOUSE_SSL")
    env_port = os.environ.get("LEARNHOUSE_PORT")
    env_use_default_org = os.environ.get("LEARNHOUSE_USE_DEFAULT_ORG")
    env_allowed_origins = os.environ.get("LEARNHOUSE_ALLOWED_ORIGINS")
    env_cookie_domain = os.environ.get("LEARNHOUSE_COOKIE_DOMAIN")

    # Allowed origins should be a comma separated string
    if env_allowed_origins:
        env_allowed_origins = env_allowed_origins.split(",")
    env_allowed_regexp = os.environ.get("LEARNHOUSE_ALLOWED_REGEXP")
    env_self_hosted = os.environ.get("LEARNHOUSE_SELF_HOSTED")
    env_sql_connection_string = os.environ.get("LEARNHOUSE_SQL_CONNECTION_STRING")

    

    # Fill in values with YAML file if they are not provided
    site_name = env_site_name or yaml_config.get("site_name")
    site_description = env_site_description or yaml_config.get("site_description")
    contact_email = env_contact_email or yaml_config.get("contact_email")

    domain = env_domain or yaml_config.get("hosting_config", {}).get("domain")
    ssl = env_ssl or yaml_config.get("hosting_config", {}).get("ssl")
    port = env_port or yaml_config.get("hosting_config", {}).get("port")
    use_default_org = env_use_default_org or yaml_config.get("hosting_config", {}).get(
        "use_default_org"
    )
    allowed_origins = env_allowed_origins or yaml_config.get("hosting_config", {}).get(
        "allowed_origins"
    )
    allowed_regexp = env_allowed_regexp or yaml_config.get("hosting_config", {}).get(
        "allowed_regexp"
    )
    self_hosted = env_self_hosted or yaml_config.get("hosting_config", {}).get(
        "self_hosted"
    )

    cookies_domain = env_cookie_domain or yaml_config.get("hosting_config", {}).get(
        "cookies_config", {}
    ).get("domain")
    cookie_config = CookieConfig(domain=cookies_domain)

    env_content_delivery_type = os.environ.get("LEARNHOUSE_CONTENT_DELIVERY_TYPE")
    content_delivery_type: str = env_content_delivery_type or (
        (yaml_config.get("hosting_config", {}).get("content_delivery", {}).get("type"))
        or "filesystem"
    )  # default to filesystem

    env_bucket_name = os.environ.get("LEARNHOUSE_S3_API_BUCKET_NAME")
    env_endpoint_url = os.environ.get("LEARNHOUSE_S3_API_ENDPOINT_URL")
    bucket_name = (
        yaml_config.get("hosting_config", {})
        .get("content_delivery", {})
        .get("s3api", {})
        .get("bucket_name")
    ) or env_bucket_name
    endpoint_url = (
        yaml_config.get("hosting_config", {})
        .get("content_delivery", {})
        .get("s3api", {})
        .get("endpoint_url")
    ) or env_endpoint_url

    content_delivery = ContentDeliveryConfig(
        type=content_delivery_type,  # type: ignore
        s3api=S3ApiConfig(bucket_name=bucket_name, endpoint_url=endpoint_url),  # type: ignore
    )

    # Database config
    sql_connection_string = env_sql_connection_string or yaml_config.get(
        "database_config", {}
    ).get("sql_connection_string")

    # AI Config
    env_openai_api_key = os.environ.get("LEARNHOUSE_OPENAI_API_KEY")
    env_is_ai_enabled_str = os.environ.get("LEARNHOUSE_IS_AI_ENABLED")
    
    openai_api_key = env_openai_api_key or yaml_config.get("ai_config", {}).get(
        "openai_api_key"
    )
    
    # Parse is_ai_enabled from env or yaml
    if env_is_ai_enabled_str:
        is_ai_enabled = env_is_ai_enabled_str.lower() in ("true", "1", "yes")
    else:
        is_ai_enabled = yaml_config.get("ai_config", {}).get("is_ai_enabled", False)

    # Redis config
    env_redis_connection_string = os.environ.get("LEARNHOUSE_REDIS_CONNECTION_STRING")
    redis_connection_string = env_redis_connection_string or yaml_config.get(
        "redis_config", {}
    ).get("redis_connection_string")

    # Mailing config
    env_resend_api_key = os.environ.get("LEARNHOUSE_RESEND_API_KEY")
    env_system_email_address = os.environ.get("LEARNHOUSE_SYSTEM_EMAIL_ADDRESS")
    resend_api_key = env_resend_api_key or yaml_config.get("mailing_config", {}).get(
        "resend_api_key"
    )
    system_email_address = env_system_email_address or yaml_config.get(
        "mailing_config", {}
    ).get("system_email_address")

    # Payments config
    env_stripe_secret_key = os.environ.get("LEARNHOUSE_STRIPE_SECRET_KEY")
    env_stripe_publishable_key = os.environ.get("LEARNHOUSE_STRIPE_PUBLISHABLE_KEY")
    env_stripe_webhook_standard_secret = os.environ.get("LEARNHOUSE_STRIPE_WEBHOOK_STANDARD_SECRET")
    env_stripe_webhook_connect_secret = os.environ.get("LEARNHOUSE_STRIPE_WEBHOOK_CONNECT_SECRET")
    env_stripe_client_id = os.environ.get("LEARNHOUSE_STRIPE_CLIENT_ID")
    
    stripe_secret_key = env_stripe_secret_key or yaml_config.get("payments_config", {}).get(
        "stripe", {}
    ).get("stripe_secret_key")
    
    stripe_publishable_key = env_stripe_publishable_key or yaml_config.get("payments_config", {}).get(
        "stripe", {}
    ).get("stripe_publishable_key")

    stripe_webhook_standard_secret = env_stripe_webhook_standard_secret or yaml_config.get("payments_config", {}).get(
        "stripe", {}
    ).get("stripe_webhook_standard_secret")

    stripe_webhook_connect_secret = env_stripe_webhook_connect_secret or yaml_config.get("payments_config", {}).get(
        "stripe", {}
    ).get("stripe_webhook_connect_secret")

    stripe_client_id = env_stripe_client_id or yaml_config.get("payments_config", {}).get(
        "stripe", {}
    ).get("stripe_client_id")

    # Create HostingConfig and DatabaseConfig objects
    hosting_config = HostingConfig(
        domain=domain,
        ssl=bool(ssl),
        port=int(port),
        use_default_org=bool(use_default_org),
        allowed_origins=list(allowed_origins),
        allowed_regexp=allowed_regexp,
        self_hosted=bool(self_hosted),
        cookie_config=cookie_config,
        content_delivery=content_delivery,
    )
    database_config = DatabaseConfig(
        sql_connection_string=sql_connection_string,
    )

    # AI Config
    ai_config = AIConfig(
        openai_api_key=openai_api_key,
        is_ai_enabled=bool(is_ai_enabled),
    )

    # Create LearnHouseConfig object
    config = LearnHouseConfig(
        site_name=site_name,
        site_description=site_description,
        contact_email=contact_email,
        general_config=GeneralConfig(
            development_mode=bool(development_mode), 
            logfire_enabled=bool(logfire_enabled)
        ),
        hosting_config=hosting_config,
        database_config=database_config,
        security_config=SecurityConfig(auth_jwt_secret_key=auth_jwt_secret_key),
        ai_config=ai_config,
        redis_config=RedisConfig(redis_connection_string=redis_connection_string),
        mailing_config=MailingConfig(
            resend_api_key=resend_api_key, system_email_address=system_email_address
        ),
        payments_config=InternalPaymentsConfig(
            stripe=InternalStripeConfig(
                stripe_secret_key=stripe_secret_key,
                stripe_publishable_key=stripe_publishable_key,
                stripe_webhook_standard_secret=stripe_webhook_standard_secret,
                stripe_webhook_connect_secret=stripe_webhook_connect_secret,
                stripe_client_id=stripe_client_id
            )
        )
    )

    return config



================================================
FILE: apps/api/config/config.yaml
================================================
site_name: LearnHouse
site_description: LearnHouse is an open-source platform tailored for learning experiences.
contact_email: hi@learnhouse.app

# This config is optimized for local development. You can change the values according to your needs.

general:
  development_mode: true
  logfire_enabled: false

security:
  auth_jwt_secret_key: secret

hosting_config:
  domain: learnhouse.app
  ssl: true
  port: 1338
  allowed_origins:
    - http://localhost:3000
    - http://localhost:3001
  cookies_config:
    domain: ".localhost"
  allowed_regexp: '\b((?:https?://)[^\s/$.?#].[^\s]*)\b'
  content_delivery:
    type: "filesystem" # "filesystem" or "s3api"
    s3api:
      bucket_name: ""
      endpoint_url: ""

mailing_config:
  resend_api_key: ""
  system_email_address: ""

database_config:
  sql_connection_string: postgresql://learnhouse:learnhouse@localhost:5432/learnhouse

redis_config:
  redis_connection_string: redis://localhost:6379/learnhouse

payments_config:
  stripe:
    stripe_secret_key: ""
    stripe_publishable_key: ""
    stripe_webhook_standard_secret: ""
    stripe_client_id: ""

ai_config:
  openai_api_key: ""
  is_ai_enabled: false



================================================
FILE: apps/api/content/__init__.py
================================================
[Empty file]


================================================
FILE: apps/api/migrations/env.py
================================================
import importlib
from logging.config import fileConfig
import os
import alembic_postgresql_enum # noqa: F401
from sqlalchemy import engine_from_config
from sqlalchemy import pool
from sqlmodel import SQLModel
from alembic import context

from config.config import get_learnhouse_config

# LearnHouse config

lh_config = get_learnhouse_config()

# this is the Alembic Config object, which provides
# access to the values within the .ini file in use.
config = context.config

# Interpret the config file for Python logging.
# This line sets up loggers basically.
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# add your model's MetaData object here
# for 'autogenerate' support
# from myapp import mymodel
# target_metadata = mymodel.Base.metadata

# IMPORTING ALL SCHEMAS
base_dir = 'src/db'
base_module_path = 'src.db'

# Recursively walk through the base directory
for root, dirs, files in os.walk(base_dir):
    # Filter out __init__.py and non-Python files
    module_files = [f for f in files if f.endswith('.py') and f != '__init__.py']
    # Calculate the module's base path from its directory structure
    path_diff = os.path.relpath(root, base_dir)
    if path_diff == '.':
        # Root of the base_dir, no additional path to add
        current_module_base = base_module_path
    else:
        # Convert directory path to a module path
        current_module_base = f"{base_module_path}.{path_diff.replace(os.sep, '.')}"
    
    # Dynamically import each module
    for file_name in module_files:
        module_name = file_name[:-3]  # Remove the '.py' extension
        full_module_path = f"{current_module_base}.{module_name}"
        importlib.import_module(full_module_path)

# IMPORTING ALL SCHEMAS

target_metadata = SQLModel.metadata

# other values from the config, defined by the needs of env.py,
# can be acquired:
# my_important_option = config.get_main_option("my_important_option")
# ... etc.


def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode.

    This configures the context with just a URL
    and not an Engine, though an Engine is acceptable
    here as well.  By skipping the Engine creation
    we don't even need a DBAPI to be available.

    Calls to context.execute() here emit the given string to the
    script output.

    """
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
    )

    with context.begin_transaction():
        context.run_migrations()


def run_migrations_online() -> None:
    """Run migrations in 'online' mode.

    In this scenario we need to create an Engine
    and associate a connection with the context.

    """
    connectable = engine_from_config(
        config.get_section(config.config_ini_section, {}),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(connection=connection, target_metadata=target_metadata)

        with context.begin_transaction():
            context.run_migrations()


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()



================================================
FILE: apps/api/migrations/script.py.mako
================================================
"""${message}

Revision ID: ${up_revision}
Revises: ${down_revision | comma,n}
Create Date: ${create_date}

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa # noqa: F401
import sqlmodel # noqa: F401
${imports if imports else ""}

# revision identifiers, used by Alembic.
revision: str = ${repr(up_revision)}
down_revision: Union[str, None] = ${repr(down_revision)}
branch_labels: Union[str, Sequence[str], None] = ${repr(branch_labels)}
depends_on: Union[str, Sequence[str], None] = ${repr(depends_on)}


def upgrade() -> None:
    ${upgrades if upgrades else "pass"}


def downgrade() -> None:
    ${downgrades if downgrades else "pass"}



================================================
FILE: apps/api/migrations/orgconfigs/orgconfigs_migrations.py
================================================
def migrate_v0_to_v1(v0_config):
    v1_config = {
        "config_version": "1.0",
        "general": {
            "enabled": v0_config["GeneralConfig"]["active"],
            "color": v0_config["GeneralConfig"]["color"],
            "watermark": True,  # Default value as it's not present in v0
        },
        "features": {
            "courses": {
                "enabled": True,
                "limit": (
                    v0_config["GeneralConfig"]["limits"]["max_users"]
                    if v0_config["GeneralConfig"]["limits"]["limits_enabled"]
                    else 5
                ),
            },
            "members": {
                "enabled": True,
                "signup_mode": (
                    "open"
                    if v0_config["GeneralConfig"]["users"]["signup_mechanism"] == "open"
                    else "inviteOnly"
                ),
                "admin_limit": 5,
                "limit": (
                    v0_config["GeneralConfig"]["limits"]["max_users"]
                    if v0_config["GeneralConfig"]["limits"]["limits_enabled"]
                    else 10
                ),
            },
            "usergroups": {
                "enabled": False,
                "limit": (
                    v0_config["GeneralConfig"]["limits"]["max_staff"]
                    if v0_config["GeneralConfig"]["limits"]["limits_enabled"]
                    else 10
                ),
            },
            "storage": {
                "enabled": True,
                "limit": (
                    v0_config["GeneralConfig"]["limits"]["max_storage"]
                    if v0_config["GeneralConfig"]["limits"]["limits_enabled"]
                    else 10
                ),
            },
            "ai": {
                "enabled": False,
                "limit": (
                    v0_config["AIConfig"]["limits"]["max_asks"]
                    if v0_config["AIConfig"]["limits"]["limits_enabled"]
                    else 10
                ),
                "model": 'gpt-4o-mini',
            },
            "assignments": {"enabled": True, "limit": 5},
            "payments": {"enabled": False, "stripe_key": ""},
            "discussions": {"enabled": False, "limit": 10},
            "analytics": {"enabled": False, "limit": 10},
            "collaboration": {
                "enabled": False,
                "limit": 10,
            },
            "api": {"enabled": False, "limit": 10},
        },
    }

    return v1_config


def migrate_to_v1_1(v1_config):
    # Start by copying the existing configuration
    v1_1_config = v1_config.copy()
    
    # Update the config version
    v1_1_config["config_version"] = "1.1"
    
    # Add the new 'cloud' object at the end
    v1_1_config['cloud'] = {
        "plan": "free",
        "custom_domain": False
    }
    
    return v1_1_config

def migrate_to_v1_2(v1_1_config):
    v1_2_config = v1_1_config.copy()

    v1_2_config['config_version'] = '1.2'

    # Enable payments for everyone
    v1_2_config['features']['payments']['enabled'] = True
    
    # Only delete stripe_key if it exists
    if 'stripe_key' in v1_2_config['features']['payments']:
        del v1_2_config['features']['payments']['stripe_key']

    return v1_2_config


================================================
FILE: apps/api/migrations/versions/0314ec7791e1_payments.py
================================================
"""Payments

Revision ID: 0314ec7791e1
Revises: 040ccb1d456e
Create Date: 2024-11-23 19:41:14.064680

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa # noqa: F401
import sqlmodel # noqa: F401
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = '0314ec7791e1'
down_revision: Union[str, None] = '040ccb1d456e'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('paymentsconfig',
    sa.Column('enabled', sa.Boolean(), nullable=False),
    sa.Column('active', sa.Boolean(), nullable=False),
    sa.Column('provider', postgresql.ENUM('STRIPE', name='paymentproviderenum', create_type=False), nullable=False),
    sa.Column('provider_specific_id', sqlmodel.sql.sqltypes.AutoString(), nullable=True),
    sa.Column('provider_config', sa.JSON(), nullable=True),
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('org_id', sa.BigInteger(), nullable=True),
    sa.Column('creation_date', sa.DateTime(), nullable=False),
    sa.Column('update_date', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['org_id'], ['organization.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('paymentsproduct',
    sa.Column('name', sqlmodel.sql.sqltypes.AutoString(), nullable=False),
    sa.Column('description', sqlmodel.sql.sqltypes.AutoString(), nullable=True),
    sa.Column('product_type', postgresql.ENUM('SUBSCRIPTION', 'ONE_TIME', name='paymentproducttypeenum', create_type=False), nullable=False),
    sa.Column('price_type', postgresql.ENUM('CUSTOMER_CHOICE', 'FIXED_PRICE', name='paymentpricetypeenum', create_type=False), nullable=False),
    sa.Column('benefits', sqlmodel.sql.sqltypes.AutoString(), nullable=False),
    sa.Column('amount', sa.Float(), nullable=False),
    sa.Column('currency', sqlmodel.sql.sqltypes.AutoString(), nullable=False),
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('org_id', sa.BigInteger(), nullable=True),
    sa.Column('payments_config_id', sa.BigInteger(), nullable=True),
    sa.Column('provider_product_id', sa.String(), nullable=True),
    sa.Column('creation_date', sa.DateTime(), nullable=False),
    sa.Column('update_date', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['org_id'], ['organization.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['payments_config_id'], ['paymentsconfig.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('paymentscourse',
    sa.Column('course_id', sa.BigInteger(), nullable=True),
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('payment_product_id', sa.BigInteger(), nullable=True),
    sa.Column('org_id', sa.BigInteger(), nullable=True),
    sa.Column('creation_date', sa.DateTime(), nullable=False),
    sa.Column('update_date', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['course_id'], ['course.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['org_id'], ['organization.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['payment_product_id'], ['paymentsproduct.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('paymentsuser',
    sa.Column('status', postgresql.ENUM('PENDING', 'COMPLETED', 'ACTIVE', 'CANCELLED', 'FAILED', 'REFUNDED', name='paymentstatusenum', create_type=False), nullable=False),
    sa.Column('provider_specific_data', sa.JSON(), nullable=True),
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=True),
    sa.Column('org_id', sa.BigInteger(), nullable=True),
    sa.Column('payment_product_id', sa.BigInteger(), nullable=True),
    sa.Column('creation_date', sa.DateTime(), nullable=False),
    sa.Column('update_date', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['org_id'], ['organization.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['payment_product_id'], ['paymentsproduct.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('paymentsuser')
    op.drop_table('paymentscourse')
    op.drop_table('paymentsproduct')
    op.drop_table('paymentsconfig')
    # ### end Alembic commands ###



================================================
FILE: apps/api/migrations/versions/040ccb1d456e_add_thumbnail_image_to_orgs.py
================================================
"""Add thumbnail image to orgs

Revision ID: 040ccb1d456e
Revises: 83b6d9d6f57a
Create Date: 2024-09-27 10:23:50.508031

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa # noqa: F401
import sqlmodel # noqa: F401

# revision identifiers, used by Alembic.
revision: str = '040ccb1d456e'
down_revision: Union[str, None] = '83b6d9d6f57a'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('organization', sa.Column('thumbnail_image', sa.String(), nullable=True))
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('organization', 'thumbnail_image')
    # ### end Alembic commands ###



================================================
FILE: apps/api/migrations/versions/4a88b680263c_multi_contributors.py
================================================
"""Multi-contributors

Revision ID: 4a88b680263c
Revises: 87a621284ae4
Create Date: 2025-03-20 11:05:24.951129

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa # noqa: F401
import sqlmodel # noqa: F401
from alembic_postgresql_enum import TableReference
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = '4a88b680263c'
down_revision: Union[str, None] = '87a621284ae4'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('course', sa.Column('open_to_contributors', sa.Boolean(), nullable=False, default=False, server_default='false'))
    op.add_column('resourceauthor', sa.Column('authorship_status', postgresql.ENUM('ACTIVE', 'PENDING', 'INACTIVE', name='resourceauthorshipstatusenum', create_type=False), nullable=False, default='INACTIVE', server_default='INACTIVE'))
    op.sync_enum_values(
        enum_schema='public',
        enum_name='resourceauthorshipenum',
        new_values=['CREATOR', 'CONTRIBUTOR', 'MAINTAINER', 'REPORTER'],
        affected_columns=[TableReference(table_schema='public', table_name='resourceauthor', column_name='authorship')],
        enum_values_to_rename=[],
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.sync_enum_values(
        enum_schema='public',
        enum_name='resourceauthorshipenum',
        new_values=['CREATOR', 'MAINTAINER', 'REPORTER'],
        affected_columns=[TableReference(table_schema='public', table_name='resourceauthor', column_name='authorship')],
        enum_values_to_rename=[],
    )
    op.drop_column('resourceauthor', 'authorship_status')
    op.drop_column('course', 'open_to_contributors')
    # ### end Alembic commands ###



================================================
FILE: apps/api/migrations/versions/6295e05ff7d0_enum_updates.py
================================================
"""Enum updates

Revision ID: 6295e05ff7d0
Revises: df2981bf24dd
Create Date: 2024-07-11 20:46:26.582170

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa # noqa: F401
import sqlmodel # noqa: F401
from alembic_postgresql_enum import TableReference # type: ignore

# revision identifiers, used by Alembic.
revision: str = '6295e05ff7d0'
down_revision: Union[str, None] = 'df2981bf24dd'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.sync_enum_values('public', 'activitytypeenum', ['TYPE_VIDEO', 'TYPE_DOCUMENT', 'TYPE_DYNAMIC', 'TYPE_ASSIGNMENT', 'TYPE_CUSTOM'],
                        [TableReference(table_schema='public', table_name='activity', column_name='activity_type')],
                        enum_values_to_rename=[])
    op.sync_enum_values('public', 'activitysubtypeenum', ['SUBTYPE_DYNAMIC_PAGE', 'SUBTYPE_VIDEO_YOUTUBE', 'SUBTYPE_VIDEO_HOSTED', 'SUBTYPE_DOCUMENT_PDF', 'SUBTYPE_DOCUMENT_DOC', 'SUBTYPE_ASSIGNMENT_ANY', 'SUBTYPE_CUSTOM'],
                        [TableReference(table_schema='public', table_name='activity', column_name='activity_sub_type')],
                        enum_values_to_rename=[])
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.sync_enum_values('public', 'activitysubtypeenum', ['SUBTYPE_DYNAMIC_PAGE', 'SUBTYPE_VIDEO_YOUTUBE', 'SUBTYPE_VIDEO_HOSTED', 'SUBTYPE_DOCUMENT_PDF', 'SUBTYPE_DOCUMENT_DOC', 'SUBTYPE_ASSESSMENT_QUIZ', 'SUBTYPE_CUSTOM'],
                        [TableReference(table_schema='public', table_name='activity', column_name='activity_sub_type')],
                        enum_values_to_rename=[])
    op.sync_enum_values('public', 'activitytypeenum', ['TYPE_VIDEO', 'TYPE_DOCUMENT', 'TYPE_DYNAMIC', 'TYPE_ASSESSMENT', 'TYPE_CUSTOM'],
                        [TableReference(table_schema='public', table_name='activity', column_name='activity_type')],
                        enum_values_to_rename=[])
    # ### end Alembic commands ###



================================================
FILE: apps/api/migrations/versions/83b6d9d6f57a_org_ids_cascades.py
================================================
"""Org IDs Cascades

Revision ID: 83b6d9d6f57a
Revises: cb2029aadc2d
Create Date: 2024-08-29 19:38:10.022100

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa # noqa: F401
import sqlmodel # noqa: F401


# revision identifiers, used by Alembic.
revision: str = '83b6d9d6f57a'
down_revision: Union[str, None] = 'cb2029aadc2d'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint('chapter_org_id_fkey', 'chapter', type_='foreignkey')
    op.drop_constraint('chapteractivity_org_id_fkey', 'chapteractivity', type_='foreignkey')
    op.create_foreign_key(None, 'chapteractivity', 'organization', ['org_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint('collectioncourse_org_id_fkey', 'collectioncourse', type_='foreignkey')
    op.create_foreign_key(None, 'collectioncourse', 'organization', ['org_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint('coursechapter_org_id_fkey', 'coursechapter', type_='foreignkey')
    op.create_foreign_key(None, 'coursechapter', 'organization', ['org_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint('courseupdate_org_id_fkey', 'courseupdate', type_='foreignkey')
    op.create_foreign_key(None, 'courseupdate', 'organization', ['org_id'], ['id'], ondelete='CASCADE')
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(None, 'courseupdate', type_='foreignkey')
    op.create_foreign_key('courseupdate_org_id_fkey', 'courseupdate', 'organization', ['org_id'], ['id'])
    op.drop_constraint(None, 'coursechapter', type_='foreignkey')
    op.create_foreign_key('coursechapter_org_id_fkey', 'coursechapter', 'organization', ['org_id'], ['id'])
    op.drop_constraint(None, 'collectioncourse', type_='foreignkey')
    op.create_foreign_key('collectioncourse_org_id_fkey', 'collectioncourse', 'organization', ['org_id'], ['id'])
    op.drop_constraint(None, 'chapteractivity', type_='foreignkey')
    op.create_foreign_key('chapteractivity_org_id_fkey', 'chapteractivity', 'organization', ['org_id'], ['id'])
    op.create_foreign_key('chapter_org_id_fkey', 'chapter', 'organization', ['org_id'], ['id'])
    # ### end Alembic commands ###



================================================
FILE: apps/api/migrations/versions/87a621284ae4_organizations_new_model.py
================================================
"""Organizations new model

Revision ID: 87a621284ae4
Revises: 0314ec7791e1
Create Date: 2024-12-17 22:51:50.998443

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa # noqa: F401
import sqlmodel # noqa: F401


# revision identifiers, used by Alembic.
revision: str = '87a621284ae4'
down_revision: Union[str, None] = '0314ec7791e1'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('organization', sa.Column('about', sqlmodel.sql.sqltypes.AutoString(), nullable=True))
    op.add_column('organization', sa.Column('socials', sa.JSON(), nullable=True))
    op.add_column('organization', sa.Column('links', sa.JSON(), nullable=True))
    op.add_column('organization', sa.Column('previews', sa.JSON(), nullable=True))
    op.add_column('organization', sa.Column('explore', sa.Boolean(), nullable=True))
    op.add_column('organization', sa.Column('label', sqlmodel.sql.sqltypes.AutoString(), nullable=True))
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('organization', 'label')
    op.drop_column('organization', 'explore')
    op.drop_column('organization', 'previews')
    op.drop_column('organization', 'links')
    op.drop_column('organization', 'socials')
    op.drop_column('organization', 'about')
    # ### end Alembic commands ###



================================================
FILE: apps/api/migrations/versions/9e031a0358d1_video_thumbnails.py
================================================
"""Video Thumbnails

Revision ID: 9e031a0358d1
Revises: eb10d15465b3
Create Date: 2025-06-20 21:28:50.735540

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa # noqa: F401
import sqlmodel # noqa: F401
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = '9e031a0358d1'
down_revision: Union[str, None] = 'eb10d15465b3'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    # Create the ENUM type first
    thumbnail_type_enum = postgresql.ENUM('IMAGE', 'VIDEO', 'BOTH', name='thumbnail_type')
    thumbnail_type_enum.create(op.get_bind())
    
    op.add_column('course', sa.Column('thumbnail_type', thumbnail_type_enum, nullable=True))
    op.add_column('course', sa.Column('thumbnail_video', sa.String(), nullable=True))
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('course', 'thumbnail_video')
    op.drop_column('course', 'thumbnail_type')
    
    # Drop the ENUM type
    thumbnail_type_enum = postgresql.ENUM('IMAGE', 'VIDEO', 'BOTH', name='thumbnail_type')
    thumbnail_type_enum.drop(op.get_bind())
    # ### end Alembic commands ###



================================================
FILE: apps/api/migrations/versions/a5afa69dd917_activity_details.py
================================================
"""Activity Details

Revision ID: a5afa69dd917
Revises: adb944cc8bec
Create Date: 2025-04-22 16:04:58.028488

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa # noqa: F401
import sqlmodel # noqa: F401


# revision identifiers, used by Alembic.
revision: str = 'a5afa69dd917'
down_revision: Union[str, None] = 'adb944cc8bec'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('activity', sa.Column('details', sa.JSON(), nullable=True))
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('activity', 'details')
    # ### end Alembic commands ###



================================================
FILE: apps/api/migrations/versions/adb944cc8bec_add_users_details_and_profile.py
================================================
"""Add Users details and Profile

Revision ID: adb944cc8bec
Revises: 4a88b680263c
Create Date: 2025-03-29 16:31:38.797525

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa # noqa: F401
import sqlmodel # noqa: F401


# revision identifiers, used by Alembic.
revision: str = 'adb944cc8bec'
down_revision: Union[str, None] = '4a88b680263c'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('user', sa.Column('details', sa.JSON(), nullable=True))
    op.add_column('user', sa.Column('profile', sa.JSON(), nullable=True))
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('user', 'profile')
    op.drop_column('user', 'details')
    # ### end Alembic commands ###



================================================
FILE: apps/api/migrations/versions/cb2029aadc2d_cloud_changes.py
================================================
"""Cloud Changes

Revision ID: cb2029aadc2d
Revises: d8bc71595932
Create Date: 2024-08-29 19:24:34.859544

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa # noqa: F401
import sqlmodel # noqa: F401


# revision identifiers, used by Alembic.
revision: str = 'cb2029aadc2d'
down_revision: Union[str, None] = 'd8bc71595932'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column('activity', 'course_id',
               existing_type=sa.BIGINT(),
               type_=sa.Integer(),
               existing_nullable=True)
    op.drop_constraint('activity_org_id_fkey', 'activity', type_='foreignkey')
    op.create_foreign_key(None, 'activity', 'organization', ['org_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint('block_org_id_fkey', 'block', type_='foreignkey')
    op.create_foreign_key(None, 'block', 'organization', ['org_id'], ['id'], ondelete='CASCADE')
    op.alter_column('collection', 'org_id',
               existing_type=sa.INTEGER(),
               type_=sa.BigInteger(),
               existing_nullable=True)
    op.drop_constraint('collection_org_id_fkey', 'collection', type_='foreignkey')
    op.create_foreign_key(None, 'collection', 'organization', ['org_id'], ['id'], ondelete='CASCADE')
    op.alter_column('collectioncourse', 'collection_id',
               existing_type=sa.BIGINT(),
               type_=sa.Integer(),
               existing_nullable=True)
    op.alter_column('collectioncourse', 'course_id',
               existing_type=sa.BIGINT(),
               type_=sa.Integer(),
               existing_nullable=True)
    op.drop_constraint('course_org_id_fkey', 'course', type_='foreignkey')
    op.create_foreign_key(None, 'course', 'organization', ['org_id'], ['id'], ondelete='CASCADE')
    op.alter_column('coursechapter', 'course_id',
               existing_type=sa.BIGINT(),
               type_=sa.Integer(),
               existing_nullable=True)
    op.alter_column('coursechapter', 'chapter_id',
               existing_type=sa.BIGINT(),
               type_=sa.Integer(),
               existing_nullable=True)
    op.drop_constraint('resourceauthor_user_id_fkey', 'resourceauthor', type_='foreignkey')
    op.create_foreign_key(None, 'resourceauthor', 'user', ['user_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint('role_org_id_fkey', 'role', type_='foreignkey')
    op.create_foreign_key(None, 'role', 'organization', ['org_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint('trailrun_user_id_fkey', 'trailrun', type_='foreignkey')
    op.drop_constraint('trailrun_course_id_fkey', 'trailrun', type_='foreignkey')
    op.drop_constraint('trailrun_trail_id_fkey', 'trailrun', type_='foreignkey')
    op.drop_constraint('trailrun_org_id_fkey', 'trailrun', type_='foreignkey')
    op.create_foreign_key(None, 'trailrun', 'user', ['user_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key(None, 'trailrun', 'course', ['course_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key(None, 'trailrun', 'organization', ['org_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key(None, 'trailrun', 'trail', ['trail_id'], ['id'], ondelete='CASCADE')
    op.alter_column('trailstep', 'trailrun_id',
               existing_type=sa.BIGINT(),
               type_=sa.Integer(),
               existing_nullable=True)
    op.drop_constraint('trailstep_activity_id_fkey', 'trailstep', type_='foreignkey')
    op.drop_constraint('trailstep_org_id_fkey', 'trailstep', type_='foreignkey')
    op.drop_constraint('trailstep_course_id_fkey', 'trailstep', type_='foreignkey')
    op.drop_constraint('trailstep_user_id_fkey', 'trailstep', type_='foreignkey')
    op.drop_constraint('trailstep_trail_id_fkey', 'trailstep', type_='foreignkey')
    op.create_foreign_key(None, 'trailstep', 'organization', ['org_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key(None, 'trailstep', 'user', ['user_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key(None, 'trailstep', 'trail', ['trail_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key(None, 'trailstep', 'course', ['course_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key(None, 'trailstep', 'activity', ['activity_id'], ['id'], ondelete='CASCADE')
    op.alter_column('userorganization', 'org_id',
               existing_type=sa.BIGINT(),
               type_=sa.Integer(),
               existing_nullable=True)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column('userorganization', 'org_id',
               existing_type=sa.Integer(),
               type_=sa.BIGINT(),
               existing_nullable=True)
    op.drop_constraint(None, 'trailstep', type_='foreignkey')
    op.drop_constraint(None, 'trailstep', type_='foreignkey')
    op.drop_constraint(None, 'trailstep', type_='foreignkey')
    op.drop_constraint(None, 'trailstep', type_='foreignkey')
    op.drop_constraint(None, 'trailstep', type_='foreignkey')
    op.create_foreign_key('trailstep_trail_id_fkey', 'trailstep', 'trail', ['trail_id'], ['id'])
    op.create_foreign_key('trailstep_user_id_fkey', 'trailstep', 'user', ['user_id'], ['id'])
    op.create_foreign_key('trailstep_course_id_fkey', 'trailstep', 'course', ['course_id'], ['id'])
    op.create_foreign_key('trailstep_org_id_fkey', 'trailstep', 'organization', ['org_id'], ['id'])
    op.create_foreign_key('trailstep_activity_id_fkey', 'trailstep', 'activity', ['activity_id'], ['id'])
    op.alter_column('trailstep', 'trailrun_id',
               existing_type=sa.Integer(),
               type_=sa.BIGINT(),
               existing_nullable=True)
    op.drop_constraint(None, 'trailrun', type_='foreignkey')
    op.drop_constraint(None, 'trailrun', type_='foreignkey')
    op.drop_constraint(None, 'trailrun', type_='foreignkey')
    op.drop_constraint(None, 'trailrun', type_='foreignkey')
    op.create_foreign_key('trailrun_org_id_fkey', 'trailrun', 'organization', ['org_id'], ['id'])
    op.create_foreign_key('trailrun_trail_id_fkey', 'trailrun', 'trail', ['trail_id'], ['id'])
    op.create_foreign_key('trailrun_course_id_fkey', 'trailrun', 'course', ['course_id'], ['id'])
    op.create_foreign_key('trailrun_user_id_fkey', 'trailrun', 'user', ['user_id'], ['id'])
    op.drop_constraint(None, 'role', type_='foreignkey')
    op.create_foreign_key('role_org_id_fkey', 'role', 'organization', ['org_id'], ['id'])
    op.drop_constraint(None, 'resourceauthor', type_='foreignkey')
    op.create_foreign_key('resourceauthor_user_id_fkey', 'resourceauthor', 'user', ['user_id'], ['id'])
    op.alter_column('coursechapter', 'chapter_id',
               existing_type=sa.Integer(),
               type_=sa.BIGINT(),
               existing_nullable=True)
    op.alter_column('coursechapter', 'course_id',
               existing_type=sa.Integer(),
               type_=sa.BIGINT(),
               existing_nullable=True)
    op.drop_constraint(None, 'course', type_='foreignkey')
    op.create_foreign_key('course_org_id_fkey', 'course', 'organization', ['org_id'], ['id'])
    op.alter_column('collectioncourse', 'course_id',
               existing_type=sa.Integer(),
               type_=sa.BIGINT(),
               existing_nullable=True)
    op.alter_column('collectioncourse', 'collection_id',
               existing_type=sa.Integer(),
               type_=sa.BIGINT(),
               existing_nullable=True)
    op.drop_constraint(None, 'collection', type_='foreignkey')
    op.create_foreign_key('collection_org_id_fkey', 'collection', 'organization', ['org_id'], ['id'])
    op.alter_column('collection', 'org_id',
               existing_type=sa.BigInteger(),
               type_=sa.INTEGER(),
               existing_nullable=True)
    op.drop_constraint(None, 'block', type_='foreignkey')
    op.create_foreign_key('block_org_id_fkey', 'block', 'organization', ['org_id'], ['id'])
    op.drop_constraint(None, 'activity', type_='foreignkey')
    op.create_foreign_key('activity_org_id_fkey', 'activity', 'organization', ['org_id'], ['id'])
    op.alter_column('activity', 'course_id',
               existing_type=sa.Integer(),
               type_=sa.BIGINT(),
               existing_nullable=True)
    # ### end Alembic commands ###



================================================
FILE: apps/api/migrations/versions/d8bc71595932_add_reference_for_assignmenttasks.py
================================================
"""Add reference for AssignmentTasks

Revision ID: d8bc71595932
Revises: 6295e05ff7d0
Create Date: 2024-07-12 18:59:50.242716

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
import sqlmodel # noqa: F401


# revision identifiers, used by Alembic.
revision: str = 'd8bc71595932'
down_revision: Union[str, None] = '6295e05ff7d0'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('assignmenttask', sa.Column('reference_file', sa.VARCHAR(), nullable=True))
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('assignmenttask', 'reference_file')
    # ### end Alembic commands ###



================================================
FILE: apps/api/migrations/versions/df2981bf24dd_initial_migration.py
================================================
"""Initial Migration

Revision ID: df2981bf24dd
Revises: 
Create Date: 2024-07-11 19:33:37.993767

"""
from typing import Sequence, Union

from alembic import op
from grpc import server # noqa: F401
import sqlalchemy as sa
import sqlmodel # noqa: F401


# revision identifiers, used by Alembic.
revision: str = 'df2981bf24dd'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('activity', sa.Column('published', sa.Boolean(), nullable=False, server_default=sa.true()))
    # If you need to rename columns instead of dropping them, use the rename_column command
    # For example, if we are changing the name 'published_version' to 'published', we would use:
    # op.alter_column('activity', 'published_version', new_column_name='published', existing_type=sa.Boolean())
    op.drop_column('activity', 'published_version')
    op.drop_column('activity', 'version')
    
    op.drop_column('assignmentusersubmission', 'assignment_user_uuid')

    op.drop_constraint('trail_org_id_fkey', 'trail', type_='foreignkey')
    op.create_foreign_key('trail_org_id_fkey', 'trail', 'organization', ['org_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint('trail_user_id_fkey', 'trail', type_='foreignkey')
    op.create_foreign_key('trail_user_id_fkey', 'trail', 'user', ['user_id'], ['id'], ondelete='CASCADE')
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint('trail_org_id_fkey', 'trail', type_='foreignkey')
    op.create_foreign_key('trail_org_id_fkey', 'trail', 'organization', ['org_id'], ['id'])
    op.drop_constraint('trail_user_id_fkey', 'trail', type_='foreignkey')
    op.create_foreign_key('trail_user_id_fkey', 'trail', 'user', ['user_id'], ['id'])

    op.add_column('assignmentusersubmission', sa.Column('assignment_user_uuid', sa.VARCHAR(), autoincrement=False, nullable=False))

    op.add_column('activity', sa.Column('version', sa.INTEGER(), autoincrement=False, nullable=False, server_default=sa.text('1')))
    op.add_column('activity', sa.Column('published_version', sa.INTEGER(), autoincrement=False, nullable=False, server_default=sa.text('1')))
    op.drop_column('activity', 'published')
    # ### end Alembic commands ###




================================================
FILE: apps/api/migrations/versions/eb10d15465b3_org_scripts.py
================================================
"""Org Scripts

Revision ID: eb10d15465b3
Revises: a5afa69dd917
Create Date: 2025-06-08 18:12:18.853988

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa # noqa: F401
import sqlmodel # noqa: F401


# revision identifiers, used by Alembic.
revision: str = 'eb10d15465b3'
down_revision: Union[str, None] = 'a5afa69dd917'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('organization', sa.Column('scripts', sa.JSON(), nullable=True))
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('organization', 'scripts')
    # ### end Alembic commands ###



================================================
FILE: apps/api/src/__init__.py
================================================
[Empty file]


================================================
FILE: apps/api/src/router.py
================================================
import os
from fastapi import APIRouter, Depends
from src.routers import health
from src.routers import usergroups
from src.routers import dev, trail, users, auth, orgs, roles, search
from src.routers.ai import ai
from src.routers.courses import chapters, collections, courses, assignments, certifications
from src.routers.courses.activities import activities, blocks
from src.routers.ee import cloud_internal, payments
from src.services.dev.dev import isDevModeEnabledOrRaise
from src.routers.utils import router as utils_router


v1_router = APIRouter(prefix="/api/v1")


# API Routes
v1_router.include_router(users.router, prefix="/users", tags=["users"])
v1_router.include_router(usergroups.router, prefix="/usergroups", tags=["usergroups"])
v1_router.include_router(auth.router, prefix="/auth", tags=["auth"])
v1_router.include_router(orgs.router, prefix="/orgs", tags=["orgs"])
v1_router.include_router(roles.router, prefix="/roles", tags=["roles"])
v1_router.include_router(blocks.router, prefix="/blocks", tags=["blocks"])
v1_router.include_router(courses.router, prefix="/courses", tags=["courses"])
v1_router.include_router(search.router, prefix="/search", tags=["search"])
v1_router.include_router(
    assignments.router, prefix="/assignments", tags=["assignments"]
)
v1_router.include_router(chapters.router, prefix="/chapters", tags=["chapters"])
v1_router.include_router(activities.router, prefix="/activities", tags=["activities"])
v1_router.include_router(
    collections.router, prefix="/collections", tags=["collections"]
)
v1_router.include_router(
    certifications.router, prefix="/certifications", tags=["certifications"]
)
v1_router.include_router(trail.router, prefix="/trail", tags=["trail"])
v1_router.include_router(ai.router, prefix="/ai", tags=["ai"])
v1_router.include_router(payments.router, prefix="/payments", tags=["payments"])

if os.environ.get("CLOUD_INTERNAL_KEY"):
    v1_router.include_router(
        cloud_internal.router,
        prefix="/cloud_internal",
        tags=["cloud_internal"],
        dependencies=[Depends(cloud_internal.check_internal_cloud_key)],
    )

v1_router.include_router(health.router, prefix="/health", tags=["health"])

# Dev Routes
v1_router.include_router(
    dev.router,
    prefix="/dev",
    tags=["dev"],
    dependencies=[Depends(isDevModeEnabledOrRaise)],
)

v1_router.include_router(utils_router, prefix="/utils", tags=["utils"])



================================================
FILE: apps/api/src/core/__init__.py
================================================
[Empty file]


================================================
FILE: apps/api/src/core/events/__init__.py
================================================
[Empty file]


================================================
FILE: apps/api/src/core/events/autoinstall.py
================================================
from sqlalchemy import create_engine
from sqlmodel import SQLModel, Session, select

from cli import install
from config.config import get_learnhouse_config
from src.db.organizations import Organization


def auto_install():
    # Get the database session
    learnhouse_config = get_learnhouse_config()
    engine = create_engine(
        learnhouse_config.database_config.sql_connection_string, echo=False, pool_pre_ping=True  # type: ignore
    )
    SQLModel.metadata.create_all(engine)

    db_session = Session(engine)

    orgs = db_session.exec(select(Organization)).all()

    if len(orgs) == 0:
        print("No organizations found. Starting auto-installation ğŸ—ï¸")
        install(short=True)

    if orgs: 
        for org in orgs:
            default_org = db_session.exec(select(Organization).where(Organization.slug == 'default')).first()

            if not default_org:
                print("No default organization found. Starting auto-installation ğŸ—ï¸")
                install(short=True)

    else: 
        print("Organizations found. Skipping auto-installation ğŸš€")

            
            



================================================
FILE: apps/api/src/core/events/content.py
================================================
import os


async def check_content_directory():
    if not os.path.exists("content"):
        # create folder for activity
        print("Creating content directory...")
        os.makedirs("content")



================================================
FILE: apps/api/src/core/events/database.py
================================================
import logging
import os
import importlib
from config.config import get_learnhouse_config
from fastapi import FastAPI
from sqlmodel import SQLModel, Session, create_engine
from sqlalchemy import event

def import_all_models():
    base_dir = 'src/db'
    base_module_path = 'src.db'
    
    # Recursively walk through the base directory
    for root, dirs, files in os.walk(base_dir):
        # Filter out __init__.py and non-Python files
        module_files = [f for f in files if f.endswith('.py') and f != '__init__.py']
        
        # Calculate the module's base path from its directory structure
        path_diff = os.path.relpath(root, base_dir)
        if path_diff == '.':
            current_module_base = base_module_path
        else:
            current_module_base = f"{base_module_path}.{path_diff.replace(os.sep, '.')}"
        
        # Dynamically import each module
        for file_name in module_files:
            module_name = file_name[:-3]  # Remove the '.py' extension
            full_module_path = f"{current_module_base}.{module_name}"
            importlib.import_module(full_module_path)

# Import all models before creating engine
import_all_models()

learnhouse_config = get_learnhouse_config()

# Check if we're in test mode
is_testing = os.getenv("TESTING", "false").lower() == "true"

if is_testing:
    # Use SQLite for tests
    engine = create_engine(
        "sqlite:///:memory:",
        echo=False,
        connect_args={"check_same_thread": False}
    )
else:
    # Use configured database for production/development
    engine = create_engine(
        learnhouse_config.database_config.sql_connection_string,  # type: ignore
        echo=False, 
        pool_pre_ping=True,  # type: ignore
        pool_size=20,  # Increased from 5 to handle more concurrent requests
        max_overflow=10,  # Allow 10 additional connections beyond pool_size
        pool_recycle=300,  # Recycle connections after 5 minutes
        pool_timeout=30
    )
    
    # Add connection pool monitoring for debugging
    @event.listens_for(engine, "connect")
    def receive_connect(dbapi_connection, connection_record):
        logging.debug("Database connection established")
    
    @event.listens_for(engine, "checkout")
    def receive_checkout(dbapi_connection, connection_record, connection_proxy):
        logging.debug("Connection checked out from pool")
    
    @event.listens_for(engine, "checkin")
    def receive_checkin(dbapi_connection, connection_record):
        logging.debug("Connection returned to pool")

# Only create tables if not in test mode (tests will handle this themselves)
if not is_testing:
    SQLModel.metadata.create_all(engine)
    # Note: logfire instrumentation will be handled in app.py after configuration

async def connect_to_db(app: FastAPI):
    app.db_engine = engine  # type: ignore
    logging.info("LearnHouse database has been started.")
    # Only create tables if not in test mode
    if not is_testing:
        SQLModel.metadata.create_all(engine)

def get_db_session():
    with Session(engine) as session:
        yield session

async def close_database(app: FastAPI):
    logging.info("LearnHouse has been shut down.")
    return app



================================================
FILE: apps/api/src/core/events/events.py
================================================
from typing import Callable
from fastapi import FastAPI
from config.config import LearnHouseConfig, get_learnhouse_config
from src.core.events.autoinstall import auto_install
from src.core.events.content import check_content_directory
from src.core.events.database import close_database, connect_to_db
from src.core.events.logs import create_logs_dir


def startup_app(app: FastAPI) -> Callable:
    async def start_app() -> None:
        # Get LearnHouse Config
        learnhouse_config: LearnHouseConfig = get_learnhouse_config()
        app.learnhouse_config = learnhouse_config  # type: ignore

        # Connect to database
        await connect_to_db(app)

        # Create logs directory
        await create_logs_dir()

        # Create content directory
        await check_content_directory()

        # Check if auto-installation is needed
        auto_install()

    return start_app


def shutdown_app(app: FastAPI) -> Callable:
    async def close_app() -> None:
        await close_database(app)

    return close_app



================================================
FILE: apps/api/src/core/events/logs.py
================================================
import logging
import os


async def create_logs_dir():
    if not os.path.exists("logs"):
        os.mkdir("logs")

# Initiate logging
async def init_logging():
    await create_logs_dir()

    # Logging
    logging.basicConfig(
        level=logging.INFO,
        format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
        datefmt="%d-%b-%y %H:%M:%S",
        handlers=[
            logging.FileHandler("logs/learnhouse.log"),
            logging.StreamHandler()
        ]
    )

    logging.info("Logging initiated")



================================================
FILE: apps/api/src/db/__init__.py
================================================
[Empty file]


================================================
FILE: apps/api/src/db/collections.py
================================================
from typing import Optional
from sqlalchemy import BigInteger, Column, ForeignKey
from sqlmodel import Field, SQLModel


class CollectionBase(SQLModel):
    name: str
    public: bool
    description: Optional[str] = ""
    

class Collection(CollectionBase, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    org_id: int = Field(
        sa_column=Column(BigInteger, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    collection_uuid: str = ""
    creation_date: str = ""
    update_date: str = ""


class CollectionCreate(CollectionBase):
    courses: list[int]
    org_id: int = Field(default=None, foreign_key="organization.id")

    pass


class CollectionUpdate(CollectionBase):
    courses: Optional[list]
    name: Optional[str]
    public: Optional[bool]
    description: Optional[str] = ""


class CollectionRead(CollectionBase):
    id: int
    courses: list
    collection_uuid: str
    creation_date: str
    update_date: str
    pass



================================================
FILE: apps/api/src/db/collections_courses.py
================================================
from typing import Optional
from sqlalchemy import Column, ForeignKey, Integer
from sqlmodel import Field, SQLModel


class CollectionCourse(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    collection_id: int = Field(
        sa_column=Column(Integer, ForeignKey("collection.id", ondelete="CASCADE"))
    )
    course_id: int = Field(
        sa_column=Column(Integer, ForeignKey("course.id", ondelete="CASCADE"))
    )
    org_id: int = Field(
        sa_column=Column(Integer, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    creation_date: str
    update_date: str



================================================
FILE: apps/api/src/db/organization_config.py
================================================
from typing import Literal, Optional
from pydantic import BaseModel
from sqlalchemy import JSON, BigInteger, Column, ForeignKey
from sqlmodel import Field, SQLModel


# Features
class CourseOrgConfig(BaseModel):
    enabled: bool = True
    limit: int = 10


class MemberOrgConfig(BaseModel):
    enabled: bool = True
    signup_mode: Literal["open", "inviteOnly"] = "open"
    admin_limit: int = 1
    limit: int = 10


class UserGroupOrgConfig(BaseModel):
    enabled: bool = True
    limit: int = 10


class StorageOrgConfig(BaseModel):
    enabled: bool = True
    limit: int = 10


class AIOrgConfig(BaseModel):
    enabled: bool = True
    limit: int = 10
    model: str = "gpt-4o-mini"


class AssignmentOrgConfig(BaseModel):
    enabled: bool = False
    limit: int = 10


class PaymentOrgConfig(BaseModel):
    enabled: bool = True


class DiscussionOrgConfig(BaseModel):
    enabled: bool = True
    limit: int = 10


class AnalyticsOrgConfig(BaseModel):
    enabled: bool = True
    limit: int = 10


class CollaborationOrgConfig(BaseModel):
    enabled: bool = True
    limit: int = 10


class APIOrgConfig(BaseModel):
    enabled: bool = True
    limit: int = 10


class OrgFeatureConfig(BaseModel):
    courses: CourseOrgConfig = CourseOrgConfig()
    members: MemberOrgConfig = MemberOrgConfig()
    usergroups: UserGroupOrgConfig = UserGroupOrgConfig()
    storage: StorageOrgConfig = StorageOrgConfig()
    ai: AIOrgConfig = AIOrgConfig()
    assignments: AssignmentOrgConfig = AssignmentOrgConfig()
    payments: PaymentOrgConfig = PaymentOrgConfig()
    discussions: DiscussionOrgConfig = DiscussionOrgConfig()
    analytics: AnalyticsOrgConfig = AnalyticsOrgConfig()
    collaboration: CollaborationOrgConfig = CollaborationOrgConfig()
    api: APIOrgConfig = APIOrgConfig()


# General
class OrgGeneralConfig(BaseModel):
    enabled: bool = True
    color: str = "normal"
    watermark: bool = True


# Cloud
class OrgCloudConfig(BaseModel):
    plan: Literal["free", "standard", "pro"] = "free"
    custom_domain: bool = False


# Main Config
class OrganizationConfigBase(BaseModel):
    config_version: str = "1.3"
    general: OrgGeneralConfig
    features: OrgFeatureConfig
    cloud: OrgCloudConfig
    landing: dict = {}


class OrganizationConfig(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    org_id: int = Field(
        sa_column=Column(BigInteger, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    config: dict = Field(default={}, sa_column=Column(JSON))
    creation_date: Optional[str]
    update_date: Optional[str]



================================================
FILE: apps/api/src/db/organizations.py
================================================
from typing import Optional
from pydantic import BaseModel
from sqlalchemy import JSON, Column
from sqlmodel import Field, SQLModel
from src.db.roles import RoleRead

from src.db.organization_config import OrganizationConfig


class OrganizationBase(SQLModel):
    name: str
    description: Optional[str]
    about: Optional[str]
    socials: Optional[dict] = Field(default={}, sa_column=Column(JSON))
    links: Optional[dict] = Field(default={}, sa_column=Column(JSON))
    scripts: Optional[dict] = Field(default={}, sa_column=Column(JSON))
    logo_image: Optional[str]
    thumbnail_image: Optional[str]
    previews: Optional[dict] = Field(default={}, sa_column=Column(JSON))
    explore: Optional[bool] = Field(default=False)
    label: Optional[str]
    slug: str
    email: str


class Organization(OrganizationBase, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    org_uuid: str = ""
    creation_date: str = ""
    update_date: str = ""

class OrganizationWithConfig(BaseModel):
    org: Organization
    config: OrganizationConfig


class OrganizationUpdate(SQLModel):
    name: Optional[str] = None
    description: Optional[str] = None
    about: Optional[str] = None
    socials: Optional[dict] = None
    links: Optional[dict] = None
    scripts: Optional[dict] = None
    logo_image: Optional[str] = None
    thumbnail_image: Optional[str] = None
    previews: Optional[dict] = None
    label: Optional[str] = None
    slug: Optional[str] = None
    email: Optional[str] = None
    explore: Optional[bool] = None

class OrganizationCreate(OrganizationBase):
    pass


class OrganizationRead(OrganizationBase):
    id: int
    org_uuid: str
    config: Optional[OrganizationConfig | dict]
    creation_date: str
    update_date: str


class OrganizationUser(BaseModel):
    from src.db.users import UserRead
    user: UserRead
    role: RoleRead



================================================
FILE: apps/api/src/db/resource_authors.py
================================================
from enum import Enum
from typing import Optional
from sqlalchemy import Column, ForeignKey, Integer
from sqlmodel import Field, SQLModel


class ResourceAuthorshipEnum(str, Enum):
    CREATOR = "CREATOR"
    CONTRIBUTOR = "CONTRIBUTOR"
    MAINTAINER = "MAINTAINER"
    REPORTER = "REPORTER"

class ResourceAuthorshipStatusEnum(str, Enum):
    ACTIVE = "ACTIVE"
    PENDING = "PENDING"
    INACTIVE = "INACTIVE"


class ResourceAuthor(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    resource_uuid: str
    user_id: int = Field(
        sa_column=Column(Integer, ForeignKey("user.id", ondelete="CASCADE"))
    )
    authorship: ResourceAuthorshipEnum
    authorship_status: ResourceAuthorshipStatusEnum
    creation_date: str = ""
    update_date: str = ""



================================================
FILE: apps/api/src/db/roles.py
================================================
from enum import Enum
from typing import Optional, Union
from pydantic import BaseModel
from sqlalchemy import JSON, Column, ForeignKey, Integer
from sqlmodel import Field, SQLModel


# Rights
class Permission(BaseModel):
    action_create: bool
    action_read: bool
    action_update: bool
    action_delete: bool

    def __getitem__(self, item):
        return getattr(self, item)


class PermissionsWithOwn(BaseModel):
    action_create: bool
    action_read: bool
    action_read_own: bool
    action_update: bool
    action_update_own: bool
    action_delete: bool
    action_delete_own: bool

    def __getitem__(self, item):
        return getattr(self, item)


class DashboardPermission(BaseModel):
    action_access: bool

    def __getitem__(self, item):
        return getattr(self, item)


class Rights(BaseModel):
    courses: PermissionsWithOwn
    users: Permission
    usergroups : Permission
    collections: Permission
    organizations: Permission
    coursechapters: Permission
    activities: Permission
    roles: Permission
    dashboard: DashboardPermission

    def __getitem__(self, item):
        return getattr(self, item)


# Database Models


class RoleTypeEnum(str, Enum):
    TYPE_ORGANIZATION = "TYPE_ORGANIZATION"  # Organization roles are associated with an organization, they are used to define the rights of a user in an organization
    TYPE_ORGANIZATION_API_TOKEN = "TYPE_ORGANIZATION_API_TOKEN"  # Organization API Token roles are associated with an organization, they are used to define the rights of an API Token in an organization
    TYPE_GLOBAL = "TYPE_GLOBAL"  # Global roles are not associated with an organization, they are used to define the default rights of a user


class RoleBase(SQLModel):
    name: str
    description: Optional[str]
    rights: Optional[Union[Rights, dict]] = Field(default={}, sa_column=Column(JSON))


class Role(RoleBase, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    org_id: Optional[int] = Field(
        default=None,
        sa_column=Column(Integer, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    role_type: RoleTypeEnum = RoleTypeEnum.TYPE_GLOBAL
    role_uuid: str = ""
    creation_date: str = ""
    update_date: str = ""


class RoleRead(RoleBase):
    id: Optional[int] = Field(default=None, primary_key=True)
    org_id: int = Field(default=None, foreign_key="organization.id")
    role_type: RoleTypeEnum = RoleTypeEnum.TYPE_GLOBAL
    role_uuid: str
    creation_date: str
    update_date: str


class RoleCreate(RoleBase):
    org_id: Optional[int] = Field(default=None, foreign_key="organization.id")


class RoleUpdate(SQLModel):
    role_id: int = Field(default=None, foreign_key="role.id")
    name: Optional[str]
    description: Optional[str]
    rights: Optional[Union[Rights, dict]] = Field(default={}, sa_column=Column(JSON))



================================================
FILE: apps/api/src/db/trail_runs.py
================================================
from typing import Optional
from pydantic import BaseModel
from sqlalchemy import JSON, Column, ForeignKey, Integer
from sqlmodel import Field, SQLModel
from enum import Enum

from src.db.trail_steps import TrailStep


class TrailRunEnum(str, Enum):
    RUN_TYPE_COURSE = "RUN_TYPE_COURSE"


class StatusEnum(str, Enum):
    STATUS_IN_PROGRESS = "STATUS_IN_PROGRESS"
    STATUS_COMPLETED = "STATUS_COMPLETED"
    STATUS_PAUSED = "STATUS_PAUSED"
    STATUS_CANCELLED = "STATUS_CANCELLED"


class TrailRun(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    data: dict = Field(default={}, sa_column=Column(JSON))
    status: StatusEnum = StatusEnum.STATUS_IN_PROGRESS
    # foreign keys
    trail_id: int = Field(
        sa_column=Column(Integer, ForeignKey("trail.id", ondelete="CASCADE"))
    )
    course_id: int = Field(
        sa_column=Column(Integer, ForeignKey("course.id", ondelete="CASCADE"))
    )
    org_id: int = Field(
        sa_column=Column(Integer, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    user_id: int = Field(
        sa_column=Column(Integer, ForeignKey("user.id", ondelete="CASCADE"))
    )
    # timestamps
    creation_date: str
    update_date: str


class TrailRunCreate(TrailRun):
    pass


# trick because Lists are not supported in SQLModel (runs: list[TrailStep] )
class TrailRunRead(BaseModel):
    id: Optional[int] = Field(default=None, primary_key=True)
    data: dict = Field(default={}, sa_column=Column(JSON))
    status: StatusEnum = StatusEnum.STATUS_IN_PROGRESS
    # foreign keys
    trail_id: int = Field(default=None, foreign_key="trail.id")
    course_id: int = Field(default=None, foreign_key="course.id")
    org_id: int = Field(default=None, foreign_key="organization.id")
    user_id: int = Field(default=None, foreign_key="user.id")
    # course object
    course: Optional[dict]
    # timestamps
    creation_date: Optional[str]
    update_date: Optional[str]
    # number of activities in course
    course_total_steps: int
    steps: list[TrailStep]
    pass



================================================
FILE: apps/api/src/db/trail_steps.py
================================================
from enum import Enum
from typing import Optional
from sqlmodel import Field, SQLModel
from sqlalchemy import ForeignKey, JSON, Column, Integer


class TrailStepTypeEnum(str, Enum):
    STEP_TYPE_READABLE_ACTIVITY = "STEP_TYPE_READABLE_ACTIVITY"
    STEP_TYPE_ASSIGNMENT_ACTIVITY = "STEP_TYPE_ASSIGNMENT_ACTIVITY"
    STEP_TYPE_CUSTOM_ACTIVITY = "STEP_TYPE_CUSTOM_ACTIVITY"


class TrailStep(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    complete: bool
    teacher_verified: bool
    grade: str
    data: dict = Field(default={}, sa_column=Column(JSON))
    # foreign keys
    trailrun_id: int = Field(
        sa_column=Column(Integer, ForeignKey("trailrun.id", ondelete="CASCADE"))
    )
    trail_id: int = Field(
        sa_column=Column(Integer, ForeignKey("trail.id", ondelete="CASCADE"))
    )
    activity_id: int = Field(
        sa_column=Column(Integer, ForeignKey("activity.id", ondelete="CASCADE"))
    )
    course_id: int = Field(
        sa_column=Column(Integer, ForeignKey("course.id", ondelete="CASCADE"))
    )
    org_id: int = Field(
        sa_column=Column(Integer, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    user_id: int = Field(
        sa_column=Column(Integer, ForeignKey("user.id", ondelete="CASCADE"))
    )
    # timestamps
    creation_date: str
    update_date: str


# note : prepare assignments support
# an assignment object will be linked to a trail step object in the future



================================================
FILE: apps/api/src/db/trails.py
================================================
from typing import Optional
from pydantic import BaseModel
from sqlalchemy import Column, ForeignKey, Integer
from sqlmodel import Field, SQLModel
from src.db.trail_runs import TrailRunRead


class TrailBase(SQLModel):
    org_id: int = Field(
        sa_column=Column(Integer, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    user_id: int = Field(
        sa_column=Column(Integer, ForeignKey("user.id", ondelete="CASCADE"))
    )


class Trail(TrailBase, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    org_id: int = Field(
        sa_column=Column(Integer, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    user_id: int = Field(
        sa_column=Column(Integer, ForeignKey("user.id", ondelete="CASCADE"))
    )
    trail_uuid: str = ""
    creation_date: str = ""
    update_date: str = ""


class TrailCreate(TrailBase):
    pass


# TODO: This is a hacky way to get around the list[TrailRun] issue, find a better way to do this
class TrailRead(BaseModel):
    id: Optional[int] = Field(default=None, primary_key=True)
    trail_uuid: Optional[str]
    org_id: int = Field(
        sa_column=Column(Integer, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    user_id: int = Field(
        sa_column=Column(Integer, ForeignKey("user.id", ondelete="CASCADE"))
    )
    creation_date: Optional[str]
    update_date: Optional[str]
    runs: list[TrailRunRead]

    class Config:
        orm_mode = True



================================================
FILE: apps/api/src/db/user_organizations.py
================================================
from typing import Optional
from sqlalchemy import Column, ForeignKey, Integer
from sqlmodel import Field, SQLModel


class UserOrganization(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    user_id: int = Field(default=None, foreign_key="user.id")
    org_id: int = Field(
        sa_column=Column(Integer, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    role_id: int = Field(default=None, foreign_key="role.id")
    creation_date: str
    update_date: str



================================================
FILE: apps/api/src/db/usergroup_resources.py
================================================
from typing import Optional
from sqlalchemy import Column, ForeignKey, Integer
from sqlmodel import Field, SQLModel


class UserGroupResource(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    usergroup_id: int = Field(
        sa_column=Column(Integer, ForeignKey("usergroup.id", ondelete="CASCADE"))
    )
    resource_uuid: str = ""
    org_id: int = Field(
        sa_column=Column(Integer, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    creation_date: str = ""
    update_date: str = ""



================================================
FILE: apps/api/src/db/usergroup_user.py
================================================
from typing import Optional
from sqlalchemy import Column, ForeignKey, Integer
from sqlmodel import Field, SQLModel


class UserGroupUser(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    usergroup_id: int = Field(
        sa_column=Column(Integer, ForeignKey("usergroup.id", ondelete="CASCADE"))
    )
    user_id: int = Field(
        sa_column=Column(Integer, ForeignKey("user.id", ondelete="CASCADE"))
    )
    org_id: int = Field(
        sa_column=Column(Integer, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    creation_date: str = ""
    update_date: str = ""



================================================
FILE: apps/api/src/db/usergroups.py
================================================
from typing import Optional
from sqlalchemy import Column, ForeignKey, Integer
from sqlmodel import Field, SQLModel


class UserGroupBase(SQLModel):
    name: str
    description: str

class UserGroup(UserGroupBase, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    org_id: int = Field(
        sa_column=Column(Integer, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    usergroup_uuid: str = ""
    creation_date: str = ""
    update_date: str = ""

class UserGroupCreate(UserGroupBase):
    org_id: int = Field(default=None, foreign_key="organization.id")
    pass

class UserGroupUpdate(UserGroupBase):
    name: str
    description: str

class UserGroupRead(UserGroupBase):
    id: int
    org_id: int = Field(default=None, foreign_key="organization.id")
    usergroup_uuid: str
    creation_date: str
    update_date: str
    pass



================================================
FILE: apps/api/src/db/users.py
================================================
from typing import Optional
from pydantic import BaseModel, EmailStr
from sqlmodel import Field, SQLModel
from sqlalchemy import JSON, Column
from src.db.roles import RoleRead



class UserBase(SQLModel):
    username: str
    first_name: str
    last_name: str
    email: EmailStr
    avatar_image: Optional[str] = ""
    bio: Optional[str] = ""
    details: Optional[dict] = Field(default={}, sa_column=Column(JSON))
    profile: Optional[dict] = Field(default={}, sa_column=Column(JSON))

class UserCreate(UserBase):
    first_name: str = ""
    last_name: str = ""
    password: str


class UserUpdate(UserBase):
    username: str
    first_name: Optional[str]
    last_name: Optional[str]
    email: str
    avatar_image: Optional[str] = ""
    bio: Optional[str] = ""
    details: Optional[dict] = {}
    profile: Optional[dict] = {}


class UserUpdatePassword(SQLModel):
    old_password: str
    new_password: str


class UserRead(UserBase):
    id: int
    user_uuid: str


class PublicUser(UserRead):
    pass


class UserRoleWithOrg(BaseModel):
    from src.db.organizations import OrganizationRead
    role: RoleRead
    org: OrganizationRead


class UserSession(BaseModel):
    user: UserRead
    roles: list[UserRoleWithOrg]


class AnonymousUser(SQLModel):
    id: int = 0
    user_uuid: str = "user_anonymous"
    username: str = "anonymous"

class InternalUser(SQLModel):
    id: int = 0
    user_uuid: str = "user_internal"
    username: str = "internal"


class User(UserBase, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    password: str = ""
    user_uuid: str = ""
    email_verified: bool = False
    creation_date: str = ""
    update_date: str = ""



================================================
FILE: apps/api/src/db/courses/activities.py
================================================
from typing import Optional
from sqlalchemy import JSON, Column, ForeignKey, Integer
from sqlmodel import Field, SQLModel
from enum import Enum


class ActivityTypeEnum(str, Enum):
    TYPE_VIDEO = "TYPE_VIDEO"
    TYPE_DOCUMENT = "TYPE_DOCUMENT"
    TYPE_DYNAMIC = "TYPE_DYNAMIC"
    TYPE_ASSIGNMENT = "TYPE_ASSIGNMENT"
    TYPE_CUSTOM = "TYPE_CUSTOM"


class ActivitySubTypeEnum(str, Enum):
    # Dynamic
    SUBTYPE_DYNAMIC_PAGE = "SUBTYPE_DYNAMIC_PAGE"
    # Video
    SUBTYPE_VIDEO_YOUTUBE = "SUBTYPE_VIDEO_YOUTUBE"
    SUBTYPE_VIDEO_HOSTED = "SUBTYPE_VIDEO_HOSTED"
    # Document
    SUBTYPE_DOCUMENT_PDF = "SUBTYPE_DOCUMENT_PDF"
    SUBTYPE_DOCUMENT_DOC = "SUBTYPE_DOCUMENT_DOC"
    # Assignment
    SUBTYPE_ASSIGNMENT_ANY = "SUBTYPE_ASSIGNMENT_ANY"
    # Custom
    SUBTYPE_CUSTOM = "SUBTYPE_CUSTOM"


class ActivityBase(SQLModel):
    name: str
    activity_type: ActivityTypeEnum 
    activity_sub_type: ActivitySubTypeEnum 
    content: dict = Field(default={}, sa_column=Column(JSON))
    details: Optional[dict] = Field(default=None, sa_column=Column(JSON))
    published: bool = False


class Activity(ActivityBase, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    org_id: int = Field(
        sa_column=Column(Integer, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    course_id: int = Field(
        default=None,
        sa_column=Column(Integer, ForeignKey("course.id", ondelete="CASCADE")),
    )
    activity_uuid: str = ""
    creation_date: str = ""
    update_date: str = ""


class ActivityCreate(ActivityBase):
    chapter_id: int
    activity_type: ActivityTypeEnum = ActivityTypeEnum.TYPE_CUSTOM
    activity_sub_type: ActivitySubTypeEnum = ActivitySubTypeEnum.SUBTYPE_CUSTOM
    details: dict = Field(default={}, sa_column=Column(JSON))
    pass


class ActivityUpdate(ActivityBase):
    name: Optional[str]
    content: dict = Field(default={}, sa_column=Column(JSON))
    activity_type: Optional[ActivityTypeEnum] 
    activity_sub_type: Optional[ActivitySubTypeEnum] 
    details: Optional[dict] = Field(default=None, sa_column=Column(JSON))
    published_version: Optional[int]
    version: Optional[int]


class ActivityRead(ActivityBase):
    id: int
    org_id: int
    course_id: int
    activity_uuid: str
    creation_date: str
    update_date: str
    details: Optional[dict] = Field(default=None, sa_column=Column(JSON))
    pass



================================================
FILE: apps/api/src/db/courses/assignments.py
================================================
from typing import Optional, Dict
from sqlalchemy import JSON, Column, ForeignKey
from sqlmodel import Field, SQLModel
from enum import Enum


## Assignment ##
class GradingTypeEnum(str, Enum):
    ALPHABET = "ALPHABET"
    NUMERIC = "NUMERIC"
    PERCENTAGE = "PERCENTAGE"


class AssignmentBase(SQLModel):
    """Represents the common fields for an assignment."""

    title: str
    description: str
    due_date: str
    published: Optional[bool] = False
    grading_type: GradingTypeEnum

    org_id: int
    course_id: int
    chapter_id: int
    activity_id: int


class AssignmentCreate(AssignmentBase):
    """Model for creating a new assignment."""

    pass  # Inherits all fields from AssignmentBase


class AssignmentRead(AssignmentBase):
    """Model for reading an assignment."""

    id: int
    assignment_uuid: str
    creation_date: Optional[str]
    update_date: Optional[str]


class AssignmentUpdate(SQLModel):
    """Model for updating an assignment."""

    title: Optional[str]
    description: Optional[str]
    due_date: Optional[str]
    published: Optional[bool]
    grading_type: Optional[GradingTypeEnum]
    org_id: Optional[int]
    course_id: Optional[int]
    chapter_id: Optional[int]
    activity_id: Optional[int]
    update_date: Optional[str]


class Assignment(AssignmentBase, table=True):
    """Represents an assignment with relevant details and foreign keys."""

    id: Optional[int] = Field(default=None, primary_key=True)
    creation_date: Optional[str]
    update_date: Optional[str]
    assignment_uuid: str

    org_id: int = Field(
        sa_column=Column("org_id", ForeignKey("organization.id", ondelete="CASCADE"))
    )
    course_id: int = Field(
        sa_column=Column("course_id", ForeignKey("course.id", ondelete="CASCADE"))
    )
    chapter_id: int = Field(
        sa_column=Column("chapter_id", ForeignKey("chapter.id", ondelete="CASCADE"))
    )
    activity_id: int = Field(
        sa_column=Column("activity_id", ForeignKey("activity.id", ondelete="CASCADE"))
    )


## Assignment ##

## AssignmentTask ##


class AssignmentTaskTypeEnum(str, Enum):
    FILE_SUBMISSION = "FILE_SUBMISSION"
    QUIZ = "QUIZ"
    FORM = "FORM"  # soon to be implemented
    OTHER = "OTHER"


class AssignmentTaskBase(SQLModel):
    """Represents the common fields for an assignment task."""

    title: str
    description: str
    hint: str
    reference_file: Optional[str]
    assignment_type: AssignmentTaskTypeEnum
    contents: Dict = Field(default={}, sa_column=Column(JSON))
    max_grade_value: int = 0  # Value is always between 0-100


class AssignmentTaskCreate(AssignmentTaskBase):
    """Model for creating a new assignment task."""

    pass  # Inherits all fields from AssignmentTaskBase


class AssignmentTaskRead(AssignmentTaskBase):
    """Model for reading an assignment task."""

    id: int
    assignment_task_uuid: str


class AssignmentTaskUpdate(SQLModel):
    """Model for updating an assignment task."""

    title: Optional[str]
    description: Optional[str]
    hint: Optional[str]
    assignment_type: Optional[AssignmentTaskTypeEnum]
    contents: Optional[Dict] = Field(default=None, sa_column=Column(JSON))
    max_grade_value: Optional[int]


class AssignmentTask(AssignmentTaskBase, table=True):
    """Represents a task within an assignment with various attributes and foreign keys."""

    id: Optional[int] = Field(default=None, primary_key=True)

    assignment_task_uuid: str
    creation_date: str
    update_date: str

    assignment_id: int = Field(
        sa_column=Column(
            "assignment_id", ForeignKey("assignment.id", ondelete="CASCADE")
        )
    )
    org_id: int = Field(
        sa_column=Column("org_id", ForeignKey("organization.id", ondelete="CASCADE"))
    )
    course_id: int = Field(
        sa_column=Column("course_id", ForeignKey("course.id", ondelete="CASCADE"))
    )
    chapter_id: int = Field(
        sa_column=Column("chapter_id", ForeignKey("chapter.id", ondelete="CASCADE"))
    )
    activity_id: int = Field(
        sa_column=Column("activity_id", ForeignKey("activity.id", ondelete="CASCADE"))
    )


## AssignmentTask ##


## AssignmentTaskSubmission ##


class AssignmentTaskSubmissionBase(SQLModel):
    """Represents the common fields for an assignment task submission."""
    assignment_task_submission_uuid: str
    task_submission: Dict = Field(default={}, sa_column=Column(JSON))
    grade: int = 0  # Value is always between 0-100
    task_submission_grade_feedback: str
    assignment_type: AssignmentTaskTypeEnum

    user_id: int
    activity_id: int
    course_id: int
    chapter_id: int
    assignment_task_id: int


class AssignmentTaskSubmissionCreate(AssignmentTaskSubmissionBase):
    """Model for creating a new assignment task submission."""

    pass  # Inherits all fields from AssignmentTaskSubmissionBase


class AssignmentTaskSubmissionRead(AssignmentTaskSubmissionBase):
    """Model for reading an assignment task submission."""

    id: int
    creation_date: str
    update_date: str


class AssignmentTaskSubmissionUpdate(SQLModel):
    """Model for updating an assignment task submission."""

    assignment_task_id: Optional[int]
    assignment_task_submission_uuid: Optional[str]
    task_submission: Optional[Dict] = Field(default=None, sa_column=Column(JSON))
    grade: Optional[int]
    task_submission_grade_feedback: Optional[str]
    assignment_type: Optional[AssignmentTaskTypeEnum]


class AssignmentTaskSubmission(AssignmentTaskSubmissionBase, table=True):
    """Represents a submission for a specific assignment task with grade and feedback."""

    id: Optional[int] = Field(default=None, primary_key=True)
    assignment_task_submission_uuid: str
    task_submission: Dict = Field(default={}, sa_column=Column(JSON))
    grade: int = 0  # Value is always between 0-100
    task_submission_grade_feedback: str
    assignment_type: AssignmentTaskTypeEnum

    user_id: int = Field(
        sa_column=Column("user_id", ForeignKey("user.id", ondelete="CASCADE"))
    )
    activity_id: int = Field(
        sa_column=Column("activity_id", ForeignKey("activity.id", ondelete="CASCADE"))
    )
    course_id: int = Field(
        sa_column=Column("course_id", ForeignKey("course.id", ondelete="CASCADE"))
    )
    chapter_id: int = Field(
        sa_column=Column("chapter_id", ForeignKey("chapter.id", ondelete="CASCADE"))
    )
    assignment_task_id: int = Field(
        sa_column=Column(
            "assignment_task_id", ForeignKey("assignmenttask.id", ondelete="CASCADE")
        )
    )

    creation_date: str
    update_date: str


## AssignmentTaskSubmission ##

## AssignmentUserSubmission ##


class AssignmentUserSubmissionStatus(str, Enum):
    PENDING = "PENDING"
    SUBMITTED = "SUBMITTED"
    GRADED = "GRADED"
    LATE = "LATE"
    NOT_SUBMITTED = "NOT_SUBMITTED"


class AssignmentUserSubmissionBase(SQLModel):
    """Represents the submission status of an assignment for a user."""

    submission_status: AssignmentUserSubmissionStatus = (
        AssignmentUserSubmissionStatus.SUBMITTED
    )
    grade: int
    user_id: int = Field(
        sa_column=Column("user_id", ForeignKey("user.id", ondelete="CASCADE"))
    )
    assignment_id: int = Field(
        sa_column=Column(
            "assignment_id", ForeignKey("assignment.id", ondelete="CASCADE")
        )
    )


class AssignmentUserSubmissionCreate(SQLModel):
    """Model for creating a new assignment user submission."""

    assignment_id: int
    pass  # Inherits all fields from AssignmentUserSubmissionBase


class AssignmentUserSubmissionRead(AssignmentUserSubmissionBase):
    """Model for reading an assignment user submission."""

    id: int
    creation_date: str
    update_date: str


class AssignmentUserSubmissionUpdate(SQLModel):
    """Model for updating an assignment user submission."""

    submission_status: Optional[AssignmentUserSubmissionStatus]
    grade: Optional[str]
    user_id: Optional[int]
    assignment_id: Optional[int]


class AssignmentUserSubmission(AssignmentUserSubmissionBase, table=True):
    """Represents the submission status of an assignment for a user."""

    id: Optional[int] = Field(default=None, primary_key=True)
    creation_date: str
    update_date: str
    assignmentusersubmission_uuid: str

    submission_status: AssignmentUserSubmissionStatus = (
        AssignmentUserSubmissionStatus.SUBMITTED
    )
    grade: int
    user_id: int = Field(
        sa_column=Column("user_id", ForeignKey("user.id", ondelete="CASCADE"))
    )
    assignment_id: int = Field(
        sa_column=Column(
            "assignment_id", ForeignKey("assignment.id", ondelete="CASCADE")
        )
    )



================================================
FILE: apps/api/src/db/courses/blocks.py
================================================
from typing import Optional
from sqlalchemy import JSON, Column, ForeignKey
from sqlmodel import Field, SQLModel
from enum import Enum


class BlockTypeEnum(str, Enum):
    BLOCK_QUIZ = "BLOCK_QUIZ"
    BLOCK_VIDEO = "BLOCK_VIDEO"
    BLOCK_DOCUMENT_PDF = "BLOCK_DOCUMENT_PDF"
    BLOCK_IMAGE = "BLOCK_IMAGE"
    BLOCK_CUSTOM = "BLOCK_CUSTOM"


class BlockBase(SQLModel):
    id: Optional[int] = Field(default=None, primary_key=True)
    block_type: BlockTypeEnum = BlockTypeEnum.BLOCK_CUSTOM
    content: dict = Field(default={}, sa_column=Column(JSON))


class Block(BlockBase, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    content: dict = Field(default={}, sa_column=Column(JSON))
    org_id: int = Field(sa_column= Column("org_id", ForeignKey("organization.id", ondelete="CASCADE")))
    course_id: int = Field(sa_column= Column("course_id", ForeignKey("course.id", ondelete="CASCADE")))
    chapter_id: int = Field(sa_column= Column("chapter_id", ForeignKey("chapter.id", ondelete="CASCADE")))
    activity_id: int = Field(sa_column= Column("activity_id", ForeignKey("activity.id", ondelete="CASCADE")))
    block_uuid: str
    creation_date: str
    update_date: str


class BlockCreate(BlockBase):
    pass


class BlockRead(BlockBase):
    id: int = Field(default=None, primary_key=True)
    org_id: int = Field(default=None, foreign_key="organization.id")
    course_id: int = Field(default=None, foreign_key="course.id")
    chapter_id: int = Field(default=None, foreign_key="chapter.id")
    activity_id: int = Field(default=None, foreign_key="activity.id")
    block_uuid: str
    creation_date: str
    update_date: str
    pass



================================================
FILE: apps/api/src/db/courses/certifications.py
================================================
from typing import Optional
from sqlalchemy import JSON, Column, ForeignKey
from sqlmodel import Field, SQLModel

class CertificationBase(SQLModel):
    course_id: int = Field(sa_column= Column("course_id", ForeignKey("course.id", ondelete="CASCADE")))
    config: dict = Field(default={}, sa_column= Column("config", JSON))

class Certifications(CertificationBase, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    certification_uuid: str = Field(unique=True)
    course_id: int = Field(sa_column= Column("course_id", ForeignKey("course.id", ondelete="CASCADE")))
    config: dict = Field(default={}, sa_column= Column("config", JSON))
    creation_date: str = ""
    update_date: str = ""

class CertificationCreate(SQLModel):
    course_id: int
    config: dict = Field(default={})

class CertificationUpdate(SQLModel):
    config: Optional[dict] = None

class CertificationRead(SQLModel):
    id: int
    certification_uuid: str
    course_id: int
    config: dict
    creation_date: str
    update_date: str


class CertificateUserBase(SQLModel):
    user_id: int = Field(sa_column= Column("user_id", ForeignKey("user.id", ondelete="CASCADE")))
    certification_id: int = Field(sa_column= Column("certification_id", ForeignKey("certifications.id", ondelete="CASCADE")))
    user_certification_uuid: str

class CertificateUser(CertificateUserBase, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    user_id: int = Field(sa_column= Column("user_id", ForeignKey("user.id", ondelete="CASCADE")))
    certification_id: int = Field(sa_column= Column("certification_id", ForeignKey("certifications.id", ondelete="CASCADE")))
    user_certification_uuid: str
    created_at: str = ""
    updated_at: str = ""

class CertificateUserCreate(SQLModel):
    user_id: int
    certification_id: int
    user_certification_uuid: str

class CertificateUserRead(SQLModel):
    id: int
    user_id: int
    certification_id: int
    user_certification_uuid: str
    created_at: str
    updated_at: str

class CertificateUserUpdate(SQLModel):
    user_id: Optional[int] = None
    certification_id: Optional[int] = None
    user_certification_uuid: Optional[str] = None




================================================
FILE: apps/api/src/db/courses/chapter_activities.py
================================================
from typing import Optional
from sqlalchemy import BigInteger, Column, ForeignKey, Integer
from sqlmodel import Field, SQLModel

class ChapterActivity(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    order: int
    chapter_id: int = Field(sa_column=Column(BigInteger, ForeignKey("chapter.id", ondelete="CASCADE")))
    activity_id: int = Field(sa_column=Column(BigInteger, ForeignKey("activity.id", ondelete="CASCADE")))
    course_id : int = Field(sa_column=Column(BigInteger, ForeignKey("course.id", ondelete="CASCADE")))
    org_id: int = Field(
        sa_column=Column(Integer, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    creation_date: str
    update_date: str


================================================
FILE: apps/api/src/db/courses/chapters.py
================================================
from typing import Any, List, Optional
from pydantic import BaseModel
from sqlmodel import Column, ForeignKey, Integer
from sqlmodel import Field, SQLModel
from src.db.courses.activities import ActivityRead


class ChapterBase(SQLModel):
    name: str
    description: Optional[str] = ""
    thumbnail_image: Optional[str] = ""
    org_id: int = Field(
        sa_column=Column("org_id", Integer, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    course_id: int = Field(
        sa_column=Column("course_id", Integer, ForeignKey("course.id", ondelete="CASCADE"))
    )


class Chapter(ChapterBase, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    chapter_uuid: str = ""
    creation_date: str = ""
    update_date: str = ""


class ChapterCreate(ChapterBase):
    # referenced order here will be ignored and just used for validation
    # used order will be the next available.
    pass


class ChapterUpdate(ChapterBase):
    name: Optional[str]
    description: Optional[str] = ""
    thumbnail_image: Optional[str] = ""
    course_id: Optional[int]
    org_id: Optional[int] # type: ignore


class ChapterRead(ChapterBase):
    id: int
    activities: List[ActivityRead]
    chapter_uuid: str
    creation_date: str
    update_date: str
    pass


class ActivityOrder(BaseModel):
    activity_id: int


class ChapterOrder(BaseModel):
    chapter_id: int
    activities_order_by_ids: List[ActivityOrder]


class ChapterUpdateOrder(BaseModel):
    chapter_order_by_ids: List[ChapterOrder]


class DepreceatedChaptersRead(BaseModel):
    chapterOrder: Any
    chapters: Any
    activities: Any
    pass



================================================
FILE: apps/api/src/db/courses/course_chapters.py
================================================
from typing import Optional
from sqlalchemy import Column, ForeignKey, Integer
from sqlmodel import Field, SQLModel


class CourseChapter(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    order: int
    course_id: int = Field(
        sa_column=Column(Integer, ForeignKey("course.id", ondelete="CASCADE"))
    )
    chapter_id: int = Field(
        sa_column=Column(Integer, ForeignKey("chapter.id", ondelete="CASCADE"))
    )
    org_id: int = Field(
        sa_column=Column(Integer, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    creation_date: str
    update_date: str



================================================
FILE: apps/api/src/db/courses/course_updates.py
================================================
from typing import Optional
from sqlalchemy import Column, ForeignKey, Integer
from sqlmodel import Field, SQLModel


class CourseUpdate(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    courseupdate_uuid: str
    title: str 
    content: str 
    course_id: int = Field(
        sa_column=Column(Integer, ForeignKey("course.id", ondelete="CASCADE"))
    )
    linked_activity_uuids: Optional[str] = Field(default=None)
    org_id: int = Field(
        sa_column=Column(Integer, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    creation_date: str
    update_date: str

class CourseUpdateCreate(SQLModel):
    title: str 
    content: str 
    linked_activity_uuids: Optional[str] = Field(default=None)
    org_id: int

class CourseUpdateRead(SQLModel):
    id: int
    title: str 
    content: str 
    course_id: int
    courseupdate_uuid: str
    linked_activity_uuids: Optional[str] = Field(default=None)
    org_id: int
    creation_date: str
    update_date: str

class CourseUpdateUpdate(SQLModel):
    title: Optional[str] = None
    content: Optional[str] = None
    linked_activity_uuids: Optional[str] = Field(default=None)

    


================================================
FILE: apps/api/src/db/courses/courses.py
================================================
from typing import List, Optional
from sqlalchemy import Column, ForeignKey, Integer
from sqlmodel import Field, SQLModel
from enum import Enum
from src.db.users import UserRead
from src.db.trails import TrailRead
from src.db.courses.chapters import ChapterRead
from src.db.resource_authors import ResourceAuthorshipEnum, ResourceAuthorshipStatusEnum


class ThumbnailType(str, Enum):
    IMAGE = "image"
    VIDEO = "video"
    BOTH = "both"


class AuthorWithRole(SQLModel):
    user: UserRead
    authorship: ResourceAuthorshipEnum
    authorship_status: ResourceAuthorshipStatusEnum
    creation_date: str
    update_date: str


class CourseBase(SQLModel):
    name: str
    description: Optional[str]
    about: Optional[str]
    learnings: Optional[str]
    tags: Optional[str]
    thumbnail_type: Optional[ThumbnailType] = Field(default=ThumbnailType.IMAGE)
    thumbnail_image: Optional[str] = Field(default="")
    thumbnail_video: Optional[str] = Field(default="")
    public: bool
    open_to_contributors: bool


class Course(CourseBase, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    org_id: int = Field(
        sa_column=Column(Integer, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    course_uuid: str = ""   
    creation_date: str = ""
    update_date: str = ""


class CourseCreate(CourseBase):
    org_id: int = Field(default=None, foreign_key="organization.id")
    thumbnail_type: Optional[ThumbnailType] = Field(default=ThumbnailType.IMAGE)
    thumbnail_image: Optional[str] = Field(default="")
    thumbnail_video: Optional[str] = Field(default="")
    pass


class CourseUpdate(CourseBase):
    name: str
    description: Optional[str]
    about: Optional[str]
    learnings: Optional[str]
    tags: Optional[str]
    thumbnail_type: Optional[ThumbnailType] = Field(default=ThumbnailType.IMAGE)
    thumbnail_image: Optional[str] = Field(default="")
    thumbnail_video: Optional[str] = Field(default="")
    public: Optional[bool]
    open_to_contributors: Optional[bool]


class CourseRead(CourseBase):
    id: int
    org_id: int = Field(default=None, foreign_key="organization.id")
    authors: List[AuthorWithRole]
    course_uuid: str
    creation_date: str
    update_date: str
    thumbnail_type: Optional[ThumbnailType] = Field(default=ThumbnailType.IMAGE)
    thumbnail_image: Optional[str] = Field(default="")
    thumbnail_video: Optional[str] = Field(default="")
    pass


class FullCourseRead(CourseBase):
    id: int
    org_id: int
    course_uuid: Optional[str]
    creation_date: Optional[str]
    update_date: Optional[str]
    thumbnail_type: Optional[ThumbnailType] = Field(default=ThumbnailType.IMAGE)
    thumbnail_image: Optional[str] = Field(default="")
    thumbnail_video: Optional[str] = Field(default="")
    # Chapters, Activities
    chapters: List[ChapterRead]
    authors: List[AuthorWithRole]
    pass


class FullCourseReadWithTrail(CourseBase):
    id: int
    course_uuid: Optional[str]
    creation_date: Optional[str]
    update_date: Optional[str]
    org_id: int = Field(default=None, foreign_key="organization.id")
    authors: List[AuthorWithRole]
    # Chapters, Activities
    chapters: List[ChapterRead]
    # Trail
    trail: TrailRead | None
    pass



================================================
FILE: apps/api/src/db/payments/payments.py
================================================
from datetime import datetime
from enum import Enum
from typing import  Optional
from sqlalchemy import JSON
from sqlmodel import Field, SQLModel, Column, BigInteger, ForeignKey

# PaymentsConfig 
class PaymentProviderEnum(str, Enum):
    STRIPE = "stripe"
    
class PaymentsConfigBase(SQLModel):
    enabled: bool = True
    active: bool = False
    provider: PaymentProviderEnum = PaymentProviderEnum.STRIPE
    provider_specific_id: str | None = None
    provider_config: dict = Field(default={}, sa_column=Column(JSON))


class PaymentsConfig(PaymentsConfigBase, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    org_id: int = Field(
        sa_column=Column(BigInteger, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    creation_date: datetime = Field(default=datetime.now())
    update_date: datetime = Field(default=datetime.now())


class PaymentsConfigCreate(PaymentsConfigBase):
    pass


class PaymentsConfigUpdate(PaymentsConfigBase):
    enabled: Optional[bool] = True
    provider_config: Optional[dict] = None
    provider_specific_id: Optional[str] = None


class PaymentsConfigRead(PaymentsConfigBase):
    id: int
    org_id: int
    creation_date: datetime
    update_date: datetime


class PaymentsConfigDelete(SQLModel):
    id: int


================================================
FILE: apps/api/src/db/payments/payments_courses.py
================================================
from sqlmodel import SQLModel, Field, Column, BigInteger, ForeignKey
from typing import Optional
from datetime import datetime

class PaymentsCourseBase(SQLModel):
    course_id: int = Field(sa_column=Column(BigInteger, ForeignKey("course.id", ondelete="CASCADE")))
    
class PaymentsCourse(PaymentsCourseBase, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    payment_product_id: int = Field(sa_column=Column(BigInteger, ForeignKey("paymentsproduct.id", ondelete="CASCADE")))
    org_id: int = Field(
        sa_column=Column(BigInteger, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    creation_date: datetime = Field(default=datetime.now())
    update_date: datetime = Field(default=datetime.now())


================================================
FILE: apps/api/src/db/payments/payments_products.py
================================================
from enum import Enum
from sqlmodel import SQLModel, Field, Column, BigInteger, ForeignKey, String
from typing import Optional
from datetime import datetime

class PaymentProductTypeEnum(str, Enum):
    SUBSCRIPTION = "subscription"
    ONE_TIME = "one_time"

class PaymentPriceTypeEnum(str, Enum):
    CUSTOMER_CHOICE = "customer_choice"
    FIXED_PRICE = "fixed_price"
    
class PaymentsProductBase(SQLModel):
    name: str = ""
    description: Optional[str] = ""
    product_type: PaymentProductTypeEnum = PaymentProductTypeEnum.ONE_TIME
    price_type: PaymentPriceTypeEnum = PaymentPriceTypeEnum.FIXED_PRICE
    benefits: str = ""
    amount: float = 0.0
    currency: str = "USD"

class PaymentsProduct(PaymentsProductBase, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    org_id: int = Field(
        sa_column=Column(BigInteger, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    payments_config_id: int = Field(sa_column=Column(BigInteger, ForeignKey("paymentsconfig.id", ondelete="CASCADE")))
    provider_product_id: str = Field(sa_column=Column(String))
    creation_date: datetime = Field(default=datetime.now())
    update_date: datetime = Field(default=datetime.now())

class PaymentsProductCreate(PaymentsProductBase):
    pass

class PaymentsProductUpdate(PaymentsProductBase):
    pass

class PaymentsProductRead(PaymentsProductBase):
    id: int
    org_id: int
    payments_config_id: int
    creation_date: datetime
    update_date: datetime



================================================
FILE: apps/api/src/db/payments/payments_users.py
================================================
from openai import BaseModel
from sqlmodel import SQLModel, Field, Column, BigInteger, ForeignKey, JSON
from typing import Optional
from datetime import datetime
from enum import Enum

class PaymentStatusEnum(str, Enum):
    PENDING = "pending"
    COMPLETED = "completed"
    ACTIVE = "active"
    CANCELLED = "cancelled"
    FAILED = "failed"
    REFUNDED = "refunded"


class ProviderSpecificData(BaseModel):
    stripe_customer: dict | None = None
    custom_customer: dict | None = None

class PaymentsUserBase(SQLModel):
    status: PaymentStatusEnum = PaymentStatusEnum.PENDING
    provider_specific_data: dict = Field(default={}, sa_column=Column(JSON))

class PaymentsUser(PaymentsUserBase, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    user_id: int = Field(
        sa_column=Column(BigInteger, ForeignKey("user.id", ondelete="CASCADE"))
    )
    org_id: int = Field(
        sa_column=Column(BigInteger, ForeignKey("organization.id", ondelete="CASCADE"))
    )
    payment_product_id: int = Field(
        sa_column=Column(BigInteger, ForeignKey("paymentsproduct.id", ondelete="CASCADE"))
    )
    creation_date: datetime = Field(default=datetime.now())
    update_date: datetime = Field(default=datetime.now())




================================================
FILE: apps/api/src/routers/__init__.py
================================================
[Empty file]


================================================
FILE: apps/api/src/routers/auth.py
================================================
from datetime import timedelta
from typing import Literal, Optional
from fastapi import Depends, APIRouter, HTTPException, Response, status, Request
from fastapi.security import OAuth2PasswordRequestForm
from pydantic import BaseModel, EmailStr
from sqlmodel import Session
from src.db.users import AnonymousUser, UserRead
from src.core.events.database import get_db_session
from config.config import get_learnhouse_config
from src.security.auth import AuthJWT, authenticate_user, get_current_user
from src.services.auth.utils import signWithGoogle


router = APIRouter()


@router.get("/refresh")
def refresh(response: Response, Authorize: AuthJWT = Depends()):
    """
    The jwt_refresh_token_required() function insures a valid refresh
    token is present in the request before running any code below that function.
    we can use the get_jwt_subject() function to get the subject of the refresh
    token, and use the create_access_token() function again to make a new access token
    """
    Authorize.jwt_refresh_token_required()

    current_user = Authorize.get_jwt_subject()
    new_access_token = Authorize.create_access_token(subject=current_user)  # type: ignore

    response.set_cookie(
        key="access_token_cookie",
        value=new_access_token,
        httponly=False,
        domain=get_learnhouse_config().hosting_config.cookie_config.domain,
        expires=int(timedelta(hours=8).total_seconds()),
    )
    return {"access_token": new_access_token}


@router.post("/login")
async def login(
    request: Request,
    response: Response,
    Authorize: AuthJWT = Depends(),
    form_data: OAuth2PasswordRequestForm = Depends(),
    db_session: Session = Depends(get_db_session),
):
    user = await authenticate_user(
        request, form_data.username, form_data.password, db_session
    )
    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Incorrect Email or password",
            headers={"WWW-Authenticate": "Bearer"},
        )

    access_token = Authorize.create_access_token(subject=form_data.username)
    refresh_token = Authorize.create_refresh_token(subject=form_data.username)
    Authorize.set_refresh_cookies(refresh_token)

    # set cookies using fastapi
    response.set_cookie(
        key="access_token_cookie",
        value=access_token,
        httponly=False,
        domain=get_learnhouse_config().hosting_config.cookie_config.domain,
        expires=int(timedelta(hours=8).total_seconds()),
    )

    user = UserRead.model_validate(user)

    result = {
        "user": user,
        "tokens": {"access_token": access_token, "refresh_token": refresh_token},
    }
    return result


class ThirdPartyLogin(BaseModel):
    email: EmailStr
    provider: Literal["google"]
    access_token: str


@router.post("/oauth")
async def third_party_login(
    request: Request,
    response: Response,
    body: ThirdPartyLogin,
    org_id: Optional[int] = None,
    current_user: AnonymousUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
    Authorize: AuthJWT = Depends(),
):
    # Google
    if body.provider == "google":

        user = await signWithGoogle(
            request, body.access_token, body.email, org_id, current_user, db_session
        )

    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Incorrect Email or password",
            headers={"WWW-Authenticate": "Bearer"},
        )

    access_token = Authorize.create_access_token(subject=user.email)
    refresh_token = Authorize.create_refresh_token(subject=user.email)
    Authorize.set_refresh_cookies(refresh_token)

    # set cookies using fastapi
    response.set_cookie(
        key="access_token_cookie",
        value=access_token,
        httponly=False,
        domain=get_learnhouse_config().hosting_config.cookie_config.domain,
        expires=int(timedelta(hours=8).total_seconds()),
    )

    user = UserRead.model_validate(user)

    result = {
        "user": user,
        "tokens": {"access_token": access_token, "refresh_token": refresh_token},
    }
    return result


@router.delete("/logout")
def logout(Authorize: AuthJWT = Depends()):
    """
    Because the JWT are stored in an httponly cookie now, we cannot
    log the user out by simply deleting the cookies in the frontend.
    We need the backend to send us a response to delete the cookies.
    """
    Authorize.jwt_required()

    Authorize.unset_jwt_cookies()
    return {"msg": "Successfully logout"}



================================================
FILE: apps/api/src/routers/dev.py
================================================
from fastapi import APIRouter, Depends
from sqlmodel import Session, select
from config.config import get_learnhouse_config
from migrations.orgconfigs.orgconfigs_migrations import migrate_to_v1_1, migrate_to_v1_2, migrate_v0_to_v1
from src.core.events.database import get_db_session
from src.db.organization_config import OrganizationConfig


router = APIRouter()


@router.get("/config")
async def config():
    config = get_learnhouse_config()
    return config.dict()


@router.post("/migrate_orgconfig_v0_to_v1")
async def migrate(
    db_session: Session = Depends(get_db_session),
):
    """
    Migrate organization config from v0 to v1
    """
    statement = select(OrganizationConfig)
    result = db_session.exec(statement)

    for orgConfig in result:
        orgConfig.config = migrate_v0_to_v1(orgConfig.config)

        db_session.add(orgConfig)
        db_session.commit()

    return {"message": "Migration successful"}


@router.post("/migrate_orgconfig_v1_to_v1.1")
async def migratev1_1(
    db_session: Session = Depends(get_db_session),
):
    """
    Migrate organization config from v0 to v1
    """
    statement = select(OrganizationConfig)
    result = db_session.exec(statement)

    for orgConfig in result:
        orgConfig.config = migrate_to_v1_1(orgConfig.config)

        db_session.add(orgConfig)
        db_session.commit()

    return {"message": "Migration successful"}

@router.post("/migrate_orgconfig_v1_to_v1.2")
async def migratev1_2(
    db_session: Session = Depends(get_db_session),
):
    """
    Migrate organization config from v0 to v1
    """
    statement = select(OrganizationConfig)
    result = db_session.exec(statement)

    for orgConfig in result:
        orgConfig.config = migrate_to_v1_2(orgConfig.config)

        db_session.add(orgConfig)
        db_session.commit()

    return {"message": "Migration successful"}


================================================
FILE: apps/api/src/routers/health.py
================================================
from fastapi import Depends, APIRouter
from sqlmodel import Session
from src.services.health.health import check_health
from src.core.events.database import get_db_session


router = APIRouter()

@router.get("")
async def health(db_session: Session = Depends(get_db_session)):
    return await check_health(db_session)


================================================
FILE: apps/api/src/routers/orgs.py
================================================
from typing import List, Literal
from fastapi import APIRouter, Depends, Request, UploadFile
from sqlmodel import Session
from src.services.orgs.invites import (
    create_invite_code,
    create_invite_code_with_usergroup,
    delete_invite_code,
    get_invite_code,
    get_invite_codes,
)
from src.services.orgs.join import JoinOrg, join_org
from src.services.orgs.users import (
    get_list_of_invited_users,
    get_organization_users,
    invite_batch_users,
    remove_invited_user,
    remove_user_from_org,
    update_user_role,
)
from src.db.organization_config import OrganizationConfigBase
from src.db.users import PublicUser
from src.db.organizations import (
    OrganizationCreate,
    OrganizationRead,
    OrganizationUpdate,
    OrganizationUser,
)
from src.core.events.database import get_db_session
from src.security.auth import get_current_user
from src.services.orgs.orgs import (
    create_org,
    create_org_with_config,
    delete_org,
    get_organization,
    get_organization_by_slug,
    get_orgs_by_user,
    get_orgs_by_user_admin,
    update_org,
    update_org_logo,
    update_org_preview,
    update_org_signup_mechanism,
    update_org_thumbnail,
    update_org_landing,
    upload_org_landing_content_service,
)


router = APIRouter()


@router.post("/")
async def api_create_org(
    request: Request,
    org_object: OrganizationCreate,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> OrganizationRead:
    """
    Create new organization
    """
    return await create_org(request, org_object, current_user, db_session)


# Temporary pre-alpha code
@router.post("/withconfig/")
async def api_create_org_withconfig(
    request: Request,
    org_object: OrganizationCreate,
    config_object: OrganizationConfigBase,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> OrganizationRead:
    """
    Create new organization
    """
    return await create_org_with_config(
        request, org_object, current_user, db_session, config_object
    )


@router.get("/{org_id}")
async def api_get_org(
    request: Request,
    org_id: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> OrganizationRead:
    """
    Get single Org by ID
    """
    return await get_organization(request, org_id, db_session, current_user)


@router.get("/{org_id}/users")
async def api_get_org_users(
    request: Request,
    org_id: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> list[OrganizationUser]:
    """
    Get single Org by ID
    """
    return await get_organization_users(request, org_id, db_session, current_user)


@router.post("/join")
async def api_join_an_org(
    request: Request,
    args: JoinOrg,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Get single Org by ID
    """
    return await join_org(request, args, current_user, db_session)


@router.put("/{org_id}/users/{user_id}/role/{role_uuid}")
async def api_update_user_role(
    request: Request,
    org_id: str,
    user_id: str,
    role_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Update user role
    """
    return await update_user_role(
        request, org_id, user_id, role_uuid, db_session, current_user
    )


@router.delete("/{org_id}/users/{user_id}")
async def api_remove_user_from_org(
    request: Request,
    org_id: int,
    user_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Remove user from org
    """
    return await remove_user_from_org(
        request, org_id, user_id, db_session, current_user
    )


# Config related routes
@router.put("/{org_id}/signup_mechanism")
async def api_get_org_signup_mechanism(
    request: Request,
    org_id: int,
    signup_mechanism: Literal["open", "inviteOnly"],
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Get org signup mechanism
    """
    return await update_org_signup_mechanism(
        request, signup_mechanism, org_id, current_user, db_session
    )


# Invites related routes
@router.post("/{org_id}/invites")
async def api_create_invite_code(
    request: Request,
    org_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Create invite code
    """
    return await create_invite_code(request, org_id, current_user, db_session)


@router.post("/{org_id}/invites_with_usergroups")
async def api_create_invite_code_with_ug(
    request: Request,
    org_id: int,
    usergroup_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Create invite code
    """
    return await create_invite_code_with_usergroup(
        request, org_id, usergroup_id, current_user, db_session
    )


@router.get("/{org_id}/invites")
async def api_get_invite_codes(
    request: Request,
    org_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Get invite codes
    """
    return await get_invite_codes(request, org_id, current_user, db_session)


@router.get("/{org_id}/invites/code/{invite_code}")
async def api_get_invite_code(
    request: Request,
    org_id: int,
    invite_code: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Get invite code
    """
    print(f"org_id: {org_id}, invite_code: {invite_code}")
    return await get_invite_code(request, org_id, invite_code, current_user, db_session)


@router.delete("/{org_id}/invites/{org_invite_code_uuid}")
async def api_delete_invite_code(
    request: Request,
    org_id: int,
    org_invite_code_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Delete invite code
    """
    return await delete_invite_code(
        request, org_id, org_invite_code_uuid, current_user, db_session
    )


@router.post("/{org_id}/invites/users/batch")
async def api_invite_batch_users(
    request: Request,
    org_id: int,
    emails: str,
    invite_code_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Invite batch users by emails
    """
    return await invite_batch_users(
        request, org_id, emails, invite_code_uuid, db_session, current_user
    )


@router.get("/{org_id}/invites/users")
async def api_get_org_users_invites(
    request: Request,
    org_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Get org users invites
    """
    return await get_list_of_invited_users(request, org_id, db_session, current_user)


@router.delete("/{org_id}/invites/users/{email}")
async def api_delete_org_users_invites(
    request: Request,
    org_id: int,
    email: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Delete org users invites
    """
    return await remove_invited_user(request, org_id, email, db_session, current_user)


@router.get("/slug/{org_slug}")
async def api_get_org_by_slug(
    request: Request,
    org_slug: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> OrganizationRead:
    """
    Get single Org by Slug
    """
    return await get_organization_by_slug(request, org_slug, db_session, current_user)


@router.put("/{org_id}/logo")
async def api_update_org_logo(
    request: Request,
    org_id: str,
    logo_file: UploadFile,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Update org logo
    """
    return await update_org_logo(
        request=request,
        logo_file=logo_file,
        org_id=org_id,
        current_user=current_user,
        db_session=db_session,
    )


@router.put("/{org_id}/thumbnail")
async def api_update_org_thumbnail(
    request: Request,
    org_id: str,
    thumbnail_file: UploadFile,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Update org thumbnail
    """
    return await update_org_thumbnail(
        request=request,
        thumbnail_file=thumbnail_file,
        org_id=org_id,
        current_user=current_user,
        db_session=db_session,
    )

@router.put("/{org_id}/preview")
async def api_update_org_preview(
    request: Request,
    org_id: str,
    preview_file: UploadFile,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Update org thumbnail
    """
    return await update_org_preview(
        request=request,
        preview_file=preview_file,
        org_id=org_id,
        current_user=current_user,
        db_session=db_session,
    )


@router.get("/user/page/{page}/limit/{limit}")
async def api_user_orgs(
    request: Request,
    page: int,
    limit: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> List[OrganizationRead]:
    """
    Get orgs by page and limit by current user
    """
    return await get_orgs_by_user(
        request, db_session, str(current_user.id), page, limit
    )


@router.get("/user_admin/page/{page}/limit/{limit}")
async def api_user_orgs_admin(
    request: Request,
    page: int,
    limit: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> List[OrganizationRead]:
    """
    Get orgs by page and limit by current user
    """
    return await get_orgs_by_user_admin(
        request, db_session, str(current_user.id), page, limit
    )


@router.put("/{org_id}")
async def api_update_org(
    request: Request,
    org_object: OrganizationUpdate,
    org_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> OrganizationRead:
    """
    Update Org by ID
    """
    return await update_org(request, org_object, org_id, current_user, db_session)


@router.delete("/{org_id}")
async def api_delete_org(
    request: Request,
    org_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Delete Org by ID
    """

    return await delete_org(request, org_id, current_user, db_session)


@router.put("/{org_id}/landing")
async def api_update_org_landing(
    request: Request,
    org_id: int,
    landing_object: dict,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Update organization landing object
    """
    return await update_org_landing(request, landing_object, org_id, current_user, db_session)


@router.post("/{org_id}/landing/content")
async def api_upload_org_landing_content(
    request: Request,
    org_id: int,
    content_file: UploadFile,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Upload content for organization landing page
    """
    return await upload_org_landing_content_service(
        request=request,
        content_file=content_file,
        org_id=org_id,
        current_user=current_user,
        db_session=db_session,
    )



================================================
FILE: apps/api/src/routers/roles.py
================================================
from fastapi import APIRouter, Depends, Request, HTTPException
from sqlmodel import Session
from src.core.events.database import get_db_session
from src.db.roles import RoleCreate, RoleRead, RoleUpdate
from src.security.auth import get_current_user
from src.services.roles.roles import create_role, delete_role, read_role, update_role, get_roles_by_organization
from src.db.users import PublicUser
from typing import List


router = APIRouter()


@router.post("/org/{org_id}")
async def api_create_role(
    request: Request,
    org_id: int,
    role_object: RoleCreate,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
)-> RoleRead:
    """
    Create new role for a specific organization
    """
    # Set the org_id in the role object
    role_object.org_id = org_id
    return await create_role(request, db_session, role_object, current_user)


@router.get("/org/{org_id}")
async def api_get_roles_by_organization(
    request: Request,
    org_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
)-> List[RoleRead]:
    """
    Get all roles for a specific organization, including global roles
    """
    return await get_roles_by_organization(request, db_session, org_id, current_user)


@router.get("/{role_id}")
async def api_get_role(
    request: Request,
    role_id: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
)-> RoleRead:
    """
    Get single role by role_id
    """
    return await read_role(request, db_session, role_id, current_user)


@router.put("/{role_id}")
async def api_update_role(
    request: Request,
    role_id: str,
    role_object: RoleUpdate,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
)-> RoleRead:
    """
    Update role by role_id
    """
    # Convert role_id to integer and set it in the role_object
    try:
        role_id_int = int(role_id)
    except ValueError:
        raise HTTPException(
            status_code=400,
            detail="Invalid role ID format. Role ID must be a number.",
        )
    
    role_object.role_id = role_id_int
    return await update_role(request, db_session, role_object, current_user)


@router.delete("/{role_id}")
async def api_delete_role(
    request: Request,
    role_id: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Delete role by ID
    """

    return await delete_role(request, db_session, role_id, current_user)



================================================
FILE: apps/api/src/routers/search.py
================================================
from fastapi import APIRouter, Depends, Request
from sqlmodel import Session
from src.core.events.database import get_db_session
from src.db.users import PublicUser
from src.security.auth import get_current_user
from src.services.search.search import search_across_org, SearchResult

router = APIRouter()

@router.get("/org_slug/{org_slug}", response_model=SearchResult)
async def api_search_across_org(
    request: Request,
    org_slug: str,
    query: str,
    page: int = 1,
    limit: int = 10,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
) -> SearchResult:
    """
    Search across courses, collections and users within an organization
    """
    return await search_across_org(
        request=request,
        current_user=current_user,
        org_slug=org_slug,
        search_query=query,
        db_session=db_session,
        page=page,
        limit=limit
    ) 


================================================
FILE: apps/api/src/routers/trail.py
================================================
from fastapi import APIRouter, Depends, Request
from src.core.events.database import get_db_session
from src.db.trails import TrailCreate, TrailRead
from src.security.auth import get_current_user
from src.services.trail.trail import (
    Trail,
    add_activity_to_trail,
    add_course_to_trail,
    create_user_trail,
    get_user_trails,
    get_user_trail_with_orgid,
    remove_course_from_trail,
    remove_activity_from_trail,
)


router = APIRouter()


@router.post("/start")
async def api_start_trail(
    request: Request,
    trail_object: TrailCreate,
    user=Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> Trail:
    """
    Start trail
    """
    return await create_user_trail(request, user, trail_object, db_session)


@router.get("/")
async def api_get_user_trail(
    request: Request,
    user=Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> TrailRead:
    """
    Get a user trails
    """
    return await get_user_trails(request, user=user, db_session=db_session)


@router.get("/org/{org_id}/trail")
async def api_get_trail_by_org_id(
    request: Request,
    org_id: int,
    user=Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> TrailRead:
    """
    Get a user trails using org slug
    """
    return await get_user_trail_with_orgid(
        request, user, org_id=org_id, db_session=db_session
    )


@router.post("/add_course/{course_uuid}")
async def api_add_course_to_trail(
    request: Request,
    course_uuid: str,
    user=Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> TrailRead:
    """
    Add Course to trail
    """
    return await add_course_to_trail(request, user, course_uuid, db_session)


@router.delete("/remove_course/{course_uuid}")
async def api_remove_course_to_trail(
    request: Request,
    course_uuid: str,
    user=Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> TrailRead:
    """
    Remove Course from trail
    """
    return await remove_course_from_trail(request, user, course_uuid, db_session)


@router.post("/add_activity/{activity_uuid}")
async def api_add_activity_to_trail(
    request: Request,
    activity_uuid: str,
    user=Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> TrailRead:
    """
    Add Course to trail
    """
    return await add_activity_to_trail(
        request, user, activity_uuid, db_session
    )


@router.delete("/remove_activity/{activity_uuid}")
async def api_remove_activity_from_trail(
    request: Request,
    activity_uuid: str,
    user=Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> TrailRead:
    """
    Remove Activity from trail
    """
    return await remove_activity_from_trail(request, user, activity_uuid, db_session)



================================================
FILE: apps/api/src/routers/usergroups.py
================================================
from fastapi import APIRouter, Depends, Request
from sqlmodel import Session
from src.db.usergroups import UserGroupCreate, UserGroupRead, UserGroupUpdate
from src.db.users import PublicUser, UserRead
from src.services.users.usergroups import (
    add_resources_to_usergroup,
    add_users_to_usergroup,
    create_usergroup,
    delete_usergroup_by_id,
    get_usergroups_by_resource,
    get_users_linked_to_usergroup,
    read_usergroup_by_id,
    read_usergroups_by_org_id,
    remove_resources_from_usergroup,
    remove_users_from_usergroup,
    update_usergroup_by_id,
)
from src.security.auth import get_current_user
from src.core.events.database import get_db_session


router = APIRouter()


@router.post("/", response_model=UserGroupRead, tags=["usergroups"])
async def api_create_usergroup(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    usergroup_object: UserGroupCreate,
) -> UserGroupRead:
    """
    Create User
    """
    return await create_usergroup(request, db_session, current_user, usergroup_object)


@router.get("/{usergroup_id}", response_model=UserGroupRead, tags=["usergroups"])
async def api_get_usergroup(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    usergroup_id: int,
) -> UserGroupRead:
    """
    Get UserGroup
    """
    return await read_usergroup_by_id(request, db_session, current_user, usergroup_id)


@router.get("/{usergroup_id}/users", response_model=list[UserRead], tags=["usergroups"])
async def api_get_users_linked_to_usergroup(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    usergroup_id: int,
) -> list[UserRead]:
    """
    Get Users linked to UserGroup
    """
    return await get_users_linked_to_usergroup(
        request, db_session, current_user, usergroup_id
    )


@router.get("/org/{org_id}", response_model=list[UserGroupRead], tags=["usergroups"])
async def api_get_usergroups(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    org_id: int,
) -> list[UserGroupRead]:
    """
    Get UserGroups by Org
    """
    return await read_usergroups_by_org_id(request, db_session, current_user, org_id)


@router.get(
    "/resource/{resource_uuid}", response_model=list[UserGroupRead], tags=["usergroups"]
)
async def api_get_usergroupsby_resource(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    resource_uuid: str,
) -> list[UserGroupRead]:
    """
    Get UserGroups by Org
    """
    return await get_usergroups_by_resource(
        request, db_session, current_user, resource_uuid
    )


@router.put("/{usergroup_id}", response_model=UserGroupRead, tags=["usergroups"])
async def api_update_usergroup(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    usergroup_id: int,
    usergroup_object: UserGroupUpdate,
) -> UserGroupRead:
    """
    Update UserGroup
    """
    return await update_usergroup_by_id(
        request, db_session, current_user, usergroup_id, usergroup_object
    )


@router.delete("/{usergroup_id}", tags=["usergroups"])
async def api_delete_usergroup(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    usergroup_id: int,
) -> str:
    """
    Delete UserGroup
    """
    return await delete_usergroup_by_id(request, db_session, current_user, usergroup_id)


@router.post("/{usergroup_id}/add_users", tags=["usergroups"])
async def api_add_users_to_usergroup(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    usergroup_id: int,
    user_ids: str,
) -> str:
    """
    Add Users to UserGroup
    """
    return await add_users_to_usergroup(
        request, db_session, current_user, usergroup_id, user_ids
    )


@router.delete("/{usergroup_id}/remove_users", tags=["usergroups"])
async def api_delete_users_from_usergroup(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    usergroup_id: int,
    user_ids: str,
) -> str:
    """
    Delete Users from UserGroup
    """
    return await remove_users_from_usergroup(
        request, db_session, current_user, usergroup_id, user_ids
    )


@router.post("/{usergroup_id}/add_resources", tags=["usergroups"])
async def api_add_resources_to_usergroup(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    usergroup_id: int,
    resource_uuids: str,
) -> str:
    """
    Add Resources to UserGroup
    """
    return await add_resources_to_usergroup(
        request, db_session, current_user, usergroup_id, resource_uuids
    )


@router.delete("/{usergroup_id}/remove_resources", tags=["usergroups"])
async def api_delete_resources_from_usergroup(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    usergroup_id: int,
    resource_uuids: str,
) -> str:
    """
    Delete Resources from UserGroup
    """
    return await remove_resources_from_usergroup(
        request, db_session, current_user, usergroup_id, resource_uuids
    )



================================================
FILE: apps/api/src/routers/users.py
================================================
from typing import Literal, List
from fastapi import APIRouter, Depends, HTTPException, Request, UploadFile
from pydantic import EmailStr
from sqlmodel import Session
from src.services.users.password_reset import (
    change_password_with_reset_code,
    send_reset_password_code,
)
from src.services.orgs.orgs import get_org_join_mechanism
from src.security.auth import get_current_user
from src.core.events.database import get_db_session
from src.db.courses.courses import CourseRead

from src.db.users import (
    PublicUser,
    User,
    UserCreate,
    UserRead,
    UserSession,
    UserUpdate,
    UserUpdatePassword,
)
from src.services.users.users import (
    authorize_user_action,
    create_user,
    create_user_with_invite,
    create_user_without_org,
    delete_user_by_id,
    get_user_session,
    read_user_by_id,
    read_user_by_uuid,
    read_user_by_username,
    update_user,
    update_user_avatar,
    update_user_password,
)
from src.services.courses.courses import get_user_courses


router = APIRouter()


@router.get("/profile")
async def api_get_current_user(current_user: User = Depends(get_current_user)):
    """
    Get current user
    """
    return current_user.model_dump()


@router.get("/session")
async def api_get_current_user_session(
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
) -> UserSession:
    """
    Get current user
    """
    return await get_user_session(request, db_session, current_user)


@router.get("/authorize/ressource/{ressource_uuid}/action/{action}")
async def api_get_authorization_status(
    request: Request,
    ressource_uuid: str,
    action: Literal["create", "read", "update", "delete"],
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
):
    """
    Get current user authorization status
    """
    return await authorize_user_action(
        request, db_session, current_user, ressource_uuid, action
    )


@router.post("/{org_id}", response_model=UserRead, tags=["users"])
async def api_create_user_with_orgid(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    user_object: UserCreate,
    org_id: int,
) -> UserRead:
    """
    Create User with Org ID
    """

    # TODO(fix) : This is temporary, logic should be moved to service
    if (
        await get_org_join_mechanism(request, org_id, current_user, db_session)
        == "inviteOnly"
    ):
        raise HTTPException(
            status_code=403,
            detail="You need an invite to join this organization",
        )
    else:
        return await create_user(request, db_session, current_user, user_object, org_id)


@router.post("/{org_id}/invite/{invite_code}", response_model=UserRead, tags=["users"])
async def api_create_user_with_orgid_and_invite(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    user_object: UserCreate,
    invite_code: str,
    org_id: int,
) -> UserRead:
    """
    Create User with Org ID and invite code
    """

    # TODO: This is temporary, logic should be moved to service
    if (
        await get_org_join_mechanism(request, org_id, current_user, db_session)
        == "inviteOnly"
    ):
        return await create_user_with_invite(
            request, db_session, current_user, user_object, org_id, invite_code
        )
    else:
        raise HTTPException(
            status_code=403,
            detail="This organization does not require an invite code",
        )


@router.post("/", response_model=UserRead, tags=["users"])
async def api_create_user_without_org(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    user_object: UserCreate,
) -> UserRead:
    """
    Create User
    """
    return await create_user_without_org(request, db_session, current_user, user_object)


@router.get("/id/{user_id}", response_model=UserRead, tags=["users"])
async def api_get_user_by_id(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    user_id: int,
) -> UserRead:
    """
    Get User by ID
    """
    return await read_user_by_id(request, db_session, current_user, user_id)


@router.get("/uuid/{user_uuid}", response_model=UserRead, tags=["users"])
async def api_get_user_by_uuid(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    user_uuid: str,
) -> UserRead:
    """
    Get User by UUID
    """
    return await read_user_by_uuid(request, db_session, current_user, user_uuid)


@router.get("/username/{username}", response_model=UserRead, tags=["users"])
async def api_get_user_by_username(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    username: str,
) -> UserRead:
    """
    Get User by Username
    """
    return await read_user_by_username(request, db_session, current_user, username)


@router.put("/{user_id}", response_model=UserRead, tags=["users"])
async def api_update_user(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    user_id: int,
    user_object: UserUpdate,
) -> UserRead:
    """
    Update User
    """
    return await update_user(request, db_session, user_id, current_user, user_object)


@router.put("/update_avatar/{user_id}", response_model=UserRead, tags=["users"])
async def api_update_avatar_user(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    avatar_file: UploadFile | None = None,
) -> UserRead:
    """
    Update User
    """
    return await update_user_avatar(request, db_session, current_user, avatar_file)


@router.put("/change_password/{user_id}", response_model=UserRead, tags=["users"])
async def api_update_user_password(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    user_id: int,
    form: UserUpdatePassword,
) -> UserRead:
    """
    Update User Password
    """
    return await update_user_password(request, db_session, current_user, user_id, form)


@router.post("/reset_password/change_password/{email}", tags=["users"])
async def api_change_password_with_reset_code(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    new_password: str,
    email: EmailStr,
    org_id: int,
    reset_code: str,
):
    """
    Update User Password with reset code
    """
    return await change_password_with_reset_code(
        request, db_session, current_user, new_password, org_id, email, reset_code
    )


@router.post("/reset_password/send_reset_code/{email}", tags=["users"])
async def api_send_password_reset_email(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    email: EmailStr,
    org_id: int,
):
    """
    Update User Password
    """
    return await send_reset_password_code(
        request, db_session, current_user, org_id, email
    )


@router.delete("/user_id/{user_id}", tags=["users"])
async def api_delete_user(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    user_id: int,
):
    """
    Delete User
    """
    return await delete_user_by_id(request, db_session, current_user, user_id)


@router.get("/{user_id}/courses", response_model=List[CourseRead], tags=["users"])
async def api_get_user_courses(
    *,
    request: Request,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
    user_id: int,
    page: int = 1,
    limit: int = 10,
) -> List[CourseRead]:
    """
    Get courses made or contributed by a user.
    """
    return await get_user_courses(
        request=request,
        current_user=current_user,
        user_id=user_id,
        db_session=db_session,
        page=page,
        limit=limit,
    )



================================================
FILE: apps/api/src/routers/utils.py
================================================
from fastapi import APIRouter, HTTPException, Query
from src.services.utils.link_preview import fetch_link_preview

router = APIRouter()

@router.get("/link-preview")
async def link_preview(url: str = Query(..., description="URL to preview")):
    try:
        data = await fetch_link_preview(url)
        return data
    except Exception as e:
        raise HTTPException(status_code=400, detail=f"Failed to fetch link preview: {str(e)}") 


================================================
FILE: apps/api/src/routers/ai/ai.py
================================================
from fastapi import APIRouter, Depends, Request
from sqlmodel import Session
from src.services.ai.ai import ai_send_activity_chat_message, ai_start_activity_chat_session
from src.services.ai.schemas.ai import ActivityAIChatSessionResponse, SendActivityAIChatMessage, StartActivityAIChatSession
from src.core.events.database import get_db_session
from src.db.users import PublicUser
from src.security.auth import get_current_user


router = APIRouter()


@router.post("/start/activity_chat_session")
async def api_ai_start_activity_chat_session(
    request: Request,
    chat_session_object: StartActivityAIChatSession,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
)-> ActivityAIChatSessionResponse:
    """
    Start a new AI Chat session with a Course Activity
    """
    return ai_start_activity_chat_session(
        request, chat_session_object, current_user, db_session
    )

@router.post("/send/activity_chat_message")
async def api_ai_send_activity_chat_message(
    request: Request,
    chat_session_object: SendActivityAIChatMessage,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
)-> ActivityAIChatSessionResponse:
    """
    Send a message to an AI Chat session with a Course Activity
    """
    return ai_send_activity_chat_message(
        request, chat_session_object, current_user, db_session
    )


================================================
FILE: apps/api/src/routers/courses/assignments.py
================================================
from fastapi import APIRouter, Depends, Request, UploadFile, HTTPException
from src.db.courses.assignments import (
    AssignmentCreate,
    AssignmentRead,
    AssignmentTaskCreate,
    AssignmentTaskSubmissionUpdate,
    AssignmentTaskUpdate,
    AssignmentUpdate,
    AssignmentUserSubmissionCreate,
)
from src.db.users import PublicUser
from src.core.events.database import get_db_session
from src.security.auth import get_current_user
from src.services.courses.activities.assignments import (
    create_assignment,
    create_assignment_submission,
    create_assignment_task,
    delete_assignment,
    delete_assignment_from_activity_uuid,
    delete_assignment_submission,
    delete_assignment_task,
    delete_assignment_task_submission,
    get_assignments_from_course,
    get_grade_assignment_submission,
    grade_assignment_submission,
    handle_assignment_task_submission,
    mark_activity_as_done_for_user,
    put_assignment_task_reference_file,
    put_assignment_task_submission_file,
    read_assignment,
    read_assignment_from_activity_uuid,
    read_assignment_submissions,
    read_assignment_task,
    read_assignment_task_submissions,
    read_assignment_tasks,
    read_user_assignment_submissions,
    read_user_assignment_submissions_me,
    read_user_assignment_task_submissions,
    read_user_assignment_task_submissions_me,
    update_assignment,
    update_assignment_submission,
    update_assignment_task,
)

router = APIRouter()

## ASSIGNMENTS ##


@router.post("/")
async def api_create_assignments(
    request: Request,
    assignment_object: AssignmentCreate,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> AssignmentRead:
    """
    Create new activity
    """
    return await create_assignment(request, assignment_object, current_user, db_session)


@router.get("/{assignment_uuid}")
async def api_read_assignment(
    request: Request,
    assignment_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> AssignmentRead:
    """
    Read an assignment
    """
    return await read_assignment(request, assignment_uuid, current_user, db_session)


@router.get("/activity/{activity_uuid}")
async def api_read_assignment_from_activity(
    request: Request,
    activity_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> AssignmentRead:
    """
    Read an assignment
    """
    return await read_assignment_from_activity_uuid(
        request, activity_uuid, current_user, db_session
    )


@router.put("/{assignment_uuid}")
async def api_update_assignment(
    request: Request,
    assignment_uuid: str,
    assignment_object: AssignmentUpdate,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> AssignmentRead:
    """
    Update an assignment
    """
    return await update_assignment(
        request, assignment_uuid, assignment_object, current_user, db_session
    )


@router.delete("/{assignment_uuid}")
async def api_delete_assignment(
    request: Request,
    assignment_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Delete an assignment
    """
    return await delete_assignment(request, assignment_uuid, current_user, db_session)


@router.delete("/activity/{activity_uuid}")
async def api_delete_assignment_from_activity(
    request: Request,
    activity_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Delete an assignment
    """
    return await delete_assignment_from_activity_uuid(
        request, activity_uuid, current_user, db_session
    )


## ASSIGNMENTS Tasks ##


@router.post("/{assignment_uuid}/tasks")
async def api_create_assignment_tasks(
    request: Request,
    assignment_uuid: str,
    assignment_task_object: AssignmentTaskCreate,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Create new tasks for an assignment
    """
    return await create_assignment_task(
        request, assignment_uuid, assignment_task_object, current_user, db_session
    )


@router.get("/{assignment_uuid}/tasks")
async def api_read_assignment_tasks(
    request: Request,
    assignment_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Read tasks for an assignment
    """
    return await read_assignment_tasks(
        request, assignment_uuid, current_user, db_session
    )


@router.get("/task/{assignment_task_uuid}")
async def api_read_assignment_task(
    request: Request,
    assignment_task_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Read task for an assignment
    """
    return await read_assignment_task(
        request, assignment_task_uuid, current_user, db_session
    )


@router.put("/{assignment_uuid}/tasks/{assignment_task_uuid}")
async def api_update_assignment_tasks(
    request: Request,
    assignment_task_uuid: str,
    assignment_task_object: AssignmentTaskUpdate,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Update tasks for an assignment
    """
    return await update_assignment_task(
        request, assignment_task_uuid, assignment_task_object, current_user, db_session
    )


@router.post("/{assignment_uuid}/tasks/{assignment_task_uuid}/ref_file")
async def api_put_assignment_task_ref_file(
    request: Request,
    assignment_task_uuid: str,
    reference_file: UploadFile | None = None,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Update tasks for an assignment
    """
    return await put_assignment_task_reference_file(
        request, db_session, assignment_task_uuid, current_user, reference_file
    )


@router.post("/{assignment_uuid}/tasks/{assignment_task_uuid}/sub_file")
async def api_put_assignment_task_sub_file(
    request: Request,
    assignment_task_uuid: str,
    sub_file: UploadFile | None = None,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Update tasks for an assignment
    """
    return await put_assignment_task_submission_file(
        request, db_session, assignment_task_uuid, current_user, sub_file
    )


@router.delete("/{assignment_uuid}/tasks/{assignment_task_uuid}")
async def api_delete_assignment_tasks(
    request: Request,
    assignment_task_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Delete tasks for an assignment
    """
    return await delete_assignment_task(
        request, assignment_task_uuid, current_user, db_session
    )


## ASSIGNMENTS Tasks Submissions ##


@router.put("/{assignment_uuid}/tasks/{assignment_task_uuid}/submissions")
async def api_handle_assignment_task_submissions(
    request: Request,
    assignment_task_submission_object: AssignmentTaskSubmissionUpdate,
    assignment_task_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Create new task submissions for an assignment
    """
    return await handle_assignment_task_submission(
        request,
        assignment_task_uuid,
        assignment_task_submission_object,
        current_user,
        db_session,
    )


@router.get(
    "/{assignment_uuid}/tasks/{assignment_task_uuid}/submissions/user/{user_id}"
)
async def api_read_user_assignment_task_submissions(
    request: Request,
    assignment_task_uuid: str,
    user_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Read task submissions for an assignment from a user
    """
    return await read_user_assignment_task_submissions(
        request, assignment_task_uuid, user_id, current_user, db_session
    )


@router.get("/{assignment_uuid}/tasks/{assignment_task_uuid}/submissions/me")
async def api_read_user_assignment_task_submissions_me(
    request: Request,
    assignment_task_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Read task submissions for an assignment from a user
    """
    result = await read_user_assignment_task_submissions_me(
        request, assignment_task_uuid, current_user, db_session
    )
    if result is None:
        # Return 404 if no submission exists (maintains current frontend behavior)
        raise HTTPException(
            status_code=404,
            detail="Assignment Task Submission not found",
        )
    return result


@router.get("/{assignment_uuid}/tasks/{assignment_task_uuid}/submissions")
async def api_read_assignment_task_submissions(
    request: Request,
    assignment_task_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Read task submissions for an assignment from a user
    """
    return await read_assignment_task_submissions(
        request, assignment_task_uuid, current_user, db_session
    )


@router.delete(
    "/{assignment_uuid}/tasks/{assignment_task_uuid}/submissions/{assignment_task_submission_uuid}"
)
async def api_delete_assignment_task_submissions(
    request: Request,
    assignment_task_submission_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Delete task submissions for an assignment from a user
    """
    return await delete_assignment_task_submission(
        request, assignment_task_submission_uuid, current_user, db_session
    )


## ASSIGNMENTS Submissions ##


@router.post("/{assignment_uuid}/submissions")
async def api_create_assignment_submissions(
    request: Request,
    assignment_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Create new submissions for an assignment
    """
    return await create_assignment_submission(
        request, assignment_uuid, current_user, db_session
    )


@router.get("/{assignment_uuid}/submissions")
async def api_read_assignment_submissions(
    request: Request,
    assignment_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Read submissions for an assignment
    """
    return await read_assignment_submissions(
        request, assignment_uuid, current_user, db_session
    )


@router.get("/{assignment_uuid}/submissions/me")
async def api_read_user_assignment_submission_me(
    request: Request,
    assignment_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Read submissions for an assignment from the current user
    """
    return await read_user_assignment_submissions_me(
        request, assignment_uuid, current_user, db_session
    )


@router.get("/{assignment_uuid}/submissions/{user_id}")
async def api_read_user_assignment_submissions(
    request: Request,
    assignment_uuid: str,
    user_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Read submissions for an assignment from a user
    """
    return await read_user_assignment_submissions(
        request, assignment_uuid, user_id, current_user, db_session
    )


@router.put("/{assignment_uuid}/submissions/{user_id}")
async def api_update_user_assignment_submissions(
    request: Request,
    assignment_uuid: str,
    user_id: str,
    assignment_submission: AssignmentUserSubmissionCreate,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Update submissions for an assignment from a user
    """
    return await update_assignment_submission(
        request, user_id, assignment_submission, current_user, db_session
    )


@router.delete("/{assignment_uuid}/submissions/{user_id}")
async def api_delete_user_assignment_submissions(
    request: Request,
    assignment_uuid: str,
    user_id: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Delete submissions for an assignment from a user
    """
    return await delete_assignment_submission(
        request, user_id, assignment_uuid, current_user, db_session
    )


@router.get("/{assignment_uuid}/submissions/{user_id}/grade")
async def api_get_submission_grade(
    request: Request,
    assignment_uuid: str,
    user_id: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Grade submissions for an assignment from a user
    """

    return await get_grade_assignment_submission(
        request, user_id, assignment_uuid, current_user, db_session
    )


@router.post("/{assignment_uuid}/submissions/{user_id}/grade")
async def api_final_grade_submission(
    request: Request,
    assignment_uuid: str,
    user_id: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Grade submissions for an assignment from a user
    """

    return await grade_assignment_submission(
        request, user_id, assignment_uuid, current_user, db_session
    )


@router.post("/{assignment_uuid}/submissions/{user_id}/done")
async def api_submission_mark_as_done(
    request: Request,
    assignment_uuid: str,
    user_id: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Grade submissions for an assignment from a user
    """

    return await mark_activity_as_done_for_user(
        request, user_id, assignment_uuid, current_user, db_session
    )


@router.get("/course/{course_uuid}")
async def api_get_assignments(
    request: Request,
    course_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Get assignments for a course
    """
    return await get_assignments_from_course(
        request, course_uuid, current_user, db_session
    )



================================================
FILE: apps/api/src/routers/courses/certifications.py
================================================
from typing import List
from fastapi import APIRouter, Depends, Request
from sqlmodel import Session
from src.core.events.database import get_db_session
from src.db.courses.certifications import (
    CertificationCreate,
    CertificationRead,
    CertificationUpdate,
)
from src.db.users import PublicUser
from src.security.auth import get_current_user
from src.services.courses.certifications import (
    create_certification,
    get_certification,
    get_certifications_by_course,
    update_certification,
    delete_certification,
    get_user_certificates_for_course,
    get_certificate_by_user_certification_uuid,
    get_all_user_certificates,
)

router = APIRouter()


@router.post("/")
async def api_create_certification(
    request: Request,
    certification_object: CertificationCreate,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> CertificationRead:
    """
    Create new certification for a course
    """
    return await create_certification(
        request, certification_object, current_user, db_session
    )


@router.get("/{certification_uuid}")
async def api_get_certification(
    request: Request,
    certification_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> CertificationRead:
    """
    Get single certification by certification_id
    """
    return await get_certification(
        request, certification_uuid, current_user, db_session
    )


@router.get("/course/{course_uuid}")
async def api_get_certifications_by_course(
    request: Request,
    course_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> List[CertificationRead]:
    """
    Get all certifications for a specific course
    """
    return await get_certifications_by_course(
        request, course_uuid, current_user, db_session
    )


@router.put("/{certification_uuid}")
async def api_update_certification(
    request: Request,
    certification_uuid: str,
    certification_object: CertificationUpdate,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> CertificationRead:
    """
    Update certification by certification_id
    """
    return await update_certification(
        request, certification_uuid, certification_object, current_user, db_session
    )


@router.delete("/{certification_uuid}")
async def api_delete_certification(
    request: Request,
    certification_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Delete certification by certification_id
    """
    return await delete_certification(
        request, certification_uuid, current_user, db_session
    )


@router.get("/user/course/{course_uuid}")
async def api_get_user_certificates_for_course(
    request: Request,
    course_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> List[dict]:
    """
    Get all certificates for the current user in a specific course with certification details
    """
    return await get_user_certificates_for_course(
        request, course_uuid, current_user, db_session
    )


@router.get("/certificate/{user_certification_uuid}")
async def api_get_certificate_by_user_certification_uuid(
    request: Request,
    user_certification_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> dict:
    """
    Get a certificate by user_certification_uuid with certification and course details
    """
    return await get_certificate_by_user_certification_uuid(
        request, user_certification_uuid, current_user, db_session
    )


@router.get("/user/all")
async def api_get_all_user_certificates(
    request: Request,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> List[dict]:
    """
    Get all certificates obtained by the current user with complete linked information
    """
    return await get_all_user_certificates(
        request, current_user, db_session
    ) 


================================================
FILE: apps/api/src/routers/courses/chapters.py
================================================
from typing import List
from fastapi import APIRouter, Depends, Request
from src.core.events.database import get_db_session
from src.db.courses.chapters import (
    ChapterCreate,
    ChapterRead,
    ChapterUpdate,
    ChapterUpdateOrder,
)
from src.services.courses.chapters import (
    DEPRECEATED_get_course_chapters,
    create_chapter,
    delete_chapter,
    get_chapter,
    get_course_chapters,
    reorder_chapters_and_activities,
    update_chapter,
)

from src.services.users.users import PublicUser
from src.security.auth import get_current_user

router = APIRouter()


@router.post("/")
async def api_create_coursechapter(
    request: Request,
    coursechapter_object: ChapterCreate,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> ChapterRead:
    """
    Create new Course Chapter
    """
    return await create_chapter(request, coursechapter_object, current_user, db_session)


@router.get("/{chapter_id}")
async def api_get_coursechapter(
    request: Request,
    chapter_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> ChapterRead:
    """
    Get single CourseChapter by chapter_id
    """
    return await get_chapter(request, chapter_id, current_user, db_session)


@router.get("/course/{course_uuid}/meta", deprecated=True)
async def api_get_chapter_meta(
    request: Request,
    course_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Get Chapters metadata
    """
    return await DEPRECEATED_get_course_chapters(
        request, course_uuid, current_user, db_session
    )


@router.put("/course/{course_uuid}/order")
async def api_update_chapter_meta(
    request: Request,
    course_uuid: str,
    order: ChapterUpdateOrder,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Update Chapter metadata
    """
    return await reorder_chapters_and_activities(
        request, course_uuid, order, current_user, db_session
    )


@router.get("/course/{course_id}/page/{page}/limit/{limit}")
async def api_get_chapter_by(
    request: Request,
    course_id: int,
    page: int,
    limit: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> List[ChapterRead]:
    """
    Get Course Chapters by page and limit
    """
    return await get_course_chapters(
        request, course_id, db_session, current_user, page, limit
    )


@router.put("/{chapter_id}")
async def api_update_coursechapter(
    request: Request,
    coursechapter_object: ChapterUpdate,
    chapter_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> ChapterRead:
    """
    Update CourseChapters by course_id
    """
    return await update_chapter(
        request, coursechapter_object, chapter_id, current_user, db_session
    )


@router.delete("/{chapter_id}")
async def api_delete_coursechapter(
    request: Request,
    chapter_id: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Delete CourseChapters by ID
    """

    return await delete_chapter(request, chapter_id, current_user, db_session)



================================================
FILE: apps/api/src/routers/courses/collections.py
================================================
from typing import List
from fastapi import APIRouter, Depends, Request
from src.core.events.database import get_db_session
from src.db.collections import CollectionCreate, CollectionRead, CollectionUpdate
from src.security.auth import get_current_user
from src.services.users.users import PublicUser
from src.services.courses.collections import (
    create_collection,
    get_collection,
    get_collections,
    update_collection,
    delete_collection,
)


router = APIRouter()


@router.post("/")
async def api_create_collection(
    request: Request,
    collection_object: CollectionCreate,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> CollectionRead:
    """
    Create new Collection
    """
    return await create_collection(request, collection_object, current_user, db_session)


@router.get("/{collection_uuid}")
async def api_get_collection(
    request: Request,
    collection_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> CollectionRead:
    """
    Get single collection by ID
    """
    return await get_collection(request, collection_uuid, current_user, db_session)


@router.get("/org/{org_id}/page/{page}/limit/{limit}")
async def api_get_collections_by(
    request: Request,
    page: int,
    limit: int,
    org_id: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> List[CollectionRead]:
    """
    Get collections by page and limit
    """
    return await get_collections(request, org_id, current_user, db_session, page, limit)


@router.put("/{collection_uuid}")
async def api_update_collection(
    request: Request,
    collection_object: CollectionUpdate,
    collection_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> CollectionRead:
    """
    Update collection by ID
    """
    return await update_collection(
        request, collection_object, collection_uuid, current_user, db_session
    )


@router.delete("/{collection_uuid}")
async def api_delete_collection(
    request: Request,
    collection_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Delete collection by ID
    """

    return await delete_collection(request, collection_uuid, current_user, db_session)



================================================
FILE: apps/api/src/routers/courses/courses.py
================================================
from typing import List
from fastapi import APIRouter, Depends, UploadFile, Form, Request
from sqlmodel import Session
from src.core.events.database import get_db_session
from src.db.courses.course_updates import (
    CourseUpdateCreate,
    CourseUpdateRead,
    CourseUpdateUpdate,
)
from src.db.users import PublicUser
from src.db.courses.courses import (
    CourseCreate,
    CourseRead,
    CourseUpdate,
    FullCourseRead,
    ThumbnailType,
)
from src.security.auth import get_current_user
from src.services.courses.courses import (
    create_course,
    get_course,
    get_course_by_id,
    get_course_meta,
    get_courses_orgslug,
    update_course,
    delete_course,
    update_course_thumbnail,
    search_courses,
    get_course_user_rights,
)
from src.services.courses.updates import (
    create_update,
    delete_update,
    get_updates_by_course_uuid,
    update_update,
)
from src.services.courses.contributors import (
    apply_course_contributor,
    update_course_contributor,
    get_course_contributors,
    add_bulk_course_contributors,
    remove_bulk_course_contributors,
)
from src.db.resource_authors import ResourceAuthorshipEnum, ResourceAuthorshipStatusEnum


router = APIRouter()


@router.post("/")
async def api_create_course(
    request: Request,
    org_id: int,
    name: str = Form(),
    description: str = Form(),
    public: bool = Form(),
    learnings: str = Form(None),
    tags: str = Form(None),
    about: str = Form(),
    thumbnail_type: ThumbnailType = Form(default=ThumbnailType.IMAGE),
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
    thumbnail: UploadFile | None = None,
) -> CourseRead:
    """
    Create new Course
    """
    course = CourseCreate(
        name=name,
        description=description,
        org_id=org_id,
        public=public,
        thumbnail_type=thumbnail_type,
        thumbnail_image="",
        thumbnail_video="",
        about=about,
        learnings=learnings,
        tags=tags,
        open_to_contributors=False,
    )
    return await create_course(
        request, org_id, course, current_user, db_session, thumbnail, thumbnail_type
    )


@router.put("/{course_uuid}/thumbnail")
async def api_create_course_thumbnail(
    request: Request,
    course_uuid: str,
    thumbnail_type: ThumbnailType = Form(default=ThumbnailType.IMAGE),
    thumbnail: UploadFile | None = None,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
) -> CourseRead:
    """
    Update Course Thumbnail (Image or Video)
    """
    return await update_course_thumbnail(
        request, course_uuid, current_user, db_session, thumbnail, thumbnail_type
    )


@router.get("/{course_uuid}")
async def api_get_course(
    request: Request,
    course_uuid: str,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
) -> CourseRead:
    """
    Get single Course by course_uuid
    """
    return await get_course(
        request, course_uuid, current_user=current_user, db_session=db_session
    )


@router.get("/id/{course_id}")
async def api_get_course_by_id(
    request: Request,
    course_id: str,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
) -> CourseRead:
    """
    Get single Course by id
    """
    return await get_course_by_id(
        request, course_id, current_user=current_user, db_session=db_session
    )


@router.get("/{course_uuid}/meta")
async def api_get_course_meta(
    request: Request,
    course_uuid: str,
    with_unpublished_activities: bool = False,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
) -> FullCourseRead:
    """
    Get single Course Metadata (chapters, activities) by course_uuid
    """
    return await get_course_meta(
        request, course_uuid, with_unpublished_activities, current_user=current_user, db_session=db_session
    )


@router.get("/org_slug/{org_slug}/page/{page}/limit/{limit}")
async def api_get_course_by_orgslug(
    request: Request,
    page: int,
    limit: int,
    org_slug: str,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
) -> List[CourseRead]:
    """
    Get courses by page and limit
    """
    return await get_courses_orgslug(
        request, current_user, org_slug, db_session, page, limit
    )


@router.get("/org_slug/{org_slug}/search")
async def api_search_courses(
    request: Request,
    org_slug: str,
    query: str,
    page: int = 1,
    limit: int = 10,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
) -> List[CourseRead]:
    """
    Search courses by title and description
    """
    return await search_courses(
        request, current_user, org_slug, query, db_session, page, limit
    )


@router.put("/{course_uuid}")
async def api_update_course(
    request: Request,
    course_object: CourseUpdate,
    course_uuid: str,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
) -> CourseRead:
    """
    Update Course by course_uuid
    """
    return await update_course(
        request, course_object, course_uuid, current_user, db_session
    )


@router.delete("/{course_uuid}")
async def api_delete_course(
    request: Request,
    course_uuid: str,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
):
    """
    Delete Course by ID
    """

    return await delete_course(request, course_uuid, current_user, db_session)


@router.post("/{course_uuid}/apply-contributor")
async def api_apply_course_contributor(
    request: Request,
    course_uuid: str,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
):
    """
    Apply to be a contributor for a course
    """
    return await apply_course_contributor(request, course_uuid, current_user, db_session)


@router.get("/{course_uuid}/updates")
async def api_get_course_updates(
    request: Request,
    course_uuid: str,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
) -> List[CourseUpdateRead]:
    """
    Get Course Updates by course_uuid
    """

    return await get_updates_by_course_uuid(
        request, course_uuid, current_user, db_session
    )


@router.post("/{course_uuid}/updates")
async def api_create_course_update(
    request: Request,
    course_uuid: str,
    update_object: CourseUpdateCreate,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
) -> CourseUpdateRead:
    """
    Create new Course Update
    """

    return await create_update(
        request, course_uuid, update_object, current_user, db_session
    )


@router.put("/{course_uuid}/update/{courseupdate_uuid}")
async def api_update_course_update(
    request: Request,
    course_uuid: str,
    courseupdate_uuid: str,
    update_object: CourseUpdateUpdate,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
) -> CourseUpdateRead:
    """
    Update Course Update by courseupdate_uuid
    """

    return await update_update(
        request, courseupdate_uuid, update_object, current_user, db_session
    )


@router.delete("/{course_uuid}/update/{courseupdate_uuid}")
async def api_delete_course_update(
    request: Request,
    course_uuid: str,
    courseupdate_uuid: str,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
):
    """
    Delete Course Update by courseupdate_uuid
    """

    return await delete_update(request, courseupdate_uuid, current_user, db_session)


@router.get("/{course_uuid}/contributors")
async def api_get_course_contributors(
    request: Request,
    course_uuid: str,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
):
    """
    Get all contributors for a course
    """
    return await get_course_contributors(request, course_uuid, current_user, db_session)


@router.put("/{course_uuid}/contributors/{contributor_user_id}")
async def api_update_course_contributor(
    request: Request,
    course_uuid: str,
    contributor_user_id: int,
    authorship: ResourceAuthorshipEnum,
    authorship_status: ResourceAuthorshipStatusEnum,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
):
    """
    Update a course contributor's role and status
    Only administrators can perform this action
    """
    return await update_course_contributor(
        request,
        course_uuid,
        contributor_user_id,
        authorship,
        authorship_status,
        current_user,
        db_session
    )


@router.post("/{course_uuid}/bulk-add-contributors")
async def api_add_bulk_course_contributors(
    request: Request,
    course_uuid: str,
    usernames: List[str],
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
):
    """
    Add multiple contributors to a course by their usernames
    Only administrators can perform this action
    """
    return await add_bulk_course_contributors(
        request,
        course_uuid,
        usernames,
        current_user,
        db_session
    )


@router.put("/{course_uuid}/bulk-remove-contributors")
async def api_remove_bulk_course_contributors(
    request: Request,
    course_uuid: str,
    usernames: List[str],
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
):
    """
    Remove multiple contributors from a course by their usernames
    """
    return await remove_bulk_course_contributors(
        request, course_uuid, usernames, current_user, db_session
    )


@router.get("/{course_uuid}/rights")
async def api_get_course_user_rights(
    request: Request,
    course_uuid: str,
    db_session: Session = Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
) -> dict:
    """
    Get detailed user rights for a specific course.
    
    This endpoint returns comprehensive rights information that can be used
    by the UI to enable/disable features based on user permissions.
    
    
    
    **Response Structure:**
    ```json
    {
        "course_uuid": "course_123",
        "user_id": 456,
        "is_anonymous": false,
        "permissions": {
            "read": true,
            "create": false,
            "update": true,
            "delete": false,
            "create_content": true,
            "update_content": true,
            "delete_content": true,
            "manage_contributors": true,
            "manage_access": true,
            "grade_assignments": true,
            "mark_activities_done": true,
            "create_certifications": true
        },
        "ownership": {
            "is_owner": true,
            "is_creator": true,
            "is_maintainer": false,
            "is_contributor": false,
            "authorship_status": "ACTIVE"
        },
        "roles": {
            "is_admin": false,
            "is_maintainer_role": false,
            "is_instructor": true,
            "is_user": true
        }
    }
    ```
    
    **Permissions Explained:**
    - `read`: Can read the course content
    - `create`: Can create new courses (instructor role or higher)
    - `update`: Can update course settings (title, description, etc.)
    - `delete`: Can delete the course
    - `create_content`: Can create activities, assignments, chapters, etc.
    - `update_content`: Can update course content
    - `delete_content`: Can delete course content
    - `manage_contributors`: Can add/remove contributors
    - `manage_access`: Can change course access settings (public, open_to_contributors)
    - `grade_assignments`: Can grade student assignments
    - `mark_activities_done`: Can mark activities as done for other users
    - `create_certifications`: Can create course certifications
    
    **Ownership Information:**
    - `is_owner`: Is course owner (CREATOR, MAINTAINER, or CONTRIBUTOR)
    - `is_creator`: Is course creator
    - `is_maintainer`: Is course maintainer
    - `is_contributor`: Is course contributor
    - `authorship_status`: Current authorship status (ACTIVE, PENDING, INACTIVE)
    
    **Role Information:**
    - `is_admin`: Has admin role (role 1)
    - `is_maintainer_role`: Has maintainer role (role 2)
    - `is_instructor`: Has instructor role (role 3)
    - `is_user`: Has basic user role (role 4)
    
    **Security Notes:**
    - Returns rights based on course ownership and user roles
    - Safe to expose to UI as it only returns permission information
    - Anonymous users can only read public courses
    - All permissions are calculated based on current user context
    """
    return await get_course_user_rights(request, course_uuid, current_user, db_session)



================================================
FILE: apps/api/src/routers/courses/activities/activities.py
================================================
from typing import List
from fastapi import APIRouter, Depends, UploadFile, Form, Request
from src.db.courses.activities import ActivityCreate, ActivityRead, ActivityUpdate
from src.db.users import PublicUser
from src.core.events.database import get_db_session
from src.services.courses.activities.activities import (
    create_activity,
    get_activity,
    get_activities,
    get_activityby_id,
    update_activity,
    delete_activity,
)
from src.security.auth import get_current_user
from src.services.courses.activities.pdf import create_documentpdf_activity
from src.services.courses.activities.video import (
    ExternalVideo,
    create_external_video_activity,
    create_video_activity,
)

router = APIRouter()


@router.post("/")
async def api_create_activity(
    request: Request,
    activity_object: ActivityCreate,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> ActivityRead:
    """
    Create new activity
    """
    return await create_activity(request, activity_object, current_user, db_session)


@router.get("/{activity_uuid}")
async def api_get_activity(
    request: Request,
    activity_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> ActivityRead:
    """
    Get single activity by activity_id
    """
    return await get_activity(
        request, activity_uuid, current_user=current_user, db_session=db_session
    )

@router.get("/id/{activity_id}")
async def api_get_activityby_id(
    request: Request,
    activity_id: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> ActivityRead:
    """
    Get single activity by activity_id
    """
    return await get_activityby_id(
        request, activity_id, current_user=current_user, db_session=db_session
    )
            
@router.get("/chapter/{chapter_id}")
async def api_get_chapter_activities(
    request: Request,
    chapter_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> List[ActivityRead]:
    """
    Get Activities for a chapter
    """
    return await get_activities(request, chapter_id, current_user, db_session)


@router.put("/{activity_uuid}")
async def api_update_activity(
    request: Request,
    activity_object: ActivityUpdate,
    activity_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> ActivityRead:
    """
    Update activity by activity_id
    """
    return await update_activity(
        request, activity_object, activity_uuid, current_user, db_session
    )


@router.delete("/{activity_uuid}")
async def api_delete_activity(
    request: Request,
    activity_uuid: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
):
    """
    Delete activity by activity_id
    """
    return await delete_activity(request, activity_uuid, current_user, db_session)


# Video activity


@router.post("/video")
async def api_create_video_activity(
    request: Request,
    name: str = Form(),
    chapter_id: str = Form(),
    details: str = Form(default="{}"),
    current_user: PublicUser = Depends(get_current_user),
    video_file: UploadFile | None = None,
    db_session=Depends(get_db_session),
) -> ActivityRead:
    """
    Create new activity
    """
    return await create_video_activity(
        request,
        name,
        chapter_id,
        current_user,
        db_session,
        video_file,
        details,
    )


@router.post("/external_video")
async def api_create_external_video_activity(
    request: Request,
    external_video: ExternalVideo,
    current_user: PublicUser = Depends(get_current_user),
    db_session=Depends(get_db_session),
) -> ActivityRead:
    """
    Create new activity
    """
    return await create_external_video_activity(
        request, current_user, external_video, db_session
    )


@router.post("/documentpdf")
async def api_create_documentpdf_activity(
    request: Request,
    name: str = Form(),
    chapter_id: str = Form(),
    current_user: PublicUser = Depends(get_current_user),
    pdf_file: UploadFile | None = None,
    db_session=Depends(get_db_session),
) -> ActivityRead:
    """
    Create new activity
    """
    return await create_documentpdf_activity(
        request, name, chapter_id, current_user, db_session, pdf_file
    )



================================================
FILE: apps/api/src/routers/courses/activities/blocks.py
================================================
from fastapi import APIRouter, Depends, UploadFile, Form, Request
from src.db.courses.blocks import BlockRead
from src.core.events.database import get_db_session
from src.security.auth import get_current_user
from src.services.blocks.block_types.imageBlock.imageBlock import (
    create_image_block,
    get_image_block,
)
from src.services.blocks.block_types.videoBlock.videoBlock import (
    create_video_block,
    get_video_block,
)
from src.services.blocks.block_types.pdfBlock.pdfBlock import (
    create_pdf_block,
    get_pdf_block,
)

from src.services.users.users import PublicUser

router = APIRouter()

####################
# Image Block
####################


@router.post("/image")
async def api_create_image_file_block(
    request: Request,
    file_object: UploadFile,
    activity_uuid: str = Form(),
    db_session=Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
) -> BlockRead:
    """
    Create new image file
    """
    return await create_image_block(request, file_object, activity_uuid, db_session)


@router.get("/image")
async def api_get_image_file_block(
    request: Request,
    block_uuid: str,
    db_session=Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
) -> BlockRead:
    """
    Get image file
    """
    return await get_image_block(request, block_uuid, current_user, db_session)


####################
# Video Block
####################


@router.post("/video")
async def api_create_video_file_block(
    request: Request,
    file_object: UploadFile,
    activity_uuid: str = Form(),
    db_session=Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
) -> BlockRead:
    """
    Create new video file
    """
    return await create_video_block(request, file_object, activity_uuid, db_session)


@router.get("/video")
async def api_get_video_file_block(
    request: Request,
    block_uuid: str,
    db_session=Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
) -> BlockRead:
    """
    Get video file
    """
    return await get_video_block(request, block_uuid, current_user, db_session)


####################
# PDF Block
####################


@router.post("/pdf")
async def api_create_pdf_file_block(
    request: Request,
    file_object: UploadFile,
    activity_uuid: str = Form(),
    db_session=Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
) -> BlockRead:
    """
    Create new pdf file
    """
    return await create_pdf_block(request, file_object, activity_uuid, db_session)


@router.get("/pdf")
async def api_get_pdf_file_block(
    request: Request,
    block_uuid: str,
    db_session=Depends(get_db_session),
    current_user: PublicUser = Depends(get_current_user),
) -> BlockRead:
    """
    Get pdf file
    """
    return await get_pdf_block(request, block_uuid, current_user, db_session)



================================================
FILE: apps/api/src/routers/ee/cloud_internal.py
================================================
import os
from typing import Optional
from fastapi import APIRouter, Depends, HTTPException, Request
from sqlmodel import Session
from src.core.events.database import get_db_session
from src.db.organization_config import OrganizationConfigBase
from src.services.explore.explore import get_course_for_explore, get_courses_for_an_org_explore, get_org_for_explore, get_orgs_for_explore, search_orgs_for_explore
from src.services.orgs.orgs import update_org_with_config_no_auth

router = APIRouter()

# Utils
def check_internal_cloud_key(request: Request):
    if request.headers.get("CloudInternalKey") != os.environ.get(
        "CLOUD_INTERNAL_KEY"
    ):
        raise HTTPException(status_code=403, detail="Unauthorized")

@router.get("/explore/orgs")
async def api_get_orgs_for_explore(
    request: Request,
    page: int = 1,
    limit: int = 10,
    label: str = "",
    salt: str = "",
    db_session: Session = Depends(get_db_session),
):
    return await get_orgs_for_explore(request, db_session, page, limit, label, salt)

@router.get("/explore/orgs/search")
async def api_search_orgs_for_explore(
    request: Request,
    search_query: str,  
    label: Optional[str] = None,
    db_session: Session = Depends(get_db_session),
):
    return await search_orgs_for_explore(request, db_session, search_query, label)

@router.get("/explore/orgs/{org_uuid}/courses")
async def api_get_courses_for_explore(
    request: Request,
    org_uuid: str,
    db_session: Session = Depends(get_db_session),
):
    return await get_courses_for_an_org_explore(request, db_session, org_uuid)

@router.get("/explore/courses/{course_id}")
async def api_get_course_for_explore(
    request: Request,
    course_id: str,
    db_session: Session = Depends(get_db_session),
):
    return await get_course_for_explore(request, course_id, db_session)

@router.get("/explore/orgs/{org_slug}")
async def api_get_org_for_explore(
    request: Request,
    org_slug: str,
    db_session: Session = Depends(get_db_session),
):
    return await get_org_for_explore(request, org_slug, db_session)

@router.put("/update_org_config")
async def update_org_Config(
    request: Request,
    org_id: int,
    config_object: OrganizationConfigBase,
    db_session: Session = Depends(get_db_session),
):

    res = await update_org_with_config_no_auth(
        request, config_object, org_id, db_session
    )
    return res



================================================
FILE: apps/api/src/routers/ee/payments.py
================================================
from typing import Literal
from fastapi import APIRouter, Depends, Request
from sqlmodel import Session
from src.core.events.database import get_db_session
from src.db.payments.payments import PaymentsConfig, PaymentsConfigRead
from src.db.users import PublicUser
from src.security.auth import get_current_user
from src.services.payments.payments_config import (
    init_payments_config,
    get_payments_config,
    delete_payments_config,
)
from src.db.payments.payments_products import PaymentsProductCreate, PaymentsProductRead, PaymentsProductUpdate
from src.services.payments.payments_products import create_payments_product, delete_payments_product, get_payments_product, get_products_by_course, list_payments_products, update_payments_product
from src.services.payments.payments_courses import (
    link_course_to_product,
    unlink_course_from_product,
    get_courses_by_product,
)
from src.services.payments.payments_users import get_owned_courses
from src.services.payments.payments_stripe import create_checkout_session, handle_stripe_oauth_callback, update_stripe_account_id
from src.services.payments.payments_access import check_course_paid_access
from src.services.payments.payments_customers import get_customers
from src.services.payments.payments_stripe import generate_stripe_connect_link
from src.services.payments.webhooks.payments_webhooks import handle_stripe_webhook


router = APIRouter()

@router.post("/{org_id}/config")
async def api_create_payments_config(
    request: Request,
    org_id: int,
    provider: Literal["stripe"],
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> PaymentsConfig:
    return await init_payments_config(request, org_id, provider, current_user, db_session)


@router.get("/{org_id}/config")
async def api_get_payments_config(
    request: Request,
    org_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> list[PaymentsConfigRead]:
    return await get_payments_config(request, org_id, current_user, db_session)

@router.delete("/{org_id}/config")
async def api_delete_payments_config(
    request: Request,
    org_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    await delete_payments_config(request, org_id, current_user, db_session)
    return {"message": "Payments config deleted successfully"}

@router.post("/{org_id}/products")
async def api_create_payments_product(
    request: Request,
    org_id: int,
    payments_product: PaymentsProductCreate,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> PaymentsProductRead:
    return await create_payments_product(request, org_id, payments_product, current_user, db_session)

@router.get("/{org_id}/products")
async def api_get_payments_products(
    request: Request,
    org_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> list[PaymentsProductRead]:
    return await list_payments_products(request, org_id, current_user, db_session)

@router.get("/{org_id}/products/{product_id}")
async def api_get_payments_product(
    request: Request,
    org_id: int,
    product_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> PaymentsProductRead:
    return await get_payments_product(request, org_id, product_id, current_user, db_session)

@router.put("/{org_id}/products/{product_id}")
async def api_update_payments_product(
    request: Request,
    org_id: int,
    product_id: int,
    payments_product: PaymentsProductUpdate,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> PaymentsProductRead:
    return await update_payments_product(request, org_id, product_id, payments_product, current_user, db_session)

@router.delete("/{org_id}/products/{product_id}")
async def api_delete_payments_product(
    request: Request,
    org_id: int,
    product_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    await delete_payments_product(request, org_id, product_id, current_user, db_session)
    return {"message": "Payments product deleted successfully"}

@router.post("/{org_id}/products/{product_id}/courses/{course_id}")
async def api_link_course_to_product(
    request: Request,
    org_id: int,
    product_id: int,
    course_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    return await link_course_to_product(
        request, org_id, course_id, product_id, current_user, db_session
    )

@router.delete("/{org_id}/products/{product_id}/courses/{course_id}")
async def api_unlink_course_from_product(
    request: Request,
    org_id: int,
    product_id: int,
    course_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    return await unlink_course_from_product(
        request, org_id, course_id, current_user, db_session
    )

@router.get("/{org_id}/products/{product_id}/courses")
async def api_get_courses_by_product(
    request: Request,
    org_id: int,
    product_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    return await get_courses_by_product(
        request, org_id, product_id, current_user, db_session
    )

@router.get("/{org_id}/courses/{course_id}/products")
async def api_get_products_by_course(
    request: Request,
    org_id: int,
    course_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    return await get_products_by_course(
        request, org_id, course_id, current_user, db_session
    )

# Payments webhooks

@router.post("/stripe/webhook")
async def api_handle_connected_accounts_stripe_webhook(
    request: Request,
    db_session: Session = Depends(get_db_session),
):
    return await handle_stripe_webhook(request, "standard", db_session)

@router.post("/stripe/webhook/connect")
async def api_handle_connected_accounts_stripe_webhook_connect(
    request: Request,
    db_session: Session = Depends(get_db_session),
):
    return await handle_stripe_webhook(request, "connect", db_session)

# Payments checkout

@router.post("/{org_id}/stripe/checkout/product/{product_id}")
async def api_create_checkout_session(
    request: Request,
    org_id: int,
    product_id: int,
    redirect_uri: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    return await create_checkout_session(request, org_id, product_id, redirect_uri, current_user, db_session)

@router.get("/{org_id}/courses/{course_id}/access")
async def api_check_course_paid_access(
    request: Request,
    org_id: int,
    course_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Check if current user has paid access to a specific course
    """
    return {
        "has_access": await check_course_paid_access(
            course_id=course_id,
            user=current_user,
            db_session=db_session
        )
    }

@router.get("/{org_id}/customers")
async def api_get_customers(
    request: Request,
    org_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Get list of customers and their subscriptions for an organization
    """
    return await get_customers(request, org_id, current_user, db_session)

@router.get("/{org_id}/courses/owned")
async def api_get_owned_courses(
    request: Request,
    org_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    return await get_owned_courses(request, current_user, db_session)

@router.put("/{org_id}/stripe/account")
async def api_update_stripe_account_id(
    request: Request,
    org_id: int,
    stripe_account_id: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    return await update_stripe_account_id(
        request, org_id, stripe_account_id, current_user, db_session
    )

@router.post("/{org_id}/stripe/connect/link")
async def api_generate_stripe_connect_link(
    request: Request,
    org_id: int,
    redirect_uri: str,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    """
    Generate a Stripe OAuth link for connecting a Stripe account
    """
    return await generate_stripe_connect_link(
        request, org_id, redirect_uri, current_user, db_session
    )

@router.get("/stripe/oauth/callback")
async def stripe_oauth_callback(
    request: Request,
    code: str,
    org_id: int,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    return await handle_stripe_oauth_callback(request, org_id, code, current_user, db_session)


================================================
FILE: apps/api/src/security/__init__.py
================================================
[Empty file]


================================================
FILE: apps/api/src/security/auth.py
================================================
from sqlmodel import Session
from src.core.events.database import get_db_session
from src.db.users import AnonymousUser, PublicUser, User, UserRead
from src.services.users.users import security_get_user
from config.config import get_learnhouse_config
from pydantic import BaseModel
from fastapi import Depends, HTTPException, Request, status
from fastapi.security import OAuth2PasswordBearer
from jose import JWTError, jwt
from datetime import datetime, timedelta, timezone
from src.services.dev.dev import isDevModeEnabled
from src.services.users.users import security_verify_password
from src.security.security import ALGORITHM, SECRET_KEY
from fastapi_jwt_auth import AuthJWT

oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/api/auth/login")


#### JWT Auth ####################################################
class Settings(BaseModel):
    authjwt_secret_key: str = "secret" if isDevModeEnabled() else SECRET_KEY
    authjwt_token_location = {"cookies", "headers"}
    authjwt_cookie_csrf_protect = False
    authjwt_access_token_expires = (
        False if isDevModeEnabled() else timedelta(hours=8).total_seconds()
    )
    authjwt_cookie_samesite = "lax"
    authjwt_cookie_secure = True
    authjwt_cookie_domain = get_learnhouse_config().hosting_config.cookie_config.domain


@AuthJWT.load_config  # type: ignore
def get_config():
    return Settings()


#### JWT Auth ####################################################


#### Classes ####################################################


class Token(BaseModel):
    access_token: str
    token_type: str


class TokenData(BaseModel):
    username: str | None = None


#### Classes ####################################################
async def authenticate_user(
    request: Request,
    email: str,
    password: str,
    db_session: Session,
) -> User | bool:
    user = await security_get_user(request, db_session, email)
    if not user:
        return False
    if not security_verify_password(password, user.password):
        return False
    return user


def create_access_token(data: dict, expires_delta: timedelta | None = None):
    to_encode = data.copy()
    if expires_delta:
        expire = datetime.now(timezone.utc) + expires_delta
    else:
        expire = datetime.now(timezone.utc) + timedelta(minutes=15)
    to_encode.update({"exp": expire})
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
    return encoded_jwt


async def get_current_user(
    request: Request,
    Authorize: AuthJWT = Depends(),
    db_session: Session = Depends(get_db_session),
):
    credentials_exception = HTTPException(
        status_code=status.HTTP_401_UNAUTHORIZED,
        detail="Could not validate credentials",
        headers={"WWW-Authenticate": "Bearer"},
    )

    try:
        Authorize.jwt_optional()
        username = Authorize.get_jwt_subject() or None
        token_data = TokenData(username=username)  # type: ignore
    except JWTError:
        raise credentials_exception
    if username:
        user = await security_get_user(request, db_session, email=token_data.username)  # type: ignore # treated as an email
        if user is None:
            raise credentials_exception
        return PublicUser(**user.model_dump())
    else:
        return AnonymousUser()


async def non_public_endpoint(current_user: UserRead | AnonymousUser):
    if isinstance(current_user, AnonymousUser):
        raise HTTPException(status_code=401, detail="Not authenticated")



================================================
FILE: apps/api/src/security/courses_security.py
================================================
"""
SECURITY DOCUMENTATION FOR COURSES RBAC SYSTEM

This module provides unified RBAC (Role-Based Access Control) checks for all courses-related operations.

SECURITY MEASURES IMPLEMENTED:

1. COURSE OWNERSHIP REQUIREMENTS:
   - All non-read operations (create, update, delete) require course ownership
   - Course ownership is determined by ResourceAuthor table with ACTIVE status
   - Valid ownership roles: CREATOR, MAINTAINER, CONTRIBUTOR
   - Admin/maintainer roles are also accepted for course operations

2. COURSE CREATION VS COURSE CONTENT CREATION:
   - COURSE CREATION: Allow if user has instructor role (3) or higher
   - COURSE CONTENT CREATION (activities, assignments, chapters, etc.): Require course ownership (CREATOR, MAINTAINER, CONTRIBUTOR) or admin/maintainer role
   - This distinction allows instructors to create courses but prevents them from creating content in courses they don't own

3. STRICT ACCESS CONTROLS:
   - Activities: Require course ownership for all non-read operations
   - Assignments: Require course ownership for all non-read operations
   - Chapters: Require course ownership for all non-read operations
   - Certifications: Require course ownership for all non-read operations
   - Collections: Use organization-level permissions

4. GRADING AND SUBMISSION SECURITY:
   - Only course owners or instructors can grade assignments
   - Users can only submit their own work
   - Users cannot update grades unless they are instructors
   - Users can only update their own submissions

5. CERTIFICATE SECURITY:
   - Certificates can only be created by course owners or instructors
   - System-generated certificates (from course completion) are properly secured
   - Certificate creation requires proper RBAC checks

6. ACTIVITY MARKING SECURITY:
   - Only course owners or instructors can mark activities as done for other users
   - Users can only mark their own activities as done

7. COLLECTION SECURITY:
   - Users can only add courses to collections if they have read access to those courses
   - Collection operations require appropriate organization-level permissions

8. ANONYMOUS USER HANDLING:
   - Anonymous users can only read public courses
   - All non-read operations require authentication

9. ERROR HANDLING:
   - Clear error messages for security violations
   - Proper HTTP status codes (401, 403, 404)
   - Comprehensive logging of security events

10. COURSE ACCESS MANAGEMENT SECURITY:
    - Sensitive fields (public, open_to_contributors) require additional validation
    - Only course owners (CREATOR, MAINTAINER) or admins can change access settings
    - Course creation requires proper organization-level permissions
    - Course updates require course ownership or admin role

11. CONTRIBUTOR MANAGEMENT SECURITY:
    - Only course owners (CREATOR, MAINTAINER) or admins can add/remove contributors
    - Only course owners (CREATOR, MAINTAINER) or admins can update contributor roles
    - Cannot modify the role of the course creator
    - Contributor applications are created with PENDING status
    - Only course owners or admins can approve contributor applications

SECURITY BEST PRACTICES:
- Always check course ownership before allowing modifications
- Validate user permissions at multiple levels
- Use proper RBAC checks for all operations
- Implement principle of least privilege
- Provide clear error messages for security violations
- Log security events for audit purposes
- Additional validation for sensitive access control fields
- Strict ownership requirements for contributor management
- Distinguish between course creation and course content creation permissions

CRITICAL SECURITY FIXES:
- Fixed: Users could create certifications for courses they don't own
- Fixed: Users could grade assignments without proper permissions
- Fixed: Users could mark activities as done for other users without permissions
- Fixed: Collections could be created with courses the user doesn't have access to
- Fixed: Assignment submissions could be modified by unauthorized users
- Fixed: Users could change course access settings (public, open_to_contributors) without proper permissions
- Fixed: Users could add/remove contributors from courses they don't own
- Fixed: Users could update contributor roles without course ownership
- Fixed: Course creation used hardcoded RBAC check
- Fixed: Contributor management used permissive RBAC checks instead of strict ownership requirements
- Fixed: Instructors could create content in courses they don't own (now they can only create courses)
"""

from typing import Literal
from fastapi import HTTPException, Request, status
from sqlmodel import Session, select
from src.db.users import AnonymousUser, PublicUser
from src.db.courses.courses import Course
from src.db.resource_authors import ResourceAuthor, ResourceAuthorshipEnum, ResourceAuthorshipStatusEnum
from src.security.rbac.rbac import (
    authorization_verify_based_on_roles_and_authorship,
    authorization_verify_if_element_is_public,
    authorization_verify_if_user_is_anon,
    authorization_verify_based_on_org_admin_status,
)


async def courses_rbac_check(
    request: Request,
    course_uuid: str,
    current_user: PublicUser | AnonymousUser,
    action: Literal["create", "read", "update", "delete"],
    db_session: Session,
    require_course_ownership: bool = False,
) -> bool:
    """
    Unified RBAC check for courses-related operations.
    
    SECURITY NOTES:
    - READ operations: Allow if user has read access to the course (public courses or user has permissions)
    - COURSE CREATION: Allow if user has instructor role (3) or higher
    - COURSE CONTENT CREATION (activities, assignments, chapters, etc.): Require course ownership (CREATOR, MAINTAINER, CONTRIBUTOR) or admin/maintainer role
    - UPDATE/DELETE operations: Require course ownership (CREATOR, MAINTAINER, CONTRIBUTOR) or admin/maintainer role
    - Course ownership is determined by ResourceAuthor table with ACTIVE status
    - Admin/maintainer roles are checked via authorization_verify_based_on_org_admin_status
    
    Args:
        request: FastAPI request object
        course_uuid: UUID of the course (or "course_x" for course creation)
        current_user: Current user (PublicUser or AnonymousUser)
        action: Action to perform (create, read, update, delete)
        db_session: Database session
        require_course_ownership: If True, requires course ownership for non-read actions
    
    Returns:
        bool: True if authorized, raises HTTPException otherwise
    
    Raises:
        HTTPException: 403 Forbidden if user lacks required permissions
        HTTPException: 401 Unauthorized if user is anonymous for non-read actions
    """
    
    if action == "read":
        if current_user.id == 0:  # Anonymous user
            return await authorization_verify_if_element_is_public(
                request, course_uuid, action, db_session
            )
        else:
            return await authorization_verify_based_on_roles_and_authorship(
                request, current_user.id, action, course_uuid, db_session
            )
    else:
        # For non-read actions, proceed with strict RBAC checks
        await authorization_verify_if_user_is_anon(current_user.id)
        
        # SECURITY: Special handling for course creation vs course content creation
        if action == "create" and course_uuid == "course_x":
            # This is course creation - allow instructors (role 3) or higher
            # Check if user has instructor role or higher
            from src.security.rbac.rbac import authorization_verify_based_on_roles
            
            has_create_permission = await authorization_verify_based_on_roles(
                request, current_user.id, "create", "course_x", db_session
            )
            
            if has_create_permission:
                return True
            else:
                raise HTTPException(
                    status_code=status.HTTP_403_FORBIDDEN,
                    detail="You must have instructor role or higher to create courses",
                )
        
        # SECURITY: For course content creation and other operations, require course ownership
        # This prevents users without course ownership from creating/modifying course content
        if require_course_ownership or action in ["create", "update", "delete"]:
            # Check if user is course owner (CREATOR, MAINTAINER, or CONTRIBUTOR)
            statement = select(ResourceAuthor).where(
                ResourceAuthor.resource_uuid == course_uuid,
                ResourceAuthor.user_id == current_user.id
            )
            resource_author = db_session.exec(statement).first()
            
            is_course_owner = False
            if resource_author:
                if ((resource_author.authorship == ResourceAuthorshipEnum.CREATOR) or 
                    (resource_author.authorship == ResourceAuthorshipEnum.MAINTAINER) or 
                    (resource_author.authorship == ResourceAuthorshipEnum.CONTRIBUTOR)) and \
                    resource_author.authorship_status == ResourceAuthorshipStatusEnum.ACTIVE:
                    is_course_owner = True
            
            # Check if user has admin or maintainer role
            is_admin_or_maintainer = await authorization_verify_based_on_org_admin_status(
                request, current_user.id, action, course_uuid, db_session
            )
            
            # SECURITY: For creating, updating, and deleting course content, user MUST be either:
            # 1. Course owner (CREATOR, MAINTAINER, or CONTRIBUTOR with ACTIVE status)
            # 2. Admin or maintainer role
            # General role permissions are NOT sufficient for these actions
            if not (is_course_owner or is_admin_or_maintainer):
                raise HTTPException(
                    status_code=status.HTTP_403_FORBIDDEN,
                    detail=f"You must be the course owner (CREATOR, MAINTAINER, or CONTRIBUTOR) or have admin/maintainer role to {action} in this course",
                )
            return True
        else:
            # For other actions, use the existing RBAC check
            return await authorization_verify_based_on_roles_and_authorship(
                request,
                current_user.id,
                action,
                course_uuid,
                db_session,
            )


async def courses_rbac_check_with_course_lookup(
    request: Request,
    course_uuid: str,
    current_user: PublicUser | AnonymousUser,
    action: Literal["create", "read", "update", "delete"],
    db_session: Session,
    require_course_ownership: bool = False,
) -> Course:
    """
    Unified RBAC check for courses-related operations with course lookup.
    
    SECURITY NOTES:
    - First validates that the course exists
    - Then performs RBAC check using courses_rbac_check
    - Returns the course object if authorized
    
    Args:
        request: FastAPI request object
        course_uuid: UUID of the course
        current_user: Current user (PublicUser or AnonymousUser)
        action: Action to perform (create, read, update, delete)
        db_session: Database session
        require_course_ownership: If True, requires course ownership for non-read actions
    
    Returns:
        Course: The course object if authorized, raises HTTPException otherwise
    
    Raises:
        HTTPException: 404 Not Found if course doesn't exist
        HTTPException: 403 Forbidden if user lacks required permissions
    """
    
    # First check if course exists
    statement = select(Course).where(Course.course_uuid == course_uuid)
    course = db_session.exec(statement).first()
    
    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )
    
    # Perform RBAC check
    await courses_rbac_check(
        request, course_uuid, current_user, action, db_session, require_course_ownership
    )
    
    return course


async def courses_rbac_check_for_activities(
    request: Request,
    course_uuid: str,
    current_user: PublicUser | AnonymousUser,
    action: Literal["create", "read", "update", "delete"],
    db_session: Session,
) -> bool:
    """
    Specialized RBAC check for activities that requires course ownership for non-read actions.
    
    SECURITY NOTES:
    - Activities are core course content and require strict ownership controls
    - READ: Allow if user has read access to the course
    - CREATE/UPDATE/DELETE: Require course ownership (CREATOR, MAINTAINER, CONTRIBUTOR) or admin/maintainer role
    - This prevents unauthorized users from creating/modifying course activities
    - Instructors can create courses but cannot create activities in courses they don't own
    """
    
    return await courses_rbac_check(
        request, course_uuid, current_user, action, db_session, require_course_ownership=True
    )


async def courses_rbac_check_for_assignments(
    request: Request,
    course_uuid: str,
    current_user: PublicUser | AnonymousUser,
    action: Literal["create", "read", "update", "delete"],
    db_session: Session,
) -> bool:
    """
    Specialized RBAC check for assignments that requires course ownership for non-read actions.
    
    SECURITY NOTES:
    - Assignments are course content and require strict ownership controls
    - READ: Allow if user has read access to the course
    - CREATE/UPDATE/DELETE: Require course ownership (CREATOR, MAINTAINER, CONTRIBUTOR) or admin/maintainer role
    - This prevents unauthorized users from creating/modifying course assignments
    - Instructors can create courses but cannot create assignments in courses they don't own
    """
    
    return await courses_rbac_check(
        request, course_uuid, current_user, action, db_session, require_course_ownership=True
    )


async def courses_rbac_check_for_chapters(
    request: Request,
    course_uuid: str,
    current_user: PublicUser | AnonymousUser,
    action: Literal["create", "read", "update", "delete"],
    db_session: Session,
) -> bool:
    """
    Specialized RBAC check for chapters that requires course ownership for non-read actions.
    
    SECURITY NOTES:
    - Chapters are course structure and require strict ownership controls
    - READ: Allow if user has read access to the course
    - CREATE/UPDATE/DELETE: Require course ownership (CREATOR, MAINTAINER, CONTRIBUTOR) or admin/maintainer role
    - This prevents unauthorized users from creating/modifying course chapters
    - Instructors can create courses but cannot create chapters in courses they don't own
    """
    
    return await courses_rbac_check(
        request, course_uuid, current_user, action, db_session, require_course_ownership=True
    )


async def courses_rbac_check_for_certifications(
    request: Request,
    course_uuid: str,
    current_user: PublicUser | AnonymousUser,
    action: Literal["create", "read", "update", "delete"],
    db_session: Session,
) -> bool:
    """
    Specialized RBAC check for certifications that requires course ownership for non-read actions.
    
    SECURITY NOTES:
    - Certifications are course credentials and require strict ownership controls
    - READ: Allow if user has read access to the course
    - CREATE/UPDATE/DELETE: Require course ownership (CREATOR, MAINTAINER, CONTRIBUTOR) or admin/maintainer role
    - This prevents unauthorized users from creating/modifying course certifications
    - CRITICAL: Without this check, users could create certifications for courses they don't own
    - Instructors can create courses but cannot create certifications in courses they don't own
    """
    
    return await courses_rbac_check(
        request, course_uuid, current_user, action, db_session, require_course_ownership=True
    )


async def courses_rbac_check_for_collections(
    request: Request,
    collection_uuid: str,
    current_user: PublicUser | AnonymousUser,
    action: Literal["create", "read", "update", "delete"],
    db_session: Session,
) -> bool:
    """
    Specialized RBAC check for collections.
    
    SECURITY NOTES:
    - Collections are course groupings and require appropriate access controls
    - READ: Allow if collection is public or user has read access
    - CREATE/UPDATE/DELETE: Require appropriate permissions based on collection ownership
    - Collections may have different ownership models than courses
    
    Args:
        request: FastAPI request object
        collection_uuid: UUID of the collection
        current_user: Current user (PublicUser or AnonymousUser)
        action: Action to perform (create, read, update, delete)
        db_session: Database session
    
    Returns:
        bool: True if authorized, raises HTTPException otherwise
    """
    
    if action == "read":
        if current_user.id == 0:  # Anonymous user
            res = await authorization_verify_if_element_is_public(
                request, collection_uuid, action, db_session
            )
            if res == False:
                raise HTTPException(
                    status_code=status.HTTP_403_FORBIDDEN,
                    detail="User rights : You are not allowed to read this collection",
                )
            return res
        else:
            return await authorization_verify_based_on_roles_and_authorship(
                request, current_user.id, action, collection_uuid, db_session
            )
    else:
        await authorization_verify_if_user_is_anon(current_user.id)
        
        return await authorization_verify_based_on_roles_and_authorship(
            request,
            current_user.id,
            action,
            collection_uuid,
            db_session,
        ) 


================================================
FILE: apps/api/src/security/file_validation.py
================================================
"""
Secure file validation utilities.
Blocks SVG files entirely to prevent XSS attacks (CWE-79).
Validates file types and content to prevent unrestricted uploads (CWE-434).
"""

import re
from typing import List, Optional, Tuple
from fastapi import HTTPException, UploadFile


def validate_image_content(content: bytes) -> bool:
    """Validate image content using magic bytes (no deprecated modules)."""
    if len(content) < 12:
        return False
    
    # Check common image format magic bytes
    magic_bytes = content[:12]
    
    # JPEG: FF D8 FF
    if magic_bytes.startswith(b'\xff\xd8\xff'):
        return True
    
    # PNG: 89 50 4E 47 0D 0A 1A 0A
    if magic_bytes.startswith(b'\x89PNG\r\n\x1a\n'):
        return True
    
    # GIF: GIF87a or GIF89a
    if magic_bytes.startswith(b'GIF87a') or magic_bytes.startswith(b'GIF89a'):
        return True
    
    # WebP: RIFF....WEBP
    if magic_bytes.startswith(b'RIFF') and b'WEBP' in content[:16]:
        return True
    
    return False


def validate_video_content(content: bytes) -> bool:
    """Validate video content using magic bytes."""
    if len(content) < 12:
        return False
    
    magic_bytes = content[:12]
    
    # MP4: starts with specific ftyp box signatures
    if (magic_bytes[4:8] == b'ftyp' and 
        (b'mp4' in magic_bytes[8:12] or b'M4V' in magic_bytes[8:12] or b'isom' in magic_bytes[8:12])):
        return True
    
    # WebM: EBML header
    if magic_bytes.startswith(b'\x1a\x45\xdf\xa3'):
        return True
    
    return False


# File type configurations
FILE_TYPES = {
    'image': {
        'extensions': ['.jpg', '.jpeg', '.png', '.gif', '.webp'],
        'mime_types': ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
        'max_size': 10 * 1024 * 1024,  # 10MB
        'validator': validate_image_content
    },
    'video': {
        'extensions': ['.mp4', '.webm'],
        'mime_types': ['video/mp4', 'video/webm'],
        'max_size': 100 * 1024 * 1024,  # 100MB
        'validator': validate_video_content
    },
    'document': {
        'extensions': ['.pdf'],
        'mime_types': ['application/pdf'],
        'max_size': 50 * 1024 * 1024,  # 50MB
        'validator': lambda content: content.startswith(b'%PDF-')
    }
}


def validate_upload(
    file: UploadFile,
    allowed_types: List[str],
    max_size: Optional[int] = None
) -> Tuple[str, bytes]:
    """
    Validate uploaded file for security and type compliance.
    
    Args:
        file: The uploaded file
        allowed_types: List of allowed file types ('image', 'video', 'document')
        max_size: Maximum file size in bytes (auto-determined if None)
        
    Returns:
        Tuple of (mime_type, file_content)
        
    Raises:
        HTTPException: If validation fails
    """
    if not file or not file.filename:
        raise HTTPException(status_code=400, detail="No file provided")
    
    # Read file content once
    content = file.file.read()
    file.file.seek(0)
    
    # Get file extension and block SVG explicitly
    ext = '.' + file.filename.split('.')[-1].lower()
    if ext == '.svg':
        raise HTTPException(status_code=415, detail="SVG files are not allowed for security reasons")
    
    # Find matching file type configuration
    config = None
    for file_type in allowed_types:
        if file_type in FILE_TYPES and ext in FILE_TYPES[file_type]['extensions']:
            config = FILE_TYPES[file_type]
            break
    
    if not config:
        allowed_exts = [ext for t in allowed_types for ext in FILE_TYPES.get(t, {}).get('extensions', [])]
        raise HTTPException(status_code=415, detail=f"File type not allowed. Allowed: {allowed_exts}")
    
    # Check file size
    size_limit = max_size or config['max_size']
    if len(content) > size_limit:
        raise HTTPException(
            status_code=413, 
            detail=f"File too large ({len(content)/1024/1024:.1f}MB > {size_limit/1024/1024:.1f}MB)"
        )
    
    # Validate file content
    if not config['validator'](content):
        raise HTTPException(status_code=415, detail="File appears to be corrupted or invalid")
    
    return file.content_type, content


def get_safe_filename(original_filename: str, prefix: str = "") -> str:
    """Generate a safe filename with UUID and validated extension."""
    if not original_filename:
        return f"{prefix}.bin"
    
    ext = original_filename.split('.')[-1].lower()
    # Only allow safe alphanumeric extensions
    if re.match(r'^[a-zA-Z0-9]+$', ext):
        return f"{prefix}.{ext}"
    
    return f"{prefix}.bin"



================================================
FILE: apps/api/src/security/security.py
================================================
from passlib.context import CryptContext
from passlib.hash import pbkdf2_sha256
from config.config import get_learnhouse_config


### ğŸ”’ JWT ##############################################################

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

ACCESS_TOKEN_EXPIRE_MINUTES = 30
SECRET_KEY = get_learnhouse_config().security_config.auth_jwt_secret_key
ALGORITHM = "HS256"

### ğŸ”’ JWT ##############################################################


### ğŸ”’ Passwords Hashing ##############################################################


def security_hash_password(password: str):
    return pbkdf2_sha256.hash(password)


def security_verify_password(plain_password: str, hashed_password: str):
    return pbkdf2_sha256.verify(plain_password, hashed_password)


### ğŸ”’ Passwords Hashing ##############################################################





================================================
FILE: apps/api/src/security/features_utils/usage.py
================================================
import redis
from src.db.organization_config import OrganizationConfig
from config.config import get_learnhouse_config
from typing import Literal, TypeAlias
from fastapi import HTTPException
from sqlmodel import Session, select

FeatureSet: TypeAlias = Literal[
    "ai",
    "analytics",
    "api",
    "assignments",
    "collaboration",
    "courses",
    "discussions",
    "members",
    "payments",
    "storage",
    "usergroups",
]


def check_limits_with_usage(
    feature: FeatureSet,
    org_id: int,
    db_session: Session,
):

    # Get the Organization Config
    statement = select(OrganizationConfig).where(OrganizationConfig.org_id == org_id)
    result = db_session.exec(statement)

    org_config = result.first()

    if org_config is None:
        raise HTTPException(
            status_code=404,
            detail="Organization has no config",
        )

    # Check if the Organizations has AI enabled
    if org_config.config["features"][feature]["enabled"] == False:
        raise HTTPException(
            status_code=403,
            detail=f"{feature.capitalize()} is not enabled for this organization",
        )

    LH_CONFIG = get_learnhouse_config()
    redis_conn_string = LH_CONFIG.redis_config.redis_connection_string

    if not redis_conn_string:
        raise HTTPException(
            status_code=500,
            detail="Redis connection string not found",
        )

    # Connect to Redis
    r = redis.Redis.from_url(redis_conn_string)

    # Check limits
    feature_limit = org_config.config["features"][feature]["limit"]

    if feature_limit > 0:
        # Get the number of feature usage
        feature_usage = r.get(f"{feature}_usage:{org_id}")

        # Get a number of feature asks
        if feature_usage is None:
            feature_usage_count = 0
        else:
            feature_usage_count = int(feature_usage)  # type: ignore

        # Check if the Number of usage is less than the max_asks limit
        if feature_limit <= feature_usage_count:
            raise HTTPException(
                status_code=403,
                detail=f"Usage Limit has been reached for {feature.capitalize()}",
            )
        return True


def increase_feature_usage(
    feature: FeatureSet,
    org_id: int,
    db_session: Session,
):
    LH_CONFIG = get_learnhouse_config()
    redis_conn_string = LH_CONFIG.redis_config.redis_connection_string

    if not redis_conn_string:
        raise HTTPException(
            status_code=500,
            detail="Redis connection string not found",
        )

    # Connect to Redis
    r = redis.Redis.from_url(redis_conn_string)

    # Get the number of feature usage
    feature_usage = r.get(f"{feature}_usage:{org_id}")

    # Get a number of feature asks
    if feature_usage is None:
        feature_usage_count = 0
    else:
        feature_usage_count = int(feature_usage)  # type: ignore

    # Increment the feature usage
    r.set(f"{feature}_usage:{org_id}", feature_usage_count + 1)
    return True


def decrease_feature_usage(
    feature: FeatureSet,
    org_id: int,
    db_session: Session,
):
    LH_CONFIG = get_learnhouse_config()
    redis_conn_string = LH_CONFIG.redis_config.redis_connection_string

    if not redis_conn_string:
        raise HTTPException(
            status_code=500,
            detail="Redis connection string not found",
        )

    # Connect to Redis
    r = redis.Redis.from_url(redis_conn_string)

    # Get the number of feature usage
    feature_usage = r.get(f"{feature}_usage:{org_id}")

    # Get a number of feature asks
    if feature_usage is None:
        feature_usage_count = 0
    else:
        feature_usage_count = int(feature_usage)  # type: ignore

    # Increment the feature usage
    r.set(f"{feature}_usage:{org_id}", feature_usage_count - 1)
    return True



================================================
FILE: apps/api/src/security/rbac/rbac.py
================================================
from typing import Literal
from fastapi import HTTPException, status, Request
from sqlalchemy import null
from sqlmodel import Session, select
from src.db.collections import Collection
from src.db.courses.courses import Course
from src.db.resource_authors import ResourceAuthor, ResourceAuthorshipEnum, ResourceAuthorshipStatusEnum
from src.db.roles import Role
from src.db.user_organizations import UserOrganization
from src.security.rbac.utils import check_element_type, check_course_permissions_with_own


# Tested and working
async def authorization_verify_if_element_is_public(
    request,
    element_uuid: str,
    action: Literal["read"],
    db_session: Session,
):
    element_nature = await check_element_type(element_uuid)
    # Verifies if the element is public
    if element_nature == ("courses") and action == "read":
        if element_nature == "courses":
            statement = select(Course).where(
                Course.public == True, Course.course_uuid == element_uuid
            )
            course = db_session.exec(statement).first()
            if course:
                return True
            else:
                raise HTTPException(
                    status_code=status.HTTP_403_FORBIDDEN,
                    detail="User rights : You don't have the right to perform this action",
                )

    if element_nature == "collections" and action == "read":
        statement = select(Collection).where(
            Collection.public == True, Collection.collection_uuid == element_uuid
        )
        collection = db_session.exec(statement).first()
        if collection:
            return True
        else:
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail="User rights : You don't have the right to perform this action",
            )
    else:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="User rights : You don't have the right to perform this action",
        )


# Tested and working
async def authorization_verify_if_user_is_author(
    request,
    user_id: int,
    action: Literal["read", "update", "delete", "create"],
    element_uuid: str,
    db_session: Session,
):
    # For create action, we don't need to check existing resource
    if action == "create":
        return True  # Allow creation if user is authenticated
        
    if action in ["update", "delete", "read"]:
        statement = select(ResourceAuthor).where(
            ResourceAuthor.resource_uuid == element_uuid
        )
        resource_author = db_session.exec(statement).first()

        if resource_author:
            if resource_author.user_id == int(user_id):
                if ((resource_author.authorship == ResourceAuthorshipEnum.CREATOR) or 
                    (resource_author.authorship == ResourceAuthorshipEnum.MAINTAINER) or 
                    (resource_author.authorship == ResourceAuthorshipEnum.CONTRIBUTOR)) and \
                    resource_author.authorship_status == ResourceAuthorshipStatusEnum.ACTIVE:
                    return True
                else:
                    return False
            else:
                return False
        else:
            return False
    return False


# Tested and working
async def authorization_verify_based_on_roles(
    request: Request,
    user_id: int,
    action: Literal["read", "update", "delete", "create"],
    element_uuid: str,
    db_session: Session,
):
    element_type = await check_element_type(element_uuid)

    # Get user roles bound to an organization and standard roles
    statement = (
        select(Role)
        .join(UserOrganization)
        .where((UserOrganization.org_id == Role.org_id) | (Role.org_id == null()))
        .where(UserOrganization.user_id == user_id)
    )

    user_roles_in_organization_and_standard_roles = db_session.exec(statement).all()

    
    # Check if user is the author of the resource for "own" permissions
    is_author = False
    if action in ["update", "delete", "read"]:
        is_author = await authorization_verify_if_user_is_author(
            request, user_id, action, element_uuid, db_session
        )

    # Check all roles until we find one that grants the permission
    for role in user_roles_in_organization_and_standard_roles:
        role = Role.model_validate(role)
        if role.rights:
            rights = role.rights
            element_rights = getattr(rights, element_type, None)
            if element_rights:
                # Special handling for courses with PermissionsWithOwn
                if element_type == "courses":
                    if await check_course_permissions_with_own(element_rights, action, is_author):
                        return True
                else:
                    # For non-course resources, only check general permissions
                    # (regular Permission class no longer has "own" permissions)
                    if getattr(element_rights, f"action_{action}", False):
                        return True
    
    # If we get here, no role granted the permission
    return False


async def authorization_verify_based_on_org_admin_status(
    request: Request,
    user_id: int,
    action: Literal["read", "update", "delete", "create"],
    element_uuid: str,
    db_session: Session,
):
    await check_element_type(element_uuid)

    # Get user roles bound to an organization and standard roles
    statement = (
        select(Role)
        .join(UserOrganization)
        .where((UserOrganization.org_id == Role.org_id) | (Role.org_id == null()))
        .where(UserOrganization.user_id == user_id)
    )

    user_roles_in_organization_and_standard_roles = db_session.exec(statement).all()

    # Check if user has admin role (role_id 1 or 2) in any organization
    for role in user_roles_in_organization_and_standard_roles:
        role = Role.model_validate(role)
        if role.id in [1, 2]:  # Assuming 1 and 2 are admin role IDs
            return True
    
    return False


# Tested and working
async def authorization_verify_based_on_roles_and_authorship(
    request: Request,
    user_id: int,
    action: Literal["read", "update", "delete", "create"],
    element_uuid: str,
    db_session: Session,
):
    isAuthor = await authorization_verify_if_user_is_author(
        request, user_id, action, element_uuid, db_session
    )

    isRole = await authorization_verify_based_on_roles(
        request, user_id, action, element_uuid, db_session
    )

    if isAuthor or isRole:
        return True
    else:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="User rights (roles & authorship) : You don't have the right to perform this action",
        )


async def authorization_verify_if_user_is_anon(user_id: int):
    if user_id == 0:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="You should be logged in to perform this action",
        )



================================================
FILE: apps/api/src/security/rbac/utils.py
================================================
from fastapi import HTTPException, status


async def check_element_type(element_uuid):
    """
    Check if the element is a course, a user, a house or a collection, by checking its prefix
    """
    if element_uuid.startswith("course_") or element_uuid.startswith("courseupdate_"):
        return "courses"
    elif element_uuid.startswith("user_"):
        return "users"
    elif element_uuid.startswith("usergroup_"):
        return "usergroups"
    elif element_uuid.startswith("house_"):
        return "houses"
    elif element_uuid.startswith("org_"):
        return "organizations"
    elif element_uuid.startswith("chapter_"):
        return "coursechapters"
    elif element_uuid.startswith("collection_"):
        return "collections"
    elif element_uuid.startswith("activity_"):
        return "activities"
    elif element_uuid.startswith("role_"):
        return "roles"
    else:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT,
            detail="User rights : Issue verifying element nature",
        )


async def check_course_permissions_with_own(
    element_rights,
    action: str,
    is_author: bool = False
) -> bool:
    """
    Check course-specific permissions including "own" permissions.
    
    Args:
        element_rights: The rights object for courses (PermissionsWithOwn)
        action: The action to check ("read", "update", "delete", "create")
        is_author: Whether the user is the author of the course
    
    Returns:
        bool: True if permission is granted, False otherwise
    """
    if not element_rights:
        return False
    
    # Check for general permission first
    if getattr(element_rights, f"action_{action}", False):
        return True
    
    # Check for "own" permission if user is the author
    if is_author:
        own_action = f"action_{action}_own"
        if getattr(element_rights, own_action, False):
            return True
    
    return False


async def get_singular_form_of_element(element_uuid):
    element_type = await check_element_type(element_uuid)

    if element_type == "activities":
        return "activity"
    else:
        singular_form_element = element_type[:-1]
        return singular_form_element


async def get_id_identifier_of_element(element_uuid):
    singular_form_element = await get_singular_form_of_element(element_uuid)

    if singular_form_element == "organization":
        return "org_id"
    else:
        return str(singular_form_element) + "_id"



================================================
FILE: apps/api/src/services/__init__.py
================================================
[Empty file]


================================================
FILE: apps/api/src/services/ai/ai.py
================================================
from fastapi import Depends, HTTPException, Request
from sqlmodel import Session, select
from src.db.organization_config import OrganizationConfig
from src.db.organizations import Organization
from src.security.features_utils.usage import (
    check_limits_with_usage,
    increase_feature_usage,
)
from src.db.courses.courses import Course, CourseRead
from src.core.events.database import get_db_session
from src.db.users import PublicUser
from src.db.courses.activities import Activity, ActivityRead
from src.security.auth import get_current_user
from src.services.ai.base import ask_ai, get_chat_session_history, save_message_to_history

from src.services.ai.schemas.ai import (
    ActivityAIChatSessionResponse,
    SendActivityAIChatMessage,
    StartActivityAIChatSession,
)
from src.services.courses.activities.utils import (
    serialize_activity_text_to_ai_comprehensible_text,
    structure_activity_content_by_type,
)


def ai_start_activity_chat_session(
    request: Request,
    chat_session_object: StartActivityAIChatSession,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> ActivityAIChatSessionResponse:
    """
    Start a new AI Chat session with a Course Activity
    """

    # Get the Activity
    statement = select(Activity).where(
        Activity.activity_uuid == chat_session_object.activity_uuid
    )
    activity = db_session.exec(statement).first()

    activity = ActivityRead.model_validate(activity)

    # Get the Course with authors
    statement = (
        select(Course)
        .join(Activity)
        .where(Activity.activity_uuid == chat_session_object.activity_uuid)
    )
    course = db_session.exec(statement).first()
    
    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )
    
    # Get course authors
    from src.db.resource_authors import ResourceAuthor
    from src.db.users import User
    from src.services.courses.courses import AuthorWithRole, UserRead
    
    authors_statement = (
        select(ResourceAuthor, User)
        .join(User, ResourceAuthor.user_id == User.id)  # type: ignore
        .where(ResourceAuthor.resource_uuid == course.course_uuid)
        .order_by(ResourceAuthor.id.asc())  # type: ignore
    )
    author_results = db_session.exec(authors_statement).all()
    
    # Convert to AuthorWithRole objects
    authors = [
        AuthorWithRole(
            user=UserRead.model_validate(user),
            authorship=resource_author.authorship,
            authorship_status=resource_author.authorship_status,
            creation_date=resource_author.creation_date,
            update_date=resource_author.update_date
        )
        for resource_author, user in author_results
    ]
    
    course = CourseRead(**course.model_dump(), authors=authors)

    # Get the Organization
    statement = select(Organization).where(Organization.id == course.org_id)
    org = db_session.exec(statement).first()

    if not org or org.id is None:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # Check limits and usage
    check_limits_with_usage("ai", org.id, db_session)
    increase_feature_usage("ai", org.id, db_session)

    if not activity:
        raise HTTPException(
            status_code=404,
            detail="Activity not found",
        )

    # Get Activity Content Blocks
    content = activity.content

    # Serialize Activity Content Blocks to a text comprehensible by the AI
    structured = structure_activity_content_by_type(content)

    isEmpty = structured == []

    ai_friendly_text = serialize_activity_text_to_ai_comprehensible_text(
        structured, course, activity, isActivityEmpty=isEmpty
    )

    # Get Activity Organization
    statement = select(Organization).where(Organization.id == course.org_id)
    org = db_session.exec(statement).first()

    # Get Organization Config
    statement = select(OrganizationConfig).where(
        OrganizationConfig.org_id == org.id  # type: ignore
    )
    result = db_session.exec(statement)
    org_config = result.first()

    org_config = OrganizationConfig.model_validate(org_config)
    ai_model = org_config.config["features"]["ai"]["model"]

    chat_session = get_chat_session_history()

    message = "You are a helpful Education Assistant, and you are helping a student with the associated Course. "
    message += "Use the course content provided to answer questions about the course material."
    message += "For context, this is the Course name: "
    message += course.name
    message += " and this is the Lecture name: "
    message += activity.name
    message += "."
    message += "Use your knowledge to help the student if the context is not enough."

    response = ask_ai(
        chat_session_object.message,
        chat_session["message_history"],
        ai_friendly_text,
        message,
        ai_model,
    )

    # Save the message exchange to history
    save_message_to_history(
        chat_session["aichat_uuid"],
        chat_session_object.message,
        response["output"]
    )

    return ActivityAIChatSessionResponse(
        aichat_uuid=chat_session["aichat_uuid"],
        activity_uuid=activity.activity_uuid,
        message=response["output"],
    )


def ai_send_activity_chat_message(
    request: Request,
    chat_session_object: SendActivityAIChatMessage,
    current_user: PublicUser = Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
) -> ActivityAIChatSessionResponse:
    """
    Send a message in an existing AI Chat session with a Course Activity
    """
    # Get the Activity
    statement = select(Activity).where(
        Activity.activity_uuid == chat_session_object.activity_uuid
    )
    activity = db_session.exec(statement).first()

    activity = ActivityRead.model_validate(activity)

    # Get the Course with authors
    statement = (
        select(Course)
        .join(Activity)
        .where(Activity.activity_uuid == chat_session_object.activity_uuid)
    )
    course = db_session.exec(statement).first()
    
    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )
    
    # Get course authors
    from src.db.resource_authors import ResourceAuthor
    from src.db.users import User
    from src.services.courses.courses import AuthorWithRole, UserRead
    
    authors_statement = (
        select(ResourceAuthor, User)
        .join(User, ResourceAuthor.user_id == User.id)  # type: ignore
        .where(ResourceAuthor.resource_uuid == course.course_uuid)
        .order_by(ResourceAuthor.id.asc())  # type: ignore
    )
    author_results = db_session.exec(authors_statement).all()
    
    # Convert to AuthorWithRole objects
    authors = [
        AuthorWithRole(
            user=UserRead.model_validate(user),
            authorship=resource_author.authorship,
            authorship_status=resource_author.authorship_status,
            creation_date=resource_author.creation_date,
            update_date=resource_author.update_date
        )
        for resource_author, user in author_results
    ]
    
    course = CourseRead(**course.model_dump(), authors=authors)

    # Get the Organization
    statement = select(Organization).where(Organization.id == course.org_id)
    org = db_session.exec(statement).first()

    # Check limits and usage
    check_limits_with_usage("ai", course.org_id, db_session)
    increase_feature_usage("ai", course.org_id, db_session)

    if not activity:
        raise HTTPException(
            status_code=404,
            detail="Activity not found",
        )

    # Get Activity Content Blocks
    content = activity.content

    # Serialize Activity Content Blocks to a text comprehensible by the AI
    structured = structure_activity_content_by_type(content)
    ai_friendly_text = serialize_activity_text_to_ai_comprehensible_text(
        structured, course, activity
    )

    # Get Activity Organization
    statement = select(Organization).where(Organization.id == course.org_id)
    org = db_session.exec(statement).first()

    # Get Organization Config
    statement = select(OrganizationConfig).where(
        OrganizationConfig.org_id == org.id  # type: ignore
    )
    result = db_session.exec(statement)
    org_config = result.first()

    org_config = OrganizationConfig.model_validate(org_config)
    ai_model = org_config.config["features"]["ai"]["model"]

    chat_session = get_chat_session_history(chat_session_object.aichat_uuid)

    message = "You are a helpful Education Assistant, and you are helping a student with the associated Course. "
    message += "Use the course content provided to answer questions about the course material."
    message += "For context, this is the Course name: "
    message += course.name
    message += " and this is the Lecture name: "
    message += activity.name
    message += "."
    message += "Use your knowledge to help the student if the context is not enough."

    response = ask_ai(
        chat_session_object.message,
        chat_session["message_history"],
        ai_friendly_text,
        message,
        ai_model,
    )

    # Save the message exchange to history
    save_message_to_history(
        chat_session["aichat_uuid"],
        chat_session_object.message,
        response["output"]
    )

    return ActivityAIChatSessionResponse(
        aichat_uuid=chat_session["aichat_uuid"],
        activity_uuid=activity.activity_uuid,
        message=response["output"],
    )



================================================
FILE: apps/api/src/services/ai/base.py
================================================
from typing import Optional, Dict, Any
from uuid import uuid4
import redis
import json
from openai import OpenAI

from config.config import get_learnhouse_config

LH_CONFIG = get_learnhouse_config()

def get_openai_client() -> OpenAI:
    """Get OpenAI client instance"""
    api_key = getattr(LH_CONFIG.ai_config, 'openai_api_key', None)
    if not api_key:
        raise Exception("OpenAI API key not configured")
    return OpenAI(api_key=api_key)

def ask_ai(
    question: str,
    message_history: Any,
    text_reference: str,
    message_for_the_prompt: str,
    openai_model_name: str,
) -> Dict[str, Any]:
    """
    Process an AI query using OpenAI SDK directly with course content as context
    """
    try:
        client = get_openai_client()
        
        # Build conversation history
        messages = []
        
        # Add system message with context
        system_content = f"{message_for_the_prompt}\n\nCourse Content Context:\n{text_reference}"
        messages.append({"role": "system", "content": system_content})
        
        # Add message history if available
        if hasattr(message_history, 'messages'):
            for msg in message_history.messages:
                if hasattr(msg, 'type') and hasattr(msg, 'content'):
                    role = "user" if msg.type == "human" else "assistant"
                    messages.append({"role": role, "content": msg.content})
        elif isinstance(message_history, list):
            # Handle simple list format
            for i, msg in enumerate(message_history):
                role = "user" if i % 2 == 0 else "assistant"
                if isinstance(msg, dict) and 'content' in msg:
                    messages.append({"role": role, "content": msg['content']})
                elif isinstance(msg, str):
                    messages.append({"role": role, "content": msg})
        
        # Add current question
        messages.append({"role": "user", "content": question})
        
        # Make API call to OpenAI
        response = client.chat.completions.create(
            model=openai_model_name,
            messages=messages,
            temperature=0.7,
            max_tokens=1000
        )
        
        return {
            "output": response.choices[0].message.content,
            "intermediate_steps": []
        }
        
    except Exception as e:
        raise Exception(f"Error processing AI request: {str(e)}")

def get_chat_session_history(aichat_uuid: Optional[str] = None) -> Dict[str, Any]:
    """Get or create a new chat session history using Redis"""
    session_id = aichat_uuid if aichat_uuid else f"aichat_{uuid4()}"
    
    LH_CONFIG = get_learnhouse_config()
    redis_conn_string = LH_CONFIG.redis_config.redis_connection_string

    message_history = []
    
    if redis_conn_string:
        try:
            # Connect to Redis and get message history
            r = redis.from_url(redis_conn_string)
            history_data = r.get(f"chat_history:{session_id}")
            if history_data:
                if isinstance(history_data, bytes):
                    message_history = json.loads(history_data.decode('utf-8'))
                elif isinstance(history_data, str):
                    message_history = json.loads(history_data)
                else:
                    message_history = []
        except Exception as e:
            print(f"Failed to connect to Redis: {e}, using empty history")
            message_history = []
    else:
        print("Redis connection string not found, using empty history")
        message_history = []

    return {
        "message_history": message_history,
        "aichat_uuid": session_id
    }

def save_message_to_history(aichat_uuid: str, user_message: str, ai_response: str):
    """Save a message exchange to Redis history"""
    LH_CONFIG = get_learnhouse_config()
    redis_conn_string = LH_CONFIG.redis_config.redis_connection_string
    
    if not redis_conn_string:
        return
    
    try:
        r = redis.from_url(redis_conn_string)
        
        # Get existing history
        history_data = r.get(f"chat_history:{aichat_uuid}")
        if history_data:
            if isinstance(history_data, bytes):
                history = json.loads(history_data.decode('utf-8'))
            elif isinstance(history_data, str):
                history = json.loads(history_data)
            else:
                history = []
        else:
            history = []
        
        # Add new messages
        history.append({"role": "user", "content": user_message})
        history.append({"role": "assistant", "content": ai_response})
        
        # Keep only last 20 messages to prevent unlimited growth
        if len(history) > 20:
            history = history[-20:]
        
        # Save back to Redis with TTL of 25 days
        r.setex(f"chat_history:{aichat_uuid}", 2160000, json.dumps(history))
        
    except Exception as e:
        print(f"Failed to save message to Redis: {e}")


================================================
FILE: apps/api/src/services/ai/init.py
================================================
from typing import Optional
from openai import OpenAI
from config.config import get_learnhouse_config

def get_openai_client() -> Optional[OpenAI]:
    """Get OpenAI client instance"""
    LH_CONFIG = get_learnhouse_config()
    api_key = getattr(LH_CONFIG.ai_config, 'openai_api_key', None)
    
    if not api_key:
        return None
        
    return OpenAI(api_key=api_key)


================================================
FILE: apps/api/src/services/ai/schemas/ai.py
================================================
from pydantic import BaseModel


class StartActivityAIChatSession(BaseModel):
    activity_uuid: str
    message: str

class ActivityAIChatSessionResponse(BaseModel):
    aichat_uuid: str
    activity_uuid: str
    message: str


class SendActivityAIChatMessage(BaseModel):
    aichat_uuid: str
    activity_uuid: str
    message: str



================================================
FILE: apps/api/src/services/auth/utils.py
================================================
import random
from typing import Optional
from fastapi import Depends, HTTPException, Request
import httpx
from sqlmodel import Session, select
from src.core.events.database import get_db_session
from src.db.users import User, UserCreate, UserRead
from src.security.auth import get_current_user
from src.services.users.users import create_user, create_user_without_org


async def get_google_user_info(access_token: str):
    url = "https://www.googleapis.com/oauth2/v3/userinfo"
    headers = {"Authorization": f"Bearer {access_token}"}
    async with httpx.AsyncClient() as client:
        response = await client.get(url, headers=headers)

    if response.status_code != 200:
        raise HTTPException(
            status_code=response.status_code,
            detail="Failed to fetch user info from Google",
        )

    return response.json()


async def signWithGoogle(
    request: Request,
    access_token: str,
    email: str,
    org_id: Optional[int] = None,
    current_user=Depends(get_current_user),
    db_session: Session = Depends(get_db_session),
):
    # Google
    google_user = await get_google_user_info(access_token)

    # Use Google email with fallback to parameter email
    user_email = google_user.get("email", email)
    
    # Validate we have a valid email
    if not user_email:
        raise HTTPException(
            status_code=400,
            detail="No email address available from Google or request"
        )

    user = db_session.exec(
        select(User).where(User.email == user_email)
    ).first()

    if not user:
        # Extract user data with safe defaults
        given_name = google_user.get("given_name", "")
        family_name = google_user.get("family_name", "")
        picture = google_user.get("picture", "")
        
        # Generate username more robustly
        username_parts = []
        if given_name:
            username_parts.append(given_name)
        if family_name:
            username_parts.append(family_name)
        
        # If no name parts available, use part of email
        if not username_parts and user_email and "@" in user_email:
            email_prefix = user_email.split("@")[0]
            if email_prefix:  # Make sure it's not empty
                username_parts.append(email_prefix)
        
        # If still no parts, use a default
        if not username_parts:
            username_parts.append("user")
        
        username = "".join(username_parts) + str(random.randint(10, 99))
        
        user_object = UserCreate(
            email=user_email,
            username=username,
            password="",
            first_name=given_name,
            last_name=family_name,
            avatar_image=picture,
        )

        if org_id is not None:
            user = await create_user(
                request, db_session, current_user, user_object, org_id
            )

            return user
        else:
            user = await create_user_without_org(
                request, db_session, current_user, user_object
            )

            return user

    return UserRead.model_validate(user)



================================================
FILE: apps/api/src/services/blocks/__init__.py
================================================
[Empty file]


================================================
FILE: apps/api/src/services/blocks/block_types/imageBlock/imageBlock.py
================================================
from datetime import datetime
from uuid import uuid4
from src.db.organizations import Organization
from fastapi import HTTPException, status, UploadFile, Request
from sqlmodel import Session, select
from src.db.courses.activities import Activity
from src.db.courses.blocks import Block, BlockRead, BlockTypeEnum
from src.db.courses.courses import Course
from src.services.blocks.utils.upload_files import upload_file_and_return_file_object
from src.services.users.users import PublicUser


async def create_image_block(
    request: Request, image_file: UploadFile, activity_uuid: str, db_session: Session
):
    statement = select(Activity).where(Activity.activity_uuid == activity_uuid)
    activity = db_session.exec(statement).first()

    if not activity:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND, detail="Activity not found"
        )

    block_type = "imageBlock"

    # get org_uuid 
    statement = select(Organization).where(Organization.id == activity.org_id)
    org = db_session.exec(statement).first()

    # get course
    statement = select(Course).where(Course.id == activity.course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND, detail="Course not found"
        )

    # get block id
    block_uuid = str(f"block_{uuid4()}")

    block_data = await upload_file_and_return_file_object(
        request,
        image_file,
        activity_uuid,
        block_uuid,
        ["jpg", "jpeg", "png", "gif", "webp"],
        block_type,
        org.org_uuid,
        str(course.course_uuid),
    )
    
    # create block
    block = Block(
        activity_id=activity.id if activity.id else 0,
        block_type=BlockTypeEnum.BLOCK_IMAGE,
        content=block_data.dict(),
        org_id=org.id if org.id else 0,
        course_id=course.id if course.id else 0,
        block_uuid=block_uuid,
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
    )

    # insert block
    db_session.add(block)
    db_session.commit()
    db_session.refresh(block)

    block = BlockRead.model_validate(block)

    return block


async def get_image_block(
    request: Request, block_uuid: str, current_user: PublicUser, db_session: Session
):
    statement = select(Block).where(Block.block_uuid == block_uuid)
    block = db_session.exec(statement).first()

    if block:

        block = BlockRead.from_orm(block)
        
        return block
    else:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT, detail="Image block does not exist"
        )



================================================
FILE: apps/api/src/services/blocks/block_types/pdfBlock/pdfBlock.py
================================================
from datetime import datetime
from uuid import uuid4
from src.db.organizations import Organization
from fastapi import HTTPException, status, UploadFile, Request
from sqlmodel import Session, select
from src.db.courses.activities import Activity
from src.db.courses.blocks import Block, BlockRead, BlockTypeEnum
from src.db.courses.courses import Course
from src.services.blocks.utils.upload_files import upload_file_and_return_file_object

from src.services.users.users import PublicUser


async def create_pdf_block(
    request: Request, pdf_file: UploadFile, activity_uuid: str, db_session: Session
):
    statement = select(Activity).where(Activity.activity_uuid == activity_uuid)
    activity = db_session.exec(statement).first()

    if not activity:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND, detail="Activity not found"
        )

    block_type = "pdfBlock"

    # get org_uuid
    statement = select(Organization).where(Organization.id == activity.org_id)
    org = db_session.exec(statement).first()

    # get course
    statement = select(Course).where(Course.id == activity.course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND, detail="Course not found"
        )

    # get block id
    block_uuid = str(f"block_{uuid4()}")

    block_data = await upload_file_and_return_file_object(
        request,
        pdf_file,
        activity_uuid,
        block_uuid,
        ["pdf"],
        block_type,
        org.org_uuid,
        str(course.course_uuid),
    )

    # create block
    block = Block(
        activity_id=activity.id if activity.id else 0,
        block_type=BlockTypeEnum.BLOCK_DOCUMENT_PDF,
        content=block_data.dict(),
        org_id=org.id if org.id else 0,
        course_id=course.id if course.id else 0,
        block_uuid=block_uuid,
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
    )

    # insert block
    db_session.add(block)
    db_session.commit()
    db_session.refresh(block)

    block = BlockRead.model_validate(block)

    return block


async def get_pdf_block(
    request: Request, block_uuid: str, current_user: PublicUser, db_session: Session
):
    statement = select(Block).where(Block.block_uuid == block_uuid)
    block = db_session.exec(statement).first()

    if not block:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND, detail="Video file does not exist"
        )

    block = BlockRead.model_validate(block)

    return block



================================================
FILE: apps/api/src/services/blocks/block_types/videoBlock/videoBlock.py
================================================
from datetime import datetime
from uuid import uuid4
from src.db.organizations import Organization
from fastapi import HTTPException, status, UploadFile, Request
from sqlmodel import Session, select
from src.db.courses.activities import Activity
from src.db.courses.blocks import Block, BlockRead, BlockTypeEnum
from src.db.courses.courses import Course
from src.services.blocks.utils.upload_files import upload_file_and_return_file_object

from src.services.users.users import PublicUser


async def create_video_block(
    request: Request, video_file: UploadFile, activity_uuid: str, db_session: Session
):
    statement = select(Activity).where(Activity.activity_uuid == activity_uuid)
    activity = db_session.exec(statement).first()

    if not activity:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND, detail="Activity not found"
        )

    block_type = "videoBlock"

    # get org_uuid
    statement = select(Organization).where(Organization.id == activity.org_id)
    org = db_session.exec(statement).first()

    # get course
    statement = select(Course).where(Course.id == activity.course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND, detail="Course not found"
        )

    # get block id
    block_uuid = str(f"block_{uuid4()}")

    block_data = await upload_file_and_return_file_object(
        request,
        video_file,
        activity_uuid,
        block_uuid,
        ["mp4", "webm", "ogg"],
        block_type,
        org.org_uuid,
        str(course.course_uuid),
    )

    # create block
    block = Block(
        activity_id=activity.id if activity.id else 0,
        block_type=BlockTypeEnum.BLOCK_VIDEO,
        content=block_data.dict(),
        org_id=org.id if org.id else 0,
        course_id=course.id if course.id else 0,
        block_uuid=block_uuid,
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
    )

    # insert block
    db_session.add(block)
    db_session.commit()
    db_session.refresh(block)

    block = BlockRead.model_validate(block)

    return block


async def get_video_block(
    request: Request, block_uuid: str, current_user: PublicUser, db_session: Session
):
    statement = select(Block).where(Block.block_uuid == block_uuid)
    block = db_session.exec(statement).first()

    if not block:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND, detail="Video file does not exist"
        )

    block = BlockRead.model_validate(block)

    return block



================================================
FILE: apps/api/src/services/blocks/schemas/blocks.py
================================================

from typing import Any, Literal
from pydantic import BaseModel


class Block(BaseModel):
    block_id: str
    activity_id: str
    course_id: str
    org_id: str
    block_type: Literal["quizBlock", "videoBlock", "pdfBlock", "imageBlock"]
    block_data: Any



================================================
FILE: apps/api/src/services/blocks/schemas/files.py
================================================
from pydantic import BaseModel


class BlockFile(BaseModel):
    file_id: str
    file_format: str
    file_name: str
    file_size: int
    file_type: str
    activity_uuid: str


================================================
FILE: apps/api/src/services/blocks/utils/upload_files.py
================================================
import uuid
from fastapi import HTTPException, Request, UploadFile
from src.services.blocks.schemas.files import BlockFile
from src.services.utils.upload_content import upload_file


async def upload_file_and_return_file_object(
    request: Request,
    file: UploadFile,
    activity_uuid: str,
    block_id: str,
    list_of_allowed_file_formats: list,
    type_of_block: str,
    org_uuid: str,
    course_uuid: str,
):
    """Upload file for blocks."""
    file_id = str(uuid.uuid4())
    
    # Map legacy format list to type system
    allowed_types = []
    if any(fmt in ['jpg', 'jpeg', 'png', 'gif', 'webp'] for fmt in list_of_allowed_file_formats):
        allowed_types.append('image')
    if any(fmt in ['mp4', 'webm'] for fmt in list_of_allowed_file_formats):
        allowed_types.append('video')
    if any(fmt in ['pdf'] for fmt in list_of_allowed_file_formats):
        allowed_types.append('document')
    
    if not allowed_types:
        raise HTTPException(status_code=400, detail="No valid file types specified")

    # Upload file
    filename = await upload_file(
        file=file,
        directory=f"courses/{course_uuid}/activities/{activity_uuid}/dynamic/blocks/{type_of_block}/{block_id}",
        type_of_dir='orgs',
        uuid=org_uuid,
        allowed_types=allowed_types,
        filename_prefix=f"block_{file_id}",
        max_size=50 * 1024 * 1024  # 50MB
    )

    # Get file metadata
    file.file.seek(0)
    content = await file.read()
    ext = filename.split(".")[-1] if "." in filename else "bin"

    return BlockFile(
        file_id=file_id,
        file_format=ext,
        file_name=file.filename,
        file_size=len(content),
        file_type=file.content_type,
        activity_uuid=activity_uuid,
    )



================================================
FILE: apps/api/src/services/courses/certifications.py
================================================
from typing import List
from uuid import uuid4
from datetime import datetime
from sqlmodel import Session, select
from fastapi import HTTPException, Request
from src.db.courses.certifications import (
    Certifications,
    CertificationCreate,
    CertificationRead,
    CertificationUpdate,
    CertificateUser,
    CertificateUserRead,
)
from src.db.courses.courses import Course
from src.db.courses.chapter_activities import ChapterActivity
from src.db.trail_steps import TrailStep
from src.db.users import PublicUser, AnonymousUser
from src.security.courses_security import courses_rbac_check_for_certifications


####################################################
# CRUD
####################################################


async def create_certification(
    request: Request,
    certification_object: CertificationCreate,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> CertificationRead:
    """Create a new certification for a course"""
    
    # Check if course exists
    statement = select(Course).where(Course.id == certification_object.course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # RBAC check
    await courses_rbac_check_for_certifications(request, course.course_uuid, current_user, "create", db_session)

    # Create certification
    certification = Certifications(
        course_id=certification_object.course_id,
        config=certification_object.config or {},
        certification_uuid=str(f"certification_{uuid4()}"),
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
    )

    # Insert certification in DB
    db_session.add(certification)
    db_session.commit()
    db_session.refresh(certification)

    return CertificationRead(**certification.model_dump())


async def get_certification(
    request: Request,
    certification_uuid: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> CertificationRead:
    """Get a single certification by certification_id"""
    
    statement = select(Certifications).where(Certifications.certification_uuid == certification_uuid)
    certification = db_session.exec(statement).first()

    if not certification:
        raise HTTPException(
            status_code=404,
            detail="Certification not found",
        )

    # Get course for RBAC check
    statement = select(Course).where(Course.id == certification.course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # RBAC check
    await courses_rbac_check_for_certifications(request, course.course_uuid, current_user, "read", db_session)

    return CertificationRead(**certification.model_dump())


async def get_certifications_by_course(
    request: Request,
    course_uuid: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> List[CertificationRead]:
    """Get all certifications for a course"""
    
    # Get course for RBAC check
    statement = select(Course).where(Course.course_uuid == course_uuid)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # RBAC check
    await courses_rbac_check_for_certifications(request, course_uuid, current_user, "read", db_session)

    # Get certifications for this course
    statement = select(Certifications).where(Certifications.course_id == course.id)
    certifications = db_session.exec(statement).all()

    return [CertificationRead(**certification.model_dump()) for certification in certifications]


async def update_certification(
    request: Request,
    certification_uuid: str,
    certification_object: CertificationUpdate,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> CertificationRead:
    """Update a certification"""
    
    statement = select(Certifications).where(Certifications.certification_uuid == certification_uuid)
    certification = db_session.exec(statement).first()

    if not certification:
        raise HTTPException(
            status_code=404,
            detail="Certification not found",
        )

    # Get course for RBAC check
    statement = select(Course).where(Course.id == certification.course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # RBAC check
    await courses_rbac_check_for_certifications(request, course.course_uuid, current_user, "update", db_session)

    # Update only the fields that were passed in
    for var, value in vars(certification_object).items():
        if value is not None:
            setattr(certification, var, value)

    # Update the update_date
    certification.update_date = str(datetime.now())

    db_session.add(certification)
    db_session.commit()
    db_session.refresh(certification)

    return CertificationRead(**certification.model_dump())


async def delete_certification(
    request: Request,
    certification_uuid: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> dict:
    """Delete a certification"""
    
    statement = select(Certifications).where(Certifications.certification_uuid == certification_uuid)
    certification = db_session.exec(statement).first()

    if not certification:
        raise HTTPException(
            status_code=404,
            detail="Certification not found",
        )

    # Get course for RBAC check
    statement = select(Course).where(Course.id == certification.course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # RBAC check
    await courses_rbac_check_for_certifications(request, course.course_uuid, current_user, "delete", db_session)

    db_session.delete(certification)
    db_session.commit()

    return {"detail": "Certification deleted successfully"}


####################################################
# Certificate User Functions
####################################################


async def create_certificate_user(
    request: Request,
    user_id: int,
    certification_id: int,
    db_session: Session,
    current_user: PublicUser | AnonymousUser | None = None,
) -> CertificateUserRead:
    """
    Create a certificate user link
    
    SECURITY NOTES:
    - This function should only be called by authorized users (course owners, instructors, or system)
    - When called from check_course_completion_and_create_certificate, it's a system operation
    - When called directly, requires proper RBAC checks
    """
    
    # Check if certification exists
    statement = select(Certifications).where(Certifications.id == certification_id)
    certification = db_session.exec(statement).first()

    if not certification:
        raise HTTPException(
            status_code=404,
            detail="Certification not found",
        )

    # SECURITY: If current_user is provided, perform RBAC check
    if current_user:
        # Get course for RBAC check
        statement = select(Course).where(Course.id == certification.course_id)
        course = db_session.exec(statement).first()

        if not course:
            raise HTTPException(
                status_code=404,
                detail="Course not found",
            )

        # Require course ownership or instructor role for creating certificates
        await courses_rbac_check_for_certifications(request, course.course_uuid, current_user, "create", db_session)

    # Check if certificate user already exists
    statement = select(CertificateUser).where(
        CertificateUser.user_id == user_id,
        CertificateUser.certification_id == certification_id
    )
    existing_certificate_user = db_session.exec(statement).first()

    if existing_certificate_user:
        raise HTTPException(
            status_code=400,
            detail="User already has a certificate for this course",
        )

    # Generate readable certificate user UUID
    current_year = datetime.now().year
    current_month = datetime.now().month
    current_day = datetime.now().day
    
    # Get user to extract user_uuid
    from src.db.users import User
    statement = select(User).where(User.id == user_id)
    user = db_session.exec(statement).first()
    
    if not user:
        raise HTTPException(
            status_code=404,
            detail="User not found",
        )
    
    # Extract last 4 characters from user_uuid for uniqueness (since all start with "user_")
    user_uuid_short = user.user_uuid[-4:] if user.user_uuid else "USER"
    
    # Generate random 2-letter prefix
    import random
    import string
    random_prefix = ''.join(random.choices(string.ascii_uppercase, k=2))
    
    # Get the count of existing certificate users for this user today
    today_user_prefix = f"{random_prefix}-{current_year}{current_month:02d}{current_day:02d}-{user_uuid_short}-"
    statement = select(CertificateUser).where(
        CertificateUser.user_certification_uuid.startswith(today_user_prefix)
    )
    existing_certificates = db_session.exec(statement).all()
    
    # Generate next sequential number for this user today
    next_number = len(existing_certificates) + 1
    certificate_number = f"{next_number:03d}"  # Format as 3-digit number with leading zeros
    
    user_certification_uuid = f"{today_user_prefix}{certificate_number}"

    # Create certificate user
    certificate_user = CertificateUser(
        user_id=user_id,
        certification_id=certification_id,
        user_certification_uuid=user_certification_uuid,
        created_at=str(datetime.now()),
        updated_at=str(datetime.now()),
    )

    db_session.add(certificate_user)
    db_session.commit()
    db_session.refresh(certificate_user)

    return CertificateUserRead(**certificate_user.model_dump())


async def get_user_certificates_for_course(
    request: Request,
    course_uuid: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> List[dict]:
    """Get all certificates for a user in a specific course with certification details"""
    
    # Check if course exists
    statement = select(Course).where(Course.course_uuid == course_uuid)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # RBAC check
    await courses_rbac_check_for_certifications(request, course_uuid, current_user, "read", db_session)

    # Get all certifications for this course
    statement = select(Certifications).where(Certifications.course_id == course.id)
    certifications = db_session.exec(statement).all()

    if not certifications:
        return []

    # Get all certificate users for this user and these certifications
    certification_ids = [cert.id for cert in certifications if cert.id]
    if not certification_ids:
        return []

    # Query certificate users for this user and these certifications
    result = []
    for cert_id in certification_ids:
        statement = select(CertificateUser).where(
            CertificateUser.user_id == current_user.id,
            CertificateUser.certification_id == cert_id
        )
        cert_user = db_session.exec(statement).first()
        if cert_user:
            # Get the associated certification
            statement = select(Certifications).where(Certifications.id == cert_id)
            certification = db_session.exec(statement).first()
            
            result.append({
                "certificate_user": CertificateUserRead(**cert_user.model_dump()),
                "certification": CertificationRead(**certification.model_dump()) if certification else None
            })

    return result


async def check_course_completion_and_create_certificate(
    request: Request,
    user_id: int,
    course_id: int,
    db_session: Session,
) -> bool:
    """
    Check if all activities in a course are completed and create certificate if so
    
    SECURITY NOTES:
    - This function is called by the system when activities are completed
    - It should only create certificates for users who have actually completed the course
    - The function is called from mark_activity_as_done_for_user which already has RBAC checks
    """
    
    # Get all activities in the course
    statement = select(ChapterActivity).where(ChapterActivity.course_id == course_id)
    course_activities = db_session.exec(statement).all()
    
    if not course_activities:
        return False  # No activities in course
    
    # Get all completed activities for this user in this course
    statement = select(TrailStep).where(
        TrailStep.user_id == user_id,
        TrailStep.course_id == course_id,
        TrailStep.complete == True
    )
    completed_activities = db_session.exec(statement).all()
    
    # Check if all activities are completed
    if len(completed_activities) >= len(course_activities):
        # All activities completed, check if certification exists for this course
        statement = select(Certifications).where(Certifications.course_id == course_id)
        certification = db_session.exec(statement).first()
        
        if certification and certification.id:
            # SECURITY: Create certificate user link (system operation, no RBAC needed here)
            # This is called from mark_activity_as_done_for_user which already has proper RBAC checks
            try:
                await create_certificate_user(request, user_id, certification.id, db_session)
                return True
            except HTTPException as e:
                if e.status_code == 400 and "already has a certificate" in e.detail:
                    # Certificate already exists, which is fine
                    return True
                else:
                    raise e
        
    return False


async def get_certificate_by_user_certification_uuid(
    request: Request,
    user_certification_uuid: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> dict:
    """Get a certificate by user_certification_uuid with certification details"""
    
    # Get certificate user by user_certification_uuid
    statement = select(CertificateUser).where(
        CertificateUser.user_certification_uuid == user_certification_uuid
    )
    certificate_user = db_session.exec(statement).first()

    if not certificate_user:
        raise HTTPException(
            status_code=404,
            detail="Certificate not found",
        )

    # Get the associated certification
    statement = select(Certifications).where(Certifications.id == certificate_user.certification_id)
    certification = db_session.exec(statement).first()

    if not certification:
        raise HTTPException(
            status_code=404,
            detail="Certification not found",
        )

    # Get course information
    statement = select(Course).where(Course.id == certification.course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # No RBAC check - allow anyone to access certificates by UUID

    return {
        "certificate_user": CertificateUserRead(**certificate_user.model_dump()),
        "certification": CertificationRead(**certification.model_dump()),
        "course": {
            "id": course.id,
            "course_uuid": course.course_uuid,
            "name": course.name,
            "description": course.description,
            "thumbnail_image": course.thumbnail_image,
        }
    }


async def get_all_user_certificates(
    request: Request,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> List[dict]:
    """Get all certificates for the current user with complete linked information"""
    
    # Get all certificate users for this user
    statement = select(CertificateUser).where(CertificateUser.user_id == current_user.id)
    certificate_users = db_session.exec(statement).all()

    if not certificate_users:
        return []

    result = []
    for cert_user in certificate_users:
        # Get the associated certification
        statement = select(Certifications).where(Certifications.id == cert_user.certification_id)
        certification = db_session.exec(statement).first()

        if not certification:
            continue

        # Get course information
        statement = select(Course).where(Course.id == certification.course_id)
        course = db_session.exec(statement).first()

        if not course:
            continue

        # Get user information
        from src.db.users import User
        statement = select(User).where(User.id == cert_user.user_id)
        user = db_session.exec(statement).first()

        result.append({
            "certificate_user": CertificateUserRead(**cert_user.model_dump()),
            "certification": CertificationRead(**certification.model_dump()),
            "course": {
                "id": course.id,
                "course_uuid": course.course_uuid,
                "name": course.name,
                "description": course.description,
                "thumbnail_image": course.thumbnail_image,
            },
            "user": {
                "id": user.id if user else None,
                "user_uuid": user.user_uuid if user else None,
                "username": user.username if user else None,
                "email": user.email if user else None,
                "first_name": user.first_name if user else None,
                "last_name": user.last_name if user else None,
            } if user else None
        })

    return result 


================================================
FILE: apps/api/src/services/courses/chapters.py
================================================
from datetime import datetime
from typing import List
from uuid import uuid4
from sqlmodel import Session, select
from src.db.users import AnonymousUser, PublicUser
from src.db.courses.course_chapters import CourseChapter
from src.db.courses.activities import Activity, ActivityRead
from src.db.courses.chapter_activities import ChapterActivity
from src.db.courses.chapters import (
    Chapter,
    ChapterCreate,
    ChapterRead,
    ChapterUpdate,
    ChapterUpdateOrder,
)
from src.db.courses.courses import Course
from fastapi import HTTPException, status, Request
from src.security.courses_security import courses_rbac_check_for_chapters


####################################################
# CRUD
####################################################


async def create_chapter(
    request: Request,
    chapter_object: ChapterCreate,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> ChapterRead:
    chapter = Chapter.model_validate(chapter_object)

    # Get COurse
    statement = select(Course).where(Course.id == chapter_object.course_id)

    course = db_session.exec(statement).one()

    # RBAC check
    await courses_rbac_check_for_chapters(request, course.course_uuid, current_user, "create", db_session)

    # complete chapter object
    chapter.course_id = chapter_object.course_id
    chapter.chapter_uuid = f"chapter_{uuid4()}"
    chapter.creation_date = str(datetime.now())
    chapter.update_date = str(datetime.now())
    chapter.org_id = course.org_id

    # Find the last chapter in the course and add it to the list
    statement = (
        select(CourseChapter)
        .where(CourseChapter.course_id == chapter.course_id)
        .order_by(CourseChapter.order) # type: ignore
    )
    course_chapters = db_session.exec(statement).all()

    # get last chapter order
    last_order = course_chapters[-1].order if course_chapters else 0
    to_be_used_order = last_order + 1

    # Add chapter to database
    db_session.add(chapter)
    db_session.commit()
    db_session.refresh(chapter)

    chapter = ChapterRead(**chapter.model_dump(), activities=[])

    # Check if COurseChapter link exists

    statement = (
        select(CourseChapter)
        .where(CourseChapter.chapter_id == chapter.id)
        .where(CourseChapter.course_id == chapter.course_id)
        .where(CourseChapter.order == to_be_used_order)
    )
    course_chapter = db_session.exec(statement).first()

    if not course_chapter:
        # Add CourseChapter link
        course_chapter = CourseChapter(
            course_id=chapter.course_id,
            chapter_id=chapter.id,
            org_id=chapter.org_id,
            creation_date=str(datetime.now()),
            update_date=str(datetime.now()),
            order=to_be_used_order,
        )

        # Insert CourseChapter link in DB
        db_session.add(course_chapter)
        db_session.commit()

    return chapter


async def get_chapter(
    request: Request,
    chapter_id: int,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> ChapterRead:
    statement = select(Chapter).where(Chapter.id == chapter_id)
    chapter = db_session.exec(statement).first()

    if not chapter:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT, detail="Chapter does not exist"
        )

    # get COurse
    statement = select(Course).where(Course.id == chapter.course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT, detail="Course does not exist"
        )

    # RBAC check
    await courses_rbac_check_for_chapters(request, course.course_uuid, current_user, "read", db_session)

    # Get activities for this chapter
    statement = (
        select(Activity)
        .join(ChapterActivity, Activity.id == ChapterActivity.activity_id) # type: ignore
        .where(ChapterActivity.chapter_id == chapter_id)
        .distinct(Activity.id) # type: ignore
    )

    activities = db_session.exec(statement).all()

    chapter = ChapterRead(
        **chapter.model_dump(),
        activities=[ActivityRead(**activity.model_dump()) for activity in activities],
    )

    return chapter


async def update_chapter(
    request: Request,
    chapter_object: ChapterUpdate,
    chapter_id: int,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> ChapterRead:
    statement = select(Chapter).where(Chapter.id == chapter_id)
    chapter = db_session.exec(statement).first()

    if not chapter:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT, detail="Chapter does not exist"
        )

    # RBAC check
    await courses_rbac_check_for_chapters(request, chapter.chapter_uuid, current_user, "update", db_session)

    # Update only the fields that were passed in
    for var, value in vars(chapter_object).items():
        if value is not None:
            setattr(chapter, var, value)

    chapter.update_date = str(datetime.now())

    db_session.commit()
    db_session.refresh(chapter)

    if chapter:
        chapter = await get_chapter(
            request, chapter.id, current_user, db_session  # type: ignore
        )

    return chapter


async def delete_chapter(
    request: Request,
    chapter_id: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    statement = select(Chapter).where(Chapter.id == chapter_id)
    chapter = db_session.exec(statement).first()

    if not chapter:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT, detail="Chapter does not exist"
        )

    # RBAC check
    await courses_rbac_check_for_chapters(request, chapter.chapter_uuid, current_user, "delete", db_session)

    # Remove all linked chapter activities
    statement = select(ChapterActivity).where(ChapterActivity.chapter_id == chapter.id)
    chapter_activities = db_session.exec(statement).all()

    for chapter_activity in chapter_activities:
        db_session.delete(chapter_activity)

    # Delete the chapter
    db_session.delete(chapter)
    db_session.commit()

    return {"detail": "chapter deleted"}


async def get_course_chapters(
    request: Request,
    course_id: int,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    with_unpublished_activities: bool,
    page: int = 1,
    limit: int = 10,
) -> List[ChapterRead]:

    statement = select(Course).where(Course.id == course_id)
    course = db_session.exec(statement).first()

    statement = (
        select(Chapter)
        .join(CourseChapter, Chapter.id == CourseChapter.chapter_id) # type: ignore
        .where(CourseChapter.course_id == course_id)
        .where(Chapter.course_id == course_id)
        .order_by(CourseChapter.order) # type: ignore
        .group_by(Chapter.id, CourseChapter.order) # type: ignore
    )
    chapters = db_session.exec(statement).all()

    chapters = [ChapterRead(**chapter.model_dump(), activities=[]) for chapter in chapters]

    # RBAC check
    await courses_rbac_check_for_chapters(request, course.course_uuid, current_user, "read", db_session)  # type: ignore

    # Get activities for each chapter
    for chapter in chapters:
        statement = (
            select(ChapterActivity)
            .where(ChapterActivity.chapter_id == chapter.id)
            .order_by(ChapterActivity.order) # type: ignore
            .distinct(ChapterActivity.id, ChapterActivity.order) # type: ignore
        )
        chapter_activities = db_session.exec(statement).all()

        for chapter_activity in chapter_activities:
            statement = (
                select(Activity)
                .where(Activity.id == chapter_activity.activity_id, with_unpublished_activities or Activity.published == True)
                .distinct(Activity.id) # type: ignore
            )
            activity = db_session.exec(statement).first()

            if activity:
                chapter.activities.append(ActivityRead(**activity.model_dump()))

    return chapters


# Important Note : this is legacy code that has been used because
# the frontend is still not adapted for the new data structure, this implementation is absolutely not the best one
# and should not be used for future features
async def DEPRECEATED_get_course_chapters(
    request: Request,
    course_uuid: str,
    current_user: PublicUser,
    db_session: Session,
):
    statement = select(Course).where(Course.course_uuid == course_uuid)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT, detail="Course does not exist"
        )

    # RBAC check
    await courses_rbac_check_for_chapters(request, course.course_uuid, current_user, "read", db_session)

    chapters_in_db = await get_course_chapters(request, course.id, db_session, current_user)  # type: ignore

    # activities

    # chapters
    chapters = {}

    for chapter in chapters_in_db:
        chapter_activityIds = []

        for activity in chapter.activities:
            print("test", activity)
            chapter_activityIds.append(activity.activity_uuid)

        chapters[chapter.chapter_uuid] = {
            "uuid": chapter.chapter_uuid,
            "id": chapter.id,
            "name": chapter.name,
            "activityIds": chapter_activityIds,
        }

    # activities
    activities_list = {}
    statement = (
        select(Activity)
        .join(ChapterActivity, ChapterActivity.activity_id == Activity.id) # type: ignore
        .where(ChapterActivity.activity_id == Activity.id)
        .group_by(Activity.id) # type: ignore
    )
    activities_in_db = db_session.exec(statement).all()

    for activity in activities_in_db:
        activities_list[activity.activity_uuid] = {
            "uuid": activity.activity_uuid,
            "id": activity.id,
            "name": activity.name,
            "type": activity.activity_type,
            "content": activity.content,
        }

    # get chapter order
    statement = (
        select(Chapter)
        .join(CourseChapter, CourseChapter.chapter_id == Chapter.id) # type: ignore
        .where(CourseChapter.chapter_id == Chapter.id)
        .group_by(Chapter.id, CourseChapter.order) # type: ignore
        .order_by(CourseChapter.order) # type: ignore
    )
    chapters_in_db = db_session.exec(statement).all()

    chapterOrder = []

    for chapter in chapters_in_db:
        chapterOrder.append(chapter.chapter_uuid)

    final = {
        "chapters": chapters,
        "chapterOrder": chapterOrder,
        "activities": activities_list,
    }

    return final


async def reorder_chapters_and_activities(
    request: Request,
    course_uuid: str,
    chapters_order: ChapterUpdateOrder,
    current_user: PublicUser,
    db_session: Session,
):
    statement = select(Course).where(Course.course_uuid == course_uuid)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT, detail="Course does not exist"
        )

    # RBAC check
    await courses_rbac_check_for_chapters(request, course.course_uuid, current_user, "update", db_session)

    ###########
    # Chapters
    ###########

    # Get all existing course chapters
    statement = select(CourseChapter).where(
        CourseChapter.course_id == course.id,
        CourseChapter.org_id == course.org_id
    )
    existing_course_chapters = db_session.exec(statement).all()

    # Create a map of existing chapters for faster lookup
    existing_chapter_map = {cc.chapter_id: cc for cc in existing_course_chapters}

    # Update or create course chapters based on new order
    for index, chapter_order in enumerate(chapters_order.chapter_order_by_ids):
        if chapter_order.chapter_id in existing_chapter_map:
            # Update existing chapter order
            course_chapter = existing_chapter_map[chapter_order.chapter_id]
            course_chapter.order = index
            db_session.add(course_chapter)
        else:
            # Create new course chapter
            course_chapter = CourseChapter(
                chapter_id=chapter_order.chapter_id,
                course_id=course.id, # type: ignore
                org_id=course.org_id,
                creation_date=str(datetime.now()),
                update_date=str(datetime.now()),
                order=index,
            )
            db_session.add(course_chapter)
        
        db_session.commit()

    # Remove chapters that are no longer in the order
    chapter_ids_to_keep = {co.chapter_id for co in chapters_order.chapter_order_by_ids}
    for cc in existing_course_chapters:
        if cc.chapter_id not in chapter_ids_to_keep:
            db_session.delete(cc)
    db_session.commit()

    ###########
    # Activities
    ###########

    # Get all existing chapter activities
    statement = select(ChapterActivity).where(
        ChapterActivity.course_id == course.id,
        ChapterActivity.org_id == course.org_id
    )
    existing_chapter_activities = db_session.exec(statement).all()

    # Create a map for faster lookup
    existing_activity_map = {
        (ca.chapter_id, ca.activity_id): ca 
        for ca in existing_chapter_activities
    }

    # Track which activities we want to keep
    activities_to_keep = set()

    # Update or create chapter activities based on new order
    for chapter_order in chapters_order.chapter_order_by_ids:
        for index, activity_order in enumerate(chapter_order.activities_order_by_ids):
            activity_key = (chapter_order.chapter_id, activity_order.activity_id)
            activities_to_keep.add(activity_key)

            if activity_key in existing_activity_map:
                # Update existing activity order
                chapter_activity = existing_activity_map[activity_key]
                chapter_activity.order = index
                db_session.add(chapter_activity)
            else:
                # Create new chapter activity
                chapter_activity = ChapterActivity(
                    chapter_id=chapter_order.chapter_id,
                    activity_id=activity_order.activity_id,
                    org_id=course.org_id,
                    course_id=course.id, # type: ignore
                    creation_date=str(datetime.now()),
                    update_date=str(datetime.now()),
                    order=index,
                )
                db_session.add(chapter_activity)
            
            db_session.commit()

    # Remove activities that are no longer in any chapter
    for ca in existing_chapter_activities:
        if (ca.chapter_id, ca.activity_id) not in activities_to_keep:
            db_session.delete(ca)
    db_session.commit()

    return {"detail": "Chapters and activities reordered successfully"}



================================================
FILE: apps/api/src/services/courses/collections.py
================================================
from datetime import datetime
from typing import List
from uuid import uuid4
from sqlmodel import Session, select
from src.db.users import AnonymousUser, PublicUser
from src.db.collections import (
    Collection,
    CollectionCreate,
    CollectionRead,
    CollectionUpdate,
)
from src.db.collections_courses import CollectionCourse
from src.db.courses.courses import Course
from fastapi import HTTPException, status, Request
from src.security.courses_security import courses_rbac_check_for_collections


####################################################
# CRUD
####################################################


async def get_collection(
    request: Request,
    collection_uuid: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> CollectionRead:
    statement = select(Collection).where(Collection.collection_uuid == collection_uuid)
    collection = db_session.exec(statement).first()

    if not collection:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT, detail="Collection does not exist"
        )

    # RBAC check
    await courses_rbac_check_for_collections(
        request, collection.collection_uuid, current_user, "read", db_session
    )

    # get courses in collection
    statement_all = (
        select(Course)
        .join(CollectionCourse)
        .where(
            CollectionCourse.collection_id == collection.id,
            CollectionCourse.org_id == collection.org_id
        )
        .distinct()
    )

    statement_public = (
        select(Course)
        .join(CollectionCourse)
        .where(
            CollectionCourse.collection_id == collection.id,
            CollectionCourse.org_id == collection.org_id,
            Course.public == True
        )
        .distinct()
    )

    if current_user.user_uuid == "user_anonymous":
        statement = statement_public
    else:
        statement = statement_all

    courses = list(db_session.exec(statement).all())

    collection = CollectionRead(**collection.model_dump(), courses=courses)

    return collection


async def create_collection(
    request: Request,
    collection_object: CollectionCreate,
    current_user: PublicUser,
    db_session: Session,
) -> CollectionRead:
    collection = Collection.model_validate(collection_object)

    # SECURITY: Check if user has permission to create collections in this organization
    # Since collections are organization-level resources, we need to check org permissions
    # For now, we'll use the existing RBAC check but with proper organization context
    await courses_rbac_check_for_collections(request, "collection_x", current_user, "create", db_session)

    # Complete the collection object
    collection.collection_uuid = f"collection_{uuid4()}"
    collection.creation_date = str(datetime.now())
    collection.update_date = str(datetime.now())

    # Add collection to database
    db_session.add(collection)
    db_session.commit()
    db_session.refresh(collection)

    # SECURITY: Link courses to collection - ensure user has access to all courses being added
    if collection:
        for course_id in collection_object.courses:
            # Check if user has access to this course
            statement = select(Course).where(Course.id == course_id)
            course = db_session.exec(statement).first()
            
            if course:
                # Verify user has read access to the course before adding it to collection
                try:
                    await courses_rbac_check_for_collections(request, course.course_uuid, current_user, "read", db_session)
                except HTTPException:
                    raise HTTPException(
                        status_code=403,
                        detail=f"You don't have permission to add course {course.name} to this collection"
                    )
                
                collection_course = CollectionCourse(
                    collection_id=int(collection.id),  # type: ignore
                    course_id=course_id,
                    org_id=int(collection_object.org_id),
                    creation_date=str(datetime.now()),
                    update_date=str(datetime.now()),
                )
                # Add collection_course to database
                db_session.add(collection_course)

    db_session.commit()
    db_session.refresh(collection)

    # Get courses once again
    statement = (
        select(Course)
        .join(CollectionCourse)
        .where(CollectionCourse.collection_id == collection.id)
        .distinct()
    )
    courses = list(db_session.exec(statement).all())

    collection = CollectionRead(**collection.model_dump(), courses=courses)

    return CollectionRead.model_validate(collection)


async def update_collection(
    request: Request,
    collection_object: CollectionUpdate,
    collection_uuid: str,
    current_user: PublicUser,
    db_session: Session,
) -> CollectionRead:
    statement = select(Collection).where(Collection.collection_uuid == collection_uuid)
    collection = db_session.exec(statement).first()

    if not collection:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT, detail="Collection does not exist"
        )

    # RBAC check
    await courses_rbac_check_for_collections(
        request, collection.collection_uuid, current_user, "update", db_session
    )

    courses = collection_object.courses

    del collection_object.courses

    # Update only the fields that were passed in
    for var, value in vars(collection_object).items():
        if value is not None:
            setattr(collection, var, value)

    collection.update_date = str(datetime.now())

    # Update only the fields that were passed in
    for var, value in vars(collection_object).items():
        if value is not None:
            setattr(collection, var, value)

    statement = select(CollectionCourse).where(
        CollectionCourse.collection_id == collection.id
    )
    collection_courses = db_session.exec(statement).all()

    # Delete all collection_courses
    for collection_course in collection_courses:
        db_session.delete(collection_course)

    # Add new collection_courses
    for course in courses or []:
        collection_course = CollectionCourse(
            collection_id=int(collection.id),  # type: ignore
            course_id=int(course),
            org_id=int(collection.org_id),
            creation_date=str(datetime.now()),
            update_date=str(datetime.now()),
        )
        # Add collection_course to database
        db_session.add(collection_course)

    db_session.commit()
    db_session.refresh(collection)

    # Get courses once again
    statement = (
        select(Course)
        .join(CollectionCourse)
        .where(CollectionCourse.collection_id == collection.id)
        .distinct()
    )
    courses = list(db_session.exec(statement).all())

    collection = CollectionRead(**collection.model_dump(), courses=courses)

    return collection


async def delete_collection(
    request: Request,
    collection_uuid: str,
    current_user: PublicUser,
    db_session: Session,
):
    statement = select(Collection).where(Collection.collection_uuid == collection_uuid)
    collection = db_session.exec(statement).first()

    if not collection:
        raise HTTPException(
            status_code=404,
            detail="Collection not found",
        )

    # RBAC check
    await courses_rbac_check_for_collections(
        request, collection.collection_uuid, current_user, "delete", db_session
    )

    # delete collection from database
    db_session.delete(collection)
    db_session.commit()

    return {"detail": "Collection deleted"}


####################################################
# Misc
####################################################


async def get_collections(
    request: Request,
    org_id: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
    page: int = 1,
    limit: int = 10,
) -> List[CollectionRead]:

    statement_public = select(Collection).where(
        Collection.org_id == org_id, Collection.public == True
    )
    statement_all = (
        select(Collection).where(Collection.org_id == org_id).distinct(Collection.id) # type: ignore
    )

    if current_user.id == 0:
        statement = statement_public
    else:
        statement = statement_all

    collections = db_session.exec(statement).all()

    collections_with_courses = []

    for collection in collections:
        statement_all = (
            select(Course)
            .join(CollectionCourse)
            .where(
                CollectionCourse.collection_id == collection.id,
                CollectionCourse.org_id == collection.org_id
            )
            .distinct()
        )
        statement_public = (
            select(Course)
            .join(CollectionCourse)
            .where(
                CollectionCourse.collection_id == collection.id,
                CollectionCourse.org_id == org_id,
                Course.public == True
            )
            .distinct()
        )
        if current_user.id == 0:
            statement = statement_public
        else:
            # RBAC check
            statement = statement_all

        courses = db_session.exec(statement).all()

        collection = CollectionRead(**collection.model_dump(), courses=list(courses))
        collections_with_courses.append(collection)

    return collections_with_courses



================================================
FILE: apps/api/src/services/courses/contributors.py
================================================
from datetime import datetime
from fastapi import HTTPException, Request
from sqlmodel import Session, select, and_
from src.db.users import PublicUser, AnonymousUser, User, UserRead
from src.db.courses.courses import Course
from src.db.resource_authors import ResourceAuthor, ResourceAuthorshipEnum, ResourceAuthorshipStatusEnum
from src.security.rbac.rbac import authorization_verify_if_user_is_anon
from src.security.courses_security import courses_rbac_check
from typing import List


async def apply_course_contributor(
    request: Request,
    course_uuid: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    """
    Apply to become a course contributor
    
    SECURITY NOTES:
    - Any authenticated user can apply to become a contributor
    - Applications are created with PENDING status
    - Only course owners (CREATOR, MAINTAINER) or admins can approve applications
    """
    # Verify user is not anonymous
    await authorization_verify_if_user_is_anon(current_user.id)

    # Check if course exists
    statement = select(Course).where(Course.course_uuid == course_uuid)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # Check if user already has any authorship role for this course
    existing_authorship = db_session.exec(
        select(ResourceAuthor).where(
            and_(
                ResourceAuthor.resource_uuid == course_uuid,
                ResourceAuthor.user_id == current_user.id
            )
        )
    ).first()

    if existing_authorship:
        raise HTTPException(
            status_code=400,
            detail="You already have an authorship role for this course",
        )

    # Create pending contributor application
    resource_author = ResourceAuthor(
        resource_uuid=course_uuid,
        user_id=current_user.id,
        authorship=ResourceAuthorshipEnum.CONTRIBUTOR,
        authorship_status=ResourceAuthorshipStatusEnum.PENDING,
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
    )

    db_session.add(resource_author)
    db_session.commit()
    db_session.refresh(resource_author)

    return {
        "detail": "Contributor application submitted successfully",
        "status": "pending"
    }

async def update_course_contributor(
    request: Request,
    course_uuid: str,
    contributor_user_id: int,
    authorship: ResourceAuthorshipEnum,
    authorship_status: ResourceAuthorshipStatusEnum,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    """
    Update a course contributor's role and status
    
    SECURITY NOTES:
    - Only course owners (CREATOR, MAINTAINER) or admins can update contributors
    - Cannot modify the role of the course creator
    - Requires strict course ownership checks
    """
    # Verify user is not anonymous
    await authorization_verify_if_user_is_anon(current_user.id)

    # SECURITY: Require course ownership or admin role for updating contributors
    await courses_rbac_check(request, course_uuid, current_user, "update", db_session)

    # Check if course exists
    statement = select(Course).where(Course.course_uuid == course_uuid)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # Check if the contributor exists for this course
    existing_authorship = db_session.exec(
        select(ResourceAuthor).where(
            and_(
                ResourceAuthor.resource_uuid == course_uuid,
                ResourceAuthor.user_id == contributor_user_id
            )
        )
    ).first()

    if not existing_authorship:
        raise HTTPException(
            status_code=404,
            detail="Contributor not found for this course",
        )

    # SECURITY: Don't allow changing the role of the creator
    if existing_authorship.authorship == ResourceAuthorshipEnum.CREATOR:
        raise HTTPException(
            status_code=400,
            detail="Cannot modify the role of the course creator",
        )

    # Update the contributor's role and status
    existing_authorship.authorship = authorship
    existing_authorship.authorship_status = authorship_status
    existing_authorship.update_date = str(datetime.now())

    db_session.add(existing_authorship)
    db_session.commit()
    db_session.refresh(existing_authorship)

    return {
        "detail": "Contributor updated successfully",
        "status": "success"
    }

async def get_course_contributors(
    request: Request,
    course_uuid: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> List[dict]:
    """
    Get all contributors for a course with their user information
    
    SECURITY NOTES:
    - Requires read access to the course
    - Contributors are visible to anyone with course read access
    """
    # Check if course exists
    statement = select(Course).where(Course.course_uuid == course_uuid)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # SECURITY: Require read access to the course
    await courses_rbac_check(request, course_uuid, current_user, "read", db_session)

    # Get all contributors for this course with user information
    statement = (
        select(ResourceAuthor, User)
        .join(User)  # SQLModel will automatically join on foreign key
        .where(ResourceAuthor.resource_uuid == course_uuid)
    )
    results = db_session.exec(statement).all()

    return [
        {
            "user_id": contributor.user_id,
            "authorship": contributor.authorship,
            "authorship_status": contributor.authorship_status,
            "creation_date": contributor.creation_date,
            "update_date": contributor.update_date,
            "user": UserRead.model_validate(user).model_dump()
        }
        for contributor, user in results
    ]

async def add_bulk_course_contributors(
    request: Request,
    course_uuid: str,
    usernames: List[str],
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    """
    Add multiple contributors to a course by their usernames
    
    SECURITY NOTES:
    - Only course owners (CREATOR, MAINTAINER) or admins can add contributors
    - Requires strict course ownership checks
    - Cannot add contributors to courses the user doesn't own
    """
    # Verify user is not anonymous
    await authorization_verify_if_user_is_anon(current_user.id)

    # SECURITY: Require course ownership or admin role for adding contributors
    await courses_rbac_check(request, course_uuid, current_user, "update", db_session)

    # Check if course exists
    statement = select(Course).where(Course.course_uuid == course_uuid)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # Process results
    results = {
        "successful": [],
        "failed": []
    }
    
    current_time = str(datetime.now())

    for username in usernames:
        try:
            # Find user by username
            user_statement = select(User).where(User.username == username)
            user = db_session.exec(user_statement).first()

            if not user or user.id is None:
                results["failed"].append({
                    "username": username,
                    "reason": "User not found or invalid"
                })
                continue

            # Check if user already has any authorship role for this course
            existing_authorship = db_session.exec(
                select(ResourceAuthor).where(
                    and_(
                        ResourceAuthor.resource_uuid == course_uuid,
                        ResourceAuthor.user_id == user.id
                    )
                )
            ).first()

            if existing_authorship:
                results["failed"].append({
                    "username": username,
                    "reason": "User already has an authorship role for this course"
                })
                continue

            # Create contributor
            resource_author = ResourceAuthor(
                resource_uuid=course_uuid,
                user_id=user.id,
                authorship=ResourceAuthorshipEnum.CONTRIBUTOR,
                authorship_status=ResourceAuthorshipStatusEnum.PENDING,
                creation_date=current_time,
                update_date=current_time,
            )

            db_session.add(resource_author)
            db_session.commit()
            db_session.refresh(resource_author)

            results["successful"].append({
                "username": username,
                "user_id": user.id
            })

        except Exception as e:
            results["failed"].append({
                "username": username,
                "reason": str(e)
            })
            
    return results 

async def remove_bulk_course_contributors(
    request: Request,
    course_uuid: str,
    usernames: List[str],
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    """
    Remove multiple contributors from a course by their usernames
    
    SECURITY NOTES:
    - Only course owners (CREATOR, MAINTAINER) or admins can remove contributors
    - Requires strict course ownership checks
    - Cannot remove contributors from courses the user doesn't own
    - Cannot remove the course creator
    """
    # Verify user is not anonymous
    await authorization_verify_if_user_is_anon(current_user.id)

    # SECURITY: Require course ownership or admin role for removing contributors
    await courses_rbac_check(request, course_uuid, current_user, "update", db_session)

    # Check if course exists
    statement = select(Course).where(Course.course_uuid == course_uuid)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # Process results
    results = {
        "successful": [],
        "failed": []
    }

    for username in usernames:
        try:
            # Find user by username
            user_statement = select(User).where(User.username == username)
            user = db_session.exec(user_statement).first()

            if not user or user.id is None:
                results["failed"].append({
                    "username": username,
                    "reason": "User not found or invalid"
                })
                continue

            # Check if user has any authorship role for this course
            existing_authorship = db_session.exec(
                select(ResourceAuthor).where(
                    and_(
                        ResourceAuthor.resource_uuid == course_uuid,
                        ResourceAuthor.user_id == user.id
                    )
                )
            ).first()

            if not existing_authorship:
                results["failed"].append({
                    "username": username,
                    "reason": "User is not a contributor for this course"
                })
                continue

            # SECURITY: Don't allow removing the creator
            if existing_authorship.authorship == ResourceAuthorshipEnum.CREATOR:
                results["failed"].append({
                    "username": username,
                    "reason": "Cannot remove the course creator"
                })
                continue

            # Remove the contributor
            db_session.delete(existing_authorship)
            db_session.commit()

            results["successful"].append({
                "username": username,
                "user_id": user.id
            })

        except Exception as e:
            results["failed"].append({
                "username": username,
                "reason": str(e)
            })
            
    return results 


================================================
FILE: apps/api/src/services/courses/courses.py
================================================
from typing import List
from uuid import uuid4
from sqlmodel import Session, select, or_, and_, text
from src.db.usergroup_resources import UserGroupResource
from src.db.usergroup_user import UserGroupUser
from src.db.organizations import Organization
from src.security.features_utils.usage import (
    check_limits_with_usage,
    decrease_feature_usage,
    increase_feature_usage,
)
from src.db.resource_authors import ResourceAuthor, ResourceAuthorshipEnum, ResourceAuthorshipStatusEnum
from src.db.users import PublicUser, AnonymousUser, User, UserRead
from src.db.courses.courses import (
    Course,
    CourseCreate,
    CourseRead,
    CourseUpdate,
    FullCourseRead,
    AuthorWithRole,
    ThumbnailType,
)
from src.security.rbac.rbac import (
    authorization_verify_if_user_is_anon,
    authorization_verify_based_on_org_admin_status,
)
from src.services.courses.thumbnails import upload_thumbnail
from fastapi import HTTPException, Request, UploadFile, status
from datetime import datetime
from src.security.courses_security import courses_rbac_check


async def get_course(
    request: Request,
    course_uuid: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    statement = select(Course).where(Course.course_uuid == course_uuid)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # RBAC check
    await courses_rbac_check(request, course.course_uuid, current_user, "read", db_session)

    # Get course authors with their roles
    authors_statement = (
        select(ResourceAuthor, User)
        .join(User, ResourceAuthor.user_id == User.id) # type: ignore
        .where(ResourceAuthor.resource_uuid == course.course_uuid)
        .order_by(
            ResourceAuthor.id.asc() # type: ignore  
        )
    )
    author_results = db_session.exec(authors_statement).all()

    # Convert to AuthorWithRole objects
    authors = [
        AuthorWithRole(
            user=UserRead.model_validate(user),
            authorship=resource_author.authorship,
            authorship_status=resource_author.authorship_status,
            creation_date=resource_author.creation_date,
            update_date=resource_author.update_date
        )
        for resource_author, user in author_results
    ]

    course = CourseRead(**course.model_dump(), authors=authors)

    return course


async def get_course_by_id(
    request: Request,
    course_id: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    statement = select(Course).where(Course.id == course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # RBAC check
    await courses_rbac_check(request, course.course_uuid, current_user, "read", db_session)

    # Get course authors with their roles
    authors_statement = (
        select(ResourceAuthor, User)
        .join(User, ResourceAuthor.user_id == User.id) # type: ignore
        .where(ResourceAuthor.resource_uuid == course.course_uuid)
        .order_by(
            ResourceAuthor.id.asc() # type: ignore
        )
    )
    author_results = db_session.exec(authors_statement).all()

    # Convert to AuthorWithRole objects
    authors = [
        AuthorWithRole(
            user=UserRead.model_validate(user),
            authorship=resource_author.authorship,
            authorship_status=resource_author.authorship_status,
            creation_date=resource_author.creation_date,
            update_date=resource_author.update_date
        )
        for resource_author, user in author_results
    ]

    course = CourseRead(**course.model_dump(), authors=authors)

    return course


async def get_course_meta(
    request: Request,
    course_uuid: str,
    with_unpublished_activities: bool,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> FullCourseRead:
    # Avoid circular import
    from src.services.courses.chapters import get_course_chapters

    # Get course with authors in a single query using joins
    course_statement = (
        select(Course, ResourceAuthor, User)
        .outerjoin(ResourceAuthor, ResourceAuthor.resource_uuid == Course.course_uuid)  # type: ignore
        .outerjoin(User, ResourceAuthor.user_id == User.id)  # type: ignore
        .where(Course.course_uuid == course_uuid)
        .order_by(ResourceAuthor.id.asc())  # type: ignore
    )
    results = db_session.exec(course_statement).all()

    if not results:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # Extract course and authors from results
    course = results[0][0]  # First result's Course
    author_results = [(ra, u) for _, ra, u in results if ra is not None and u is not None]

    # RBAC check
    await courses_rbac_check(request, course.course_uuid, current_user, "read", db_session)

    # Get course chapters
    chapters = []
    if course.id is not None:
        chapters = await get_course_chapters(request, course.id, db_session, current_user, with_unpublished_activities)
    
    # Convert to AuthorWithRole objects
    authors = [
        AuthorWithRole(
            user=UserRead.model_validate(user),
            authorship=resource_author.authorship,
            authorship_status=resource_author.authorship_status,
            creation_date=resource_author.creation_date,
            update_date=resource_author.update_date
        )
        for resource_author, user in author_results
    ]
    
    # Create course read model with chapters
    course_read = FullCourseRead(
        **course.model_dump(),
        authors=authors,
        chapters=chapters
    )
    
    return course_read


async def get_courses_orgslug(
    request: Request,
    current_user: PublicUser | AnonymousUser,
    org_slug: str,
    db_session: Session,
    page: int = 1,
    limit: int = 10,
) -> List[CourseRead]:
    offset = (page - 1) * limit

    # Base query
    query = (
        select(Course)
        .join(Organization)
        .where(Organization.slug == org_slug)
    )

    if isinstance(current_user, AnonymousUser):
        # For anonymous users, only show public courses
        query = query.where(Course.public == True)
    else:
        # For authenticated users, show:
        # 1. Public courses
        # 2. Courses not in any UserGroup
        # 3. Courses in UserGroups where the user is a member
        # 4. Courses where the user is a resource author
        query = (
            query
            .outerjoin(UserGroupResource, UserGroupResource.resource_uuid == Course.course_uuid)  # type: ignore
            .outerjoin(UserGroupUser, and_(
                UserGroupUser.usergroup_id == UserGroupResource.usergroup_id,
                UserGroupUser.user_id == current_user.id
            ))
            .outerjoin(ResourceAuthor, ResourceAuthor.resource_uuid == Course.course_uuid)  # type: ignore
            .where(or_(
                Course.public == True,
                UserGroupResource.resource_uuid == None,  # Courses not in any UserGroup # noqa: E711
                UserGroupUser.user_id == current_user.id,  # Courses in UserGroups where user is a member
                ResourceAuthor.user_id == current_user.id  # Courses where user is a resource author
            ))
        )

    # Apply pagination
    query = query.offset(offset).limit(limit).distinct()

    courses = db_session.exec(query).all()
    
    if not courses:
        return []
        
    # Get all course UUIDs
    course_uuids = [course.course_uuid for course in courses]
    
    # Fetch all authors for all courses in a single query
    authors_query = (
        select(ResourceAuthor, User)
        .join(User, ResourceAuthor.user_id == User.id)  # type: ignore
        .where(ResourceAuthor.resource_uuid.in_(course_uuids))  # type: ignore
        .order_by(
            ResourceAuthor.id.asc() # type: ignore
        )
    )
    
    author_results = db_session.exec(authors_query).all()
    
    # Create a dictionary mapping course_uuid to list of authors
    course_authors = {}
    for resource_author, user in author_results:
        if resource_author.resource_uuid not in course_authors:
            course_authors[resource_author.resource_uuid] = []
        course_authors[resource_author.resource_uuid].append(
            AuthorWithRole(
                user=UserRead.model_validate(user),
                authorship=resource_author.authorship,
                authorship_status=resource_author.authorship_status,
                creation_date=resource_author.creation_date,
                update_date=resource_author.update_date
            )
        )
    
    # Create CourseRead objects with authors
    course_reads = []
    for course in courses:
        course_read = CourseRead.model_validate({
            "id": course.id or 0,  # Ensure id is never None
            "org_id": course.org_id,
            "name": course.name,
            "description": course.description or "",
            "about": course.about or "",
            "learnings": course.learnings or "",
            "tags": course.tags or "",
            "thumbnail_image": course.thumbnail_image or "",
            "public": course.public,
            "open_to_contributors": course.open_to_contributors,
            "course_uuid": course.course_uuid,
            "creation_date": course.creation_date,
            "update_date": course.update_date,
            "authors": course_authors.get(course.course_uuid, [])
        })
        course_reads.append(course_read)

    return course_reads


async def search_courses(
    request: Request,
    current_user: PublicUser | AnonymousUser,
    org_slug: str,
    search_query: str,
    db_session: Session,
    page: int = 1,
    limit: int = 10,
) -> List[CourseRead]:
    offset = (page - 1) * limit

    # Base query
    query = (
        select(Course)
        .join(Organization)
        .where(Organization.slug == org_slug)
        .where(
            or_(
                text(f"LOWER(course.name) LIKE LOWER('%{search_query}%')"),
                text(f"LOWER(course.description) LIKE LOWER('%{search_query}%')"),
                text(f"LOWER(course.about) LIKE LOWER('%{search_query}%')"),
                text(f"LOWER(course.learnings) LIKE LOWER('%{search_query}%')"),
                text(f"LOWER(course.tags) LIKE LOWER('%{search_query}%')")
            )
        )
    )

    if isinstance(current_user, AnonymousUser):
        # For anonymous users, only show public courses
        query = query.where(Course.public == True)
    else:
        # For authenticated users, show:
        # 1. Public courses
        # 2. Courses not in any UserGroup
        # 3. Courses in UserGroups where the user is a member
        # 4. Courses where the user is a resource author
        query = (
            query
            .outerjoin(UserGroupResource, UserGroupResource.resource_uuid == Course.course_uuid)  # type: ignore
            .outerjoin(UserGroupUser, and_(
                UserGroupUser.usergroup_id == UserGroupResource.usergroup_id,
                UserGroupUser.user_id == current_user.id
            ))
            .outerjoin(ResourceAuthor, ResourceAuthor.resource_uuid == Course.course_uuid)  # type: ignore
            .where(or_(
                Course.public == True,
                UserGroupResource.resource_uuid == None,  # Courses not in any UserGroup # noqa: E711
                UserGroupUser.user_id == current_user.id,  # Courses in UserGroups where user is a member
                ResourceAuthor.user_id == current_user.id  # Courses where user is a resource author
            ))
        )

    # Apply pagination
    query = query.offset(offset).limit(limit).distinct()

    courses = db_session.exec(query).all()

    # Fetch authors for each course
    course_reads = []
    for course in courses:
        # Get course authors with their roles
        authors_statement = (
            select(ResourceAuthor, User)
            .join(User, ResourceAuthor.user_id == User.id) # type: ignore
            .where(ResourceAuthor.resource_uuid == course.course_uuid)
            .order_by(
                ResourceAuthor.id.asc() # type: ignore
            )
        )
        author_results = db_session.exec(authors_statement).all()

        # Convert to AuthorWithRole objects
        authors = [
            AuthorWithRole(
                user=UserRead.model_validate(user),
                authorship=resource_author.authorship,
                authorship_status=resource_author.authorship_status,
                creation_date=resource_author.creation_date,
                update_date=resource_author.update_date
            )
            for resource_author, user in author_results
        ]
        
        course_read = CourseRead.model_validate({
            "id": course.id or 0,  # Ensure id is never None
            "org_id": course.org_id,
            "name": course.name,
            "description": course.description or "",
            "about": course.about or "",
            "learnings": course.learnings or "",
            "tags": course.tags or "",
            "thumbnail_image": course.thumbnail_image or "",
            "public": course.public,
            "open_to_contributors": course.open_to_contributors,
            "course_uuid": course.course_uuid,
            "creation_date": course.creation_date,
            "update_date": course.update_date,
            "authors": authors
        })
        course_reads.append(course_read)

    return course_reads


async def create_course(
    request: Request,
    org_id: int,
    course_object: CourseCreate,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
    thumbnail_file: UploadFile | None = None,
    thumbnail_type: ThumbnailType = ThumbnailType.IMAGE,
):
    """
    Create a new course
    
    SECURITY NOTES:
    - Requires proper permissions to create courses in the organization
    - User becomes the CREATOR of the course automatically
    - Course creation is subject to organization limits and permissions
    """
    course = Course.model_validate(course_object)

    # SECURITY: Check if user has permission to create courses in this organization
    # Since this is a new course, we need to check organization-level permissions
    # For now, we'll use the existing RBAC check but with proper organization context
    await courses_rbac_check(request, "course_x", current_user, "create", db_session)

    # Usage check
    check_limits_with_usage("courses", org_id, db_session)

    # Complete course object
    course.org_id = course.org_id

    # Get org uuid
    org_statement = select(Organization).where(Organization.id == org_id)
    org = db_session.exec(org_statement).first()

    course.course_uuid = str(f"course_{uuid4()}")
    course.creation_date = str(datetime.now())
    course.update_date = str(datetime.now())

    # Upload thumbnail
    if thumbnail_file and thumbnail_file.filename:
        name_in_disk = f"{course.course_uuid}_thumbnail_{uuid4()}.{thumbnail_file.filename.split('.')[-1]}"
        await upload_thumbnail(
            thumbnail_file, name_in_disk, org.org_uuid, course.course_uuid  # type: ignore
        )
        if thumbnail_type == ThumbnailType.IMAGE:
            course.thumbnail_image = name_in_disk
            course.thumbnail_type = ThumbnailType.IMAGE
        elif thumbnail_type == ThumbnailType.VIDEO:
            course.thumbnail_video = name_in_disk
            course.thumbnail_type = ThumbnailType.VIDEO
    else:
        course.thumbnail_image = ""
        course.thumbnail_video = ""
        course.thumbnail_type = ThumbnailType.IMAGE

    # Insert course
    db_session.add(course)
    db_session.commit()
    db_session.refresh(course)

    # SECURITY: Make the user the creator of the course
    resource_author = ResourceAuthor(
        resource_uuid=course.course_uuid,
        user_id=current_user.id,
        authorship=ResourceAuthorshipEnum.CREATOR,
        authorship_status=ResourceAuthorshipStatusEnum.ACTIVE,
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
    )

    # Insert course author
    db_session.add(resource_author)
    db_session.commit()
    db_session.refresh(resource_author)

    # Get course authors with their roles
    authors_statement = (
        select(ResourceAuthor, User)
        .join(User, ResourceAuthor.user_id == User.id) # type: ignore
        .where(ResourceAuthor.resource_uuid == course.course_uuid)
        .order_by(
            ResourceAuthor.id.asc() # type: ignore
        )
    )
    author_results = db_session.exec(authors_statement).all()

    # Convert to AuthorWithRole objects
    authors = [
        AuthorWithRole(
            user=UserRead.model_validate(user),
            authorship=resource_author.authorship,
            authorship_status=resource_author.authorship_status,
            creation_date=resource_author.creation_date,
            update_date=resource_author.update_date
        )
        for resource_author, user in author_results
    ]

    # Feature usage
    increase_feature_usage("courses", course.org_id, db_session)

    course = CourseRead(**course.model_dump(), authors=authors)

    return CourseRead.model_validate(course)


async def update_course_thumbnail(
    request: Request,
    course_uuid: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
    thumbnail_file: UploadFile | None = None,
    thumbnail_type: ThumbnailType = ThumbnailType.IMAGE,
):
    statement = select(Course).where(Course.course_uuid == course_uuid)
    course = db_session.exec(statement).first()

    name_in_disk = None

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # RBAC check
    await courses_rbac_check(request, course.course_uuid, current_user, "update", db_session)

    # Get org uuid
    org_statement = select(Organization).where(Organization.id == course.org_id)
    org = db_session.exec(org_statement).first()

    # Upload thumbnail
    if thumbnail_file and thumbnail_file.filename:
        name_in_disk = f"{course_uuid}_thumbnail_{uuid4()}.{thumbnail_file.filename.split('.')[-1]}"
        await upload_thumbnail(
            thumbnail_file, name_in_disk, org.org_uuid, course.course_uuid  # type: ignore
        )

    # Update course
    if name_in_disk:
        if thumbnail_type == ThumbnailType.IMAGE:
            course.thumbnail_image = name_in_disk
            course.thumbnail_type = ThumbnailType.IMAGE if not course.thumbnail_video else ThumbnailType.BOTH
        elif thumbnail_type == ThumbnailType.VIDEO:
            course.thumbnail_video = name_in_disk
            course.thumbnail_type = ThumbnailType.VIDEO if not course.thumbnail_image else ThumbnailType.BOTH
    else:
        raise HTTPException(
            status_code=500,
            detail="Issue with thumbnail upload",
        )

    # Complete the course object
    course.update_date = str(datetime.now())

    db_session.add(course)
    db_session.commit()
    db_session.refresh(course)

    # Get course authors with their roles
    authors_statement = (
        select(ResourceAuthor, User)
        .join(User, ResourceAuthor.user_id == User.id) # type: ignore
        .where(ResourceAuthor.resource_uuid == course.course_uuid)
        .order_by(
            ResourceAuthor.id.asc() # type: ignore
        )
    )
    author_results = db_session.exec(authors_statement).all()

    # Convert to AuthorWithRole objects
    authors = [
        AuthorWithRole(
            user=UserRead.model_validate(user),
            authorship=resource_author.authorship,
            authorship_status=resource_author.authorship_status,
            creation_date=resource_author.creation_date,
            update_date=resource_author.update_date
        )
        for resource_author, user in author_results
    ]

    course = CourseRead(**course.model_dump(), authors=authors)

    return course


async def update_course(
    request: Request,
    course_object: CourseUpdate,
    course_uuid: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    """
    Update a course
    
    SECURITY NOTES:
    - Requires course ownership (CREATOR, MAINTAINER) or admin role
    - Sensitive fields (public, open_to_contributors) require additional validation
    - Cannot change course access settings without proper permissions
    """
    statement = select(Course).where(Course.course_uuid == course_uuid)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # SECURITY: Require course ownership or admin role for updating courses
    await courses_rbac_check(request, course.course_uuid, current_user, "update", db_session)

    # SECURITY: Additional checks for sensitive access control fields
    sensitive_fields_updated = []
    
    # Check if sensitive fields are being updated
    if course_object.public is not None:
        sensitive_fields_updated.append("public")
    if course_object.open_to_contributors is not None:
        sensitive_fields_updated.append("open_to_contributors")
    
    # If sensitive fields are being updated, require additional validation
    if sensitive_fields_updated:
        # SECURITY: For sensitive access control changes, require CREATOR or MAINTAINER role
        # Check if user is course owner (CREATOR or MAINTAINER)
        statement = select(ResourceAuthor).where(
            ResourceAuthor.resource_uuid == course_uuid,
            ResourceAuthor.user_id == current_user.id
        )
        resource_author = db_session.exec(statement).first()
        
        is_course_owner = False
        if resource_author:
            if ((resource_author.authorship == ResourceAuthorshipEnum.CREATOR) or 
                (resource_author.authorship == ResourceAuthorshipEnum.MAINTAINER)) and \
                resource_author.authorship_status == ResourceAuthorshipStatusEnum.ACTIVE:
                is_course_owner = True
        
        # Check if user has admin or maintainer role
        is_admin_or_maintainer = await authorization_verify_based_on_org_admin_status(
            request, current_user.id, "update", course_uuid, db_session
        )
        
        # SECURITY: Only course owners (CREATOR, MAINTAINER) or admins can change access settings
        if not (is_course_owner or is_admin_or_maintainer):
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail=f"You must be the course owner (CREATOR or MAINTAINER) or have admin role to change access settings: {', '.join(sensitive_fields_updated)}",
            )

    # Update only the fields that were passed in
    for var, value in vars(course_object).items():
        if value is not None:
            setattr(course, var, value)

    # Complete the course object
    course.update_date = str(datetime.now())

    db_session.add(course)
    db_session.commit()
    db_session.refresh(course)

    # Get course authors with their roles
    authors_statement = (
        select(ResourceAuthor, User)
        .join(User, ResourceAuthor.user_id == User.id) # type: ignore
        .where(ResourceAuthor.resource_uuid == course.course_uuid)
        .order_by(
            ResourceAuthor.id.asc() # type: ignore
        )
    )
    author_results = db_session.exec(authors_statement).all()

    # Convert to AuthorWithRole objects
    authors = [
        AuthorWithRole(
            user=UserRead.model_validate(user),
            authorship=resource_author.authorship,
            authorship_status=resource_author.authorship_status,
            creation_date=resource_author.creation_date,
            update_date=resource_author.update_date
        )
        for resource_author, user in author_results
    ]

    course = CourseRead(**course.model_dump(), authors=authors)

    return course


async def delete_course(
    request: Request,
    course_uuid: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    statement = select(Course).where(Course.course_uuid == course_uuid)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # RBAC check
    await courses_rbac_check(request, course.course_uuid, current_user, "delete", db_session)

    # Feature usage
    decrease_feature_usage("courses", course.org_id, db_session)

    db_session.delete(course)
    db_session.commit()

    return {"detail": "Course deleted"}


async def get_user_courses(
    request: Request,
    current_user: PublicUser | AnonymousUser,
    user_id: int,
    db_session: Session,
    page: int = 1,
    limit: int = 10,
) -> List[CourseRead]:
    # Verify user is not anonymous
    await authorization_verify_if_user_is_anon(current_user.id)
    
    # Get all resource authors for the user
    statement = select(ResourceAuthor).where(
        and_(
            ResourceAuthor.user_id == user_id,
            ResourceAuthor.authorship_status == ResourceAuthorshipStatusEnum.ACTIVE
        )
    )
    resource_authors = db_session.exec(statement).all()
    
    # Extract course UUIDs from resource authors
    course_uuids = [author.resource_uuid for author in resource_authors]
    
    if not course_uuids:
        return []
    
    # Get courses with the extracted UUIDs
    statement = select(Course).where(Course.course_uuid.in_(course_uuids)) # type: ignore
    
    # Apply pagination
    statement = statement.offset((page - 1) * limit).limit(limit)
    
    courses = db_session.exec(statement).all()
    
    # Convert to CourseRead objects
    result = []
    for course in courses:
        # Get authors for the course
        authors_statement = select(ResourceAuthor).where(
            ResourceAuthor.resource_uuid == course.course_uuid
        )
        authors = db_session.exec(authors_statement).all()
        
        # Convert authors to AuthorWithRole objects
        authors_with_role = []
        for author in authors:
            # Get user for the author
            user_statement = select(User).where(User.id == author.user_id)
            user = db_session.exec(user_statement).first()
            
            if user:
                authors_with_role.append(
                    AuthorWithRole(
                        user=UserRead.model_validate(user),
                        authorship=author.authorship,
                        authorship_status=author.authorship_status,
                        creation_date=author.creation_date,
                        update_date=author.update_date,
                    )
                )
        
        # Create CourseRead object
        course_read = CourseRead.model_validate({
            "id": course.id or 0,  # Ensure id is never None
            "org_id": course.org_id,
            "name": course.name,
            "description": course.description or "",
            "about": course.about or "",
            "learnings": course.learnings or "",
            "tags": course.tags or "",
            "thumbnail_image": course.thumbnail_image or "",
            "public": course.public,
            "open_to_contributors": course.open_to_contributors,
            "course_uuid": course.course_uuid,
            "creation_date": course.creation_date,
            "update_date": course.update_date,
            "authors": authors_with_role
        })
        
        result.append(course_read)
    
    return result


async def get_course_user_rights(
    request: Request,
    course_uuid: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> dict:
    """
    Get detailed user rights for a specific course.
    
    This function returns comprehensive rights information that can be used
    by the UI to enable/disable features based on user permissions.
    
    SECURITY NOTES:
    - Returns rights based on course ownership and user roles
    - Includes both course-level and content-level permissions
    - Safe to expose to UI as it only returns permission information
    """
    # Check if course exists
    statement = select(Course).where(Course.course_uuid == course_uuid)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # Initialize rights object
    rights = {
        "course_uuid": course_uuid,
        "user_id": current_user.id,
        "is_anonymous": current_user.id == 0,
        "permissions": {
            "read": False,
            "create": False,
            "update": False,
            "delete": False,
            "create_content": False,
            "update_content": False,
            "delete_content": False,
            "manage_contributors": False,
            "manage_access": False,
            "grade_assignments": False,
            "mark_activities_done": False,
            "create_certifications": False,
        },
        "ownership": {
            "is_owner": False,
            "is_creator": False,
            "is_maintainer": False,
            "is_contributor": False,
            "authorship_status": None,
        },
        "roles": {
            "is_admin": False,
            "is_maintainer_role": False,
            "is_instructor": False,
            "is_user": False,
        }
    }

    # Handle anonymous users
    if current_user.id == 0:
        # Anonymous users can only read public courses
        if course.public:
            rights["permissions"]["read"] = True
        return rights

    # Check course ownership
    statement = select(ResourceAuthor).where(
        ResourceAuthor.resource_uuid == course_uuid,
        ResourceAuthor.user_id == current_user.id
    )
    resource_author = db_session.exec(statement).first()
    
    if resource_author:
        rights["ownership"]["authorship_status"] = resource_author.authorship_status
        
        if resource_author.authorship_status == ResourceAuthorshipStatusEnum.ACTIVE:
            if resource_author.authorship == ResourceAuthorshipEnum.CREATOR:
                rights["ownership"]["is_creator"] = True
                rights["ownership"]["is_owner"] = True
            elif resource_author.authorship == ResourceAuthorshipEnum.MAINTAINER:
                rights["ownership"]["is_maintainer"] = True
                rights["ownership"]["is_owner"] = True
            elif resource_author.authorship == ResourceAuthorshipEnum.CONTRIBUTOR:
                rights["ownership"]["is_contributor"] = True
                rights["ownership"]["is_owner"] = True

    # Check user roles
    from src.security.rbac.rbac import authorization_verify_based_on_org_admin_status
    from src.security.rbac.rbac import authorization_verify_based_on_roles
    
    # Check admin/maintainer role
    is_admin_or_maintainer = await authorization_verify_based_on_org_admin_status(
        request, current_user.id, "update", course_uuid, db_session
    )
    
    if is_admin_or_maintainer:
        rights["roles"]["is_admin"] = True
        rights["roles"]["is_maintainer_role"] = True

    # Check instructor role
    has_instructor_permissions = await authorization_verify_based_on_roles(
        request, current_user.id, "create", "course_x", db_session
    )
    
    if has_instructor_permissions:
        rights["roles"]["is_instructor"] = True

    # Check user role (basic permissions)
    has_user_permissions = await authorization_verify_based_on_roles(
        request, current_user.id, "read", course_uuid, db_session
    )
    
    if has_user_permissions:
        rights["roles"]["is_user"] = True

    # Determine permissions based on ownership and roles
    is_course_owner = rights["ownership"]["is_owner"]
    is_admin = rights["roles"]["is_admin"]
    is_maintainer_role = rights["roles"]["is_maintainer_role"]
    is_instructor = rights["roles"]["is_instructor"]

    # READ permissions
    if course.public or is_course_owner or is_admin or is_maintainer_role or is_instructor or has_user_permissions:
        rights["permissions"]["read"] = True

    # CREATE permissions (course creation)
    if is_instructor or is_admin or is_maintainer_role:
        rights["permissions"]["create"] = True

    # UPDATE permissions (course-level updates)
    if is_course_owner or is_admin or is_maintainer_role:
        rights["permissions"]["update"] = True

    # DELETE permissions (course deletion)
    if is_course_owner or is_admin or is_maintainer_role:
        rights["permissions"]["delete"] = True

    # CONTENT CREATION permissions (activities, assignments, chapters, etc.)
    if is_course_owner or is_admin or is_maintainer_role:
        rights["permissions"]["create_content"] = True

    # CONTENT UPDATE permissions
    if is_course_owner or is_admin or is_maintainer_role:
        rights["permissions"]["update_content"] = True

    # CONTENT DELETE permissions
    if is_course_owner or is_admin or is_maintainer_role:
        rights["permissions"]["delete_content"] = True

    # CONTRIBUTOR MANAGEMENT permissions
    if is_course_owner or is_admin or is_maintainer_role:
        rights["permissions"]["manage_contributors"] = True

    # ACCESS MANAGEMENT permissions (public, open_to_contributors)
    if (rights["ownership"]["is_creator"] or rights["ownership"]["is_maintainer"] or 
        is_admin or is_maintainer_role):
        rights["permissions"]["manage_access"] = True

    # GRADING permissions
    if is_course_owner or is_admin or is_maintainer_role:
        rights["permissions"]["grade_assignments"] = True

    # ACTIVITY MARKING permissions
    if is_course_owner or is_admin or is_maintainer_role:
        rights["permissions"]["mark_activities_done"] = True

    # CERTIFICATION permissions
    if is_course_owner or is_admin or is_maintainer_role:
        rights["permissions"]["create_certifications"] = True

    return rights



================================================
FILE: apps/api/src/services/courses/thumbnails.py
================================================
from src.services.utils.upload_content import upload_content


async def upload_thumbnail(thumbnail_file, name_in_disk,  org_uuid, course_id):
    contents = thumbnail_file.file.read()
    try:
        await upload_content(
            f"courses/{course_id}/thumbnails",
            "orgs",
            org_uuid,
            contents,
            f"{name_in_disk}",
        )

    except Exception:
        return {"message": "There was an error uploading the file"}



================================================
FILE: apps/api/src/services/courses/updates.py
================================================
from datetime import datetime
from typing import List
from uuid import uuid4
from fastapi import HTTPException, Request, status
from sqlmodel import Session, col, select
from src.db.courses.course_updates import (
    CourseUpdate,
    CourseUpdateCreate,
    CourseUpdateRead,
    CourseUpdateUpdate,
)
from src.db.courses.courses import Course
from src.db.organizations import Organization
from src.db.users import AnonymousUser, PublicUser
from src.security.courses_security import courses_rbac_check


async def create_update(
    request: Request,
    course_uuid: str,
    update_object: CourseUpdateCreate,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> CourseUpdateRead:

    # CHekc if org exists
    statement_org = select(Organization).where(Organization.id == update_object.org_id)
    org = db_session.exec(statement_org).first()

    if not org or org.id is None:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT, detail="Organization does not exist"
        )

    statement = select(Course).where(Course.course_uuid == course_uuid)
    course = db_session.exec(statement).first()

    if not course or course.id is None:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT, detail="Course does not exist"
        )

    # RBAC check
    await courses_rbac_check(request, course.course_uuid, current_user, "update", db_session)

    # Generate UUID
    courseupdate_uuid = str(f"courseupdate_{uuid4()}")

    update = CourseUpdate(
        **update_object.model_dump(),
        course_id=course.id,
        courseupdate_uuid=courseupdate_uuid,
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
    )

    db_session.add(update)

    db_session.commit()
    db_session.refresh(update)

    return CourseUpdateRead(**update.model_dump())


# Update Course Update
async def update_update(
    request: Request,
    courseupdate_uuid: str,
    update_object: CourseUpdateUpdate,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> CourseUpdateRead:
    statement = select(CourseUpdate).where(
        CourseUpdate.courseupdate_uuid == courseupdate_uuid
    )
    update = db_session.exec(statement).first()

    if not update or update.id is None:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT, detail="Update does not exist"
        )

    # RBAC check
    await courses_rbac_check(
        request, update.courseupdate_uuid, current_user, "update", db_session
    )

    for key, value in update_object.model_dump().items():
        if value is not None:
            setattr(update, key, value)

    db_session.add(update)

    db_session.commit()
    db_session.refresh(update)

    return CourseUpdateRead(**update.model_dump())


# Delete Course Update
async def delete_update(
    request: Request,
    courseupdate_uuid: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    statement = select(CourseUpdate).where(
        CourseUpdate.courseupdate_uuid == courseupdate_uuid
    )
    update = db_session.exec(statement).first()

    if not update or update.id is None:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT, detail="Update does not exist"
        )

    # RBAC check
    await courses_rbac_check(
        request, update.courseupdate_uuid, current_user, "delete", db_session
    )

    db_session.delete(update)
    db_session.commit()

    return {"message": "Update deleted successfully"}


# Get Course Updates by Course ID
async def get_updates_by_course_uuid(
    request: Request,
    course_uuid: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> List[CourseUpdateRead]:
    # FInd if course exists
    statement = select(Course).where(Course.course_uuid == course_uuid)
    course = db_session.exec(statement).first()

    if not course or course.id is None:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT, detail="Course does not exist"
        )

    statement = (
        select(CourseUpdate)
        .where(CourseUpdate.course_id == course.id)
        .order_by(col(CourseUpdate.creation_date).desc())
    )  # https://sqlmodel.tiangolo.com/tutorial/where/#type-annotations-and-errors
    updates = db_session.exec(statement).all()

    return [CourseUpdateRead(**update.model_dump()) for update in updates]



================================================
FILE: apps/api/src/services/courses/activities/activities.py
================================================
from sqlmodel import Session, select
from src.db.courses.courses import Course
from src.db.courses.chapters import Chapter
from src.db.courses.activities import ActivityCreate, Activity, ActivityRead, ActivityUpdate
from src.db.courses.chapter_activities import ChapterActivity
from src.db.users import AnonymousUser, PublicUser
from fastapi import HTTPException, Request
from uuid import uuid4
from datetime import datetime

from src.services.payments.payments_access import check_activity_paid_access
from src.security.courses_security import courses_rbac_check_for_activities


####################################################
# CRUD
####################################################


async def create_activity(
    request: Request,
    activity_object: ActivityCreate,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):

    # CHeck if org exists
    statement = select(Chapter).where(Chapter.id == activity_object.chapter_id)
    chapter = db_session.exec(statement).first()

    if not chapter:
        raise HTTPException(
            status_code=404,
            detail="Chapter not found",
        )

    # RBAC check
    statement = select(Course).where(Course.id == chapter.course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    await courses_rbac_check_for_activities(request, course.course_uuid, current_user, "create", db_session)

    # Create Activity
    activity = Activity(**activity_object.model_dump())

    activity.activity_uuid = str(f"activity_{uuid4()}")
    activity.creation_date = str(datetime.now())
    activity.update_date = str(datetime.now())
    activity.org_id = chapter.org_id
    activity.course_id = chapter.course_id

    # Insert Activity in DB
    db_session.add(activity)
    db_session.commit()
    db_session.refresh(activity)

    # Find the last activity in the Chapter and add it to the list
    statement = (
        select(ChapterActivity)
        .where(ChapterActivity.chapter_id == activity_object.chapter_id)
        .order_by(ChapterActivity.order) # type: ignore
    )
    chapter_activities = db_session.exec(statement).all()

    last_order = chapter_activities[-1].order if chapter_activities else 0
    to_be_used_order = last_order + 1

    # Add activity to chapter
    activity_chapter = ChapterActivity(
        chapter_id=activity_object.chapter_id,
        activity_id=activity.id if activity.id else 0,
        course_id=chapter.course_id,
        org_id=chapter.org_id,
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
        order=to_be_used_order,
    )

    # Insert ChapterActivity link in DB
    db_session.add(activity_chapter)
    db_session.commit()
    db_session.refresh(activity_chapter)

    return ActivityRead.model_validate(activity)


async def get_activity(
    request: Request,
    activity_uuid: str,
    current_user: PublicUser,
    db_session: Session,
):
    # Optimize by joining Activity with Course in a single query
    statement = (
        select(Activity, Course)
        .join(Course)
        .where(Activity.activity_uuid == activity_uuid)
    )
    result = db_session.exec(statement).first()

    if not result:
        raise HTTPException(
            status_code=404,
            detail="Activity not found",
        )
    
    activity, course = result

    # RBAC check
    await courses_rbac_check_for_activities(request, course.course_uuid, current_user, "read", db_session)

    # Paid access check
    has_paid_access = await check_activity_paid_access(
        request=request,
        activity_id=activity.id if activity.id else 0,
        user=current_user,
        db_session=db_session
    )

    activity_read = ActivityRead.model_validate(activity)
    activity_read.content = activity_read.content if has_paid_access else { "paid_access": False }

    return activity_read

async def get_activityby_id(
    request: Request,
    activity_id: str,
    current_user: PublicUser,
    db_session: Session,
):
    # Optimize by joining Activity with Course in a single query
    statement = (
        select(Activity, Course)
        .join(Course)
        .where(Activity.id == activity_id)
    )
    result = db_session.exec(statement).first()

    if not result:
        raise HTTPException(
            status_code=404,
            detail="Activity not found",
        )
    
    activity, course = result

    # RBAC check
    await courses_rbac_check_for_activities(request, course.course_uuid, current_user, "read", db_session)

    return ActivityRead.model_validate(activity)


async def update_activity(
    request: Request,
    activity_object: ActivityUpdate,
    activity_uuid: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    statement = select(Activity).where(Activity.activity_uuid == activity_uuid)
    activity = db_session.exec(statement).first()

    if not activity:
        raise HTTPException(
            status_code=404,
            detail="Activity not found",
        )

    # RBAC check
    statement = select(Course).where(Course.id == activity.course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    await courses_rbac_check_for_activities(request, course.course_uuid, current_user, "update", db_session)

    # Update only the fields that were passed in
    for var, value in vars(activity_object).items():
        if value is not None:
            setattr(activity, var, value)

    db_session.add(activity)
    db_session.commit()
    db_session.refresh(activity)

    activity = ActivityRead.model_validate(activity)

    return activity


async def delete_activity(
    request: Request,
    activity_uuid: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    statement = select(Activity).where(Activity.activity_uuid == activity_uuid)
    activity = db_session.exec(statement).first()

    if not activity:
        raise HTTPException(
            status_code=404,
            detail="Activity not found",
        )

    # RBAC check
    statement = select(Course).where(Course.id == activity.course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    await courses_rbac_check_for_activities(request, course.course_uuid, current_user, "delete", db_session)

    # Delete activity from chapter
    statement = select(ChapterActivity).where(
        ChapterActivity.activity_id == activity.id
    )
    activity_chapter = db_session.exec(statement).first()

    if not activity_chapter:
        raise HTTPException(
            status_code=404,
            detail="Activity not found in chapter",
        )

    db_session.delete(activity_chapter)
    db_session.delete(activity)
    db_session.commit()

    return {"detail": "Activity deleted"}


####################################################
# Misc
####################################################


async def get_activities(
    request: Request,
    coursechapter_id: int,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> list[ActivityRead]:
    # Get activities that are published and belong to the chapter
    statement = (
        select(Activity)
        .join(ChapterActivity)
        .where(
            ChapterActivity.chapter_id == coursechapter_id,
            Activity.published == True
        )
    )
    activities = db_session.exec(statement).all()

    if not activities:
        raise HTTPException(
            status_code=404,
            detail="No published activities found",
        )

    # RBAC check
    statement = select(Chapter).where(Chapter.id == coursechapter_id)
    chapter = db_session.exec(statement).first()
    
    if not chapter:
        raise HTTPException(
            status_code=404,
            detail="Chapter not found",
        )

    statement = select(Course).where(Course.id == chapter.course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    await courses_rbac_check_for_activities(request, course.course_uuid, current_user, "read", db_session)

    activities = [ActivityRead.model_validate(activity) for activity in activities]

    return activities



================================================
FILE: apps/api/src/services/courses/activities/pdf.py
================================================
from src.db.courses.courses import Course
from src.db.organizations import Organization
from sqlmodel import Session, select
from src.db.courses.chapters import Chapter
from src.db.courses.activities import (
    Activity,
    ActivityRead,
    ActivitySubTypeEnum,
    ActivityTypeEnum,
)
from src.db.courses.chapter_activities import ChapterActivity
from src.db.courses.course_chapters import CourseChapter
from src.db.users import AnonymousUser, PublicUser
from src.services.courses.activities.uploads.pdfs import upload_pdf
from fastapi import HTTPException, status, UploadFile, Request
from uuid import uuid4
from datetime import datetime
from src.security.courses_security import courses_rbac_check_for_activities


async def create_documentpdf_activity(
    request: Request,
    name: str,
    chapter_id: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
    pdf_file: UploadFile | None = None,
):
    # get chapter_id
    statement = select(Chapter).where(Chapter.id == chapter_id)
    chapter = db_session.exec(statement).first()

    if not chapter:
        raise HTTPException(
            status_code=404,
            detail="Chapter not found",
        )

    statement = select(CourseChapter).where(CourseChapter.chapter_id == chapter_id)
    coursechapter = db_session.exec(statement).first()

    if not coursechapter:
        raise HTTPException(
            status_code=404,
            detail="CourseChapter not found",
        )

    # Get course_uuid for RBAC check
    statement = select(Course).where(Course.id == coursechapter.course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # RBAC check
    await courses_rbac_check_for_activities(request, course.course_uuid, current_user, "create", db_session)

    # get org_id
    org_id = coursechapter.org_id

    # Get org_uuid
    statement = select(Organization).where(Organization.id == coursechapter.org_id)
    organization = db_session.exec(statement).first()

    # create activity uuid
    activity_uuid = f"activity_{uuid4()}"

    # check if pdf_file is not None
    if not pdf_file:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT, detail="Pdf : No pdf file provided"
        )

    if pdf_file.content_type not in ["application/pdf"]:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT, detail="Pdf : Wrong pdf format"
        )

    # get pdf format
    if pdf_file.filename:
        pdf_format = pdf_file.filename.split(".")[-1]

    else:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT, detail="Pdf : No pdf file provided"
        )

    # Create activity
    activity = Activity(
        name=name,
        activity_type=ActivityTypeEnum.TYPE_DOCUMENT,
        activity_sub_type=ActivitySubTypeEnum.SUBTYPE_DOCUMENT_PDF,
        content={
            "filename": "documentpdf." + pdf_format,
            "activity_uuid": activity_uuid,
            },  
        org_id=org_id if org_id else 0,
        course_id=coursechapter.course_id,
        activity_uuid=activity_uuid,
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
    )

    # Insert Activity in DB
    db_session.add(activity)
    db_session.commit()
    db_session.refresh(activity)

    # Add activity to chapter
    activity_chapter = ChapterActivity(
        chapter_id=(int(chapter_id)),
        activity_id=activity.id,  # type: ignore
        course_id=coursechapter.course_id,
        org_id=coursechapter.org_id,
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
        order=1,
    )

    # upload pdf
    if pdf_file and organization and course:
        # get pdffile format
        await upload_pdf(
            pdf_file,
            activity.activity_uuid,
            organization.org_uuid,
            course.course_uuid,
        )

    # Insert ChapterActivity link in DB
    db_session.add(activity_chapter)
    db_session.commit()
    db_session.refresh(activity_chapter)

    return ActivityRead.model_validate(activity)



================================================
FILE: apps/api/src/services/courses/activities/utils.py
================================================
from src.db.courses.activities import ActivityRead
from src.db.courses.courses import CourseRead


def structure_activity_content_by_type(activity):
    ### Get Headings, Texts, Callouts, Answers and Paragraphs from the activity as a big list of strings (text only) and return it

    if "content" not in activity or not activity["content"]:
        return []

    content = activity["content"]

    headings = []
    callouts = []
    paragraphs = []

    for item in content:
        if "content" in item:
            if item["type"] == "heading" and "text" in item["content"][0]:
                headings.append(item["content"][0]["text"])
            elif item["type"] in ["calloutInfo", "calloutWarning"] and all(
                "text" in text_item for text_item in item["content"]
            ):
                callouts.append(
                    "".join([text_item["text"] for text_item in item["content"]])
                )
            elif item["type"] == "paragraph" and "text" in item["content"][0]:
                paragraphs.append(item["content"][0]["text"])

    # TODO: Get Questions and Answers (if any)

    data_array = []

    # Add Headings
    data_array.append({"Headings": headings})

    # Add Callouts
    data_array.append({"Callouts": callouts})

    # Add Paragraphs
    data_array.append({"Paragraphs": paragraphs})

    return data_array


def serialize_activity_text_to_ai_comprehensible_text(
    data_array,
    course: CourseRead,
    activity: ActivityRead,
    isActivityEmpty: bool = False,
):

    if isActivityEmpty:
        text = (
            "Use this as a context "
            + 'This is a course about "'
            + course.name
            + '". '
            + 'This is a lecture about "'
            + activity.name
            + '". '
            + "There is no content yet in this lecture."
        )

        return text

    # Serialize Headings
    serialized_headings = ""
    for heading in data_array[0]["Headings"]:
        serialized_headings += heading + " "

    # Serialize Callouts
    serialized_callouts = ""
    for callout in data_array[1]["Callouts"]:
        serialized_callouts += callout + " "

    # Serialize Paragraphs
    serialized_paragraphs = ""
    for paragraph in data_array[2]["Paragraphs"]:
        serialized_paragraphs += paragraph + " "

    # Get a text that is comprehensible by the AI
    text = (
        "Use this as a context "
        + 'This is a course about "'
        + course.name
        + '". '
        + 'This is a lecture about "'
        + activity.name
        + '". '
        'These are the headings: "'
        + serialized_headings
        + '" These are the callouts: "'
        + serialized_callouts
        + '" These are the paragraphs: "'
        + serialized_paragraphs
        + '"'
    )

    return text



================================================
FILE: apps/api/src/services/courses/activities/video.py
================================================
from typing import Literal
import json
from src.db.courses.courses import Course
from src.db.organizations import Organization

from pydantic import BaseModel
from sqlmodel import Session, select
from src.db.courses.chapters import Chapter
from src.db.courses.activities import (
    Activity,
    ActivityRead,
    ActivitySubTypeEnum,
    ActivityTypeEnum,
)
from src.db.courses.chapter_activities import ChapterActivity
from src.db.courses.course_chapters import CourseChapter
from src.db.users import AnonymousUser, PublicUser
from src.services.courses.activities.uploads.videos import upload_video
from fastapi import HTTPException, status, UploadFile, Request
from uuid import uuid4
from datetime import datetime
from src.security.courses_security import courses_rbac_check_for_activities


async def create_video_activity(
    request: Request,
    name: str,
    chapter_id: str,
    current_user: PublicUser,
    db_session: Session,
    video_file: UploadFile | None = None,
    details: str = "{}",
):
    # get chapter_id
    statement = select(Chapter).where(Chapter.id == chapter_id)
    chapter = db_session.exec(statement).first()

    # convert details to dict
    details = json.loads(details)

    if not chapter:
        raise HTTPException(
            status_code=404,
            detail="Chapter not found",
        )

    statement = select(CourseChapter).where(CourseChapter.chapter_id == chapter_id)
    coursechapter = db_session.exec(statement).first()

    if not coursechapter:
        raise HTTPException(
            status_code=404,
            detail="CourseChapter not found",
        )

    # Get course_uuid for RBAC check
    statement = select(Course).where(Course.id == coursechapter.course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # RBAC check
    await courses_rbac_check_for_activities(request, course.course_uuid, current_user, "create", db_session)

    # Get org_uuid
    statement = select(Organization).where(Organization.id == coursechapter.org_id)
    organization = db_session.exec(statement).first()

    # generate activity_uuid
    activity_uuid = str(f"activity_{uuid4()}")

    # check if video_file is not None
    if not video_file:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT,
            detail="Video : No video file provided",
        )

    if video_file.content_type not in ["video/mp4", "video/webm"]:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT, detail="Video : Wrong video format"
        )

    # get video format
    if video_file.filename:
        video_format = video_file.filename.split(".")[-1]

    else:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT,
            detail="Video : No video file provided",
        )

    activity_object = Activity(
        name=name,
        activity_type=ActivityTypeEnum.TYPE_VIDEO,
        activity_sub_type=ActivitySubTypeEnum.SUBTYPE_VIDEO_HOSTED,
        activity_uuid=activity_uuid,
        org_id=coursechapter.org_id,
        course_id=coursechapter.course_id,
        content={
            "filename": "video." + video_format,
            "activity_uuid": activity_uuid,
        },
        details=details if isinstance(details, dict) else json.loads(details),
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
    )

    # create activity
    activity = Activity.model_validate(activity_object)
    db_session.add(activity)
    db_session.commit()
    db_session.refresh(activity)

    # upload video
    if video_file and organization and course:
        # get videofile format
        await upload_video(
            video_file,
            activity.activity_uuid,
            organization.org_uuid,
            course.course_uuid,
        )

    # update chapter
    chapter_activity_object = ChapterActivity(
        chapter_id=chapter.id,  # type: ignore
        activity_id=activity.id,  # type: ignore
        course_id=coursechapter.course_id,
        org_id=coursechapter.org_id,
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
        order=1,
    )

    # Insert ChapterActivity link in DB
    db_session.add(chapter_activity_object)
    db_session.commit()
    db_session.refresh(chapter_activity_object)

    return ActivityRead.model_validate(activity)


class ExternalVideo(BaseModel):
    name: str
    uri: str
    type: Literal["youtube", "vimeo"]
    chapter_id: str
    details: str = "{}"


class ExternalVideoInDB(BaseModel):
    activity_id: str


async def create_external_video_activity(
    request: Request,
    current_user: PublicUser | AnonymousUser,
    data: ExternalVideo,
    db_session: Session,
):
    # get chapter_id
    statement = select(Chapter).where(Chapter.id == data.chapter_id)
    chapter = db_session.exec(statement).first()

    if not chapter:
        raise HTTPException(
            status_code=404,
            detail="Chapter not found",
        )

    statement = select(CourseChapter).where(CourseChapter.chapter_id == data.chapter_id)
    coursechapter = db_session.exec(statement).first()

    if not coursechapter:
        raise HTTPException(
            status_code=404,
            detail="CourseChapter not found",
        )

    # Get course_uuid for RBAC check
    statement = select(Course).where(Course.id == coursechapter.course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # RBAC check
    await courses_rbac_check_for_activities(request, course.course_uuid, current_user, "create", db_session)

    # generate activity_uuid
    activity_uuid = str(f"activity_{uuid4()}")

    # convert details to dict
    details = json.loads(data.details)

    activity_object = Activity(
        name=data.name,
        activity_type=ActivityTypeEnum.TYPE_VIDEO,
        activity_sub_type=ActivitySubTypeEnum.SUBTYPE_VIDEO_YOUTUBE,
        activity_uuid=activity_uuid,
        course_id=coursechapter.course_id,
        org_id=coursechapter.org_id,
        content={
            "uri": data.uri,
            "type": data.type,
            "activity_uuid": activity_uuid,
        },
        details=details,
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
    )

    # create activity
    activity = Activity.model_validate(activity_object)
    db_session.add(activity)
    db_session.commit()
    db_session.refresh(activity)

    # update chapter
    chapter_activity_object = ChapterActivity(
        chapter_id=coursechapter.chapter_id,  # type: ignore
        activity_id=activity.id,  # type: ignore
        course_id=coursechapter.course_id,
        org_id=coursechapter.org_id,
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
        order=1,
    )

    # Insert ChapterActivity link in DB
    db_session.add(chapter_activity_object)
    db_session.commit()

    return ActivityRead.model_validate(activity)


## ğŸ”’ RBAC Utils ##



================================================
FILE: apps/api/src/services/courses/activities/uploads/pdfs.py
================================================
from src.services.utils.upload_content import upload_content


async def upload_pdf(pdf_file, activity_uuid, org_uuid, course_uuid):
    contents = pdf_file.file.read()
    pdf_format = pdf_file.filename.split(".")[-1]

    try:
        await upload_content(
            f"courses/{course_uuid}/activities/{activity_uuid}/documentpdf",
            "orgs",
            org_uuid,
            contents,
            f"documentpdf.{pdf_format}",
        )

    except Exception:
        return {"message": "There was an error uploading the file"}



================================================
FILE: apps/api/src/services/courses/activities/uploads/sub_file.py
================================================
from src.services.utils.upload_content import upload_content


async def upload_submission_file(
    file,
    name_in_disk,
    activity_uuid,
    org_uuid,
    course_uuid,
    assignment_uuid,
    assignment_task_uuid,
):
    contents = file.file.read()
    file.filename.split(".")[-1]

    await upload_content(
        f"courses/{course_uuid}/activities/{activity_uuid}/assignments/{assignment_uuid}/tasks/{assignment_task_uuid}/subs",
        "orgs",
        org_uuid,
        contents,
        f"{name_in_disk}",
        ["pdf", "docx", "mp4", "jpg", "jpeg", "png", "pptx", "zip"],
    )



================================================
FILE: apps/api/src/services/courses/activities/uploads/tasks_ref_files.py
================================================
from src.services.utils.upload_content import upload_content


async def upload_reference_file(
    file,
    name_in_disk,
    activity_uuid,
    org_uuid,
    course_uuid,
    assignment_uuid,
    assignment_task_uuid,
):
    contents = file.file.read()
    file.filename.split(".")[-1]

    await upload_content(
        f"courses/{course_uuid}/activities/{activity_uuid}/assignments/{assignment_uuid}/tasks/{assignment_task_uuid}",
        "orgs",
        org_uuid,
        contents,
        f"{name_in_disk}",
        ["pdf", "docx", "mp4", "jpg", "jpeg", "png", "pptx", "zip"],
    )



================================================
FILE: apps/api/src/services/courses/activities/uploads/videos.py
================================================

from src.services.utils.upload_content import upload_content


async def upload_video(video_file, activity_uuid, org_uuid, course_uuid):
    contents = video_file.file.read()
    video_format = video_file.filename.split(".")[-1]

    try:
        await upload_content(
            f"courses/{course_uuid}/activities/{activity_uuid}/video",
            'orgs',
            org_uuid,
            contents,
            f"video.{video_format}",
        )

    except Exception:
        return {"message": "There was an error uploading the file"}



================================================
FILE: apps/api/src/services/dev/__init__.py
================================================
[Empty file]


================================================
FILE: apps/api/src/services/dev/dev.py
================================================
from fastapi import HTTPException
from config.config import get_learnhouse_config


def isDevModeEnabled():
    config = get_learnhouse_config()
    if config.general_config.development_mode:
        return True
    else:
        return False


def isDevModeEnabledOrRaise():
    config = get_learnhouse_config()
    if config.general_config.development_mode:
        return True
    else:
        raise HTTPException(status_code=403, detail="Development mode is disabled")
    




================================================
FILE: apps/api/src/services/email/__init__.py
================================================
[Empty file]


================================================
FILE: apps/api/src/services/email/utils.py
================================================
from pydantic import EmailStr
import resend
from config.config import get_learnhouse_config


def send_email(to: EmailStr, subject: str, body: str):
    lh_config = get_learnhouse_config()
    params = {
        "from": "LearnHouse <" + lh_config.mailing_config.system_email_address + ">",
        "to": [to],
        "subject": subject,
        "html": body,
    }

    resend.api_key = lh_config.mailing_config.resend_api_key
    email = resend.Emails.send(params)

    return email
        



================================================
FILE: apps/api/src/services/explore/explore.py
================================================
from typing import Optional
from fastapi import HTTPException, Request
from sqlmodel import Session, select
from sqlalchemy import text

from src.db.courses.courses import Course, CourseRead, AuthorWithRole
from src.db.organizations import Organization, OrganizationRead
from src.db.users import User, UserRead
from src.db.resource_authors import ResourceAuthor


def _get_sort_expression(salt: str):
    """Helper function to create consistent sort expression"""
    if not salt:
        return Organization.name
    
    # Create a deterministic ordering using md5(salt + id)
    return text(
        f"md5('{salt}' || id)"
    )

async def get_orgs_for_explore(
    request: Request,
    db_session: Session,
    page: int = 1,
    limit: int = 10,
    label: str = "",
    salt: str = "",
) -> list[OrganizationRead]:

    statement = (
        select(Organization)
        .where(
            Organization.explore == True,
        )
    )

    # Add label filter if provided
    if label:
        statement = statement.where(Organization.label == label)  #type: ignore

    # Add deterministic ordering based on salt
    statement = statement.order_by(_get_sort_expression(salt))

    # Add pagination
    statement = (
        statement
        .offset((page - 1) * limit)
        .limit(limit)
    )

    result = db_session.exec(statement)
    orgs = result.all()

    return [OrganizationRead.model_validate(org) for org in orgs]



async def get_courses_for_an_org_explore(
    request: Request,
    db_session: Session,
    org_uuid: str,
) -> list[CourseRead]:
    statement = select(Organization).where(Organization.org_uuid == org_uuid)
    result = db_session.exec(statement)
    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )
    
    statement = select(Course).where(Course.org_id == org.id, Course.public == True)
    result = db_session.exec(statement)
    courses = result.all()

    courses_list = []

    for course in courses:
        courses_list.append(course)

    return courses_list

async def get_course_for_explore(
    request: Request,
    course_id: str,
    db_session: Session,
) -> CourseRead:
    statement = select(Course).where(Course.id == course_id)
    result = db_session.exec(statement)
    
    course = result.first()

    if not course:
        raise HTTPException(
            status_code=404,
            detail="Course not found",
        )

    # Get course authors with their roles
    authors_statement = (
        select(ResourceAuthor, User)
        .join(User, ResourceAuthor.user_id == User.id)
        .where(ResourceAuthor.resource_uuid == course.course_uuid)
    )
    author_results = db_session.exec(authors_statement).all()

    # Convert to AuthorWithRole objects
    authors = [
        AuthorWithRole(
            user=UserRead.model_validate(user),
            authorship=resource_author.authorship,
            authorship_status=resource_author.authorship_status,
            creation_date=resource_author.creation_date,
            update_date=resource_author.update_date
        )
        for resource_author, user in author_results
    ]

    return CourseRead(**course.model_dump(), authors=authors)

async def search_orgs_for_explore(
    request: Request,
    db_session: Session,
    search_query: str,
    label: Optional[str] = None,
    page: int = 1,
    limit: int = 10,
    salt: str = "",
) -> list[OrganizationRead]:
    # Create a combined search vector
    search_terms = search_query.split()
    search_conditions = []
    
    for term in search_terms:
        term_pattern = f"%{term}%"
        search_conditions.append(
            (Organization.name.ilike(term_pattern)) | #type: ignore
            (Organization.about.ilike(term_pattern)) | #type: ignore
            (Organization.description.ilike(term_pattern)) | #type: ignore
            (Organization.label.ilike(term_pattern)) #type: ignore
        )
    
    statement = (
        select(Organization)
        .where(Organization.explore == True)
    )

    if label and label != "all":
        statement = statement.where(Organization.label == label)  #type: ignore

    if search_conditions:
        statement = statement.where(*search_conditions)

    # Add deterministic ordering based on salt
    statement = statement.order_by(_get_sort_expression(salt))

    # Add pagination
    statement = (
        statement
        .offset((page - 1) * limit)
        .limit(limit)
    )
    
    result = db_session.exec(statement)
    orgs = result.all()

    return [OrganizationRead.model_validate(org) for org in orgs]

async def get_org_for_explore(
    request: Request,
    org_slug: str,
    db_session: Session,
 ) -> OrganizationRead:
    statement = select(Organization).where(Organization.slug == org_slug)
    result = db_session.exec(statement)
    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )
    
    return OrganizationRead.model_validate(org)
    


================================================
FILE: apps/api/src/services/health/__init__.py
================================================
[Empty file]


================================================
FILE: apps/api/src/services/health/health.py
================================================
from fastapi import HTTPException
from sqlmodel import Session, select
from src.db.organizations import Organization

async def check_database_health(db_session: Session) -> bool:
    statement = select(Organization)
    result = db_session.exec(statement)

    if not result:
        return False

    return True

async def check_health(db_session: Session) -> bool:
    # Check database health
    database_healthy = await check_database_health(db_session)

    if not database_healthy:
        raise HTTPException(status_code=503, detail="Database is not healthy")

    return True



================================================
FILE: apps/api/src/services/orgs/__init__.py
================================================
[Empty file]


================================================
FILE: apps/api/src/services/orgs/invites.py
================================================
import json
import random
import string
import uuid
from pydantic import EmailStr
import redis
from datetime import datetime, timedelta
from sqlmodel import Session, select
from src.services.email.utils import send_email
from config.config import get_learnhouse_config
from src.services.orgs.orgs import rbac_check
from src.db.users import AnonymousUser, PublicUser, UserRead
from src.db.organizations import (
    Organization,
    OrganizationRead,
)
from fastapi import HTTPException, Request


async def create_invite_code(
    request: Request,
    org_id: int,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    # Redis init
    LH_CONFIG = get_learnhouse_config()
    redis_conn_string = LH_CONFIG.redis_config.redis_connection_string

    if not redis_conn_string:
        raise HTTPException(
            status_code=500,
            detail="Redis connection string not found",
        )

    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "update", db_session)

    # Connect to Redis
    r = redis.Redis.from_url(redis_conn_string)

    if not r:
        raise HTTPException(
            status_code=500,
            detail="Could not connect to Redis",
        )

    # Check if this org has more than 6 invite codes
    invite_codes = r.keys(f"*:org:{org.org_uuid}:code:*")

    if len(invite_codes) >= 6:
        raise HTTPException(
            status_code=400,
            detail="Organization has reached the maximum number of invite codes",
        )

    # Generate invite code
    def generate_code(length=5):
        letters_and_digits = string.ascii_letters + string.digits
        return "".join(random.choice(letters_and_digits) for _ in range(length))

    generated_invite_code = generate_code()
    invite_code_uuid = f"org_invite_code_{uuid.uuid4()}"

    # time to live in days to seconds
    ttl = int(timedelta(days=365).total_seconds())

    inviteCodeObject = {
        "invite_code": generated_invite_code,
        "invite_code_uuid": invite_code_uuid,
        "invite_code_expires": ttl,
        "invite_code_type": "signup",
        "created_at": datetime.now().isoformat(),
        "created_by": current_user.user_uuid,
    }

    r.set(
        f"{invite_code_uuid}:org:{org.org_uuid}:code:{generated_invite_code}",
        json.dumps(inviteCodeObject),
        ex=ttl,
    )

    return inviteCodeObject


async def create_invite_code_with_usergroup(
    request: Request,
    org_id: int,
    usergroup_id: int,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    # Redis init
    LH_CONFIG = get_learnhouse_config()
    redis_conn_string = LH_CONFIG.redis_config.redis_connection_string

    if not redis_conn_string:
        raise HTTPException(
            status_code=500,
            detail="Redis connection string not found",
        )

    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "update", db_session)

    # Connect to Redis
    r = redis.Redis.from_url(redis_conn_string)

    if not r:
        raise HTTPException(
            status_code=500,
            detail="Could not connect to Redis",
        )

    # Check if this org has more than 6 invite codes
    invite_codes = r.keys(f"*:org:{org.org_uuid}:code:*")

    if len(invite_codes) >= 6:
        raise HTTPException(
            status_code=400,
            detail="Organization has reached the maximum number of invite codes",
        )

    # Generate invite code
    def generate_code(length=5):
        letters_and_digits = string.ascii_letters + string.digits
        return "".join(random.choice(letters_and_digits) for _ in range(length))

    generated_invite_code = generate_code()
    invite_code_uuid = f"org_invite_code_{uuid.uuid4()}"

    # time to live in days to seconds
    ttl = int(timedelta(days=365).total_seconds())

    inviteCodeObject = {
        "invite_code": generated_invite_code,
        "invite_code_uuid": invite_code_uuid,
        "invite_code_expires": ttl,
        "usergroup_id": usergroup_id,
        "invite_code_type": "signup",
        "created_at": datetime.now().isoformat(),
        "created_by": current_user.user_uuid,
    }

    r.set(
        f"{invite_code_uuid}:org:{org.org_uuid}:code:{generated_invite_code}",
        json.dumps(inviteCodeObject),
        ex=ttl,
    )

    return inviteCodeObject


async def get_invite_codes(
    request: Request,
    org_id: int,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    # Redis init
    LH_CONFIG = get_learnhouse_config()
    redis_conn_string = LH_CONFIG.redis_config.redis_connection_string

    if not redis_conn_string:
        raise HTTPException(
            status_code=500,
            detail="Redis connection string not found",
        )

    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "update", db_session)

    # Connect to Redis
    r = redis.Redis.from_url(redis_conn_string)

    if not r:
        raise HTTPException(
            status_code=500,
            detail="Could not connect to Redis",
        )

    # Get invite codes
    invite_codes = r.keys(f"org_invite_code_*:org:{org.org_uuid}:code:*")



    invite_codes_list = []

    for invite_code in invite_codes:  # type: ignore
        invite_code = r.get(invite_code)
        invite_code = json.loads(invite_code)  # type: ignore
        invite_codes_list.append(invite_code)

    return invite_codes_list


async def get_invite_code(
    request: Request,
    org_id: int,
    invite_code: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    # Redis init
    LH_CONFIG = get_learnhouse_config()
    redis_conn_string = LH_CONFIG.redis_config.redis_connection_string

    if not redis_conn_string:
        raise HTTPException(
            status_code=500,
            detail="Redis connection string not found",
        )

    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # RBAC check
    # await rbac_check(request, org.org_uuid, current_user, "update", db_session)

    # Connect to Redis
    r = redis.Redis.from_url(redis_conn_string)

    if not r:
        raise HTTPException(
            status_code=500,
            detail="Could not connect to Redis",
        )

    # Get invite code
    invite_code = r.keys(f"org_invite_code_*:org:{org.org_uuid}:code:{invite_code}")  # type: ignore

    if not invite_code:
        raise HTTPException(
            status_code=404,
            detail="Invite code not found",
        )

    invite_code = r.get(invite_code[0])  # type: ignore
    invite_code = json.loads(invite_code)

    return invite_code


async def delete_invite_code(
    request: Request,
    org_id: int,
    invite_code_uuid: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    # Redis init
    LH_CONFIG = get_learnhouse_config()
    redis_conn_string = LH_CONFIG.redis_config.redis_connection_string

    if not redis_conn_string:
        raise HTTPException(
            status_code=500,
            detail="Redis connection string not found",
        )

    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "update", db_session)

    # Connect to Redis
    r = redis.Redis.from_url(redis_conn_string)

    if not r:
        raise HTTPException(
            status_code=500,
            detail="Could not connect to Redis",
        )

    # Delete invite code
    keys = r.keys(f"{invite_code_uuid}:org:{org.org_uuid}:code:*")
    if keys:
        r.delete(*keys)

    if not keys:
        raise HTTPException(
            status_code=404,
            detail="Invite code not found",
        )

    return keys


def send_invite_email(
    org: OrganizationRead,
    invite_code_uuid: str,
    user: UserRead,
    email: EmailStr,
):
    LH_CONFIG = get_learnhouse_config()
    redis_conn_string = LH_CONFIG.redis_config.redis_connection_string

    if not redis_conn_string:
        raise HTTPException(
            status_code=500,
            detail="Redis connection string not found",
        )

    # Connect to Redis
    r = redis.Redis.from_url(redis_conn_string)

    if not r:
        raise HTTPException(
            status_code=500,
            detail="Could not connect to Redis",
        )

    # Get invite code
    invite = r.keys(f"{invite_code_uuid}:org:{org.org_uuid}:code:*")  # type: ignore

    # Send email
    if invite:
        invite = r.get(invite[0])
        invite = json.loads(invite)  # type: ignore

        # send email
        send_email(
            to=email,
            subject=f"You have been invited to {org.name}",
            body=f"""
<html>
    <body>
        <p>Hello {email}</p>
        <p>You have been invited to {org.name} by @{user.username}. Your invite code is {invite['invite_code']}.</p>
        <p>Click <a href="{org.slug}.learnhouse.io/signup?orgslug={org.slug}&inviteCode={invite['invite_code']}">here</a> to sign up.</p>
        <p>Thank you</p>
    </body>
</html>
""",
        )

        return True

    else:
        return False



================================================
FILE: apps/api/src/services/orgs/join.py
================================================
from datetime import datetime
from typing import Optional
from fastapi import HTTPException, Request
from pydantic import BaseModel
from sqlmodel import Session, select
from src.db.organizations import Organization
from src.db.user_organizations import UserOrganization
from src.db.users import AnonymousUser, PublicUser, User
from src.security.features_utils.usage import (
    check_limits_with_usage,
    increase_feature_usage,
)
from src.services.orgs.invites import get_invite_code
from src.services.orgs.orgs import get_org_join_mechanism


class JoinOrg(BaseModel):
    org_id: int
    user_id: str
    invite_code: Optional[str]


async def join_org(
    request: Request,
    args: JoinOrg,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    statement = select(Organization).where(Organization.id == args.org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org or org.id is None:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    check_limits_with_usage("members", org.id, db_session)

    join_method = await get_org_join_mechanism(
        request, args.org_id, current_user, db_session
    )

    # Get User
    statement = select(User).where(User.id == args.user_id)
    result = db_session.exec(statement)

    user = result.first()

    # Check if User isn't already part of the org
    statement = select(UserOrganization).where(
        UserOrganization.user_id == args.user_id, UserOrganization.org_id == args.org_id
    )
    result = db_session.exec(statement)

    userorg = result.first()

    if userorg:
        raise HTTPException(
            status_code=400, detail="User is already part of that organization"
        )

    if join_method == "inviteOnly" and user and org and args.invite_code:
        if user.id is not None and org.id is not None:

            # Check if invite code exists
            inviteCode = await get_invite_code(
                request, org.id, args.invite_code, current_user, db_session
            )

            if not inviteCode:
                raise HTTPException(
                    status_code=400,
                    detail="Invite code is incorrect",
                )

            # Link user and organization
            user_organization = UserOrganization(
                user_id=user.id,
                org_id=org.id,
                role_id=4,
                creation_date=str(datetime.now()),
                update_date=str(datetime.now()),
            )

            db_session.add(user_organization)
            db_session.commit()

            return "Great, You're part of the Organization"

        else:
            raise HTTPException(
                status_code=403,
                detail="Something wrong, try later.",
            )

    if join_method == "open" and user and org:
        if user.id is not None and org.id is not None:
            # Link user and organization
            user_organization = UserOrganization(
                user_id=user.id,
                org_id=org.id,
                role_id=4,
                creation_date=str(datetime.now()),
                update_date=str(datetime.now()),
            )

            db_session.add(user_organization)
            db_session.commit()

            increase_feature_usage("members", org.id, db_session)

            return "Great, You're part of the Organization"

        else:
            raise HTTPException(
                status_code=403,
                detail="Something wrong, try later.",
            )

    else:
        raise HTTPException(
            status_code=403,
            detail="Something wrong, try later.",
        )



================================================
FILE: apps/api/src/services/orgs/orgs.py
================================================
import json
import logging
from datetime import datetime
from typing import Literal
from uuid import uuid4
from sqlmodel import Session, select
from src.db.organization_config import (
    AIOrgConfig,
    APIOrgConfig,
    AnalyticsOrgConfig,
    AssignmentOrgConfig,
    CollaborationOrgConfig,
    CourseOrgConfig,
    DiscussionOrgConfig,
    MemberOrgConfig,
    OrgCloudConfig,
    OrgFeatureConfig,
    OrgGeneralConfig,
    OrganizationConfig,
    OrganizationConfigBase,
    PaymentOrgConfig,
    StorageOrgConfig,
    UserGroupOrgConfig,
)
from src.security.rbac.rbac import (
    authorization_verify_based_on_org_admin_status,
    authorization_verify_if_user_is_anon,
)
from src.db.users import AnonymousUser, InternalUser, PublicUser
from src.db.user_organizations import UserOrganization
from src.db.organizations import (
    Organization,
    OrganizationCreate,
    OrganizationRead,
    OrganizationUpdate,
)
from fastapi import HTTPException, UploadFile, status, Request

from src.services.orgs.uploads import upload_org_logo, upload_org_preview, upload_org_thumbnail, upload_org_landing_content


async def get_organization(
    request: Request,
    org_id: str,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
) -> OrganizationRead:
    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "read", db_session)

    # Get org config
    statement = select(OrganizationConfig).where(OrganizationConfig.org_id == org.id)
    result = db_session.exec(statement)

    org_config = result.first()

    if org_config is None:
        logging.error(f"Organization {org_id} has no config")

    config = OrganizationConfig.model_validate(org_config) if org_config else {}

    org = OrganizationRead(**org.model_dump(), config=config)

    return org


async def get_organization_by_slug(
    request: Request,
    org_slug: str,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
) -> OrganizationRead:
    statement = select(Organization).where(Organization.slug == org_slug)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "read", db_session)

    # Get org config
    statement = select(OrganizationConfig).where(OrganizationConfig.org_id == org.id)
    result = db_session.exec(statement)

    org_config = result.first()

    if org_config is None:
        logging.error(f"Organization {org_slug} has no config")

    config = OrganizationConfig.model_validate(org_config) if org_config else {}

    org = OrganizationRead(**org.model_dump(), config=config)

    return org


async def create_org(
    request: Request,
    org_object: OrganizationCreate,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    statement = select(Organization).where(Organization.slug == org_object.slug)
    result = db_session.exec(statement)

    org = result.first()

    if org:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT,
            detail="Organization already exists",
        )

    org = Organization.model_validate(org_object)

    if isinstance(current_user, AnonymousUser):
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT,
            detail="You should be logged in to be able to achieve this action",
        )

    # Complete the org object
    org.org_uuid = f"org_{uuid4()}"
    org.creation_date = str(datetime.now())
    org.update_date = str(datetime.now())

    db_session.add(org)
    db_session.commit()
    db_session.refresh(org)

    # Link user to org
    user_org = UserOrganization(
        user_id=int(current_user.id),
        org_id=int(org.id if org.id else 0),
        role_id=1,
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
    )

    db_session.add(user_org)
    db_session.commit()
    db_session.refresh(user_org)

    org_config = org_config = OrganizationConfigBase(
        config_version="1.1Ã¥",
        general=OrgGeneralConfig(
            enabled=True,
            color="normal",
            watermark=True,
        ),
        features=OrgFeatureConfig(
            courses=CourseOrgConfig(enabled=True, limit=0),
            members=MemberOrgConfig(
                enabled=True, signup_mode="open", admin_limit=0, limit=0
            ),
            usergroups=UserGroupOrgConfig(enabled=True, limit=0),
            storage=StorageOrgConfig(enabled=True, limit=0),
            ai=AIOrgConfig(enabled=True, limit=0, model="gpt-4o-mini"),
            assignments=AssignmentOrgConfig(enabled=True, limit=0),
            payments=PaymentOrgConfig(enabled=True),
            discussions=DiscussionOrgConfig(enabled=True, limit=0),
            analytics=AnalyticsOrgConfig(enabled=True, limit=0),
            collaboration=CollaborationOrgConfig(enabled=True, limit=0),
            api=APIOrgConfig(enabled=True, limit=0),
        ),
        cloud=OrgCloudConfig(plan="free", custom_domain=False),
    )

    org_config = json.loads(org_config.json())

    # OrgSettings
    org_settings = OrganizationConfig(
        org_id=int(org.id if org.id else 0),
        config=org_config,
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
    )

    db_session.add(org_settings)
    db_session.commit()
    db_session.refresh(org_settings)

    # Get org config
    statement = select(OrganizationConfig).where(OrganizationConfig.org_id == org.id)
    result = db_session.exec(statement)

    org_config = result.first()

    if org_config is None:
        logging.error(f"Organization {org.id} has no config")

    config = OrganizationConfig.model_validate(org_config)

    org = OrganizationRead(**org.model_dump(), config=config)

    return org


async def create_org_with_config(
    request: Request,
    org_object: OrganizationCreate,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
    submitted_config: OrganizationConfigBase,
):
    statement = select(Organization).where(Organization.slug == org_object.slug)
    result = db_session.exec(statement)

    org = result.first()

    if org:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT,
            detail="Organization already exists",
        )

    org = Organization.model_validate(org_object)

    if isinstance(current_user, AnonymousUser):
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT,
            detail="You should be logged in to be able to achieve this action",
        )

    # Complete the org object
    org.org_uuid = f"org_{uuid4()}"
    org.creation_date = str(datetime.now())
    org.update_date = str(datetime.now())

    db_session.add(org)
    db_session.commit()
    db_session.refresh(org)

    # Link user to org
    user_org = UserOrganization(
        user_id=int(current_user.id),
        org_id=int(org.id if org.id else 0),
        role_id=1,
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
    )

    db_session.add(user_org)
    db_session.commit()
    db_session.refresh(user_org)

    org_config = submitted_config

    org_config = json.loads(org_config.json())

    # OrgSettings
    org_settings = OrganizationConfig(
        org_id=int(org.id if org.id else 0),
        config=org_config,
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
    )

    db_session.add(org_settings)
    db_session.commit()
    db_session.refresh(org_settings)

    # Get org config
    statement = select(OrganizationConfig).where(OrganizationConfig.org_id == org.id)
    result = db_session.exec(statement)

    org_config = result.first()

    if org_config is None:
        logging.error(f"Organization {org.id} has no config")

    config = OrganizationConfig.model_validate(org_config)

    org = OrganizationRead(**org.model_dump(), config=config)

    return org


async def update_org(
    request: Request,
    org_object: OrganizationUpdate,
    org_id: int,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization slug not found",
        )

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "update", db_session)

    # Verify if the new slug is already in use
    statement = select(Organization).where(Organization.slug == org_object.slug)
    result = db_session.exec(statement)

    slug_available = result.first()

    if slug_available and slug_available.id != org_id:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT,
            detail="Organization slug already exists",
        )

    # Update only the fields that were passed in
    for var, value in vars(org_object).items():
        if value is not None:
            setattr(org, var, value)

    # Complete the org object
    org.update_date = str(datetime.now())

    db_session.add(org)
    db_session.commit()
    db_session.refresh(org)

    org = OrganizationRead.model_validate(org)

    return org


async def update_org_with_config_no_auth(
    request: Request,
    orgconfig: OrganizationConfigBase,
    org_id: int,
    db_session: Session,
):
    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization slug not found",
        )

    # Get org config
    statement = select(OrganizationConfig).where(OrganizationConfig.org_id == org.id)
    result = db_session.exec(statement)

    org_config = result.first()

    if org_config is None:
        logging.error(f"Organization {org_id} has no config")
        raise HTTPException(
            status_code=404,
            detail="Organization config not found",
        )

    updated_config = orgconfig

    # Update the database
    org_config.config = json.loads(updated_config.json())
    org_config.update_date = str(datetime.now())

    db_session.add(org_config)
    db_session.commit()
    db_session.refresh(org_config)

    return {"detail": "Organization updated"}


async def update_org_logo(
    request: Request,
    logo_file: UploadFile,
    org_id: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "update", db_session)

    # Upload logo
    name_in_disk = await upload_org_logo(logo_file, org.org_uuid)

    # Update org
    org.logo_image = name_in_disk

    # Complete the org object
    org.update_date = str(datetime.now())

    db_session.add(org)
    db_session.commit()
    db_session.refresh(org)

    return {"detail": "Logo updated"}

async def update_org_thumbnail(
    request: Request,
    thumbnail_file: UploadFile,
    org_id: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "update", db_session)

    # Upload logo
    name_in_disk = await upload_org_thumbnail(thumbnail_file, org.org_uuid)

    # Update org
    org.thumbnail_image = name_in_disk

    # Complete the org object
    org.update_date = str(datetime.now())

    db_session.add(org)
    db_session.commit()
    db_session.refresh(org)

    return {"detail": "Thumbnail updated"}

async def update_org_preview(
    request: Request,
    preview_file: UploadFile,
    org_id: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "update", db_session)

    # Upload logo
    name_in_disk = await upload_org_preview(preview_file, org.org_uuid)

    return {"name_in_disk": name_in_disk}

async def delete_org(
    request: Request,
    org_id: int,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "delete", db_session)

    db_session.delete(org)
    db_session.commit()

    # Delete links to org
    statement = select(UserOrganization).where(UserOrganization.org_id == org_id)
    result = db_session.exec(statement)

    user_orgs = result.all()

    for user_org in user_orgs:
        db_session.delete(user_org)
        db_session.commit()

    db_session.refresh(org)

    return {"detail": "Organization deleted"}


async def get_orgs_by_user_admin(
    request: Request,
    db_session: Session,
    user_id: str,
    page: int = 1,
    limit: int = 10,
) -> list[OrganizationRead]:
    # Join Organization, UserOrganization and OrganizationConfig in a single query
    statement = (
        select(Organization, OrganizationConfig)
        .join(UserOrganization)
        .outerjoin(OrganizationConfig)
        .where(
            UserOrganization.user_id == user_id,
            UserOrganization.role_id == 1,  # Only where the user is admin
            UserOrganization.org_id == Organization.id,
            OrganizationConfig.org_id == Organization.id
        )
        .offset((page - 1) * limit)
        .limit(limit)
    )

    # Execute single query to get all data
    result = db_session.exec(statement)
    org_data = result.all()

    # Process results in memory
    orgsWithConfig = []
    for org, org_config in org_data:
        config = OrganizationConfig.model_validate(org_config) if org_config else {}
        org_read = OrganizationRead(**org.model_dump(), config=config)
        orgsWithConfig.append(org_read)

    return orgsWithConfig


async def get_orgs_by_user(
    request: Request,
    db_session: Session,
    user_id: str,
    page: int = 1,
    limit: int = 10,
) -> list[OrganizationRead]:
    # Join Organization, UserOrganization and OrganizationConfig in a single query
    statement = (
        select(Organization, OrganizationConfig)
        .join(UserOrganization)
        .outerjoin(OrganizationConfig)
        .where(
            UserOrganization.user_id == user_id,
            UserOrganization.org_id == Organization.id,
            OrganizationConfig.org_id == Organization.id
        )
        .offset((page - 1) * limit)
        .limit(limit)
    )

    # Execute single query to get all data
    result = db_session.exec(statement)
    org_data = result.all()

    # Process results in memory
    orgsWithConfig = []
    for org, org_config in org_data:
        config = OrganizationConfig.model_validate(org_config) if org_config else {}
        org_read = OrganizationRead(**org.model_dump(), config=config)
        orgsWithConfig.append(org_read)

    return orgsWithConfig


# Config related
async def update_org_signup_mechanism(
    request: Request,
    signup_mechanism: Literal["open", "inviteOnly"],
    org_id: int,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "update", db_session)

    # Get org config
    statement = select(OrganizationConfig).where(OrganizationConfig.org_id == org.id)
    result = db_session.exec(statement)

    org_config = result.first()

    if org_config is None:
        logging.error(f"Organization {org_id} has no config")
        raise HTTPException(
            status_code=404,
            detail="Organization config not found",
        )

    updated_config = org_config.config

    # Update config
    updated_config = OrganizationConfigBase(**updated_config)
    updated_config.features.members.signup_mode = signup_mechanism

    # Update the database
    org_config.config = json.loads(updated_config.json())
    org_config.update_date = str(datetime.now())

    db_session.add(org_config)
    db_session.commit()
    db_session.refresh(org_config)

    return {"detail": "Signup mechanism updated"}


async def get_org_join_mechanism(
    request: Request,
    org_id: int,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "read", db_session)

    # Get org config
    statement = select(OrganizationConfig).where(OrganizationConfig.org_id == org.id)
    result = db_session.exec(statement)

    org_config = result.first()

    if org_config is None:
        logging.error(f"Organization {org_id} has no config")
        raise HTTPException(
            status_code=404,
            detail="Organization config not found",
        )

    config = org_config.config

    # Get the signup mechanism
    config = OrganizationConfigBase(**config)
    signup_mechanism = config.features.members.signup_mode

    return signup_mechanism

async def upload_org_preview_service(
    preview_file: UploadFile,
    org_uuid: str,
) -> dict:
    # No need for request or current_user since we're not doing RBAC checks for previews
    
    # Upload preview
    name_in_disk = await upload_org_preview(preview_file, org_uuid)

    return {
        "detail": "Preview uploaded successfully",
        "filename": name_in_disk
    }

async def update_org_landing(
    request: Request,
    landing_object: dict,
    org_id: int,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "update", db_session)

    # Get org config
    statement = select(OrganizationConfig).where(OrganizationConfig.org_id == org.id)
    result = db_session.exec(statement)

    org_config = result.first()

    if org_config is None:
        logging.error(f"Organization {org_id} has no config")
        raise HTTPException(
            status_code=404,
            detail="Organization config not found",
        )

    # Convert to OrganizationConfigBase model and back to ensure all fields exist
    config_model = OrganizationConfigBase(**org_config.config)
    
    # Update the landing object
    config_model.landing = landing_object

    # Convert back to dict and update
    updated_config = json.loads(config_model.json())
    org_config.config = updated_config
    org_config.update_date = str(datetime.now())

    db_session.add(org_config)
    db_session.commit()
    db_session.refresh(org_config)

    return {"detail": "Landing object updated"}

async def upload_org_landing_content_service(
    request: Request,
    content_file: UploadFile,
    org_id: int,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> dict:
    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "update", db_session)

    # Upload content
    name_in_disk = await upload_org_landing_content(content_file, org.org_uuid)

    return {
        "detail": "Landing content uploaded successfully",
        "filename": name_in_disk
    }

## ğŸ”’ RBAC Utils ##


async def rbac_check(
    request: Request,
    org_uuid: str,
    current_user: PublicUser | AnonymousUser | InternalUser,
    action: Literal["create", "read", "update", "delete"],
    db_session: Session,
):
    # Organizations are readable by anyone
    if action == "read":
        return True
    
    # Internal users can do anything
    if isinstance(current_user, InternalUser):
        return True

    else:
        isUserAnon = await authorization_verify_if_user_is_anon(current_user.id)

        isAllowedOnOrgAdminStatus = (
            await authorization_verify_based_on_org_admin_status(
                request, current_user.id, action, org_uuid, db_session
            )
        )

        if isUserAnon:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="You should be logged in to be able to achieve this action",
            )

        if not isAllowedOnOrgAdminStatus:
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail="User rights (admin status) : You don't have the right to perform this action",
            )


## ğŸ”’ RBAC Utils ##



================================================
FILE: apps/api/src/services/orgs/uploads.py
================================================
from fastapi import UploadFile
from src.services.utils.upload_content import upload_file


async def upload_org_logo(logo_file: UploadFile, org_uuid: str) -> str:
    """Upload organization logo."""
    return await upload_file(
        file=logo_file,
        directory="logos",
        type_of_dir="orgs",
        uuid=org_uuid,
        allowed_types=["image"],
        filename_prefix="logo",
        max_size=5 * 1024 * 1024  # 5MB
    )


async def upload_org_thumbnail(thumbnail_file: UploadFile, org_uuid: str) -> str:
    """Upload organization thumbnail."""
    return await upload_file(
        file=thumbnail_file,
        directory="thumbnails",
        type_of_dir="orgs",
        uuid=org_uuid,
        allowed_types=["image"],
        filename_prefix="thumbnail",
        max_size=5 * 1024 * 1024  # 5MB
    )


async def upload_org_preview(file: UploadFile, org_uuid: str) -> str:
    """Upload organization preview image."""
    return await upload_file(
        file=file,
        directory="previews",
        type_of_dir="orgs",
        uuid=org_uuid,
        allowed_types=["image"],
        filename_prefix="preview",
        max_size=5 * 1024 * 1024  # 5MB
    )


async def upload_org_landing_content(file: UploadFile, org_uuid: str) -> str:
    """Upload organization landing content."""
    return await upload_file(
        file=file,
        directory="landing",
        type_of_dir="orgs",
        uuid=org_uuid,
        allowed_types=["image", "video", "document"],
        filename_prefix="landing",
        max_size=50 * 1024 * 1024  # 50MB
    )


================================================
FILE: apps/api/src/services/orgs/users.py
================================================
from datetime import datetime, timedelta
import json
import logging

import redis
from fastapi import HTTPException, Request
from sqlmodel import Session, select
from src.security.features_utils.usage import decrease_feature_usage
from src.services.orgs.invites import send_invite_email
from config.config import get_learnhouse_config
from src.services.orgs.orgs import rbac_check
from src.db.roles import Role, RoleRead
from src.db.users import AnonymousUser, PublicUser, User, UserRead
from src.db.user_organizations import UserOrganization
from src.db.organizations import (
    Organization,
    OrganizationRead,
    OrganizationUser,
)


async def get_organization_users(
    request: Request,
    org_id: str,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
) -> list[OrganizationUser]:
    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "read", db_session)

    statement = (
        select(User)
        .join(UserOrganization)
        .join(Organization)
        .where(Organization.id == org_id)
    )
    users = db_session.exec(statement)
    users = users.all()

    org_users_list = []

    for user in users:
        statement = select(UserOrganization).where(
            UserOrganization.user_id == user.id, UserOrganization.org_id == org_id
        )
        result = db_session.exec(statement)
        user_org = result.first()

        if not user_org:
            logging.error(f"User {user.id} not found")

            # skip this user
            continue

        statement = select(Role).where(Role.id == user_org.role_id)
        result = db_session.exec(statement)

        role = result.first()

        if not role:
            logging.error(f"Role {user_org.role_id} not found")

            # skip this user
            continue

        statement = select(User).where(User.id == user_org.user_id)
        result = db_session.exec(statement)

        user = result.first()

        if not user:
            logging.error(f"User {user_org.user_id} not found")

            # skip this user
            continue

        user = UserRead.model_validate(user)
        role = RoleRead.model_validate(role)

        org_user = OrganizationUser(
            user=user,
            role=role,
        )

        org_users_list.append(org_user)

    return org_users_list


async def remove_user_from_org(
    request: Request,
    org_id: int,
    user_id: int,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
):
    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "delete", db_session)

    statement = select(UserOrganization).where(
        UserOrganization.user_id == user_id, UserOrganization.org_id == org.id
    )
    result = db_session.exec(statement)

    user_org = result.first()

    if not user_org:
        raise HTTPException(
            status_code=404,
            detail="User not found",
        )

    # Check if user is the last admin
    statement = select(UserOrganization).where(
        UserOrganization.org_id == org.id, UserOrganization.role_id == 1
    )
    result = db_session.exec(statement)
    admins = result.all()

    if len(admins) == 1 and admins[0].user_id == user_id:
        raise HTTPException(
            status_code=400,
            detail="You can't remove the last admin of the organization",
        )

    db_session.delete(user_org)
    db_session.commit()

    decrease_feature_usage("members", org_id, db_session)

    return {"detail": "User removed from org"}


async def update_user_role(
    request: Request,
    org_id: str,
    user_id: str,
    role_uuid: str,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
):
    # find role
    statement = select(Role).where(Role.role_uuid == role_uuid)
    result = db_session.exec(statement)

    role = result.first()

    if not role:
        raise HTTPException(
            status_code=404,
            detail="Role not found",
        )

    role_id = role.id

    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "update", db_session)

    # Check if user is the last admin and if the new role is not admin
    statement = select(UserOrganization).where(
        UserOrganization.org_id == org.id, UserOrganization.role_id == 1
    )
    result = db_session.exec(statement)
    admins = result.all()

    if not admins:
        raise HTTPException(
            status_code=400,
            detail="There is no admin in the organization",
        )

    if (
        len(admins) == 1
        and int(admins[0].user_id) == int(user_id)
        and str(role_uuid) != "role_global_admin"
    ):
        raise HTTPException(
            status_code=400,
            detail="Organization must have at least one admin",
        )

    statement = select(UserOrganization).where(
        UserOrganization.user_id == user_id, UserOrganization.org_id == org.id
    )
    result = db_session.exec(statement)

    user_org = result.first()

    if not user_org:
        raise HTTPException(
            status_code=404,
            detail="User not found",
        )

    if role_id is not None:
        user_org.role_id = role_id

    db_session.add(user_org)
    db_session.commit()
    db_session.refresh(user_org)

    return {"detail": "User role updated"}


async def invite_batch_users(
    request: Request,
    org_id: int,
    emails: str,
    invite_code_uuid: str,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
):
    # Redis init
    LH_CONFIG = get_learnhouse_config()
    redis_conn_string = LH_CONFIG.redis_config.redis_connection_string

    if not redis_conn_string:
        raise HTTPException(
            status_code=500,
            detail="Redis connection string not found",
        )

    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # get User sender
    statement = select(User).where(User.id == current_user.id)
    user = db_session.exec(statement).first()

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "create", db_session)

    # Connect to Redis
    r = redis.Redis.from_url(redis_conn_string)

    if not r:
        raise HTTPException(
            status_code=500,
            detail="Could not connect to Redis",
        )

    invite_list = emails.split(",")

    # invitations expire after 60 days
    ttl = int(timedelta(days=60).total_seconds())

    for email in invite_list:
        email = email.strip()

        # Check if user is already invited
        invited_user = r.get(f"invited_user:{email}:org:{org.org_uuid}")

        if invited_user:
            logging.error(f"User {email} already invited")
            # skip this user
            continue

        org = OrganizationRead.model_validate(org)
        user = UserRead.model_validate(user)

        isEmailSent = send_invite_email(
            org,
            invite_code_uuid,
            user,
            email,
        )

        invited_user_object = {
            "email": email,
            "org_id": org.id,
            "invite_code_uuid": invite_code_uuid,
            "pending": True,
            "email_sent": isEmailSent,
            "expires": ttl,
            "created_at": datetime.now().isoformat(),
            "created_by": current_user.user_uuid,
        }

        invited_user = r.set(
            f"invited_user:{email}:org:{org.org_uuid}",
            json.dumps(invited_user_object),
            ex=ttl,
        )

    return {"detail": "Users invited"}


async def get_list_of_invited_users(
    request: Request,
    org_id: int,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
):
    # Redis init
    LH_CONFIG = get_learnhouse_config()
    redis_conn_string = LH_CONFIG.redis_config.redis_connection_string

    if not redis_conn_string:
        raise HTTPException(
            status_code=500,
            detail="Redis connection string not found",
        )

    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "read", db_session)

    # Connect to Redis
    r = redis.Redis.from_url(redis_conn_string)

    if not r:
        raise HTTPException(
            status_code=500,
            detail="Could not connect to Redis",
        )

    invited_users = r.keys(f"invited_user:*:org:{org.org_uuid}")

    invited_users_list = []

    for user in invited_users:
        invited_user = r.get(user)
        if invited_user:
            invited_user = json.loads(invited_user.decode("utf-8"))
            invited_users_list.append(invited_user)

    return invited_users_list


async def remove_invited_user(
    request: Request,
    org_id: int,
    email: str,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
):
    # Redis init
    LH_CONFIG = get_learnhouse_config()
    redis_conn_string = LH_CONFIG.redis_config.redis_connection_string

    if not redis_conn_string:
        raise HTTPException(
            status_code=500,
            detail="Redis connection string not found",
        )

    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    org = result.first()

    if not org:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "delete", db_session)

    # Connect to Redis
    r = redis.Redis.from_url(redis_conn_string)

    if not r:
        raise HTTPException(
            status_code=500,
            detail="Could not connect to Redis",
        )

    invited_user = r.get(f"invited_user:{email}:org:{org.org_uuid}")

    if not invited_user:
        raise HTTPException(
            status_code=404,
            detail="User not found",
        )

    r.delete(f"invited_user:{email}:org:{org.org_uuid}")

    return {"detail": "User removed"}



================================================
FILE: apps/api/src/services/payments/payments_access.py
================================================
from sqlmodel import Session, select
from src.security.rbac.rbac import authorization_verify_if_user_is_author
from src.db.payments.payments_users import PaymentStatusEnum, PaymentsUser
from src.db.users import PublicUser, AnonymousUser
from src.db.payments.payments_courses import PaymentsCourse
from src.db.courses.activities import Activity
from src.db.courses.courses import Course
from fastapi import HTTPException, Request

async def check_activity_paid_access(
    request: Request,
    activity_id: int,
    user: PublicUser | AnonymousUser,
    db_session: Session,
) -> bool:
    """
    Check if a user has access to a specific activity
    Returns True if:
    - User is an author of the course
    - Activity is in a free course
    - User has a valid subscription for the course
    """


    # Get activity and associated course
    statement = select(Activity).where(Activity.id == activity_id)
    activity = db_session.exec(statement).first()

    if not activity:
        raise HTTPException(status_code=404, detail="Activity not found")

    # Check if course exists
    statement = select(Course).where(Course.id == activity.course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(status_code=404, detail="Course not found")
    
    # Check if user is author of the course
    is_course_author = await authorization_verify_if_user_is_author(request, user.id, "update", course.course_uuid, db_session)

    if is_course_author:
        return True

    # Check if course is linked to a product
    statement = select(PaymentsCourse).where(PaymentsCourse.course_id == course.id)
    course_payment = db_session.exec(statement).first()

    # If course is not linked to any product, it's free
    if not course_payment:
        return True
    
    # Anonymous users have no access to paid activities
    if isinstance(user, AnonymousUser):
        return False
    
    # Check if user has a valid subscription or payment
    statement = select(PaymentsUser).where(
        PaymentsUser.user_id == user.id,
        PaymentsUser.payment_product_id == course_payment.payment_product_id,
        PaymentsUser.status.in_( # type: ignore
            [PaymentStatusEnum.ACTIVE, PaymentStatusEnum.COMPLETED]
        ),
    )
    access = db_session.exec(statement).first()

    return bool(access)

async def check_course_paid_access(
    course_id: int,
    user: PublicUser | AnonymousUser,
    db_session: Session,
) -> bool:
    """
    Check if a user has paid access to a specific course
    Returns True if:
    - User is an author of the course
    - Course is free (not linked to any product)
    - User has a valid subscription for the course
    """
    # Check if course exists
    statement = select(Course).where(Course.id == course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(status_code=404, detail="Course not found")

    # Check if course is linked to a product
    statement = select(PaymentsCourse).where(PaymentsCourse.course_id == course.id)
    course_payment = db_session.exec(statement).first()

    # If course is not linked to any product, it's free
    if not course_payment:
        return True

    # Check if user has a valid subscription
    statement = select(PaymentsUser).where(
        PaymentsUser.user_id == user.id,
        PaymentsUser.payment_product_id == course_payment.payment_product_id,
        PaymentsUser.status.in_( # type: ignore
            [PaymentStatusEnum.ACTIVE, PaymentStatusEnum.COMPLETED]
        ),
    )
    subscription = db_session.exec(statement).first()

    return bool(subscription)



================================================
FILE: apps/api/src/services/payments/payments_config.py
================================================
from typing import Literal
from fastapi import HTTPException, Request
from sqlmodel import Session, select
from src.db.payments.payments import (
    PaymentProviderEnum,
    PaymentsConfig,
    PaymentsConfigUpdate,
    PaymentsConfigRead,
)
from src.db.users import PublicUser, AnonymousUser, InternalUser
from src.db.organizations import Organization
from src.services.orgs.orgs import rbac_check


async def init_payments_config(
    request: Request,
    org_id: int,
    provider: Literal["stripe"],
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> PaymentsConfig:
    # Validate organization exists
    org = db_session.exec(
        select(Organization).where(Organization.id == org_id)
    ).first()
    if not org:
        raise HTTPException(status_code=404, detail="Organization not found")

    # Verify permissions
    await rbac_check(request, org.org_uuid, current_user, "create", db_session)

    # Check for existing config
    existing_config = db_session.exec(
        select(PaymentsConfig).where(PaymentsConfig.org_id == org_id)
    ).first()
    
    if existing_config:
        raise HTTPException(
            status_code=409,
            detail="Payments config already exists for this organization"
        )

    # Initialize new config
    new_config = PaymentsConfig(
        org_id=org_id,
        provider=PaymentProviderEnum.STRIPE,
        provider_config={
            "onboarding_completed": False,
        },
        provider_specific_id=None
    )

    # Save to database
    db_session.add(new_config)
    db_session.commit()
    db_session.refresh(new_config)

    return new_config


async def get_payments_config(
    request: Request,
    org_id: int,
    current_user: PublicUser | AnonymousUser | InternalUser,
    db_session: Session,
) -> list[PaymentsConfigRead]:
    # Check if organization exists
    statement = select(Organization).where(Organization.id == org_id)
    org = db_session.exec(statement).first()
    if not org:
        raise HTTPException(status_code=404, detail="Organization not found")

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "read", db_session)

    # Get payments config
    statement = select(PaymentsConfig).where(PaymentsConfig.org_id == org_id)
    configs = db_session.exec(statement).all()

    return [PaymentsConfigRead.model_validate(config) for config in configs]


async def update_payments_config(
    request: Request,
    org_id: int,
    payments_config: PaymentsConfigUpdate,
    current_user: PublicUser | AnonymousUser | InternalUser,
    db_session: Session,
) -> PaymentsConfig:
    # Check if organization exists
    statement = select(Organization).where(Organization.id == org_id)
    org = db_session.exec(statement).first()
    if not org:
        raise HTTPException(status_code=404, detail="Organization not found")

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "update", db_session)

    # Get existing payments config
    statement = select(PaymentsConfig).where(PaymentsConfig.org_id == org_id)
    config = db_session.exec(statement).first()
    if not config:
        raise HTTPException(status_code=404, detail="Payments config not found")

    # Update config
    for key, value in payments_config.model_dump().items():
        setattr(config, key, value)

    db_session.add(config)
    db_session.commit()
    db_session.refresh(config)

    return config


async def delete_payments_config(
    request: Request,
    org_id: int,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> None:
    # Check if organization exists
    statement = select(Organization).where(Organization.id == org_id)
    org = db_session.exec(statement).first()
    if not org:
        raise HTTPException(status_code=404, detail="Organization not found")

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "delete", db_session)

    # Get existing payments config
    statement = select(PaymentsConfig).where(PaymentsConfig.org_id == org_id)
    config = db_session.exec(statement).first()
    if not config:
        raise HTTPException(status_code=404, detail="Payments config not found")

    # Delete config
    db_session.delete(config)
    db_session.commit()



================================================
FILE: apps/api/src/services/payments/payments_courses.py
================================================
from fastapi import HTTPException, Request
from sqlmodel import Session, select
from src.db.payments.payments_courses import PaymentsCourse
from src.db.payments.payments_products import PaymentsProduct
from src.db.courses.courses import Course
from src.db.users import PublicUser, AnonymousUser
from src.security.courses_security import courses_rbac_check

async def link_course_to_product(
    request: Request,
    org_id: int,
    course_id: int,
    product_id: int,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    # Check if course exists and user has permission
    statement = select(Course).where(Course.id == course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(status_code=404, detail="Course not found")

    # RBAC check
    await courses_rbac_check(request, course.course_uuid, current_user, "update", db_session)

    # Check if product exists
    statement = select(PaymentsProduct).where(
        PaymentsProduct.id == product_id,
        PaymentsProduct.org_id == org_id
    )
    product = db_session.exec(statement).first()

    if not product:
        raise HTTPException(status_code=404, detail="Product not found")

    # Check if course is already linked to another product
    statement = select(PaymentsCourse).where(PaymentsCourse.course_id == course.id)
    existing_link = db_session.exec(statement).first()

    if existing_link:
        raise HTTPException(
            status_code=400,
            detail="Course is already linked to a product"
        )

    # Create new payment course link
    payment_course = PaymentsCourse(
        course_id=course.id,  # type: ignore
        payment_product_id=product_id,
        org_id=org_id,
    )

    db_session.add(payment_course)
    db_session.commit()

    return {"message": "Course linked to product successfully"}

async def unlink_course_from_product(
    request: Request,
    org_id: int,
    course_id: int,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    # Check if course exists and user has permission
    statement = select(Course).where(Course.id == course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(status_code=404, detail="Course not found")

    # RBAC check
    await courses_rbac_check(request, course.course_uuid, current_user, "update", db_session)

    # Find and delete the payment course link
    statement = select(PaymentsCourse).where(
        PaymentsCourse.course_id == course.id,
        PaymentsCourse.org_id == org_id
    )
    payment_course = db_session.exec(statement).first()

    if not payment_course:
        raise HTTPException(
            status_code=404,
            detail="Course is not linked to any product"
        )

    db_session.delete(payment_course)
    db_session.commit()

    return {"message": "Course unlinked from product successfully"}

async def get_courses_by_product(
    request: Request,
    org_id: int,
    product_id: int,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    # Check if product exists
    statement = select(PaymentsProduct).where(
        PaymentsProduct.id == product_id,
        PaymentsProduct.org_id == org_id
    )
    product = db_session.exec(statement).first()

    if not product:
        raise HTTPException(status_code=404, detail="Product not found")

    # Get all courses linked to this product with explicit join
    statement = (
        select(Course)
        .select_from(Course)
        .join(PaymentsCourse, Course.id == PaymentsCourse.course_id)  # type: ignore
        .where(
            PaymentsCourse.payment_product_id == product_id,
            PaymentsCourse.org_id == org_id
        )
    )
    courses = db_session.exec(statement).all()

    return courses



================================================
FILE: apps/api/src/services/payments/payments_customers.py
================================================
from fastapi import HTTPException, Request
from sqlmodel import Session, select
from src.db.organizations import Organization
from src.db.users import PublicUser, AnonymousUser
from src.db.payments.payments_users import PaymentsUser
from src.services.orgs.orgs import rbac_check
from src.services.payments.payments_products import get_payments_product
from src.services.users.users import read_user_by_id

async def get_customers(
    request: Request,
    org_id: int,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    # Check if organization exists
    statement = select(Organization).where(Organization.id == org_id)
    org = db_session.exec(statement).first()
    if not org:
        raise HTTPException(status_code=404, detail="Organization not found")

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "read", db_session)

    # Get all payment users for the organization
    statement = select(PaymentsUser).where(PaymentsUser.org_id == org_id)
    payment_users = db_session.exec(statement).all()

    customers_data = []
    
    for payment_user in payment_users:
        # Get user data
        user = await read_user_by_id(request, db_session, current_user, payment_user.user_id)
        
        # Get product data
        if org.id is None:
            raise HTTPException(status_code=400, detail="Invalid organization ID")
        product = await get_payments_product(request, org.id, payment_user.payment_product_id, current_user, db_session)

        customer_data = {
            'payment_user_id': payment_user.id,
            'user': user if user else None,
            'product': product if product else None,
            'status': payment_user.status,
            'creation_date': payment_user.creation_date,
            'update_date': payment_user.update_date
        }
        customers_data.append(customer_data)

    return customers_data


================================================
FILE: apps/api/src/services/payments/payments_products.py
================================================
from fastapi import HTTPException, Request
from sqlmodel import Session, select
from src.db.courses.courses import Course
from src.db.payments.payments import PaymentsConfig
from src.db.payments.payments_courses import PaymentsCourse
from src.db.payments.payments_products import (
    PaymentsProduct,
    PaymentsProductCreate,
    PaymentsProductUpdate,
    PaymentsProductRead,
)
from src.db.payments.payments_users import PaymentStatusEnum, PaymentsUser
from src.db.users import PublicUser, AnonymousUser
from src.db.organizations import Organization
from src.services.orgs.orgs import rbac_check
from datetime import datetime

from src.services.payments.payments_stripe import archive_stripe_product, create_stripe_product, update_stripe_product

async def create_payments_product(
    request: Request,
    org_id: int,
    payments_product: PaymentsProductCreate,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> PaymentsProductRead:
    # Check if organization exists
    statement = select(Organization).where(Organization.id == org_id)
    org = db_session.exec(statement).first()
    if not org:
        raise HTTPException(status_code=404, detail="Organization not found")

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "create", db_session)

    # Check if payments config exists, has a valid id, and is active
    statement = select(PaymentsConfig).where(PaymentsConfig.org_id == org_id)
    config = db_session.exec(statement).first()
    if not config or config.id is None:
        raise HTTPException(status_code=404, detail="Valid payments config not found")

    if not config.active:
        raise HTTPException(status_code=400, detail="Payments config is not active")

    # Create new payments product
    new_product = PaymentsProduct(**payments_product.model_dump(), org_id=org_id, payments_config_id=config.id)
    new_product.creation_date = datetime.now()
    new_product.update_date = datetime.now()

    # Create product in Stripe
    stripe_product = await create_stripe_product(request, org_id, new_product, current_user, db_session)
    new_product.provider_product_id = stripe_product.id

    # Save to DB
    db_session.add(new_product)
    db_session.commit()
    db_session.refresh(new_product)    

    return PaymentsProductRead.model_validate(new_product)

async def get_payments_product(
    request: Request,
    org_id: int,
    product_id: int,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> PaymentsProductRead:
    # Check if organization exists
    statement = select(Organization).where(Organization.id == org_id)
    org = db_session.exec(statement).first()
    if not org:
        raise HTTPException(status_code=404, detail="Organization not found")

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "read", db_session)

    # Get payments product
    statement = select(PaymentsProduct).where(PaymentsProduct.id == product_id, PaymentsProduct.org_id == org_id)
    product = db_session.exec(statement).first()
    if not product:
        raise HTTPException(status_code=404, detail="Payments product not found")

    return PaymentsProductRead.model_validate(product)

async def update_payments_product(
    request: Request,
    org_id: int,
    product_id: int,
    payments_product: PaymentsProductUpdate,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> PaymentsProductRead:
    # Check if organization exists
    statement = select(Organization).where(Organization.id == org_id)
    org = db_session.exec(statement).first()
    if not org:
        raise HTTPException(status_code=404, detail="Organization not found")

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "update", db_session)

    # Get existing payments product
    statement = select(PaymentsProduct).where(PaymentsProduct.id == product_id, PaymentsProduct.org_id == org_id)
    product = db_session.exec(statement).first()
    if not product:
        raise HTTPException(status_code=404, detail="Payments product not found")

    # Update product
    for key, value in payments_product.model_dump().items():
        setattr(product, key, value)
    
    product.update_date = datetime.now()

    db_session.add(product)
    db_session.commit()
    db_session.refresh(product)

    # Update product in Stripe
    await update_stripe_product(request, org_id, product.provider_product_id, product, current_user, db_session)

    return PaymentsProductRead.model_validate(product)

async def delete_payments_product(
    request: Request,
    org_id: int,
    product_id: int,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> None:
    # Check if organization exists
    statement = select(Organization).where(Organization.id == org_id)
    org = db_session.exec(statement).first()
    if not org:
        raise HTTPException(status_code=404, detail="Organization not found")

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "delete", db_session)

    # Get existing payments product
    statement = select(PaymentsProduct).where(PaymentsProduct.id == product_id, PaymentsProduct.org_id == org_id)
    product = db_session.exec(statement).first()
    if not product:
        raise HTTPException(status_code=404, detail="Payments product not found")
    
    # Check if there are any payment users linked to this product
    statement = select(PaymentsUser).where(
        PaymentsUser.payment_product_id == product_id,
        PaymentsUser.status.in_([PaymentStatusEnum.ACTIVE, PaymentStatusEnum.COMPLETED]) # type: ignore
    )
    payment_users = db_session.exec(statement).all()
    if payment_users:
        raise HTTPException(
            status_code=400, 
            detail="Cannot delete product because users have paid access to it."
        )

    # Archive product in Stripe
    await archive_stripe_product(request, org_id, product.provider_product_id, current_user, db_session)

    # Delete product
    db_session.delete(product)
    db_session.commit()

async def list_payments_products(
    request: Request,
    org_id: int,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> list[PaymentsProductRead]:
    # Check if organization exists
    statement = select(Organization).where(Organization.id == org_id)
    org = db_session.exec(statement).first()
    if not org:
        raise HTTPException(status_code=404, detail="Organization not found")

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "read", db_session)

    # Get payments products ordered by id
    statement = select(PaymentsProduct).where(PaymentsProduct.org_id == org_id).order_by(PaymentsProduct.id.desc()) # type: ignore
    products = db_session.exec(statement).all()

    return [PaymentsProductRead.model_validate(product) for product in products]

async def get_products_by_course(
    request: Request,
    org_id: int,
    course_id: int,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> list[PaymentsProductRead]:
    # Check if course exists and user has permission
    statement = select(Course).where(Course.id == course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(status_code=404, detail="Course not found")

    # RBAC check
    await rbac_check(request, course.course_uuid, current_user, "read", db_session)

    # Get all products linked to this course with explicit join
    statement = (
        select(PaymentsProduct)
        .select_from(PaymentsProduct)
        .join(PaymentsCourse, PaymentsProduct.id == PaymentsCourse.payment_product_id) # type: ignore
        .where(
            PaymentsCourse.course_id == course_id,
            PaymentsCourse.org_id == org_id
        )
    )
    products = db_session.exec(statement).all()

    return [PaymentsProductRead.model_validate(product) for product in products]





================================================
FILE: apps/api/src/services/payments/payments_stripe.py
================================================
import logging
from typing import Literal
from fastapi import HTTPException, Request
from sqlmodel import Session
import stripe
from config.config import  get_learnhouse_config
from src.db.payments.payments import PaymentsConfigUpdate, PaymentsConfig
from src.db.payments.payments_products import (
    PaymentPriceTypeEnum,
    PaymentProductTypeEnum,
    PaymentsProduct,
)
from src.db.payments.payments_users import PaymentStatusEnum
from src.db.users import AnonymousUser, InternalUser, PublicUser
from src.services.payments.payments_config import (
    get_payments_config,
    update_payments_config,
)
from sqlmodel import select

from src.services.payments.payments_users import (
    create_payment_user,
    delete_payment_user,
)


async def get_stripe_connected_account_id(
    request: Request,
    org_id: int,
    current_user: PublicUser | AnonymousUser | InternalUser,
    db_session: Session,
):
    # Get payments config
    payments_config = await get_payments_config(request, org_id, current_user, db_session)

    return payments_config[0].provider_specific_id


async def get_stripe_internal_credentials(
):
    # Get payments config from config file
    learnhouse_config = get_learnhouse_config()

    if not learnhouse_config.payments_config.stripe.stripe_secret_key:
        raise HTTPException(status_code=400, detail="Stripe secret key not configured")

    if not learnhouse_config.payments_config.stripe.stripe_publishable_key:
        raise HTTPException(
            status_code=400, detail="Stripe publishable key not configured"
        )

    return {
        "stripe_secret_key": learnhouse_config.payments_config.stripe.stripe_secret_key,
        "stripe_publishable_key": learnhouse_config.payments_config.stripe.stripe_publishable_key,
        "stripe_webhook_standard_secret": learnhouse_config.payments_config.stripe.stripe_webhook_standard_secret,
        "stripe_webhook_connect_secret": learnhouse_config.payments_config.stripe.stripe_webhook_connect_secret,
    }


async def create_stripe_product(
    request: Request,
    org_id: int,
    product_data: PaymentsProduct,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    creds = await get_stripe_internal_credentials()

    # Set the Stripe API key using the credentials
    stripe.api_key = creds.get("stripe_secret_key")

    # Prepare default_price_data based on price_type
    if product_data.price_type == PaymentPriceTypeEnum.CUSTOMER_CHOICE:
        default_price_data = {
            "currency": product_data.currency,
            "custom_unit_amount": {
                "enabled": True,
                "minimum": int(product_data.amount * 100),  # Convert to cents
            },
        }
    else:
        default_price_data = {
            "currency": product_data.currency,
            "unit_amount": int(product_data.amount * 100),  # Convert to cents
        }

    if product_data.product_type == PaymentProductTypeEnum.SUBSCRIPTION:
        default_price_data["recurring"] = {"interval": "month"}

    stripe_acc_id = await get_stripe_connected_account_id(request, org_id, current_user, db_session)

    product = stripe.Product.create(
        name=product_data.name,
        description=product_data.description or "",
        marketing_features=[
            {"name": benefit.strip()}
            for benefit in product_data.benefits.split(",")
            if benefit.strip()
        ],
        default_price_data=default_price_data,  # type: ignore
        stripe_account=stripe_acc_id,
    )

    return product


async def archive_stripe_product(
    request: Request,
    org_id: int,
    product_id: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    creds = await get_stripe_internal_credentials()

    # Set the Stripe API key using the credentials
    stripe.api_key = creds.get("stripe_secret_key")

    stripe_acc_id = await get_stripe_connected_account_id(request, org_id, current_user, db_session)

    try:
        # Archive the product in Stripe
        archived_product = stripe.Product.modify(product_id, active=False, stripe_account=stripe_acc_id)

        return archived_product
    except stripe.StripeError as e:
        print(f"Error archiving Stripe product: {str(e)}")
        raise HTTPException(
            status_code=400, detail=f"Error archiving Stripe product: {str(e)}"
        )


async def update_stripe_product(
    request: Request,
    org_id: int,
    product_id: str,
    product_data: PaymentsProduct,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    creds = await get_stripe_internal_credentials()

    # Set the Stripe API key using the credentials
    stripe.api_key = creds.get("stripe_secret_key")

    stripe_acc_id = await get_stripe_connected_account_id(request, org_id, current_user, db_session)

    try:
        # Create new price based on price_type
        if product_data.price_type == PaymentPriceTypeEnum.CUSTOMER_CHOICE:
            new_price_data = {
                "currency": product_data.currency,
                "product": product_id,
                "custom_unit_amount": {
                    "enabled": True,
                    "minimum": int(product_data.amount * 100),  # Convert to cents
                },
            }
        else:
            new_price_data = {
                "currency": product_data.currency,
                "unit_amount": int(product_data.amount * 100),  # Convert to cents
                "product": product_id,
            }

        if product_data.product_type == PaymentProductTypeEnum.SUBSCRIPTION:
            new_price_data["recurring"] = {"interval": "month"}

        new_price = stripe.Price.create(**new_price_data)

        # Prepare the update data
        update_data = {
            "name": product_data.name,
            "description": product_data.description or "",
            "metadata": {"benefits": product_data.benefits},
            "marketing_features": [
                {"name": benefit.strip()}
                for benefit in product_data.benefits.split(",")
                if benefit.strip()
            ],
            "default_price": new_price.id,
        }

        # Update the product in Stripe
        updated_product = stripe.Product.modify(product_id, **update_data, stripe_account=stripe_acc_id)

        # Archive all existing prices for the product
        existing_prices = stripe.Price.list(product=product_id, active=True)
        for price in existing_prices:
            if price.id != new_price.id:
                stripe.Price.modify(price.id, active=False, stripe_account=stripe_acc_id)

        return updated_product
    except stripe.StripeError as e:
        raise HTTPException(
            status_code=400, detail=f"Error updating Stripe product: {str(e)}"
        )


async def create_checkout_session(
    request: Request,
    org_id: int,
    product_id: int,
    redirect_uri: str,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
):
    # Get Stripe credentials
    creds = await get_stripe_internal_credentials()
    stripe.api_key = creds.get("stripe_secret_key")


    stripe_acc_id = await get_stripe_connected_account_id(request, org_id, current_user, db_session)

    # Get product details
    statement = select(PaymentsProduct).where(
        PaymentsProduct.id == product_id, PaymentsProduct.org_id == org_id
    )
    product = db_session.exec(statement).first()

    if not product:
        raise HTTPException(status_code=404, detail="Product not found")

    success_url = redirect_uri
    cancel_url = redirect_uri

    # Get the default price for the product
    stripe_product = stripe.Product.retrieve(product.provider_product_id, stripe_account=stripe_acc_id)
    line_items = [{"price": stripe_product.default_price, "quantity": 1}]


    # Create or retrieve Stripe customer
    try:
        customers = stripe.Customer.list(
            email=current_user.email, stripe_account=stripe_acc_id
        )
        if customers.data:
            customer = customers.data[0]
        else:
            customer = stripe.Customer.create(
                email=current_user.email,
                metadata={
                    "user_id": str(current_user.id),
                    "org_id": str(org_id),
                },
                stripe_account=stripe_acc_id,
            )

        # Create initial payment user with pending status
        payment_user = await create_payment_user(
            request=request,
            org_id=org_id,
            user_id=current_user.id,
            product_id=product_id,
            status=PaymentStatusEnum.PENDING,
            provider_data=customer,
            current_user=InternalUser(),
            db_session=db_session,
        )

        if not payment_user:
            raise HTTPException(status_code=400, detail="Error creating payment user")

    except stripe.StripeError as e:
        # Clean up payment user if customer creation fails
        if payment_user and payment_user.id:
            await delete_payment_user(
                request, org_id, payment_user.id, InternalUser(), db_session
            )
        raise HTTPException(
            status_code=400, detail=f"Error creating/retrieving customer: {str(e)}"
        )

    # Create checkout session with customer
    try:
        checkout_session_params = {
            "success_url": success_url,
            "cancel_url": cancel_url,
            "mode": (
                "payment"
                if product.product_type == PaymentProductTypeEnum.ONE_TIME
                else "subscription"
            ),
            "line_items": line_items,
            "customer": customer.id,
            "metadata": {
                "product_id": str(product.id),
                "payment_user_id": str(payment_user.id),
            }
        }

        # Add payment_intent_data only for one-time payments
        if product.product_type == PaymentProductTypeEnum.ONE_TIME:
            checkout_session_params["payment_intent_data"] = {
                "metadata": {
                    "product_id": str(product.id),
                    "payment_user_id": str(payment_user.id),
                }
            }
        # Add subscription_data for subscription payments
        else:
            checkout_session_params["subscription_data"] = {
                "metadata": {
                    "product_id": str(product.id),
                    "payment_user_id": str(payment_user.id),
                }
            }

        checkout_session = stripe.checkout.Session.create(**checkout_session_params, stripe_account=stripe_acc_id)

        return {"checkout_url": checkout_session.url, "session_id": checkout_session.id}

    except stripe.StripeError as e:
        # Clean up payment user if checkout session creation fails
        if payment_user and payment_user.id:
            await delete_payment_user(
                request, org_id, payment_user.id, InternalUser(), db_session
            )
        logging.error(f"Error creating checkout session: {str(e)}")
        raise HTTPException(status_code=400, detail=str(e))


async def generate_stripe_connect_link(
    request: Request,
    org_id: int,
    redirect_uri: str,
    current_user: PublicUser | AnonymousUser | InternalUser,
    db_session: Session,
):
    """
    Generate a Stripe OAuth link for connecting a Stripe account
    """
    # Get credentials
    creds = await get_stripe_internal_credentials()
    stripe.api_key = creds.get("stripe_secret_key")
    
    # Get learnhouse config for client_id
    learnhouse_config = get_learnhouse_config()
    client_id = learnhouse_config.payments_config.stripe.stripe_client_id
    
    if not client_id:
        raise HTTPException(status_code=400, detail="Stripe client ID not configured")

    state = f"org_id={org_id}"
    
    # Generate OAuth link for existing accounts
    oauth_link = f"https://connect.stripe.com/oauth/authorize?response_type=code&client_id={client_id}&scope=read_write&redirect_uri={redirect_uri}&state={state}"

    return {"connect_url": oauth_link}

async def create_stripe_account(
    request: Request,
    org_id: int,
    type: Literal["standard"], # Only standard is supported for now, we'll see if we need express later
    current_user: PublicUser | AnonymousUser | InternalUser,
    db_session: Session,
):
    # Get credentials
    creds = await get_stripe_internal_credentials()
    stripe.api_key = creds.get("stripe_secret_key")

    # Get existing payments config
    statement = select(PaymentsConfig).where(PaymentsConfig.org_id == org_id)
    existing_config = db_session.exec(statement).first()

    if existing_config and existing_config.provider_specific_id:
        logging.error(f"A Stripe Account is already linked to this organization: {existing_config.provider_specific_id}")
        return existing_config.provider_specific_id

    # Create Stripe account
    stripe_account = stripe.Account.create(
        type="standard",
        capabilities={
            "card_payments": {"requested": True},
            "transfers": {"requested": True},
        },
    )

    config_data = existing_config.model_dump() if existing_config else {}
    config_data.update({
            "enabled": True,
            "provider_specific_id": stripe_account.id,  # Use the ID directly
        "provider_config": {"onboarding_completed": False}
    })

    # Update payments config for the org
    await update_payments_config(
        request,
        org_id,
        PaymentsConfigUpdate(**config_data),
        current_user,
        db_session,
    )

    return stripe_account


async def update_stripe_account_id(
    request: Request,
    org_id: int,
    stripe_account_id: str,
    current_user: PublicUser | AnonymousUser | InternalUser,
    db_session: Session,
):
    """
    Update the Stripe account ID for an organization
    """
    # Get existing payments config
    statement = select(PaymentsConfig).where(PaymentsConfig.org_id == org_id)
    existing_config = db_session.exec(statement).first()

    if not existing_config:
        raise HTTPException(
            status_code=404,
            detail="No payments configuration found for this organization"
        )

    # Create config update with existing values but new stripe account id
    config_data = existing_config.model_dump()
    config_data["provider_specific_id"] = stripe_account_id

    # Update payments config
    await update_payments_config(
        request,
        org_id,
        PaymentsConfigUpdate(**config_data),
        current_user,
        db_session,
    )

    return {"message": "Stripe account ID updated successfully"}

async def handle_stripe_oauth_callback(
    request: Request,
    org_id: int,
    code: str,
    current_user: PublicUser | AnonymousUser | InternalUser,
    db_session: Session,
):
    """
    Handle the OAuth callback from Stripe and complete the account connection
    """
    creds = await get_stripe_internal_credentials()
    stripe.api_key = creds.get("stripe_secret_key")

    try:
        # Exchange the authorization code for an access token
        response = stripe.OAuth.token(
            grant_type='authorization_code',
            code=code,
        )
        
        connected_account_id = response.stripe_user_id
        if not connected_account_id:
            raise HTTPException(status_code=400, detail="No account ID received from Stripe")

        # Now connected_account_id is guaranteed to be a string
        await update_stripe_account_id(
            request,
            org_id,
            connected_account_id,
            current_user,
            db_session,
        )

        return {"success": True, "account_id": connected_account_id}

    except stripe.StripeError as e:
        logging.error(f"Error connecting Stripe account: {str(e)}")
        raise HTTPException(
            status_code=400,
            detail=f"Error connecting Stripe account: {str(e)}"
        )



================================================
FILE: apps/api/src/services/payments/payments_users.py
================================================
from fastapi import HTTPException, Request
from sqlmodel import Session, select
from typing import Any
from src.db.courses.courses import Course, CourseRead, AuthorWithRole
from src.db.payments.payments_courses import PaymentsCourse
from src.db.payments.payments_users import PaymentsUser, PaymentStatusEnum, ProviderSpecificData
from src.db.payments.payments_products import PaymentsProduct
from src.db.resource_authors import ResourceAuthor
from src.db.users import InternalUser, PublicUser, AnonymousUser, User, UserRead
from src.db.organizations import Organization
from src.services.orgs.orgs import rbac_check
from datetime import datetime

async def create_payment_user(
    request: Request,
    org_id: int,
    user_id: int,
    product_id: int,
    status: PaymentStatusEnum,
    provider_data: Any,
    current_user: PublicUser | AnonymousUser | InternalUser,
    db_session: Session,
) -> PaymentsUser:
    # Check if organization exists
    statement = select(Organization).where(Organization.id == org_id)
    org = db_session.exec(statement).first()
    if not org:
        raise HTTPException(status_code=404, detail="Organization not found")

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "create", db_session)

    # Check if product exists
    statement = select(PaymentsProduct).where(
        PaymentsProduct.id == product_id,
        PaymentsProduct.org_id == org_id
    )
    product = db_session.exec(statement).first()
    if not product:
        raise HTTPException(status_code=404, detail="Product not found")
    
    provider_specific_data = ProviderSpecificData(
        stripe_customer=provider_data if provider_data else None,
    )

    # Check if user already has a payment user for this product
    statement = select(PaymentsUser).where(
        PaymentsUser.user_id == user_id,
        PaymentsUser.org_id == org_id,
        PaymentsUser.payment_product_id == product_id
    )
    existing_payment_user = db_session.exec(statement).first()

    if existing_payment_user:
        # If status is PENDING, CANCELLED, or FAILED, delete the existing record
        if existing_payment_user.status in [
            PaymentStatusEnum.PENDING,
            PaymentStatusEnum.CANCELLED,
            PaymentStatusEnum.FAILED
        ]:
            db_session.delete(existing_payment_user)
            db_session.commit()
        else:
            raise HTTPException(status_code=400, detail="User already has purchase for this product")

    # Create new payment user
    payment_user = PaymentsUser(
        user_id=user_id,
        org_id=org_id,
        payment_product_id=product_id,
        provider_specific_data=provider_specific_data.model_dump(),
        status=status
    )

    db_session.add(payment_user)
    db_session.commit()
    db_session.refresh(payment_user)

    return payment_user

async def get_payment_user(
    request: Request,
    org_id: int,
    payment_user_id: int,
    current_user: PublicUser | AnonymousUser | InternalUser,
    db_session: Session,
) -> PaymentsUser:
    # Check if organization exists
    statement = select(Organization).where(Organization.id == org_id)
    org = db_session.exec(statement).first()
    if not org:
        raise HTTPException(status_code=404, detail="Organization not found")

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "read", db_session)

    # Get payment user
    statement = select(PaymentsUser).where(
        PaymentsUser.id == payment_user_id,
        PaymentsUser.org_id == org_id
    )
    payment_user = db_session.exec(statement).first()
    if not payment_user:
        raise HTTPException(status_code=404, detail="Payment user not found")

    return payment_user

async def update_payment_user_status(
    request: Request,
    org_id: int,
    payment_user_id: int,
    status: PaymentStatusEnum,
    current_user: PublicUser | AnonymousUser | InternalUser,
    db_session: Session,
) -> PaymentsUser:
    # Check if organization exists
    statement = select(Organization).where(Organization.id == org_id)
    org = db_session.exec(statement).first()
    if not org:
        raise HTTPException(status_code=404, detail="Organization not found")

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "update", db_session)

    # Get existing payment user
    statement = select(PaymentsUser).where(
        PaymentsUser.id == payment_user_id,
        PaymentsUser.org_id == org_id
    )
    payment_user = db_session.exec(statement).first()
    if not payment_user:
        raise HTTPException(status_code=404, detail="Payment user not found")

    # Update status
    payment_user.status = status
    payment_user.update_date = datetime.now()

    db_session.add(payment_user)
    db_session.commit()
    db_session.refresh(payment_user)

    return payment_user

async def list_payment_users(
    request: Request,
    org_id: int,
    current_user: PublicUser | AnonymousUser | InternalUser,
    db_session: Session,
) -> list[PaymentsUser]:
    # Check if organization exists
    statement = select(Organization).where(Organization.id == org_id)
    org = db_session.exec(statement).first()
    if not org:
        raise HTTPException(status_code=404, detail="Organization not found")

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "read", db_session)

    # Get all payment users for org ordered by id
    statement = select(PaymentsUser).where(
        PaymentsUser.org_id == org_id
    ).order_by(PaymentsUser.id.desc()) # type: ignore
    payment_users = list(db_session.exec(statement).all())  # Convert to list

    return payment_users

async def delete_payment_user(
    request: Request,
    org_id: int,
    payment_user_id: int,
    current_user: PublicUser | AnonymousUser | InternalUser,
    db_session: Session,
) -> None:
    # Check if organization exists
    statement = select(Organization).where(Organization.id == org_id)
    org = db_session.exec(statement).first()
    if not org:
        raise HTTPException(status_code=404, detail="Organization not found")

    # RBAC check
    await rbac_check(request, org.org_uuid, current_user, "delete", db_session)

    # Get existing payment user
    statement = select(PaymentsUser).where(
        PaymentsUser.id == payment_user_id,
        PaymentsUser.org_id == org_id
    )
    payment_user = db_session.exec(statement).first()
    if not payment_user:
        raise HTTPException(status_code=404, detail="Payment user not found")

    # Delete payment user
    db_session.delete(payment_user)
    db_session.commit()


async def get_owned_courses(
    request: Request,
    current_user: PublicUser | AnonymousUser,
    db_session: Session,
) -> list[CourseRead]:
    # Anonymous users don't own any courses
    if isinstance(current_user, AnonymousUser):
        return []

    # Get all active/completed payment users for the current user
    statement = select(PaymentsUser).where(
        PaymentsUser.user_id == current_user.id,
        PaymentsUser.status.in_([PaymentStatusEnum.ACTIVE, PaymentStatusEnum.COMPLETED])  # type: ignore
    )
    payment_users = db_session.exec(statement).all()

    # Get all product IDs from payment users
    product_ids = [pu.payment_product_id for pu in payment_users]

    # Get all courses linked to these products
    courses = []
    for product_id in product_ids:
        # Get courses linked to this product through PaymentsCourse
        statement = (
            select(Course)
            .join(PaymentsCourse, Course.id == PaymentsCourse.course_id)  # type: ignore
            .where(PaymentsCourse.payment_product_id == product_id)
        )
        product_courses = db_session.exec(statement).all()
        courses.extend(product_courses)

    # Remove duplicates by converting to set and back to list
    unique_courses = list({course.id: course for course in courses}.values())

    # Get authors for each course and convert to CourseRead
    course_reads = []
    for course in unique_courses:
        # Get course authors with their roles
        authors_statement = (
            select(ResourceAuthor, User)
            .join(User, ResourceAuthor.user_id == User.id)
            .where(ResourceAuthor.resource_uuid == course.course_uuid)
        )
        author_results = db_session.exec(authors_statement).all()

        # Convert to AuthorWithRole objects
        authors = [
            AuthorWithRole(
                user=UserRead.model_validate(user),
                authorship=resource_author.authorship,
                authorship_status=resource_author.authorship_status,
                creation_date=resource_author.creation_date,
                update_date=resource_author.update_date
            )
            for resource_author, user in author_results
        ]

        # Create CourseRead object
        course_read = CourseRead(**course.model_dump(), authors=authors)
        course_reads.append(course_read)

    return course_reads




================================================
FILE: apps/api/src/services/payments/utils/stripe_utils.py
================================================
from fastapi import HTTPException
from sqlmodel import Session, select
import stripe
import logging

from src.db.payments.payments_products import PaymentsProduct
from src.db.users import User
from src.db.payments.payments import PaymentsConfig

logger = logging.getLogger(__name__)

async def get_user_from_customer(customer_id: str, db_session: Session) -> User:
    """Helper function to get user from Stripe customer ID"""
    try:
        customer = stripe.Customer.retrieve(customer_id)
        statement = select(User).where(User.email == customer.email)
        user = db_session.exec(statement).first()
        if not user:
            raise HTTPException(
                status_code=404, detail=f"User not found for customer {customer_id}"
            )
        return user
    except stripe.StripeError as e:
        logger.error(f"Stripe error retrieving customer {customer_id}: {str(e)}")
        raise HTTPException(
            status_code=400, detail="Error retrieving customer information"
        )


async def get_product_from_stripe_id(
    product_id: str, db_session: Session
) -> PaymentsProduct:
    """Helper function to get product from Stripe product ID"""
    statement = select(PaymentsProduct).where(
        PaymentsProduct.provider_product_id == product_id
    )
    product = db_session.exec(statement).first()
    if not product:
        raise HTTPException(status_code=404, detail=f"Product not found: {product_id}")
    return product


async def get_org_id_from_stripe_account(
    stripe_account_id: str,
    db_session: Session,
) -> int:
    """Get organization ID from Stripe account ID"""
    statement = select(PaymentsConfig).where(
        PaymentsConfig.provider_specific_id == stripe_account_id
    )
    config = db_session.exec(statement).first()

    if not config:
        raise HTTPException(
            status_code=404,
            detail=f"No organization found for Stripe account {stripe_account_id}",
        )

    return config.org_id



================================================
FILE: apps/api/src/services/payments/webhooks/payments_webhooks.py
================================================
from typing import Literal
from fastapi import HTTPException, Request
from sqlmodel import Session, select
import stripe
import logging
from src.db.payments.payments_users import PaymentStatusEnum
from src.db.users import InternalUser
from src.services.payments.payments_users import update_payment_user_status
from src.services.payments.payments_stripe import get_stripe_internal_credentials
from src.db.payments.payments import PaymentsConfig, PaymentsConfigUpdate
from src.services.payments.payments_config import update_payments_config
from src.services.payments.utils.stripe_utils import get_org_id_from_stripe_account

logger = logging.getLogger(__name__)


async def handle_stripe_webhook(
    request: Request,
    webhook_type: Literal["connect", "standard"],
    db_session: Session,
) -> dict:
    # Get Stripe credentials
    creds = await get_stripe_internal_credentials()
    webhook_secret = creds.get(f'stripe_webhook_{webhook_type}_secret')
    stripe.api_key = creds.get("stripe_secret_key")
    
    if not webhook_secret:
        logger.error("Stripe webhook secret not configured")
        raise HTTPException(status_code=400, detail="Stripe webhook secret not configured")

    # Get request data
    payload = await request.body()
    sig_header = request.headers.get('stripe-signature')

    try:
        # Verify webhook signature
        event = stripe.Webhook.construct_event(payload, sig_header, webhook_secret)
    except ValueError:
        logger.error(ValueError)
        raise HTTPException(status_code=400, detail="Invalid payload")
    except stripe.SignatureVerificationError:
        logger.error(stripe.SignatureVerificationError)
        raise HTTPException(status_code=400, detail="Invalid signature")

    try:
        event_type = event.type
        event_data = event.data.object

        # Get organization ID based on the event type
        stripe_account_id = event.account
        if not stripe_account_id:
            logger.error("Stripe account ID not found")
            raise HTTPException(status_code=400, detail="Stripe account ID not found")
        
        org_id = await get_org_id_from_stripe_account(stripe_account_id, db_session)

        # Handle internal account events
        if event_type == 'account.application.authorized':
            statement = select(PaymentsConfig).where(PaymentsConfig.org_id == org_id)
            config = db_session.exec(statement).first()
            
            if not config:
                logger.error("No payments configuration found for this organization")
                raise HTTPException(
                    status_code=404,
                    detail="No payments configuration found for this organization"
                )

            config_data = config.model_dump()
            config_data.update({
                "enabled": True,
                "active": True,
                "provider_config": {
                    **config.provider_config,
                    "onboarding_completed": True
                }
            })
            await update_payments_config(
                request,
                org_id,
                PaymentsConfigUpdate(**config_data),
                InternalUser(),
                db_session,
            )

            logger.info(f"Account authorized for organization {org_id}")
            return {"status": "success", "message": "Account authorized successfully"}

        elif event_type == 'account.application.deauthorized':
            statement = select(PaymentsConfig).where(PaymentsConfig.org_id == org_id)
            config = db_session.exec(statement).first()
            
            if not config:
                raise HTTPException(
                    status_code=404,
                    detail="No payments configuration found for this organization"
                )

            config_data = config.model_dump()
            config_data.update({
                "enabled": True,
                "active": False,
                "provider_config": {
                    **config.provider_config,
                    "onboarding_completed": False
                }
            })
            await update_payments_config(
                request,
                org_id,
                PaymentsConfigUpdate(**config_data),
                InternalUser(),
                db_session,
            )

            logger.info(f"Account deauthorized for organization {org_id}")
            return {"status": "success", "message": "Account deauthorized successfully"}

        # Handle payment-related events
        elif event_type == "checkout.session.completed":
            session = event_data
            payment_user_id = int(session.get("metadata", {}).get("payment_user_id"))

            if session.get("mode") == "subscription":
                if session.get("subscription"):
                    await update_payment_user_status(
                        request=request,
                        org_id=org_id,
                        payment_user_id=payment_user_id,
                        status=PaymentStatusEnum.ACTIVE,
                        current_user=InternalUser(),
                        db_session=db_session,
                    )
            else:
                if session.get("payment_status") == "paid":
                    await update_payment_user_status(
                        request=request,
                        org_id=org_id,
                        payment_user_id=payment_user_id,
                        status=PaymentStatusEnum.COMPLETED,
                        current_user=InternalUser(),
                        db_session=db_session,
                    )

        elif event_type == "customer.subscription.deleted":
            subscription = event_data
            payment_user_id = int(subscription.get("metadata", {}).get("payment_user_id"))

            await update_payment_user_status(
                request=request,
                org_id=org_id,
                payment_user_id=payment_user_id,
                status=PaymentStatusEnum.CANCELLED,
                current_user=InternalUser(),
                db_session=db_session,
            )

        elif event_type == "payment_intent.payment_failed":
            payment_intent = event_data
            payment_user_id = int(payment_intent.get("metadata", {}).get("payment_user_id"))

            await update_payment_user_status(
                request=request,
                org_id=org_id,
                payment_user_id=payment_user_id,
                status=PaymentStatusEnum.FAILED,
                current_user=InternalUser(),
                db_session=db_session,
            )

        else:
            logger.warning(f"Unhandled event type: {event_type}")
            return {"status": "ignored", "message": f"Unhandled event type: {event_type}"}

        return {"status": "success"}

    except Exception as e:
        logger.error(f"Error processing webhook: {str(e)}")
        raise HTTPException(status_code=400, detail=f"Error processing webhook: {str(e)}") 


================================================
FILE: apps/api/src/services/roles/__init__.py
================================================
[Empty file]


================================================
FILE: apps/api/src/services/roles/roles.py
================================================
from typing import Literal, List
from uuid import uuid4
from sqlmodel import Session, select, text
from sqlalchemy.exc import IntegrityError
from src.security.rbac.rbac import (
    authorization_verify_based_on_roles_and_authorship,
    authorization_verify_if_user_is_anon,
)
from src.db.users import AnonymousUser, PublicUser
from src.db.roles import Role, RoleCreate, RoleRead, RoleUpdate, RoleTypeEnum
from src.db.organizations import Organization
from src.db.user_organizations import UserOrganization
from fastapi import HTTPException, Request
from datetime import datetime


async def create_role(
    request: Request,
    db_session: Session,
    role_object: RoleCreate,
    current_user: PublicUser,
):
    role = Role.model_validate(role_object)

    # RBAC check
    await rbac_check(request, current_user, "create", "role_xxx", db_session)

    # ============================================================================
    # VERIFICATION 1: Ensure the role is created as TYPE_ORGANIZATION and has an org_id
    # ============================================================================
    if not role.org_id:
        raise HTTPException(
            status_code=400,
            detail="Organization ID is required for role creation",
        )
    
    # Force the role type to be TYPE_ORGANIZATION for user-created roles
    role.role_type = RoleTypeEnum.TYPE_ORGANIZATION

    # ============================================================================
    # VERIFICATION 2: Check if the organization exists
    # ============================================================================
    statement = select(Organization).where(Organization.id == role.org_id)
    organization = db_session.exec(statement).first()
    
    if not organization:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # ============================================================================
    # VERIFICATION 3: Check if the current user is a member of the organization
    # ============================================================================
    statement = select(UserOrganization).where(
        UserOrganization.user_id == current_user.id,
        UserOrganization.org_id == role.org_id
    )
    user_org = db_session.exec(statement).first()
    
    if not user_org:
        raise HTTPException(
            status_code=403,
            detail="You are not a member of this organization",
        )

    # ============================================================================
    # VERIFICATION 4: Check if the user has permission to create roles in this organization
    # ============================================================================
    # Get the user's role in this organization
    statement = select(Role).where(Role.id == user_org.role_id)
    user_role = db_session.exec(statement).first()
    
    if not user_role:
        raise HTTPException(
            status_code=403,
            detail="Your role in this organization could not be determined",
        )

    # Check if the user has role creation permissions
    if user_role.rights and isinstance(user_role.rights, dict):
        roles_rights = user_role.rights.get('roles', {})
        if not roles_rights.get('action_create', False):
            raise HTTPException(
                status_code=403,
                detail="You don't have permission to create roles in this organization",
            )
    else:
        # If no rights are defined, check if user has admin role (role_id 1 or 2)
        if user_role.id not in [1, 2]:  # Admin and Maintainer roles
            raise HTTPException(
                status_code=403,
                detail="You don't have permission to create roles in this organization. Admin or Maintainer role required.",
            )

    # ============================================================================
    # VERIFICATION 5: Check if a role with the same name already exists in this organization
    # ============================================================================
    statement = select(Role).where(
        Role.name == role.name,
        Role.org_id == role.org_id,
        Role.role_type == RoleTypeEnum.TYPE_ORGANIZATION
    )
    existing_role = db_session.exec(statement).first()
    
    if existing_role:
        raise HTTPException(
            status_code=409,
            detail=f"A role with the name '{role.name}' already exists in this organization",
        )

    # ============================================================================
    # VERIFICATION 6: Validate role name and description
    # ============================================================================
    if not role.name or role.name.strip() == "":
        raise HTTPException(
            status_code=400,
            detail="Role name is required and cannot be empty",
        )
    
    if len(role.name.strip()) > 100:  # Assuming a reasonable limit
        raise HTTPException(
            status_code=400,
            detail="Role name cannot exceed 100 characters",
        )

    # ============================================================================
    # VERIFICATION 7: Validate rights structure if provided
    # ============================================================================
    if role.rights:
        # Convert Rights model to dict if needed
        if isinstance(role.rights, dict):
            # It's already a dict
            rights_dict = role.rights
        else:
            # It's likely a Pydantic model, try to convert to dict
            try:
                # Try dict() method first (for Pydantic v1)
                rights_dict = role.rights.dict()
            except AttributeError:
                try:
                    # Try model_dump() method (for Pydantic v2)
                    rights_dict = role.rights.model_dump()  # type: ignore
                except AttributeError:
                    raise HTTPException(
                        status_code=400,
                        detail="Rights must be provided as a JSON object",
                    )
        
        # Validate rights structure - check for required top-level keys
        required_rights = [
            'courses', 'users', 'usergroups', 'collections', 
            'organizations', 'coursechapters', 'activities', 
            'roles', 'dashboard'
        ]
        
        for required_right in required_rights:
            if required_right not in rights_dict:
                raise HTTPException(
                    status_code=400,
                    detail=f"Missing required right: {required_right}",
                )
            
            # Validate the structure of each right
            right_data = rights_dict[required_right]
            if not isinstance(right_data, dict):
                raise HTTPException(
                    status_code=400,
                    detail=f"Right '{required_right}' must be a JSON object",
                )
            
            # Validate courses permissions (has additional 'own' permissions)
            if required_right == 'courses':
                required_course_permissions = [
                    'action_create', 'action_read', 'action_read_own', 
                    'action_update', 'action_update_own', 'action_delete', 'action_delete_own'
                ]
                for perm in required_course_permissions:
                    if perm not in right_data:
                        raise HTTPException(
                            status_code=400,
                            detail=f"Missing required course permission: {perm}",
                        )
                    if not isinstance(right_data[perm], bool):
                        raise HTTPException(
                            status_code=400,
                            detail=f"Course permission '{perm}' must be a boolean",
                        )
            
            # Validate other permissions (standard permissions)
            elif required_right in ['users', 'usergroups', 'collections', 'organizations', 'coursechapters', 'activities', 'roles']:
                required_permissions = ['action_create', 'action_read', 'action_update', 'action_delete']
                for perm in required_permissions:
                    if perm not in right_data:
                        raise HTTPException(
                            status_code=400,
                            detail=f"Missing required permission '{perm}' for '{required_right}'",
                        )
                    if not isinstance(right_data[perm], bool):
                        raise HTTPException(
                            status_code=400,
                            detail=f"Permission '{perm}' for '{required_right}' must be a boolean",
                        )
            
            # Validate dashboard permissions
            elif required_right == 'dashboard':
                if 'action_access' not in right_data:
                    raise HTTPException(
                        status_code=400,
                        detail="Missing required dashboard permission: action_access",
                    )
                if not isinstance(right_data['action_access'], bool):
                    raise HTTPException(
                        status_code=400,
                        detail="Dashboard permission 'action_access' must be a boolean",
                    )
        
        # Convert back to dict if it was a model
        if not isinstance(role.rights, dict):
            role.rights = rights_dict

    # ============================================================================
    # VERIFICATION 8: Ensure user cannot create a role with higher permissions than they have
    # ============================================================================
    if role.rights and isinstance(role.rights, dict) and user_role.rights and isinstance(user_role.rights, dict):
        # Check if the new role has any permissions that the user doesn't have
        for right_key, right_permissions in role.rights.items():
            if right_key in user_role.rights:
                user_right_permissions = user_role.rights[right_key]
                
                # Check each permission in the right
                for perm_key, perm_value in right_permissions.items():
                    if isinstance(perm_value, bool) and perm_value:  # If the new role has this permission enabled
                        if isinstance(user_right_permissions, dict) and perm_key in user_right_permissions:
                            user_has_perm = user_right_permissions[perm_key]
                            if not user_has_perm:
                                raise HTTPException(
                                    status_code=403,
                                    detail=f"You cannot create a role with '{perm_key}' permission for '{right_key}' as you don't have this permission yourself",
                                )
                        else:
                            raise HTTPException(
                                status_code=403,
                                detail=f"You cannot create a role with '{perm_key}' permission for '{right_key}' as you don't have this permission yourself",
                            )

    # Complete the role object
    role.role_uuid = f"role_{uuid4()}"
    role.creation_date = str(datetime.now())
    role.update_date = str(datetime.now())

    # ============================================================================
    # VERIFICATION 9: Handle ID sequence issue (existing logic)
    # ============================================================================
    try:
        db_session.add(role)
        db_session.commit()
        db_session.refresh(role)
    except IntegrityError as e:
        if "duplicate key value violates unique constraint" in str(e) and "role_pkey" in str(e):
            # Handle the sequence issue by finding the next available ID
            db_session.rollback()
            
            # Get the maximum ID from the role table using raw SQL
            result = db_session.execute(text("SELECT COALESCE(MAX(id), 0) as max_id FROM role"))
            max_id_result = result.scalar()
            max_id = max_id_result if max_id_result is not None else 0
            
            # Set the next available ID
            role.id = max_id + 1
            
            # Try to insert again
            db_session.add(role)
            db_session.commit()
            db_session.refresh(role)
            
            # Update the sequence to the correct value for future inserts
            try:
                # Use raw SQL to update the sequence
                db_session.execute(text(f"SELECT setval('role_id_seq', {max_id + 1}, true)"))
                db_session.commit()
            except Exception:
                # If sequence doesn't exist or can't be updated, that's okay
                # The manual ID assignment above will handle it
                pass
        else:
            # Re-raise the original exception if it's not the sequence issue
            raise e

    # Create RoleRead object with all required fields
    role_data = role.model_dump()
    # Ensure org_id is properly handled
    if role_data.get('org_id') is None:
        role_data['org_id'] = 0
    role = RoleRead(**role_data)

    return role


async def get_roles_by_organization(
    request: Request,
    db_session: Session,
    org_id: int,
    current_user: PublicUser,
) -> List[RoleRead]:
    """
    Get all roles for a specific organization, including global roles.
    
    Args:
        request: FastAPI request object
        db_session: Database session
        org_id: Organization ID
        current_user: Current authenticated user
        
    Returns:
        List[RoleRead]: List of roles for the organization (including global roles)
        
    Raises:
        HTTPException: If organization not found or user lacks permissions
    """
    # ============================================================================
    # VERIFICATION 1: Check if the organization exists
    # ============================================================================
    statement = select(Organization).where(Organization.id == org_id)
    organization = db_session.exec(statement).first()
    
    if not organization:
        raise HTTPException(
            status_code=404,
            detail="Organization not found",
        )

    # ============================================================================
    # VERIFICATION 2: Check if the current user is a member of the organization
    # ============================================================================
    statement = select(UserOrganization).where(
        UserOrganization.user_id == current_user.id,
        UserOrganization.org_id == org_id
    )
    user_org = db_session.exec(statement).first()
    
    if not user_org:
        raise HTTPException(
            status_code=403,
            detail="You are not a member of this organization",
        )

    # ============================================================================
    # VERIFICATION 3: Check if the user has permission to read roles in this organization
    # ============================================================================
    # Get the user's role in this organization
    statement = select(Role).where(Role.id == user_org.role_id)
    user_role = db_session.exec(statement).first()
    
    if not user_role:
        raise HTTPException(
            status_code=403,
            detail="Your role in this organization could not be determined",
        )

    # Check if the user has role reading permissions
    if user_role.rights and isinstance(user_role.rights, dict):
        roles_rights = user_role.rights.get('roles', {})
        if not roles_rights.get('action_read', False):
            raise HTTPException(
                status_code=403,
                detail="You don't have permission to read roles in this organization",
            )
    else:
        # If no rights are defined, check if user has admin role (role_id 1 or 2)
        if user_role.id not in [1, 2]:  # Admin and Maintainer roles
            raise HTTPException(
                status_code=403,
                detail="You don't have permission to read roles in this organization. Admin or Maintainer role required.",
            )

    # ============================================================================
    # GET ROLES: Fetch all roles for the organization AND global roles
    # ============================================================================
    # Get global roles first
    global_roles_statement = select(Role).where(
        Role.role_type == RoleTypeEnum.TYPE_GLOBAL
    ).order_by(Role.id)  # type: ignore
    
    global_roles = list(db_session.exec(global_roles_statement).all())
    
    # Get organization-specific roles
    org_roles_statement = select(Role).where(
        Role.org_id == org_id,
        Role.role_type == RoleTypeEnum.TYPE_ORGANIZATION
    ).order_by(Role.id)  # type: ignore
    
    org_roles = list(db_session.exec(org_roles_statement).all())
    
    # Combine lists with global roles first, then organization roles
    all_roles = global_roles + org_roles
    
    # Convert to RoleRead objects
    role_reads = []
    for role in all_roles:
        role_data = role.model_dump()
        # Ensure org_id is properly handled
        if role_data.get('org_id') is None:
            role_data['org_id'] = 0
        role_reads.append(RoleRead(**role_data))
    
    return role_reads


async def read_role(
    request: Request, db_session: Session, role_id: str, current_user: PublicUser
):
    # Convert role_id to integer
    try:
        role_id_int = int(role_id)
    except ValueError:
        raise HTTPException(
            status_code=400,
            detail="Invalid role ID format. Role ID must be a number.",
        )
    
    statement = select(Role).where(Role.id == role_id_int)
    result = db_session.exec(statement)

    role = result.first()

    if not role:
        raise HTTPException(
            status_code=404,
            detail="Role not found",
        )

    # RBAC check
    await rbac_check(request, current_user, "read", role.role_uuid, db_session)

    role = RoleRead(**role.model_dump())

    return role


async def update_role(
    request: Request,
    db_session: Session,
    role_object: RoleUpdate,
    current_user: PublicUser,
):
    statement = select(Role).where(Role.id == role_object.role_id)
    result = db_session.exec(statement)

    role = result.first()

    if not role:
        raise HTTPException(
            status_code=404,
            detail="Role not found",
        )

    # ============================================================================
    # VERIFICATION: Prevent updating TYPE_GLOBAL roles
    # ============================================================================
    if role.role_type == RoleTypeEnum.TYPE_GLOBAL:
        raise HTTPException(
            status_code=403,
            detail="Global roles cannot be updated. These are system-defined roles that must remain unchanged.",
        )

    # RBAC check
    await rbac_check(request, current_user, "update", role.role_uuid, db_session)

    # Complete the role object
    role.update_date = str(datetime.now())

    # Remove the role_id from the role_object
    del role_object.role_id

    # Update only the fields that were passed in
    # Use model_dump() to get the data as a dictionary
    try:
        update_data = role_object.model_dump(exclude_unset=True)
    except AttributeError:
        # Fallback to dict() method for older Pydantic versions
        try:
            update_data = role_object.dict(exclude_unset=True)
        except AttributeError:
            # Fallback to vars() for SQLModel
            update_data = {k: v for k, v in vars(role_object).items() if v is not None}
    
    # Update the role with the new data
    for key, value in update_data.items():
        if value is not None:
            setattr(role, key, value)

    # ============================================================================
    # VALIDATE RIGHTS STRUCTURE if rights are being updated
    # ============================================================================
    if role.rights:
        # Convert Rights model to dict if needed
        if isinstance(role.rights, dict):
            # It's already a dict
            rights_dict = role.rights
        else:
            # It's likely a Pydantic model, try to convert to dict
            try:
                # Try dict() method first (for Pydantic v1)
                rights_dict = role.rights.dict()
            except AttributeError:
                try:
                    # Try model_dump() method (for Pydantic v2)
                    rights_dict = role.rights.model_dump()  # type: ignore
                except AttributeError:
                    raise HTTPException(
                        status_code=400,
                        detail="Rights must be provided as a JSON object",
                    )
        
        # Validate rights structure - check for required top-level keys
        required_rights = [
            'courses', 'users', 'usergroups', 'collections', 
            'organizations', 'coursechapters', 'activities', 
            'roles', 'dashboard'
        ]
        
        for required_right in required_rights:
            if required_right not in rights_dict:
                raise HTTPException(
                    status_code=400,
                    detail=f"Missing required right: {required_right}",
                )
            
            # Validate the structure of each right
            right_data = rights_dict[required_right]
            if not isinstance(right_data, dict):
                raise HTTPException(
                    status_code=400,
                    detail=f"Right '{required_right}' must be a JSON object",
                )
            
            # Validate courses permissions (has additional 'own' permissions)
            if required_right == 'courses':
                required_course_permissions = [
                    'action_create', 'action_read', 'action_read_own', 
                    'action_update', 'action_update_own', 'action_delete', 'action_delete_own'
                ]
                for perm in required_course_permissions:
                    if perm not in right_data:
                        raise HTTPException(
                            status_code=400,
                            detail=f"Missing required course permission: {perm}",
                        )
                    if not isinstance(right_data[perm], bool):
                        raise HTTPException(
                            status_code=400,
                            detail=f"Course permission '{perm}' must be a boolean",
                        )
            
            # Validate other permissions (standard permissions)
            elif required_right in ['users', 'usergroups', 'collections', 'organizations', 'coursechapters', 'activities', 'roles']:
                required_permissions = ['action_create', 'action_read', 'action_update', 'action_delete']
                for perm in required_permissions:
                    if perm not in right_data:
                        raise HTTPException(
                            status_code=400,
                            detail=f"Missing required permission '{perm}' for '{required_right}'",
                        )
                    if not isinstance(right_data[perm], bool):
                        raise HTTPException(
                            status_code=400,
                            detail=f"Permission '{perm}' for '{required_right}' must be a boolean",
                        )
            
            # Validate dashboard permissions
            elif required_right == 'dashboard':
                if 'action_access' not in right_data:
                    raise HTTPException(
                        status_code=400,
                        detail="Missing required dashboard permission: action_access",
                    )
                if not isinstance(right_data['action_access'], bool):
                    raise HTTPException(
                        status_code=400,
                        detail="Dashboard permission 'action_access' must be a boolean",
                    )
        
        # Convert back to dict if it was a model
        if not isinstance(role.rights, dict):
            role.rights = rights_dict

    db_session.add(role)
    db_session.commit()
    db_session.refresh(role)

    role = RoleRead(**role.model_dump())

    return role


async def delete_role(
    request: Request, db_session: Session, role_id: str, current_user: PublicUser
):
    # Convert role_id to integer
    try:
        role_id_int = int(role_id)
    except ValueError:
        raise HTTPException(
            status_code=400,
            detail="Invalid role ID format. Role ID must be a number.",
        )
    
    # First, get the role to check if it exists and get its UUID
    statement = select(Role).where(Role.id == role_id_int)
    result = db_session.exec(statement)

    role = result.first()

    if not role:
        raise HTTPException(
            status_code=404,
            detail="Role not found",
        )

    # ============================================================================
    # VERIFICATION: Prevent deleting TYPE_GLOBAL roles
    # ============================================================================
    if role.role_type == RoleTypeEnum.TYPE_GLOBAL:
        raise HTTPException(
            status_code=403,
            detail="Global roles cannot be deleted. These are system-defined roles that must remain unchanged.",
        )

    # RBAC check using the role's UUID
    await rbac_check(request, current_user, "delete", role.role_uuid, db_session)

    db_session.delete(role)
    db_session.commit()

    return "Role deleted"


## ğŸ”’ RBAC Utils ##


async def rbac_check(
    request: Request,
    current_user: PublicUser | AnonymousUser,
    action: Literal["create", "read", "update", "delete"],
    role_uuid: str,
    db_session: Session,
):
    await authorization_verify_if_user_is_anon(current_user.id)

    await authorization_verify_based_on_roles_and_authorship(
        request, current_user.id, action, role_uuid, db_session
    )


## ğŸ”’ RBAC Utils ##



================================================
FILE: apps/api/src/services/search/search.py
================================================
from typing import List, TypeVar
from fastapi import Request
from sqlmodel import Session, select, or_, text, and_
from sqlalchemy import true as sa_true
from pydantic import BaseModel
from src.db.users import PublicUser, AnonymousUser, UserRead, User
from src.db.courses.courses import Course, CourseRead
from src.db.collections import Collection, CollectionRead
from src.db.collections_courses import CollectionCourse
from src.db.organizations import Organization
from src.db.user_organizations import UserOrganization
from src.services.courses.courses import search_courses

T = TypeVar('T')

class SearchResult(BaseModel):
    courses: List[CourseRead]
    collections: List[CollectionRead]
    users: List[UserRead]

    class Config:
        arbitrary_types_allowed = True

async def search_across_org(
    request: Request,
    current_user: PublicUser | AnonymousUser,
    org_slug: str,
    search_query: str,
    db_session: Session,
    page: int = 1,
    limit: int = 10,
) -> SearchResult:
    """
    Search across courses, collections and users within an organization
    """
    offset = (page - 1) * limit

    # Get organization
    org_statement = select(Organization).where(Organization.slug == org_slug)
    org = db_session.exec(org_statement).first()
    
    if not org:
        return SearchResult(courses=[], collections=[], users=[])

    # Search courses using existing search_courses function
    courses = await search_courses(request, current_user, org_slug, search_query, db_session, page, limit)

    # Search collections
    collections_query = (
        select(Collection)
        .where(Collection.org_id == org.id)
        .where(
            or_(
                text('LOWER("collection".name) LIKE LOWER(:pattern)'),
                text('LOWER("collection".description) LIKE LOWER(:pattern)')
            )
        )
        .params(pattern=f"%{search_query}%")
    )

    # Search users
    users_query = (
        select(User)
        .join(UserOrganization, and_(
            UserOrganization.user_id == User.id,
            UserOrganization.org_id == org.id
        ))
        .where(
            or_(
                text('LOWER("user".username) LIKE LOWER(:pattern) OR ' +
                     'LOWER("user".first_name) LIKE LOWER(:pattern) OR ' +
                     'LOWER("user".last_name) LIKE LOWER(:pattern) OR ' +
                     'LOWER("user".bio) LIKE LOWER(:pattern)')
            )
        )
        .params(pattern=f"%{search_query}%")
    )

    if isinstance(current_user, AnonymousUser):
        # For anonymous users, only show public collections
        collections_query = collections_query.where(Collection.public == sa_true())
    else:
        # For authenticated users, show public collections and those in their org
        collections_query = (
            collections_query
            .where(
                or_(
                    Collection.public == sa_true(),
                    Collection.org_id == org.id
                )
            )
        )

    # Apply pagination to queries
    collections = db_session.exec(collections_query.offset(offset).limit(limit)).all()
    users = db_session.exec(users_query.offset(offset).limit(limit)).all()

    # Convert collections to CollectionRead objects with courses
    collection_reads = []
    for collection in collections:
        # Get courses in collection
        statement = (
            select(Course)
            .select_from(Course)
            .join(CollectionCourse, and_(
                CollectionCourse.course_id == Course.id,
                CollectionCourse.collection_id == collection.id,
                CollectionCourse.org_id == collection.org_id
            ))
            .distinct()
        )
        collection_courses = list(db_session.exec(statement).all())
        collection_read = CollectionRead(**collection.model_dump(), courses=collection_courses)
        collection_reads.append(collection_read)

    # Convert users to UserRead objects
    user_reads = [UserRead.model_validate(user) for user in users]

    return SearchResult(
        courses=courses,
        collections=collection_reads,
        users=user_reads
    ) 


================================================
FILE: apps/api/src/services/setup/__init__.py
================================================
[Empty file]


================================================
FILE: apps/api/src/services/setup/setup.py
================================================
from datetime import datetime
import json
from uuid import uuid4
from fastapi import HTTPException
from sqlmodel import Session, select
from src.db.organization_config import (
    AIOrgConfig,
    APIOrgConfig,
    AnalyticsOrgConfig,
    AssignmentOrgConfig,
    CollaborationOrgConfig,
    CourseOrgConfig,
    DiscussionOrgConfig,
    MemberOrgConfig,
    OrgCloudConfig,
    OrgFeatureConfig,
    OrgGeneralConfig,
    OrganizationConfig,
    OrganizationConfigBase,
    PaymentOrgConfig,
    StorageOrgConfig,
    UserGroupOrgConfig,
)
from src.db.organizations import Organization, OrganizationCreate
from src.db.roles import DashboardPermission, Permission, PermissionsWithOwn, Rights, Role, RoleTypeEnum
from src.db.user_organizations import UserOrganization
from src.db.users import User, UserCreate, UserRead
from src.security.security import security_hash_password


# Install Default roles
def install_default_elements(db_session: Session):
    """ """
    # remove all default roles
    statement = select(Role).where(Role.role_type == RoleTypeEnum.TYPE_GLOBAL)
    roles = db_session.exec(statement).all()

    for role in roles:
        db_session.delete(role)

    db_session.commit()

    # Check if default roles already exist
    statement = select(Role).where(Role.role_type == RoleTypeEnum.TYPE_GLOBAL)
    roles = db_session.exec(statement).all()

    if roles and len(roles) == 4:
        raise HTTPException(
            status_code=409,
            detail="Default roles already exist",
        )

    # Create default roles
    role_global_admin = Role(
        name="Admin",
        description="Full platform control",
        id=1,
        role_type=RoleTypeEnum.TYPE_GLOBAL,
        role_uuid="role_global_admin",
        rights=Rights(
            courses=PermissionsWithOwn(
                action_create=True,
                action_read=True,
                action_read_own=True,
                action_update=True,
                action_update_own=True,
                action_delete=True,
                action_delete_own=True,
            ),
            users=Permission(
                action_create=True,
                action_read=True,
                action_update=True,
                action_delete=True,
            ),
            usergroups=Permission(
                action_create=True,
                action_read=True,
                action_update=True,
                action_delete=True,
            ),
            collections=Permission(
                action_create=True,
                action_read=True,
                action_update=True,
                action_delete=True,
            ),
            organizations=Permission(
                action_create=True,
                action_read=True,
                action_update=True,
                action_delete=True,
            ),
            coursechapters=Permission(
                action_create=True,
                action_read=True,
                action_update=True,
                action_delete=True,
            ),
            activities=Permission(
                action_create=True,
                action_read=True,
                action_update=True,
                action_delete=True,
            ),
            roles=Permission(
                action_create=True,
                action_read=True,
                action_update=True,
                action_delete=True,
            ),
            dashboard=DashboardPermission(
                action_access=True,
            ),
        ),
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
    )

    role_global_maintainer = Role(
        name="Maintainer",
        description="Mid-level manager, wide permissions but no platform control",
        id=2,
        role_type=RoleTypeEnum.TYPE_GLOBAL,
        role_uuid="role_global_maintainer",
        rights=Rights(
            courses=PermissionsWithOwn(
                action_create=True,
                action_read=True,
                action_read_own=True,
                action_update=True,
                action_update_own=True,
                action_delete=True,
                action_delete_own=True,
            ),
            users=Permission(
                action_create=True,
                action_read=True,
                action_update=True,
                action_delete=False,
            ),
            usergroups=Permission(
                action_create=True,
                action_read=True,
                action_update=True,
                action_delete=True,
            ),
            collections=Permission(
                action_create=True,
                action_read=True,
                action_update=True,
                action_delete=True,
            ),
            organizations=Permission(
                action_create=False,
                action_read=True,
                action_update=False,
                action_delete=False,
            ),
            coursechapters=Permission(
                action_create=True,
                action_read=True,
                action_update=True,
                action_delete=True,
            ),
            activities=Permission(
                action_create=True,
                action_read=True,
                action_update=True,
                action_delete=True,
            ),
            roles=Permission(
                action_create=False,
                action_read=True,
                action_update=False,
                action_delete=False,
            ),
            dashboard=DashboardPermission(
                action_access=True,
            ),
        ),
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
    )

    role_global_instructor = Role(
        name="Instructor",
        description="Can manage their own content",
        id=3,
        role_type=RoleTypeEnum.TYPE_GLOBAL,
        role_uuid="role_global_instructor",
        rights=Rights(
            courses=PermissionsWithOwn(
                action_create=True,
                action_read=True,
                action_read_own=True,
                action_update=False,
                action_update_own=True,
                action_delete=False,
                action_delete_own=True,
            ),
            users=Permission(
                action_create=False,
                action_read=False,
                action_update=False,
                action_delete=False,
            ),
            usergroups=Permission(
                action_create=False,
                action_read=True,
                action_update=False,
                action_delete=False,
            ),
            collections=Permission(
                action_create=True,
                action_read=True,
                action_update=False,
                action_delete=False,
            ),
            organizations=Permission(
                action_create=False,
                action_read=False,
                action_update=False,
                action_delete=False,
            ),
            coursechapters=Permission(
                action_create=True,
                action_read=True,
                action_update=False,
                action_delete=False,
            ),
            activities=Permission(
                action_create=True,
                action_read=True,
                action_update=False,
                action_delete=False,
            ),
            roles=Permission(
                action_create=False,
                action_read=False,
                action_update=False,
                action_delete=False,
            ),
            dashboard=DashboardPermission(
                action_access=True,
            ),
        ),
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
    )

    role_global_user = Role(
        name="User",
        description="Read-Only Learner",
        role_type=RoleTypeEnum.TYPE_GLOBAL,
        role_uuid="role_global_user",
        id=4,
        rights=Rights(
            courses=PermissionsWithOwn(
                action_create=False,
                action_read=True,
                action_read_own=True,
                action_update=False,
                action_update_own=False,
                action_delete=True,
                action_delete_own=True,
            ),
            users=Permission(
                action_create=False,
                action_read=False,
                action_update=False,
                action_delete=False,
            ),
            usergroups=Permission(
                action_create=False,
                action_read=True,
                action_update=False,
                action_delete=False,
            ),
            collections=Permission(
                action_create=False,
                action_read=True,
                action_update=False,
                action_delete=False,
            ),
            organizations=Permission(
                action_create=False,
                action_read=False,
                action_update=False,
                action_delete=False,
            ),
            coursechapters=Permission(
                action_create=False,
                action_read=True,
                action_update=False,
                action_delete=False,
            ),
            activities=Permission(
                action_create=False,
                action_read=True,
                action_update=False,    
                action_delete=False,
            ),
            roles=Permission(
                action_create=False,
                action_read=False,
                action_update=False,
                action_delete=False,
            ),
            dashboard=DashboardPermission(
                action_access=False,
            ),
        ),
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
    )

    # Serialize rights to JSON
    role_global_admin.rights = role_global_admin.rights.dict()  # type: ignore
    role_global_maintainer.rights = role_global_maintainer.rights.dict()  # type: ignore
    role_global_instructor.rights = role_global_instructor.rights.dict()  # type: ignore
    role_global_user.rights = role_global_user.rights.dict()  # type: ignore

    # Insert roles in DB
    db_session.add(role_global_admin)
    db_session.add(role_global_maintainer)
    db_session.add(role_global_instructor)
    db_session.add(role_global_user)

    # commit changes
    db_session.commit()

    # refresh roles
    db_session.refresh(role_global_admin)

    return True


# Organization creation
def install_create_organization(org_object: OrganizationCreate, db_session: Session):
    org = Organization.model_validate(org_object)

    # Complete the org object
    org.org_uuid = f"org_{uuid4()}"
    org.creation_date = str(datetime.now())
    org.update_date = str(datetime.now())

    db_session.add(org)
    db_session.commit()
    db_session.refresh(org)

    # Org Config
    org_config = OrganizationConfigBase(
        config_version="1.3",
        general=OrgGeneralConfig(
            enabled=True,
            color="normal",
            watermark=True,
        ),
        features=OrgFeatureConfig(
            courses=CourseOrgConfig(enabled=True, limit=0),
            members=MemberOrgConfig(
                enabled=True, signup_mode="open", admin_limit=0, limit=0
            ),
            usergroups=UserGroupOrgConfig(enabled=True, limit=0),
            storage=StorageOrgConfig(enabled=True, limit=0),
            ai=AIOrgConfig(enabled=True, limit=0, model="gpt-4o-mini"),
            assignments=AssignmentOrgConfig(enabled=True, limit=0),
            payments=PaymentOrgConfig(enabled=False),
            discussions=DiscussionOrgConfig(enabled=True, limit=0),
            analytics=AnalyticsOrgConfig(enabled=True, limit=0),
            collaboration=CollaborationOrgConfig(enabled=True, limit=0),
            api=APIOrgConfig(enabled=True, limit=0),
        ),
        cloud=OrgCloudConfig(
            plan='free',
            custom_domain=False
        ),
        landing={}
    )

    org_config = json.loads(org_config.json())

    # OrgSettings
    org_settings = OrganizationConfig(
        org_id=int(org.id if org.id else 0),
        config=org_config,
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
    )

    db_session.add(org_settings)
    db_session.commit()
    db_session.refresh(org_settings)

    return org


def install_create_organization_user(
    user_object: UserCreate, org_slug: str, db_session: Session
):
    user = User.model_validate(user_object)

    # Complete the user object
    user.user_uuid = f"user_{uuid4()}"
    user.password = security_hash_password(user_object.password)
    user.email_verified = False
    user.creation_date = str(datetime.now())
    user.update_date = str(datetime.now())

    # Verifications

    # Check if Organization exists
    statement = select(Organization).where(Organization.slug == org_slug)
    org = db_session.exec(statement)

    if not org.first():
        raise HTTPException(
            status_code=409,
            detail="Organization does not exist",
        )

    # Username
    statement = select(User).where(User.username == user.username)
    result = db_session.exec(statement)

    if result.first():
        raise HTTPException(
            status_code=409,
            detail="Username already exists",
        )

    # Email
    statement = select(User).where(User.email == user.email)
    result = db_session.exec(statement)

    if result.first():
        raise HTTPException(
            status_code=409,
            detail="Email already exists",
        )

    # Exclude unset values
    user_data = user.dict(exclude_unset=True)
    for key, value in user_data.items():
        setattr(user, key, value)

    # Add user to database
    db_session.add(user)
    db_session.commit()
    db_session.refresh(user)

    # get org id
    statement = select(Organization).where(Organization.slug == org_slug)
    org = db_session.exec(statement)
    org = org.first()
    org_id = org.id if org else 0

    # Link user and organization
    user_organization = UserOrganization(
        user_id=user.id if user.id else 0,
        org_id=org_id or 0,
        role_id=1,
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
    )

    db_session.add(user_organization)
    db_session.commit()
    db_session.refresh(user_organization)

    user = UserRead.model_validate(user)

    return user




================================================
FILE: apps/api/src/services/trail/__init__.py
================================================
[Empty file]


================================================
FILE: apps/api/src/services/trail/trail.py
================================================
from datetime import datetime
from uuid import uuid4
from src.db.courses.chapter_activities import ChapterActivity
from fastapi import HTTPException, Request, status
from sqlmodel import Session, select
from src.db.courses.activities import Activity
from src.db.courses.courses import Course
from src.db.trail_runs import TrailRun, TrailRunRead
from src.db.trail_steps import TrailStep
from src.db.trails import Trail, TrailCreate, TrailRead
from src.db.users import AnonymousUser, PublicUser
from src.services.courses.certifications import check_course_completion_and_create_certificate


async def create_user_trail(
    request: Request,
    user: PublicUser,
    trail_object: TrailCreate,
    db_session: Session,
) -> Trail:
    statement = select(Trail).where(
        Trail.org_id == trail_object.org_id, Trail.user_id == user.id
    )
    trail = db_session.exec(statement).first()

    if trail:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Trail already exists",
        )

    trail = Trail.model_validate(trail_object)

    trail.creation_date = str(datetime.now())
    trail.update_date = str(datetime.now())
    trail.org_id = trail_object.org_id
    trail.trail_uuid = str(f"trail_{uuid4()}")

    # create trail
    db_session.add(trail)
    db_session.commit()
    db_session.refresh(trail)

    return trail


async def get_user_trails(
    request: Request,
    user: PublicUser,
    db_session: Session,
) -> TrailRead:
    statement = select(Trail).where(Trail.user_id == user.id)
    trail = db_session.exec(statement).first()

    if not trail:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND, detail="Trail not found"
        )

    statement = select(TrailRun).where(TrailRun.trail_id == trail.id)
    trail_runs = db_session.exec(statement).all()

    trail_runs = [
        TrailRunRead(**trail_run.__dict__, course={}, steps=[], course_total_steps=0)
        for trail_run in trail_runs
    ]

    # Add course object and total activities in a course to trail runs
    for trail_run in trail_runs:
        statement = select(Course).where(Course.id == trail_run.course_id)
        course = db_session.exec(statement).first()
        trail_run.course = course.model_dump() if course else {}

        # Add number of activities (steps) in a course
        statement = select(ChapterActivity).where(
            ChapterActivity.course_id == trail_run.course_id
        )
        course_total_steps = db_session.exec(statement)
        # count number of activities in a this list
        trail_run.course_total_steps = len(course_total_steps.all())

    for trail_run in trail_runs:
        statement = select(TrailStep).where(TrailStep.trailrun_id == trail_run.id)
        trail_steps = db_session.exec(statement).all()

        trail_steps = [TrailStep(**trail_step.__dict__) for trail_step in trail_steps]
        trail_run.steps = trail_steps

        for trail_step in trail_steps:
            statement = select(Course).where(Course.id == trail_step.course_id)
            course = db_session.exec(statement).first()
            trail_step.data = dict(course=course)

    trail_read = TrailRead(
        **trail.model_dump(),
        runs=trail_runs,
    )

    return trail_read


async def check_trail_presence(
    org_id: int,
    user_id: int,
    request: Request,
    user: PublicUser,
    db_session: Session,
):
    statement = select(Trail).where(Trail.org_id == org_id, Trail.user_id == user_id)
    trail = db_session.exec(statement).first()

    if not trail:
        trail = await create_user_trail(
            request,
            user,
            TrailCreate(
                org_id=org_id,
                user_id=user.id,
            ),
            db_session,
        )
        return trail

    return trail


async def get_user_trail_with_orgid(
    request: Request, user: PublicUser | AnonymousUser, org_id: int, db_session: Session
) -> TrailRead:

    if isinstance(user, AnonymousUser):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Anonymous users cannot access this endpoint",
        )

    trail = await check_trail_presence(
        org_id=org_id,
        user_id=user.id,
        request=request,
        user=user,
        db_session=db_session,
    )

    statement = select(TrailRun).where(TrailRun.trail_id == trail.id)
    trail_runs = db_session.exec(statement).all()

    trail_runs = [
        TrailRunRead(**trail_run.__dict__, course={}, steps=[], course_total_steps=0)
        for trail_run in trail_runs
    ]

    # Add course object and total activities in a course to trail runs
    for trail_run in trail_runs:
        statement = select(Course).where(Course.id == trail_run.course_id)
        course = db_session.exec(statement).first()
        trail_run.course = course.model_dump() if course else {}

        # Add number of activities (steps) in a course
        statement = select(ChapterActivity).where(
            ChapterActivity.course_id == trail_run.course_id
        )
        course_total_steps = db_session.exec(statement)
        # count number of activities in a this list
        trail_run.course_total_steps = len(course_total_steps.all())

    for trail_run in trail_runs:
        statement = select(TrailStep).where(TrailStep.trailrun_id == trail_run.id)
        trail_steps = db_session.exec(statement).all()

        trail_steps = [TrailStep(**trail_step.__dict__) for trail_step in trail_steps]
        trail_run.steps = trail_steps

        for trail_step in trail_steps:
            statement = select(Course).where(Course.id == trail_step.course_id)
            course = db_session.exec(statement).first()
            trail_step.data = dict(course=course)

    trail_read = TrailRead(
        **trail.model_dump(),
        runs=trail_runs,
    )

    return trail_read


async def add_activity_to_trail(
    request: Request,
    user: PublicUser,
    activity_uuid: str,
    db_session: Session,
) -> TrailRead:
    # Look for the activity
    statement = select(Activity).where(Activity.activity_uuid == activity_uuid)
    activity = db_session.exec(statement).first()

    if not activity:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND, detail="Activity not found"
        )

    statement = select(Course).where(Course.id == activity.course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND, detail="Course not found"
        )

    trail = await check_trail_presence(
        org_id=course.org_id,
        user_id=user.id,
        request=request,
        user=user,
        db_session=db_session,
    )

    statement = select(TrailRun).where(
        TrailRun.trail_id == trail.id, TrailRun.course_id == course.id, TrailRun.user_id == user.id
    )
    trailrun = db_session.exec(statement).first()

    if not trailrun:
        trailrun = TrailRun(
            trail_id=trail.id if trail.id is not None else 0,
            course_id=course.id if course.id is not None else 0,
            org_id=course.org_id,
            user_id=user.id,
            creation_date=str(datetime.now()),
            update_date=str(datetime.now()),
        )
        db_session.add(trailrun)
        db_session.commit()
        db_session.refresh(trailrun)

    statement = select(TrailStep).where(
        TrailStep.trailrun_id == trailrun.id, TrailStep.activity_id == activity.id, TrailStep.user_id == user.id
    )
    trailstep = db_session.exec(statement).first()

    if not trailstep:
        trailstep = TrailStep(
            trailrun_id=trailrun.id if trailrun.id is not None else 0,
            activity_id=activity.id if activity.id is not None else 0,
            course_id=course.id if course.id is not None else 0,
            trail_id=trail.id if trail.id is not None else 0,
            org_id=course.org_id,
            complete=True,
            teacher_verified=False,
            grade="",
            user_id=user.id,
            creation_date=str(datetime.now()),
            update_date=str(datetime.now()),
        )
        db_session.add(trailstep)
        db_session.commit()
        db_session.refresh(trailstep)

    # Check if all activities in the course are completed and create certificate if so
    if course and course.id:
        await check_course_completion_and_create_certificate(
            request, user.id, course.id, db_session
        )

    statement = select(TrailRun).where(TrailRun.trail_id == trail.id , TrailRun.user_id == user.id)
    trail_runs = db_session.exec(statement).all()

    trail_runs = [
        TrailRunRead(**trail_run.__dict__, course={}, steps=[], course_total_steps=0)
        for trail_run in trail_runs
    ]

    for trail_run in trail_runs:
        statement = select(TrailStep).where(TrailStep.trailrun_id == trail_run.id, TrailStep.user_id == user.id)
        trail_steps = db_session.exec(statement).all()

        trail_steps = [TrailStep(**trail_step.__dict__) for trail_step in trail_steps]
        trail_run.steps = trail_steps

        for trail_step in trail_steps:
            statement = select(Course).where(Course.id == trail_step.course_id)
            course = db_session.exec(statement).first()
            trail_step.data = dict(course=course)

    trail_read = TrailRead(
        **trail.model_dump(),
        runs=trail_runs,
    )

    return trail_read

async def remove_activity_from_trail(
    request: Request,
    user: PublicUser,
    activity_uuid: str,
    db_session: Session,
) -> TrailRead:
    # Look for the activity
    statement = select(Activity).where(Activity.activity_uuid == activity_uuid)
    activity = db_session.exec(statement).first()

    if not activity:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND, detail="Activity not found"
        )

    statement = select(Course).where(Course.id == activity.course_id)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND, detail="Course not found"
        )

    statement = select(Trail).where(
        Trail.org_id == course.org_id, Trail.user_id == user.id
    )
    trail = db_session.exec(statement).first()

    if not trail:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND, detail="Trail not found"
        )

    # Delete the trail step for this activity
    statement = select(TrailStep).where(
        TrailStep.activity_id == activity.id, 
        TrailStep.user_id == user.id,
        TrailStep.trail_id == trail.id
    )
    trail_step = db_session.exec(statement).first()

    if trail_step:
        db_session.delete(trail_step)
        db_session.commit()

    # Get updated trail data
    statement = select(TrailRun).where(TrailRun.trail_id == trail.id, TrailRun.user_id == user.id)
    trail_runs = db_session.exec(statement).all()

    trail_runs = [
        TrailRunRead(**trail_run.__dict__, course={}, steps=[], course_total_steps=0)
        for trail_run in trail_runs
    ]

    for trail_run in trail_runs:
        statement = select(TrailStep).where(TrailStep.trailrun_id == trail_run.id, TrailStep.user_id == user.id)
        trail_steps = db_session.exec(statement).all()

        trail_steps = [TrailStep(**trail_step.__dict__) for trail_step in trail_steps]
        trail_run.steps = trail_steps

        for trail_step in trail_steps:
            statement = select(Course).where(Course.id == trail_step.course_id)
            course = db_session.exec(statement).first()
            trail_step.data = dict(course=course)

    trail_read = TrailRead(
        **trail.model_dump(),
        runs=trail_runs,
    )

    return trail_read


async def add_course_to_trail(
    request: Request,
    user: PublicUser,
    course_uuid: str,
    db_session: Session,
) -> TrailRead:
    statement = select(Course).where(Course.course_uuid == course_uuid)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND, detail="Course not found"
        )

    # check if run already exists
    statement = select(TrailRun).where(
        TrailRun.course_id == course.id, TrailRun.user_id == user.id
    )
    trailrun = db_session.exec(statement).first()

    if trailrun:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST, detail="TrailRun already exists"
        )

    statement = select(Trail).where(
        Trail.org_id == course.org_id, Trail.user_id == user.id
    )
    trail = db_session.exec(statement).first()

    if not trail:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND, detail="Trail not found"
        )

    statement = select(TrailRun).where(
        TrailRun.trail_id == trail.id, TrailRun.course_id == course.id, TrailRun.user_id == user.id
    )
    trail_run = db_session.exec(statement).first()

    if not trail_run:
        trail_run = TrailRun(
            trail_id=trail.id if trail.id is not None else 0,
            course_id=course.id if course.id is not None else 0,
            org_id=course.org_id,
            user_id=user.id,
            creation_date=str(datetime.now()),
            update_date=str(datetime.now()),
        )
        db_session.add(trail_run)
        db_session.commit()
        db_session.refresh(trail_run)

    statement = select(TrailRun).where(TrailRun.trail_id == trail.id, TrailRun.user_id == user.id)
    trail_runs = db_session.exec(statement).all()

    trail_runs = [
        TrailRunRead(**trail_run.__dict__, course={}, steps=[], course_total_steps=0)
        for trail_run in trail_runs
    ]

    for trail_run in trail_runs:
        statement = select(TrailStep).where(TrailStep.trailrun_id == trail_run.id , TrailStep.user_id == user.id)
        trail_steps = db_session.exec(statement).all()

        trail_steps = [TrailStep(**trail_step.__dict__) for trail_step in trail_steps]
        trail_run.steps = trail_steps

        for trail_step in trail_steps:
            statement = select(Course).where(Course.id == trail_step.course_id)
            course = db_session.exec(statement).first()
            trail_step.data = dict(course=course)

    trail_read = TrailRead(
        **trail.model_dump(),
        runs=trail_runs,
    )

    return trail_read


async def remove_course_from_trail(
    request: Request,
    user: PublicUser,
    course_uuid: str,
    db_session: Session,
) -> TrailRead:
    statement = select(Course).where(Course.course_uuid == course_uuid)
    course = db_session.exec(statement).first()

    if not course:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND, detail="Course not found"
        )

    statement = select(Trail).where(
        Trail.org_id == course.org_id, Trail.user_id == user.id
    )
    trail = db_session.exec(statement).first()

    if not trail:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND, detail="Trail not found"
        )

    statement = select(TrailRun).where(
        TrailRun.trail_id == trail.id, TrailRun.course_id == course.id, TrailRun.user_id == user.id
    )
    trail_run = db_session.exec(statement).first()

    if trail_run:
        db_session.delete(trail_run)
        db_session.commit()

    # Delete all trail steps for this course
    statement = select(TrailStep).where(TrailStep.course_id == course.id, TrailStep.user_id == user.id)
    trail_steps = db_session.exec(statement).all()

    for trail_step in trail_steps:
        db_session.delete(trail_step)
        db_session.commit()

    statement = select(TrailRun).where(TrailRun.trail_id == trail.id, TrailRun.user_id == user.id)
    trail_runs = db_session.exec(statement).all()

    trail_runs = [
        TrailRunRead(**trail_run.__dict__, course={}, steps=[], course_total_steps=0)
        for trail_run in trail_runs
    ]

    for trail_run in trail_runs:
        statement = select(TrailStep).where(TrailStep.trailrun_id == trail_run.id, TrailStep.user_id == user.id)
        trail_steps = db_session.exec(statement).all()

        trail_steps = [TrailStep(**trail_step.__dict__) for trail_step in trail_steps]
        trail_run.steps = trail_steps

        for trail_step in trail_steps:
            statement = select(Course).where(Course.id == trail_step.course_id)
            course = db_session.exec(statement).first()
            trail_step.data = dict(course=course)

    trail_read = TrailRead(
        **trail.model_dump(),
        runs=trail_runs,
    )

    return trail_read



================================================
FILE: apps/api/src/services/users/__init__.py
================================================
[Empty file]


================================================
FILE: apps/api/src/services/users/avatars.py
================================================
from fastapi import UploadFile
from src.services.utils.upload_content import upload_file


async def upload_avatar(avatar_file: UploadFile, user_uuid: str) -> str:
    """Upload user avatar."""
    return await upload_file(
        file=avatar_file,
        directory="avatars",
        type_of_dir="users",
        uuid=user_uuid,
        allowed_types=["image"],
        filename_prefix="avatar",
        max_size=2 * 1024 * 1024  # 2MB
    )



================================================
FILE: apps/api/src/services/users/emails.py
================================================
from pydantic import EmailStr
from src.db.organizations import OrganizationRead
from src.db.users import UserRead
from src.services.email.utils import send_email


def send_account_creation_email(
    user: UserRead,
    email: EmailStr,
):
    # send email
    return send_email(
        to=email,
        subject=f"Welcome to LearnHouse, {user.username}!",
        body=f"""
<html>
    <body>
        <p>Hello {user.username}</p>
        <p>Welcome to LearnHouse! , get started by creating your own organization or join a one.</p>
        <p>Need some help to get started ? <a href="https://university.learnhouse.io">LearnHouse Academy</a></p>
    </body>
</html>
""",
    )


def send_password_reset_email(
    generated_reset_code: str,
    user: UserRead,
    organization: OrganizationRead,
    email: EmailStr,
):
    
    # send email
    return send_email(
        to=email,
        subject="Reset your password",
        body=f"""
<html>
    <body>
        <p>Hello {user.username}</p>
        <p>You have requested to reset your password.</p>
        <p>Here is your reset code: {generated_reset_code}</p>
        <p>Click <a href="https://{organization.slug}.learnhouse.io/reset?orgslug={organization.slug}&email={email}&resetCode={generated_reset_code}">here</a> to reset your password.</p>
    </body>
</html>
""",
    )



================================================
FILE: apps/api/src/services/users/password_reset.py
================================================
from datetime import datetime
import json
import random
import redis
import string
import uuid
from fastapi import HTTPException, Request
from pydantic import EmailStr
from sqlmodel import Session, select
from src.db.organizations import Organization, OrganizationRead
from src.security.security import security_hash_password
from config.config import get_learnhouse_config
from src.services.users.emails import (
    send_password_reset_email,
)
from src.db.users import (
    AnonymousUser,
    PublicUser,
    User,
    UserRead,
)


async def send_reset_password_code(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    org_id: int,
    email: EmailStr,
):
    # Get user
    statement = select(User).where(User.email == email)
    user = db_session.exec(statement).first()

    if not user:
        raise HTTPException(
            status_code=400,
            detail="User does not exist",
        )

    # Get org
    statement = select(Organization).where(Organization.id == org_id)
    org = db_session.exec(statement).first()

    if not org:
        raise HTTPException(
            status_code=400,
            detail="Organization not found",
        )

    # Redis init
    LH_CONFIG = get_learnhouse_config()
    redis_conn_string = LH_CONFIG.redis_config.redis_connection_string

    if not redis_conn_string:
        raise HTTPException(
            status_code=500,
            detail="Redis connection string not found",
        )

    # Connect to Redis
    r = redis.Redis.from_url(redis_conn_string)

    if not r:
        raise HTTPException(
            status_code=500,
            detail="Could not connect to Redis",
        )

    # Generate reset code
    def generate_code(length=5):
        letters_and_digits = string.ascii_letters + string.digits
        return "".join(random.choice(letters_and_digits) for _ in range(length))

    generated_reset_code = generate_code()
    reset_email_invite_uuid = f"reset_email_invite_code_{uuid.uuid4()}"

    ttl = int(datetime.now().timestamp()) + 60 * 60 * 1  # 1 hour

    resetCodeObject = {
        "reset_code": generated_reset_code,
        "reset_email_invite_uuid": reset_email_invite_uuid,
        "reset_code_expires": ttl,
        "reset_code_type": "signup",
        "created_at": datetime.now().isoformat(),
        "created_by": user.user_uuid,
        "org_uuid": org.org_uuid,
    }

    r.set(
        f"{reset_email_invite_uuid}:user:{user.user_uuid}:org:{org.org_uuid}:code:{generated_reset_code}",
        json.dumps(resetCodeObject),
        ex=ttl,
    )

    user = UserRead.model_validate(user)

    org = OrganizationRead.model_validate(org)

    # Send reset code via email
    isEmailSent = send_password_reset_email(
        generated_reset_code=generated_reset_code,
        user=user,
        organization=org,
        email=user.email,
    )

    if not isEmailSent:
        raise HTTPException(
            status_code=500,
            detail="Issue with sending reset code",
        )

    return "Reset code sent"


async def change_password_with_reset_code(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    new_password: str,
    org_id: int,
    email: EmailStr,
    reset_code: str,
):
    # Get user
    statement = select(User).where(User.email == email)
    user = db_session.exec(statement).first()

    if not user:
        raise HTTPException(
            status_code=400,
            detail="User does not exist",
        )

    # Get org
    statement = select(Organization).where(Organization.id == org_id)
    org = db_session.exec(statement).first()

    if not org:
        raise HTTPException(
            status_code=400,
            detail="Organization not found",
        )

    # Redis init
    LH_CONFIG = get_learnhouse_config()
    redis_conn_string = LH_CONFIG.redis_config.redis_connection_string

    if not redis_conn_string:
        raise HTTPException(
            status_code=500,
            detail="Redis connection string not found",
        )

    # Connect to Redis
    r = redis.Redis.from_url(redis_conn_string)

    if not r:
        raise HTTPException(
            status_code=500,
            detail="Could not connect to Redis",
        )

    # Get reset code
    reset_code_key = f"*:user:{user.user_uuid}:org:{org.org_uuid}:code:{reset_code}"
    keys = r.keys(reset_code_key)

    if not keys:
        raise HTTPException(
            status_code=400,
            detail="Reset code not found",
        )

    # Get reset code object
    reset_code_value = r.get(keys[0])

    if reset_code_value is None:
        raise HTTPException(
            status_code=400,
            detail="Reset code value not found",
        )
    reset_code_object = json.loads(reset_code_value)

    # Check if reset code is expired
    if reset_code_object["reset_code_expires"] < int(datetime.now().timestamp()):
        raise HTTPException(
            status_code=400,
            detail="Reset code expired",
        )

    # Change password
    user.password = security_hash_password(new_password)
    db_session.add(user)

    db_session.commit()
    db_session.refresh(user)

    # Delete reset code
    r.delete(keys[0])

    return "Password changed"



================================================
FILE: apps/api/src/services/users/usergroups.py
================================================
from datetime import datetime
import logging
from typing import Literal
from uuid import uuid4
from fastapi import HTTPException, Request
from sqlmodel import Session, select
from src.security.features_utils.usage import (
    check_limits_with_usage,
    increase_feature_usage,
)
from src.security.rbac.rbac import (
    authorization_verify_based_on_roles_and_authorship,
    authorization_verify_if_user_is_anon,
)
from src.db.usergroup_resources import UserGroupResource
from src.db.usergroup_user import UserGroupUser
from src.db.organizations import Organization
from src.db.usergroups import UserGroup, UserGroupCreate, UserGroupRead, UserGroupUpdate
from src.db.users import AnonymousUser, InternalUser, PublicUser, User, UserRead


async def create_usergroup(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    usergroup_create: UserGroupCreate,
) -> UserGroupRead:

    usergroup = UserGroup.model_validate(usergroup_create)

    # RBAC check
    await rbac_check(
        request,
        usergroup_uuid="usergroup_X",
        current_user=current_user,
        action="create",
        db_session=db_session,
    )

    # Check if Organization exists
    statement = select(Organization).where(Organization.id == usergroup_create.org_id)
    org = db_session.exec(statement).first()

    if not org or org.id is None:
        raise HTTPException(
            status_code=400,
            detail="Organization does not exist",
        )

    # Usage check
    check_limits_with_usage("courses", org.id, db_session)

    # Complete the object
    usergroup.usergroup_uuid = f"usergroup_{uuid4()}"
    usergroup.creation_date = str(datetime.now())
    usergroup.update_date = str(datetime.now())

    # Save the object
    db_session.add(usergroup)
    db_session.commit()
    db_session.refresh(usergroup)

    # Feature usage
    increase_feature_usage("usergroups", org.id, db_session)

    usergroup = UserGroupRead.model_validate(usergroup)

    return usergroup


async def read_usergroup_by_id(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    usergroup_id: int,
) -> UserGroupRead:

    statement = select(UserGroup).where(UserGroup.id == usergroup_id)
    usergroup = db_session.exec(statement).first()

    if not usergroup:
        raise HTTPException(
            status_code=404,
            detail="UserGroup not found",
        )

    # RBAC check
    await rbac_check(
        request,
        usergroup_uuid=usergroup.usergroup_uuid,
        current_user=current_user,
        action="read",
        db_session=db_session,
    )

    usergroup = UserGroupRead.model_validate(usergroup)

    return usergroup


async def get_users_linked_to_usergroup(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    usergroup_id: int,
) -> list[UserRead]:

    statement = select(UserGroup).where(UserGroup.id == usergroup_id)
    usergroup = db_session.exec(statement).first()

    if not usergroup:
        raise HTTPException(
            status_code=404,
            detail="UserGroup not found",
        )

    # RBAC check
    await rbac_check(
        request,
        usergroup_uuid=usergroup.usergroup_uuid,
        current_user=current_user,
        action="read",
        db_session=db_session,
    )

    statement = select(UserGroupUser).where(UserGroupUser.usergroup_id == usergroup_id)
    usergroup_users = db_session.exec(statement).all()

    user_ids = [usergroup_user.user_id for usergroup_user in usergroup_users]

    # get users
    users = []
    for user_id in user_ids:
        statement = select(User).where(User.id == user_id)
        user = db_session.exec(statement).first()
        users.append(user)

    users = [UserRead.model_validate(user) for user in users]

    return users


async def read_usergroups_by_org_id(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    org_id: int,
) -> list[UserGroupRead]:

    statement = select(UserGroup).where(UserGroup.org_id == org_id)
    usergroups = db_session.exec(statement).all()

    # RBAC check
    await rbac_check(
        request,
        usergroup_uuid="usergroup_X",
        current_user=current_user,
        action="read",
        db_session=db_session,
    )

    usergroups = [UserGroupRead.model_validate(usergroup) for usergroup in usergroups]

    return usergroups


async def get_usergroups_by_resource(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    resource_uuid: str,
) -> list[UserGroupRead]:

    statement = select(UserGroupResource).where(
        UserGroupResource.resource_uuid == resource_uuid
    )
    usergroup_resources = db_session.exec(statement).all()

    # RBAC check
    await rbac_check(
        request,
        usergroup_uuid="usergroup_X",
        current_user=current_user,
        action="read",
        db_session=db_session,
    )

    usergroup_ids = [usergroup.usergroup_id for usergroup in usergroup_resources]

    # get usergroups
    usergroups = []
    for usergroup_id in usergroup_ids:
        statement = select(UserGroup).where(UserGroup.id == usergroup_id)
        usergroup = db_session.exec(statement).first()
        usergroups.append(usergroup)

    usergroups = [UserGroupRead.model_validate(usergroup) for usergroup in usergroups]

    return usergroups


async def update_usergroup_by_id(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    usergroup_id: int,
    usergroup_update: UserGroupUpdate,
) -> UserGroupRead:

    statement = select(UserGroup).where(UserGroup.id == usergroup_id)
    usergroup = db_session.exec(statement).first()

    if not usergroup:
        raise HTTPException(
            status_code=404,
            detail="UserGroup not found",
        )

    # RBAC check
    await rbac_check(
        request,
        usergroup_uuid=usergroup.usergroup_uuid,
        current_user=current_user,
        action="update",
        db_session=db_session,
    )

    usergroup.name = usergroup_update.name
    usergroup.description = usergroup_update.description
    usergroup.update_date = str(datetime.now())

    db_session.add(usergroup)
    db_session.commit()
    db_session.refresh(usergroup)

    usergroup = UserGroupRead.model_validate(usergroup)

    return usergroup


async def delete_usergroup_by_id(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    usergroup_id: int,
) -> str:

    statement = select(UserGroup).where(UserGroup.id == usergroup_id)
    usergroup = db_session.exec(statement).first()

    if not usergroup:
        raise HTTPException(
            status_code=404,
            detail="UserGroup not found",
        )

    # RBAC check
    await rbac_check(
        request,
        usergroup_uuid=usergroup.usergroup_uuid,
        current_user=current_user,
        action="delete",
        db_session=db_session,
    )

    # Feature usage
    increase_feature_usage("usergroups", usergroup.org_id, db_session)

    db_session.delete(usergroup)
    db_session.commit()

    return "UserGroup deleted successfully"


async def add_users_to_usergroup(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser | InternalUser,
    usergroup_id: int,
    user_ids: str,
) -> str:

    statement = select(UserGroup).where(UserGroup.id == usergroup_id)
    usergroup = db_session.exec(statement).first()

    if not usergroup:
        raise HTTPException(
            status_code=404,
            detail="UserGroup not found",
        )

    # RBAC check
    await rbac_check(
        request,
        usergroup_uuid=usergroup.usergroup_uuid,
        current_user=current_user,
        action="create",
        db_session=db_session,
    )

    user_ids_array = user_ids.split(",")

    for user_id in user_ids_array:
        statement = select(User).where(User.id == user_id)
        user = db_session.exec(statement).first()

        # Check if User is already Linked to UserGroup
        statement = select(UserGroupUser).where(
            UserGroupUser.usergroup_id == usergroup_id,
            UserGroupUser.user_id == user_id,
        )
        usergroup_user = db_session.exec(statement).first()

        if usergroup_user:
            logging.error(f"User with id {user_id} already exists in UserGroup")
            continue

        if user:
            # Add user to UserGroup
            if user.id is not None:
                usergroup_obj = UserGroupUser(
                    usergroup_id=usergroup_id,
                    user_id=user.id,
                    org_id=usergroup.org_id,
                    creation_date=str(datetime.now()),
                    update_date=str(datetime.now()),
                )

                db_session.add(usergroup_obj)
                db_session.commit()
                db_session.refresh(usergroup_obj)
        else:
            logging.error(f"User with id {user_id} not found")

    return "Users added to UserGroup successfully"


async def remove_users_from_usergroup(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    usergroup_id: int,
    user_ids: str,
) -> str:

    statement = select(UserGroup).where(UserGroup.id == usergroup_id)
    usergroup = db_session.exec(statement).first()

    if not usergroup:
        raise HTTPException(
            status_code=404,
            detail="UserGroup not found",
        )

    # RBAC check
    await rbac_check(
        request,
        usergroup_uuid=usergroup.usergroup_uuid,
        current_user=current_user,
        action="delete",
        db_session=db_session,
    )

    user_ids_array = user_ids.split(",")

    for user_id in user_ids_array:
        statement = select(UserGroupUser).where(
            UserGroupUser.user_id == user_id, UserGroupUser.usergroup_id == usergroup_id
        )
        usergroup_user = db_session.exec(statement).first()

        if usergroup_user:
            db_session.delete(usergroup_user)
            db_session.commit()
        else:
            logging.error(f"User with id {user_id} not found in UserGroup")

    return "Users removed from UserGroup successfully"


async def add_resources_to_usergroup(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    usergroup_id: int,
    resources_uuids: str,
) -> str:

    statement = select(UserGroup).where(UserGroup.id == usergroup_id)
    usergroup = db_session.exec(statement).first()

    if not usergroup:
        raise HTTPException(
            status_code=404,
            detail="UserGroup not found",
        )

    # RBAC check
    await rbac_check(
        request,
        usergroup_uuid=usergroup.usergroup_uuid,
        current_user=current_user,
        action="create",
        db_session=db_session,
    )

    resources_uuids_array = resources_uuids.split(",")

    for resource_uuid in resources_uuids_array:
        # Check if a link between UserGroup and Resource already exists
        statement = select(UserGroupResource).where(
            UserGroupResource.usergroup_id == usergroup_id,
            UserGroupResource.resource_uuid == resource_uuid,
        )
        usergroup_resource = db_session.exec(statement).first()

        if usergroup_resource:
            raise HTTPException(
                status_code=400,
                detail=f"Resource {resource_uuid} already exists in UserGroup",
            )
            continue

        # TODO : Find a way to check if resource really exists
        usergroup_obj = UserGroupResource(
            usergroup_id=usergroup_id,
            resource_uuid=resource_uuid,
            org_id=usergroup.org_id,
            creation_date=str(datetime.now()),
            update_date=str(datetime.now()),
        )

        db_session.add(usergroup_obj)
        db_session.commit()
        db_session.refresh(usergroup_obj)

    return "Resources added to UserGroup successfully"


async def remove_resources_from_usergroup(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    usergroup_id: int,
    resources_uuids: str,
) -> str:

    statement = select(UserGroup).where(UserGroup.id == usergroup_id)
    usergroup = db_session.exec(statement).first()

    if not usergroup:
        raise HTTPException(
            status_code=404,
            detail="UserGroup not found",
        )

    # RBAC check
    await rbac_check(
        request,
        usergroup_uuid=usergroup.usergroup_uuid,
        current_user=current_user,
        action="delete",
        db_session=db_session,
    )

    resources_uuids_array = resources_uuids.split(",")

    for resource_uuid in resources_uuids_array:
        statement = select(UserGroupResource).where(
            UserGroupResource.resource_uuid == resource_uuid
        )
        usergroup_resource = db_session.exec(statement).first()

        if usergroup_resource:
            db_session.delete(usergroup_resource)
            db_session.commit()
        else:
            logging.error(f"resource with uuid {resource_uuid} not found in UserGroup")

    return "Resources removed from UserGroup successfully"


## ğŸ”’ RBAC Utils ##


async def rbac_check(
    request: Request,
    usergroup_uuid: str,
    current_user: PublicUser | AnonymousUser | InternalUser,
    action: Literal["create", "read", "update", "delete"],
    db_session: Session,
):
    if isinstance(current_user, InternalUser):
        return True

    await authorization_verify_if_user_is_anon(current_user.id)

    await authorization_verify_based_on_roles_and_authorship(
        request,
        current_user.id,
        action,
        usergroup_uuid,
        db_session,
    )


## ğŸ”’ RBAC Utils ##



================================================
FILE: apps/api/src/services/users/users.py
================================================
from datetime import datetime
from typing import Literal
from uuid import uuid4
from fastapi import HTTPException, Request, UploadFile, status
from sqlmodel import Session, select
from src.security.features_utils.usage import (
    check_limits_with_usage,
    increase_feature_usage,
)
from src.services.users.usergroups import add_users_to_usergroup
from src.services.users.emails import (
    send_account_creation_email,
)
from src.services.orgs.invites import get_invite_code
from src.services.users.avatars import upload_avatar
from src.db.roles import Role, RoleRead
from src.security.rbac.rbac import (
    authorization_verify_based_on_roles_and_authorship,
    authorization_verify_if_user_is_anon,
)
from src.db.organizations import Organization, OrganizationRead
from src.db.users import (
    AnonymousUser,
    InternalUser,
    PublicUser,
    User,
    UserCreate,
    UserRead,
    UserRoleWithOrg,
    UserSession,
    UserUpdate,
    UserUpdatePassword,
)
from src.db.user_organizations import UserOrganization
from src.security.security import security_hash_password, security_verify_password


async def create_user(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    user_object: UserCreate,
    org_id: int,
):
    user = User.model_validate(user_object)

    # RBAC check
    await rbac_check(request, current_user, "create", "user_x", db_session)

    # Complete the user object
    user.user_uuid = f"user_{uuid4()}"
    user.password = security_hash_password(user_object.password)
    user.email_verified = False
    user.creation_date = str(datetime.now())
    user.update_date = str(datetime.now())

    # Verifications

    # Check if Organization exists
    statement = select(Organization).where(Organization.id == org_id)
    result = db_session.exec(statement)

    if not result.first():
        raise HTTPException(
            status_code=400,
            detail="Organization does not exist",
        )

    # Usage check
    check_limits_with_usage("members", org_id, db_session)

    # Username
    statement = select(User).where(User.username == user.username)
    result = db_session.exec(statement)

    if result.first():
        raise HTTPException(
            status_code=400,
            detail="Username already exists",
        )

    # Email
    statement = select(User).where(User.email == user.email)
    result = db_session.exec(statement)

    if result.first():
        raise HTTPException(
            status_code=400,
            detail="Email already exists",
        )

    # Exclude unset values
    user_data = user.dict(exclude_unset=True)
    for key, value in user_data.items():
        setattr(user, key, value)

    # Add user to database
    db_session.add(user)
    db_session.commit()
    db_session.refresh(user)

    # Link user and organization
    user_organization = UserOrganization(
        user_id=user.id if user.id else 0,
        org_id=int(org_id),
        role_id=4,
        creation_date=str(datetime.now()),
        update_date=str(datetime.now()),
    )

    db_session.add(user_organization)
    db_session.commit()
    db_session.refresh(user_organization)

    user = UserRead.model_validate(user)

    increase_feature_usage("members", org_id, db_session)

    # Send Account creation email
    send_account_creation_email(
        user=user,
        email=user.email,
    )

    return user


async def create_user_with_invite(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    user_object: UserCreate,
    org_id: int,
    invite_code: str,
):

    # Check if invite code exists
    inviteCode = await get_invite_code(
        request, org_id, invite_code, current_user, db_session
    )

    if not inviteCode:
        raise HTTPException(
            status_code=400,
            detail="Invite code is incorrect",
        )

    # Usage check
    check_limits_with_usage("members", org_id, db_session)

    

    user = await create_user(request, db_session, current_user, user_object, org_id)

    # Check if invite code contains UserGroup
    if inviteCode.get("usergroup_id"): # type: ignore
        # Add user to UserGroup
        await add_users_to_usergroup(
            request,
            db_session,
            InternalUser(id=0),
            int(inviteCode.get("usergroup_id")), # type: ignore / Convert to int since usergroup_id is expected to be int
            str(user.id),
        )

    increase_feature_usage("members", org_id, db_session)

    return user


async def create_user_without_org(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    user_object: UserCreate,
):
    user = User.model_validate(user_object)

    # RBAC check
    await rbac_check(request, current_user, "create", "user_x", db_session)

    # Complete the user object
    user.user_uuid = f"user_{uuid4()}"
    user.password = security_hash_password(user_object.password)
    user.email_verified = False
    user.creation_date = str(datetime.now())
    user.update_date = str(datetime.now())

    # Verifications

    # Username
    statement = select(User).where(User.username == user.username)
    result = db_session.exec(statement)

    if result.first():
        raise HTTPException(
            status_code=400,
            detail="Username already exists",
        )

    # Email
    statement = select(User).where(User.email == user.email)
    result = db_session.exec(statement)

    if result.first():
        raise HTTPException(
            status_code=400,
            detail="Email already exists",
        )

    # Exclude unset values
    user_data = user.dict(exclude_unset=True)
    for key, value in user_data.items():
        setattr(user, key, value)

    # Add user to database
    db_session.add(user)
    db_session.commit()
    db_session.refresh(user)

    user = UserRead.model_validate(user)

    # Send Account creation email
    send_account_creation_email(
        user=user,
        email=user.email,
    )

    return user


async def update_user(
    request: Request,
    db_session: Session,
    user_id: int,
    current_user: PublicUser | AnonymousUser,
    user_object: UserUpdate,
):
    # Get user
    statement = select(User).where(User.id == user_id)
    user = db_session.exec(statement).first()

    if not user:
        raise HTTPException(
            status_code=400,
            detail="User does not exist",
        )

    # RBAC check
    await rbac_check(request, current_user, "update", user.user_uuid, db_session)

    # Verifications

    # Username
    statement = select(User).where(User.username == user_object.username)
    username_user = db_session.exec(statement).first()

    if username_user:
        isSameUser = username_user.id == current_user.id
        if not isSameUser:
            raise HTTPException(
                status_code=400,
                detail="Username already exists",
            )

    # Email
    statement = select(User).where(User.email == user_object.email)
    email_user = db_session.exec(statement).first()

    if email_user:
        isSameUser = email_user.id == current_user.id
        if not isSameUser:
            raise HTTPException(
                status_code=400,
                detail="Email already exists",
            )

    # Update user
    user_data = user_object.dict(exclude_unset=True)
    for key, value in user_data.items():
        setattr(user, key, value)

    user.update_date = str(datetime.now())

    # Update user in database
    db_session.add(user)
    db_session.commit()
    db_session.refresh(user)

    user = UserRead.model_validate(user)

    return user


async def update_user_avatar(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    avatar_file: UploadFile | None = None,
):
    # Get user
    statement = select(User).where(User.id == current_user.id)
    user = db_session.exec(statement).first()

    if not user:
        raise HTTPException(
            status_code=400,
            detail="User does not exist",
        )

    # RBAC check
    await rbac_check(request, current_user, "update", user.user_uuid, db_session)

    # Upload avatar with security validation
    if avatar_file and avatar_file.filename:
        try:
            name_in_disk = await upload_avatar(avatar_file, user.user_uuid)
            user.avatar_image = name_in_disk
        except Exception as e:
            raise HTTPException(
                status_code=400,
                detail=f"Avatar upload failed: {str(e)}",
            )

    # Update user in database
    db_session.add(user)
    db_session.commit()
    db_session.refresh(user)

    user = UserRead.model_validate(user)

    return user


async def update_user_password(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    user_id: int,
    form: UserUpdatePassword,
):
    # Get user
    statement = select(User).where(User.id == user_id)
    user = db_session.exec(statement).first()

    if not user:
        raise HTTPException(
            status_code=400,
            detail="User does not exist",
        )

    # RBAC check
    await rbac_check(request, current_user, "update", user.user_uuid, db_session)

    if not security_verify_password(form.old_password, user.password):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED, detail="Wrong password"
        )

    # Update user
    user.password = security_hash_password(form.new_password)
    user.update_date = str(datetime.now())

    # Update user in database
    db_session.add(user)
    db_session.commit()
    db_session.refresh(user)

    user = UserRead.model_validate(user)

    return user


async def read_user_by_id(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    user_id: int,
):
    # Get user
    statement = select(User).where(User.id == user_id)
    user = db_session.exec(statement).first()

    if not user:
        raise HTTPException(
            status_code=400,
            detail="User does not exist",
        )

    user = UserRead.model_validate(user)

    return user


async def read_user_by_uuid(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    user_uuid: str,
):
    # Get user
    statement = select(User).where(User.user_uuid == user_uuid)
    user = db_session.exec(statement).first()

    if not user:
        raise HTTPException(
            status_code=400,
            detail="User does not exist",
        )

    

    user = UserRead.model_validate(user)

    return user


async def read_user_by_username(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    username: str,
):
    # Get user
    statement = select(User).where(User.username == username)
    user = db_session.exec(statement).first()

    if not user:
        raise HTTPException(
            status_code=400,
            detail="User does not exist",
        )

    

    user = UserRead.model_validate(user)

    return user


async def get_user_session(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
) -> UserSession:
    # Get user
    statement = select(User).where(User.user_uuid == current_user.user_uuid)
    user = db_session.exec(statement).first()

    if not user:
        raise HTTPException(
            status_code=400,
            detail="User does not exist",
        )

    user = UserRead.model_validate(user)

    # Get roles and orgs
    statement = (
        select(UserOrganization)
        .where(UserOrganization.user_id == user.id)
        .join(Organization)
    )
    user_organizations = db_session.exec(statement).all()

    roles = []

    for user_organization in user_organizations:
        role_statement = select(Role).where(Role.id == user_organization.role_id)
        role = db_session.exec(role_statement).first()

        org_statement = select(Organization).where(
            Organization.id == user_organization.org_id
        )
        org = db_session.exec(org_statement).first()

        roles.append(
            UserRoleWithOrg(
                role=RoleRead.model_validate(role),
                org=OrganizationRead.model_validate(org),
            )
        )

    user_session = UserSession(
        user=user,
        roles=roles,
    )

    return user_session


async def authorize_user_action(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    resource_uuid: str,
    action: Literal["create", "read", "update", "delete"],
):
    # Get user
    statement = select(User).where(User.user_uuid == current_user.user_uuid)
    user = db_session.exec(statement).first()

    if not user:
        raise HTTPException(
            status_code=400,
            detail="User does not exist",
        )

    # RBAC check
    authorized = (
        await authorization_verify_based_on_roles_and_authorship(
            request, current_user.id, action, resource_uuid, db_session
        )
    )

    if authorized:
        return True
    else:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="You are not authorized to perform this action",
        )


async def delete_user_by_id(
    request: Request,
    db_session: Session,
    current_user: PublicUser | AnonymousUser,
    user_id: int,
):
    # Get user
    statement = select(User).where(User.id == user_id)
    user = db_session.exec(statement).first()

    if not user:
        raise HTTPException(
            status_code=400,
            detail="User does not exist",
        )

    # RBAC check
    await rbac_check(request, current_user, "delete", user.user_uuid, db_session)

    # Delete user
    db_session.delete(user)
    db_session.commit()

    return "User deleted"


# Utils & Security functions


async def security_get_user(request: Request, db_session: Session, email: str) -> User:
    # Check if user exists
    statement = select(User).where(User.email == email)
    user = db_session.exec(statement).first()

    if not user:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT,
            detail="User with Email does not exist",
        )

    user = User(**user.model_dump())

    return user


## ğŸ”’ RBAC Utils ##


async def rbac_check(
    request: Request,
    current_user: PublicUser | AnonymousUser,
    action: Literal["create", "read", "update", "delete"],
    user_uuid: str,
    db_session: Session,
):
    if action == "create" or action == "read":
        if current_user.id == 0:  # if user is anonymous
            return True
        else:
            await authorization_verify_based_on_roles_and_authorship(
                request, current_user.id, "create", "user_x", db_session
            )

    else:
        await authorization_verify_if_user_is_anon(current_user.id)

        # if user is the same as the one being read
        if current_user.user_uuid == user_uuid:
            return True

        await authorization_verify_based_on_roles_and_authorship(
            request, current_user.id, action, user_uuid, db_session
        )


## ğŸ”’ RBAC Utils ##



================================================
FILE: apps/api/src/services/utils/link_preview.py
================================================
import httpx
from bs4 import BeautifulSoup, Tag
from typing import Optional, Dict
from urllib.parse import urljoin, urlparse

async def fetch_link_preview(url: str) -> Dict[str, Optional[str]]:
    async with httpx.AsyncClient(follow_redirects=True, timeout=10) as client:
        response = await client.get(url)
        response.raise_for_status()
        html = response.text

    soup = BeautifulSoup(html, 'html.parser')

    def get_meta(property_name: str, attr: str = 'property') -> Optional[str]:
        tag = soup.find('meta', attrs={attr: property_name})
        if tag and isinstance(tag, Tag) and tag.has_attr('content'):
            content = tag['content']
            if isinstance(content, str):
                return content
        return None

    # Title
    title = soup.title.string.strip() if soup.title and soup.title.string else None
    # Description
    description = get_meta('og:description') or get_meta('description', 'name')
    # OG Image
    og_image = get_meta('og:image')
    if og_image and isinstance(og_image, str) and not og_image.startswith('http'):
        og_image = urljoin(url, og_image)
    # Favicon (robust)
    favicon = None
    icon_rels = [
        'icon',
        'shortcut icon',
        'apple-touch-icon',
        'apple-touch-icon-precomposed',
    ]
    for link in soup.find_all('link'):
        if not isinstance(link, Tag):
            continue
        rels = link.get('rel')
        href = link.get('href')
        if rels and href:
            rels_lower = [r.lower() for r in rels]
            if any(rel in rels_lower for rel in icon_rels):
                if isinstance(href, str):
                    favicon = href
                    break
    # Fallback to /favicon.ico if not found
    if not favicon:
        parsed = urlparse(url)
        favicon = f"{parsed.scheme}://{parsed.netloc}/favicon.ico"
    elif favicon and not favicon.startswith('http'):
        favicon = urljoin(url, favicon)
    # OG Title
    og_title = get_meta('og:title')
    # OG Type
    og_type = get_meta('og:type')
    # OG URL
    og_url = get_meta('og:url')

    return {
        'title': og_title or title,
        'description': description,
        'og_image': og_image,
        'favicon': favicon,
        'og_type': og_type,
        'og_url': og_url or url,
        'url': url,
    } 


================================================
FILE: apps/api/src/services/utils/upload_content.py
================================================
from typing import Literal, Optional
import boto3
from botocore.exceptions import ClientError
import os
from fastapi import HTTPException, UploadFile
from config.config import get_learnhouse_config
from src.security.file_validation import validate_upload


def ensure_directory_exists(directory: str):
    if not os.path.exists(directory):
        os.makedirs(directory)


async def upload_file(
    file: UploadFile,
    directory: str,
    type_of_dir: Literal["orgs", "users"],
    uuid: str,
    allowed_types: list[str],
    filename_prefix: str,
    max_size: Optional[int] = None,
) -> str:
    """
    Secure file upload with validation.
    
    Args:
        file: The uploaded file
        directory: Target directory (e.g., "logos", "avatars")
        type_of_dir: "orgs" or "users"
        uuid: Organization or user UUID
        allowed_types: List of allowed file types ('image', 'video', 'document')
        filename_prefix: Prefix for the generated filename
        max_size: Maximum file size in bytes (optional)
        
    Returns:
        The saved filename
    """
    from uuid import uuid4
    from src.security.file_validation import get_safe_filename
    
    # Validate the file
    _, content = validate_upload(file, allowed_types, max_size)
    
    # Generate safe filename
    filename = get_safe_filename(file.filename, f"{uuid4()}_{filename_prefix}")
    
    # Save the file
    await upload_content(
        directory=directory,
        type_of_dir=type_of_dir,
        uuid=uuid,
        file_binary=content,
        file_and_format=filename,
        allowed_formats=None,  # Already validated
    )
    
    return filename


async def upload_content(
    directory: str,
    type_of_dir: Literal["orgs", "users"],
    uuid: str,  # org_uuid or user_uuid
    file_binary: bytes,
    file_and_format: str,
    allowed_formats: Optional[list[str]] = None,
):
    # Get Learnhouse Config
    learnhouse_config = get_learnhouse_config()

    file_format = file_and_format.split(".")[-1].strip().lower()

    # Get content delivery method
    content_delivery = learnhouse_config.hosting_config.content_delivery.type

    # Check if format file is allowed
    if allowed_formats:
        if file_format not in allowed_formats:
            raise HTTPException(
                status_code=400,
                detail=f"File format {file_format} not allowed",
            )

    ensure_directory_exists(f"content/{type_of_dir}/{uuid}/{directory}")

    if content_delivery == "filesystem":
        # upload file to server
        with open(
            f"content/{type_of_dir}/{uuid}/{directory}/{file_and_format}",
            "wb",
        ) as f:
            f.write(file_binary)
            f.close()

    elif content_delivery == "s3api":
        # Upload to server then to s3 (AWS Keys are stored in environment variables and are loaded by boto3)
        # TODO: Improve implementation of this
        print("Uploading to s3...")
        s3 = boto3.client(
            "s3",
            endpoint_url=learnhouse_config.hosting_config.content_delivery.s3api.endpoint_url,
        )

        # Upload file to server
        with open(
            f"content/{type_of_dir}/{uuid}/{directory}/{file_and_format}",
            "wb",
        ) as f:
            f.write(file_binary)
            f.close()

        print("Uploading to s3 using boto3...")
        try:
            s3.upload_file(
                f"content/{type_of_dir}/{uuid}/{directory}/{file_and_format}",
                "learnhouse-media",
                f"content/{type_of_dir}/{uuid}/{directory}/{file_and_format}",
            )
        except ClientError as e:
            print(e)

        print("Checking if file exists in s3...")
        try:
            s3.head_object(
                Bucket="learnhouse-media",
                Key=f"content/{type_of_dir}/{uuid}/{directory}/{file_and_format}",
            )
            print("File upload successful!")
        except Exception as e:
            print(f"An error occurred: {str(e)}")



================================================
FILE: apps/api/src/tests/__init__.py
================================================
[Empty file]


================================================
FILE: apps/api/src/tests/conftest.py
================================================
import sys
import os

# Ensure src/ is on the Python path for all tests
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '../..')))

# Set testing environment variable to use SQLite
os.environ["TESTING"] = "true"

# Suppress logfire warnings in tests
os.environ["LOGFIRE_IGNORE_NO_CONFIG"] = "1" 


================================================
FILE: apps/api/src/tests/security/README.md
================================================
# Security Module Tests

This directory contains comprehensive unit tests for the security module of the LearnHouse API.

## Test Structure

The security tests are organized into the following files:

### Core Security Tests
- **`test_security.py`** - Tests for password hashing, JWT constants, and core security functions
- **`test_auth.py`** - Tests for JWT authentication, user authentication, and token management

### Role-Based Access Control (RBAC) Tests
- **`test_rbac.py`** - Tests for RBAC authorization functions and user permissions
- **`test_rbac_utils.py`** - Tests for RBAC utility functions like element type checking

### Feature Usage Tests
- **`test_features_utils.py`** - Tests for feature usage tracking and limits

### Comprehensive Tests
- **`test_security_all.py`** - Comprehensive test suite that imports and validates all security modules

## Test Coverage

### Security Core (`test_security.py`)
- âœ… Password hashing with `security_hash_password()`
- âœ… Password verification with `security_verify_password()`
- âœ… JWT constants validation
- âœ… Edge cases (special characters, unicode, long passwords)
- âœ… Password consistency and security

### Authentication (`test_auth.py`)
- âœ… JWT token creation and validation
- âœ… User authentication flow
- âœ… Anonymous user handling
- âœ… Token expiry and validation
- âœ… Error handling for invalid tokens
- âœ… Settings and configuration validation

### RBAC (`test_rbac.py`)
- âœ… Public element authorization
- âœ… User author verification
- âœ… Role-based permissions
- âœ… Organization admin status
- âœ… Combined roles and authorship
- âœ… Anonymous user restrictions

### RBAC Utils (`test_rbac_utils.py`)
- âœ… Element type detection for all supported types
- âœ… Singular form conversion
- âœ… ID identifier generation
- âœ… Edge cases and error handling
- âœ… Consistency validation

### Feature Usage (`test_features_utils.py`)
- âœ… Feature limit checking
- âœ… Usage tracking (increase/decrease)
- âœ… Redis integration
- âœ… Organization configuration validation
- âœ… Unlimited feature handling
- âœ… Error handling for missing configs

## Running the Tests

### Run All Security Tests
```bash
# From the project root
pytest src/tests/security/ -v

# Run with coverage
pytest src/tests/security/ --cov=src.security --cov-report=html
```

### Run Specific Test Files
```bash
# Run only core security tests
pytest src/tests/security/test_security.py -v

# Run only authentication tests
pytest src/tests/security/test_auth.py -v

# Run only RBAC tests
pytest src/tests/security/test_rbac.py -v

# Run only feature usage tests
pytest src/tests/security/test_features_utils.py -v
```

### Run Comprehensive Tests
```bash
# Run the comprehensive test suite
pytest src/tests/security/test_security_all.py -v
```

## Test Dependencies

The tests use the following dependencies:
- `pytest` - Testing framework
- `pytest-asyncio` - Async test support
- `unittest.mock` - Mocking and patching
- `fastapi` - HTTP exception testing
- `sqlmodel` - Database session mocking

## Mock Strategy

The tests use comprehensive mocking to isolate the security functionality:

1. **Database Sessions** - Mocked to avoid actual database connections
2. **Redis Connections** - Mocked to avoid actual Redis dependencies
3. **External Services** - Mocked to test error conditions
4. **Configuration** - Mocked to test different config scenarios

## Test Patterns

### Async Testing
All async functions are properly tested with `@pytest.mark.asyncio` decorators.

### Error Handling
Tests verify that appropriate HTTP exceptions are raised with correct status codes and messages.

### Edge Cases
Tests cover edge cases like:
- Empty or null values
- Invalid UUIDs
- Disabled features
- Missing configurations
- Network failures

### Type Safety
Tests ensure type safety by using proper type annotations and handling type checking errors.

## Adding New Tests

When adding new security functionality:

1. **Create a new test file** following the naming convention `test_<module_name>.py`
2. **Add comprehensive test cases** covering success, failure, and edge cases
3. **Use proper mocking** to isolate the functionality being tested
4. **Add async support** if the function is async
5. **Update this README** to document the new tests

## Test Data

The tests use mock data that represents realistic scenarios:
- Mock users with different permission levels
- Mock organizations with various configurations
- Mock resources with different access patterns
- Mock Redis usage data

## Continuous Integration

These tests are designed to run in CI/CD pipelines and provide:
- Fast execution (no real database/Redis connections)
- Comprehensive coverage of security functionality
- Clear error messages for debugging
- Reliable results across different environments

## Security Considerations

The tests are designed to validate security without exposing sensitive information:
- No real passwords or tokens in test data
- Mocked authentication flows
- Isolated testing of security functions
- No actual encryption/decryption of sensitive data

## Contributing

When contributing to security tests:

1. Follow the existing patterns and conventions
2. Ensure all edge cases are covered
3. Use descriptive test names and docstrings
4. Add appropriate error handling tests
5. Update documentation as needed 


================================================
FILE: apps/api/src/tests/security/__init__.py
================================================
# Security tests package 


================================================
FILE: apps/api/src/tests/security/test_auth.py
================================================
import pytest
from unittest.mock import Mock, AsyncMock, patch
from fastapi import HTTPException, Request
from fastapi_jwt_auth import AuthJWT
from sqlmodel import Session
from src.security.auth import (
    authenticate_user,
    create_access_token,
    get_current_user,
    non_public_endpoint,
    Token,
    TokenData,
    Settings,
)
from src.db.users import User, AnonymousUser, PublicUser
from datetime import datetime, timedelta, timezone
from jose import jwt
from src.security.security import SECRET_KEY, ALGORITHM


class TestAuth:
    """Test cases for auth.py module"""

    @pytest.fixture
    def mock_request(self):
        """Create a mock request object"""
        return Mock(spec=Request)

    @pytest.fixture
    def mock_db_session(self):
        """Create a mock database session"""
        return Mock(spec=Session)

    @pytest.fixture
    def mock_user(self):
        """Create a mock user object"""
        user = Mock(spec=User)
        user.email = "test@example.com"
        user.password = "hashed_password"
        user.model_dump.return_value = {
            "id": 1,
            "email": "test@example.com",
            "username": "testuser",
            "first_name": "Test",
            "last_name": "User",
            "user_uuid": "user_123"
        }
        return user

    def test_token_model(self):
        """Test Token model"""
        token = Token(access_token="test_token", token_type="bearer")
        assert token.access_token == "test_token"
        assert token.token_type == "bearer"

    def test_token_data_model(self):
        """Test TokenData model"""
        token_data = TokenData(username="test@example.com")
        assert token_data.username == "test@example.com"

    def test_token_data_model_default(self):
        """Test TokenData model with default values"""
        token_data = TokenData()
        assert token_data.username is None

    def test_settings_model(self):
        """Test Settings model"""
        settings = Settings()
        assert settings.authjwt_secret_key == "secret"  # Default in dev mode
        assert settings.authjwt_token_location == {"cookies", "headers"}
        assert settings.authjwt_cookie_csrf_protect is False
        assert settings.authjwt_cookie_samesite == "lax"
        assert settings.authjwt_cookie_secure is True

    # Note: get_config is a decorator function for AuthJWT.load_config
    # Testing it directly may not be appropriate in unit tests
    pass

    @pytest.mark.asyncio
    async def test_authenticate_user_success(self, mock_request, mock_db_session, mock_user):
        """Test successful user authentication"""
        with patch('src.security.auth.security_get_user', new_callable=AsyncMock) as mock_get_user, \
             patch('src.security.auth.security_verify_password', return_value=True):
            
            mock_get_user.return_value = mock_user
            
            result = await authenticate_user(
                request=mock_request,
                email="test@example.com",
                password="correct_password",
                db_session=mock_db_session
            )
            
            assert result == mock_user
            mock_get_user.assert_called_once_with(mock_request, mock_db_session, "test@example.com")

    @pytest.mark.asyncio
    async def test_authenticate_user_user_not_found(self, mock_request, mock_db_session):
        """Test authentication when user is not found"""
        with patch('src.security.auth.security_get_user', new_callable=AsyncMock) as mock_get_user:
            mock_get_user.return_value = None
            
            result = await authenticate_user(
                request=mock_request,
                email="nonexistent@example.com",
                password="password",
                db_session=mock_db_session
            )
            
            assert result is False

    @pytest.mark.asyncio
    async def test_authenticate_user_wrong_password(self, mock_request, mock_db_session, mock_user):
        """Test authentication with wrong password"""
        with patch('src.security.auth.security_get_user', new_callable=AsyncMock) as mock_get_user, \
             patch('src.security.auth.security_verify_password', return_value=False):
            
            mock_get_user.return_value = mock_user
            
            result = await authenticate_user(
                request=mock_request,
                email="test@example.com",
                password="wrong_password",
                db_session=mock_db_session
            )
            
            assert result is False

    def test_create_access_token_default_expiry(self):
        """Test access token creation with default expiry"""
        data = {"sub": "test@example.com"}
        token = create_access_token(data)
        
        # Verify token is created
        assert isinstance(token, str)
        assert len(token) > 0
        
        # Decode and verify token
        decoded = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        assert decoded["sub"] == "test@example.com"
        assert "exp" in decoded

    def test_create_access_token_custom_expiry(self):
        """Test access token creation with custom expiry"""
        data = {"sub": "test@example.com"}
        expires_delta = timedelta(hours=2)
        token = create_access_token(data, expires_delta)
        
        # Decode and verify token
        decoded = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        assert decoded["sub"] == "test@example.com"
        
        # Check that expiry time exists and is in the future
        assert "exp" in decoded
        exp_time = datetime.fromtimestamp(decoded["exp"], tz=timezone.utc)
        now = datetime.now(timezone.utc)
        
        # Verify the token expires in the future
        assert exp_time > now

    @pytest.mark.asyncio
    async def test_get_current_user_authenticated(self, mock_request, mock_db_session, mock_user):
        """Test getting current user when authenticated"""
        with patch('src.security.auth.security_get_user', new_callable=AsyncMock) as mock_get_user:
            mock_get_user.return_value = mock_user
            
            # Mock AuthJWT
            mock_authorize = Mock(spec=AuthJWT)
            mock_authorize.jwt_optional.return_value = None
            mock_authorize.get_jwt_subject.return_value = "test@example.com"
            
            result = await get_current_user(
                request=mock_request,
                Authorize=mock_authorize,
                db_session=mock_db_session
            )
            
            assert isinstance(result, PublicUser)
            mock_get_user.assert_called_once_with(mock_request, mock_db_session, email="test@example.com")

    @pytest.mark.asyncio
    async def test_get_current_user_anonymous(self, mock_request, mock_db_session):
        """Test getting current user when anonymous"""
        # Mock AuthJWT
        mock_authorize = Mock(spec=AuthJWT)
        mock_authorize.jwt_optional.return_value = None
        mock_authorize.get_jwt_subject.return_value = None
        
        result = await get_current_user(
            request=mock_request,
            Authorize=mock_authorize,
            db_session=mock_db_session
        )
        
        assert isinstance(result, AnonymousUser)

    @pytest.mark.asyncio
    async def test_get_current_user_jwt_error(self, mock_request, mock_db_session):
        """Test getting current user when JWT is invalid"""
        from jose import JWTError
        
        # Mock AuthJWT to raise JWTError
        mock_authorize = Mock(spec=AuthJWT)
        mock_authorize.jwt_optional.side_effect = JWTError("Invalid token")
        
        with pytest.raises(HTTPException) as exc_info:
            await get_current_user(
                request=mock_request,
                Authorize=mock_authorize,
                db_session=mock_db_session
            )
        
        assert exc_info.value.status_code == 401
        assert "Could not validate credentials" in exc_info.value.detail

    @pytest.mark.asyncio
    async def test_get_current_user_user_not_found(self, mock_request, mock_db_session):
        """Test getting current user when user doesn't exist in database"""
        with patch('src.security.auth.security_get_user', new_callable=AsyncMock) as mock_get_user:
            mock_get_user.return_value = None
            
            # Mock AuthJWT
            mock_authorize = Mock(spec=AuthJWT)
            mock_authorize.jwt_optional.return_value = None
            mock_authorize.get_jwt_subject.return_value = "nonexistent@example.com"
            
            with pytest.raises(HTTPException) as exc_info:
                await get_current_user(
                    request=mock_request,
                    Authorize=mock_authorize,
                    db_session=mock_db_session
                )
            
            assert exc_info.value.status_code == 401
            assert "Could not validate credentials" in exc_info.value.detail

    @pytest.mark.asyncio
    async def test_non_public_endpoint_authenticated(self, mock_user):
        """Test non_public_endpoint with authenticated user"""
        # Should not raise any exception
        await non_public_endpoint(mock_user)

    @pytest.mark.asyncio
    async def test_non_public_endpoint_anonymous(self):
        """Test non_public_endpoint with anonymous user"""
        anonymous_user = AnonymousUser()
        
        with pytest.raises(HTTPException) as exc_info:
            await non_public_endpoint(anonymous_user)
        
        assert exc_info.value.status_code == 401
        assert "Not authenticated" in exc_info.value.detail 


================================================
FILE: apps/api/src/tests/security/test_features_utils.py
================================================
import pytest
from unittest.mock import Mock, patch
from fastapi import HTTPException
from sqlmodel import Session
from src.security.features_utils.usage import (
    check_limits_with_usage,
    increase_feature_usage,
    decrease_feature_usage,
)
from src.db.organization_config import OrganizationConfig


class TestFeaturesUtils:
    """Test cases for features_utils/usage.py module"""

    @pytest.fixture
    def mock_db_session(self):
        """Create a mock database session"""
        return Mock(spec=Session)

    @pytest.fixture
    def mock_org_config(self):
        """Create a mock organization config"""
        config = Mock(spec=OrganizationConfig)
        config.org_id = 1
        config.config = {
            "features": {
                "ai": {"enabled": True, "limit": 100},
                "analytics": {"enabled": True, "limit": 50},
                "api": {"enabled": True, "limit": 0},  # Unlimited
                "assignments": {"enabled": True, "limit": 25},
                "collaboration": {"enabled": True, "limit": 10},
                "courses": {"enabled": True, "limit": 5},
                "discussions": {"enabled": True, "limit": 20},
                "members": {"enabled": True, "limit": 100},
                "payments": {"enabled": True, "limit": 0},  # Unlimited
                "storage": {"enabled": True, "limit": 1000},
                "usergroups": {"enabled": True, "limit": 15},
            }
        }
        return config

    @pytest.fixture
    def mock_redis(self):
        """Create a mock Redis connection"""
        redis_mock = Mock()
        redis_mock.get.return_value = b"5"  # Current usage
        redis_mock.set.return_value = True
        return redis_mock

    def test_feature_set_type_alias(self):
        """Test that FeatureSet type alias includes all expected features"""
        expected_features = [
            "ai", "analytics", "api", "assignments", "collaboration",
            "courses", "discussions", "members", "payments", "storage", "usergroups"
        ]
        
        # This test verifies that the FeatureSet type alias is properly defined
        # by checking that all expected features are valid
        for feature in expected_features:
            # Type checking is handled by the type system, so we just verify the features exist
            assert feature in ["ai", "analytics", "api", "assignments", "collaboration",
                             "courses", "discussions", "members", "payments", "storage", "usergroups"]

    @pytest.mark.asyncio
    async def test_check_limits_with_usage_success(self, mock_db_session, mock_org_config):
        """Test successful feature limit check"""
        with patch('src.security.features_utils.usage.get_learnhouse_config') as mock_config, \
             patch('redis.Redis.from_url') as mock_redis_class:
            
            # Mock config
            mock_config_instance = Mock()
            mock_config_instance.redis_config.redis_connection_string = "redis://localhost:6379"
            mock_config.return_value = mock_config_instance
            
            # Mock Redis
            mock_redis = Mock()
            mock_redis.get.return_value = b"5"  # Current usage
            mock_redis_class.return_value = mock_redis
            
            # Mock database query
            mock_db_session.exec.return_value.first.return_value = mock_org_config
            
            result = check_limits_with_usage(
                feature="ai",
                org_id=1,
                db_session=mock_db_session
            )
            
            assert result is True
            mock_redis.get.assert_called_once_with("ai_usage:1")

    @pytest.mark.asyncio
    async def test_check_limits_with_usage_feature_disabled(self, mock_db_session, mock_org_config):
        """Test feature limit check when feature is disabled"""
        # Disable the feature
        mock_org_config.config["features"]["ai"]["enabled"] = False
        
        # Mock database query
        mock_db_session.exec.return_value.first.return_value = mock_org_config
        
        with pytest.raises(HTTPException) as exc_info:
            check_limits_with_usage(
                feature="ai",
                org_id=1,
                db_session=mock_db_session
            )
        
        assert exc_info.value.status_code == 403
        assert "Ai is not enabled for this organization" in exc_info.value.detail

    @pytest.mark.asyncio
    async def test_check_limits_with_usage_no_org_config(self, mock_db_session):
        """Test feature limit check when organization has no config"""
        # Mock database query to return None
        mock_db_session.exec.return_value.first.return_value = None
        
        with pytest.raises(HTTPException) as exc_info:
            check_limits_with_usage(
                feature="ai",
                org_id=1,
                db_session=mock_db_session
            )
        
        assert exc_info.value.status_code == 404
        assert "Organization has no config" in exc_info.value.detail

    @pytest.mark.asyncio
    async def test_check_limits_with_usage_no_redis_connection(self, mock_db_session, mock_org_config):
        """Test feature limit check when Redis connection is not available"""
        with patch('src.security.features_utils.usage.get_learnhouse_config') as mock_config:
            # Mock config with no Redis connection
            mock_config_instance = Mock()
            mock_config_instance.redis_config.redis_connection_string = None
            mock_config.return_value = mock_config_instance
            
            # Mock database query
            mock_db_session.exec.return_value.first.return_value = mock_org_config
            
            with pytest.raises(HTTPException) as exc_info:
                check_limits_with_usage(
                    feature="ai",
                    org_id=1,
                    db_session=mock_db_session
                )
            
            assert exc_info.value.status_code == 500
            assert "Redis connection string not found" in exc_info.value.detail

    @pytest.mark.asyncio
    async def test_check_limits_with_usage_limit_reached(self, mock_db_session, mock_org_config):
        """Test feature limit check when limit is reached"""
        with patch('src.security.features_utils.usage.get_learnhouse_config') as mock_config, \
             patch('redis.Redis.from_url') as mock_redis_class:
            
            # Mock config
            mock_config_instance = Mock()
            mock_config_instance.redis_config.redis_connection_string = "redis://localhost:6379"
            mock_config.return_value = mock_config_instance
            
            # Mock Redis with usage at limit
            mock_redis = Mock()
            mock_redis.get.return_value = b"100"  # At limit
            mock_redis_class.return_value = mock_redis
            
            # Mock database query
            mock_db_session.exec.return_value.first.return_value = mock_org_config
            
            with pytest.raises(HTTPException) as exc_info:
                check_limits_with_usage(
                    feature="ai",
                    org_id=1,
                    db_session=mock_db_session
                )
            
            assert exc_info.value.status_code == 403
            assert "Usage Limit has been reached for Ai" in exc_info.value.detail

    @pytest.mark.asyncio
    async def test_check_limits_with_usage_unlimited_feature(self, mock_db_session, mock_org_config):
        """Test feature limit check for unlimited feature (limit = 0)"""
        with patch('src.security.features_utils.usage.get_learnhouse_config') as mock_config, \
             patch('redis.Redis.from_url') as mock_redis_class:
            
            # Mock config
            mock_config_instance = Mock()
            mock_config_instance.redis_config.redis_connection_string = "redis://localhost:6379"
            mock_config.return_value = mock_config_instance
            
            # Mock Redis
            mock_redis = Mock()
            mock_redis.get.return_value = b"1000"  # High usage
            mock_redis_class.return_value = mock_redis
            
            # Mock database query
            mock_db_session.exec.return_value.first.return_value = mock_org_config
            
            result = check_limits_with_usage(
                feature="api",  # Unlimited feature
                org_id=1,
                db_session=mock_db_session
            )
            
            # For unlimited features (limit=0), the function returns True or None
            assert result is True or result is None

    @pytest.mark.asyncio
    async def test_check_limits_with_usage_no_previous_usage(self, mock_db_session, mock_org_config):
        """Test feature limit check when no previous usage exists"""
        with patch('src.security.features_utils.usage.get_learnhouse_config') as mock_config, \
             patch('redis.Redis.from_url') as mock_redis_class:
            
            # Mock config
            mock_config_instance = Mock()
            mock_config_instance.redis_config.redis_connection_string = "redis://localhost:6379"
            mock_config.return_value = mock_config_instance
            
            # Mock Redis with no previous usage
            mock_redis = Mock()
            mock_redis.get.return_value = None
            mock_redis_class.return_value = mock_redis
            
            # Mock database query
            mock_db_session.exec.return_value.first.return_value = mock_org_config
            
            result = check_limits_with_usage(
                feature="ai",
                org_id=1,
                db_session=mock_db_session
            )
            
            assert result is True

    @pytest.mark.asyncio
    async def test_increase_feature_usage_success(self, mock_db_session):
        """Test successful feature usage increase"""
        with patch('src.security.features_utils.usage.get_learnhouse_config') as mock_config, \
             patch('redis.Redis.from_url') as mock_redis_class:
            
            # Mock config
            mock_config_instance = Mock()
            mock_config_instance.redis_config.redis_connection_string = "redis://localhost:6379"
            mock_config.return_value = mock_config_instance
            
            # Mock Redis
            mock_redis = Mock()
            mock_redis.get.return_value = b"5"  # Current usage
            mock_redis.set.return_value = True
            mock_redis_class.return_value = mock_redis
            
            result = increase_feature_usage(
                feature="ai",
                org_id=1,
                db_session=mock_db_session
            )
            
            assert result is True
            mock_redis.get.assert_called_once_with("ai_usage:1")
            mock_redis.set.assert_called_once_with("ai_usage:1", 6)

    @pytest.mark.asyncio
    async def test_increase_feature_usage_no_previous_usage(self, mock_db_session):
        """Test feature usage increase when no previous usage exists"""
        with patch('src.security.features_utils.usage.get_learnhouse_config') as mock_config, \
             patch('redis.Redis.from_url') as mock_redis_class:
            
            # Mock config
            mock_config_instance = Mock()
            mock_config_instance.redis_config.redis_connection_string = "redis://localhost:6379"
            mock_config.return_value = mock_config_instance
            
            # Mock Redis with no previous usage
            mock_redis = Mock()
            mock_redis.get.return_value = None
            mock_redis.set.return_value = True
            mock_redis_class.return_value = mock_redis
            
            result = increase_feature_usage(
                feature="ai",
                org_id=1,
                db_session=mock_db_session
            )
            
            assert result is True
            mock_redis.set.assert_called_once_with("ai_usage:1", 1)

    @pytest.mark.asyncio
    async def test_decrease_feature_usage_success(self, mock_db_session):
        """Test successful feature usage decrease"""
        with patch('src.security.features_utils.usage.get_learnhouse_config') as mock_config, \
             patch('redis.Redis.from_url') as mock_redis_class:
            
            # Mock config
            mock_config_instance = Mock()
            mock_config_instance.redis_config.redis_connection_string = "redis://localhost:6379"
            mock_config.return_value = mock_config_instance
            
            # Mock Redis
            mock_redis = Mock()
            mock_redis.get.return_value = b"5"  # Current usage
            mock_redis.set.return_value = True
            mock_redis_class.return_value = mock_redis
            
            result = decrease_feature_usage(
                feature="ai",
                org_id=1,
                db_session=mock_db_session
            )
            
            assert result is True
            mock_redis.get.assert_called_once_with("ai_usage:1")
            mock_redis.set.assert_called_once_with("ai_usage:1", 4)

    @pytest.mark.asyncio
    async def test_decrease_feature_usage_no_previous_usage(self, mock_db_session):
        """Test feature usage decrease when no previous usage exists"""
        with patch('src.security.features_utils.usage.get_learnhouse_config') as mock_config, \
             patch('redis.Redis.from_url') as mock_redis_class:
            
            # Mock config
            mock_config_instance = Mock()
            mock_config_instance.redis_config.redis_connection_string = "redis://localhost:6379"
            mock_config.return_value = mock_config_instance
            
            # Mock Redis with no previous usage
            mock_redis = Mock()
            mock_redis.get.return_value = None
            mock_redis.set.return_value = True
            mock_redis_class.return_value = mock_redis
            
            result = decrease_feature_usage(
                feature="ai",
                org_id=1,
                db_session=mock_db_session
            )
            
            assert result is True
            mock_redis.set.assert_called_once_with("ai_usage:1", -1)

    @pytest.mark.asyncio
    async def test_all_features_covered(self, mock_db_session, mock_org_config):
        """Test that all features in FeatureSet are covered"""
        features = [
            "ai", "analytics", "api", "assignments", "collaboration",
            "courses", "discussions", "members", "payments", "storage", "usergroups"
        ]
        
        with patch('src.security.features_utils.usage.get_learnhouse_config') as mock_config, \
             patch('redis.Redis.from_url') as mock_redis_class:
            
            # Mock config
            mock_config_instance = Mock()
            mock_config_instance.redis_config.redis_connection_string = "redis://localhost:6379"
            mock_config.return_value = mock_config_instance
            
            # Mock Redis
            mock_redis = Mock()
            mock_redis.get.return_value = b"0"  # No usage
            mock_redis.set.return_value = True
            mock_redis_class.return_value = mock_redis
            
            # Mock database query
            mock_db_session.exec.return_value.first.return_value = mock_org_config
            
            for feature in features:
                # Test that each feature can be processed without errors
                result = check_limits_with_usage(
                    feature=feature,  # type: ignore
                    org_id=1,
                    db_session=mock_db_session
                )
                # For enabled features, result should be True or None (for unlimited)
                assert result is True or result is None 


================================================
FILE: apps/api/src/tests/security/test_rbac.py
================================================
import pytest
from unittest.mock import Mock, AsyncMock, patch
from fastapi import HTTPException, Request
from sqlmodel import Session
from src.security.rbac.rbac import (
    authorization_verify_if_element_is_public,
    authorization_verify_if_user_is_author,
    authorization_verify_based_on_roles,
    authorization_verify_based_on_org_admin_status,
    authorization_verify_based_on_roles_and_authorship,
    authorization_verify_if_user_is_anon,
)
from src.db.courses.courses import Course
from src.db.collections import Collection
from src.db.resource_authors import ResourceAuthor, ResourceAuthorshipEnum, ResourceAuthorshipStatusEnum
from src.db.roles import Role


class TestRBAC:
    """Test cases for RBAC module"""

    @pytest.fixture
    def mock_request(self):
        """Create a mock request object"""
        return Mock(spec=Request)

    @pytest.fixture
    def mock_db_session(self):
        """Create a mock database session"""
        return Mock(spec=Session)

    @pytest.fixture
    def mock_course(self):
        """Create a mock course object"""
        course = Mock(spec=Course)
        course.course_uuid = "course_123"
        course.public = True
        return course

    @pytest.fixture
    def mock_collection(self):
        """Create a mock collection object"""
        collection = Mock(spec=Collection)
        collection.collection_uuid = "collection_123"
        collection.public = True
        return collection

    @pytest.fixture
    def mock_resource_author(self):
        """Create a mock resource author object"""
        author = Mock(spec=ResourceAuthor)
        author.user_id = 1
        author.authorship = ResourceAuthorshipEnum.CREATOR
        author.authorship_status = ResourceAuthorshipStatusEnum.ACTIVE
        return author

    @pytest.fixture
    def mock_role(self):
        """Create a mock role object"""
        from src.db.roles import RoleTypeEnum, Rights, PermissionsWithOwn, Permission, DashboardPermission
        role = Mock(spec=Role)
        role.id = 1
        role.org_id = 1
        role.name = "Test Role"
        role.description = "A test role."
        # Rights should be a Rights object with proper Permission objects
        role.rights = Rights(
            courses=PermissionsWithOwn(
                action_create=False,
                action_read=True,
                action_read_own=False,
                action_update=False,
                action_update_own=False,
                action_delete=False,
                action_delete_own=False,
            ),
            users=Permission(
                action_create=False,
                action_read=True,
                action_update=False,
                action_delete=False,
            ),
            usergroups=Permission(
                action_create=False,
                action_read=True,
                action_update=False,
                action_delete=False,
            ),
            collections=Permission(
                action_create=False,
                action_read=True,
                action_update=False,
                action_delete=False,
            ),
            organizations=Permission(
                action_create=False,
                action_read=True,
                action_update=False,
                action_delete=False,
            ),
            coursechapters=Permission(
                action_create=False,
                action_read=True,
                action_update=False,
                action_delete=False,
            ),
            activities=Permission(
                action_create=False,
                action_read=True,
                action_update=False,
                action_delete=False,
            ),
            roles=Permission(
                action_create=False,
                action_read=True,
                action_update=False,
                action_delete=False,
            ),
            dashboard=DashboardPermission(
                action_access=True,
            )
        )
        role.role_type = RoleTypeEnum.TYPE_GLOBAL
        role.role_uuid = "role_test"
        role.creation_date = "2024-01-01T00:00:00"
        role.update_date = "2024-01-01T00:00:00"
        return role

    @pytest.mark.asyncio
    async def test_authorization_verify_if_element_is_public_course_success(self, mock_request, mock_db_session, mock_course):
        """Test public course authorization success"""
        with patch('src.security.rbac.rbac.check_element_type', new_callable=AsyncMock) as mock_check_type:
            mock_check_type.return_value = "courses"
            
            # Mock database query
            mock_db_session.exec.return_value.first.return_value = mock_course
            
            result = await authorization_verify_if_element_is_public(
                request=mock_request,
                element_uuid="course_123",
                action="read",
                db_session=mock_db_session
            )
            
            assert result is True

    @pytest.mark.asyncio
    async def test_authorization_verify_if_element_is_public_course_not_public(self, mock_request, mock_db_session):
        """Test public course authorization failure when course is not public"""
        with patch('src.security.rbac.rbac.check_element_type', new_callable=AsyncMock) as mock_check_type:
            mock_check_type.return_value = "courses"
            
            # Mock database query to return None (course not found or not public)
            mock_db_session.exec.return_value.first.return_value = None
            
            with pytest.raises(HTTPException) as exc_info:
                await authorization_verify_if_element_is_public(
                    request=mock_request,
                    element_uuid="course_123",
                    action="read",
                    db_session=mock_db_session
                )
            
            assert exc_info.value.status_code == 403
            assert "You don't have the right to perform this action" in exc_info.value.detail

    @pytest.mark.asyncio
    async def test_authorization_verify_if_element_is_public_collection_success(self, mock_request, mock_db_session, mock_collection):
        """Test public collection authorization success"""
        with patch('src.security.rbac.rbac.check_element_type', new_callable=AsyncMock) as mock_check_type:
            mock_check_type.return_value = "collections"
            
            # Mock database query
            mock_db_session.exec.return_value.first.return_value = mock_collection
            
            result = await authorization_verify_if_element_is_public(
                request=mock_request,
                element_uuid="collection_123",
                action="read",
                db_session=mock_db_session
            )
            
            assert result is True

    @pytest.mark.asyncio
    async def test_authorization_verify_if_element_is_public_unsupported_element_type(self, mock_request, mock_db_session):
        """Test public element authorization with unsupported element type"""
        with patch('src.security.rbac.rbac.check_element_type', new_callable=AsyncMock) as mock_check_type:
            mock_check_type.return_value = "users"  # Unsupported element type
            
            with pytest.raises(HTTPException) as exc_info:
                await authorization_verify_if_element_is_public(
                    request=mock_request,
                    element_uuid="user_123",
                    action="read",
                    db_session=mock_db_session
                )
            
            assert exc_info.value.status_code == 403
            assert "You don't have the right to perform this action" in exc_info.value.detail

    @pytest.mark.asyncio
    async def test_authorization_verify_if_user_is_author_create_action(self, mock_request, mock_db_session):
        """Test author verification for create action"""
        result = await authorization_verify_if_user_is_author(
            request=mock_request,
            user_id=1,
            action="create",
            element_uuid="course_123",
            db_session=mock_db_session
        )
        
        assert result is True

    @pytest.mark.asyncio
    async def test_authorization_verify_if_user_is_author_success(self, mock_request, mock_db_session, mock_resource_author):
        """Test author verification success"""
        with patch('src.security.rbac.rbac.check_element_type', new_callable=AsyncMock):
            # Mock database query
            mock_db_session.exec.return_value.first.return_value = mock_resource_author
            
            result = await authorization_verify_if_user_is_author(
                request=mock_request,
                user_id=1,
                action="read",
                element_uuid="course_123",
                db_session=mock_db_session
            )
            
            assert result is True

    @pytest.mark.asyncio
    async def test_authorization_verify_if_user_is_author_wrong_user(self, mock_request, mock_db_session, mock_resource_author):
        """Test author verification with wrong user"""
        with patch('src.security.rbac.rbac.check_element_type', new_callable=AsyncMock):
            # Mock database query
            mock_db_session.exec.return_value.first.return_value = mock_resource_author
            
            result = await authorization_verify_if_user_is_author(
                request=mock_request,
                user_id=2,  # Different user
                action="read",
                element_uuid="course_123",
                db_session=mock_db_session
            )
            
            assert result is False

    @pytest.mark.asyncio
    async def test_authorization_verify_if_user_is_author_no_resource_author(self, mock_request, mock_db_session):
        """Test author verification when no resource author exists"""
        with patch('src.security.rbac.rbac.check_element_type', new_callable=AsyncMock):
            # Mock database query to return None
            mock_db_session.exec.return_value.first.return_value = None
            
            result = await authorization_verify_if_user_is_author(
                request=mock_request,
                user_id=1,
                action="read",
                element_uuid="course_123",
                db_session=mock_db_session
            )
            
            assert result is False

    @pytest.mark.asyncio
    async def test_authorization_verify_based_on_roles_success(self, mock_request, mock_db_session, mock_role):
        """Test role-based authorization success"""
        with patch('src.security.rbac.rbac.check_element_type', new_callable=AsyncMock) as mock_check_type:
            mock_check_type.return_value = "courses"
            
            # Mock database query
            mock_db_session.exec.return_value.all.return_value = [mock_role]
            
            result = await authorization_verify_based_on_roles(
                request=mock_request,
                user_id=1,
                action="read",
                element_uuid="course_123",
                db_session=mock_db_session
            )
            
            assert result is True

    @pytest.mark.asyncio
    async def test_authorization_verify_based_on_roles_no_permission(self, mock_request, mock_db_session, mock_role):
        """Test role-based authorization failure"""
        with patch('src.security.rbac.rbac.check_element_type', new_callable=AsyncMock) as mock_check_type:
            mock_check_type.return_value = "courses"
            
            # Mock role without permission
            mock_role.rights.courses.action_read = False
            
            # Mock database query
            mock_db_session.exec.return_value.all.return_value = [mock_role]
            
            result = await authorization_verify_based_on_roles(
                request=mock_request,
                user_id=1,
                action="read",
                element_uuid="course_123",
                db_session=mock_db_session
            )
            
            assert result is False

    @pytest.mark.asyncio
    async def test_authorization_verify_based_on_org_admin_status_success(self, mock_request, mock_db_session):
        """Test org admin status verification success"""
        with patch('src.security.rbac.rbac.check_element_type', new_callable=AsyncMock):
            # Mock admin role
            from src.db.roles import RoleTypeEnum
            admin_role = Mock(spec=Role)
            admin_role.id = 1  # Admin role ID
            admin_role.org_id = 1
            admin_role.name = "Admin Role"
            admin_role.description = "An admin role."
            admin_role.rights = {}
            admin_role.role_type = RoleTypeEnum.TYPE_GLOBAL
            admin_role.role_uuid = "role_admin"
            admin_role.creation_date = "2024-01-01T00:00:00"
            admin_role.update_date = "2024-01-01T00:00:00"
            
            # Mock database query
            mock_db_session.exec.return_value.all.return_value = [admin_role]
            
            result = await authorization_verify_based_on_org_admin_status(
                request=mock_request,
                user_id=1,
                action="read",
                element_uuid="course_123",
                db_session=mock_db_session
            )
            
            assert result is True

    @pytest.mark.asyncio
    async def test_authorization_verify_based_on_org_admin_status_no_admin(self, mock_request, mock_db_session):
        """Test org admin status verification failure"""
        with patch('src.security.rbac.rbac.check_element_type', new_callable=AsyncMock):
            # Mock non-admin role
            from src.db.roles import RoleTypeEnum
            regular_role = Mock(spec=Role)
            regular_role.id = 3  # Non-admin role ID
            regular_role.org_id = 1
            regular_role.name = "Regular Role"
            regular_role.description = "A regular role."
            regular_role.rights = {}
            regular_role.role_type = RoleTypeEnum.TYPE_GLOBAL
            regular_role.role_uuid = "role_regular"
            regular_role.creation_date = "2024-01-01T00:00:00"
            regular_role.update_date = "2024-01-01T00:00:00"
            
            # Mock database query
            mock_db_session.exec.return_value.all.return_value = [regular_role]
            
            result = await authorization_verify_based_on_org_admin_status(
                request=mock_request,
                user_id=1,
                action="read",
                element_uuid="course_123",
                db_session=mock_db_session
            )
            
            assert result is False

    @pytest.mark.asyncio
    async def test_authorization_verify_based_on_roles_and_authorship_success(self, mock_request, mock_db_session, mock_resource_author):
        """Test combined roles and authorship authorization success"""
        with patch('src.security.rbac.rbac.authorization_verify_if_user_is_author', new_callable=AsyncMock) as mock_author, \
             patch('src.security.rbac.rbac.authorization_verify_based_on_roles', new_callable=AsyncMock) as mock_roles:
            
            mock_author.return_value = True
            mock_roles.return_value = False
            
            result = await authorization_verify_based_on_roles_and_authorship(
                request=mock_request,
                user_id=1,
                action="read",
                element_uuid="course_123",
                db_session=mock_db_session
            )
            
            assert result is True

    @pytest.mark.asyncio
    async def test_authorization_verify_based_on_roles_and_authorship_failure(self, mock_request, mock_db_session):
        """Test combined roles and authorship authorization failure"""
        with patch('src.security.rbac.rbac.authorization_verify_if_user_is_author', new_callable=AsyncMock) as mock_author, \
             patch('src.security.rbac.rbac.authorization_verify_based_on_roles', new_callable=AsyncMock) as mock_roles:
            
            mock_author.return_value = False
            mock_roles.return_value = False
            
            with pytest.raises(HTTPException) as exc_info:
                await authorization_verify_based_on_roles_and_authorship(
                    request=mock_request,
                    user_id=1,
                    action="read",
                    element_uuid="course_123",
                    db_session=mock_db_session
                )
            
            assert exc_info.value.status_code == 403
            assert "User rights (roles & authorship)" in exc_info.value.detail

    @pytest.mark.asyncio
    async def test_authorization_verify_if_user_is_anon_anonymous_user(self):
        """Test anonymous user verification"""
        with pytest.raises(HTTPException) as exc_info:
            await authorization_verify_if_user_is_anon(user_id=0)
        
        assert exc_info.value.status_code == 403
        assert "You should be logged in to perform this action" in exc_info.value.detail

    @pytest.mark.asyncio
    async def test_authorization_verify_if_user_is_anon_authenticated_user(self):
        """Test authenticated user verification"""
        # Should not raise any exception
        await authorization_verify_if_user_is_anon(user_id=1) 


================================================
FILE: apps/api/src/tests/security/test_rbac_utils.py
================================================
import pytest
from fastapi import HTTPException
from src.security.rbac.utils import (
    check_element_type,
    get_singular_form_of_element,
    get_id_identifier_of_element,
)


class TestRBACUtils:
    """Test cases for RBAC utils module"""

    @pytest.mark.asyncio
    async def test_check_element_type_course(self):
        """Test element type checking for course"""
        result = await check_element_type("course_123")
        assert result == "courses"

    @pytest.mark.asyncio
    async def test_check_element_type_course_update(self):
        """Test element type checking for course update"""
        result = await check_element_type("courseupdate_123")
        assert result == "courses"

    @pytest.mark.asyncio
    async def test_check_element_type_user(self):
        """Test element type checking for user"""
        result = await check_element_type("user_123")
        assert result == "users"

    @pytest.mark.asyncio
    async def test_check_element_type_usergroup(self):
        """Test element type checking for usergroup"""
        result = await check_element_type("usergroup_123")
        assert result == "usergroups"

    @pytest.mark.asyncio
    async def test_check_element_type_house(self):
        """Test element type checking for house"""
        result = await check_element_type("house_123")
        assert result == "houses"

    @pytest.mark.asyncio
    async def test_check_element_type_org(self):
        """Test element type checking for organization"""
        result = await check_element_type("org_123")
        assert result == "organizations"

    @pytest.mark.asyncio
    async def test_check_element_type_chapter(self):
        """Test element type checking for chapter"""
        result = await check_element_type("chapter_123")
        assert result == "coursechapters"

    @pytest.mark.asyncio
    async def test_check_element_type_collection(self):
        """Test element type checking for collection"""
        result = await check_element_type("collection_123")
        assert result == "collections"

    @pytest.mark.asyncio
    async def test_check_element_type_activity(self):
        """Test element type checking for activity"""
        result = await check_element_type("activity_123")
        assert result == "activities"

    @pytest.mark.asyncio
    async def test_check_element_type_role(self):
        """Test element type checking for role"""
        result = await check_element_type("role_123")
        assert result == "roles"

    @pytest.mark.asyncio
    async def test_check_element_type_unknown(self):
        """Test element type checking for unknown element"""
        with pytest.raises(HTTPException) as exc_info:
            await check_element_type("unknown_123")
        
        assert exc_info.value.status_code == 409
        assert "Issue verifying element nature" in exc_info.value.detail

    @pytest.mark.asyncio
    async def test_check_element_type_empty_uuid(self):
        """Test element type checking for empty UUID"""
        with pytest.raises(HTTPException) as exc_info:
            await check_element_type("")
        
        assert exc_info.value.status_code == 409
        assert "Issue verifying element nature" in exc_info.value.detail

    @pytest.mark.asyncio
    async def test_get_singular_form_of_element_activity(self):
        """Test getting singular form for activity"""
        result = await get_singular_form_of_element("activity_123")
        assert result == "activity"

    @pytest.mark.asyncio
    async def test_get_singular_form_of_element_course(self):
        """Test getting singular form for course"""
        result = await get_singular_form_of_element("course_123")
        assert result == "course"

    @pytest.mark.asyncio
    async def test_get_singular_form_of_element_user(self):
        """Test getting singular form for user"""
        result = await get_singular_form_of_element("user_123")
        assert result == "user"

    @pytest.mark.asyncio
    async def test_get_singular_form_of_element_collection(self):
        """Test getting singular form for collection"""
        result = await get_singular_form_of_element("collection_123")
        assert result == "collection"

    @pytest.mark.asyncio
    async def test_get_singular_form_of_element_organization(self):
        """Test getting singular form for organization"""
        result = await get_singular_form_of_element("org_123")
        assert result == "organization"

    @pytest.mark.asyncio
    async def test_get_id_identifier_of_element_activity(self):
        """Test getting ID identifier for activity"""
        result = await get_id_identifier_of_element("activity_123")
        assert result == "activity_id"

    @pytest.mark.asyncio
    async def test_get_id_identifier_of_element_course(self):
        """Test getting ID identifier for course"""
        result = await get_id_identifier_of_element("course_123")
        assert result == "course_id"

    @pytest.mark.asyncio
    async def test_get_id_identifier_of_element_user(self):
        """Test getting ID identifier for user"""
        result = await get_id_identifier_of_element("user_123")
        assert result == "user_id"

    @pytest.mark.asyncio
    async def test_get_id_identifier_of_element_organization(self):
        """Test getting ID identifier for organization"""
        result = await get_id_identifier_of_element("org_123")
        assert result == "org_id"

    @pytest.mark.asyncio
    async def test_get_id_identifier_of_element_collection(self):
        """Test getting ID identifier for collection"""
        result = await get_id_identifier_of_element("collection_123")
        assert result == "collection_id"

    @pytest.mark.asyncio
    async def test_element_type_consistency(self):
        """Test consistency between element type checking and singular form"""
        test_cases = [
            ("course_123", "courses", "course"),
            ("user_123", "users", "user"),
            ("collection_123", "collections", "collection"),
            ("activity_123", "activities", "activity"),
            ("org_123", "organizations", "organization"),
        ]
        
        for uuid, expected_plural, expected_singular in test_cases:
            element_type = await check_element_type(uuid)
            singular_form = await get_singular_form_of_element(uuid)
            
            assert element_type == expected_plural
            assert singular_form == expected_singular

    @pytest.mark.asyncio
    async def test_id_identifier_consistency(self):
        """Test consistency between singular form and ID identifier"""
        test_cases = [
            ("course_123", "course_id"),
            ("user_123", "user_id"),
            ("collection_123", "collection_id"),
            ("activity_123", "activity_id"),
            ("org_123", "org_id"),
        ]
        
        for uuid, expected_id_identifier in test_cases:
            id_identifier = await get_id_identifier_of_element(uuid)
            assert id_identifier == expected_id_identifier

    @pytest.mark.asyncio
    async def test_edge_cases_with_underscores(self):
        """Test edge cases with multiple underscores"""
        # Test with multiple underscores
        result = await check_element_type("course_123_456")
        assert result == "courses"
        
        result = await get_singular_form_of_element("course_123_456")
        assert result == "course"
        
        result = await get_id_identifier_of_element("course_123_456")
        assert result == "course_id"

    @pytest.mark.asyncio
    async def test_edge_cases_with_numbers_only(self):
        """Test edge cases with numbers only after prefix"""
        result = await check_element_type("course_123456")
        assert result == "courses"
        
        result = await get_singular_form_of_element("course_123456")
        assert result == "course"
        
        result = await get_id_identifier_of_element("course_123456")
        assert result == "course_id" 


================================================
FILE: apps/api/src/tests/security/test_security.py
================================================
from src.security.security import (
    security_hash_password,
    security_verify_password,
    ACCESS_TOKEN_EXPIRE_MINUTES,
    SECRET_KEY,
    ALGORITHM,
)


class TestSecurity:
    """Test cases for security.py module"""

    def test_security_hash_password(self):
        """Test password hashing functionality"""
        password = "test_password_123"
        hashed = security_hash_password(password)
        
        # Verify the hash is different from original password
        assert hashed != password
        # Verify the hash is a string
        assert isinstance(hashed, str)
        # Verify the hash is not empty
        assert len(hashed) > 0

    def test_security_verify_password_correct(self):
        """Test password verification with correct password"""
        password = "test_password_123"
        hashed = security_hash_password(password)
        
        # Verify correct password returns True
        assert security_verify_password(password, hashed) is True

    def test_security_verify_password_incorrect(self):
        """Test password verification with incorrect password"""
        password = "test_password_123"
        wrong_password = "wrong_password_456"
        hashed = security_hash_password(password)
        
        # Verify incorrect password returns False
        assert security_verify_password(wrong_password, hashed) is False

    def test_security_verify_password_empty_password(self):
        """Test password verification with empty password"""
        password = "test_password_123"
        hashed = security_hash_password(password)
        
        # Verify empty password returns False
        assert security_verify_password("", hashed) is False

    def test_security_verify_password_empty_string(self):
        """Test password verification with empty string"""
        password = "test_password_123"
        hashed = security_hash_password(password)
        
        # Verify empty string returns False
        assert security_verify_password("", hashed) is False

    def test_jwt_constants(self):
        """Test JWT constants are properly set"""
        # Verify constants are set
        assert ACCESS_TOKEN_EXPIRE_MINUTES == 30
        assert ALGORITHM == "HS256"
        assert SECRET_KEY is not None
        assert isinstance(SECRET_KEY, str)
        assert len(SECRET_KEY) > 0

    def test_password_hashing_consistency(self):
        """Test that password hashing produces consistent results"""
        password = "consistent_test_password"
        hashed1 = security_hash_password(password)
        hashed2 = security_hash_password(password)
        
        # Each hash should be different (due to salt)
        assert hashed1 != hashed2
        
        # But both should verify correctly
        assert security_verify_password(password, hashed1) is True
        assert security_verify_password(password, hashed2) is True

    def test_special_characters_in_password(self):
        """Test password hashing with special characters"""
        password = "!@#$%^&*()_+-=[]{}|;':\",./<>?"
        hashed = security_hash_password(password)
        
        assert security_verify_password(password, hashed) is True
        assert security_verify_password("wrong", hashed) is False

    def test_unicode_characters_in_password(self):
        """Test password hashing with unicode characters"""
        password = "æµ‹è¯•å¯†ç 123ğŸš€ğŸŒŸ"
        hashed = security_hash_password(password)
        
        assert security_verify_password(password, hashed) is True
        assert security_verify_password("wrong", hashed) is False

    def test_very_long_password(self):
        """Test password hashing with very long password"""
        password = "a" * 1000
        hashed = security_hash_password(password)
        
        assert security_verify_password(password, hashed) is True
        assert security_verify_password("wrong", hashed) is False 


================================================
FILE: apps/api/src/tests/security/test_security_all.py
================================================
"""
Comprehensive test suite for the security module.

This file imports and runs all security-related tests to ensure complete coverage
of the security functionality including:
- Password hashing and verification
- JWT authentication
- Role-based access control (RBAC)
- Feature usage tracking
- Authorization utilities
"""

from src.tests.security.test_security import TestSecurity
from src.tests.security.test_auth import TestAuth
from src.tests.security.test_rbac import TestRBAC
from src.tests.security.test_rbac_utils import TestRBACUtils
from src.tests.security.test_features_utils import TestFeaturesUtils


class TestSecurityComprehensive:
    """Comprehensive test suite for all security functionality"""
    
    def test_security_module_imports(self):
        """Test that all security modules can be imported successfully"""
        # Test core security imports
        
        # Test auth imports
        
        # Test RBAC imports
        
        # Test RBAC utils imports
        
        # Test features utils imports
        
        # Verify all imports succeeded
        assert True

    def test_security_constants(self):
        """Test that security constants are properly defined"""
        from src.security.security import ACCESS_TOKEN_EXPIRE_MINUTES, ALGORITHM, SECRET_KEY
        
        assert ACCESS_TOKEN_EXPIRE_MINUTES == 30
        assert ALGORITHM == "HS256"
        assert SECRET_KEY is not None
        assert isinstance(SECRET_KEY, str)
        assert len(SECRET_KEY) > 0

    def test_feature_set_definition(self):
        """Test that FeatureSet includes all expected features"""
        
        expected_features = [
            "ai", "analytics", "api", "assignments", "collaboration",
            "courses", "discussions", "members", "payments", "storage", "usergroups"
        ]
        
        # Verify all expected features are included in the type definition
        for feature in expected_features:
            assert feature in ["ai", "analytics", "api", "assignments", "collaboration",
                             "courses", "discussions", "members", "payments", "storage", "usergroups"]

    def test_security_module_structure(self):
        """Test that the security module has the expected structure"""
        import src.security
        import src.security.auth
        import src.security.security
        import src.security.rbac
        import src.security.rbac.rbac
        import src.security.rbac.utils
        import src.security.features_utils
        import src.security.features_utils.usage
        
        # Verify all modules can be imported
        assert src.security is not None
        assert src.security.auth is not None
        assert src.security.security is not None
        assert src.security.rbac is not None
        assert src.security.rbac.rbac is not None
        assert src.security.rbac.utils is not None
        assert src.security.features_utils is not None
        assert src.security.features_utils.usage is not None


# Test discovery helpers
def get_security_test_classes():
    """Get all security test classes for discovery"""
    return [
        TestSecurity,
        TestAuth,
        TestRBAC,
        TestRBACUtils,
        TestFeaturesUtils,
        TestSecurityComprehensive,
    ]


def run_security_tests():
    """Run all security tests"""
    test_classes = get_security_test_classes()
    
    for test_class in test_classes:
        print(f"Running tests for {test_class.__name__}")
        # In a real implementation, this would run the tests
        # For now, we just verify the class exists
        assert test_class is not None
        assert hasattr(test_class, '__name__')


if __name__ == "__main__":
    run_security_tests() 


================================================
FILE: apps/api/src/tests/utils/__init__.py
================================================
[Empty file]


================================================
FILE: apps/api/src/tests/utils/init_data_for_tests.py
================================================
from sqlmodel import Session, select
from pydantic import EmailStr
from src.db.user_organizations import UserOrganization
from src.db.organizations import OrganizationCreate
from src.db.users import User, UserCreate
from src.services.setup.setup import (
    install_create_organization,
    install_create_organization_user,
    install_default_elements,
)

# TODO: Depreceated and need to be removed and remade
async def create_initial_data_for_tests(db_session: Session):
    # Install default elements
    install_default_elements(db_session)

    # Initiate test Organization
    test_org = OrganizationCreate(
        name="Wayne Enterprises",
        description=None,
        about=None,
        slug="wayne",
        email="hello@wayne.dev",
        logo_image=None,
        thumbnail_image=None,
        label=None,
    )

    # Create test organization
    install_create_organization(test_org, db_session)

    users = [
        UserCreate(
            username="batman",
            first_name="Bruce",
            last_name="Wayne",
            email=EmailStr("bruce@wayne.com"),
            password="imbatman",
        ),
        UserCreate(
            username="robin",
            first_name="Richard John",
            last_name="Grayson",
            email=EmailStr("robin@wayne.com"),
            password="secret",
        ),
    ]

    # Create 2 users in that Organization
    for user in users:
        install_create_organization_user(user, "wayne", db_session)

    # Make robin a normal user
    statement = select(UserOrganization).join(User).where(User.username == "robin")
    user_org = db_session.exec(statement).first()

    user_org.role_id = 3 # type: ignore
    db_session.add(user_org)
    db_session.commit()

    return True



================================================
FILE: apps/web/README.md
================================================
[Empty file]


================================================
FILE: apps/web/components.json
================================================
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.js",
    "css": "styles/globals.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "iconLibrary": "lucide"
}


================================================
FILE: apps/web/docker-entrypoint.sh
================================================
#!/bin/sh
set -e

# Frontend entrypoint script
# This script starts the Next.js server with runtime environment variable injection

# Validate required environment variables (optional - can be set with defaults)
# NEXT_PUBLIC_* variables are injected at runtime by server-wrapper.js

# Set defaults if not provided
export HOSTNAME="${HOSTNAME:-0.0.0.0}"
export PORT="${PORT:-3000}"

# Start the Next.js server using the wrapper script
# The wrapper will inject NEXT_PUBLIC_* env vars before starting
# Using 'env' ensures all Kubernetes-injected environment variables are passed through
exec env node server-wrapper.js




================================================
FILE: apps/web/Dockerfile
================================================
FROM node:22-alpine AS base

# Install dependencies only when needed
FROM base AS deps
# Check https://github.com/nodejs/docker-node/tree/b4117f9333da4138b03a546ec926ef50a31506c3#nodealpine to understand why libc6-compat might be needed.
RUN apk update && apk add --no-cache libc6-compat && rm -rf /var/cache/apk/*
WORKDIR /app

# Install dependencies based on the preferred package manager
COPY package.json yarn.lock* package-lock.json* pnpm-lock.yaml* ./
RUN \
  if [ -f pnpm-lock.yaml ]; then corepack enable pnpm && pnpm i --frozen-lockfile; \
  else echo "Lockfile not found." && exit 1; \
  fi


# Rebuild the source code only when needed
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# Next.js collects completely anonymous telemetry data about general usage.
# Learn more here: https://nextjs.org/telemetry
# Uncomment the following line in case you want to disable telemetry during the build.
# ENV NEXT_TELEMETRY_DISABLED 1

# Remove .env files from the final image
# This is a good practice to avoid leaking sensitive data
# Learn more about it in the Next.js documentation: https://nextjs.org/docs/basic-features/environment-variables
RUN rm -f .env*

RUN \
  if [ -f pnpm-lock.yaml ]; then corepack enable pnpm && pnpm run build; \
  else echo "Lockfile not found." && exit 1; \
  fi

# Production image, copy all the files and run next
FROM base AS runner
WORKDIR /app

# Install curl for health checks
RUN apk update && apk add --no-cache curl && rm -rf /var/cache/apk/*

ENV NODE_ENV production
# Uncomment the following line in case you want to disable telemetry during runtime.
ENV NEXT_TELEMETRY_DISABLED 1

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public

# Set the correct permission for prerender cache
RUN mkdir .next
RUN chown nextjs:nodejs .next

# Automatically leverage output traces to reduce image size
# https://nextjs.org/docs/advanced-features/output-file-tracing
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

# Copy server wrapper for runtime environment variable injection
COPY --chown=nextjs:nodejs server-wrapper.js ./
RUN chmod +x server-wrapper.js

# Copy entrypoint script
COPY --chown=nextjs:nodejs docker-entrypoint.sh ./
RUN chmod +x docker-entrypoint.sh

# Create runtime-config.json placeholder (will be generated at startup)
RUN touch runtime-config.json && chown nextjs:nodejs runtime-config.json

USER nextjs

EXPOSE 3000

ENV PORT 3000

# Use entrypoint script which will start the server with runtime env vars
ENTRYPOINT ["./docker-entrypoint.sh"]


================================================
FILE: apps/web/eslint.config.mjs
================================================
import unusedImports from "eslint-plugin-unused-imports";
import nextConfig from "eslint-config-next";
import js from "@eslint/js";

export default [
    js.configs.recommended,
    ...nextConfig,
    {
        plugins: {
            "unused-imports": unusedImports,
        },
        rules: {
            "react/no-unescaped-entities": "off",
            "@next/next/no-page-custom-font": "off",
            "@next/next/no-img-element": "off",
            "unused-imports/no-unused-imports": "warn",
            "no-console": "warn",
        },
    },
];


================================================
FILE: apps/web/instrumentation.ts
================================================
export async function register() {
  if (process.env.NEXT_RUNTIME === 'nodejs') {
    // Node.js specific instrumentation
  }

  if (process.env.NEXT_RUNTIME === 'edge') {
    // Edge runtime specific instrumentation
  }
}



================================================
FILE: apps/web/next.config.js
================================================
/** @type {import('next').NextConfig} */
const nextConfig = {
  async rewrites() {
    return [
      {
        source: '/umami/script.js',
        destination: `https://eu.umami.is/script.js`,
      },
      {
        source: '/umami/api/send',
        destination: `https://eu.umami.is/api/send`,
      },
    ]
  },
  reactStrictMode: false,
  output: 'standalone',
  eslint: {
    ignoreDuringBuilds: true,
  },
}

module.exports = nextConfig



================================================
FILE: apps/web/package.json
================================================
{
  "name": "learnhouse",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev --turbopack",
    "dev-https": "next dev --experimental-https -p 443",
    "build": "next build",
    "start": "next start",
    "lint": "eslint . || true",
    "lint:fix": "eslint --fix . || true"
  },
  "dependencies": {
    "@emoji-mart/data": "^1.2.1",
    "@emoji-mart/react": "^1.1.1",
    "@hello-pangea/dnd": "^18.0.1",
    "@icons-pack/react-simple-icons": "^13.8.0",
    "@radix-ui/colors": "^3.0.0",
    "@radix-ui/react-aspect-ratio": "^1.1.7",
    "@radix-ui/react-checkbox": "^1.3.3",
    "@radix-ui/react-dialog": "^1.1.15",
    "@radix-ui/react-dropdown-menu": "^2.1.16",
    "@radix-ui/react-form": "^0.1.8",
    "@radix-ui/react-hover-card": "^1.1.15",
    "@radix-ui/react-icons": "^1.3.2",
    "@radix-ui/react-label": "^2.1.7",
    "@radix-ui/react-select": "^2.2.6",
    "@radix-ui/react-slot": "^1.2.3",
    "@radix-ui/react-switch": "^1.2.6",
    "@radix-ui/react-tabs": "^1.1.13",
    "@radix-ui/react-toggle": "^1.1.10",
    "@radix-ui/react-toggle-group": "^1.1.11",
    "@radix-ui/react-tooltip": "^1.2.8",
    "@stitches/react": "^1.2.8",
    "@tanstack/react-table": "^8.21.3",
    "@tiptap/core": "^3.10.1",
    "@tiptap/extension-bullet-list": "^3.10.1",
    "@tiptap/extension-code-block-lowlight": "^3.10.1",
    "@tiptap/extension-heading": "^3.10.1",
    "@tiptap/extension-link": "^3.10.1",
    "@tiptap/extension-list-item": "^3.10.1",
    "@tiptap/extension-ordered-list": "^3.10.1",
    "@tiptap/extension-table": "^3.10.1",
    "@tiptap/extension-table-cell": "^3.10.1",
    "@tiptap/extension-table-header": "^3.10.1",
    "@tiptap/extension-table-row": "^3.10.1",
    "@tiptap/extension-youtube": "^3.10.1",
    "@tiptap/html": "^3.10.1",
    "@tiptap/pm": "^3.10.1",
    "@tiptap/react": "^3.10.1",
    "@tiptap/starter-kit": "^3.10.1",
    "@types/randomcolor": "^0.5.9",
    "avvvatars-react": "^0.4.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "currency-codes": "^2.2.0",
    "dayjs": "^1.11.19",
    "dompurify": "^3.3.1",
    "emblor": "^1.4.8",
    "formik": "^2.4.6",
    "framer-motion": "^12.23.24",
    "get-youtube-id": "^1.0.1",
    "highlight.js": "^11.11.1",
    "html2canvas": "^1.4.1",
    "jspdf": "^3.0.4",
    "jspdf-html2canvas": "^1.5.2",
    "katex": "^0.16.25",
    "lowlight": "^3.3.0",
    "lucide-react": "^0.552.0",
    "next": "16.0.10",
    "next-auth": "^4.24.13",
    "nextjs-toploader": "^3.9.17",
    "plyr": "^3.8.3",
    "prosemirror-state": "^1.4.4",
    "qrcode": "^1.5.4",
    "randomcolor": "^0.6.2",
    "re-resizable": "^6.11.2",
    "react": "19.2.0",
    "react-confetti": "^6.4.0",
    "react-dom": "19.2.0",
    "react-hot-toast": "^2.6.0",
    "react-katex": "^3.1.0",
    "react-plyr": "^2.2.0",
    "react-spinners": "^0.17.0",
    "react-youtube": "^10.1.0",
    "require-in-the-middle": "^8.0.1",
    "sharp": "^0.34.4",
    "styled-components": "^6.1.19",
    "swr": "^2.3.6",
    "tailwind-merge": "^3.3.1",
    "tailwindcss-animate": "^1.0.7",
    "unsplash-js": "^7.0.20",
    "usehooks-ts": "^3.1.1",
    "uuid": "^13.0.0",
    "yup": "^1.7.1"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.1.16",
    "@types/node": "24.9.2",
    "@types/qrcode": "^1.5.6",
    "@types/react": "19.2.2",
    "@types/react-dom": "19.2.2",
    "@types/react-katex": "^3.0.4",
    "@types/react-transition-group": "^4.4.12",
    "@types/styled-components": "^5.1.35",
    "eslint": "^9.39.0",
    "eslint-config-next": "16.0.1",
    "eslint-plugin-unused-imports": "^4.3.0",
    "postcss": "^8.5.6",
    "tailwindcss": "^4.1.16",
    "typescript": "5.9.3"
  },
  "pnpm": {
    "overrides": {
      "@types/react": "19.2.2",
      "@types/react-dom": "19.2.2"
    }
  }
}



================================================
FILE: apps/web/postcss.config.js
================================================
module.exports = {
  plugins: {
    '@tailwindcss/postcss': {},
  },
}



================================================
FILE: apps/web/proxy.ts
================================================
import {
  getLEARNHOUSE_DOMAIN_VAL,
  getLEARNHOUSE_TOP_DOMAIN_VAL,
  getDefaultOrg,
  getUriWithOrg,
  isMultiOrgModeEnabled,
} from './services/config/config'
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export const config = {
  matcher: [
    /*
     * Match all paths except for:
     * 1. /api routes
     * 2. /_next (Next.js internals)
     * 3. /fonts (inside /public)
     * 4. Umami Analytics
     * 4. /examples (inside /public)
     * 5. all root files inside /public (e.g. /favicon.ico)
     */
    '/((?!api|_next|fonts|umami|examples|[\\w-]+\\.\\w+).*)',
    '/sitemap.xml',
    '/payments/stripe/connect/oauth',
  ],
}

export default async function proxy(req: NextRequest) {
  // Get initial data
  const hosting_mode = isMultiOrgModeEnabled() ? 'multi' : 'single'
  const default_org = getDefaultOrg()
  const { pathname, search } = req.nextUrl
  const fullhost = req.headers ? req.headers.get('host') : ''
  const cookie_orgslug = req.cookies.get('learnhouse_current_orgslug')?.value
  

  // Out of orgslug paths & rewrite
  const standard_paths = ['/home']
  const auth_paths = ['/login', '/signup', '/reset', '/forgot']
  if (standard_paths.includes(pathname)) {
    // Redirect to the same pathname with the original search params
    return NextResponse.rewrite(new URL(`${pathname}${search}`, req.url))
  }

  if (auth_paths.includes(pathname)) {
    const response = NextResponse.rewrite(
      new URL(`/auth${pathname}${search}`, req.url)
    )

    // Parse the search params
    const searchParams = new URLSearchParams(search)
    const orgslug = searchParams.get('orgslug')

    if (orgslug) {
      const LEARNHOUSE_TOP_DOMAIN = getLEARNHOUSE_TOP_DOMAIN_VAL()
      response.cookies.set({
        name: 'learnhouse_current_orgslug',
        value: orgslug,
        domain:
          LEARNHOUSE_TOP_DOMAIN == 'localhost' ? '' : LEARNHOUSE_TOP_DOMAIN,
      })
    }
    return response
  }


  // Dynamic Pages Editor
  if (pathname.match(/^\/course\/[^/]+\/activity\/[^/]+\/edit$/)) {
    return NextResponse.rewrite(new URL(`/editor${pathname}`, req.url))
  }

  // Check if the request is for the Stripe callback URL
  if (req.nextUrl.pathname.startsWith('/payments/stripe/connect/oauth')) {
    const searchParams = req.nextUrl.searchParams
    const orgslug = searchParams.get('state')?.split('_')[0] // Assuming state parameter contains orgslug_randomstring
    
    // Construct the new URL with the required parameters
    const redirectUrl = new URL('/payments/stripe/connect/oauth', req.url)
    
    // Preserve all original search parameters
    searchParams.forEach((value, key) => {
      redirectUrl.searchParams.append(key, value)
    })
    
    // Add orgslug if available
    if (orgslug) {
      redirectUrl.searchParams.set('orgslug', orgslug)
    }

    return NextResponse.rewrite(redirectUrl)
  }

  // Health Check
  if (pathname.startsWith('/health')) {
    return NextResponse.rewrite(new URL(`/api/health`, req.url))
  }

  // Auth Redirects
  if (pathname == '/redirect_from_auth') {
    if (cookie_orgslug) {
      const searchParams = req.nextUrl.searchParams
      const queryString = searchParams.toString()
      const redirectPathname = '/'
      const redirectUrl = new URL(
        getUriWithOrg(cookie_orgslug, redirectPathname),
        req.url
      )

      if (queryString) {
        redirectUrl.search = queryString
      }
      return NextResponse.redirect(redirectUrl)
    } else {
      return 'Did not find the orgslug in the cookie'
    }
  }

  if (pathname.startsWith('/sitemap.xml')) {
    let orgslug: string;
    
    const LEARNHOUSE_DOMAIN = getLEARNHOUSE_DOMAIN_VAL()
    if (hosting_mode === 'multi') {
      orgslug = fullhost
        ? fullhost.replace(`.${LEARNHOUSE_DOMAIN}`, '')
        : (default_org as string);
    } else {
      // Single hosting mode
      orgslug = default_org as string;
    }

    const sitemapUrl = new URL(`/api/sitemap`, req.url);

    // Create a response object
    const response = NextResponse.rewrite(sitemapUrl);

    // Set the orgslug in a header
    response.headers.set('X-Sitemap-Orgslug', orgslug);

    return response;
  }

  // Multi Organization Mode
  if (hosting_mode === 'multi') {
    // Get the organization slug from the URL
    const LEARNHOUSE_DOMAIN = getLEARNHOUSE_DOMAIN_VAL()
    const LEARNHOUSE_TOP_DOMAIN = getLEARNHOUSE_TOP_DOMAIN_VAL()
    const orgslug = fullhost
      ? fullhost.replace(`.${LEARNHOUSE_DOMAIN}`, '')
      : (default_org as string)
    const response = NextResponse.rewrite(
      new URL(`/orgs/${orgslug}${pathname}`, req.url)
    )

    // Set the cookie with the orgslug value
    response.cookies.set({
      name: 'learnhouse_current_orgslug',
      value: orgslug,
      domain: LEARNHOUSE_TOP_DOMAIN == 'localhost' ? '' : LEARNHOUSE_TOP_DOMAIN,
      path: '/',
    })

    return response
  }

  // Single Organization Mode
  if (hosting_mode === 'single') {
    // Get the default organization slug
    const LEARNHOUSE_TOP_DOMAIN = getLEARNHOUSE_TOP_DOMAIN_VAL()
    const orgslug = default_org as string
    const response = NextResponse.rewrite(
      new URL(`/orgs/${orgslug}${pathname}`, req.url)
    )

    // Set the cookie with the orgslug value
    response.cookies.set({
      name: 'learnhouse_current_orgslug',
      value: orgslug,
      domain: LEARNHOUSE_TOP_DOMAIN == 'localhost' ? '' : LEARNHOUSE_TOP_DOMAIN,
      path: '/',
    })

    return response
  }
}



================================================
FILE: apps/web/server-wrapper.js
================================================
#!/usr/bin/env node

/**
 * Server wrapper for Next.js standalone mode
 * This script generates a runtime config file from environment variables
 * and injects them before starting the Next.js server.
 */

const fs = require('fs');
const path = require('path');

// Read all NEXT_PUBLIC_* environment variables from the environment
const env = process.env;

// Collect all NEXT_PUBLIC_* variables
const runtimeConfig = {};

// List of all known NEXT_PUBLIC_* variables that might be set
const knownPublicVars = [
  'NEXT_PUBLIC_LEARNHOUSE_API_URL',
  'NEXT_PUBLIC_LEARNHOUSE_BACKEND_URL',
  'NEXT_PUBLIC_LEARNHOUSE_DOMAIN',
  'NEXT_PUBLIC_LEARNHOUSE_TOP_DOMAIN',
  'NEXT_PUBLIC_LEARNHOUSE_MULTI_ORG',
  'NEXT_PUBLIC_LEARNHOUSE_DEFAULT_ORG',
  'NEXT_PUBLIC_LEARNHOUSE_HTTPS',
  'NEXT_PUBLIC_LEARNHOUSE_MEDIA_URL',
  'NEXT_PUBLIC_UNSPLASH_ACCESS_KEY',
];

// Collect all NEXT_PUBLIC_* variables
Object.keys(env).forEach((key) => {
  if (key.startsWith('NEXT_PUBLIC_')) {
    runtimeConfig[key] = env[key];
    process.env[key] = env[key];
  }
});

// Ensure known variables are set (with defaults if needed)
knownPublicVars.forEach((key) => {
  if (env[key]) {
    runtimeConfig[key] = env[key];
    process.env[key] = env[key];
  } else if (!runtimeConfig[key]) {
    // Set defaults for required variables
    switch (key) {
      case 'NEXT_PUBLIC_LEARNHOUSE_API_URL':
        runtimeConfig[key] = 'http://localhost/api/v1/';
        break;
      case 'NEXT_PUBLIC_LEARNHOUSE_BACKEND_URL':
        runtimeConfig[key] = 'http://localhost/';
        break;
      case 'NEXT_PUBLIC_LEARNHOUSE_DOMAIN':
        runtimeConfig[key] = 'localhost';
        break;
      case 'NEXT_PUBLIC_LEARNHOUSE_TOP_DOMAIN':
        runtimeConfig[key] = 'localhost';
        break;
      case 'NEXT_PUBLIC_LEARNHOUSE_MULTI_ORG':
        runtimeConfig[key] = 'false';
        break;
      case 'NEXT_PUBLIC_LEARNHOUSE_DEFAULT_ORG':
        runtimeConfig[key] = 'default';
        break;
      case 'NEXT_PUBLIC_LEARNHOUSE_HTTPS':
        runtimeConfig[key] = 'false';
        break;
    }
    if (runtimeConfig[key]) {
      process.env[key] = runtimeConfig[key];
    }
  }
});

// Write runtime config JSON file
const configPath = path.join(__dirname, 'runtime-config.json');
fs.writeFileSync(configPath, JSON.stringify(runtimeConfig, null, 2), 'utf8');

// Create client-side runtime config script for browser access
// In Next.js standalone, public files are served from the public directory
const publicDir = path.join(__dirname, 'public');
try {
  if (!fs.existsSync(publicDir)) {
    fs.mkdirSync(publicDir, { recursive: true });
  }
  const scriptPath = path.join(publicDir, 'runtime-config.js');
  fs.writeFileSync(
    scriptPath,
    `window.__RUNTIME_CONFIG__ = ${JSON.stringify(runtimeConfig)};`,
    'utf8'
  );
} catch {
  // Ignore if can't create (non-critical for server-side rendering)
  // Client-side config is optional if runtime-config.json is available
}

// Set default HOSTNAME if not provided
if (!process.env.HOSTNAME) {
  process.env.HOSTNAME = '0.0.0.0';
}

// Set PORT from environment or default
if (!process.env.PORT) {
  process.env.PORT = '3000';
}

// Now require and run the actual Next.js server
// The server.js is in the same directory (standalone output)
require('./server.js');




================================================
FILE: apps/web/tailwind.config.js
================================================
/** @type {import('tailwindcss').Config} */
module.exports = {
  darkMode: ["class"],
  content: [
    './pages/**/*.{ts,tsx}',
    './components/**/*.{ts,tsx}',
    './app/**/*.{ts,tsx}',
    './src/**/*.{ts,tsx}',
  ],
  theme: {
    container: {
      center: true,
      padding: "2rem",
      screens: {
        "2xl": "1400px",
      },
    },
    extend: {
      colors: {
        border: "hsl(var(--border))",
        input: "hsl(var(--input))",
        ring: "hsl(var(--ring))",
        background: "hsl(var(--background))",
        foreground: "hsl(var(--foreground))",
        primary: {
          DEFAULT: "hsl(var(--primary))",
          foreground: "hsl(var(--primary-foreground))",
        },
        secondary: {
          DEFAULT: "hsl(var(--secondary))",
          foreground: "hsl(var(--secondary-foreground))",
        },
        destructive: {
          DEFAULT: "hsl(var(--destructive))",
          foreground: "hsl(var(--destructive-foreground))",
        },
        muted: {
          DEFAULT: "hsl(var(--muted))",
          foreground: "hsl(var(--muted-foreground))",
        },
        accent: {
          DEFAULT: "hsl(var(--accent))",
          foreground: "hsl(var(--accent-foreground))",
        },
        popover: {
          DEFAULT: "hsl(var(--popover))",
          foreground: "hsl(var(--popover-foreground))",
        },
        card: {
          DEFAULT: "hsl(var(--card))",
          foreground: "hsl(var(--card-foreground))",
        },
      },
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
      keyframes: {
        "accordion-down": {
          from: { height: "0" },
          to: { height: "var(--radix-accordion-content-height)" },
        },
        "accordion-up": {
          from: { height: "var(--radix-accordion-content-height)" },
          to: { height: "0" },
        },
        "fade-in": {
          from: { opacity: "0" },
          to: { opacity: "1" },
        },
        "fade-out": {
          from: { opacity: "1" },
          to: { opacity: "0" },
        },
        "zoom-in": {
          from: { transform: "scale(0.95)" },
          to: { transform: "scale(1)" },
        },
        "zoom-out": {
          from: { transform: "scale(1)" },
          to: { transform: "scale(0.95)" },
        },
        "slide-in-from-top": {
          from: { transform: "translateY(-100%)" },
          to: { transform: "translateY(0)" },
        },
        "slide-in-from-bottom": {
          from: { transform: "translateY(100%)" },
          to: { transform: "translateY(0)" },
        },
      },
      animation: {
        "accordion-down": "accordion-down 0.2s ease-out",
        "accordion-up": "accordion-up 0.2s ease-out",
        "fade-in": "fade-in 0.2s ease-out",
        "fade-out": "fade-out 0.2s ease-out",
        "zoom-in": "zoom-in 0.2s ease-out",
        "zoom-out": "zoom-out 0.2s ease-out",
        "slide-in-from-top": "slide-in-from-top 0.2s ease-out",
        "slide-in-from-bottom": "slide-in-from-bottom 0.2s ease-out",
      },
    },
  },
  plugins: [require("tailwindcss-animate")],
} 


================================================
FILE: apps/web/tsconfig.json
================================================
{
  "compilerOptions": {
    "target": "es5",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "baseUrl": ".",
    "paths": {
      "@components/*": [
        "components/*"
      ],
      "@public/*": [
        "public/*"
      ],
      "@images/*": [
        "public/img/*"
      ],
      "@styles/*": [
        "styles/*"
      ],
      "@services/*": [
        "services/*"
      ],
      "@editor/*": [
        "components/Objects/Editor/*"
      ],
      "@hooks/*": [
        "components/Hooks/*"
      ],
      "@/*": [
        "./*"
      ]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}



================================================
FILE: apps/web/.prettierrc.yaml
================================================
trailingComma: "es5"
semi: false
singleQuote: true


================================================
FILE: apps/web/app/global-error.tsx
================================================
"use client";

export default function GlobalError({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  return (
    <html>
      <body>
        <h2>Something went wrong!</h2>
        <button onClick={() => reset()}>Try again</button>
      </body>
    </html>
  );
}


================================================
FILE: apps/web/app/layout.tsx
================================================
'use client'
import '../styles/globals.css'
import StyledComponentsRegistry from '../components/Utils/libs/styled-registry'
import { motion } from 'framer-motion'
import { SessionProvider } from 'next-auth/react'
import LHSessionProvider from '@components/Contexts/LHSessionContext'
import { isDevEnv } from './auth/options'
import Script from 'next/script'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const variants = {
    hidden: { opacity: 0, x: 0, y: 0 },
    enter: { opacity: 1, x: 0, y: 0 },
    exit: { opacity: 0, x: 0, y: 0 },
  }
  return (
    <html className="" lang="en">
      <head />
      <body>
        {/* Inject runtime configuration for client-side access */}
        <Script src="/runtime-config.js" strategy="beforeInteractive" />
        {isDevEnv ? '' : <Script data-website-id="a1af6d7a-9286-4a1f-8385-ddad2a29fcbb" src="/umami/script.js" />}
        <SessionProvider key="session-provider" refetchInterval={60000}>
          <LHSessionProvider>
            <StyledComponentsRegistry>
              <motion.main
                variants={variants} // Pass the variant object into Framer Motion
                initial="hidden" // Set the initial state to variants.hidden
                animate="enter" // Animated state to variants.enter
                exit="exit" // Exit state (used later) to variants.exit
                transition={{ type: 'tween' }} // Set the transition to tween
              >
                {children}
              </motion.main>
            </StyledComponentsRegistry>
          </LHSessionProvider>
        </SessionProvider>
      </body>
    </html>
  )
}



================================================
FILE: apps/web/app/not-found.tsx
================================================
import { ArrowRight } from 'lucide-react'
import Image from 'next/image'
import Link from 'next/link'
import learnhouseIcon from 'public/black_logo.png'

export default function NotFound() {
  return (
    <div className="flex min-h-screen w-full flex-col items-center justify-center 
   bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-zinc-200 to-slate-300">
    <div className="nx-flex nx-items-center hover:nx-opacity-75 ltr:nx-mr-auto rtl:nx-ml-auto pb-20">
        <Image quality={100}
          width={270}
          height={100}
          src={learnhouseIcon}
          alt="logo"
        />
        </div>
      <div className="space-y-6 text-center">
        <h1 className="text-8xl leading-7 font-bold text-black drop-shadow-md">
          404!
        </h1>
        <p className='text-lg pt-8 text-black tracking-tight font-medium leading-normal'>
          We are very sorry for the inconvenience. It looks like you're trying to
          <div>access a page that has been deleted or never existed before</div>
        </p>
      </div>
      <div className='pt-8 flex flex-col items-center'>
        <button className="flex w-fit h-[50px] text-xl space-x-2 bg-black px-6 py-2 text-md rounded-lg font-bold text-white items-center shadow-md">
          <Link className='flex gap-2' href="/" >
            Go back to homepage
            <ArrowRight className='tracking-tight group-hover:translate-x-0.5 
        transition-transform duration-150 ease-in-out ml-1' />
          </Link>
        </button>
      </div>
    </div>
  )
}




================================================
FILE: apps/web/app/api/auth/[...nextauth]/route.ts
================================================
import NextAuth from 'next-auth'
import { nextAuthOptions } from 'app/auth/options'

const handler = NextAuth(nextAuthOptions)

export { handler as GET, handler as POST }



================================================
FILE: apps/web/app/api/health/route.ts
================================================
export const dynamic = 'force-dynamic' // defaults to auto
export const revalidate = 0

import { NextResponse } from 'next/server';
import { checkHealth } from '@services/utils/health';

export async function GET() {
  const health = await checkHealth()
  if (health.success === true) {
    return NextResponse.json(
      {
        status: 'healthy',
        timestamp: new Date().toISOString(),
        health: health.data,
      },
      {
        status: 200,
        headers: {
          'Content-Type': 'application/json',
        },
      }
    )
  } else {
    return NextResponse.json(
      {
        status: 'unhealthy',
        timestamp: new Date().toISOString(),
        health: null,
        error: health.HTTPmessage,
      },
      {
        status: 503,
        headers: {
          'Content-Type': 'application/json',
        },
      }
    );
  }
}



================================================
FILE: apps/web/app/api/revalidate/route.ts
================================================
import { NextRequest, NextResponse } from 'next/server'
import { revalidateTag } from 'next/cache'

export async function GET(request: NextRequest) {
  const tag = request.nextUrl.searchParams.get('tag')
  
  if (!tag) {
    return NextResponse.json(
      { error: 'Tag parameter is required' },
      { status: 400 }
    )
  }
  
  revalidateTag(tag, {})

  return NextResponse.json(
    { revalidated: true, now: Date.now(), tag },
    {
      status: 200,
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type, Authorization',
      },
    }
  )
}


================================================
FILE: apps/web/app/api/sitemap/route.ts
================================================
import { getUriWithOrg } from '@services/config/config';
import { getOrgCourses } from '@services/courses/courses';
import { getOrganizationContextInfo } from '@services/organizations/orgs';
import { getOrgCollections } from '@services/courses/collections';
import { NextRequest, NextResponse } from 'next/server';


export async function GET(request: NextRequest) {
  const orgSlug = request.headers.get('X-Sitemap-Orgslug');

  if (!orgSlug) {
    return NextResponse.json({ error: 'Missing X-Sitemap-Orgslug header' }, { status: 400 });
  }

  const orgInfo = await getOrganizationContextInfo(orgSlug, null);
  const courses = await getOrgCourses(orgSlug, null);
  const collections = await getOrgCollections(orgInfo.id);

  const host = request.headers.get('host');
  if (!host) {
    return NextResponse.json({ error: 'Missing host header' }, { status: 400 });
  }

  const baseUrl = getUriWithOrg(orgSlug, '/');

  const sitemapUrls: SitemapUrl[] = [
    { loc: baseUrl, priority: 1.0, changefreq: 'daily' },
    { loc: `${baseUrl}collections`, priority: 0.9, changefreq: 'weekly' },
    { loc: `${baseUrl}courses`, priority: 0.9, changefreq: 'weekly' },
    // Courses
    ...courses.map((course: { course_uuid: string }) => ({ 
      loc: `${baseUrl}course/${course.course_uuid.replace('course_', '')}`, 
      priority: 0.7,
      changefreq: 'weekly'
    })),
    // Collections
    ...collections.map((collection: { collection_uuid: string }) => ({
      loc: `${baseUrl}collections/${collection.collection_uuid.replace('collection_', '')}`,
      priority: 0.6,
      changefreq: 'weekly'
    }))
  ];

  const sitemap = generateSitemap(baseUrl, sitemapUrls);

  return new NextResponse(sitemap, {
    headers: {
      'Content-Type': 'application/xml',
    },
  });
}

interface SitemapUrl {
    loc: string;
    priority: number;
    changefreq: string;
  }
  
  function generateSitemap(baseUrl: string, urls: SitemapUrl[]): string {
    const urlEntries = urls.map(({ loc, priority, changefreq }) => `
    <url>
      <loc>${loc}</loc>
      <priority>${priority.toFixed(1)}</priority>
      <changefreq>${changefreq}</changefreq>
    </url>`).join('');
  
    return `<?xml version="1.0" encoding="UTF-8"?>
  <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  ${urlEntries}
  </urlset>`;
  }




================================================
FILE: apps/web/app/auth/layout.tsx
================================================
'use client'
import { OrgProvider } from '@components/Contexts/OrgContext'
import ErrorUI from '@components/Objects/StyledElements/Error/Error'
import { useSearchParams } from 'next/navigation'


export default function AuthLayout({
    children,
}: {
    children: React.ReactNode
}) {
    const searchParams = useSearchParams()
    const orgslug = searchParams.get('orgslug')
    if (orgslug) {
        return <OrgProvider orgslug={orgslug}>{children}</OrgProvider>
    } else {
        return <ErrorUI message='Organization not specified' submessage='Please access this page from an Organization' />
    }
}


================================================
FILE: apps/web/app/auth/options.ts
================================================
import {
  getNewAccessTokenUsingRefreshTokenServer,
  getUserSession,
  loginAndGetToken,
  loginWithOAuthToken,
} from '@services/auth/auth'
import { getLEARNHOUSE_TOP_DOMAIN_VAL, getUriWithOrg } from '@services/config/config'
import { getResponseMetadata } from '@services/utils/ts/requests'
import CredentialsProvider from 'next-auth/providers/credentials'
import GoogleProvider from 'next-auth/providers/google'

// Add type declarations at the top of the file
declare global {
  var sessionCache: {
    [key: string]: {
      data: any;
      timestamp: number;
    };
  };
}

export const isDevEnv = getLEARNHOUSE_TOP_DOMAIN_VAL() == 'localhost' ? true : false

export const nextAuthOptions = {
  debug: true,
  providers: [
    CredentialsProvider({
      // The name to display on the sign in form (e.g. 'Sign in with...')
      name: 'Credentials',
      // The credentials is used to generate a suitable form on the sign in page.
      // You can specify whatever fields you are expecting to be submitted.
      // e.g. domain, username, password, 2FA token, etc.
      // You can pass any HTML attribute to the <input> tag through the object.
      credentials: {
        email: { label: 'Email', type: 'text', placeholder: 'jsmith' },
        password: { label: 'Password', type: 'password' },
      },
      async authorize(credentials, req) {
        // logic to verify if user exists
        let unsanitized_req = await loginAndGetToken(
          credentials?.email,
          credentials?.password
        )
        let res = await getResponseMetadata(unsanitized_req)
        if (res.success) {
          // If login failed, then this is the place you could do a registration
          return res.data
        } else {
          return null
        }
      },
    }),
    GoogleProvider({
      clientId: process.env.LEARNHOUSE_GOOGLE_CLIENT_ID || '',
      clientSecret: process.env.LEARNHOUSE_GOOGLE_CLIENT_SECRET || '',
    }),
  ],
  pages: {
    signIn: getUriWithOrg('auth', '/'),
    verifyRequest: getUriWithOrg('auth', '/'),
    error: getUriWithOrg('auth', '/'), // Error code passed in query string as ?error=
  },
  cookies: {
    sessionToken: {
      name: `${!isDevEnv ? '__Secure-' : ''}next-auth.session-token`,
      options: {
        httpOnly: true,
        sameSite: 'lax',
        path: '/',
        // When working on localhost, the cookie domain must be omitted entirely (https://stackoverflow.com/a/1188145)
        domain: `.${getLEARNHOUSE_TOP_DOMAIN_VAL()}`,
        secure: !isDevEnv,
      },
    },
  },
  callbacks: {
    async jwt({ token, user, account }: any) {
      // First sign in with Credentials provider
      if (account?.provider == 'credentials' && user) {
        token.user = user;
      }

      // Sign up with Google
      if (account?.provider == 'google' && user) {
        let unsanitized_req = await loginWithOAuthToken(
          user.email,
          'google',
          account.access_token
        );
        let userFromOAuth = await getResponseMetadata(unsanitized_req);
        token.user = userFromOAuth.data;
      }

      // Refresh token only if it's close to expiring (1 minute before expiry)
      if (token?.user?.tokens) {
        const tokenExpiry = token.user.tokens.expiry || 0;
        const oneMinute = 1 * 60 * 1000;
        
        if (Date.now() + oneMinute >= tokenExpiry) {
          const RefreshedToken = await getNewAccessTokenUsingRefreshTokenServer(
            token?.user?.tokens?.refresh_token
          );
          token = {
            ...token,
            user: {
              ...token.user,
              tokens: {
                ...token.user.tokens,
                access_token: RefreshedToken.access_token,
                expiry: Date.now() + (60 * 60 * 1000), // 1 hour from now
              },
            },
          };
        }
      }
      return token;
    },
    async session({ session, token }: any) {
      // Include user information in the session
      if (token.user) {
        // Cache the session for 1 minute to refresh every minute
        const cacheKey = `user_session_${token.user.tokens.access_token}`;
        let cachedSession = global.sessionCache?.[cacheKey];
        
        if (cachedSession && Date.now() - cachedSession.timestamp < 1 * 60 * 1000) {
          return cachedSession.data;
        }

        let api_SESSION = await getUserSession(token.user.tokens.access_token);
        session.user = api_SESSION.user;
        session.roles = api_SESSION.roles;
        session.tokens = token.user.tokens;

        // Cache the session
        if (!global.sessionCache) {
          global.sessionCache = {};
        }
        global.sessionCache[cacheKey] = {
          data: session,
          timestamp: Date.now()
        };
      }
      return session;
    },
  },
}



================================================
FILE: apps/web/app/auth/forgot/forgot.tsx
================================================
'use client'
import Image from 'next/image'
import React from 'react'
import learnhouseIcon from 'public/learnhouse_bigicon_1.png'
import FormLayout, {
    FormField,
    FormLabelAndMessage,
    Input,
} from '@components/Objects/StyledElements/Form/Form'
import * as Form from '@radix-ui/react-form'
import { getOrgLogoMediaDirectory } from '@services/media/media'
import { AlertTriangle, Info } from 'lucide-react'
import Link from 'next/link'
import { getUriWithOrg } from '@services/config/config'
import { useOrg } from '@components/Contexts/OrgContext'
import { useRouter } from 'next/navigation'
import { useFormik } from 'formik'
import { sendResetLink } from '@services/auth/auth'

const validate = (values: any) => {
    const errors: any = {}

    if (!values.email) {
        errors.email = 'Required'
    } else if (!/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i.test(values.email)) {
        errors.email = 'Invalid email address'
    }


    return errors
}

function ForgotPasswordClient() {
    const org = useOrg() as any;
    const [isSubmitting, setIsSubmitting] = React.useState(false)
    const router = useRouter()
    const [error, setError] = React.useState('')
    const [message, setMessage] = React.useState('')

    const formik = useFormik({
        initialValues: {
            email: ''
        },
        validate,
        validateOnBlur: true,
        onSubmit: async (values) => {
            setIsSubmitting(true)
            let res = await sendResetLink(values.email, org?.id)
            if (res.status == 200) {
                setMessage(res.data + ', please check your email')
                setIsSubmitting(false)
            } else {
                setError(res.data.detail)
                setIsSubmitting(false)
            }
        },
    })
    return (

        <div className="grid grid-flow-col justify-stretch h-screen">
            <div
                className="right-login-part"
                style={{
                    background:
                        'linear-gradient(041.61deg, #202020 7.15%, #000000 90.96%)',
                }}
            >
                <div className="login-topbar m-10">
                    <Link prefetch href={getUriWithOrg(org?.slug, '/')}>
                        <Image
                            quality={100}
                            width={30}
                            height={30}
                            src={learnhouseIcon}
                            alt=""
                        />
                    </Link>
                </div>
                <div className="ml-10 h-4/6 flex flex-row text-white">
                    <div className="m-auto flex space-x-4 items-center flex-wrap">

                        <div className="shadow-[0px_4px_16px_rgba(0,0,0,0.02)]">
                            {org?.logo_image ? (
                                <img
                                    src={`${getOrgLogoMediaDirectory(
                                        org?.org_uuid,
                                        org?.logo_image
                                    )}`}
                                    alt="Learnhouse"
                                    style={{ width: 'auto', height: 70 }}
                                    className="rounded-xl shadow-xl inset-0 ring-1 ring-inset ring-black/10 bg-white"
                                />
                            ) : (
                                <Image
                                    quality={100}
                                    width={70}
                                    height={70}
                                    src={learnhouseIcon}
                                    alt=""
                                />
                            )}
                        </div>
                        <div className="font-bold text-xl">{org?.name}</div>
                    </div>
                </div>
            </div>
            <div className="left-login-part bg-white flex flex-row">
                <div className="login-form m-auto w-72">
                    <h1 className="text-2xl font-bold mb-4">Forgot Password</h1>
                    <p className="text-sm mb-4">
                        Enter your email address and we will send you a link to reset your
                        password
                    </p>

                    {error && (
                        <div className="flex justify-center bg-red-200 rounded-md text-red-950 space-x-2 items-center p-4 transition-all shadow-xs">
                            <AlertTriangle size={18} />
                            <div className="font-bold text-sm">{error}</div>
                        </div>
                    )}
                    {message && (
                        <div className="flex justify-center bg-green-200 rounded-md text-green-950 space-x-2 items-center p-4 transition-all shadow-xs">
                            <Info size={18} />
                            <div className="font-bold text-sm">{message}</div>
                        </div>
                    )}
                    <FormLayout onSubmit={formik.handleSubmit}>
                        <FormField name="email">
                            <FormLabelAndMessage
                                label="Email"
                                message={formik.errors.email}
                            />
                            <Form.Control asChild>
                                <Input
                                    onChange={formik.handleChange}
                                    value={formik.values.email}
                                    type="email"
                                    required
                                />
                            </Form.Control>
                        </FormField>
                        <div className="flex  py-4">
                            <Form.Submit asChild>
                                <button className="w-full bg-black text-white font-bold text-center p-2 rounded-md shadow-md hover:cursor-pointer">
                                    {isSubmitting ? 'Loading...' : 'Send Reset Link'}
                                </button>
                            </Form.Submit>
                        </div>
                    </FormLayout>

                </div>
            </div>
        </div>
    )
}

export default ForgotPasswordClient


================================================
FILE: apps/web/app/auth/forgot/page.tsx
================================================
import React from 'react'
import ForgotPasswordClient from './forgot'
import { Metadata } from 'next'

export const metadata: Metadata = {
  title: 'LearnHouse - Forgot Password',
}

function ForgotPasswordPage() {
  return (
    <>
      <ForgotPasswordClient />
    </>
  )
}

export default ForgotPasswordPage


================================================
FILE: apps/web/app/auth/login/login.tsx
================================================
'use client'
import learnhouseIcon from 'public/learnhouse_bigicon_1.png'
import FormLayout, {
  FormField,
  FormLabelAndMessage,
  Input,
} from '@components/Objects/StyledElements/Form/Form'
import Image from 'next/image'
import * as Form from '@radix-ui/react-form'
import { useFormik } from 'formik'
import { getOrgLogoMediaDirectory } from '@services/media/media'
import React from 'react'
import { AlertTriangle, UserRoundPlus } from 'lucide-react'
import { useRouter } from 'next/navigation'
import Link from 'next/link'
import { signIn } from "next-auth/react"
import { getUriWithOrg, getUriWithoutOrg } from '@services/config/config'
import { useLHSession } from '@components/Contexts/LHSessionContext'

interface LoginClientProps {
  org: any
}

const validate = (values: any) => {
  const errors: any = {}

  if (!values.email) {
    errors.email = 'Required'
  } else if (!/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i.test(values.email)) {
    errors.email = 'Invalid email address'
  }

  if (!values.password) {
    errors.password = 'Required'
  } else if (values.password.length < 8) {
    errors.password = 'Password must be at least 8 characters'
  }

  return errors
}

const LoginClient = (props: LoginClientProps) => {
  const [isSubmitting, setIsSubmitting] = React.useState(false)
  const router = useRouter();
  const session = useLHSession() as any;

  const [error, setError] = React.useState('')
  const formik = useFormik({
    initialValues: {
      email: '',
      password: '',
    },
    validate,
    validateOnBlur: true,
    validateOnChange: true,
    onSubmit: async (values, {validateForm, setErrors, setSubmitting}) => {
      setIsSubmitting(true)
      const errors = await validateForm(values);
      if (Object.keys(errors).length > 0) {
        setErrors(errors);
        setSubmitting(false);
        return;
      }
      
      const res = await signIn('credentials', {
        redirect: false,
        email: values.email,
        password: values.password,
        callbackUrl: '/redirect_from_auth'
      });
      if (res && res.error) {
        setError("Wrong Email or password");
        setIsSubmitting(false);
      } else {
        await signIn('credentials', {
          email: values.email,
          password: values.password,
          callbackUrl: '/redirect_from_auth'
        });
      }
    },
  })

  return (
    <div className="grid grid-flow-col justify-stretch h-screen">
      <div
        className="right-login-part"
        style={{
          background:
            'linear-gradient(041.61deg, #202020 7.15%, #000000 90.96%)',
        }}
      >
        <div className="login-topbar m-10">
          <Link prefetch href={getUriWithOrg(props.org.slug, '/')}>
            <Image
              quality={100}
              width={30}
              height={30}
              src={learnhouseIcon}
              alt=""
            />
          </Link>
        </div>
        <div className="ml-10 h-4/6 flex flex-row text-white">
          <div className="m-auto flex space-x-4 items-center flex-wrap">
            <div>Login to </div>
            <div className="shadow-[0px_4px_16px_rgba(0,0,0,0.02)]">
              {props.org?.logo_image ? (
                <img
                  src={`${getOrgLogoMediaDirectory(
                    props.org.org_uuid,
                    props.org?.logo_image
                  )}`}
                  alt="Learnhouse"
                  style={{ width: 'auto', height: 70 }}
                  className="rounded-xl shadow-xl inset-0 ring-1 ring-inset ring-black/10 bg-white"
                />
              ) : (
                <Image
                  quality={100}
                  width={70}
                  height={70}
                  src={learnhouseIcon}
                  alt=""
                />
              )}
            </div>
            <div className="font-bold text-xl">{props.org?.name}</div>
          </div>
        </div>
      </div>
      <div className="left-login-part bg-white flex flex-row">
        <div className="login-form m-auto w-72">
          {error && (
            <div className="flex justify-center bg-red-200 rounded-md text-red-950 space-x-2 items-center p-4 transition-all shadow-xs">
              <AlertTriangle size={18} />
              <div className="font-bold text-sm">{error}</div>
            </div>
          )}
          <FormLayout onSubmit={formik.handleSubmit}>
            <FormField name="email">
              <FormLabelAndMessage
                label="Email"
                message={formik.errors.email}
              />
              <Form.Control asChild>
                <Input
                  onChange={formik.handleChange}
                  value={formik.values.email}
                  type="email"
                  
                />
              </Form.Control>
            </FormField>
            {/* for password  */}
            <FormField name="password">
              <FormLabelAndMessage
                label="Password"
                message={formik.errors.password}
              />

              <Form.Control asChild>
                <Input
                  onChange={formik.handleChange}
                  value={formik.values.password}
                  type="password"
                  
                />
              </Form.Control>
            </FormField>
            <div>
              <Link
                href={{ pathname: getUriWithoutOrg('/forgot'), query: props.org.slug ? { orgslug: props.org.slug } : null }}
                passHref
                className="text-xs text-gray-500 hover:underline"
              >
                Forgot password?
              </Link>
            </div>
            <div className="flex  py-4">
              <Form.Submit asChild>
                <button  className="w-full bg-black text-white font-bold text-center p-2 rounded-md shadow-md hover:cursor-pointer">
                  {isSubmitting ? 'Loading...' : 'Login'}
                </button>
              </Form.Submit>
            </div>
          </FormLayout>
          <div className='flex h-0.5 rounded-2xl bg-slate-100 mt-5  mx-10'></div>
          <div className='flex justify-center py-5 mx-auto'>OR </div>
          <div className='flex flex-col space-y-4'>
            <Link href={{ pathname: getUriWithoutOrg('/signup'), query: props.org.slug ? { orgslug: props.org.slug } : null }}  className="flex justify-center items-center py-3 text-md w-full bg-gray-800 text-gray-300 space-x-3 font-semibold text-center p-2 rounded-md shadow-sm hover:cursor-pointer">
              <UserRoundPlus size={17} />
              <span>Sign up</span>
            </Link>
            <button onClick={() => signIn('google', { callbackUrl: '/redirect_from_auth' })} className="flex justify-center py-3 text-md w-full bg-white text-slate-600 space-x-3 font-semibold text-center p-2 rounded-md shadow-sm hover:cursor-pointer">
              <img src="https://fonts.gstatic.com/s/i/productlogos/googleg/v6/24px.svg" alt="" />
              <span>Sign in with Google</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}

export default LoginClient



================================================
FILE: apps/web/app/auth/login/page.tsx
================================================
import { getOrganizationContextInfo } from '@services/organizations/orgs'
import LoginClient from './login'
import { Metadata } from 'next'

type MetadataProps = {
  params: Promise<{ orgslug: string }>
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>
}

export async function generateMetadata(params: MetadataProps): Promise<Metadata> {
  const orgslug = (await params.searchParams).orgslug
  
  //const orgslug = params.orgslug
  // Get Org context information
  const org = await getOrganizationContextInfo(orgslug, {
    revalidate: 0,
    tags: ['organizations'],
  })

  return {
    title: 'Login' + ` â€” ${org.name}`,
  }
}

const Login = async (params: MetadataProps) => {
  const orgslug = (await params.searchParams).orgslug
  const org = await getOrganizationContextInfo(orgslug, {
    revalidate: 0,
    tags: ['organizations'],
  })

  return (
    <div>
      <LoginClient org={org}></LoginClient>
    </div>
  )
}

export default Login



================================================
FILE: apps/web/app/auth/reset/page.tsx
================================================
import { Metadata } from 'next'
import React from 'react'
import ResetPasswordClient from './reset'

export const metadata: Metadata = {
    title: 'LearnHouse - Reset Password',
}

function ResetPasswordPage() {
    return (
        <ResetPasswordClient />
    )
}

export default ResetPasswordPage


================================================
FILE: apps/web/app/auth/reset/reset.tsx
================================================
'use client'
import Image from 'next/image'
import React from 'react'
import learnhouseIcon from 'public/learnhouse_bigicon_1.png'
import FormLayout, {
    FormField,
    FormLabelAndMessage,
    Input,
} from '@components/Objects/StyledElements/Form/Form'
import * as Form from '@radix-ui/react-form'
import { getOrgLogoMediaDirectory } from '@services/media/media'
import { AlertTriangle, Info } from 'lucide-react'
import Link from 'next/link'
import { getUriWithOrg, getUriWithoutOrg } from '@services/config/config'
import { useOrg } from '@components/Contexts/OrgContext'
import { useRouter, useSearchParams } from 'next/navigation'
import { useFormik } from 'formik'
import { resetPassword } from '@services/auth/auth'

const validate = (values: any) => {
    const errors: any = {}

    if (!values.email) {
        errors.email = 'Required'
    } else if (!/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i.test(values.email)) {
        errors.email = 'Invalid email address'
    }

    if (!values.new_password) {
        errors.new_password = 'Required'
    }

    if (!values.confirm_password) {
        errors.confirm_password = 'Required'
    }

    if (values.new_password !== values.confirm_password) {
        errors.confirm_password = 'Passwords do not match'
    }

    if (!values.reset_code) {
        errors.reset_code = 'Required'
    }
    return errors
}

function ResetPasswordClient() {
    const org = useOrg() as any;
    const [isSubmitting, setIsSubmitting] = React.useState(false)
    const searchParams = useSearchParams()
    const reset_code = searchParams.get('resetCode') || ''
    const email = searchParams.get('email') || ''
    const router = useRouter()
    const [error, setError] = React.useState('')
    const [message, setMessage] = React.useState('')

    const formik = useFormik({
        initialValues: {
            email: email,
            new_password: '',
            confirm_password: '',
            reset_code: reset_code
        },
        validate,
        enableReinitialize: true,
        onSubmit: async (values) => {
            setIsSubmitting(true)
            let res = await resetPassword(values.email, values.new_password, org?.id, values.reset_code)
            if (res.status == 200) {
                setMessage(res.data + ', please login')
                setIsSubmitting(false)
            } else {
                setError(res.data.detail)
                setIsSubmitting(false)
            }

        },
    })
    return (

        <div className="grid grid-flow-col justify-stretch h-screen">
            <div
                className="right-login-part"
                style={{
                    background:
                        'linear-gradient(041.61deg, #202020 7.15%, #000000 90.96%)',
                }}
            >
                <div className="login-topbar m-10">
                    <Link prefetch href={getUriWithOrg(org?.slug, '/')}>
                        <Image
                            quality={100}
                            width={30}
                            height={30}
                            src={learnhouseIcon}
                            alt=""
                        />
                    </Link>
                </div>
                <div className="ml-10 h-4/6 flex flex-row text-white">
                    <div className="m-auto flex space-x-4 items-center flex-wrap">

                        <div className="shadow-[0px_4px_16px_rgba(0,0,0,0.02)]">
                            {org?.logo_image ? (
                                <img
                                    src={`${getOrgLogoMediaDirectory(
                                        org?.org_uuid,
                                        org?.logo_image
                                    )}`}
                                    alt="Learnhouse"
                                    style={{ width: 'auto', height: 70 }}
                                    className="rounded-xl shadow-xl inset-0 ring-1 ring-inset ring-black/10 bg-white"
                                />
                            ) : (
                                <Image
                                    quality={100}
                                    width={70}
                                    height={70}
                                    src={learnhouseIcon}
                                    alt=""
                                />
                            )}
                        </div>
                        <div className="font-bold text-xl">{org?.name}</div>
                    </div>
                </div>
            </div>
            <div className="left-login-part bg-white flex flex-row">
                <div className="login-form m-auto w-72">
                    <h1 className="text-2xl font-bold mb-4">Reset Password</h1>
                    <p className="text-sm mb-4">
                        Enter your email and reset code to reset your password
                    </p>

                    {error && (
                        <div className="flex justify-center bg-red-200 rounded-md text-red-950 space-x-2 items-center p-4 transition-all shadow-xs">
                            <AlertTriangle size={18} />
                            <div className="font-bold text-sm">{error}</div>
                        </div>
                    )}
                    {message && (
                        <div className="flex flex-col gap-2">
                            <div className="flex justify-center bg-green-200 rounded-md text-green-950 space-x-2 items-center p-4 transition-all shadow-xs">
                                <Info size={18} />
                                <div className="font-bold text-sm">{message}</div>
                            </div>
                            <Link href={getUriWithoutOrg('/login?orgslug=' + org.slug)} className="text-center text-sm text-blue-600 hover:text-blue-800">
                                Please login again with your new password
                            </Link>
                        </div>
                    )}
                    <FormLayout onSubmit={formik.handleSubmit}>
                        <FormField name="email">
                            <FormLabelAndMessage
                                label="Email"
                                message={formik.errors.email}
                            />
                            <Form.Control asChild>
                                <Input
                                    onChange={formik.handleChange}
                                    value={formik.values.email}
                                    type="email"
                                />
                            </Form.Control>
                        </FormField>

                        <FormField name="reset_code">
                            <FormLabelAndMessage
                                label="Reset Code"
                                message={formik.errors.reset_code}
                            />
                            <Form.Control asChild>
                                <Input
                                    onChange={formik.handleChange}
                                    value={formik.values.reset_code}
                                    type="text"
                                />
                            </Form.Control>
                        </FormField>

                        <FormField name="new_password">
                            <FormLabelAndMessage
                                label="New Password"
                                message={formik.errors.new_password}
                            />
                            <Form.Control asChild>
                                <Input
                                    onChange={formik.handleChange}
                                    value={formik.values.new_password}
                                    type="password"
                                />
                            </Form.Control>
                        </FormField>

                        <FormField name="confirm_password">
                            <FormLabelAndMessage
                                label="Confirm Password"
                                message={formik.errors.confirm_password}
                            />
                            <Form.Control asChild>
                                <Input
                                    onChange={formik.handleChange}
                                    value={formik.values.confirm_password}
                                    type="password"
                                />
                            </Form.Control>
                        </FormField>


                        <div className="flex  py-4">
                            <Form.Submit asChild>
                                <button className="w-full bg-black text-white font-bold text-center p-2 rounded-md shadow-md hover:cursor-pointer">
                                    {isSubmitting ? 'Loading...' : 'Change Password'}
                                </button>
                            </Form.Submit>
                        </div>
                    </FormLayout>

                </div>
            </div>
        </div>
    )
}

export default ResetPasswordClient


================================================
FILE: apps/web/app/auth/signup/InviteOnlySignUp.tsx
================================================
'use client'
import { useFormik } from 'formik'
import { useRouter } from 'next/navigation'
import React, { useEffect } from 'react'
import FormLayout, {
  FormField,
  FormLabelAndMessage,
  Input,
  Textarea,
} from '@components/Objects/StyledElements/Form/Form'
import * as Form from '@radix-ui/react-form'
import { AlertTriangle, Check, User } from 'lucide-react'
import Link from 'next/link'
import { signUpWithInviteCode } from '@services/auth/auth'
import { useOrg } from '@components/Contexts/OrgContext'
import { signIn } from 'next-auth/react'

const validate = (values: any) => {
  const errors: any = {}

  if (!values.email) {
    errors.email = 'Required'
  } else if (!/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i.test(values.email)) {
    errors.email = 'Invalid email address'
  }

  if (!values.password) {
    errors.password = 'Required'
  } else if (values.password.length < 8) {
    errors.password = 'Password must be at least 8 characters'
  }

  if (!values.username) {
    errors.username = 'Required'
  }

  if (!values.username || values.username.length < 4) {
    errors.username = 'Username must be at least 4 characters'
  }

  if (!values.bio) {
    errors.bio = 'Required'
  }

  return errors
}

interface InviteOnlySignUpProps {
  inviteCode: string
}

function InviteOnlySignUpComponent(props: InviteOnlySignUpProps) {
  const [isSubmitting, setIsSubmitting] = React.useState(false)
  const org = useOrg() as any
  const router = useRouter()
  const [error, setError] = React.useState('')
  const [message, setMessage] = React.useState('')
  const formik = useFormik({
    initialValues: {
      org_slug: org?.slug,
      org_id: org?.id,
      email: '',
      password: '',
      username: '',
      bio: '',
      first_name: '',
      last_name: '',
    },
    validate,
    enableReinitialize: true,
    onSubmit: async (values) => {
      setError('')
      setMessage('')
      setIsSubmitting(true)
      let res = await signUpWithInviteCode(values, props.inviteCode)
      let message = await res.json()
      if (res.status == 200) {
        //router.push(`/login`);
        setMessage('Your account was successfully created')
        setIsSubmitting(false)
      } else if (
        res.status == 401 ||
        res.status == 400 ||
        res.status == 404 ||
        res.status == 409
      ) {
        setError(message.detail)
        setIsSubmitting(false)
      } else {
        setError('Something went wrong')
        setIsSubmitting(false)
      }
    },
  })

  useEffect(() => { }, [org])

  return (
    <div className="login-form m-auto w-72">
      {error && (
        <div className="flex justify-center bg-red-200 rounded-md text-red-950 space-x-2 items-center p-4 transition-all shadow-xs">
          <AlertTriangle size={18} />
          <div className="font-bold text-sm">{error}</div>
        </div>
      )}
      {message && (
        <div className="flex flex-col space-y-4 justify-center bg-green-200 rounded-md text-green-950 space-x-2 items-center p-4 transition-all shadow-xs">
          <div className="flex space-x-2">
            <Check size={18} />
            <div className="font-bold text-sm">{message}</div>
          </div>
          <hr className="border-green-900/20 800 w-40 border" />
          <Link className="flex space-x-2 items-center" href={
            `/login?orgslug=${org?.slug}`
          } >
            <User size={14} /> <div>Login to your account</div>
          </Link>
        </div>
      )}
      <FormLayout onSubmit={formik.handleSubmit}>
        <FormField name="email">
          <FormLabelAndMessage label="Email" message={formik.errors.email} />
          <Form.Control asChild>
            <Input
              onChange={formik.handleChange}
              value={formik.values.email}
              type="email"
              required
            />
          </Form.Control>
        </FormField>
        {/* for password  */}
        <FormField name="password">
          <FormLabelAndMessage
            label="Password"
            message={formik.errors.password}
          />

          <Form.Control asChild>
            <Input
              onChange={formik.handleChange}
              value={formik.values.password}
              type="password"
              required
            />
          </Form.Control>
        </FormField>
        {/* for username  */}
        <FormField name="username">
          <FormLabelAndMessage
            label="Username"
            message={formik.errors.username}
          />

          <Form.Control asChild>
            <Input
              onChange={formik.handleChange}
              value={formik.values.username}
              type="text"
              required
            />
          </Form.Control>
        </FormField>

        {/* for bio  */}
        <FormField name="bio">
          <FormLabelAndMessage label="Bio" message={formik.errors.bio} />

          <Form.Control asChild>
            <Textarea
              onChange={formik.handleChange}
              value={formik.values.bio}
              required
            />
          </Form.Control>
        </FormField>

        <div className="flex  py-4">
          <Form.Submit asChild>
            <button className="w-full bg-black text-white font-bold text-center p-2 rounded-md shadow-md hover:cursor-pointer">
              {isSubmitting ? 'Loading...' : 'Create an account & Join'}
            </button>
          </Form.Submit>
        </div>
      </FormLayout>
      <div>
        <div className='flex h-0.5 rounded-2xl bg-slate-100 mt-5 mb-5 mx-10'></div>
        <button onClick={() => signIn('google')} className="flex justify-center py-3 text-md w-full bg-white text-slate-600 space-x-3 font-semibold text-center p-2 rounded-md shadow-sm hover:cursor-pointer">
          <img src="https://fonts.gstatic.com/s/i/productlogos/googleg/v6/24px.svg" alt="" />
          <span>Sign in with Google</span>
        </button>
      </div>
    </div>
  )
}

export default InviteOnlySignUpComponent



================================================
FILE: apps/web/app/auth/signup/OpenSignup.tsx
================================================
'use client'
import { useFormik } from 'formik'
import { useRouter } from 'next/navigation'
import React, { useEffect } from 'react'
import FormLayout, {
  FormField,
  FormLabelAndMessage,
  Input,
  Textarea,
} from '@components/Objects/StyledElements/Form/Form'
import * as Form from '@radix-ui/react-form'
import { AlertTriangle, Check, User } from 'lucide-react'
import Link from 'next/link'
import { signup } from '@services/auth/auth'
import { useOrg } from '@components/Contexts/OrgContext'
import { signIn } from 'next-auth/react'

const validate = (values: any) => {
  const errors: any = {}

  if (!values.email) {
    errors.email = 'Required'
  } else if (!/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i.test(values.email)) {
    errors.email = 'Invalid email address'
  }

  if (!values.password) {
    errors.password = 'Required'
  } else if (values.password.length < 8) {
    errors.password = 'Password must be at least 8 characters'
  }

  if (!values.username) {
    errors.username = 'Required'
  }

  if (!values.username || values.username.length < 4) {
    errors.username = 'Username must be at least 4 characters'
  }

  if (!values.bio) {
    errors.bio = 'Required'
  }

  return errors
}

function OpenSignUpComponent() {
  const [isSubmitting, setIsSubmitting] = React.useState(false)
  const org = useOrg() as any
  const router = useRouter()
  const [error, setError] = React.useState('')
  const [message, setMessage] = React.useState('')
  const formik = useFormik({
    initialValues: {
      org_slug: org?.slug,
      org_id: org?.id,
      email: '',
      password: '',
      username: '',
      bio: '',
      first_name: '',
      last_name: '',
    },
    validate,
    enableReinitialize: true,
    onSubmit: async (values) => {
      setError('')
      setMessage('')
      setIsSubmitting(true)
      let res = await signup(values)
      let message = await res.json()
      if (res.status == 200) {
        //router.push(`/login`);
        setMessage('Your account was successfully created')
        setIsSubmitting(false)
      } else if (
        res.status == 401 ||
        res.status == 400 ||
        res.status == 404 ||
        res.status == 409
      ) {
        setError(message.detail)
        setIsSubmitting(false)
      } else {
        setError('Something went wrong')
        setIsSubmitting(false)
      }
    },
  })

  useEffect(() => { }, [org])

  return (
    <div className="login-form m-auto w-72">
      {error && (
        <div className="flex justify-center bg-red-200 rounded-md text-red-950 space-x-2 items-center p-4 transition-all shadow-xs">
          <AlertTriangle size={18} />
          <div className="font-bold text-sm">{error}</div>
        </div>
      )}
      {message && (
        <div className="flex flex-col space-y-4 justify-center bg-green-200 rounded-md text-green-950 space-x-2 items-center p-4 transition-all shadow-xs">
          <div className="flex space-x-2">
            <Check size={18} />
            <div className="font-bold text-sm">{message}</div>
          </div>
          <hr className="border-green-900/20 800 w-40 border" />
          <Link className="flex space-x-2 items-center" href={'/login'}>
            <User size={14} /> <div>Login </div>
          </Link>
        </div>
      )}
      <FormLayout onSubmit={formik.handleSubmit}>
        <FormField name="email">
          <FormLabelAndMessage label="Email" message={formik.errors.email} />
          <Form.Control asChild>
            <Input
              onChange={formik.handleChange}
              value={formik.values.email}
              type="email"
              required
            />
          </Form.Control>
        </FormField>
        {/* for password  */}
        <FormField name="password">
          <FormLabelAndMessage
            label="Password"
            message={formik.errors.password}
          />

          <Form.Control asChild>
            <Input
              onChange={formik.handleChange}
              value={formik.values.password}
              type="password"
              required
            />
          </Form.Control>
        </FormField>
        {/* for username  */}
        <FormField name="username">
          <FormLabelAndMessage
            label="Username"
            message={formik.errors.username}
          />

          <Form.Control asChild>
            <Input
              onChange={formik.handleChange}
              value={formik.values.username}
              type="text"
              required
            />
          </Form.Control>
        </FormField>

        {/* for bio  */}
        <FormField name="bio">
          <FormLabelAndMessage label="Bio" message={formik.errors.bio} />

          <Form.Control asChild>
            <Textarea
              onChange={formik.handleChange}
              value={formik.values.bio}
              required
            />
          </Form.Control>
        </FormField>

        <div className="flex  py-4">
          <Form.Submit asChild>
            <button className="w-full bg-black text-white font-bold text-center p-2 rounded-md shadow-md hover:cursor-pointer">
              {isSubmitting ? 'Loading...' : 'Create an account'}
            </button>
          </Form.Submit>
        </div>
      </FormLayout>
      <div>
        <div className='flex h-0.5 rounded-2xl bg-slate-100 mt-5 mb-5 mx-10'></div>
        <button onClick={() => signIn('google')} className="flex justify-center py-3 text-md w-full bg-white text-slate-600 space-x-3 font-semibold text-center p-2 rounded-md shadow-sm hover:cursor-pointer">
          <img src="https://fonts.gstatic.com/s/i/productlogos/googleg/v6/24px.svg" alt="" />
          <span>Sign in with Google</span>
        </button>
      </div>
    </div>
  )
}

export default OpenSignUpComponent



================================================
FILE: apps/web/app/auth/signup/page.tsx
================================================
import { Metadata } from 'next'
import { getOrganizationContextInfo } from '@services/organizations/orgs'
import SignUpClient from './signup'
import { Suspense } from 'react'
import PageLoading from '@components/Objects/Loaders/PageLoading'

type MetadataProps = {
  params: Promise<{ orgslug: string; courseid: string }>
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>
}

export async function generateMetadata(
  params
    : MetadataProps): Promise<Metadata> {
  const orgslug = (await params.searchParams).orgslug
  // Get Org context information
  const org = await getOrganizationContextInfo(orgslug, {
    revalidate: 0,
    tags: ['organizations'],
  })

  return {
    title: 'Sign up' + ` â€” ${org.name}`,
  }
}

const SignUp = async (params: any) => {
  const orgslug = (await params.searchParams).orgslug
  const org = await getOrganizationContextInfo(orgslug, {
    revalidate: 0,
    tags: ['organizations'],
  })

  return (
    <>
      <Suspense fallback={<PageLoading />}>
        <SignUpClient org={org} />
      </Suspense>
    </>
  )
}
export default SignUp



================================================
FILE: apps/web/app/auth/signup/signup.tsx
================================================
'use client'
import learnhouseIcon from 'public/learnhouse_bigicon_1.png'
import Image from 'next/image'
import { getOrgLogoMediaDirectory } from '@services/media/media'
import Link from 'next/link'
import { getUriWithOrg, getUriWithoutOrg } from '@services/config/config'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import React, { useEffect } from 'react'
import { MailWarning, Ticket, UserPlus } from 'lucide-react'
import { useOrg } from '@components/Contexts/OrgContext'
import UserAvatar from '@components/Objects/UserAvatar'
import OpenSignUpComponent from './OpenSignup'
import InviteOnlySignUpComponent from './InviteOnlySignUp'
import { useRouter, useSearchParams } from 'next/navigation'
import { validateInviteCode } from '@services/organizations/invites'
import PageLoading from '@components/Objects/Loaders/PageLoading'
import Toast from '@components/Objects/StyledElements/Toast/Toast'
import toast from 'react-hot-toast'
import { BarLoader } from 'react-spinners'
import { joinOrg } from '@services/organizations/orgs'

interface SignUpClientProps {
  org: any
}

function SignUpClient(props: SignUpClientProps) {
  const session = useLHSession() as any
  const [joinMethod, setJoinMethod] = React.useState('open')
  const [inviteCode, setInviteCode] = React.useState('')
  const searchParams = useSearchParams()
  const inviteCodeParam = searchParams.get('inviteCode')

  useEffect(() => {
    if (props.org.config) {
      setJoinMethod(
        props.org?.config?.config?.features.members.signup_mode
      )
    }
    if (inviteCodeParam) {
      setInviteCode(inviteCodeParam)
    }
  }, [props.org, inviteCodeParam])

  return (
    <div className="grid grid-flow-col justify-stretch h-screen">
      <div
        className="right-login-part"
        style={{
          background:
            'linear-gradient(041.61deg, #202020 7.15%, #000000 90.96%)',
        }}
      >
        <div className="login-topbar m-10">
          <Link prefetch href={getUriWithOrg(props.org.slug, '/')}>
            <Image
              quality={100}
              width={30}
              height={30}
              src={learnhouseIcon}
              alt=""
            />
          </Link>
        </div>
        <div className="ml-10 h-3/4 flex flex-row text-white">
          <div className="m-auto flex space-x-4 items-center flex-wrap">
            <div>You've been invited to join </div>
            <div className="shadow-[0px_4px_16px_rgba(0,0,0,0.02)]">
              {props.org?.logo_image ? (
                <img
                  src={`${getOrgLogoMediaDirectory(
                    props.org.org_uuid,
                    props.org?.logo_image
                  )}`}
                  alt="LearnHouse"
                  style={{ width: 'auto', height: 70 }}
                  className="rounded-xl shadow-xl inset-0 ring-1 ring-inset ring-black/10 bg-white"
                />
              ) : (
                <Image
                  quality={100}
                  width={70}
                  height={70}
                  src={learnhouseIcon}
                  alt=""
                />
              )}
            </div>
            <div className="font-bold text-xl">{props.org?.name}</div>
          </div>
        </div>
      </div>
      <div className="left-join-part bg-white flex flex-row">
        {joinMethod == 'open' &&
          (session.status == 'authenticated' ? (
            <LoggedInJoinScreen inviteCode={inviteCode} />
          ) : (
            <OpenSignUpComponent />
          ))}
        {joinMethod == 'inviteOnly' &&
          (inviteCode ? (
            session.status == 'authenticated' ? (
              <LoggedInJoinScreen inviteCode={inviteCode} />
            ) : (
              <InviteOnlySignUpComponent inviteCode={inviteCode} />
            )
          ) : (
            <NoTokenScreen />
          ))}
      </div>
    </div>
  )
}

const LoggedInJoinScreen = (props: any) => {
  const session = useLHSession() as any
  const org = useOrg() as any
  const invite_code = props.inviteCode
  const [isLoading, setIsLoading] = React.useState(true)
  const [isSumbitting, setIsSubmitting] = React.useState(false)
  const router = useRouter()

  const join = async () => {
    setIsSubmitting(true)
    const res = await joinOrg({ org_id: org.id, user_id: session?.data?.user?.id, invite_code: props.inviteCode }, null, session.data?.tokens?.access_token)
    //wait for 1s
    if (res.success) {
      toast.success(
        res.data
      )
      setTimeout(() => {
        router.push(getUriWithOrg(org.slug,'/'))
      }, 2000)
      setIsSubmitting(false)
    } else {
      toast.error(res.data.detail)
      setIsLoading(false)
      setIsSubmitting(false)
    }

  }

  useEffect(() => {
    if (session && org) {
      setIsLoading(false)
    }
  }, [org, session])

  return (
    <div className="flex flex-row  items-center mx-auto">
       <Toast />
      <div className="flex space-y-7 flex-col justify-center items-center">
        <p className="pt-3 text-2xl font-semibold text-black/70 flex justify-center space-x-2 items-center">
          <span className="items-center">Hi</span>
          <span className="capitalize flex space-x-2 items-center">
            <UserAvatar rounded="rounded-xl" border="border-4" width={35} />
            <span>{session.data.username},</span>
          </span>
          <span>join {org?.name} ?</span>
        </p>
        <button onClick={() => join()} className="flex w-fit h-[35px] space-x-2 bg-black px-6 py-2 text-md rounded-lg font-semibold h-fit text-white items-center shadow-md">
          {isSumbitting ? <BarLoader
            cssOverride={{ borderRadius: 60 }}
            width={60}
            color="#ffffff"
          /> : <><UserPlus size={18} />
            <p>Join </p></>}
        </button>
      </div>
    </div>
  )
}

const NoTokenScreen = (props: any) => {
  const session = useLHSession() as any
  const org = useOrg() as any
  const router = useRouter()
  const [isLoading, setIsLoading] = React.useState(true)
  const [inviteCode, setInviteCode] = React.useState('')
  const [messsage, setMessage] = React.useState('bruh')

  const handleInviteCodeChange = (e: any) => {
    setInviteCode(e.target.value)
  }

  const validateCode = async () => {
    setIsLoading(true)
    let res = await validateInviteCode(org?.id, inviteCode, session?.user?.tokens.access_token)
    //wait for 1s
    if (res.success) {
      toast.success(
        "Invite code is valid, you'll be redirected to the signup page in a few seconds"
      )
      setTimeout(() => {
        router.push(getUriWithoutOrg(`/signup?inviteCode=${inviteCode}&orgslug=${org.slug}`))
      }, 2000)
    } else {
      toast.error('Invite code is invalid')
      setIsLoading(false)
    }
  }

  useEffect(() => {
    if (session && org) {
      setIsLoading(false)
    }
  }, [org, session])

  return (
    <div className="flex flex-row  items-center mx-auto">
      <Toast />
      {isLoading ? (
        <div className="flex space-y-7 flex-col w-[300px] justify-center items-center">
          <PageLoading />
        </div>
      ) : (
        <div className="flex space-y-7 flex-col justify-center items-center">
          <p className="flex space-x-2 text-lg font-medium text-red-800 items-center">
            <MailWarning size={18} />
            <span>An invite code is required to join {org?.name}</span>
          </p>
          <input
            onChange={handleInviteCodeChange}
            className="bg-white outline-2 outline outline-gray-200 rounded-lg px-5 w-[300px] h-[50px]"
            placeholder="Please enter an invite code"
            type="text"
          />
          <button
            onClick={validateCode}
            className="flex w-fit space-x-2 bg-black px-6 py-2 text-md rounded-lg font-semibold h-fit text-white items-center shadow-md"
          >
            <Ticket size={18} />
            <p>Submit </p>
          </button>
        </div>
      )}
    </div>
  )
}

export default SignUpClient



================================================
FILE: apps/web/app/editor/main.ts
================================================
export const EDITOR = 'main'



================================================
FILE: apps/web/app/editor/course/[courseid]/activity/[activityuuid]/edit/loading.tsx
================================================
import PageLoading from '@components/Objects/Loaders/PageLoading'

export default function Loading() {
  // Or a custom loading skeleton component
  return <PageLoading></PageLoading>
}


================================================
FILE: apps/web/app/editor/course/[courseid]/activity/[activityuuid]/edit/page.tsx
================================================

import { default as React } from 'react'
import { getCourseMetadata } from '@services/courses/courses'
import { Metadata } from 'next'
import { getActivityWithAuthHeader } from '@services/courses/activities'
import { getOrganizationContextInfoWithId } from '@services/organizations/orgs'
import EditorOptionsProvider from '@components/Contexts/Editor/EditorContext'
import AIEditorProvider from '@components/Contexts/AI/AIEditorContext'
import { nextAuthOptions } from 'app/auth/options'
import { getServerSession } from 'next-auth'
import EditorWrapper from '@components/Objects/Editor/EditorWrapper'


type MetadataProps = {
  params: Promise<{ orgslug: string; courseid: string; activityid: string }>
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>
}

export async function generateMetadata(props: MetadataProps): Promise<Metadata> {
  const params = await props.params;
  const session = await getServerSession(nextAuthOptions)
  const access_token = session?.tokens?.access_token
  // Get Org context information
  const course_meta = await getCourseMetadata(
    params.courseid,
    { revalidate: 60, tags: ['courses'] },
    access_token ? access_token : null
  )

  return {
    title: `Edit - ${course_meta.name} Activity`,
    description: course_meta.mini_description,
  }
}

const EditActivity = async (params: any) => {
  const session = await getServerSession(nextAuthOptions)
  const access_token = session?.tokens?.access_token
  const activityuuid = (await params.params).activityuuid
  const courseid = (await params.params).courseid
  const courseInfo = await getCourseMetadata(
    courseid,
    { revalidate: 0, tags: ['courses'] },
    access_token ? access_token : null
  )
  const activity = await getActivityWithAuthHeader(
    activityuuid,
    { revalidate: 0, tags: ['activities'] },
    access_token ? access_token : null
  )
  
  const org = await getOrganizationContextInfoWithId(courseInfo.org_id, {
    revalidate: 180,
    tags: ['organizations'],
  }, access_token)

  return (
    <EditorOptionsProvider options={{ isEditable: true }}>
      <AIEditorProvider>
        <EditorWrapper
          org={org}
          course={courseInfo}
          activity={activity}
          content={activity.content}
        ></EditorWrapper>
      </AIEditorProvider>
    </EditorOptionsProvider>
  )
}

export default EditActivity



================================================
FILE: apps/web/app/home/home.tsx
================================================
'use client'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import UserAvatar from '@components/Objects/UserAvatar';
import { getAPIUrl, getUriWithOrg, getUriWithoutOrg } from '@services/config/config';
import { swrFetcher } from '@services/utils/ts/requests';
import { ArrowRightCircle, Info } from 'lucide-react';
import { signOut } from 'next-auth/react';
import Image from 'next/image';
import Link from 'next/link';
import learnhouseIcon from 'public/learnhouse_bigicon_1.png'
import React, { useEffect } from 'react'
import useSWR from 'swr';

function HomeClient() {
  const session = useLHSession() as any;
  const access_token = session?.data?.tokens?.access_token;
  const { data: orgs } = useSWR(`${getAPIUrl()}orgs/user/page/1/limit/10`, (url) => swrFetcher(url, access_token))

  useEffect(() => {
  }, [session, orgs])
  return (
    <div className='flex flex-col'>

      <div className='flex space-x-4 mx-auto font-semibold text-3xl pt-16 items-center bg-black rounded-b-2xl'>
        <Image
          quality={100}
          width={60}
          height={60}
          src={learnhouseIcon}
          alt=""
        />
      </div>

      <div className='flex space-x-4 mx-auto font-semibold text-2xl pt-16 items-center'><span>Hello,</span> <UserAvatar /> <span className='capitalize'>{session?.data?.user.first_name} {session?.data?.user.last_name}</span></div>
      <div className='flex space-x-4 mx-auto font-semibold text-sm mt-12 items-center uppercase bg-slate-200 text-gray-600 px-3 py-2 rounded-md'>Your Organizations</div>
      {orgs && orgs.length == 0 && <div className='flex mx-auto my-5 space-x-3 bg-rose-200 rounded-lg px-3 py-2'>
        <Info />
        <span>It seems you're not part of an organization yet, join one to be able to see it here </span>
      </div>}
      <div className='flex mx-auto pt-10 rounded-lg'>
        {orgs && orgs.map((org: any) => (
          <Link href={getUriWithOrg(org.slug, '/')} key={org.id} className='flex space-x-2 mx-auto w-fit justify-between items-center outline outline-1 outline-slate-200 px-3 py-2 rounded-lg'>
            <div>{org.name}</div>
            <ArrowRightCircle />
          </Link>
        ))}
      </div>
      <div className='flex cursor-pointer space-x-4 mx-auto font-semibold text-2xl pt-16 items-center'><span onClick={() =>  signOut({ redirect: true, callbackUrl: getUriWithoutOrg('/') })}>Sign out</span></div>

    </div>
  )
}

export default HomeClient


================================================
FILE: apps/web/app/home/page.tsx
================================================
import React from 'react'
import HomeClient from './home'
import type { Metadata } from 'next'
 
export const metadata: Metadata = {
  title: 'Home',
}
function Home() {
  return (
    <div>
      <HomeClient/>
    </div>
  )
}

export default Home


================================================
FILE: apps/web/app/orgs/[orgslug]/layout.tsx
================================================
'use client';
import { use } from "react";
import { OrgProvider } from '@components/Contexts/OrgContext'
import NextTopLoader from 'nextjs-toploader';
import Toast from '@components/Objects/StyledElements/Toast/Toast'
import '@styles/globals.css'
import Onboarding from '@components/Objects/Onboarding/Onboarding';
import Footer from "@components/Footer/Footer";

export default function RootLayout(
  props: {
    children: React.ReactNode
    params: Promise<any>
  }
) {
  const params = use(props.params);

  const {
    children
  } = props;

  return (
    <div>
      <OrgProvider orgslug={params.orgslug}>
        <NextTopLoader color="#2e2e2e" initialPosition={0.3} height={4}  easing={'ease'} speed={500} showSpinner={false} />
        <Toast />
        <Onboarding />
        {children}
        <Footer />
      </OrgProvider>
    </div>
  )
}



================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/error.tsx
================================================
'use client' // Error components must be Client Components

import ErrorUI from '@components/Objects/StyledElements/Error/Error'
import { useEffect } from 'react'

export default function Error({
  error,
  reset,
}: {
  error: Error
  reset: () => void
}) {
  useEffect(() => {
    // Log the error to an error reporting service
    console.error(error)
  }, [error])

  return (
    <div>
      <ErrorUI></ErrorUI>
    </div>
  )
}



================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/layout.tsx
================================================
'use client';
import { use } from "react";
import '@styles/globals.css'
import { SessionProvider } from 'next-auth/react'
import Watermark from '@components/Objects/Watermark'
import { OrgMenu } from '@components/Objects/Menus/OrgMenu'

export default function RootLayout(
  props: {
    children: React.ReactNode
    params: Promise<any>
  }
) {
  const params = use(props.params);

  const {
    children
  } = props;

  return (
    <>
      <SessionProvider>
        <OrgMenu orgslug={params?.orgslug}></OrgMenu>
        {children}
        <Watermark />
      </SessionProvider>
    </>
  )
}



================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/loading.tsx
================================================
import PageLoading from '@components/Objects/Loaders/PageLoading'

export default function Loading() {
  return <PageLoading></PageLoading>
}



================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/page.tsx
================================================
export const dynamic = 'force-dynamic'
import { Metadata } from 'next'
import { getOrgCourses } from '@services/courses/courses'
import { getOrganizationContextInfo } from '@services/organizations/orgs'
import { getOrgCollections } from '@services/courses/collections'
import { getServerSession } from 'next-auth'
import { nextAuthOptions } from 'app/auth/options'
import { getOrgThumbnailMediaDirectory } from '@services/media/media'
import LandingClassic from '@components/Landings/LandingClassic'
import LandingCustom from '@components/Landings/LandingCustom'

type MetadataProps = {
  params: Promise<{ orgslug: string }>
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>
}

export async function generateMetadata(props: MetadataProps): Promise<Metadata> {
  const params = await props.params;
  // Get Org context information
  const org = await getOrganizationContextInfo(params.orgslug, {
    revalidate: 0,
    tags: ['organizations'],
  })

  // SEO
  return {
    title: `Home â€” ${org.name}`,
    description: org.description,
    robots: {
      index: true,
      follow: true,
      nocache: true,
      googleBot: {
        index: true,
        follow: true,
        'max-image-preview': 'large',
      },
    },
    openGraph: {
      title: `Home â€” ${org.name}`,
      description: org.description,
      type: 'website',
      images: [
        {
          url: getOrgThumbnailMediaDirectory(org?.org_uuid, org?.thumbnail_image),
          width: 800,
          height: 600,
          alt: org.name,
        },
      ],
    },
  }
}

const OrgHomePage = async (params: any) => {
  const orgslug = (await params.params).orgslug
  const session = await getServerSession(nextAuthOptions)
  const access_token = session?.tokens?.access_token
  const courses = await getOrgCourses(
    orgslug,
    { revalidate: 0, tags: ['courses'] },
    access_token ? access_token : null
  )
  const org = await getOrganizationContextInfo(orgslug, {
    revalidate: 0,
    tags: ['organizations'],
  })
  const org_id = org.id
  const collections = await getOrgCollections(
    org.id,
    access_token ? access_token : null,
    { revalidate: 0, tags: ['courses'] }
  )

  // Check if custom landing is enabled
  const hasCustomLanding = org.config?.config?.landing?.enabled 

  return (
    <div className="w-full">
      {hasCustomLanding ? (
        <LandingCustom 
          landing={org.config.config.landing}
          orgslug={orgslug}
        />
      ) : (
        <LandingClassic 
          courses={courses}
          collections={collections}
          orgslug={orgslug}
          org_id={org_id}
        />
      )}
    </div>
  )
}

export default OrgHomePage



================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/certificates/[uuid]/verify/page.tsx
================================================
import CertificateVerificationPage from '@components/Pages/Certificate/CertificateVerificationPage';
import React from 'react';

interface CertificateVerifyPageProps {
  params: Promise<{
    uuid: string;
  }>;
}

const CertificateVerifyPage: React.FC<CertificateVerifyPageProps> = async ({ params }) => {
  const { uuid } = await params;
  return <CertificateVerificationPage certificateUuid={uuid} />;
};

export default CertificateVerifyPage; 


================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/collection/[collectionid]/error.tsx
================================================
'use client' // Error components must be Client Components

import ErrorUI from '@components/Objects/StyledElements/Error/Error'
import { useEffect } from 'react'

export default function Error({
  error,
  reset,
}: {
  error: Error
  reset: () => void
}) {
  useEffect(() => {
    // Log the error to an error reporting service
    console.error(error)
  }, [error])

  return (
    <div>
      <ErrorUI></ErrorUI>
    </div>
  )
}



================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/collection/[collectionid]/loading.tsx
================================================
import PageLoading from '@components/Objects/Loaders/PageLoading'

export default function Loading() {
  return <PageLoading></PageLoading>
}



================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/collection/[collectionid]/page.tsx
================================================
import GeneralWrapperStyled from '@components/Objects/StyledElements/Wrappers/GeneralWrapper'
import { getUriWithOrg } from '@services/config/config'
import { getCollectionById } from '@services/courses/collections'
import { getCourseThumbnailMediaDirectory } from '@services/media/media'
import { getOrganizationContextInfo } from '@services/organizations/orgs'
import { nextAuthOptions } from 'app/auth/options'
import { Metadata } from 'next'
import { getServerSession } from 'next-auth'
import Link from 'next/link'

type MetadataProps = {
  params: Promise<{ orgslug: string; courseid: string; collectionid: string }>
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>
}

export async function generateMetadata(props: MetadataProps): Promise<Metadata> {
  const params = await props.params;
  const session = await getServerSession(nextAuthOptions)
  const access_token = session?.tokens?.access_token

  // Get Org context information
  const org = await getOrganizationContextInfo(params.orgslug, {
    revalidate: 1800,
    tags: ['organizations'],
  })
  const col = await getCollectionById(
    params.collectionid,
    access_token ? access_token : null,
    { revalidate: 0, tags: ['collections'] }
  )

  // SEO
  return {
    title: `Collection : ${col.name}  â€” ${org.name}`,
    description: `${col.description} `,
    robots: {
      index: true,
      follow: true,
      nocache: true,
      googleBot: {
        index: true,
        follow: true,
        'max-image-preview': 'large',
      },
    },
    openGraph: {
      title: `Collection : ${col.name}  â€” ${org.name}`,
      description: `${col.description} `,
      type: 'website',
    },
  }
}

const CollectionPage = async (params: any) => {
  const session = await getServerSession(nextAuthOptions)
  const access_token = session?.tokens?.access_token
  const org = await getOrganizationContextInfo((await params.params).orgslug, {
    revalidate: 1800,
    tags: ['organizations'],
  })
  const orgslug = (await params.params).orgslug
  const col = await getCollectionById(
    (await params.params).collectionid,
    access_token ? access_token : null,
    { revalidate: 0, tags: ['collections'] }
  )

  const removeCoursePrefix = (courseid: string) => {
    return courseid.replace('course_', '')
  }

  return (
    <GeneralWrapperStyled>
      <h2 className="text-sm font-bold text-gray-400">Collection</h2>
      <h1 className="text-3xl font-bold">{col.name}</h1>
      <br />
      <div className="home_courses flex flex-wrap">
        {col.courses.map((course: any) => (
          <div className="pr-8" key={course.course_uuid}>
            <Link
              href={getUriWithOrg(
                orgslug,
                '/course/' + removeCoursePrefix(course.course_uuid)
              )}
            >
              <div
                className="inset-0 ring-1 ring-inset ring-black/10 rounded-lg shadow-xl relative w-[249px] h-[131px] bg-cover"
                style={{
                  backgroundImage: `url(${getCourseThumbnailMediaDirectory(
                    org.org_uuid,
                    course.course_uuid,
                    course.thumbnail_image
                  )})`,
                }}
              ></div>
            </Link>
            <h2 className="font-bold text-lg w-[250px] py-2">{course.name}</h2>
          </div>
        ))}
      </div>
    </GeneralWrapperStyled>
  )
}

export default CollectionPage



================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/collections/loading.tsx
================================================
import PageLoading from '@components/Objects/Loaders/PageLoading'

export default function Loading() {
  // Or a custom loading skeleton component
  return <PageLoading></PageLoading>
}



================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/collections/page.tsx
================================================
import AuthenticatedClientElement from '@components/Security/AuthenticatedClientElement'
import TypeOfContentTitle from '@components/Objects/StyledElements/Titles/TypeOfContentTitle'
import GeneralWrapperStyled from '@components/Objects/StyledElements/Wrappers/GeneralWrapper'
import { getUriWithOrg } from '@services/config/config'
import { getOrganizationContextInfo } from '@services/organizations/orgs'
import { Metadata } from 'next'
import Link from 'next/link'
import CollectionThumbnail from '@components/Objects/Thumbnails/CollectionThumbnail'
import NewCollectionButton from '@components/Objects/StyledElements/Buttons/NewCollectionButton'
import { nextAuthOptions } from 'app/auth/options'
import { getServerSession } from 'next-auth'
import { getOrgCollections } from '@services/courses/collections'
import { getOrgThumbnailMediaDirectory } from '@services/media/media'
import ContentPlaceHolderIfUserIsNotAdmin from '@components/Objects/ContentPlaceHolder'

type MetadataProps = {
  params: Promise<{ orgslug: string; courseid: string }>
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>
}

export async function generateMetadata(props: MetadataProps): Promise<Metadata> {
  const params = await props.params;
  // Get Org context information
  const org = await getOrganizationContextInfo(params.orgslug, {
    revalidate: 0,
    tags: ['organizations'],
  })

  // SEO
  return {
    title: `Collections â€” ${org.name}`,
    description: `Collections of courses from ${org.name}`,
    robots: {
      index: true,
      follow: true,
      nocache: true,
      googleBot: {
        index: true,
        follow: true,
        'max-image-preview': 'large',
      },
    },
    openGraph: {
      title: `Collections â€” ${org.name}`,
      description: `Collections of courses from ${org.name}`,
      type: 'website',
      images: [
        {
          url: getOrgThumbnailMediaDirectory(org?.org_uuid, org?.thumbnail_image),
          width: 800,
          height: 600,
          alt: org.name,
        },
      ],
    },
  }
}

const CollectionsPage = async (params: any) => {
  const session = await getServerSession(nextAuthOptions)
  const access_token = session?.tokens?.access_token
  const orgslug = (await params.params).orgslug
  const org = await getOrganizationContextInfo(orgslug, {
    revalidate: 1800,
    tags: ['organizations'],
  })
  const org_id = org.id
  const collections = await getOrgCollections(
    org_id,
    access_token ? access_token : null,
    { revalidate: 0, tags: ['collections'] }
  )

  return (
    <GeneralWrapperStyled>
      <div className="flex flex-col space-y-4 mb-8">
        <div className="flex items-center justify-between">
          <TypeOfContentTitle title="Collections" type="col" />
          <AuthenticatedClientElement
            ressourceType="collections"
            action="create"
            checkMethod="roles"
            orgId={org_id}
          >
            <Link href={getUriWithOrg(orgslug, '/collections/new')}>
              <NewCollectionButton />
            </Link>
          </AuthenticatedClientElement>
        </div>
        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          {collections.map((collection: any) => (
            <div key={collection.collection_uuid} className="p-3">
              <CollectionThumbnail
                collection={collection}
                orgslug={orgslug}
                org_id={org_id}
              />
            </div>
          ))}
          {collections.length === 0 && (
            <div className="col-span-full flex justify-center items-center py-8">
              <div className="text-center">
                <div className="mb-4">
                  <svg
                    width="50"
                    height="50"
                    viewBox="0 0 295 295"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                    className="mx-auto"
                  >
                    <rect
                      opacity="0.51"
                      x="10"
                      y="10"
                      width="275"
                      height="275"
                      rx="75"
                      stroke="#4B5564"
                      strokeOpacity="0.15"
                      strokeWidth="20"
                    />
                    <path
                      d="M135.8 200.8V130L122.2 114.6L135.8 110.4V102.8L122.2 87.4L159.8 76V200.8L174.6 218H121L135.8 200.8Z"
                      fill="#4B5564"
                      fillOpacity="0.08"
                    />
                  </svg>
                </div>
                <h1 className="text-xl font-bold text-gray-600 mb-2">
                  No collections yet
                </h1>
                <p className="text-md text-gray-400">
                  <ContentPlaceHolderIfUserIsNotAdmin
                    text="Create a collection to add content"
                  />
                </p>
                <div className="mt-4 flex justify-center">
                  <AuthenticatedClientElement
                    checkMethod="roles"
                    ressourceType="collections"
                    action="create"
                    orgId={org_id}
                  >
                    <Link href={getUriWithOrg(orgslug, '/collections/new')}>
                      <NewCollectionButton />
                    </Link>
                  </AuthenticatedClientElement>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </GeneralWrapperStyled>
  )
}

export default CollectionsPage



================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/collections/new/page.tsx
================================================
'use client'
import { useRouter } from 'next/navigation'
import React, { useState } from 'react'
import { createCollection } from '@services/courses/collections'
import useSWR from 'swr'
import { getAPIUrl, getUriWithOrg } from '@services/config/config'
import { revalidateTags, swrFetcher } from '@services/utils/ts/requests'
import { useOrg } from '@components/Contexts/OrgContext'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { Loader2, Image as ImageIcon } from 'lucide-react'
import { toast } from 'react-hot-toast'
import { getCourseThumbnailMediaDirectory } from '@services/media/media'

function NewCollection(params: any) {
  const org = useOrg() as any
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token
  const orgslug = params.params.orgslug
  const [name, setName] = React.useState('')
  const [description, setDescription] = React.useState('')
  const [selectedCourses, setSelectedCourses] = React.useState([]) as any
  const [isSubmitting, setIsSubmitting] = useState(false)
  const router = useRouter()
  const { data: courses, error: error, isLoading } = useSWR(
    `${getAPIUrl()}courses/org_slug/${orgslug}/page/1/limit/10`,
    (url) => swrFetcher(url, access_token)
  )
  const [isPublic, setIsPublic] = useState('true')

  const handleVisibilityChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
    setIsPublic(e.target.value)
  }

  const handleNameChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    setName(event.target.value)
  }

  const handleDescriptionChange = (
    event: React.ChangeEvent<HTMLTextAreaElement>
  ) => {
    setDescription(event.target.value)
  }

  const handleSubmit = async (e: any) => {
    e.preventDefault()
    
    if (!name.trim()) {
      toast.error('Please enter a collection name')
      return
    }

    if (!description.trim()) {
      toast.error('Please enter a description')
      return
    }

    if (selectedCourses.length === 0) {
      toast.error('Please select at least one course')
      return
    }

    setIsSubmitting(true)
    try {
      const collection = {
        name: name.trim(),
        description: description.trim(),
        courses: selectedCourses,
        public: isPublic,
        org_id: org.id,
      }
      await createCollection(collection, session.data?.tokens?.access_token)
      await revalidateTags(['collections'], org.slug)
      toast.success('Collection created successfully!')
      router.push(getUriWithOrg(orgslug, '/collections'))
    } catch (error) {
      toast.error('Failed to create collection. Please try again.')
    } finally {
      setIsSubmitting(false)
    }
  }

  if (error) {
    return (
      <div className="flex items-center justify-center h-[60vh]">
        <div className="text-red-500">Failed to load courses. Please try again later.</div>
      </div>
    )
  }

  return (
    <div className="max-w-2xl mx-auto py-12 px-4">
      <div className="space-y-8">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Create New Collection</h1>
          <p className="mt-2 text-sm text-gray-600">
            Group your courses together in a collection to make them easier to find and manage.
          </p>
        </div>

        <form onSubmit={handleSubmit} className="space-y-6">
          <div className="space-y-4">
            <label className="block">
              <span className="text-sm font-medium text-gray-700">Collection Name</span>
              <input
                type="text"
                placeholder="Enter collection name"
                value={name}
                onChange={handleNameChange}
                className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                maxLength={100}
              />
            </label>

            <label className="block">
              <span className="text-sm font-medium text-gray-700">Visibility</span>
              <select
                onChange={handleVisibilityChange}
                className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                defaultValue={isPublic}
              >
                <option value="true">Public Collection - Visible to everyone</option>
                <option value="false">Private Collection - Only visible to organization members</option>
              </select>
            </label>

            <label className="block">
              <span className="text-sm font-medium text-gray-700">Description</span>
              <textarea
                placeholder="Enter collection description"
                value={description}
                onChange={handleDescriptionChange}
                rows={4}
                className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                maxLength={500}
              />
            </label>

            <div className="space-y-2">
              <span className="text-sm font-medium text-gray-700">Select Courses</span>
              {isLoading ? (
                <div className="flex items-center justify-center py-8">
                  <Loader2 className="w-6 h-6 animate-spin text-gray-500" />
                </div>
              ) : courses?.length === 0 ? (
                <p className="text-sm text-gray-500 py-4">No courses available. Create some courses first.</p>
              ) : (
                <div className="mt-2 border border-gray-200 rounded-lg bg-gray-50">
                  <div className="max-h-[400px] overflow-y-auto p-4 space-y-3 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-transparent hover:scrollbar-thumb-gray-400">
                    {courses?.map((course: any) => (
                      <label
                        key={course.id}
                        className="relative flex items-center p-4 bg-white rounded-md hover:bg-gray-50 transition cursor-pointer gap-4"
                      >
                        <input
                          type="checkbox"
                          id={course.id}
                          name={course.name}
                          value={course.id}
                          onChange={(e) => {
                            if (e.target.checked) {
                              setSelectedCourses([...selectedCourses, course.id])
                            } else {
                              setSelectedCourses(
                                selectedCourses.filter((id: any) => id !== course.id)
                              )
                            }
                          }}
                          className="h-4 w-4 text-blue-500 rounded border-gray-300 focus:ring-blue-500"
                        />
                        <div className="relative w-24 h-16 rounded-md overflow-hidden bg-gray-100 shrink-0">
                          {course.thumbnail_image ? (
                            <img
                              src={getCourseThumbnailMediaDirectory(org.org_uuid, course.course_uuid, course.thumbnail_image)}
                              alt={course.name}
                              className="object-cover"
                            />
                          ) : (
                            <div className="w-full h-full flex items-center justify-center">
                              <ImageIcon className="w-6 h-6 text-gray-400" />
                            </div>
                          )}
                        </div>
                        <div className="flex-1 min-w-0">
                          <h3 className="text-sm font-medium text-gray-900 truncate">{course.name}</h3>
                          {course.description && (
                            <p className="mt-1 text-xs text-gray-500 line-clamp-2">{course.description}</p>
                          )}
                        </div>
                      </label>
                    ))}
                  </div>
                  <div className="px-4 py-3 bg-gray-50 border-t border-gray-200">
                    <p className="text-xs text-gray-500">
                      Selected courses: {selectedCourses.length}
                    </p>
                  </div>
                </div>
              )}
            </div>
          </div>

          <div className="flex items-center justify-end space-x-4">
            <button
              type="button"
              onClick={() => router.back()}
              className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-hidden focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition"
            >
              Cancel
            </button>
            <button
              type="submit"
              disabled={isSubmitting}
              className="px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg shadow-xs hover:bg-blue-700 focus:outline-hidden focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
            >
              {isSubmitting && <Loader2 className="w-4 h-4 animate-spin" />}
              <span>{isSubmitting ? 'Creating...' : 'Create Collection'}</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  )
}

export default NewCollection



================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/course/[courseuuid]/course.tsx
================================================
'use client'
import Link from 'next/link'
import React, { useEffect, useState } from 'react'
import { getUriWithOrg, getAPIUrl } from '@services/config/config'
import PageLoading from '@components/Objects/Loaders/PageLoading'
import { swrFetcher } from '@services/utils/ts/requests'
import ActivityIndicators from '@components/Pages/Courses/ActivityIndicators'
import { useRouter } from 'next/navigation'
import GeneralWrapperStyled from '@components/Objects/StyledElements/Wrappers/GeneralWrapper'
import {
  getCourseThumbnailMediaDirectory,
} from '@services/media/media'
import { ArrowRight, Backpack, Check, File, StickyNote, Video, Square, Image as ImageIcon, Layers } from 'lucide-react'
import { useOrg } from '@components/Contexts/OrgContext'
import { CourseProvider } from '@components/Contexts/CourseContext'
import { useMediaQuery } from 'usehooks-ts'
import CoursesActions from '@components/Objects/Courses/CourseActions/CoursesActions'
import CourseActionsMobile from '@components/Objects/Courses/CourseActions/CourseActionsMobile'
import CourseAuthors from '@components/Objects/Courses/CourseAuthors/CourseAuthors'
import CourseBreadcrumbs from '@components/Pages/Courses/CourseBreadcrumbs'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import useSWR from 'swr'

const CourseClient = (props: any) => {
  const [learnings, setLearnings] = useState<any>([])
  const [expandedChapters, setExpandedChapters] = useState<{[key: string]: boolean}>({})
  const [activeThumbnailType, setActiveThumbnailType] = useState<'image' | 'video'>('image')
  const courseuuid = props.courseuuid
  const orgslug = props.orgslug
  const course = props.course
  const org = useOrg() as any
  const router = useRouter()
  const isMobile = useMediaQuery('(max-width: 768px)')
  const session = useLHSession() as any;
  const access_token = session?.data?.tokens?.access_token;

  // Add SWR for trail data
  const { data: trailData } = useSWR(
    `${getAPIUrl()}trail/org/${org?.id}/trail`,
    (url) => swrFetcher(url, access_token)
  );

  console.log(course)

  function getLearningTags() {
    if (!course?.learnings) {
      setLearnings([])
      return
    }

    try {
      // Try to parse as JSON (new format)
      const parsedLearnings = JSON.parse(course.learnings)
      if (Array.isArray(parsedLearnings)) {
        // New format: array of learning items with text and emoji
        setLearnings(parsedLearnings)
        return
      }
    } catch (e) {
      // Not valid JSON, continue to legacy format handling
    }

    // Legacy format: comma-separated string (changed from pipe-separated)
    const learningItems = course.learnings.split(',').map((text: string) => ({
      id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(),
      text: text.trim(), // Trim whitespace that might be present after commas
      emoji: 'ğŸ“' // Default emoji for legacy items
    }))
    
    setLearnings(learningItems)
  }

  useEffect(() => {
    getLearningTags()

    // Collapse chapters by default if more than 5 activities in total
    if (course?.chapters) {
      const totalActivities = course.chapters.reduce((sum: number, chapter: any) => sum + (chapter.activities?.length || 0), 0)
      const defaultExpanded: {[key: string]: boolean} = {}
      course.chapters.forEach((chapter: any, idx: number) => {
        // Always expand the first chapter
        defaultExpanded[chapter.chapter_uuid] = idx === 0 ? true : totalActivities <= 5
      })
      setExpandedChapters(defaultExpanded)
    }
  }, [org, course])

  const getActivityTypeLabel = (activityType: string) => {
    switch (activityType) {
      case 'TYPE_VIDEO':
        return 'Video'
      case 'TYPE_DOCUMENT':
        return 'Document'
      case 'TYPE_DYNAMIC':
        return 'Page'
      case 'TYPE_ASSIGNMENT':
        return 'Assignment'
      default:
        return 'Learning Material'
    }
  }

  const getActivityTypeBadgeColor = (activityType: string) => {
    switch (activityType) {
      case 'TYPE_VIDEO':
        return 'bg-neutral-100 text-neutral-500'
      case 'TYPE_DOCUMENT':
        return 'bg-neutral-100 text-neutral-500'
      case 'TYPE_DYNAMIC':
        return 'bg-neutral-100 text-neutral-500'
      case 'TYPE_ASSIGNMENT':
        return 'bg-neutral-100 text-neutral-500'
      default:
        return 'bg-neutral-100 text-neutral-500'
    }
  }

  const isActivityDone = (activity: any) => {
    const cleanCourseUuid = course.course_uuid?.replace('course_', '');
    const run = trailData?.runs?.find(
      (run: any) => {
        const cleanRunCourseUuid = run.course?.course_uuid?.replace('course_', '');
        return cleanRunCourseUuid === cleanCourseUuid;
      }
    );
    if (run) {
      return run.steps.find((step: any) => step.activity_id == activity.id)
    }
    return false
  }

  const isActivityCurrent = (activity: any) => {
    const activity_uuid = activity.activity_uuid.replace('activity_', '')
    if (props.current_activity && props.current_activity == activity_uuid) {
      return true
    }
    return false
  }

  return (
    <>
      {!course && !org ? (
        <PageLoading></PageLoading>
      ) : (
        <>
          <GeneralWrapperStyled>
            <CourseBreadcrumbs 
              course={course}
              orgslug={orgslug}
            />
            <div className="pb-2 pt-3 flex flex-col md:flex-row justify-between items-start md:items-center">
              <div>
                <h1 className="text-3xl md:text-3xl  font-bold">{course.name}</h1>
              </div>
            </div>

            <div className="flex flex-col md:flex-row gap-8 pt-2">
              <div className="w-full md:w-3/4 space-y-4">
                {(() => {
                  const showVideo = course.thumbnail_type === 'video' || (course.thumbnail_type === 'both' && activeThumbnailType === 'video');
                  const showImage = course.thumbnail_type === 'image' || (course.thumbnail_type === 'both' && activeThumbnailType === 'image') || !course.thumbnail_type;

                  if (showVideo && course.thumbnail_video) {
                    return (
                      <div className="relative inset-0 ring-1 ring-inset ring-black/10 rounded-lg shadow-xl w-full h-[200px] md:h-[400px]">
                        {course.thumbnail_type === 'both' && (
                          <div className="absolute top-3 right-3 z-10">
                            <div className="bg-black/20 backdrop-blur-sm rounded-lg p-1 flex space-x-1">
                              <button
                                onClick={() => setActiveThumbnailType('image')}
                                className={`flex items-center px-2 py-1 rounded-md text-xs font-medium transition-colors ${
                                  activeThumbnailType === 'image'
                                    ? 'bg-white/90 text-gray-900 shadow-sm'
                                    : 'text-white/80 hover:text-white hover:bg-white/10'
                                }`}
                              >
                                <ImageIcon size={12} className="mr-1" />
                                Image
                              </button>
                              <button
                                onClick={() => setActiveThumbnailType('video')}
                                className={`flex items-center px-2 py-1 rounded-md text-xs font-medium transition-colors ${
                                  activeThumbnailType === 'video'
                                    ? 'bg-white/90 text-gray-900 shadow-sm'
                                    : 'text-white/80 hover:text-white hover:bg-white/10'
                                }`}
                              >
                                <Video size={12} className="mr-1" />
                                Video
                              </button>
                            </div>
                          </div>
                        )}
                        <div className="w-full h-full">
                          <video
                            src={getCourseThumbnailMediaDirectory(
                              org?.org_uuid,
                              course?.course_uuid,
                              course?.thumbnail_video
                            )}
                            className="w-full h-full bg-black rounded-lg"
                            controls
                            autoPlay
                            muted
                            preload="metadata"
                            playsInline
                          />
                        </div>
                      </div>
                    );
                  } else if (showImage && course.thumbnail_image) {
                    return (
                      <div className="relative inset-0 ring-1 ring-inset ring-black/10 rounded-lg shadow-xl w-full h-[200px] md:h-[400px] bg-cover bg-center"
                        style={{
                          backgroundImage: `url(${getCourseThumbnailMediaDirectory(
                            org?.org_uuid,
                            course?.course_uuid,
                            course?.thumbnail_image
                          )})`,
                        }}
                      >
                        {course.thumbnail_type === 'both' && (
                          <div className="absolute top-3 right-3 z-10">
                            <div className="bg-black/20 backdrop-blur-sm rounded-lg p-1 flex space-x-1">
                              <button
                                onClick={() => setActiveThumbnailType('image')}
                                className={`flex items-center px-2 py-1 rounded-md text-xs font-medium transition-colors ${
                                  activeThumbnailType === 'image'
                                    ? 'bg-white/90 text-gray-900 shadow-sm'
                                    : 'text-white/80 hover:text-white hover:bg-white/10'
                                }`}
                              >
                                <ImageIcon size={12} className="mr-1" />
                                Image
                              </button>
                              <button
                                onClick={() => setActiveThumbnailType('video')}
                                className={`flex items-center px-2 py-1 rounded-md text-xs font-medium transition-colors ${
                                  activeThumbnailType === 'video'
                                    ? 'bg-white/90 text-gray-900 shadow-sm'
                                    : 'text-white/80 hover:text-white hover:bg-white/10'
                                }`}
                              >
                                <Video size={12} className="mr-1" />
                                Video
                              </button>
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  } else {
                    return (
                      <div
                        className="inset-0 ring-1 ring-inset ring-black/10 rounded-lg shadow-xl relative w-full h-[400px] bg-cover bg-center"
                        style={{
                          backgroundImage: `url('../empty_thumbnail.png')`,
                          backgroundSize: 'auto',
                        }}
                      ></div>
                    );
                  }
                })()}

                {(() => {
                  const cleanCourseUuid = course.course_uuid?.replace('course_', '');
                  const run = trailData?.runs?.find(
                    (run: any) => {
                      const cleanRunCourseUuid = run.course?.course_uuid?.replace('course_', '');
                      return cleanRunCourseUuid === cleanCourseUuid;
                    }
                  );
                  return run;
                })() && (
                  <ActivityIndicators
                    course_uuid={props.course.course_uuid}
                    orgslug={orgslug}
                    course={course}
                    trailData={trailData}
                  />
                )}

                <div className="course_metadata_left space-y-2">
                  <div className="">
                    <p className="py-5 whitespace-pre-line break-words w-full leading-relaxed tracking-normal text-pretty hyphens-auto">{course.about}</p>
                  </div>
                </div>
              </div>

              <div className='course_metadata_right w-full md:w-1/4 space-y-4'>
                {/* Actions Box */}
                <CoursesActions courseuuid={courseuuid} orgslug={orgslug} course={course} trailData={trailData} />
                
                {/* Authors & Updates Box */}
                <div className="bg-white shadow-md shadow-gray-300/25 outline outline-1 outline-neutral-200/40 rounded-lg overflow-hidden p-4">
                  <CourseProvider courseuuid={course.course_uuid}>
                    <CourseAuthors authors={course.authors} />
                  </CourseProvider>
                </div>
              </div>
            </div>

            {learnings.length > 0 && learnings[0]?.text !== 'null' && (
              <div className="w-full">
                <h2 className="py-5 text-xl md:text-2xl font-bold">What you will learn</h2>
                <div className="bg-white shadow-md shadow-gray-300/25 outline outline-1 outline-neutral-200/40 rounded-lg overflow-hidden px-5 py-5 space-y-2">
                  {learnings.map((learning: any) => {
                    // Handle both new format (object with text and emoji) and legacy format (string)
                    const learningText = typeof learning === 'string' ? learning : learning.text
                    const learningEmoji = typeof learning === 'string' ? null : learning.emoji
                    const learningId = typeof learning === 'string' ? learning : learning.id || learning.text
                    
                    if (!learningText) return null
                    
                    return (
                      <div
                        key={learningId}
                        className="flex space-x-2 items-center font-semibold text-gray-500"
                      >
                        <div className="px-2 py-2 rounded-full">
                          {learningEmoji ? (
                            <span>{learningEmoji}</span>
                          ) : (
                            <Check className="text-gray-400" size={15} />
                          )}
                        </div>
                        <p>{learningText}</p>
                        {learning.link && (
                          <a 
                            href={learning.link} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="text-blue-500 hover:underline text-sm"
                          >
                            <span className="sr-only">Link to {learningText}</span>
                            <ArrowRight size={14} />
                          </a>
                        )}
                      </div>
                    )
                  })}
                </div>
              </div>
            )}

            <div className="w-full my-5 mb-10">
              <h2 className="py-5 text-xl md:text-2xl font-bold">Course Lessons</h2>
              <div className="bg-white shadow-md shadow-gray-300/25 outline outline-1 outline-neutral-200/40 rounded-lg overflow-hidden">
                {course.chapters.map((chapter: any, idx: number) => {
                  const isExpanded = expandedChapters[chapter.chapter_uuid] ?? (idx === 0); // Default to expanded for first chapter
                  return (
                    <div key={chapter.chapter_uuid || `chapter-${chapter.name}`} className="">
                      <div 
                        className="flex items-start py-4 px-4 outline outline-1 outline-neutral-200/40 font-bold bg-neutral-50 text-neutral-600 cursor-pointer hover:bg-neutral-100 transition-colors"
                        onClick={() => setExpandedChapters(prev => ({
                          ...prev,
                          [chapter.chapter_uuid]: !isExpanded
                        }))}
                      >
                        {/* Chevron on the far left, vertically centered with the title */}
                        <div className="flex flex-col justify-center mr-3 pt-1">
                          <svg 
                            className={`w-5 h-5 transition-transform ${isExpanded ? 'rotate-180' : ''}`} 
                            fill="none" 
                            stroke="currentColor" 
                            viewBox="0 0 24 24"
                          >
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                          </svg>
                        </div>
                        {/* Title and badge column */}
                        <div className="flex flex-col items-start w-full">
                          <div className="flex items-center flex-wrap mb-1 w-full min-w-0">
                            {/* Numbered badge */}
                            <span className="flex items-center justify-center w-5 h-5 rounded-full bg-neutral-200 text-neutral-600 text-xs font-semibold mr-2 border border-neutral-300 flex-shrink-0">
                              {idx + 1}
                            </span>
                            <h3 className="text-lg font-bold leading-tight truncate min-w-0 sm:text-base md:text-lg" style={{lineHeight: '1.2'}}>{chapter.name}</h3>
                          </div>
                          <div className="flex items-center space-x-1 text-sm text-neutral-400 font-normal">
                            <Layers size={16} className="mr-1" />
                            <span>{chapter.activities.length} Activities</span>
                          </div>
                        </div>
                      </div>
                      <div className={`transition-all duration-200 ${isExpanded ? 'block' : 'hidden'}`}>
                        <div className="">
                          {chapter.activities.map((activity: any) => {
                            return (
                              <Link
                                key={activity.activity_uuid}
                                href={
                                  getUriWithOrg(orgslug, '') +
                                  `/course/${courseuuid}/activity/${activity.activity_uuid.replace('activity_', '')}`
                                }
                                rel="noopener noreferrer"
                                prefetch={false}
                                className="block group activity-container transition-all duration-200 px-4 py-4"
                              >
                                <div className="flex space-x-3 items-center">
                                  <div className="flex items-center">
                                    {isActivityDone(activity) ? (
                                      <div className="relative cursor-pointer">
                                        <Square size={16} className="stroke-[2] text-teal-600" />
                                        <Check size={16} className="stroke-[2.5] text-teal-600 absolute top-0 left-0" />
                                      </div>
                                    ) : (
                                      <div className="text-neutral-300 cursor-pointer">
                                        <Square size={16} className="stroke-[2]" />
                                      </div>
                                    )}
                                  </div>
                                  <div className="flex flex-col grow">
                                    <div className="flex items-center space-x-2 w-full">
                                      <p className="font-semibold text-neutral-600 group-hover:text-neutral-800 transition-colors">{activity.name}</p>
                                      {isActivityCurrent(activity) && (
                                        <div className="flex items-center space-x-1 text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full text-xs font-semibold animate-pulse">
                                          <span>Current</span>
                                        </div>
                                      )}
                                    </div>
                                    <div className="flex items-center space-x-1.5 mt-0.5 text-neutral-400">
                                      {activity.activity_type === 'TYPE_DYNAMIC' && (
                                        <StickyNote size={10} />
                                      )}
                                      {activity.activity_type === 'TYPE_VIDEO' && (
                                        <Video size={10} />
                                      )}
                                      {activity.activity_type === 'TYPE_DOCUMENT' && (
                                        <File size={10} />
                                      )}
                                      {activity.activity_type === 'TYPE_ASSIGNMENT' && (
                                        <Backpack size={10} />
                                      )}
                                      <span className="text-xs font-medium">{getActivityTypeLabel(activity.activity_type)}</span>
                                    </div>
                                  </div>
                                  <div className="text-neutral-300 group-hover:text-neutral-400 transition-colors cursor-pointer">
                                    <ArrowRight size={14} />
                                  </div>
                                </div>
                              </Link>
                            )
                          })}
                        </div>
                      </div>
                    </div>
                  )
                })}
              </div>
            </div>
          </GeneralWrapperStyled>
          
          {/* Mobile Actions Box */}
          {isMobile && (
            <CourseActionsMobile courseuuid={courseuuid} orgslug={orgslug} course={course} trailData={trailData} />
          )}
        </>
      )}
    </>
  )
}

export default CourseClient


================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/course/[courseuuid]/error.tsx
================================================
'use client' // Error components must be Client Components

import { useEffect } from 'react'

export default function Error({
  error,
  reset,
}: {
  error: Error
  reset: () => void
}) {
  useEffect(() => {
    // Log the error to an error reporting service
    console.error(error)
  }, [error])

  return (
    <div>
      
    </div>
  )
}



================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/course/[courseuuid]/page.tsx
================================================
import React from 'react'
import CourseClient from './course'
import { getCourseMetadata } from '@services/courses/courses'
import { getOrganizationContextInfo } from '@services/organizations/orgs'
import { Metadata } from 'next'
import { getCourseThumbnailMediaDirectory } from '@services/media/media'
import { nextAuthOptions } from 'app/auth/options'
import { getServerSession } from 'next-auth'

type MetadataProps = {
  params: Promise<{ orgslug: string; courseuuid: string }>
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>
}

export async function generateMetadata(props: MetadataProps): Promise<Metadata> {
  const params = await props.params;
  const session = await getServerSession(nextAuthOptions)
  const access_token = session?.tokens?.access_token

  // Get Org context information
  const org = await getOrganizationContextInfo(params.orgslug, {
    revalidate: 1800,
    tags: ['organizations'],
  })
  const course_meta = await getCourseMetadata(
    params.courseuuid,
    { revalidate: 60, tags: ['courses'] },
    access_token ? access_token : null
  )

  // SEO
  return {
    title: course_meta.name + ` â€” ${org.name}`,
    description: course_meta.description,
    keywords: course_meta.learnings,
    robots: {
      index: true,
      follow: true,
      nocache: true,
      googleBot: {
        index: true,
        follow: true,
        'max-image-preview': 'large',
      },
    },
    openGraph: {
      title: course_meta.name + ` â€” ${org.name}`,
      description: course_meta.description ? course_meta.description : '',
      images: [
        {
          url: getCourseThumbnailMediaDirectory(
            org?.org_uuid,
            course_meta?.course_uuid,
            course_meta?.thumbnail_image
          ),
          width: 800,
          height: 600,
          alt: course_meta.name,
        },
      ],
      type: 'article',
      publishedTime: course_meta.creation_date ? course_meta.creation_date : '',
      tags: course_meta.learnings ? course_meta.learnings : [],
    },
  }
}

const CoursePage = async (params: any) => {
  const session = await getServerSession(nextAuthOptions)
  const access_token = session?.tokens?.access_token

  // Await params before using them
  const { courseuuid, orgslug } = await params.params

  // Fetch course metadata once
  const course_meta = await getCourseMetadata(
    courseuuid,
    { revalidate: 0, tags: ['courses'] },
    access_token ? access_token : null
  )

  return (
    <CourseClient
      courseuuid={courseuuid}
      orgslug={orgslug}
      course={course_meta}
      access_token={access_token}
    />
  )
}

export default CoursePage



================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/course/[courseuuid]/activity/[activityid]/error.tsx
================================================
'use client' // Error components must be Client Components

import ErrorUI from '@components/Objects/StyledElements/Error/Error'
import { useEffect } from 'react'

export default function Error({
  error,
  reset,
}: {
  error: Error
  reset: () => void
}) {
  useEffect(() => {
    // Log the error to an error reporting service
    console.error(error)
  }, [error])

  return (
    <div>
      <ErrorUI></ErrorUI>
    </div>
  )
}



================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/course/[courseuuid]/activity/[activityid]/loading.tsx
================================================
import PageLoading from '@components/Objects/Loaders/PageLoading'

export default function Loading() {
  // Or a custom loading skeleton component
  return <PageLoading></PageLoading>
}



================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/course/[courseuuid]/activity/[activityid]/page.tsx
================================================
import { getActivityWithAuthHeader } from '@services/courses/activities'
import { getCourseMetadata } from '@services/courses/courses'
import ActivityClient from './activity'
import { getOrganizationContextInfo } from '@services/organizations/orgs'
import { Metadata } from 'next'
import { getServerSession } from 'next-auth'
import { nextAuthOptions } from 'app/auth/options'

type MetadataProps = {
  params: Promise<{ orgslug: string; courseuuid: string; activityid: string }>
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>
}

type Session = {
  tokens?: {
    access_token?: string
  }
}

// Add this function at the top level to avoid duplicate fetches
async function fetchCourseMetadata(courseuuid: string, access_token: string | null | undefined) {
  return await getCourseMetadata(
    courseuuid,
    { revalidate: 60, tags: ['courses'] },
    access_token || null
  )
}

export async function generateMetadata(props: MetadataProps): Promise<Metadata> {
  const params = await props.params;
  const session = await getServerSession(nextAuthOptions as any) as Session
  const access_token = session?.tokens?.access_token || null

  // Get Org context information
  const org = await getOrganizationContextInfo(params.orgslug, {
    revalidate: 1800,
    tags: ['organizations'],
  })
  const course_meta = await fetchCourseMetadata(params.courseuuid, access_token)
  const activity = await getActivityWithAuthHeader(
    params.activityid,
    { revalidate: 0, tags: ['activities'] },
    access_token || null
  )

  // Check if this is the course end page
  const isCourseEnd = params.activityid === 'end';
  const pageTitle = isCourseEnd ? `Congratulations â€” ${course_meta.name} Course` : activity.name + ` â€” ${course_meta.name} Course`;

  // SEO
  return {
    title: pageTitle,
    description: course_meta.description,
    keywords: course_meta.learnings,
    robots: {
      index: true,
      follow: true,
      nocache: true,
      googleBot: {
        index: true,
        follow: true,
        'max-image-preview': 'large',
      },
    },
    openGraph: {
      title: pageTitle,
      description: course_meta.description,
      publishedTime: course_meta.creation_date,
      tags: course_meta.learnings,
    },
  }
}

const ActivityPage = async (params: any) => {
  const session = await getServerSession(nextAuthOptions as any) as Session
  const access_token = session?.tokens?.access_token || null
  const activityid = (await params.params).activityid
  const courseuuid = (await params.params).courseuuid
  const orgslug = (await params.params).orgslug

  const [course_meta, activity] = await Promise.all([
    fetchCourseMetadata(courseuuid, access_token),
    getActivityWithAuthHeader(
      activityid,
      { revalidate: 0, tags: ['activities'] },
      access_token || null
    )
  ])

  return (
    <ActivityClient
      activityid={activityid}
      courseuuid={courseuuid}
      orgslug={orgslug}
      activity={activity}
      course={course_meta}
    />
  )
}

export default ActivityPage



================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/courses/courses.tsx
================================================
'use client'
import CreateCourseModal from '@components/Objects/Modals/Course/Create/CreateCourse'
import Modal from '@components/Objects/StyledElements/Modal/Modal'
import React from 'react'
import { useSearchParams } from 'next/navigation'
import GeneralWrapperStyled from '@components/Objects/StyledElements/Wrappers/GeneralWrapper'
import TypeOfContentTitle from '@components/Objects/StyledElements/Titles/TypeOfContentTitle'
import AuthenticatedClientElement from '@components/Security/AuthenticatedClientElement'
import CourseThumbnail from '@components/Objects/Thumbnails/CourseThumbnail'
import NewCourseButton from '@components/Objects/StyledElements/Buttons/NewCourseButton'
import useAdminStatus from '@components/Hooks/useAdminStatus'

interface CourseProps {
  orgslug: string
  courses: any
  org_id: string
}

function Courses(props: CourseProps) {
  const orgslug = props.orgslug
  const courses = props.courses
  const searchParams = useSearchParams()
  const isCreatingCourse = searchParams.get('new') ? true : false
  const [newCourseModal, setNewCourseModal] = React.useState(isCreatingCourse)
  const isUserAdmin = useAdminStatus() as any

  async function closeNewCourseModal() {
    setNewCourseModal(false)
  }

  return (
    <div className="w-full">
      <GeneralWrapperStyled>
        <div className="flex flex-col space-y-2 mb-2">
          <div className="flex items-center justify-between">
            <TypeOfContentTitle title="Courses" type="cou" />
            <AuthenticatedClientElement
              checkMethod="roles"
              action="create"
              ressourceType="courses"
              orgId={props.org_id}
            >
              <Modal
                isDialogOpen={newCourseModal}
                onOpenChange={setNewCourseModal}
                minHeight="md"
                dialogContent={
                  <CreateCourseModal
                    closeModal={closeNewCourseModal}
                    orgslug={orgslug}
                  />
                }
                dialogTitle="Create Course"
                dialogDescription="Create a new course"
                dialogTrigger={
                  <button>
                    <NewCourseButton />
                  </button>
                }
              />
            </AuthenticatedClientElement>
          </div>

          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            {courses.map((course: any) => (
              <div key={course.course_uuid} className="p-3">
                <CourseThumbnail course={course} orgslug={orgslug} />
              </div>
            ))}
            {courses.length === 0 && (
              <div className="col-span-full flex justify-center items-center py-8">
                <div className="text-center">
                  <div className="mb-4">
                    <svg
                      width="50"
                      height="50"
                      viewBox="0 0 295 295"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                      className="mx-auto"
                    >
                      {/* ... SVG content ... */}
                    </svg>
                  </div>
                  <h1 className="text-xl font-bold text-gray-600 mb-2">
                    No courses yet
                  </h1>
                  <p className="text-md text-gray-400">
                    {isUserAdmin ? (
                      "Create a course to add content"
                    ) : (
                      "No courses available yet"
                    )}
                  </p>
                  {isUserAdmin && (
                    <div className="mt-4">
                      <AuthenticatedClientElement
                        action="create"
                        ressourceType="courses"
                        checkMethod="roles"
                        orgId={props.org_id}
                      >
                        <Modal
                          isDialogOpen={newCourseModal}
                          onOpenChange={setNewCourseModal}
                          minHeight="md"
                          dialogContent={
                            <CreateCourseModal
                              closeModal={closeNewCourseModal}
                              orgslug={orgslug}
                            />
                          }
                          dialogTitle="Create Course"
                          dialogDescription="Create a new course"
                          dialogTrigger={
                            <button>
                              <NewCourseButton />
                            </button>
                          }
                        />
                      </AuthenticatedClientElement>
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        </div>
      </GeneralWrapperStyled>
    </div>
  )
}

export default Courses



================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/courses/error.tsx
================================================
'use client' // Error components must be Client Components

import ErrorUI from '@components/Objects/StyledElements/Error/Error'
import { useEffect } from 'react'

export default function Error({
  error,
  reset,
}: {
  error: Error
  reset: () => void
}) {
  useEffect(() => {
    // Log the error to an error reporting service
    console.error(error)
  }, [error])

  return (
    <div>
      <ErrorUI></ErrorUI>
    </div>
  )
}



================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/courses/loading.tsx
================================================
import PageLoading from '@components/Objects/Loaders/PageLoading'

export default function Loading() {
  // Or a custom loading skeleton component
  return <PageLoading></PageLoading>
}



================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/courses/page.tsx
================================================
import React from 'react'
import Courses from './courses'
import { Metadata } from 'next'
import { getOrganizationContextInfo } from '@services/organizations/orgs'
import { nextAuthOptions } from 'app/auth/options'
import { getServerSession } from 'next-auth'
import { getOrgCourses } from '@services/courses/courses'
import { getOrgThumbnailMediaDirectory } from '@services/media/media'

type MetadataProps = {
  params: Promise<{ orgslug: string }>
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>
}

export async function generateMetadata(props: MetadataProps): Promise<Metadata> {
  const params = await props.params;
  // Get Org context information
  const org = await getOrganizationContextInfo(params.orgslug, {
    revalidate: 0,
    tags: ['organizations'],
  })

  // SEO
  return {
    title: 'Courses â€” ' + org.name,
    description: org.description,
    keywords: `${org.name}, ${org.description}, courses, learning, education, online learning, edu, online courses, ${org.name} courses`,
    robots: {
      index: true,
      follow: true,
      nocache: true,
      googleBot: {
        index: true,
        follow: true,
        'max-image-preview': 'large',
      },
    },
    openGraph: {
      title: 'Courses â€” ' + org.name,
      description: org.description,
      type: 'website',
      images: [
        {
          url: getOrgThumbnailMediaDirectory(org?.org_uuid, org?.thumbnail_image),
          width: 800,
          height: 600,
          alt: org.name,
        },
      ],
    },
  }
}

const CoursesPage = async (params: any) => {
  const orgslug = (await params.params).orgslug
  const org = await getOrganizationContextInfo(orgslug, {
    revalidate: 1800,
    tags: ['organizations'],
  })
  const session = await getServerSession(nextAuthOptions)
  const access_token = session?.tokens?.access_token

  const courses = await getOrgCourses(
    orgslug,
    { revalidate: 0, tags: ['courses'] },
    access_token ? access_token : null
  )

  return (
    <div>
      <Courses org_id={org.org_id} orgslug={orgslug} courses={courses} />
    </div>
  )
}

export default CoursesPage



================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/search/page.tsx
================================================
'use client'; 

import React, { useState, useEffect } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';
import { searchOrgContent } from '@services/search/search';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import { useOrg } from '@components/Contexts/OrgContext';
import { Book, GraduationCap, Users, Search } from 'lucide-react';
import Link from 'next/link';
import { getCourseThumbnailMediaDirectory, getUserAvatarMediaDirectory } from '@services/media/media';
import { getUriWithOrg } from '@services/config/config';
import { removeCoursePrefix } from '@components/Objects/Thumbnails/CourseThumbnail';
import UserAvatar from '@components/Objects/UserAvatar';

// Types from SearchBar component
interface User {
  username: string;
  first_name: string;
  last_name: string;
  email: string;
  avatar_image: string;
  bio: string;
  details: Record<string, any>;
  profile: Record<string, any>;
  id: number;
  user_uuid: string;
}

interface Author {
  user: User;
  authorship: string;
  authorship_status: string;
  creation_date: string;
  update_date: string;
}

interface Course {
  name: string;
  description: string;
  about: string;
  learnings: string;
  tags: string;
  thumbnail_image: string;
  public: boolean;
  open_to_contributors: boolean;
  id: number;
  org_id: number;
  authors: Author[];
  course_uuid: string;
  creation_date: string;
  update_date: string;
}

interface Collection {
  name: string;
  public: boolean;
  description: string;
  id: number;
  courses: string[];
  collection_uuid: string;
  creation_date: string;
  update_date: string;
}

interface SearchResults {
  courses: Course[];
  collections: Collection[];
  users: User[];
  total_courses: number;
  total_collections: number;
  total_users: number;
}

type ContentType = 'all' | 'courses' | 'collections' | 'users';

function SearchPage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const session = useLHSession() as any;
  const org = useOrg() as any;
  
  // Search state
  const [searchResults, setSearchResults] = useState<SearchResults>({
    courses: [],
    collections: [],
    users: [],
    total_courses: 0,
    total_collections: 0,
    total_users: 0
  });
  const [isLoading, setIsLoading] = useState(false);
  const [searchQuery, setSearchQuery] = useState(searchParams.get('q') || '');
  
  // URL parameters
  const query = searchParams.get('q') || '';
  const page = parseInt(searchParams.get('page') || '1');
  const type = (searchParams.get('type') as ContentType) || 'all';
  const perPage = 9;

  // Filter state
  const [selectedType, setSelectedType] = useState<ContentType>(type);

  const updateSearchParams = (updates: Record<string, string>) => {
    const current = new URLSearchParams(Array.from(searchParams.entries()));
    Object.entries(updates).forEach(([key, value]) => {
      if (value) {
        current.set(key, value);
      } else {
        current.delete(key);
      }
    });
    router.push(`?${current.toString()}`);
  };

  const handleSearch = (e: React.FormEvent) => {
    e.preventDefault();
    if (searchQuery.trim()) {
      updateSearchParams({ q: searchQuery, page: '1' });
    }
  };

  useEffect(() => {
    setSearchQuery(query);
  }, [query]);

  useEffect(() => {
    const fetchResults = async () => {
      if (!query.trim()) {
        setSearchResults({
          courses: [],
          collections: [],
          users: [],
          total_courses: 0,
          total_collections: 0,
          total_users: 0
        });
        return;
      }

      setIsLoading(true);
      try {
        const response = await searchOrgContent(
          org?.slug,
          query,
          page,
          perPage,
          selectedType === 'all' ? null : selectedType,
          session?.data?.tokens?.access_token
        );

        // Log the response to see what we're getting
        console.log('Search API Response:', response);

        // The response data is directly what we need
        const results = response.data;
        
        setSearchResults({
          courses: results.courses || [],
          collections: results.collections || [],
          users: results.users || [],
          total_courses: results.courses?.length || 0,
          total_collections: results.collections?.length || 0,
          total_users: results.users?.length || 0
        });
      } catch (error) {
        console.error('Error searching content:', error);
        setSearchResults({
          courses: [],
          collections: [],
          users: [],
          total_courses: 0,
          total_collections: 0,
          total_users: 0
        });
      }
      setIsLoading(false);
    };

    fetchResults();
  }, [query, page, selectedType, org?.slug, session?.data?.tokens?.access_token]);

  const totalResults = searchResults.total_courses + searchResults.total_collections + searchResults.total_users;
  const totalPages = Math.ceil(totalResults / perPage);

  const FilterButton = ({ type, count, icon: Icon }: { type: ContentType; count: number; icon: any }) => (
    <button
      onClick={() => {
        setSelectedType(type);
        updateSearchParams({ type: type === 'all' ? '' : type, page: '1' });
      }}
      className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm transition-colors ${
        selectedType === type
          ? 'bg-black/10 text-black/80 font-medium'
          : 'hover:bg-black/5 text-black/60'
      }`}
    >
      <Icon size={16} />
      <span>{type.charAt(0).toUpperCase() + type.slice(1)}</span>
      <span className="text-black/40">({count})</span>
    </button>
  );

  const Pagination = () => {
    if (totalPages <= 1) return null;

    return (
      <div className="flex justify-center gap-2 mt-8">
        {Array.from({ length: totalPages }, (_, i) => i + 1).map((pageNum) => (
          <button
            key={pageNum}
            onClick={() => updateSearchParams({ page: pageNum.toString() })}
            className={`w-8 h-8 rounded-lg text-sm transition-colors ${
              page === pageNum
                ? 'bg-black/10 text-black/80 font-medium'
                : 'hover:bg-black/5 text-black/60'
            }`}
          >
            {pageNum}
          </button>
        ))}
      </div>
    );
  };

  const LoadingState = () => (
    <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
      {[1, 2, 3, 4, 5, 6].map((i) => (
        <div key={i} className="bg-white rounded-xl nice-shadow p-4 animate-pulse">
          <div className="w-full h-32 bg-black/5 rounded-lg mb-4" />
          <div className="space-y-2">
            <div className="w-3/4 h-4 bg-black/5 rounded" />
            <div className="w-1/2 h-3 bg-black/5 rounded" />
          </div>
        </div>
      ))}
    </div>
  );

  const EmptyState = () => (
    <div className="flex flex-col items-center justify-center py-16 text-center">
      <div className="mb-4 p-4 bg-black/5 rounded-full">
        <Search className="w-8 h-8 text-black/40" />
      </div>
      <h3 className="text-lg font-medium text-black/80 mb-2">No results found</h3>
      <p className="text-sm text-black/50 max-w-md">
        We couldn't find any matches for "{query}". Try adjusting your search terms or browse our featured content.
      </p>
    </div>
  );

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Search Header */}
      <div className="bg-white border-b border-black/5">
        <div className="container mx-auto px-4 py-6">
          <div className="max-w-2xl mx-auto">
            <h1 className="text-2xl font-semibold  text-black/80 mb-6">Search</h1>
            
            {/* Search Input */}
            <form onSubmit={handleSearch} className="relative group mb-6">
              <input
                type="text"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                placeholder="Search courses, users, collections..."
                className="w-full h-12 pl-12 pr-4 rounded-xl nice-shadow bg-white 
                         focus:outline-none focus:ring-1 focus:ring-black/5 focus:border-black/20 
                         text-sm placeholder:text-black/40 transition-all"
              />
              <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <Search className="text-black/40 group-focus-within:text-black/60 transition-colors" size={20} />
              </div>
              <button
                type="submit"
                className="absolute inset-y-0 right-0 px-4 flex items-center text-sm text-black/60 hover:text-black/80"
              >
                Search
              </button>
            </form>
            
            {/* Filters */}
            <div className="flex items-center gap-2 overflow-x-auto pb-2">
              <FilterButton type="all" count={totalResults} icon={Search} />
              <FilterButton type="courses" count={searchResults.total_courses} icon={GraduationCap} />
              <FilterButton type="collections" count={searchResults.total_collections} icon={Book} />
              <FilterButton type="users" count={searchResults.total_users} icon={Users} />
            </div>
          </div>
        </div>
      </div>

      {/* Search Results */}
      <div className="container mx-auto px-4 py-8">
        <div className="max-w-7xl mx-auto">
          {query && (
            <div className="text-sm text-black/60 mb-6">
              Found {totalResults} results for "{query}"
            </div>
          )}

          {isLoading ? (
            <LoadingState />
          ) : totalResults === 0 && query ? (
            <EmptyState />
          ) : (
            <div className="space-y-12">
              {/* Courses Grid */}
              {(selectedType === 'all' || selectedType === 'courses') && searchResults.courses.length > 0 && (
                <div>
                  <h2 className="text-lg font-medium text-black/80 mb-4 flex items-center gap-2">
                    <GraduationCap size={20} className="text-black/60" />
                    Courses ({searchResults.courses.length})
                  </h2>
                  <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                    {searchResults.courses.map((course) => (
                      <Link
                        key={course.course_uuid}
                        href={getUriWithOrg(org?.slug, `/course/${removeCoursePrefix(course.course_uuid)}`)}
                        className="bg-white rounded-xl nice-shadow hover:shadow-md transition-all overflow-hidden group"
                      >
                        <div className="relative h-48">
                          {course.thumbnail_image ? (
                            <img
                              src={getCourseThumbnailMediaDirectory(org?.org_uuid, course.course_uuid, course.thumbnail_image)}
                              alt={course.name}
                              className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                            />
                          ) : (
                            <div className="w-full h-full bg-black/5 flex items-center justify-center">
                              <GraduationCap size={32} className="text-black/40" />
                            </div>
                          )}
                        </div>
                        <div className="p-4">
                          <h3 className="text-sm font-medium text-black/80 mb-1">{course.name}</h3>
                          <p className="text-xs text-black/50 line-clamp-2">{course.description}</p>
                          {course.authors && course.authors.length > 0 && (
                            <div className="flex items-center gap-2 mt-3">
                              <UserAvatar
                                width={20}
                                avatar_url={course.authors[0].user.avatar_image ? getUserAvatarMediaDirectory(course.authors[0].user.user_uuid, course.authors[0].user.avatar_image) : ''}
                                predefined_avatar={course.authors[0].user.avatar_image ? undefined : 'empty'}
                                userId={course.authors[0].user.id.toString()}
                                showProfilePopup={false}
                                rounded="rounded-full"
                                backgroundColor="bg-gray-100"
                              />
                              <span className="text-xs text-black/40">
                                {course.authors[0].user.first_name} {course.authors[0].user.last_name}
                              </span>
                            </div>
                          )}
                        </div>
                      </Link>
                    ))}
                  </div>
                </div>
              )}

              {/* Collections Grid */}
              {(selectedType === 'all' || selectedType === 'collections') && searchResults.collections.length > 0 && (
                <div>
                  <h2 className="text-lg font-medium text-black/80 mb-4 flex items-center gap-2">
                    <Book size={20} className="text-black/60" />
                    Collections ({searchResults.collections.length})
                  </h2>
                  <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                    {searchResults.collections.map((collection) => (
                      <Link
                        key={collection.collection_uuid}
                        href={getUriWithOrg(org?.slug, `/collection/${collection.collection_uuid.replace('collection_', '')}`)}
                        className="flex items-start gap-4 p-4 bg-white rounded-xl nice-shadow hover:shadow-md transition-all"
                      >
                        <div className="w-12 h-12 bg-black/5 rounded-lg flex items-center justify-center flex-shrink-0">
                          <Book size={24} className="text-black/40" />
                        </div>
                        <div>
                          <h3 className="text-sm font-medium text-black/80 mb-1">{collection.name}</h3>
                          <p className="text-xs text-black/50 line-clamp-2">{collection.description}</p>
                        </div>
                      </Link>
                    ))}
                  </div>
                </div>
              )}

              {/* Users Grid */}
              {(selectedType === 'all' || selectedType === 'users') && searchResults.users.length > 0 && (
                <div>
                  <h2 className="text-lg font-medium text-black/80 mb-4 flex items-center gap-2">
                    <Users size={20} className="text-black/60" />
                    Users ({searchResults.users.length})
                  </h2>
                  <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                    {searchResults.users.map((user) => (
                      <Link
                        key={user.user_uuid}
                        href={getUriWithOrg(org?.slug, `/user/${user.username}`)}
                        className="flex items-center gap-4 p-4 bg-white rounded-xl nice-shadow hover:shadow-md transition-all"
                      >
                        <UserAvatar
                          width={48}
                          avatar_url={user.avatar_image ? getUserAvatarMediaDirectory(user.user_uuid, user.avatar_image) : ''}
                          predefined_avatar={user.avatar_image ? undefined : 'empty'}
                          userId={user.id.toString()}
                          showProfilePopup
                          rounded="rounded-full"
                          backgroundColor="bg-gray-100"
                        />
                        <div>
                          <h3 className="text-sm font-medium text-black/80">
                            {user.first_name} {user.last_name}
                          </h3>
                          <p className="text-xs text-black/50">@{user.username}</p>
                          {user.details?.title?.text && (
                            <p className="text-xs text-black/40 mt-1">{user.details.title.text}</p>
                          )}
                        </div>
                      </Link>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}

          <Pagination />
        </div>
      </div>
    </div>
  );
}

export default SearchPage;


================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/trail/page.tsx
================================================
import React from 'react'
import { Metadata } from 'next'
import { getOrganizationContextInfo } from '@services/organizations/orgs'
import Trail from './trail'
import { getServerSession } from 'next-auth'
import { nextAuthOptions } from 'app/auth/options'

type MetadataProps = {
  params: Promise<{ orgslug: string }>
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>
}

export async function generateMetadata(props: MetadataProps): Promise<Metadata> {
  const params = await props.params;
  const session = await getServerSession(nextAuthOptions)
  const access_token = session?.tokens?.access_token
  // Get Org context information
  const org = await getOrganizationContextInfo(params.orgslug, {
    revalidate: 1800,
    tags: ['organizations'],
  }, access_token)
  return {
    title: 'Trail â€” ' + org.name,
    description:
      'Check your progress using trail and easily navigate through your courses.',
  }
}

const TrailPage = async (params: any) => {
  let orgslug = (await params.params).orgslug

  return (
    <div>
      <Trail orgslug={orgslug} />
    </div>
  )
}

export default TrailPage



================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/trail/trail.tsx
================================================
'use client'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { useOrg } from '@components/Contexts/OrgContext'
import PageLoading from '@components/Objects/Loaders/PageLoading'
import TrailCourseElement from '@components/Pages/Trail/TrailCourseElement'
import UserCertificates from '@components/Pages/Trail/UserCertificates'
import TypeOfContentTitle from '@components/Objects/StyledElements/Titles/TypeOfContentTitle'
import GeneralWrapperStyled from '@components/Objects/StyledElements/Wrappers/GeneralWrapper'
import { getAPIUrl } from '@services/config/config'
import { swrFetcher } from '@services/utils/ts/requests'
import React, { useEffect, useState } from 'react'
import useSWR from 'swr'
import { removeCourse } from '@services/courses/activity'
import { revalidateTags } from '@services/utils/ts/requests'
import { useRouter } from 'next/navigation'
import ConfirmationModal from '@components/Objects/StyledElements/ConfirmationModal/ConfirmationModal'
import { BookOpen } from 'lucide-react'

function Trail(params: any) {
  let orgslug = params.orgslug
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token;
  const org = useOrg() as any
  const orgID = org?.id
  const router = useRouter()
  const [isQuittingAll, setIsQuittingAll] = useState(false)
  const [quittingProgress, setQuittingProgress] = useState(0)

  const { data: trail, error: error, mutate } = useSWR(
    `${getAPIUrl()}trail/org/${orgID}/trail`,
    (url) => swrFetcher(url, access_token)
  )

  const handleQuitAllCourses = async () => {
    if (!trail?.runs?.length || isQuittingAll) return;
    
    setIsQuittingAll(true)
    const totalCourses = trail.runs.length;

    try {
      for (let i = 0; i < trail.runs.length; i++) {
        const run = trail.runs[i];
        await removeCourse(run.course.course_uuid, orgslug, access_token);
        setQuittingProgress(Math.round(((i + 1) / totalCourses) * 100));
      }

      await revalidateTags(['courses'], orgslug);
      router.refresh();
      await mutate();
    } catch (error) {
      console.error('Error quitting courses:', error);
    } finally {
      setIsQuittingAll(false)
      setQuittingProgress(0)
    }
  }

  useEffect(() => { }, [trail, org])

  return (
    <GeneralWrapperStyled>
      <div className="flex justify-between items-center mb-6">
        <TypeOfContentTitle title="Trail" type="tra" />
        {trail?.runs?.length > 0 && (
          <ConfirmationModal
            confirmationButtonText={isQuittingAll ? `Quitting Courses (${quittingProgress}%)` : "Quit All Courses"}
            confirmationMessage="Are you sure you want to quit all courses? This action cannot be undone and you will lose all your progress."
            dialogTitle="Quit All Courses?"
            dialogTrigger={
              <button
                disabled={isQuittingAll}
                className={`px-4 py-2 rounded-lg font-medium text-sm transition-all
                  ${isQuittingAll 
                    ? 'bg-gray-100 text-gray-500 cursor-not-allowed' 
                    : 'bg-red-100 text-red-700 hover:bg-red-200'
                  }`}
              >
                {isQuittingAll 
                  ? `Quitting Courses (${quittingProgress}%)`
                  : 'Quit All Courses'
                }
              </button>
            }
            functionToExecute={handleQuitAllCourses}
            status="warning"
          />
        )}
      </div>
      
      <div className="space-y-8">
        {/* Progress Section */}
        <div className="bg-white rounded-xl shadow-sm p-6">
          <div className="flex items-center space-x-3 mb-6">
            <BookOpen className="w-6 h-6 text-blue-500" />
            <h2 className="text-xl font-semibold text-gray-900">My Progress</h2>
            {trail?.runs && (
              <span className="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
                {trail.runs.length}
              </span>
            )}
          </div>
          
          {!trail ? (
            <PageLoading></PageLoading>
          ) : trail.runs.length === 0 ? (
            <div className="text-center py-8">
              <BookOpen className="w-12 h-12 text-gray-300 mx-auto mb-3" />
              <p className="text-gray-500">No courses in progress</p>
              <p className="text-sm text-gray-400 mt-1">Start a course to see your progress here</p>
            </div>
          ) : (
            <div className="space-y-6">
              {trail.runs.map((run: any) => (
                <TrailCourseElement
                  key={run.course.course_uuid}
                  run={run}
                  course={run.course}
                  orgslug={orgslug}
                />
              ))}
            </div>
          )}
        </div>
        
        {/* Certificates Section */}
        <UserCertificates orgslug={orgslug} />
      </div>
    </GeneralWrapperStyled>
  )
}

export default Trail



================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/user/[username]/page.tsx
================================================
import React from 'react'
import { getUserByUsername } from '@services/users/users'
import { Metadata } from 'next'
import UserProfileClient from './UserProfileClient'

interface UserPageParams {
  username: string;
  orgslug: string;
}

interface UserPageProps {
  params: Promise<UserPageParams>;
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>;
}

export async function generateMetadata({ params }: UserPageProps): Promise<Metadata> {
  try {
    const resolvedParams = await params

    

    const userData = await getUserByUsername(resolvedParams.username)
    return {
      title: `${userData.first_name} ${userData.last_name} | Profile`,
      description: userData.bio || `Profile page of ${userData.first_name} ${userData.last_name}`,
    }
  } catch (error) {
    return {
      title: 'User Profile',
    }
  }
}

async function UserPage({ params }: UserPageProps) {
  const resolvedParams = await params;
  const { username } = resolvedParams;
  
  try {
    // Fetch user data by username
    const userData = await getUserByUsername(username);
    const profile = userData.profile ? (
      typeof userData.profile === 'string' ? JSON.parse(userData.profile) : userData.profile
    ) : { sections: [] };

    return (
      <div>
        <UserProfileClient
          userData={userData}
          profile={profile}
        />
      </div>
    )
  } catch (error) {
    console.error('Error fetching user data:', error)
    return (
      <div className="container mx-auto py-8">
        <div className="bg-white rounded-xl nice-shadow p-6">
          <p className="text-red-600">Error loading user profile</p>
        </div>
      </div>
    )
  }
}

export default UserPage


================================================
FILE: apps/web/app/orgs/[orgslug]/(withmenu)/user/[username]/UserProfileClient.tsx
================================================
'use client';

import React from 'react'
import UserAvatar from '@components/Objects/UserAvatar'
import { 
  Briefcase, 
  Building2, 
  MapPin, 
  Globe, 
  Link as LinkIcon, 
  GraduationCap,
  Award,
  BookOpen,
  Laptop2,
  Users,
  Calendar,
  Lightbulb,
  X
} from 'lucide-react'
import { getUserAvatarMediaDirectory } from '@services/media/media'
import { getCoursesByUser } from '@services/users/users'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import CourseThumbnailLanding from '@components/Objects/Thumbnails/CourseThumbnailLanding'

interface UserProfileClientProps {
  userData: any;
  profile: any;
}

const ICON_MAP = {
  'briefcase': Briefcase,
  'graduation-cap': GraduationCap,
  'map-pin': MapPin,
  'building-2': Building2,
  'speciality': Lightbulb,
  'globe': Globe,
  'laptop-2': Laptop2,
  'award': Award,
  'book-open': BookOpen,
  'link': LinkIcon,
  'users': Users,
  'calendar': Calendar,
} as const

// Add Modal component
const ImageModal: React.FC<{
  image: { url: string; caption?: string };
  onClose: () => void;
}> = ({ image, onClose }) => {
  return (
    <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
      <div className="relative max-w-4xl w-full">
        <button
          onClick={onClose}
          className="absolute -top-10 right-0 text-white hover:text-gray-300 transition-colors"
        >
          <X className="w-6 h-6" />
        </button>
        <img
          src={image.url}
          alt={image.caption || ''}
          className="w-full h-auto rounded-lg"
        />
        {image.caption && (
          <p className="mt-4 text-white text-center text-lg">{image.caption}</p>
        )}
      </div>
    </div>
  );
};

function UserProfileClient({ userData, profile }: UserProfileClientProps) {
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token
  const [selectedImage, setSelectedImage] = React.useState<{ url: string; caption?: string } | null>(null);
  const [userCourses, setUserCourses] = React.useState<any[]>([]);
  const [isLoadingCourses, setIsLoadingCourses] = React.useState(false);

  React.useEffect(() => {
    const fetchUserCourses = async () => {
      if (userData.id && access_token) {
        try {
          setIsLoadingCourses(true);
          const coursesData = await getCoursesByUser(userData.id, access_token);
          if (coursesData.data) {
            setUserCourses(coursesData.data);
          }
        } catch (error) {
          console.error('Error fetching user courses:', error);
        } finally {
          setIsLoadingCourses(false);
        }
      }
    };

    fetchUserCourses();
  }, [userData.id, access_token]);

  const IconComponent = ({ iconName }: { iconName: string }) => {
    const IconElement = ICON_MAP[iconName as keyof typeof ICON_MAP]
    if (!IconElement) return null
    return <IconElement className="w-4 h-4 text-gray-600" />
  }

  return (
    <div className="container mx-auto py-8">
      {/* Banner */}
      <div className="h-48 w-full bg-gray-100 rounded-t-xl mb-0 relative overflow-hidden">
        {/* Optional banner content */}
      </div>
      
      {/* Profile Content */}
      <div className="bg-white rounded-b-xl nice-shadow p-8 relative">
        {/* Avatar Positioned on the banner */}
        <div className="absolute -top-24 left-8">
          <div className="rounded-xl overflow-hidden shadow-lg border-4 border-white">
            <UserAvatar
              width={150}
              avatar_url={userData.avatar_image ? getUserAvatarMediaDirectory(userData.user_uuid, userData.avatar_image) : ''}
              predefined_avatar={userData.avatar_image ? undefined : 'empty'}
              userId={userData.id}
              showProfilePopup
              rounded="rounded-xl"
            />
          </div>
        </div>

        {/* Affiliation Logos */}
        <div className="absolute -top-12 right-8 flex items-center gap-4">
          {profile.sections?.map((section: any) => (
            section.type === 'affiliation' && section.affiliations?.map((affiliation: any, index: number) => (
              affiliation.logoUrl && (
                <div key={index} className="bg-white rounded-lg p-2 shadow-lg border-2 border-white">
                  <img 
                    src={affiliation.logoUrl} 
                    alt={affiliation.name}
                    className="w-16 h-16 object-contain"
                    title={affiliation.name}
                  />
                </div>
              )
            ))
          ))}
        </div>

        {/* Profile Content with right padding to avoid overlap */}
        <div className="mt-20 md:mt-14">
          <div className="flex flex-col md:flex-row gap-12">
            {/* Left column with details - aligned with avatar */}
            <div className="w-full md:w-1/6 pl-2">
              {/* Name */}
              <h1 className="text-[32px] font-bold mb-8">
                {userData.first_name} {userData.last_name}
              </h1>

              {/* Details */}
              <div className="flex flex-col space-y-3">
                {userData.details && Object.values(userData.details).map((detail: any) => (
                  <div key={detail.id} className="flex items-center gap-4">
                    <div className="flex-shrink-0">
                      <IconComponent iconName={detail.icon} />
                    </div>
                    <span className="text-gray-700 text-[15px] font-medium">{detail.text}</span>
                  </div>
                ))}
              </div>
            </div>

            {/* Right column with about and related content */}
            <div className="w-full md:w-4/6">
              <div className="mb-8">
                <h2 className="text-xl font-semibold mb-4">About</h2>
                {userData.bio ? (
                  <p className="text-gray-700">{userData.bio}</p>
                ) : (
                  <p className="text-gray-500 italic">No biography provided</p>
                )}
              </div>
              
              {/* Profile sections from profile builder */}
              {profile.sections && profile.sections.length > 0 && (
                <div>
                  {profile.sections.map((section: any, index: number) => (
                    <div key={index} className="mb-8">
                      <h2 className="text-xl font-semibold mb-4">{section.title}</h2>
                      
                      {/* Add Image Gallery section */}
                      {section.type === 'image-gallery' && (
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                          {section.images.map((image: any, imageIndex: number) => (
                            <div
                              key={imageIndex}
                              className="relative group cursor-pointer"
                              onClick={() => setSelectedImage(image)}
                            >
                              <img
                                src={image.url}
                                alt={image.caption || ''}
                                className="w-full h-48 object-cover rounded-lg"
                              />
                              {image.caption && (
                                <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity duration-200 rounded-lg flex items-center justify-center p-4">
                                  <p className="text-white text-center text-sm">{image.caption}</p>
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      )}
                      
                      {section.type === 'text' && (
                        <div className="prose max-w-none">{section.content}</div>
                      )}
                      
                      {section.type === 'links' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          {section.links.map((link: any, linkIndex: number) => (
                            <a
                              key={linkIndex}
                              href={link.url}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="flex items-center space-x-2 text-blue-600 hover:text-blue-800"
                            >
                              <LinkIcon className="w-4 h-4" />
                              <span>{link.title}</span>
                            </a>
                          ))}
                        </div>
                      )}
                      
                      {section.type === 'skills' && (
                        <div className="flex flex-wrap gap-2">
                          {section.skills.map((skill: any, skillIndex: number) => (
                            <span
                              key={skillIndex}
                              className="px-3 py-1 bg-gray-100 rounded-full text-sm"
                            >
                              {skill.name}
                              {skill.level && ` â€¢ ${skill.level}`}
                            </span>
                          ))}
                        </div>
                      )}
                      
                      {section.type === 'experience' && (
                        <div className="space-y-4">
                          {section.experiences.map((exp: any, expIndex: number) => (
                            <div key={expIndex} className="border-l-2 border-gray-200 pl-4">
                              <h3 className="font-medium">{exp.title}</h3>
                              <p className="text-gray-600">{exp.organization}</p>
                              <p className="text-sm text-gray-500">
                                {exp.startDate} - {exp.current ? 'Present' : exp.endDate}
                              </p>
                              {exp.description && (
                                <p className="mt-2 text-gray-700">{exp.description}</p>
                              )}
                            </div>
                          ))}
                        </div>
                      )}
                      
                      {section.type === 'education' && (
                        <div className="space-y-4">
                          {section.education.map((edu: any, eduIndex: number) => (
                            <div key={eduIndex} className="border-l-2 border-gray-200 pl-4">
                              <h3 className="font-medium">{edu.institution}</h3>
                              <p className="text-gray-600">{edu.degree} in {edu.field}</p>
                              <p className="text-sm text-gray-500">
                                {edu.startDate} - {edu.current ? 'Present' : edu.endDate}
                              </p>
                              {edu.description && (
                                <p className="mt-2 text-gray-700">{edu.description}</p>
                              )}
                            </div>
                          ))}
                        </div>
                      )}

                      {section.type === 'affiliation' && (
                        <div className="space-y-4">
                          {section.affiliations.map((affiliation: any, affIndex: number) => (
                            <div key={affIndex} className="border-l-2 border-gray-200 pl-4">
                              <div className="flex items-start gap-4">
                                {affiliation.logoUrl && (
                                  <img 
                                    src={affiliation.logoUrl} 
                                    alt={affiliation.name}
                                    className="w-12 h-12 object-contain"
                                  />
                                )}
                                <div>
                                  <h3 className="font-medium">{affiliation.name}</h3>
                                  {affiliation.description && (
                                    <p className="mt-2 text-gray-700">{affiliation.description}</p>
                                  )}
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      )}

                      {section.type === 'courses' && (
                        <div>
                          {isLoadingCourses ? (
                            <div className="flex items-center justify-center py-8">
                              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                            </div>
                          ) : userCourses.length > 0 ? (
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 auto-rows-fr">
                              {userCourses.map((course) => (
                                <div key={course.id} className="flex">
                                  <CourseThumbnailLanding
                                    course={course}
                                    orgslug={userData.org_slug || course.org_slug}
                                  />
                                </div>
                              ))}
                            </div>
                          ) : (
                            <div className="text-center py-8 text-gray-500">
                              No courses found
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      </div>

      {/* Image Modal */}
      {selectedImage && (
        <ImageModal
          image={selectedImage}
          onClose={() => setSelectedImage(null)}
        />
      )}
    </div>
  )
}

export default UserProfileClient 


================================================
FILE: apps/web/app/orgs/[orgslug]/dash/ClientAdminLayout.tsx
================================================
'use client';
import DashLeftMenu from '@components/Dashboard/Menus/DashLeftMenu';
import DashMobileMenu from '@components/Dashboard/Menus/DashMobileMenu';
import AdminAuthorization from '@components/Security/AdminAuthorization'
import { SessionProvider } from 'next-auth/react'
import React from 'react'
import { useMediaQuery } from 'usehooks-ts';

function ClientAdminLayout({
    children,
    params,
}: {
    children: React.ReactNode
    params: any
}) {
    const isMobile = useMediaQuery('(max-width: 768px)')

    return (
        <SessionProvider>
            <AdminAuthorization authorizationMode="page">
                <div className="flex flex-col md:flex-row">
                    {isMobile ? (
                        <DashMobileMenu />
                    ) : (
                        <DashLeftMenu />
                    )}
                    <div className="flex w-full">{children}</div>
                </div>
            </AdminAuthorization>
        </SessionProvider>
    )
}

export default ClientAdminLayout



================================================
FILE: apps/web/app/orgs/[orgslug]/dash/layout.tsx
================================================
import { Metadata } from 'next'
import React from 'react'
import ClientAdminLayout from './ClientAdminLayout'

export const metadata: Metadata = {
  title: 'LearnHouse Dashboard',
}

async function DashboardLayout(
  props: {
    children: React.ReactNode
    params: Promise<any>
  }
) {
  const params = await props.params;

  const {
    children
  } = props;

  return (
    <>
      <ClientAdminLayout
        params={params}>
        {children}
      </ClientAdminLayout>
    </>
  )
}

export default DashboardLayout



================================================
FILE: apps/web/app/orgs/[orgslug]/dash/page.tsx
================================================
import Image from 'next/image'
import React from 'react'
import learnhousetextlogo from '../../../../public/learnhouse_logo.png'
import { BookCopy, School, Settings, University, Users } from 'lucide-react'
import Link from 'next/link'
import AdminAuthorization from '@components/Security/AdminAuthorization'

function DashboardHome() {
  return (
    <div className="flex items-center justify-center mx-auto min-h-screen flex-col p-4 sm:mb-0 mb-16">
      <div className="mx-auto pb-6 sm:pb-10">
        <Image
          alt="learnhouse logo"
          width={230}
          src={learnhousetextlogo}
          className="w-48 sm:w-auto"
        />
      </div>
      <AdminAuthorization authorizationMode="component">
        <div className="flex flex-col sm:flex-row gap-4 lg:gap-10">
          {/* Card components */}
          <DashboardCard
            href="/dash/courses"
            icon={<BookCopy className="mx-auto text-gray-500/100" size={50} />}
            title="Courses"
            description="Create and manage courses, chapters and activities"
          />
          <DashboardCard
            href="/dash/org/settings/general"
            icon={<School className="mx-auto text-gray-500/100" size={50} />}
            title="Organization"
            description="Configure your Organization general settings"
          />
          <DashboardCard
            href="/dash/users/settings/users"
            icon={<Users className="mx-auto text-gray-500/100" size={50} />}
            title="Users"
            description="Manage your Organization's users, roles"
          />
        </div>
      </AdminAuthorization>
      <div className="flex flex-col gap-6 sm:gap-10 mt-6 sm:mt-10">
        <AdminAuthorization authorizationMode="component">
          <div className="h-1 w-[100px] bg-neutral-200/100 rounded-full mx-auto"></div>
          <div className="flex justify-center items-center">
            <Link
              href={'https://university.learnhouse.io/'}
              target='_blank'
              className="flex mt-4 sm:mt-[40px] bg-black gap-2 items-center py-3 px-7 rounded-lg shadow-lg hover:scale-105 transition-all ease-linear cursor-pointer"
            >
              <University className="text-gray-100/100" size={20} />
              <div className="text-sm font-bold text-gray-100/100">
                LearnHouse University
              </div>
            </Link>
          </div>
          <div className="mx-auto mt-4 sm:mt-[40px] w-28 h-1 bg-neutral-200/100 rounded-full"></div>
        </AdminAuthorization>

        <Link
          href={'/dash/user-account/settings/general'}
          className="flex bg-white shadow-lg p-4 items-center rounded-lg mx-auto hover:scale-105 transition-all ease-linear cursor-pointer max-w-md"
        >
          <div className="flex flex-col sm:flex-row mx-auto gap-2 sm:gap-3 items-center text-center sm:text-left">
            <Settings className="text-gray-500/100" size={20} />
            <div>
              <div className="font-bold text-gray-500/100">Account Settings</div>
              <p className="text-sm text-gray-400/100">
                Configure your personal settings, passwords, email
              </p>
            </div>
          </div>
        </Link>
      </div>
    </div>
  )
}

// New component for dashboard cards
function DashboardCard({ href, icon, title, description }: { href: string, icon: React.ReactNode, title: string, description: string }) {
  return (
    <Link
      href={href}
      className="flex bg-white shadow-lg p-6 w-full sm:w-[250px] rounded-lg items-center mx-auto hover:scale-105 transition-all ease-linear cursor-pointer"
    >
      <div className="flex flex-col mx-auto gap-2">
        {icon}
        <div className="text-center font-bold text-gray-500/100">{title}</div>
        <p className="text-center text-sm text-gray-400/100">{description}</p>
      </div>
    </Link>
  )
}

export default DashboardHome



================================================
FILE: apps/web/app/orgs/[orgslug]/dash/assignments/page.tsx
================================================
'use client';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import { useOrg } from '@components/Contexts/OrgContext';
import BreadCrumbs from '@components/Dashboard/Misc/BreadCrumbs'
import { getAPIUrl, getUriWithOrg } from '@services/config/config';
import { getAssignmentsFromACourse } from '@services/courses/assignments';
import { getCourseThumbnailMediaDirectory } from '@services/media/media';
import { swrFetcher } from '@services/utils/ts/requests';
import { EllipsisVertical, GalleryVerticalEnd, Info, Layers2, UserRoundPen } from 'lucide-react';
import Link from 'next/link';
import React from 'react'
import useSWR from 'swr';

function AssignmentsHome() {
  const session = useLHSession() as any;
  const access_token = session?.data?.tokens?.access_token;
  const org = useOrg() as any;
  const [courseAssignments, setCourseAssignments] = React.useState<any[]>([])

  const { data: courses } = useSWR(`${getAPIUrl()}courses/org_slug/${org?.slug}/page/1/limit/50`, (url) => swrFetcher(url, access_token))

  async function getAvailableAssignmentsForCourse(course_uuid: string) {
    const res = await getAssignmentsFromACourse(course_uuid, access_token)
    return res.data
  }

  function removeAssignmentPrefix(assignment_uuid: string) {
    return assignment_uuid.replace('assignment_', '')
  }

  function removeCoursePrefix(course_uuid: string) {
    return course_uuid.replace('course_', '')
  }


  React.useEffect(() => {
    if (courses) {
      const course_uuids = courses.map((course: any) => course.course_uuid)
      const courseAssignmentsPromises = course_uuids.map((course_uuid: string) => getAvailableAssignmentsForCourse(course_uuid))
      Promise.all(courseAssignmentsPromises).then((results) => {
        setCourseAssignments(results)
      })
    }
  }, [courses])


  return (
    <div className='flex w-full'>
      <div className='pl-4 sm:pl-10 mr-4 sm:mr-10 tracking-tighter flex flex-col space-y-5 w-full'>
        <div className='flex flex-col space-y-2'>
          <BreadCrumbs type="assignments" />
          <h1 className="pt-3 flex font-bold text-4xl">Assignments</h1>
        </div>
        <div className='flex flex-col space-y-3 w-full'>
          {courseAssignments.map((assignments: any, index: number) => (
            <div key={index} className='flex flex-col space-y-2 bg-white nice-shadow p-3 sm:p-4 rounded-xl w-full'>
              <div>
                <div className='flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 items-start sm:items-center justify-between w-full'>
                  <div className='flex space-x-2 items-center'>
                    <MiniThumbnail course={courses[index]} />
                    <div className='flex flex-col font-bold text-lg'>
                      <p className='bg-gray-200 text-gray-700 px-2 text-xs py-0.5 rounded-full w-fit'>Course</p>
                      <p>{courses[index].name}</p>
                    </div>
                  </div>
                  <Link
                    href={{
                      pathname: getUriWithOrg(org.slug, `/dash/courses/course/${removeCoursePrefix(courses[index].course_uuid)}/content`),
                      query: { subpage: 'editor' }
                    }}
                    prefetch
                    className='bg-black font-semibold text-sm text-zinc-100 rounded-md flex space-x-1.5 nice-shadow items-center px-3 py-1'>
                    <GalleryVerticalEnd size={15} />
                    <p>Course Editor</p>
                  </Link>
                </div>

                {assignments && assignments.map((assignment: any) => (
                  <div key={assignment.assignment_uuid} className='flex mt-3 p-2 sm:p-3 rounded flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full light-shadow justify-between bg-gray-50 items-start sm:items-center'>
                    <div className='flex flex-col sm:flex-row items-start sm:items-center space-y-1 sm:space-y-0 sm:space-x-2'>
                      <div className='flex text-xs font-bold bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full h-fit'>
                        <p>Assignment</p>
                      </div>
                      <div className='flex font-semibold text-lg'>{assignment.title}</div>
                      <div className='flex font-semibold text-gray-600 px-2 py-0.5 rounded outline outline-gray-200/70'>{assignment.description}</div>
                    </div>
                    <div className='flex space-x-2 font-bold text-sm items-center'>
                      <EllipsisVertical className='text-gray-500' size={17} />
                      <Link
                        href={{
                          pathname: getUriWithOrg(org.slug, `/dash/assignments/${removeAssignmentPrefix(assignment.assignment_uuid)}`),
                          query: { subpage: 'editor' }
                        }}
                        prefetch
                        className='bg-white rounded-full flex space-x-2 nice-shadow items-center px-3 py-0.5'>
                        <Layers2 size={15} />
                        <p>Editor</p>
                      </Link>
                      <Link
                        href={{
                          pathname: getUriWithOrg(org.slug, `/dash/assignments/${removeAssignmentPrefix(assignment.assignment_uuid)}`),
                          query: { subpage: 'submissions' }
                        }}
                        prefetch
                        className='bg-white rounded-full flex space-x-2 nice-shadow items-center px-3 py-0.5'>
                        <UserRoundPen size={15} />
                        <p>Submissions</p>
                      </Link>
                    </div>
                  </div>
                ))}

                {assignments.length === 0 && (
                  <>
                    <div className='flex mx-auto space-x-2 font-semibold mt-3 text-gray-600 items-center'>
                      <Info size={20} />
                      <p>No assignments available for this course, create course assignments from the course editor</p>
                    </div>
                  </>
                )}
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  )
}

const MiniThumbnail = (props: { course: any }) => {
  const org = useOrg() as any

  // function to remove "course_" from the course_uuid
  function removeCoursePrefix(course_uuid: string) {
    return course_uuid.replace('course_', '')
  }

  return (
    <Link
      href={getUriWithOrg(
        org.orgslug,
        '/course/' + removeCoursePrefix(props.course.course_uuid)
      )}
    >
      {props.course.thumbnail_image ? (
        <div
          className="inset-0 ring-1 ring-inset ring-black/10 rounded-lg shadow-xl w-[70px] h-[40px]   bg-cover"
          style={{
            backgroundImage: `url(${getCourseThumbnailMediaDirectory(
              org?.org_uuid,
              props.course.course_uuid,
              props.course.thumbnail_image
            )})`,
          }}
        />
      ) : (
        <div
          className="inset-0 ring-1 ring-inset ring-black/10 rounded-lg shadow-xl w-[70px] h-[40px] bg-cover"
          style={{
            backgroundImage: `url('../empty_thumbnail.png')`,
            backgroundSize: 'contain',
          }}
        />
      )}
    </Link>
  )
}


export default AssignmentsHome



================================================
FILE: apps/web/app/orgs/[orgslug]/dash/assignments/[assignmentuuid]/page.tsx
================================================
'use client';
import BreadCrumbs from '@components/Dashboard/Misc/BreadCrumbs'
import { BookOpen, BookX, EllipsisVertical, Eye, Layers2, Monitor, Pencil, UserRoundPen } from 'lucide-react'
import React, { useEffect } from 'react'
import { AssignmentProvider, useAssignments } from '@components/Contexts/Assignments/AssignmentContext';
import ToolTip from '@components/Objects/StyledElements/Tooltip/Tooltip';
import { updateAssignment } from '@services/courses/assignments';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import { mutate } from 'swr';
import { getAPIUrl } from '@services/config/config';
import toast from 'react-hot-toast';
import Link from 'next/link';
import { useParams, useSearchParams } from 'next/navigation';
import { updateActivity } from '@services/courses/activities';
// Lazy Loading
import dynamic from 'next/dynamic';
import AssignmentEditorSubPage from './subpages/AssignmentEditorSubPage';
import { useMediaQuery } from 'usehooks-ts';
import EditAssignmentModal from '@components/Objects/Modals/Activities/Assignments/EditAssignmentModal';
const AssignmentSubmissionsSubPage = dynamic(() => import('./subpages/AssignmentSubmissionsSubPage'))

function AssignmentEdit() {
    const params = useParams<{ assignmentuuid: string; }>()
    const searchParams = useSearchParams()
    const [selectedSubPage, setSelectedSubPage] = React.useState(searchParams.get('subpage') || 'editor')
    const isMobile = useMediaQuery('(max-width: 767px)')

    if (isMobile) {
        // TODO: Work on a better mobile experience
        return (
          <div className="h-screen w-full bg-[#f8f8f8] flex items-center justify-center p-4">
            <div className="bg-white p-6 rounded-lg shadow-md text-center">
              <h2 className="text-xl font-bold mb-4">Desktop Only</h2>
              <Monitor className='mx-auto my-5' size={60} />    
              <p>This page is only accessible from a desktop device.</p>
              <p>Please switch to a desktop to view and manage the assignment.</p>
            </div>
          </div>
        )
    }
    
    return (
        <div className='flex w-full flex-col'>
            <AssignmentProvider assignment_uuid={'assignment_' + params.assignmentuuid}>
                <div className='flex flex-col  bg-white z-50 shadow-[0px_4px_16px_rgba(0,0,0,0.06)] nice-shadow'>
                    <div className='flex justify-between mr-10 h-full'>
                        <div className="pl-10 mr-10 tracking-tighter">
                            <BrdCmpx />
                            <div className="w-100 flex justify-between">
                                <div className="flex font-bold text-2xl">
                                    <AssignmentTitle />
                                </div>
                            </div>
                        </div>
                        <div className='flex flex-col justify-center antialiased'>
                            <PublishingState />
                        </div>
                    </div>
                    <div className='flex space-x-2 pt-2 text-sm tracking-tight font-semibold pl-10 mr-10'>
                        <div
                            onClick={() => setSelectedSubPage('editor')}
                            className={`flex space-x-4 py-2 w-fit text-center border-black transition-all ease-linear ${selectedSubPage === 'editor'
                                ? 'border-b-4'
                                : 'opacity-50'
                                } cursor-pointer`}
                        >
                            <div className="flex items-center space-x-2.5 mx-2">
                                <Layers2 size={16} />
                                <div>Editor</div>
                            </div>
                        </div>
                        <div
                            onClick={() => setSelectedSubPage('submissions')}
                            className={`flex space-x-4 py-2 w-fit text-center border-black transition-all ease-linear ${selectedSubPage === 'submissions'
                                ? 'border-b-4'
                                : 'opacity-50'
                                } cursor-pointer`}
                        >
                            <div className="flex items-center space-x-2.5 mx-2">
                                <UserRoundPen size={16} />
                                <div>Submissions</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div className="flex h-full w-full">
                    {selectedSubPage === 'editor' && <AssignmentEditorSubPage assignmentuuid={params.assignmentuuid} />}
                    {selectedSubPage === 'submissions' && <AssignmentSubmissionsSubPage assignment_uuid={params.assignmentuuid} />}
                </div>
            </AssignmentProvider>
        </div>
    )
}

export default AssignmentEdit

function BrdCmpx() {
    const assignment = useAssignments() as any

    useEffect(() => {
    }, [assignment])

    return (
        <BreadCrumbs type="assignments" last_breadcrumb={assignment?.assignment_object?.title} />
    )
}

function PublishingState() {
    const assignment = useAssignments() as any;
    const session = useLHSession() as any;
    const access_token = session?.data?.tokens?.access_token;
    const [isEditModalOpen, setIsEditModalOpen] = React.useState(false);

    async function updateAssignmentPublishState(assignmentUUID: string) {
        const res = await updateAssignment({ published: !assignment?.assignment_object?.published }, assignmentUUID, access_token)
        const res2 = await updateActivity({ published: !assignment?.assignment_object?.published }, assignment?.activity_object?.activity_uuid, access_token)
        const toast_loading = toast.loading('Updating assignment...')
        if (res.success && res2) {
            mutate(`${getAPIUrl()}assignments/${assignmentUUID}`)
            toast.success('The assignment has been updated successfully')
            toast.dismiss(toast_loading)
        }
        else {
            toast.error('Error updating assignment, please retry later.')
        }
    }

    useEffect(() => {
    }, [assignment])

    return (
        <>
            <div className='flex mx-auto mt-5 items-center space-x-4'>
                <div className={`flex text-xs rounded-full px-3.5 py-2 mx-auto font-bold outline outline-1 ${!assignment?.assignment_object?.published ? 'outline-gray-300 bg-gray-200/60' : 'outline-green-300 bg-green-200/60'}`}>
                    {assignment?.assignment_object?.published ? 'Published' : 'Unpublished'}
                </div>
                <div><EllipsisVertical className='text-gray-500' size={13} /></div>

                <ToolTip
                    side='left'
                    slateBlack
                    sideOffset={10}
                    content="Edit Assignment Details">
                    <div
                        onClick={() => setIsEditModalOpen(true)}
                        className='flex px-3 py-2 cursor-pointer rounded-md space-x-2 items-center bg-linear-to-bl text-blue-800 font-medium from-blue-400/50 to-blue-200/80 border border-blue-600/10 shadow-blue-900/10 shadow-lg'>
                        <Pencil size={18} />
                        <p className='text-sm font-bold'>Edit</p>
                    </div>
                </ToolTip>

                <ToolTip
                    side='left'
                    slateBlack
                    sideOffset={10}
                    content="Preview the Assignment as a student" >
                    <Link
                        target='_blank'
                        href={`/course/${assignment?.course_object?.course_uuid.replace('course_', '')}/activity/${assignment?.activity_object?.activity_uuid.replace('activity_', '')}`}
                        className='flex px-3 py-2 cursor-pointer rounded-md space-x-2 items-center bg-linear-to-bl text-cyan-800 font-medium from-sky-400/50 to-cyan-200/80  border border-cyan-600/10 shadow-cyan-900/10 shadow-lg'>
                        <Eye size={18} />
                        <p className=' text-sm font-bold'>Preview</p>
                    </Link>
                </ToolTip>
                {assignment?.assignment_object?.published && <ToolTip
                    side='left'
                    slateBlack
                    sideOffset={10}
                    content="Make your Assignment unavailable for students" >
                    <div
                        onClick={() => updateAssignmentPublishState(assignment?.assignment_object?.assignment_uuid)}
                        className='flex px-3 py-2 cursor-pointer rounded-md space-x-2 items-center bg-linear-to-bl text-gray-800 font-medium from-gray-400/50 to-gray-200/80 border border-gray-600/10 shadow-gray-900/10 shadow-lg'>
                        <BookX size={18} />
                        <p className='text-sm font-bold'>Unpublish</p>
                    </div>
                </ToolTip>}
                {!assignment?.assignment_object?.published &&
                    <ToolTip
                        side='left'
                        slateBlack
                        sideOffset={10}
                        content="Make your Assignment public and available for students" >
                        <div
                            onClick={() => updateAssignmentPublishState(assignment?.assignment_object?.assignment_uuid)}
                            className='flex px-3 py-2 cursor-pointer rounded-md space-x-2 items-center bg-linear-to-bl text-green-800 font-medium from-green-400/50 to-lime-200/80  border border-green-600/10 shadow-green-900/10 shadow-lg'>
                            <BookOpen size={18} />
                            <p className=' text-sm font-bold'>Publish</p>
                        </div>
                    </ToolTip>}
            </div>
            {isEditModalOpen && (
                <EditAssignmentModal
                    isOpen={isEditModalOpen}
                    onClose={() => setIsEditModalOpen(false)}
                    assignment={assignment?.assignment_object}
                    accessToken={access_token}
                />
            )}
        </>
    )
}

function AssignmentTitle() {
    const assignment = useAssignments() as any;
    
    return (
        <div className="flex items-center gap-2">
            Assignment Tools 
        </div>
    );
}



================================================
FILE: apps/web/app/orgs/[orgslug]/dash/assignments/[assignmentuuid]/_components/Tasks.tsx
================================================
import { useAssignments } from '@components/Contexts/Assignments/AssignmentContext'
import Modal from '@components/Objects/StyledElements/Modal/Modal';
import { FileUp, ListTodo, PanelLeftOpen, Plus, Type } from 'lucide-react';
import React, { useEffect } from 'react'
import NewTaskModal from './Modals/NewTaskModal';
import { useAssignmentsTask, useAssignmentsTaskDispatch } from '@components/Contexts/Assignments/AssignmentsTaskContext';

function AssignmentTasks({ assignment_uuid }: any) {
    const assignments = useAssignments() as any;
    const assignmentTask = useAssignmentsTask() as any;
    const assignmentTaskHook = useAssignmentsTaskDispatch() as any;
    const [isNewTaskModalOpen, setIsNewTaskModalOpen] = React.useState(false)

    async function setSelectTask(task_uuid: string) {
        assignmentTaskHook({ type: 'setSelectedAssignmentTaskUUID', payload: task_uuid })
    }

    useEffect(() => {
    }, [assignments])


    return (
        <div className='flex w-full'>
            <div className='flex flex-col space-y-3 mx-auto'>
                {assignments && assignments?.assignment_tasks?.length < 10 && (<Modal
                    isDialogOpen={isNewTaskModalOpen}
                    onOpenChange={setIsNewTaskModalOpen}
                    minHeight="sm"
                    minWidth='sm'
                    dialogContent={
                        <NewTaskModal assignment_uuid={assignment_uuid} closeModal={setIsNewTaskModalOpen} />
                    }
                    dialogTitle="Add an Assignment Task"
                    dialogDescription="Create a new task for this assignment"
                    dialogTrigger={
                        <div className='flex space-x-1.5 px-2 py-2 justify-center bg-black text-white text-xs rounded-md antialiased items-center font-semibold cursor-pointer'>
                            <Plus size={17} />
                            <p>Add Task</p>
                        </div>
                    }
                />)}
                {assignments && assignments?.assignment_tasks?.map((task: any) => {
                    return (
                        <div
                            key={task.id}
                            className='flex flex-col w-[250px] nice-shadow bg-white shadow-[0px_4px_16px_rgba(0,0,0,0.06)] p-3 rounded-md'
                            onClick={() => setSelectTask(task.assignment_task_uuid)}
                        >
                            <div className='flex items-center px-2 justify-between'>
                                <div className="flex space-x-3 items-center">
                                    <div className='text-gray-500'>
                                        {task.assignment_type === 'QUIZ' && <ListTodo size={15} />}
                                        {task.assignment_type === 'FILE_SUBMISSION' && <FileUp size={15} />}
                                        {task.assignment_type === 'FORM' && <Type size={15} />}
                                    </div>
                                    <div className='font-semibold text-sm'>{task.title}</div>
                                </div>
                                <button className={`outline outline-1 outline-gray-200 ${task.assignment_task_uuid == assignmentTask.selectedAssignmentTaskUUID ? 'bg-slate-100' : ''} hover:bg-slate-100/50 rounded-md text-gray-500 font-bold py-2 px-3  ease-linear transition-all`}>
                                    <PanelLeftOpen size={16} />
                                </button>
                            </div>
                        </div>
                    )
                })}



            </div>

        </div>
    )
}

export default AssignmentTasks


================================================
FILE: apps/web/app/orgs/[orgslug]/dash/assignments/[assignmentuuid]/_components/Modals/NewTaskModal.tsx
================================================
import { useAssignmentsTaskDispatch } from '@components/Contexts/Assignments/AssignmentsTaskContext';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import { getAPIUrl } from '@services/config/config';
import { createAssignmentTask } from '@services/courses/assignments'
import { AArrowUp, FileUp, ListTodo } from 'lucide-react'
import React from 'react'
import toast from 'react-hot-toast';
import { mutate } from 'swr';

function NewTaskModal({ closeModal, assignment_uuid }: any) {
  const session = useLHSession() as any;
  const access_token = session?.data?.tokens?.access_token;
  const reminderShownRef = React.useRef(false);
  const assignmentTaskStateHook = useAssignmentsTaskDispatch() as any

  function showReminderToast() {
    // Check if the reminder has already been shown using sessionStorage
    if (sessionStorage.getItem("TasksReminderShown") !== "true") {
      setTimeout(() => {
        toast('When editing/adding your tasks, make sure to Unpublish your Assignment to avoid any issues with students, you can Publish it again when you are ready.',
              { icon: 'âœ‹', duration: 10000, style: { minWidth: 600 }  });
        // Mark the reminder as shown in sessionStorage
        sessionStorage.setItem("TasksReminderShown", "true");
      }, 3000);
    }
  }

  async function createTask(type: string) {
    const task_object = {
      title: "Untitled Task",
      description: "",
      hint: "",
      reference_file: "",
      assignment_type: type,
      contents: {},
      max_grade_value: 100,
    }
    const res = await createAssignmentTask(task_object, assignment_uuid, access_token)
    toast.success('Task created successfully')
    showReminderToast()
    mutate(`${getAPIUrl()}assignments/${assignment_uuid}/tasks`)
    assignmentTaskStateHook({ type: 'setSelectedAssignmentTaskUUID', payload: res.data.assignment_task_uuid })
    closeModal(false)
  }


  return (
    <div className='flex space-x-6 mx-auto justify-center items-center'>
      <div
        onClick={() => createTask('QUIZ')}
        className='flex flex-col space-y-2 justify-center  text-center pt-10'>
        <div className='px-5 py-5 rounded-full nice-shadow w-fit mx-auto bg-gray-100/50 text-gray-500 cursor-pointer hover:bg-gray-100 transition-all ease-linear'>
          <ListTodo size={30} />
        </div>
        <p className='text-xl text-gray-700 font-semibold'>Quiz</p>
        <p className='text-sm text-gray-500 w-40'>Questions with multiple choice answers</p>
      </div>
      <div
        onClick={() => createTask('FILE_SUBMISSION')}
        className='flex flex-col space-y-2 justify-center  text-center pt-10'>
        <div className='px-5 py-5 rounded-full nice-shadow w-fit mx-auto bg-gray-100/50 text-gray-500 cursor-pointer hover:bg-gray-100 transition-all ease-linear'>
          <FileUp size={30} />
        </div>
        <p className='text-xl text-gray-700 font-semibold'>File submission</p>
        <p className='text-sm text-gray-500 w-40'>Students can submit files for this task</p>
      </div>
      <div
        onClick={() => createTask('FORM')}
        className='flex flex-col space-y-2 justify-center  text-center pt-10'>
        <div className='px-5 py-5 rounded-full nice-shadow w-fit mx-auto bg-gray-100/50 text-gray-500 cursor-pointer hover:bg-gray-100 transition-all ease-linear'>
          <AArrowUp size={30} />
        </div>
        <p className='text-xl text-gray-700 font-semibold'>Form</p>
        <p className='text-sm text-gray-500 w-40'>Fill-in-the-blank forms for students</p>
      </div>
    </div>
  )
}

export default NewTaskModal


================================================
FILE: apps/web/app/orgs/[orgslug]/dash/assignments/[assignmentuuid]/_components/TaskEditor/TaskEditor.tsx
================================================
'use client';
import { useAssignments } from '@components/Contexts/Assignments/AssignmentContext';
import { useAssignmentsTask, useAssignmentsTaskDispatch } from '@components/Contexts/Assignments/AssignmentsTaskContext';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import { getAPIUrl } from '@services/config/config';
import { deleteAssignmentTask } from '@services/courses/assignments';
import { GalleryVerticalEnd, Info, TentTree, Trash } from 'lucide-react'
import React, { useEffect } from 'react'
import toast from 'react-hot-toast';
import { mutate } from 'swr';
import dynamic from 'next/dynamic';
import { AssignmentTaskGeneralEdit } from './Subs/AssignmentTaskGeneralEdit';
const AssignmentTaskContentEdit = dynamic(() => import('./Subs/AssignmentTaskContentEdit'))

function AssignmentTaskEditor({ page }: any) {
    const [selectedSubPage, setSelectedSubPage] = React.useState(page)
    const assignment = useAssignments() as any
    const assignmentTaskState = useAssignmentsTask() as any
    const assignmentTaskStateHook = useAssignmentsTaskDispatch() as any
    const session = useLHSession() as any;
    const access_token = session?.data?.tokens?.access_token;

    async function deleteTaskUI() {
        const res = await deleteAssignmentTask(assignmentTaskState.assignmentTask.assignment_task_uuid, assignment.assignment_object.assignment_uuid, access_token)
        if (res) {
            assignmentTaskStateHook({
                type: 'SET_MULTIPLE_STATES',
                payload: {
                    selectedAssignmentTaskUUID: null,
                    assignmentTask: {},
                },
            });
            mutate(`${getAPIUrl()}assignments/${assignment.assignment_object.assignment_uuid}/tasks`)
            mutate(`${getAPIUrl()}assignments/${assignment.assignment_object.assignment_uuid}`)
            toast.success('Task deleted successfully')
        } else {
            toast.error('Error deleting task, please retry later.')
        }
    }

    useEffect(() => {
        // Switch back to general page if the selectedAssignmentTaskUUID is changed 
        if (assignmentTaskState.selectedAssignmentTaskUUID !== assignmentTaskState.assignmentTask.assignment_task_uuid) {
            setSelectedSubPage('general')
        }
    }
        , [assignmentTaskState, assignmentTaskStateHook, selectedSubPage, assignment])

    return (
        <div className="flex flex-col font-black text-sm w-full z-20">
            {assignmentTaskState.assignmentTask && Object.keys(assignmentTaskState.assignmentTask).length > 0 && (
                <div className='flex flex-col space-y-3'>
                    <div className='flex flex-col bg-white pl-10 pr-10 text-sm tracking-tight  z-10 shadow-[0px_4px_16px_rgba(0,0,0,0.06)] pt-5 mb-3 nice-shadow'>
                        <div className='flex py-1 justify-between items-center'>
                            <div className='font-semibold text-lg '>
                                {assignmentTaskState?.assignmentTask.title}
                            </div>
                            <div>
                                <div
                                    onClick={() => deleteTaskUI()}
                                    className='flex px-2 py-1.5 cursor-pointer rounded-md space-x-2 items-center bg-linear-to-bl text-red-800  bg-rose-100  border border-rose-600/10 shadow-rose-900/10 shadow-lg'>
                                    <Trash size={18} />
                                    <p className='text-xs font-semibold'>Delete Task</p>
                                </div>
                            </div>
                        </div>
                        <div className='flex space-x-2 '>
                            <div
                                onClick={() => setSelectedSubPage('general')}
                                className={`flex space-x-4 py-2 w-fit text-center border-black transition-all ease-linear ${selectedSubPage === 'general'
                                    ? 'border-b-4'
                                    : 'opacity-50'
                                    } cursor-pointer`}
                            >
                                <div className="flex items-center space-x-2.5 mx-2">
                                    <Info size={16} />
                                    <div>General</div>
                                </div>
                            </div>
                            <div
                                onClick={() => setSelectedSubPage('content')}
                                className={`flex space-x-4 py-2 w-fit text-center border-black transition-all ease-linear ${selectedSubPage === 'content'
                                    ? 'border-b-4'
                                    : 'opacity-50'
                                    } cursor-pointer`}
                            >
                                <div className="flex items-center space-x-2.5 mx-2">
                                    <GalleryVerticalEnd size={16} />
                                    <div>Content</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div className='ml-10 mr-10 mt-10 mx-auto bg-white rounded-xl shadow-xs px-6 py-5 nice-shadow'>
                        {selectedSubPage === 'general' && <AssignmentTaskGeneralEdit />}
                        {selectedSubPage === 'content' && <AssignmentTaskContentEdit />}
                    </div>
                </div>
            )}
            {Object.keys(assignmentTaskState.assignmentTask).length == 0 && (
                <div className='flex flex-col h-full bg-white pl-10 pr-10 text-sm tracking-tight  z-10 shadow-[0px_4px_16px_rgba(0,0,0,0.06)] pt-5'>
                    <div className='flex justify-center items-center h-full text-gray-300 antialiased'>
                        <div className='flex flex-col space-y-2 items-center'>
                            <TentTree size={60} />
                            <div className='font-semibold text-2xl py-1'>
                                No Task Selected
                            </div>
                        </div>
                    </div>
                </div>
            )}

        </div>
    )
}



export default AssignmentTaskEditor


================================================
FILE: apps/web/app/orgs/[orgslug]/dash/assignments/[assignmentuuid]/_components/TaskEditor/Subs/AssignmentTaskContentEdit.tsx
================================================
import { useAssignmentsTask, useAssignmentsTaskDispatch } from '@components/Contexts/Assignments/AssignmentsTaskContext';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import React, { useEffect } from 'react'
import TaskQuizObject from './TaskTypes/TaskQuizObject';
import TaskFileObject from './TaskTypes/TaskFileObject';
import TaskFormObject from './TaskTypes/TaskFormObject';

function AssignmentTaskContentEdit() {
    const session = useLHSession() as any;
    const access_token = session?.data?.tokens?.access_token;
    const assignmentTaskStateHook = useAssignmentsTaskDispatch() as any
    const assignment_task = useAssignmentsTask() as any

    useEffect(() => {
    }
        , [assignment_task, assignmentTaskStateHook])

    return (
        <div>
            {assignment_task?.assignmentTask.assignment_type === 'QUIZ' && <TaskQuizObject view='teacher' />}
            {assignment_task?.assignmentTask.assignment_type === 'FILE_SUBMISSION' && <TaskFileObject view='teacher' />}
            {assignment_task?.assignmentTask.assignment_type === 'FORM' && <TaskFormObject view='teacher' assignmentTaskUUID={assignment_task?.assignmentTask.assignment_task_uuid} />}
        </div>
    )
}

export default AssignmentTaskContentEdit


================================================
FILE: apps/web/app/orgs/[orgslug]/dash/assignments/[assignmentuuid]/_components/TaskEditor/Subs/AssignmentTaskGeneralEdit.tsx
================================================
'use client';
import { useAssignments } from '@components/Contexts/Assignments/AssignmentContext';
import { useAssignmentsTask, useAssignmentsTaskDispatch } from '@components/Contexts/Assignments/AssignmentsTaskContext';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import { useOrg } from '@components/Contexts/OrgContext';
import FormLayout, { FormField, FormLabelAndMessage, Input, Textarea } from '@components/Objects/StyledElements/Form/Form';
import * as Form from '@radix-ui/react-form';
import { getActivityByID } from '@services/courses/activities';
import { updateAssignmentTask, updateReferenceFile } from '@services/courses/assignments';
import { getTaskRefFileDir } from '@services/media/media';
import { useFormik } from 'formik';
import { Cloud, File, Info, Loader, UploadCloud } from 'lucide-react'
import Link from 'next/link';
import React, { useEffect } from 'react'
import toast from 'react-hot-toast';
import { constructAcceptValue } from '@/lib/constants';

const SUPPORTED_FILES = constructAcceptValue(['pdf', 'docx', 'mp4', 'jpg', 'png', 'pptx', 'zip'])

export function AssignmentTaskGeneralEdit() {
    const session = useLHSession() as any;
    const access_token = session?.data?.tokens?.access_token;
    const assignmentTaskState = useAssignmentsTask() as any
    const assignmentTaskStateHook = useAssignmentsTaskDispatch() as any
    const assignment = useAssignments() as any

    const validate = (values: any) => {
        const errors: any = {};
        if (values.max_grade_value < 20 || values.max_grade_value > 100) {
            errors.max_grade_value = 'Value should be between 20 and 100';
        }
        return errors;
    };

    const formik = useFormik({
        initialValues: {
            title: assignmentTaskState.assignmentTask.title,
            description: assignmentTaskState.assignmentTask.description,
            hint: assignmentTaskState.assignmentTask.hint,
            max_grade_value: assignmentTaskState.assignmentTask.max_grade_value,
        },
        validate,
        onSubmit: async values => {
            const res = await updateAssignmentTask(values, assignmentTaskState.assignmentTask.assignment_task_uuid, assignment.assignment_object.assignment_uuid, access_token)
            if (res) {
                assignmentTaskStateHook({ type: 'reload' })
                toast.success('Task updated successfully')
            }

            else {
                toast.error('Error updating task, please retry later.')
            }
        },
        enableReinitialize: true,
    }) as any;

    return (
        <FormLayout onSubmit={formik.handleSubmit}>
            <FormField name="title">
                <FormLabelAndMessage label="Title" message={formik.errors.title} />
                <Form.Control asChild>
                    <Input
                        onChange={formik.handleChange}
                        value={formik.values.title}
                        type="text"
                    />
                </Form.Control>
            </FormField>

            <FormField name="description">
                <FormLabelAndMessage label="Description" message={formik.errors.description} />
                <Form.Control asChild>
                    <Input
                        onChange={formik.handleChange}
                        value={formik.values.description}
                        type="text"
                    />
                </Form.Control>
            </FormField>

            <FormField name="hint">
                <FormLabelAndMessage label="Hint" message={formik.errors.hint} />
                <Form.Control asChild>
                    <Textarea
                        onChange={formik.handleChange}
                        value={formik.values.hint}
                    />
                </Form.Control>
            </FormField>

            <FormField name="hint">
                <div className='flex space-x-3 justify-between items-center'>
                    <FormLabelAndMessage label="Reference file" message={formik.errors.hint} />
                    <div className='flex space-x-1.5 text-xs items-center text-gray-500 '>
                        <Info size={16} />
                        <p>Allowed formats : pdf, docx, mp4, jpg, jpeg, png, pptx, zip</p>
                    </div>

                </div>
                <Form.Control asChild>
                    <UpdateTaskRef />
                </Form.Control>
            </FormField>

            <FormField name="max_grade_value">
                <FormLabelAndMessage label="Max Grade Value" message={formik.errors.max_grade_value} />
                <Form.Control asChild>
                    <Input
                        onChange={formik.handleChange}
                        value={formik.values.max_grade_value}
                        type="number"
                    />
                </Form.Control>
            </FormField>

            {/* Submit button */}
            <Form.Submit >
                <button
                    type="submit"
                    className="flex items-center justify-center w-full px-4 py-2 mt-4 font-semibold text-white bg-green-500 rounded-md hover:bg-green-600"
                >
                    Submit
                </button>
            </Form.Submit>


        </FormLayout>
    )
}

function UpdateTaskRef() {
    const session = useLHSession() as any;
    const org = useOrg() as any;
    const access_token = session?.data?.tokens?.access_token;
    const assignmentTaskState = useAssignmentsTask() as any
    const assignmentTaskStateHook = useAssignmentsTaskDispatch() as any
    const assignment = useAssignments() as any
    const [isLoading, setIsLoading] = React.useState(false)
    const [error, setError] = React.useState('') as any
    const [localRefFile, setLocalRefFile] = React.useState(null) as any
    const [activity, setActivity] = React.useState('') as any

    const handleFileChange = async (event: any) => {
        const file = event.target.files[0]
        setLocalRefFile(file)
        setIsLoading(true)
        const res = await updateReferenceFile(
            file,
            assignmentTaskState.assignmentTask.assignment_task_uuid,
            assignment.assignment_object.assignment_uuid,
            access_token
        )
        assignmentTaskStateHook({ type: 'reload' })
        // wait for 1 second to show loading animation
        await new Promise((r) => setTimeout(r, 1500))
        if (res.success === false) {
            setError(res.data.detail)
            setIsLoading(false)
        } else {
            toast.success('Reference file updated successfully')
            setIsLoading(false)
            setError('')
        }
    }

    const getTaskRefDirUI = () => {
        return getTaskRefFileDir(
            org?.org_uuid,
            assignment.course_object.course_uuid,
            assignment.activity_object.activity_uuid,
            assignment.assignment_object.assignment_uuid,
            assignmentTaskState.assignmentTask.assignment_task_uuid,
            assignmentTaskState.assignmentTask.reference_file
        )
    }

    const deleteReferenceFile = async () => {
        setIsLoading(true)
        const res = await updateReferenceFile(
            '',
            assignmentTaskState.assignmentTask.assignment_task_uuid,
            assignment.assignment_object.assignment_uuid,
            access_token
        )
        assignmentTaskStateHook({ type: 'reload' })
        // wait for 1 second to show loading animation
        await new Promise((r) => setTimeout(r, 1500))
        if (res.success === false) {
            setError(res.data.detail)
            setIsLoading(false)
        } else {
            setIsLoading(false)
            setError('')
        }
    }

    async function getActivityUI() {
        const res = await getActivityByID(assignment.assignment_object.activity_id, null, access_token)
        setActivity(res.data)
    }



    useEffect(() => {
        getActivityUI()
    }
        , [assignmentTaskState, org])



    return (
        <div className="w-auto bg-gray-50 rounded-xl outline outline-1 outline-gray-200 h-[200px] shadow-sm">
            <div className="flex flex-col justify-center items-center h-full">
                <div className="flex flex-col justify-center items-center">
                    <div className="flex flex-col justify-center items-center">
                        {error && (
                            <div className="flex justify-center bg-red-200 rounded-md text-red-950 space-x-2 items-center p-2 transition-all shadow-xs">
                                <div className="text-sm font-semibold">{error}</div>
                            </div>
                        )}

                    </div>
                    {assignmentTaskState.assignmentTask.reference_file && !isLoading && (
                        <div className='flex flex-col rounded-lg bg-white text-gray-400 shadow-lg nice-shadow px-5 py-3 space-y-1 items-center relative'>
                            <div className='absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-green-500 rounded-full px-1.5 py-1.5 text-white flex justify-center items-center'>
                                <Cloud size={15} />
                            </div>
                            <File size={20} className='' />
                            <div className='font-semibold text-sm uppercase'>
                                {assignmentTaskState.assignmentTask.reference_file.split('.').pop()}
                            </div>
                            <div className='flex space-x-2 mt-2'>
                                <Link
                                    href={getTaskRefDirUI()}
                                    download
                                    target='_blank'
                                    className='bg-blue-500 text-white px-3 py-1 rounded-full text-xs font-semibold'>Download</Link>
                                {/** <button onClick={() => deleteReferenceFile()}
                                    className='bg-red-500 text-white px-3 py-1 rounded-full text-xs font-semibold'>Delete</button> */}
                            </div>
                        </div>
                    )}

                    {isLoading ? (
                        <div className="flex justify-center items-center">
                            <input
                                type="file"
                                accept={SUPPORTED_FILES}
                                id="fileInput"
                                style={{ display: 'none' }}
                                onChange={handleFileChange}
                            />
                            <div className="font-bold  animate-pulse antialiased items-center bg-slate-200 text-gray text-sm rounded-md px-4 py-2 mt-4 flex">
                                <Loader size={16} className="mr-2" />
                                <span>Loading</span>
                            </div>
                        </div>
                    ) : (
                        <div className="flex justify-center items-center">
                            <input
                                type="file"
                                accept={SUPPORTED_FILES}
                                id="fileInput"
                                style={{ display: 'none' }}
                                onChange={handleFileChange}
                            />
                            <button
                                className="font-bold antialiased items-center  text-gray text-sm rounded-md px-4  mt-6 flex"
                                onClick={() => document.getElementById('fileInput')?.click()}
                            >
                                <UploadCloud size={16} className="mr-2" />
                                <span>Change Reference File</span>
                            </button>
                        </div>
                    )}

                </div>
            </div>
        </div>
    )
}


================================================
FILE: apps/web/app/orgs/[orgslug]/dash/assignments/[assignmentuuid]/_components/TaskEditor/Subs/TaskTypes/TaskFileObject.tsx
================================================
import { useAssignments } from '@components/Contexts/Assignments/AssignmentContext';
import { useAssignmentsTaskDispatch } from '@components/Contexts/Assignments/AssignmentsTaskContext';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import { useOrg } from '@components/Contexts/OrgContext';
import AssignmentBoxUI from '@components/Objects/Activities/Assignment/AssignmentBoxUI'
import { getAssignmentTask, getAssignmentTaskSubmissionsMe, getAssignmentTaskSubmissionsUser, handleAssignmentTaskSubmission, updateSubFile } from '@services/courses/assignments';
import { getTaskFileSubmissionDir } from '@services/media/media';
import { Cloud, Download, File, Info, Loader, UploadCloud } from 'lucide-react'
import Link from 'next/link';
import React, { useEffect, useState } from 'react'
import toast from 'react-hot-toast';

type FileSchema = {
    fileUUID: string;
    assignment_task_submission_uuid?: string;
};

type TaskFileObjectProps = {
    view: 'teacher' | 'student' | 'grading' | 'custom-grading';
    assignmentTaskUUID?: string;
    user_id?: string;
};

export default function TaskFileObject({ view, user_id, assignmentTaskUUID }: TaskFileObjectProps) {
    const session = useLHSession() as any;
    const org = useOrg() as any;
    const access_token = session?.data?.tokens?.access_token;
    const [isLoading, setIsLoading] = React.useState(false);
    const [localUploadFile, setLocalUploadFile] = React.useState<File | null>(null);
    const [error, setError] = React.useState<string | null>(null);
    const [assignmentTask, setAssignmentTask] = React.useState<any>(null);
    const assignmentTaskStateHook = useAssignmentsTaskDispatch() as any;
    const assignment = useAssignments() as any;

    /* TEACHER VIEW CODE */
    /* TEACHER VIEW CODE */

    /* STUDENT VIEW CODE */
    const [showSavingDisclaimer, setShowSavingDisclaimer] = useState<boolean>(false);
    const [userSubmissions, setUserSubmissions] = useState<FileSchema>({
        fileUUID: '',
    });
    const [initialUserSubmissions, setInitialUserSubmissions] = useState<FileSchema>({
        fileUUID: '',
    });

    const handleFileChange = async (event: any) => {
        // Check if user is authenticated
        if (!access_token) {
            setError('Authentication required. Please sign in to upload files.');
            return;
        }

        const file = event.target.files[0]

        setLocalUploadFile(file)
        setIsLoading(true)
        const res = await updateSubFile(
            file,
            assignmentTask.assignment_task_uuid,
            assignment.assignment_object.assignment_uuid,
            access_token
        )

        // wait for 1 second to show loading animation
        await new Promise((r) => setTimeout(r, 1500))
        if (res.success === false) {
            setError(res.data.detail)
            setIsLoading(false)
        } else {
            assignmentTaskStateHook({ type: 'reload' })
            setUserSubmissions({
                fileUUID: res.data.file_uuid,
                assignment_task_submission_uuid: res.data.assignment_task_submission_uuid
            })
            setIsLoading(false)
            setError('')
        }
    }

    async function getAssignmentTaskSubmissionFromUserUI() {
        if (!access_token) {
            // Silently fail if not authenticated
            return;
        }
        
        if (assignmentTaskUUID) {
            const res = await getAssignmentTaskSubmissionsMe(assignmentTaskUUID, assignment.assignment_object.assignment_uuid, access_token);
            if (res.success) {
                setUserSubmissions({
                    ...res.data.task_submission,
                    assignment_task_submission_uuid: res.data.assignment_task_submission_uuid
                });
                setInitialUserSubmissions({
                    ...res.data.task_submission,
                    assignment_task_submission_uuid: res.data.assignment_task_submission_uuid
                });
            }
        }
    }

    const submitFC = async () => {
        // Check if user is authenticated
        if (!access_token) {
            toast.error('Authentication required. Please sign in to submit your task.');
            return;
        }

        // Save the file submission to the server
        const values = {
            assignment_task_submission_uuid: userSubmissions.assignment_task_submission_uuid || null,
            task_submission: userSubmissions,
            grade: 0,
            task_submission_grade_feedback: '',
        };
        if (assignmentTaskUUID) {
            const res = await handleAssignmentTaskSubmission(values, assignmentTaskUUID, assignment.assignment_object.assignment_uuid, access_token);
            if (res) {
                assignmentTaskStateHook({
                    type: 'reload',
                });
                toast.success('Task saved successfully');
                setShowSavingDisclaimer(false);
                // Update userSubmissions with the returned UUID for future updates
                const updatedUserSubmissions = {
                    ...userSubmissions,
                    assignment_task_submission_uuid: res.data?.assignment_task_submission_uuid || userSubmissions.assignment_task_submission_uuid
                };
                setUserSubmissions(updatedUserSubmissions);
                setInitialUserSubmissions(updatedUserSubmissions);
            } else {
                toast.error('Error saving task, please retry later.');
            }
        }
    };

    async function getAssignmentTaskUI() {
        if (!access_token) {
            // Silently fail if not authenticated
            return;
        }
        
        if (assignmentTaskUUID) {
            const res = await getAssignmentTask(assignmentTaskUUID, access_token);
            if (res.success) {
                setAssignmentTask(res.data);
                setAssignmentTaskOutsideProvider(res.data);
            }
        }
    }

    // Detect changes between initial and current submissions
    useEffect(() => {
        if (userSubmissions.fileUUID !== initialUserSubmissions.fileUUID) {
            setShowSavingDisclaimer(true);
        } else {
            setShowSavingDisclaimer(false);
        }
    }, [userSubmissions]);

    /* STUDENT VIEW CODE */

    /* GRADING VIEW CODE */
    const [userSubmissionObject, setUserSubmissionObject] = useState<any>(null);
    async function getAssignmentTaskSubmissionFromIdentifiedUserUI() {
        if (!access_token) {
            // Silently fail if not authenticated
            return;
        }
        
        if (assignmentTaskUUID && user_id) {
            const res = await getAssignmentTaskSubmissionsUser(assignmentTaskUUID, user_id, assignment.assignment_object.assignment_uuid, access_token);
            if (res.success) {
                setUserSubmissions({
                    ...res.data.task_submission,
                    assignment_task_submission_uuid: res.data.assignment_task_submission_uuid
                });
                setUserSubmissionObject(res.data);
                setInitialUserSubmissions({
                    ...res.data.task_submission,
                    assignment_task_submission_uuid: res.data.assignment_task_submission_uuid
                });
            }
        }
    }

    async function gradeCustomFC(grade: number) {
        if (assignmentTaskUUID) {
            if (grade > assignmentTaskOutsideProvider.max_grade_value) {
                toast.error(`Grade cannot be more than ${assignmentTaskOutsideProvider.max_grade_value} points`);
                return;
            }
            
    
            // Save the grade to the server
            const values = {
                assignment_task_submission_uuid: userSubmissions.assignment_task_submission_uuid,
                task_submission: userSubmissions,
                grade: grade,
                task_submission_grade_feedback: 'Graded by teacher : @' + session.data.user.username,
            };
    
            const res = await handleAssignmentTaskSubmission(values, assignmentTaskUUID, assignment.assignment_object.assignment_uuid, access_token);
            if (res) {
                getAssignmentTaskSubmissionFromIdentifiedUserUI();
                toast.success(`Task graded successfully with ${grade} points`);
            } else {
                toast.error('Error grading task, please retry later.');
            }
        }
    }

    /* GRADING VIEW CODE */
    const [assignmentTaskOutsideProvider, setAssignmentTaskOutsideProvider] = useState<any>(null);
    useEffect(() => {
        // Student area
        if (view === 'student') {
            getAssignmentTaskUI()
            getAssignmentTaskSubmissionFromUserUI()
        }

        // Grading area
        else if (view == 'custom-grading') {
            getAssignmentTaskUI();
            //setQuestions(assignmentTaskState.assignmentTask.contents.questions);
            getAssignmentTaskSubmissionFromIdentifiedUserUI();
        }
    }
        , [assignmentTaskUUID])

    return (
        <AssignmentBoxUI submitFC={submitFC} showSavingDisclaimer={showSavingDisclaimer} view={view} gradeCustomFC={gradeCustomFC} currentPoints={userSubmissionObject?.grade} maxPoints={assignmentTaskOutsideProvider?.max_grade_value} type="file">
            {view === 'teacher' && (
                <div className='flex flex-col sm:flex-row py-5 sm:py-6 text-xs sm:text-sm justify-center mx-auto space-y-2 sm:space-y-0 sm:space-x-3 text-slate-600 px-4 sm:px-2 text-center sm:text-left bg-slate-50 rounded-lg border border-slate-100'>
                    <Info size={18} className="mx-auto sm:mx-0 text-slate-500" />
                    <p>User will be able to submit a file for this task, you'll be able to review it in the Submissions Tab</p>
                </div>
            )}
            {view === 'custom-grading' && (
                <div className='flex flex-col space-y-4 w-full px-2 sm:px-0'>
                    <div className='flex flex-col sm:flex-row py-5 sm:py-6 text-xs sm:text-sm justify-center mx-auto space-y-2 sm:space-y-0 sm:space-x-3 text-slate-600 px-4 sm:px-2 text-center sm:text-left bg-slate-50 rounded-lg border border-slate-100'>
                        <Download size={18} className="mx-auto sm:mx-0 text-slate-500" />
                        <p>Please download the file and grade it manually, then input the grade above</p>
                    </div>
                    {userSubmissions.fileUUID && !isLoading && assignmentTaskUUID && (
                        <Link
                            href={getTaskFileSubmissionDir(org?.org_uuid, assignment.course_object.course_uuid, assignment.activity_object.activity_uuid, assignment.assignment_object.assignment_uuid, assignmentTaskUUID, userSubmissions.fileUUID)}
                            target='_blank'
                            className='flex flex-col rounded-lg bg-white text-gray-500 shadow-xs hover:shadow-md transition-shadow border border-gray-100 px-4 sm:px-5 py-4 space-y-1 items-center relative w-full sm:w-auto mx-auto'>
                            <div className='absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-emerald-500 rounded-full p-1.5 text-white flex justify-center items-center shadow-xs'>
                                <Cloud size={14} />
                            </div>

                            <div className='flex space-x-2 mt-2 items-center'>
                                <File size={18} className="text-emerald-500" />
                                <div className='font-medium text-xs sm:text-sm uppercase break-all'>
                                    {`${userSubmissions.fileUUID.slice(0, 8)}...${userSubmissions.fileUUID.slice(-4)}`}
                                </div>
                            </div>
                        </Link>
                    )}
                </div>
            )}
            {view === 'student' && (
                <>
                    <div className="w-full bg-white rounded-lg border border-gray-100 min-h-[200px] shadow-xs px-4 sm:px-6 py-5 sm:py-6">
                        <div className="flex flex-col justify-center items-center h-full w-full">
                            <div className="flex flex-col justify-center items-center w-full max-w-full">
                                <div className="flex flex-col justify-center items-center w-full">
                                    {error && (
                                        <div className="flex justify-center bg-red-50 border border-red-100 rounded-md text-red-600 space-x-2 items-center p-3 transition-all shadow-xs w-full sm:w-auto mb-4">
                                            <div className="text-xs sm:text-sm font-medium">{error}</div>
                                        </div>
                                    )}
                                </div>
                                {localUploadFile && !isLoading && (
                                    <div className='flex flex-col rounded-lg bg-white text-gray-500 shadow-xs border border-gray-100 px-4 sm:px-5 py-4 space-y-1 items-center relative w-full sm:w-auto mt-3'>
                                        <div className='absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-emerald-500 rounded-full p-1.5 text-white flex justify-center items-center shadow-xs'>
                                            <Cloud size={14} />
                                        </div>

                                        <div className='flex space-x-2 mt-2 items-center'>
                                            <File size={18} className="text-emerald-500" />
                                            <div className='font-medium text-xs sm:text-sm uppercase break-all'>
                                                {localUploadFile.name.length > 20 
                                                    ? `${localUploadFile.name.slice(0, 10)}...${localUploadFile.name.slice(-10)}`
                                                    : localUploadFile.name}
                                            </div>
                                        </div>
                                    </div>
                                )}
                                {userSubmissions.fileUUID && !isLoading && !localUploadFile && (
                                    <div className='flex flex-col rounded-lg bg-white text-gray-500 shadow-xs border border-gray-100 px-4 sm:px-5 py-4 space-y-1 items-center relative w-full sm:w-auto mt-3'>
                                        <div className='absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-emerald-500 rounded-full p-1.5 text-white flex justify-center items-center shadow-xs'>
                                            <Cloud size={14} />
                                        </div>

                                        <div className='flex space-x-2 mt-2 items-center'>
                                            <File size={18} className="text-emerald-500" />
                                            <div className='font-medium text-xs sm:text-sm uppercase break-all'>
                                                {`${userSubmissions.fileUUID.slice(0, 8)}...${userSubmissions.fileUUID.slice(-4)}`}
                                            </div>
                                        </div>
                                    </div>
                                )}
                                <div className='flex flex-col sm:flex-row pt-5 font-medium space-y-1 sm:space-y-0 sm:space-x-2 text-xs items-center text-slate-500 text-center sm:text-left bg-slate-50 rounded-lg px-3 py-2 mt-5 border border-slate-100 w-full sm:w-auto'>
                                    <Info size={15} className="mx-auto sm:mx-0 text-slate-400" />
                                    <p>Allowed formats: pdf, docx, mp4, jpg, jpeg, png, pptx, zip</p>
                                </div>
                                {!access_token ? (
                                    <div className="flex justify-center items-center w-full mt-5">
                                        <div className="flex justify-center bg-amber-50 border border-amber-100 rounded-md text-amber-600 space-x-2 items-center p-3 transition-all shadow-xs w-full sm:w-auto">
                                            <Info size={15} className="text-amber-500" />
                                            <div className="text-xs sm:text-sm font-medium">Please sign in to upload files</div>
                                        </div>
                                    </div>
                                ) : isLoading ? (
                                    <div className="flex justify-center items-center w-full mt-5">
                                        <input
                                            type="file"
                                            id="fileInput"
                                            style={{ display: 'none' }}
                                            onChange={handleFileChange}
                                        />
                                        <div className="font-medium animate-pulse antialiased items-center bg-slate-100 text-slate-600 text-xs sm:text-sm rounded-md px-4 sm:px-5 py-2.5 flex">
                                            <Loader size={15} className="mr-2" />
                                            <span>Loading</span>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex justify-center items-center w-full mt-5">
                                        <input
                                            type="file"
                                            id={"fileInput_" + assignmentTaskUUID}
                                            style={{ display: 'none' }}
                                            onChange={handleFileChange}
                                        />
                                        <button
                                            className="font-medium antialiased items-center text-white text-xs sm:text-sm rounded-md px-4 sm:px-5 py-2.5 flex bg-emerald-500 hover:bg-emerald-600 transition-colors shadow-xs"
                                            onClick={() => document.getElementById("fileInput_" + assignmentTaskUUID)?.click()}
                                        >
                                            <UploadCloud size={15} className="mr-2" />
                                            <span>Submit File</span>
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </>
            )}
        </AssignmentBoxUI>
    )
}



================================================
FILE: apps/web/app/orgs/[orgslug]/dash/assignments/[assignmentuuid]/_components/TaskEditor/Subs/TaskTypes/TaskFormObject.tsx
================================================
import { useAssignments } from '@components/Contexts/Assignments/AssignmentContext';
import { useAssignmentsTask, useAssignmentsTaskDispatch } from '@components/Contexts/Assignments/AssignmentsTaskContext';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import AssignmentBoxUI from '@components/Objects/Activities/Assignment/AssignmentBoxUI';
import { getAssignmentTask, getAssignmentTaskSubmissionsMe, getAssignmentTaskSubmissionsUser, handleAssignmentTaskSubmission, updateAssignmentTask } from '@services/courses/assignments';
import { Check, Info, Minus, Plus, PlusCircle, X, Type } from 'lucide-react';
import React, { useEffect, useState } from 'react';
import toast from 'react-hot-toast';
import { v4 as uuidv4 } from 'uuid';

type FormSchema = {
    questionText: string;
    questionUUID?: string;
    blanks: {
        blankUUID?: string;
        placeholder: string;
        correctAnswer: string;
        hint?: string;
    }[];
};

type FormSubmitSchema = {
    questions: FormSchema[];
    submissions: {
        questionUUID: string;
        blankUUID: string;
        answer: string;
    }[];
    assignment_task_submission_uuid?: string;
};

type TaskFormObjectProps = {
    view: 'teacher' | 'student' | 'grading';
    assignmentTaskUUID: string;
    user_id?: string;
};

function TaskFormObject({ view, assignmentTaskUUID, user_id }: TaskFormObjectProps) {
    const session = useLHSession() as any;
    const access_token = session?.data?.tokens?.access_token;
    const assignmentTaskState = useAssignmentsTask() as any;
    const assignmentTaskStateHook = useAssignmentsTaskDispatch() as any;
    const assignment = useAssignments() as any;

    /* TEACHER VIEW CODE */
    const [questions, setQuestions] = useState<FormSchema[]>(
        view === 'teacher' ? [
            { 
                questionText: '', 
                questionUUID: 'question_' + uuidv4(), 
                blanks: [{ 
                    placeholder: 'Enter the correct answer', 
                    correctAnswer: '', 
                    hint: '',
                    blankUUID: 'blank_' + uuidv4() 
                }] 
            },
        ] : []
    );

    const handleQuestionChange = (index: number, value: string) => {
        const updatedQuestions = [...questions];
        updatedQuestions[index].questionText = value;
        setQuestions(updatedQuestions);
    };

    const handleBlankChange = (qIndex: number, bIndex: number, field: 'placeholder' | 'correctAnswer' | 'hint', value: string) => {
        const updatedQuestions = [...questions];
        updatedQuestions[qIndex].blanks[bIndex][field] = value;
        setQuestions(updatedQuestions);
    };

    const addBlank = (qIndex: number) => {
        const updatedQuestions = [...questions];
        updatedQuestions[qIndex].blanks.push({ 
            placeholder: 'Enter the correct answer', 
            correctAnswer: '', 
            hint: '',
            blankUUID: 'blank_' + uuidv4() 
        });
        setQuestions(updatedQuestions);
    };

    const removeBlank = (qIndex: number, bIndex: number) => {
        const updatedQuestions = [...questions];
        if (updatedQuestions[qIndex].blanks.length > 1) {
            updatedQuestions[qIndex].blanks.splice(bIndex, 1);
            setQuestions(updatedQuestions);
        } else {
            toast.error('Cannot delete the last blank. At least one blank is required.');
        }
    };

    const addQuestion = () => {
        setQuestions([...questions, { 
            questionText: '', 
            questionUUID: 'question_' + uuidv4(), 
            blanks: [{ 
                placeholder: 'Enter the correct answer', 
                correctAnswer: '', 
                hint: '',
                blankUUID: 'blank_' + uuidv4() 
            }] 
        }]);
    };

    const removeQuestion = (qIndex: number) => {
        const updatedQuestions = [...questions];
        updatedQuestions.splice(qIndex, 1);
        setQuestions(updatedQuestions);
    };

    const saveFC = async () => {
        // Save the form to the server
        const values = {
            contents: {
                questions,
            },
        };
        const res = await updateAssignmentTask(values, assignmentTaskState.assignmentTask.assignment_task_uuid, assignment.assignment_object.assignment_uuid, access_token);
        if (res) {
            assignmentTaskStateHook({
                type: 'reload',
            });
            toast.success('Task saved successfully');
        } else {
            console.error('Save error:', res);
            toast.error('Error saving task, please retry later.');
        }
    };

    /* STUDENT VIEW CODE */
    const [userSubmissions, setUserSubmissions] = useState<FormSubmitSchema>({
        questions: [],
        submissions: [],
    });
    const [initialUserSubmissions, setInitialUserSubmissions] = useState<FormSubmitSchema>({
        questions: [],
        submissions: [],
    });
    const [showSavingDisclaimer, setShowSavingDisclaimer] = useState<boolean>(false);
    const [assignmentTaskOutsideProvider, setAssignmentTaskOutsideProvider] = useState<any>(null);
    const [userSubmissionObject, setUserSubmissionObject] = useState<any>(null);

    const handleUserAnswerChange = (questionUUID: string, blankUUID: string, answer: string) => {
        const updatedSubmissions = [...userSubmissions.submissions];
        const existingIndex = updatedSubmissions.findIndex(
            (submission) => submission.questionUUID === questionUUID && submission.blankUUID === blankUUID
        );

        if (existingIndex !== -1) {
            updatedSubmissions[existingIndex].answer = answer;
        } else {
            updatedSubmissions.push({
                questionUUID,
                blankUUID,
                answer,
            });
        }

        setUserSubmissions({
            ...userSubmissions,
            submissions: updatedSubmissions,
        });
    };

    const handleUserAnswerBlur = (questionUUID: string, blankUUID: string, answer: string) => {
        // Auto-focus next blank only when user leaves the current input and it has content
        if (answer.trim() && view === 'student') {
            const allBlanks = questions.flatMap(q => q.blanks.map(b => ({ questionUUID: q.questionUUID, blankUUID: b.blankUUID })));
            const currentIndex = allBlanks.findIndex(b => b.questionUUID === questionUUID && b.blankUUID === blankUUID);
            const nextBlank = allBlanks[currentIndex + 1];
            
            if (nextBlank) {
                setTimeout(() => {
                    const nextInput = document.querySelector(`[data-blank-id="${nextBlank.blankUUID}"]`) as HTMLInputElement;
                    if (nextInput && !nextInput.value.trim()) {
                        nextInput.focus();
                    }
                }, 100);
            }
        }
    };

    const submitFC = async () => {
        if (userSubmissions.submissions.length === 0) {
            toast.error('Please fill in at least one blank before submitting.');
            return;
        }

        const values = {
            assignment_task_submission_uuid: userSubmissions.assignment_task_submission_uuid || null,
            task_submission: userSubmissions,
            grade: 0,
            task_submission_grade_feedback: '',
        };

        const res = await handleAssignmentTaskSubmission(
            values,
            assignmentTaskUUID,
            assignment.assignment_object.assignment_uuid,
            access_token
        );

        if (res) {
            toast.success('Form submitted successfully!');
            // Update userSubmissions with the returned UUID for future updates
            const updatedUserSubmissions = {
                ...userSubmissions,
                assignment_task_submission_uuid: res.data?.assignment_task_submission_uuid || userSubmissions.assignment_task_submission_uuid
            };
            setUserSubmissions(updatedUserSubmissions);
            setInitialUserSubmissions(updatedUserSubmissions);
            setShowSavingDisclaimer(false);
        } else {
            console.error('Submission error:', res);
            toast.error('Error submitting form, please retry later.');
        }
    };

    const gradeFC = async () => {
        if (!user_id) {
            toast.error('User ID is required for grading.');
            return;
        }

        // Calculate grade based on correct answers
        let correctAnswers = 0;
        let totalBlanks = 0;

        questions.forEach((question) => {
            question.blanks.forEach((blank) => {
                totalBlanks++;
                const userAnswer = userSubmissions.submissions.find(
                    (submission) => submission.questionUUID === question.questionUUID && submission.blankUUID === blank.blankUUID
                );
                if (userAnswer && userAnswer.answer.toLowerCase().trim() === blank.correctAnswer.toLowerCase().trim()) {
                    correctAnswers++;
                }
            });
        });

        const maxPoints = assignmentTaskOutsideProvider?.max_grade_value || 100;
        const finalGrade = totalBlanks > 0 ? Math.round((correctAnswers / totalBlanks) * maxPoints) : 0;

        // Save the grade to the server
        const values = {
            assignment_task_submission_uuid: userSubmissions.assignment_task_submission_uuid,
            task_submission: userSubmissions,
            grade: finalGrade,
            task_submission_grade_feedback: 'Auto graded by system',
        };

        const res = await handleAssignmentTaskSubmission(values, assignmentTaskUUID, assignment.assignment_object.assignment_uuid, access_token);
        if (res) {
            getAssignmentTaskSubmissionFromIdentifiedUserUI();
            toast.success(`Task graded successfully with ${finalGrade} points (${correctAnswers}/${totalBlanks} correct)`);
        } else {
            toast.error('Error grading task, please retry later.');
        }
    };

    async function getAssignmentTaskSubmissionFromIdentifiedUserUI() {
        if (!access_token || !user_id) {
            return;
        }
        
        if (assignmentTaskUUID) {
            const res = await getAssignmentTaskSubmissionsUser(assignmentTaskUUID, user_id, assignment.assignment_object.assignment_uuid, access_token);
            if (res.success) {
                setUserSubmissions({
                    ...res.data.task_submission,
                    assignment_task_submission_uuid: res.data.assignment_task_submission_uuid
                });
                setInitialUserSubmissions({
                    ...res.data.task_submission,
                    assignment_task_submission_uuid: res.data.assignment_task_submission_uuid
                });
                setUserSubmissionObject(res.data);
            }
        }
    }

    useEffect(() => {
        const loadAssignmentTask = async () => {
            if (assignmentTaskUUID) {
                const res = await getAssignmentTask(assignmentTaskUUID, access_token);
                if (res.success) {
                    setAssignmentTaskOutsideProvider(res.data);
                    // Only set questions if they exist and we're not in teacher view, or if we're in teacher view and there are existing questions
                    if (res.data.contents?.questions && res.data.contents.questions.length > 0) {
                        setQuestions(res.data.contents.questions);
                    } else if (view !== 'teacher') {
                        // For non-teacher views, set empty array if no questions exist
                        setQuestions([]);
                    }
                    // For teacher view, keep the initial state if no questions exist
                }
            }
        };

        const loadUserSubmissions = async () => {
            if (view === 'student' && assignmentTaskUUID) {
                const res = await getAssignmentTaskSubmissionsMe(assignmentTaskUUID, assignment.assignment_object.assignment_uuid, access_token);
                if (res.success) {
                    setUserSubmissions({
                        ...res.data.task_submission,
                        assignment_task_submission_uuid: res.data.assignment_task_submission_uuid
                    });
                    setInitialUserSubmissions({
                        ...res.data.task_submission,
                        assignment_task_submission_uuid: res.data.assignment_task_submission_uuid
                    });
                }
            }
        };

        // Set assignment task UUID in context
        assignmentTaskStateHook({
            setSelectedAssignmentTaskUUID: assignmentTaskUUID,
        });

        // Teacher area - Load from context first, then from API if needed
        if (view === 'teacher') {
            if (assignmentTaskState.assignmentTask.contents?.questions) {
                setQuestions(assignmentTaskState.assignmentTask.contents.questions);
            } else {
                loadAssignmentTask();
            }
        }
        // Student area
        else if (view === 'student') {
            loadAssignmentTask();
            loadUserSubmissions();
        }
        // Grading area
        else if (view === 'grading') {
            loadAssignmentTask();
            getAssignmentTaskSubmissionFromIdentifiedUserUI();
        }
    }, [assignmentTaskState, assignment, assignmentTaskStateHook, access_token, assignmentTaskUUID, view]);

    useEffect(() => {
        if (JSON.stringify(userSubmissions) !== JSON.stringify(initialUserSubmissions)) {
            setShowSavingDisclaimer(true);
        } else {
            setShowSavingDisclaimer(false);
        }
    }, [userSubmissions, initialUserSubmissions]);

    // Ensure questions is always an array for teacher view
    if (view === 'teacher' && (!questions || questions.length === 0)) {
        setQuestions([
            { 
                questionText: '', 
                questionUUID: 'question_' + uuidv4(), 
                blanks: [{ 
                    placeholder: 'Enter the correct answer', 
                    correctAnswer: '', 
                    hint: '',
                    blankUUID: 'blank_' + uuidv4() 
                }] 
            },
        ]);
        return null; // Return null to prevent rendering while state updates
    }

    if (view === 'teacher' || (questions && questions.length > 0)) {
        return (
            <AssignmentBoxUI 
                submitFC={submitFC} 
                saveFC={saveFC} 
                gradeFC={gradeFC} 
                view={view} 
                currentPoints={userSubmissionObject?.grade} 
                maxPoints={assignmentTaskOutsideProvider?.max_grade_value} 
                showSavingDisclaimer={showSavingDisclaimer} 
                type="form"
            >
                {view === 'grading' && (
                    <div className="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200">
                        <h3 className="text-sm font-semibold text-gray-800 mb-2">Submission Summary</h3>
                        <div className="grid grid-cols-3 gap-4 text-sm">
                            <div className="text-center">
                                <div className="text-lg font-bold text-blue-600">
                                    {questions.flatMap(q => q.blanks).length}
                                </div>
                                <div className="text-gray-600">Total Blanks</div>
                            </div>
                            <div className="text-center">
                                <div className="text-lg font-bold text-green-600">
                                    {questions.flatMap(q => q.blanks).filter(blank => {
                                        const userAnswer = userSubmissions.submissions.find(s => s.blankUUID === blank.blankUUID);
                                        return userAnswer && userAnswer.answer.toLowerCase().trim() === blank.correctAnswer.toLowerCase().trim();
                                    }).length}
                                </div>
                                <div className="text-gray-600">Correct</div>
                            </div>
                            <div className="text-center">
                                <div className="text-lg font-bold text-red-600">
                                    {questions.flatMap(q => q.blanks).length - questions.flatMap(q => q.blanks).filter(blank => {
                                        const userAnswer = userSubmissions.submissions.find(s => s.blankUUID === blank.blankUUID);
                                        return userAnswer && userAnswer.answer.toLowerCase().trim() === blank.correctAnswer.toLowerCase().trim();
                                    }).length}
                                </div>
                                <div className="text-gray-600">Incorrect</div>
                            </div>
                        </div>
                    </div>
                )}
                <div className="flex flex-col space-y-6">
                    {questions && questions.map((question, qIndex) => (
                        <div key={qIndex} className="flex flex-col space-y-1.5">
                            <div className="flex space-x-2 items-center">
                                {view === 'teacher' ? (
                                    <input
                                        value={question.questionText}
                                        onChange={(e) => handleQuestionChange(qIndex, e.target.value)}
                                        placeholder="Enter your question with blanks (use ___ for blanks)"
                                        className="w-full px-3 text-neutral-600 bg-[#00008b00] border-2 border-gray-200 rounded-md border-dotted text-sm font-bold"
                                    />
                                ) : (
                                    <p className="w-full px-3 text-neutral-600 bg-[#00008b00] border-2 border-gray-200 rounded-md border-dotted text-sm font-bold">
                                        {question.questionText}
                                    </p>
                                )}
                                {view === 'teacher' && (
                                    <div
                                        className="w-[20px] flex-none flex items-center h-[20px] rounded-lg bg-slate-200/60 text-slate-500 hover:bg-slate-300 text-sm transition-all ease-linear cursor-pointer"
                                        onClick={() => removeQuestion(qIndex)}
                                    >
                                        <Minus size={12} className="mx-auto" />
                                    </div>
                                )}
                            </div>

                            {/* Blanks section */}
                            <div className="flex flex-col space-y-2">
                                {question.blanks.map((blank, bIndex) => (
                                    <div key={bIndex} className="flex">
                                        <div className={"blank-item outline-3 outline-white pr-2 shadow-sm w-full flex items-center space-x-2 min-h-[40px] hover:bg-opacity-100 hover:shadow-md rounded-lg bg-white text-sm duration-150 ease-linear nice-shadow " + (view == 'student' ? 'active:scale-105' : '')}>
                                            <div className="font-bold text-base flex items-center justify-center h-full w-[40px] rounded-l-md text-slate-800 bg-slate-100/80">
                                                <Type size={14} />
                                            </div>
                                            {view === 'teacher' ? (
                                                <div className="flex flex-col space-y-1 w-full py-2">
                                                    <input
                                                        value={blank.placeholder}
                                                        onChange={(e) => handleBlankChange(qIndex, bIndex, 'placeholder', e.target.value)}
                                                        placeholder="Placeholder text for the blank"
                                                        className="w-full mx-2 px-3 pr-6 text-neutral-600 bg-[#00008b00] border-2 border-gray-200 rounded-md border-dotted text-sm font-bold"
                                                    />
                                                    <input
                                                        value={blank.correctAnswer}
                                                        onChange={(e) => handleBlankChange(qIndex, bIndex, 'correctAnswer', e.target.value)}
                                                        placeholder="Correct answer"
                                                        className="w-full mx-2 px-3 pr-6 text-neutral-600 bg-lime-50 border-2 border-lime-200 rounded-md border-dotted text-sm font-bold"
                                                    />
                                                    <input
                                                        value={blank.hint || ''}
                                                        onChange={(e) => handleBlankChange(qIndex, bIndex, 'hint', e.target.value)}
                                                        placeholder="Hint (optional)"
                                                        className="w-full mx-2 px-3 pr-6 text-neutral-600 bg-blue-50 border-2 border-blue-200 rounded-md border-dotted text-xs"
                                                    />
                                                </div>
                                            ) : view === 'grading' ? (
                                                <div className="flex flex-col space-y-1 w-full py-2">
                                                    <div className="flex items-center space-x-2 w-full mx-2">
                                                        <input
                                                            value={userSubmissions.submissions.find(
                                                                (submission) => submission.questionUUID === question.questionUUID && submission.blankUUID === blank.blankUUID
                                                            )?.answer || ''}
                                                            readOnly
                                                            className="flex-1 px-3 pr-6 text-neutral-600 bg-gray-50 border-2 border-gray-200 rounded-md text-sm font-bold"
                                                        />
                                                    </div>
                                                    <div className="mx-2 text-xs text-gray-600">
                                                        <span className="font-semibold">Expected:</span> {blank.correctAnswer}
                                                    </div>
                                                    {blank.hint && (
                                                        <div className="mx-2 text-xs text-blue-600 italic">ğŸ’¡ {blank.hint}</div>
                                                    )}
                                                </div>
                                            ) : (
                                                <div className="flex flex-col space-y-1 w-full py-2">
                                                    <input
                                                        value={userSubmissions.submissions?.find(
                                                            (submission) => submission.questionUUID === question.questionUUID && submission.blankUUID === blank.blankUUID
                                                        )?.answer || ''}
                                                        onChange={(e) => handleUserAnswerChange(question.questionUUID!, blank.blankUUID!, e.target.value)}
                                                        onBlur={(e) => handleUserAnswerBlur(question.questionUUID!, blank.blankUUID!, e.target.value)}
                                                        placeholder={blank.placeholder}
                                                        data-blank-id={blank.blankUUID}
                                                        className="w-full mx-2 px-3 pr-6 text-neutral-600 bg-[#00008b00] border-2 border-gray-200 rounded-md focus:border-blue-400 focus:ring-2 focus:ring-blue-200 text-sm font-bold transition-all"
                                                    />
                                                    {blank.hint && (
                                                        <div className="mx-2 text-xs text-blue-600 italic">ğŸ’¡ {blank.hint}</div>
                                                    )}
                                                </div>
                                            )}
                                            {view === 'teacher' && (
                                                <div
                                                    className="w-[20px] flex-none flex items-center h-[20px] rounded-lg bg-slate-200/60 text-slate-500 hover:bg-slate-300 text-sm transition-all ease-linear cursor-pointer"
                                                    onClick={() => removeBlank(qIndex, bIndex)}
                                                >
                                                    <Minus size={12} className="mx-auto" />
                                                </div>
                                            )}
                                            {view === 'grading' && (
                                                <div className={`w-fit flex-none flex text-xs px-2 py-0.5 space-x-1 items-center h-fit rounded-lg ${
                                                    userSubmissions.submissions.find(
                                                        (submission) => submission.questionUUID === question.questionUUID && submission.blankUUID === blank.blankUUID
                                                    )?.answer?.toLowerCase().trim() === blank.correctAnswer.toLowerCase().trim()
                                                        ? 'bg-lime-200 text-lime-600'
                                                        : 'bg-rose-200/60 text-rose-500'
                                                } text-sm`}>
                                                    {userSubmissions.submissions.find(
                                                        (submission) => submission.questionUUID === question.questionUUID && submission.blankUUID === blank.blankUUID
                                                    )?.answer?.toLowerCase().trim() === blank.correctAnswer.toLowerCase().trim() ? (
                                                        <>
                                                            <Check size={12} className="mx-auto" />
                                                            <p className="mx-auto font-bold text-xs">Correct</p>
                                                        </>
                                                    ) : (
                                                        <>
                                                            <X size={12} className="mx-auto" />
                                                            <p className="mx-auto font-bold text-xs">Incorrect</p>
                                                        </>
                                                    )}
                                                </div>
                                            )}
                                            {view === 'student' && (
                                                <div className={`w-[20px] flex-none flex items-center h-[20px] rounded-lg ${
                                                    userSubmissions.submissions.find(
                                                        (submission) => submission.questionUUID === question.questionUUID && submission.blankUUID === blank.blankUUID
                                                    )?.answer?.trim()
                                                        ? "bg-green-200/60 text-green-500"
                                                        : "bg-slate-200/60 text-slate-500"
                                                } text-sm transition-all ease-linear`}>
                                                    {userSubmissions.submissions.find(
                                                        (submission) => submission.questionUUID === question.questionUUID && submission.blankUUID === blank.blankUUID
                                                    )?.answer?.trim() ? (
                                                        <Check size={12} className="mx-auto" />
                                                    ) : (
                                                        <X size={12} className="mx-auto" />
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                        {view === 'teacher' && bIndex === question.blanks.length - 1 && question.blanks.length <= 4 && (
                                            <div className="flex justify-center mx-auto px-2">
                                                <div
                                                    className="outline-3 outline-white px-2 shadow-sm w-full flex items-center h-[40px] hover:bg-opacity-100 hover:shadow-md rounded-lg bg-white duration-150 cursor-pointer ease-linear nice-shadow"
                                                    onClick={() => addBlank(qIndex)}
                                                >
                                                    <Plus size={14} className="inline-block" />
                                                    <span></span>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
                {view === 'teacher' && questions.length <= 5 && (
                    <div className="flex justify-center mx-auto px-2">
                        <div
                            className="flex w-full my-2 py-2 px-4 bg-white text-slate text-xs rounded-md nice-shadow hover:shadow-xs cursor-pointer space-x-3 items-center transition duration-150 ease-linear"
                            onClick={addQuestion}
                        >
                            <PlusCircle size={14} className="inline-block" />
                            <span>Add Question</span>
                        </div>
                    </div>
                )}
            </AssignmentBoxUI>
        );
    }

    return (
        <div className='flex flex-row space-x-2 text-sm items-center'>
            <Info size={12} />
            <p>No questions found</p>
        </div>
    );
}

export default TaskFormObject; 


================================================
FILE: apps/web/app/orgs/[orgslug]/dash/assignments/[assignmentuuid]/_components/TaskEditor/Subs/TaskTypes/TaskQuizObject.tsx
================================================
import { useAssignments } from '@components/Contexts/Assignments/AssignmentContext';
import { useAssignmentsTask, useAssignmentsTaskDispatch } from '@components/Contexts/Assignments/AssignmentsTaskContext';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import AssignmentBoxUI from '@components/Objects/Activities/Assignment/AssignmentBoxUI';
import { getAssignmentTask, getAssignmentTaskSubmissionsMe, getAssignmentTaskSubmissionsUser, handleAssignmentTaskSubmission, updateAssignmentTask } from '@services/courses/assignments';
import { Check, Info, Minus, Plus, PlusCircle, X } from 'lucide-react';
import React, { useEffect, useState } from 'react';
import toast from 'react-hot-toast';
import { v4 as uuidv4 } from 'uuid';

type QuizSchema = {
    questionText: string;
    questionUUID?: string;
    options: {
        optionUUID?: string;
        text: string;
        fileID: string;
        type: 'text' | 'image' | 'audio' | 'video';
        assigned_right_answer: boolean;
    }[];
};

type QuizSubmitSchema = {
    questions: QuizSchema[];
    submissions: {
        questionUUID: string;
        optionUUID: string;
        answer: boolean
    }[];
    assignment_task_submission_uuid?: string;
};

type TaskQuizObjectProps = {
    view: 'teacher' | 'student' | 'grading';
    user_id?: string; // Only for read-only view
    assignmentTaskUUID?: string;
};

type Submission = {
    questionUUID: string;
    optionUUID: string;
    answer: boolean;
};

function TaskQuizObject({ view, assignmentTaskUUID, user_id }: TaskQuizObjectProps) {
    const session = useLHSession() as any;
    const access_token = session?.data?.tokens?.access_token;
    const assignmentTaskState = useAssignmentsTask() as any;
    const assignmentTaskStateHook = useAssignmentsTaskDispatch() as any;
    const assignment = useAssignments() as any;


    /* TEACHER VIEW CODE */
    const [questions, setQuestions] = useState<QuizSchema[]>([
        { questionText: '', questionUUID: 'question_' + uuidv4(), options: [{ text: '', fileID: '', type: 'text', assigned_right_answer: false, optionUUID: 'option_' + uuidv4() }] },
    ]);

    const handleQuestionChange = (index: number, value: string) => {
        const updatedQuestions = [...questions];
        updatedQuestions[index].questionText = value;
        setQuestions(updatedQuestions);
    };

    const handleOptionChange = (qIndex: number, oIndex: number, value: string) => {
        const updatedQuestions = [...questions];
        updatedQuestions[qIndex].options[oIndex].text = value;
        setQuestions(updatedQuestions);
    };

    const addOption = (qIndex: number) => {
        const updatedQuestions = [...questions];
        updatedQuestions[qIndex].options.push({ text: '', fileID: '', type: 'text', assigned_right_answer: false, optionUUID: 'option_' + uuidv4() });
        setQuestions(updatedQuestions);
    };

    const removeOption = (qIndex: number, oIndex: number) => {
        const updatedQuestions = [...questions];
        if (updatedQuestions[qIndex].options.length > 1) {
            updatedQuestions[qIndex].options.splice(oIndex, 1);
            setQuestions(updatedQuestions);
        } else {
            toast.error('Cannot delete the last option. At least one option is required.');
        }
    };

    const addQuestion = () => {
        setQuestions([...questions, { questionText: '', questionUUID: 'question_' + uuidv4(), options: [{ text: '', fileID: '', type: 'text', assigned_right_answer: false, optionUUID: 'option_' + uuidv4() }] }]);
    };

    const removeQuestion = (qIndex: number) => {
        const updatedQuestions = [...questions];
        updatedQuestions.splice(qIndex, 1);
        setQuestions(updatedQuestions);
    };

    const toggleOption = (qIndex: number, oIndex: number) => {
        const updatedQuestions = [...questions];
        // Find the option to toggle
        const optionToToggle = updatedQuestions[qIndex].options[oIndex];
        // Toggle the 'correct' property of the option
        optionToToggle.assigned_right_answer = !optionToToggle.assigned_right_answer;
        setQuestions(updatedQuestions);
    };

    const saveFC = async () => {
        // Save the quiz to the server
        const values = {
            contents: {
                questions,
            },
        };
        const res = await updateAssignmentTask(values, assignmentTaskState.assignmentTask.assignment_task_uuid, assignment.assignment_object.assignment_uuid, access_token);
        if (res) {
            assignmentTaskStateHook({
                type: 'reload',
            });
            toast.success('Task saved successfully');
        } else {
            toast.error('Error saving task, please retry later.');
        }
    };
    /* TEACHER VIEW CODE */

    /* STUDENT VIEW CODE */
    const [userSubmissions, setUserSubmissions] = useState<QuizSubmitSchema>({
        questions: [],
        submissions: [],
    });
    const [initialUserSubmissions, setInitialUserSubmissions] = useState<QuizSubmitSchema>({
        questions: [],
        submissions: [],
    });
    const [showSavingDisclaimer, setShowSavingDisclaimer] = useState<boolean>(false);
    const [assignmentTaskOutsideProvider, setAssignmentTaskOutsideProvider] = useState<any>(null);

    async function chooseOption(qIndex: number, oIndex: number) {
        const updatedSubmissions = [...userSubmissions.submissions];
        const question = questions[qIndex];
        const option = question?.options[oIndex];

        if (!question || !option) return;

        const questionUUID = question.questionUUID;
        const optionUUID = option.optionUUID;

        if (!questionUUID || !optionUUID) return;

        const submissionIndex = updatedSubmissions.findIndex(
            (submission) => submission.questionUUID === questionUUID && submission.optionUUID === optionUUID
        );

        if (submissionIndex === -1) {
            updatedSubmissions.push({ questionUUID, optionUUID, answer: true });
        } else {
            updatedSubmissions[submissionIndex].answer = !updatedSubmissions[submissionIndex].answer;
        }

        setUserSubmissions({
            ...userSubmissions,
            submissions: updatedSubmissions,
        });
    }

    async function getAssignmentTaskUI() {
        if (assignmentTaskUUID) {
            const res = await getAssignmentTask(assignmentTaskUUID, access_token);
            if (res.success) {
                setAssignmentTaskOutsideProvider(res.data);
                setQuestions(res.data.contents.questions);
            }

        }
    }

    async function getAssignmentTaskSubmissionFromUserUI() {
        if (assignmentTaskUUID) {
            const res = await getAssignmentTaskSubmissionsMe(assignmentTaskUUID, assignment.assignment_object.assignment_uuid, access_token);
            if (res.success) {
                setUserSubmissions({
                    ...res.data.task_submission,
                    assignment_task_submission_uuid: res.data.assignment_task_submission_uuid
                });
                setInitialUserSubmissions({
                    ...res.data.task_submission,
                    assignment_task_submission_uuid: res.data.assignment_task_submission_uuid
                });
            }

        }
    }

    // Detect changes between initial and current submissions
    useEffect(() => {
        const hasChanges = JSON.stringify(initialUserSubmissions.submissions) !== JSON.stringify(userSubmissions.submissions);
        setShowSavingDisclaimer(hasChanges);
    }, [userSubmissions, initialUserSubmissions.submissions]);



    const submitFC = async () => {
        // Ensure all questions and options have submissions
        const updatedSubmissions: Submission[] = questions.flatMap(question => {
            return question.options.map(option => {
                const existingSubmission = userSubmissions.submissions.find(
                    submission => submission.questionUUID === question.questionUUID && submission.optionUUID === option.optionUUID
                );
                
                return existingSubmission || {
                    questionUUID: question.questionUUID || '',
                    optionUUID: option.optionUUID || '',
                    answer: false // Mark unsubmitted options as false
                };
            });
        });

        // Update userSubmissions with the complete set of submissions
        const updatedUserSubmissions: QuizSubmitSchema = {
            ...userSubmissions,
            submissions: updatedSubmissions
        };

        // Save the quiz to the server
        const values = {
            assignment_task_submission_uuid: userSubmissions.assignment_task_submission_uuid || null,
            task_submission: updatedUserSubmissions,
            grade: 0,
            task_submission_grade_feedback: '',
        };

        if (assignmentTaskUUID) {
            const res = await handleAssignmentTaskSubmission(values, assignmentTaskUUID, assignment.assignment_object.assignment_uuid, access_token);
            if (res) {
                assignmentTaskStateHook({
                    type: 'reload',
                });
                toast.success('Task saved successfully');
                setShowSavingDisclaimer(false);
                // Update userSubmissions with the returned UUID for future updates
                const updatedUserSubmissionsWithUUID = {
                    ...updatedUserSubmissions,
                    assignment_task_submission_uuid: res.data?.assignment_task_submission_uuid || userSubmissions.assignment_task_submission_uuid
                };
                setUserSubmissions(updatedUserSubmissionsWithUUID);
                setInitialUserSubmissions(updatedUserSubmissionsWithUUID);
            } else {
                toast.error('Error saving task, please retry later.');
            }
        }
    };

    /* STUDENT VIEW CODE */

    /* GRADING VIEW CODE */
    const [userSubmissionObject, setUserSubmissionObject] = useState<any>(null);
    async function getAssignmentTaskSubmissionFromIdentifiedUserUI() {
        if (assignmentTaskUUID && user_id) {
            const res = await getAssignmentTaskSubmissionsUser(assignmentTaskUUID, user_id, assignment.assignment_object.assignment_uuid, access_token);
            if (res.success) {
                setUserSubmissions({
                    ...res.data.task_submission,
                    assignment_task_submission_uuid: res.data.assignment_task_submission_uuid
                });
                setUserSubmissionObject(res.data);
                setInitialUserSubmissions({
                    ...res.data.task_submission,
                    assignment_task_submission_uuid: res.data.assignment_task_submission_uuid
                });
            }

        }
    }

    async function gradeFC() {
        if (assignmentTaskUUID) {
            const maxPoints = assignmentTaskOutsideProvider?.max_grade_value || 100;
            const totalOptions = questions.reduce((total, question) => total + question.options.length, 0);
            let correctAnswers = 0;

            questions.forEach((question) => {
                question.options.forEach((option) => {
                    const submission = userSubmissions.submissions.find(
                        (sub) => sub.questionUUID === question.questionUUID && sub.optionUUID === option.optionUUID
                    );
                    if (submission?.answer === option.assigned_right_answer) {
                        correctAnswers++;
                    }
                });
            });

            const finalGrade = Math.round((correctAnswers / totalOptions) * maxPoints);

            // Save the grade to the server
            const values = {
                assignment_task_submission_uuid: userSubmissions.assignment_task_submission_uuid,
                task_submission: userSubmissions,
                grade: finalGrade,
                task_submission_grade_feedback: 'Auto graded by system',
            };

            const res = await handleAssignmentTaskSubmission(values, assignmentTaskUUID, assignment.assignment_object.assignment_uuid, access_token);
            if (res) {
                getAssignmentTaskSubmissionFromIdentifiedUserUI();
                toast.success(`Task graded successfully with ${finalGrade} points`);
            } else {
                toast.error('Error grading task, please retry later.');
            }
        }
    }



    /* GRADING VIEW CODE */

    useEffect(() => {
        assignmentTaskStateHook({
            setSelectedAssignmentTaskUUID: assignmentTaskUUID,
        });
        // Teacher area
        if (view == 'teacher' && assignmentTaskState.assignmentTask.contents?.questions) {
            setQuestions(assignmentTaskState.assignmentTask.contents.questions);
        }
        // Student area
        else if (view == 'student') {
            getAssignmentTaskUI();
            getAssignmentTaskSubmissionFromUserUI();
        }

        // Grading area
        else if (view == 'grading') {
            getAssignmentTaskUI();
            //setQuestions(assignmentTaskState.assignmentTask.contents.questions);
            getAssignmentTaskSubmissionFromIdentifiedUserUI();

        }
    }, [assignmentTaskState, assignment, assignmentTaskStateHook, access_token]);

    if (questions && questions.length >= 0) {
        return (
            <AssignmentBoxUI submitFC={submitFC} saveFC={saveFC} gradeFC={gradeFC} view={view} currentPoints={userSubmissionObject?.grade} maxPoints={assignmentTaskOutsideProvider?.max_grade_value} showSavingDisclaimer={showSavingDisclaimer} type="quiz">
                <div className="flex flex-col space-y-6">
                    {questions && questions.map((question, qIndex) => (
                        <div key={qIndex} className="flex flex-col space-y-1.5">
                            <div className="flex space-x-2 items-center">
                                {view === 'teacher' ? (
                                    <input
                                        value={question.questionText}
                                        onChange={(e) => handleQuestionChange(qIndex, e.target.value)}
                                        placeholder="Question"
                                        className="w-full px-3 text-neutral-600 bg-[#00008b00] border-2 border-gray-200 rounded-md border-dotted text-sm font-bold"
                                    />
                                ) : (
                                    <p className="w-full px-3 text-neutral-600 bg-[#00008b00] border-2 border-gray-200 rounded-md border-dotted text-sm font-bold">
                                        {question.questionText}
                                    </p>
                                )}
                                {view === 'teacher' && (
                                    <div
                                        className="w-[20px] flex-none flex items-center h-[20px] rounded-lg bg-slate-200/60 text-slate-500 hover:bg-slate-300 text-sm transition-all ease-linear cursor-pointer"
                                        onClick={() => removeQuestion(qIndex)}
                                    >
                                        <Minus size={12} className="mx-auto" />
                                    </div>
                                )}
                            </div>
                            <div className="flex flex-col space-y-2">
                                {question.options.map((option, oIndex) => (
                                    <div className="flex" key={oIndex}>
                                        <div
                                            onClick={() => view === 'student' && chooseOption(qIndex, oIndex)}
                                            className={"answer outline outline-3 outline-white pr-2 shadow-sm w-full flex items-center space-x-2 h-[30px] hover:bg-opacity-100 hover:shadow-md rounded-lg bg-white text-sm duration-150 cursor-pointer ease-linear nice-shadow " + (view == 'student' ? 'active:scale-110' : '')}
                                        >
                                            <div className="font-bold text-base flex items-center h-full w-[40px] rounded-l-md text-slate-800 bg-slate-100/80">
                                                <p className="mx-auto font-bold text-sm">{String.fromCharCode(65 + oIndex)}</p>
                                            </div>
                                            {view === 'teacher' ? (
                                                <input
                                                    type="text"
                                                    value={option.text}
                                                    onChange={(e) => handleOptionChange(qIndex, oIndex, e.target.value)}
                                                    placeholder="Option"
                                                    className="w-full mx-2 px-3 pr-6 text-neutral-600 bg-[#00008b00] border-2 border-gray-200 rounded-md border-dotted text-sm font-bold"
                                                />
                                            ) : (
                                                <p className="w-full mx-2 px-3 pr-6 text-neutral-600 bg-[#00008b00] text-sm font-bold">
                                                    {option.text}
                                                </p>
                                            )}
                                            {view === 'teacher' && (
                                                <>
                                                    <div
                                                        className={`w-fit flex-none flex text-xs px-2 py-0.5 space-x-1 items-center h-fit rounded-lg ${option.assigned_right_answer ? 'bg-lime-200 text-lime-600' : 'bg-rose-200/60 text-rose-500'
                                                            } hover:bg-lime-300 text-sm transition-all ease-linear cursor-pointer`}
                                                        onClick={() => toggleOption(qIndex, oIndex)}
                                                    >
                                                        {option.assigned_right_answer ? <Check size={12} className="mx-auto" /> : <X size={12} className="mx-auto" />}
                                                        {option.assigned_right_answer ? (
                                                            <p className="mx-auto font-bold text-xs">True</p>
                                                        ) : (
                                                            <p className="mx-auto font-bold text-xs">False</p>
                                                        )}
                                                    </div>
                                                    <div
                                                        className="w-[20px] flex-none flex items-center h-[20px] rounded-lg bg-slate-200/60 text-slate-500 hover:bg-slate-300 text-sm transition-all ease-linear cursor-pointer"
                                                        onClick={() => removeOption(qIndex, oIndex)}
                                                    >
                                                        <Minus size={12} className="mx-auto" />
                                                    </div>
                                                </>
                                            )}
                                            {view === 'grading' && (
                                                <>
                                                    <div
                                                        className={`w-fit flex-none flex text-xs px-2 py-0.5 space-x-1 items-center h-fit rounded-lg ${option.assigned_right_answer ? 'bg-lime-200 text-lime-600' : 'bg-rose-200/60 text-rose-500'
                                                            } hover:bg-lime-300 text-sm transition-all ease-linear cursor-pointer`}
                                                    >
                                                        {option.assigned_right_answer ? <Check size={12} className="mx-auto" /> : <X size={12} className="mx-auto" />}
                                                        {option.assigned_right_answer ? (
                                                            <p className="mx-auto font-bold text-xs">Marked as True</p>
                                                        ) : (
                                                            <p className="mx-auto font-bold text-xs">Marked as False</p>
                                                        )}
                                                    </div>

                                                </>
                                            )}
                                            {view === 'student' && (
                                                <div 
                                                    className={`w-[20px] flex-none flex items-center h-[20px] rounded-lg ${
                                                        userSubmissions.submissions.find(
                                                            (submission) =>
                                                                submission.questionUUID === question.questionUUID &&
                                                                submission.optionUUID === option.optionUUID &&
                                                                submission.answer
                                                        )
                                                            ? "bg-green-200/60 text-green-500 hover:bg-green-300"
                                                            : "bg-slate-200/60 text-slate-500 hover:bg-slate-300"
                                                    } text-sm transition-all ease-linear cursor-pointer`}
                                                    onClick={() => chooseOption(qIndex, oIndex)}
                                                >
                                                    {userSubmissions.submissions.find(
                                                        (submission) =>
                                                            submission.questionUUID === question.questionUUID &&
                                                            submission.optionUUID === option.optionUUID &&
                                                            submission.answer
                                                    ) ? (
                                                        <Check size={12} className="mx-auto" />
                                                    ) : (
                                                        <X size={12} className="mx-auto" />
                                                    )}
                                                </div>
                                            )}
                                            {view === 'grading' && (
                                                <>
                                                   
                                                    <div className={`w-[20px] flex-none flex items-center h-[20px] rounded-lg ${
                                                        userSubmissions.submissions.find(
                                                            (submission) =>
                                                                submission.questionUUID === question.questionUUID &&
                                                                submission.optionUUID === option.optionUUID &&
                                                                submission.answer
                                                        )
                                                            ? "bg-green-200/60 text-green-500"
                                                            : "bg-slate-200/60 text-slate-500"
                                                    } text-sm`}>
                                                        {userSubmissions.submissions.find(
                                                            (submission) =>
                                                                submission.questionUUID === question.questionUUID &&
                                                                submission.optionUUID === option.optionUUID &&
                                                                submission.answer
                                                        ) ? (
                                                            <Check size={12} className="mx-auto" />
                                                        ) : (
                                                            <X size={12} className="mx-auto" />
                                                        )}
                                                    </div>
                                                </>
                                            )}

                                        </div>
                                        {view === 'teacher' && oIndex === question.options.length - 1 && questions[qIndex].options.length <= 4 && (
                                            <div className="flex justify-center mx-auto px-2">
                                                <div
                                                    className="outline text-xs outline-3 outline-white px-2 shadow-sm w-full flex items-center h-[30px] hover:bg-opacity-100 hover:shadow-md rounded-lg bg-white duration-150 cursor-pointer ease-linear nice-shadow"
                                                    onClick={() => addOption(qIndex)}
                                                >
                                                    <Plus size={14} className="inline-block" />
                                                    <span></span>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
                {view === 'teacher' && questions.length <= 5 && (
                    <div className="flex justify-center mx-auto px-2">
                        <div
                            className="flex w-full my-2 py-2 px-4 bg-white text-slate text-xs rounded-md nice-shadow hover:shadow-xs cursor-pointer space-x-3 items-center transition duration-150 ease-linear"
                            onClick={addQuestion}
                        >
                            <PlusCircle size={14} className="inline-block" />
                            <span>Add Question</span>
                        </div>
                    </div>
                )}
            </AssignmentBoxUI>
        );
    }
    else {
        return <div className='flex flex-row space-x-2 text-sm items-center'>
            <Info size={12} />
            <p>No questions found</p>
        </div>;
    }
}

export default TaskQuizObject;



================================================
FILE: apps/web/app/orgs/[orgslug]/dash/assignments/[assignmentuuid]/subpages/AssignmentEditorSubPage.tsx
================================================
'use client';
import { AssignmentsTaskProvider } from '@components/Contexts/Assignments/AssignmentsTaskContext'
import { LayoutList } from 'lucide-react'
import React from 'react'
import AssignmentTasks from '../_components/Tasks'
import { AssignmentProvider } from '@components/Contexts/Assignments/AssignmentContext'
import dynamic from 'next/dynamic';
const AssignmentTaskEditor = dynamic(() => import('../_components/TaskEditor/TaskEditor'))

function AssignmentEditorSubPage({ assignmentuuid }: { assignmentuuid: string }) {
    return (
        <AssignmentsTaskProvider>
            <div className='flex w-[400px] flex-col h-full custom-dots-bg'>
                <div className='flex mx-auto px-3.5 py-1 bg-neutral-600/80 space-x-2 my-5 items-center text-sm font-bold text-white rounded-full'>
                    <LayoutList size={18} />
                    <p>Tasks</p>
                </div>
                <AssignmentTasks assignment_uuid={'assignment_' + assignmentuuid} />
            </div>
            <div className='flex grow bg-[#fefcfe] nice-shadow h-full w-full'>
                <AssignmentProvider assignment_uuid={'assignment_' + assignmentuuid}>
                    <AssignmentTaskEditor page='general' />
                </AssignmentProvider>
            </div>
        </AssignmentsTaskProvider>
    )
}

export default AssignmentEditorSubPage


================================================
FILE: apps/web/app/orgs/[orgslug]/dash/assignments/[assignmentuuid]/subpages/AssignmentSubmissionsSubPage.tsx
================================================
import { useLHSession } from '@components/Contexts/LHSessionContext';
import UserAvatar from '@components/Objects/UserAvatar';
import Modal from '@components/Objects/StyledElements/Modal/Modal';
import { getAPIUrl } from '@services/config/config';
import { getUserAvatarMediaDirectory } from '@services/media/media';
import { swrFetcher } from '@services/utils/ts/requests';
import { SendHorizonal, UserCheck, X } from 'lucide-react';
import React, { useEffect } from 'react';
import useSWR from 'swr';
import EvaluateAssignment from './Modals/EvaluateAssignment';
import { AssignmentProvider } from '@components/Contexts/Assignments/AssignmentContext';
import { AssignmentsTaskProvider } from '@components/Contexts/Assignments/AssignmentsTaskContext';
import AssignmentSubmissionProvider from '@components/Contexts/Assignments/AssignmentSubmissionContext';

function AssignmentSubmissionsSubPage({ assignment_uuid }: { assignment_uuid: string }) {
    const session = useLHSession() as any;
    const access_token = session?.data?.tokens?.access_token;

    const { data: assignmentSubmission, error: assignmentError } = useSWR(
        `${getAPIUrl()}assignments/assignment_${assignment_uuid}/submissions`,
        (url) => swrFetcher(url, access_token)
    );

    useEffect(() => {
        console.log(assignmentSubmission);
    }, [session, assignmentSubmission]);

    const renderSubmissions = (status: string) => {
        return assignmentSubmission
            ?.filter((submission: any) => submission.submission_status === status)
            .map((submission: any) => (
                <SubmissionBox key={submission.submission_uuid} submission={submission} assignment_uuid={assignment_uuid} user_id={submission.user_id} />
            ));
    };

    return (
        <div className='pl-10 mr-10 flex flex-col pt-3 w-full'>
            <div className='flex flex-row w-full'>
                <div className='flex-1'>
                    <div className='flex w-fit mx-auto px-3.5 py-1 bg-rose-600/80 space-x-2 my-5 items-center text-sm font-bold text-white rounded-full'>
                        <X size={18} />
                        <h3>Late</h3>
                    </div>
                    <div className='flex flex-col gap-4'>
                        {renderSubmissions('LATE')}
                    </div>
                </div>
                <div className='flex-1'>
                    <div className='flex w-fit mx-auto px-3.5 py-1 bg-amber-600/80 space-x-2 my-5 items-center text-sm font-bold text-white rounded-full'>
                        <SendHorizonal size={18} />
                        <h3>Submitted</h3>
                    </div>
                    <div className='flex flex-col gap-4'>
                        {renderSubmissions('SUBMITTED')}
                    </div>
                </div>
                <div className='flex-1'>
                    <div className='flex w-fit mx-auto px-3.5 py-1 bg-emerald-600/80 space-x-2 my-5 items-center text-sm font-bold text-white rounded-full'>
                        <UserCheck size={18} />
                        <h3>Graded</h3>
                    </div>
                    <div className='flex flex-col gap-4'>
                        {renderSubmissions('GRADED')}
                    </div>
                </div>

            </div>
        </div>
    );
}

function SubmissionBox({ assignment_uuid, user_id, submission }: any) {
    const session = useLHSession() as any;
    const access_token = session?.data?.tokens?.access_token;
    const [gradeSudmissionModal, setGradeSubmissionModal] = React.useState({
        open: false,
        submission_id: '',
    });

    const { data: user, error: userError } = useSWR(
        `${getAPIUrl()}users/id/${user_id}`,
        (url) => swrFetcher(url, access_token)
    );

    useEffect(() => {
        console.log(user);
    }
        , [session, user]);

    return (
        <div className='flex flex-row bg-white shadow-[0px_4px_16px_rgba(0,0,0,0.06)] nice-shadow rounded-lg p-4 w-[350px] mx-auto'>
            <div className='flex flex-col space-y-2 w-full'>
                <div className='flex justify-between w-full'>
                    <h2 className='uppercase text-slate-400 text-xs tracking-tight font-semibold'>Submission</h2>
                    <p className='uppercase text-xs tracking-tight font-semibold'>
                        {new Date(submission.creation_date).toLocaleDateString('en-UK', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                        })}
                    </p>
                </div>
                <div className='flex justify-between space-x-2'>
                    <div className='flex space-x-2'>
                        <UserAvatar
                            border="border-4"
                            avatar_url={getUserAvatarMediaDirectory(user?.user_uuid, user?.avatar_image)}
                            predefined_avatar={user?.avatar_image ? undefined : 'empty'}
                            width={40}
                        />
                        <div className='flex flex-col'>
                            {user?.first_name && user?.last_name ? (<p className='text-sm font-semibold'>{user?.first_name} {user?.last_name}</p>) : (<p className='text-sm font-semibold'>@{user?.username}</p>)}
                            <p className='text-xs text-slate-400'>{user?.email}</p>
                        </div>
                    </div>
                    <div className='flex flex-col'>

                        <Modal
                            isDialogOpen={gradeSudmissionModal.open && gradeSudmissionModal.submission_id === submission.submission_uuid}
                            onOpenChange={(open: boolean) => setGradeSubmissionModal({ open, submission_id: submission.submission_uuid })}
                            minHeight="lg"
                            minWidth="lg"
                            dialogContent={
                                <AssignmentProvider assignment_uuid={"assignment_" + assignment_uuid}>
                                    <AssignmentsTaskProvider>
                                        <AssignmentSubmissionProvider assignment_uuid={"assignment_" + assignment_uuid}>
                                            <EvaluateAssignment user_id={user_id} />
                                        </AssignmentSubmissionProvider>
                                    </AssignmentsTaskProvider>
                                </AssignmentProvider>
                            }
                            dialogTitle={`Evaluate @${user?.username}`}
                            dialogDescription="Evaluate the submission"
                            dialogTrigger={
                                <div className='bg-slate-800 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded text-xs cursor-pointer'>
                                    Evaluate
                                </div>
                            }
                        />
                    </div>
                </div>
            </div>
        </div>
    );
}

export default AssignmentSubmissionsSubPage;



================================================
FILE: apps/web/app/orgs/[orgslug]/dash/assignments/[assignmentuuid]/subpages/Modals/EvaluateAssignment.tsx
================================================
import { useAssignments } from '@components/Contexts/Assignments/AssignmentContext';
import { BookOpenCheck, Check, Download, Info, MoveRight, X } from 'lucide-react';
import Link from 'next/link';
import React from 'react'
import TaskQuizObject from '../../_components/TaskEditor/Subs/TaskTypes/TaskQuizObject';
import TaskFileObject from '../../_components/TaskEditor/Subs/TaskTypes/TaskFileObject';
import TaskFormObject from '../../_components/TaskEditor/Subs/TaskTypes/TaskFormObject';
import { useOrg } from '@components/Contexts/OrgContext';
import { getTaskRefFileDir } from '@services/media/media';
import { deleteUserSubmission, markActivityAsDoneForUser, putFinalGrade } from '@services/courses/assignments';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import toast from 'react-hot-toast';

function EvaluateAssignment({ user_id }: any) {
    const assignments = useAssignments() as any;
    const session = useLHSession() as any;
    const org = useOrg() as any;

    async function gradeAssignment() {
        const res = await putFinalGrade(user_id, assignments?.assignment_object.assignment_uuid, session.data?.tokens?.access_token);
        if (res.success) {
            toast.success(res.data.message)
        }
        else {
            toast.error(res.data.message)
        }
    }

    async function markActivityAsDone() {
        const res = await markActivityAsDoneForUser(user_id, assignments?.assignment_object.assignment_uuid, session.data?.tokens?.access_token)
        if (res.success) {
            toast.success(res.data.message)
        }
        else {
            toast.error(res.data.message)
        }
    }

    async function rejectAssignment() {
        const res = await deleteUserSubmission(user_id, assignments?.assignment_object.assignment_uuid, session.data?.tokens?.access_token)
        toast.success('Assignment rejected successfully')
        window.location.reload()
    }

    return (
        <div className='flex-col space-y-4 px-3 py-3 overflow-y-auto min-h-fit'>
            {assignments && assignments?.assignment_tasks?.sort((a: any, b: any) => a.id - b.id).map((task: any, index: number) => {
                return (
                    <div className='flex flex-col space-y-2' key={task.assignment_task_uuid}>
                        <div className='flex justify-between py-2'>
                            <div className='flex space-x-2 font-semibold text-slate-800'>
                                <p>Task {index + 1} : </p>
                                <p className='text-slate-500'>{task.description}</p>
                            </div>
                            <div className='flex space-x-2'>
                                <div
                                    onClick={() => alert(task.hint)}
                                    className='px-3 py-1 flex items-center nice-shadow bg-amber-50/40 text-amber-900 rounded-full space-x-2 cursor-pointer'>
                                    <Info size={13} />
                                    <p className='text-xs font-semibold'>Hint</p>
                                </div>
                                <Link
                                    href={getTaskRefFileDir(
                                        org?.org_uuid,
                                        assignments?.course_object.course_uuid,
                                        assignments?.activity_object.activity_uuid,
                                        assignments?.assignment_object.assignment_uuid,
                                        task.assignment_task_uuid,
                                        task.reference_file
                                    )}
                                    target='_blank'
                                    download={true}
                                    className='px-3 py-1 flex items-center nice-shadow bg-cyan-50/40 text-cyan-900 rounded-full space-x-2 cursor-pointer'>
                                    <Download size={13} />
                                    <div className='flex items-center space-x-2'>
                                        {task.reference_file && (
                                            <span className='relative'>
                                                <span className='absolute right-0 top-0 block h-2 w-2 rounded-full ring-2 ring-white bg-green-400'></span>
                                            </span>
                                        )}
                                        <p className='text-xs font-semibold'>Reference Document</p>
                                    </div>
                                </Link>
                            </div>
                        </div>
                        <div className='min-h-full'>
                            {task.assignment_type === 'QUIZ' && <TaskQuizObject key={task.assignment_task_uuid} view='grading' user_id={user_id} assignmentTaskUUID={task.assignment_task_uuid} />}
                            {task.assignment_type === 'FILE_SUBMISSION' && <TaskFileObject key={task.assignment_task_uuid} view='custom-grading' user_id={user_id} assignmentTaskUUID={task.assignment_task_uuid} />}
                            {task.assignment_type === 'FORM' && <TaskFormObject key={task.assignment_task_uuid} view='grading' user_id={user_id} assignmentTaskUUID={task.assignment_task_uuid} />}
                        </div>
                    </div>
                )
            })}
            <div className='flex  space-x-4 font-semibold items-center justify-between'>
                <button onClick={rejectAssignment} className='flex space-x-2 px-4 py-2 text-sm bg-rose-600/80 text-white rounded-lg nice-shadow items-center cursor-pointer'>
                    <X size={18} />
                    <span>Reject Assignment</span>
                </button>
                <div className='flex space-x-3 items-center'>
                    <button onClick={gradeAssignment} className='flex space-x-2 px-4 py-2 text-sm bg-violet-600/80 text-white rounded-lg nice-shadow items-center cursor-pointer'>
                        <BookOpenCheck size={18} />
                        <span>Set final grade</span>
                    </button>
                    <MoveRight className='text-gray-400' size={18} />
                    <button onClick={markActivityAsDone} className='flex space-x-2 px-4 py-2 text-sm bg-teal-600/80 text-white rounded-lg nice-shadow items-center cursor-pointer'>
                        <Check size={18} />
                        <span>Mark Activity as Done for User</span>
                    </button>
                </div>
            </div>
        </div>
    )
}

export default EvaluateAssignment


================================================
FILE: apps/web/app/orgs/[orgslug]/dash/courses/client.tsx
================================================
'use client'
import BreadCrumbs from '@components/Dashboard/Misc/BreadCrumbs'
import CreateCourseModal from '@components/Objects/Modals/Course/Create/CreateCourse'
import CourseThumbnail, { removeCoursePrefix } from '@components/Objects/Thumbnails/CourseThumbnail'
import AuthenticatedClientElement from '@components/Security/AuthenticatedClientElement'
import NewCourseButton from '@components/Objects/StyledElements/Buttons/NewCourseButton'
import Modal from '@components/Objects/StyledElements/Modal/Modal'
import { useSearchParams } from 'next/navigation'
import React from 'react'
import useAdminStatus from '@components/Hooks/useAdminStatus'
import { getUriWithOrg } from '@services/config/config'
import { useOrg } from '@components/Contexts/OrgContext'
import { BookOpen } from 'lucide-react'
import Link from 'next/link'

type CourseProps = {
  orgslug: string
  courses: any
  org_id: string
}

function CoursesHome(params: CourseProps) {
  const searchParams = useSearchParams()
  const isCreatingCourse = searchParams.get('new') ? true : false
  const [newCourseModal, setNewCourseModal] = React.useState(isCreatingCourse)
  const orgslug = params.orgslug
  const courses = params.courses
  const isUserAdmin = useAdminStatus() as any
  const org = useOrg() as any

  async function closeNewCourseModal() {
    setNewCourseModal(false)
  }

  return (
    <div className="h-full w-full bg-[#f8f8f8] pl-10 pr-10">
      <div className="mb-6">
        <BreadCrumbs type="courses" />
        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mt-4">
          <div className="flex items-center space-x-4">
            <h1 className="text-3xl font-bold mb-4 sm:mb-0">Courses</h1>
            <Link
              href={getUriWithOrg(org?.slug, '/dash/documentation/rights')}
              className="rounded-lg bg-black hover:scale-105 transition-all duration-100 ease-linear antialiased p-2 px-5 font text-xs font-bold text-white drop-shadow-lg flex space-x-2 items-center"
            >
              <BookOpen className="w-4 h-4" />
              <span>Rights Guide</span>
            </Link>
          </div>
          <AuthenticatedClientElement
            checkMethod="roles"
            action="create"
            ressourceType="courses"
            orgId={params.org_id}
          >
            <Modal
              isDialogOpen={newCourseModal}
              onOpenChange={setNewCourseModal}
              minHeight="md"
              dialogContent={
                <CreateCourseModal
                  closeModal={closeNewCourseModal}
                  orgslug={orgslug}
                />
              }
              dialogTitle="Create Course"
              dialogDescription="Create a new course"
              dialogTrigger={
                <button>
                  <NewCourseButton />
                </button>
              }
            />
          </AuthenticatedClientElement>
        </div>
      </div>
      
      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        {courses.map((course: any) => (
          <div key={course.course_uuid}>
            <CourseThumbnail customLink={`/dash/courses/course/${removeCoursePrefix(course.course_uuid)}/general`} course={course} orgslug={orgslug} />
          </div>
        ))}
        {courses.length === 0 && (
          <div className="col-span-full flex justify-center items-center py-8">
            <div className="text-center">
              <div className="mb-4">
                <svg
                  width="120"
                  height="120"
                  viewBox="0 0 295 295"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  className="mx-auto"
                >
                  {/* ... SVG content ... */}
                </svg>
              </div>
              <h2 className="text-2xl font-bold text-gray-600 mb-2">
                No courses yet
              </h2>
              <p className="text-lg text-gray-400">
                {isUserAdmin ? (
                  "Create a course to add content"
                ) : (
                  "No courses available yet"
                )}
              </p>
              {isUserAdmin && (
                <div className="mt-6">
                  <AuthenticatedClientElement
                    action="create"
                    ressourceType="courses"
                    checkMethod="roles"
                    orgId={params.org_id}
                  >
                    <Modal
                      isDialogOpen={newCourseModal}
                      onOpenChange={setNewCourseModal}
                      minHeight="md"
                      dialogContent={
                        <CreateCourseModal
                          closeModal={closeNewCourseModal}
                          orgslug={orgslug}
                        />
                      }
                      dialogTitle="Create Course"
                      dialogDescription="Create a new course"
                      dialogTrigger={
                        <button>
                          <NewCourseButton />
                        </button>
                      }
                    />
                  </AuthenticatedClientElement>
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  )
}

export default CoursesHome



================================================
FILE: apps/web/app/orgs/[orgslug]/dash/courses/page.tsx
================================================
import { getOrganizationContextInfo } from '@services/organizations/orgs'
import { Metadata } from 'next'
import React from 'react'
import CoursesHome from './client'
import { nextAuthOptions } from 'app/auth/options'
import { getServerSession } from 'next-auth'
import { getOrgCourses } from '@services/courses/courses'

type MetadataProps = {
  params: Promise<{ orgslug: string }>
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>
}

export async function generateMetadata(props: MetadataProps): Promise<Metadata> {
  const params = await props.params;
  // Get Org context information
  const org = await getOrganizationContextInfo(params.orgslug, {
    revalidate: 1800,
    tags: ['organizations'],
  })

  // SEO
  return {
    title: 'Courses â€” ' + org.name,
    description: org.description,
    keywords: `${org.name}, ${org.description}, courses, learning, education, online learning, edu, online courses, ${org.name} courses`,
    robots: {
      index: true,
      follow: true,
      nocache: true,
      googleBot: {
        index: true,
        follow: true,
        'max-image-preview': 'large',
      },
    },
    openGraph: {
      title: 'Courses â€” ' + org.name,
      description: org.description,
      type: 'website',
    },
  }
}

async function CoursesPage(params: any) {
  const orgslug = (await params.params).orgslug
  const org = await getOrganizationContextInfo(orgslug, {
    revalidate: 1800,
    tags: ['organizations'],
  })
  const session = await getServerSession(nextAuthOptions)
  const access_token = session?.tokens?.access_token
  const courses = await getOrgCourses(
    orgslug,
    { revalidate: 0, tags: ['courses'] },
    access_token ? access_token : null
  )

  return <CoursesHome org_id={org.org_id} orgslug={orgslug} courses={courses} />
}

export default CoursesPage



================================================
FILE: apps/web/app/orgs/[orgslug]/dash/courses/course/[courseuuid]/[subpage]/page.tsx
================================================
'use client'
import React, { use, useEffect } from 'react';
import { CourseProvider } from '../../../../../../../../components/Contexts/CourseContext'
import Link from 'next/link'
import { CourseOverviewTop } from '@components/Dashboard/Misc/CourseOverviewTop'
import { motion } from 'framer-motion'
import { GalleryVerticalEnd, Globe, Info, UserPen, Award, Lock } from 'lucide-react'
import EditCourseStructure from '@components/Dashboard/Pages/Course/EditCourseStructure/EditCourseStructure'
import EditCourseGeneral from '@components/Dashboard/Pages/Course/EditCourseGeneral/EditCourseGeneral'
import EditCourseAccess from '@components/Dashboard/Pages/Course/EditCourseAccess/EditCourseAccess'
import EditCourseContributors from '@components/Dashboard/Pages/Course/EditCourseContributors/EditCourseContributors'
import EditCourseCertification from '@components/Dashboard/Pages/Course/EditCourseCertification/EditCourseCertification'
import { useCourseRights } from '@hooks/useCourseRights'
import { useRouter } from 'next/navigation'
import ToolTip from '@components/Objects/StyledElements/Tooltip/Tooltip'
import { getUriWithOrg } from '@services/config/config';

export type CourseOverviewParams = {
  orgslug: string
  courseuuid: string
  subpage: string
}

function CourseOverviewPage(props: { params: Promise<CourseOverviewParams> }) {
  const params = use(props.params);
  const router = useRouter();
  
  function getEntireCourseUUID(courseuuid: string) {
    // add course_ to uuid
    return `course_${courseuuid}`
  }

  const courseuuid = getEntireCourseUUID(params.courseuuid)
  const { hasPermission, isLoading: rightsLoading } = useCourseRights(courseuuid)

  // Define tab configurations with their required permissions
  const tabs = [
    {
      key: 'general',
      label: 'General',
      icon: Info,
      href: `/dash/courses/course/${params.courseuuid}/general`,
      requiredPermission: 'update' as const
    },
    {
      key: 'content',
      label: 'Content',
      icon: GalleryVerticalEnd,
      href: `/dash/courses/course/${params.courseuuid}/content`,
      requiredPermission: 'update_content' as const
    },
    {
      key: 'access',
      label: 'Access',
      icon: Globe,
      href: `/dash/courses/course/${params.courseuuid}/access`,
      requiredPermission: 'manage_access' as const
    },
    {
      key: 'contributors',
      label: 'Contributors',
      icon: UserPen,
      href: `/dash/courses/course/${params.courseuuid}/contributors`,
      requiredPermission: 'manage_contributors' as const
    },
    {
      key: 'certification',
      label: 'Certification',
      icon: Award,
      href: `/dash/courses/course/${params.courseuuid}/certification`,
      requiredPermission: 'create_certifications' as const
    }
  ]

  // Filter tabs based on permissions
  const visibleTabs = tabs.filter(tab => hasPermission(tab.requiredPermission))

  // Check if current subpage is accessible
  const currentTab = tabs.find(tab => tab.key === params.subpage)
  const hasAccessToCurrentPage = currentTab ? hasPermission(currentTab.requiredPermission) : false

  // Redirect to first available tab if current page is not accessible
  useEffect(() => {
    if (!rightsLoading && !hasAccessToCurrentPage && visibleTabs.length > 0) {
      const firstAvailableTab = visibleTabs[0]
      router.replace(getUriWithOrg(params.orgslug, '') + firstAvailableTab.href)
    }
  }, [rightsLoading, hasAccessToCurrentPage, visibleTabs, router, params.orgslug])

  // Show loading state while rights are being fetched
  if (rightsLoading) {
    return (
      <div className="h-screen w-full bg-[#f8f8f8] flex items-center justify-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
      </div>
    )
  }

  // Show access denied if no tabs are available
  if (!rightsLoading && visibleTabs.length === 0) {
    return (
      <div className="h-screen w-full bg-[#f8f8f8] flex items-center justify-center">
        <div className="text-center">
          <Lock className="mx-auto h-12 w-12 text-gray-400 mb-4" />
          <h3 className="text-lg font-medium text-gray-900 mb-2">Access Denied</h3>
          <p className="text-gray-500">You don't have permission to access this course.</p>
        </div>
      </div>
    )
  }

  return (
    <div className="h-screen w-full bg-[#f8f8f8] grid grid-rows-[auto_1fr]">
      <CourseProvider courseuuid={courseuuid} withUnpublishedActivities={true}>
        <div className="pl-10 pr-10 text-sm tracking-tight bg-[#fcfbfc] z-10 nice-shadow">
          <CourseOverviewTop params={params} />
          <div className="flex space-x-3 font-black text-sm">
            {tabs.map((tab) => {
              const IconComponent = tab.icon
              const isActive = params.subpage.toString() === tab.key
              const hasAccess = hasPermission(tab.requiredPermission)
              
              if (!hasAccess) {
                // Show disabled tab with subtle visual cues and tooltip
                return (
                  <ToolTip
                    key={tab.key}
                    content={
                      <div className="text-center">
                        <div className="font-medium text-gray-900">Access Restricted</div>
                        <div className="text-sm text-gray-600">
                          You don't have permission to access {tab.label}
                        </div>
                      </div>
                    }
                  >
                    <div className="flex space-x-4 py-2 w-fit text-center border-black transition-all ease-linear opacity-30 cursor-not-allowed">
                      <div className="flex items-center space-x-2.5 mx-2">
                        <IconComponent size={16} />
                        <div>{tab.label}</div>
                      </div>
                    </div>
                  </ToolTip>
                )
              }
              
              return (
                <Link
                  key={tab.key}
                  href={getUriWithOrg(params.orgslug, '') + tab.href}
                >
                  <div
                    className={`flex space-x-4 py-2 w-fit text-center border-black transition-all ease-linear ${
                      isActive ? 'border-b-4' : 'opacity-50 hover:opacity-75'
                    } cursor-pointer`}
                  >
                    <div className="flex items-center space-x-2.5 mx-2">
                      <IconComponent size={16} />
                      <div>{tab.label}</div>
                    </div>
                  </div>
                </Link>
              )
            })}
          </div>
        </div>
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          transition={{ duration: 0.1, type: 'spring', stiffness: 80 }}
          className="h-full overflow-y-auto relative"
        >
          <div className="absolute inset-0">
            {params.subpage == 'content' && hasPermission('update_content') ? (
              <EditCourseStructure orgslug={params.orgslug} />
            ) : null}
            {params.subpage == 'general' && hasPermission('update') ? (
              <EditCourseGeneral orgslug={params.orgslug} />
            ) : null}
            {params.subpage == 'access' && hasPermission('manage_access') ? (
              <EditCourseAccess orgslug={params.orgslug} />
            ) : null}
            {params.subpage == 'contributors' && hasPermission('manage_contributors') ? (
              <EditCourseContributors orgslug={params.orgslug} />
            ) : null}
            {params.subpage == 'certification' && hasPermission('create_certifications') ? (
              <EditCourseCertification orgslug={params.orgslug} />
            ) : null}
          </div>
        </motion.div>
      </CourseProvider>
    </div>
  )
}

export default CourseOverviewPage



================================================
FILE: apps/web/app/orgs/[orgslug]/dash/documentation/layout.tsx
================================================
import React from 'react'

export default function DocumentationLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return <>{children}</>
} 


================================================
FILE: apps/web/app/orgs/[orgslug]/dash/documentation/rights/page.tsx
================================================
'use client'
import React from 'react'
import { getUriWithOrg } from '@services/config/config'
import { useOrg } from '@components/Contexts/OrgContext'
import { 
  Shield, 
  Users, 
  Crown,
  User,
  UserCog,
  GraduationCap,
  CheckCircle,
  ArrowLeft
} from 'lucide-react'
import Link from 'next/link'
import { motion } from 'framer-motion'

interface RightsDocumentationProps {
  params: Promise<{ orgslug: string }>
}

const RightsDocumentation = ({ params }: RightsDocumentationProps) => {
  const org = useOrg() as any

  const roleHierarchy = [
    {
      name: 'Admin',
      icon: <Crown className="w-6 h-6 text-purple-600" />,
      color: 'bg-purple-50 border-purple-200',
      description: 'Full platform control with all permissions',
      permissions: ['All permissions', 'Manage organization', 'Manage users', 'Manage courses', 'Manage roles'],
      level: 4
    },
    {
      name: 'Maintainer',
      icon: <Shield className="w-6 h-6 text-blue-600" />,
      color: 'bg-blue-50 border-blue-200',
      description: 'Mid-level manager with wide permissions',
      permissions: ['Manage courses', 'Manage users', 'Manage assignments', ],
      level: 3
    },
    {
      name: 'Instructor',
      icon: <GraduationCap className="w-6 h-6 text-green-600" />,
      color: 'bg-green-50 border-green-200',
      description: 'Can create courses but need ownership for content creation',
      permissions: ['Create courses', 'Manage own courses', 'Create assignments', 'Grade assignments'],
      level: 2
    },
    {
      name: 'User',
      icon: <User className="w-6 h-6 text-gray-600" />,
      color: 'bg-gray-50 border-gray-200',
      description: 'Read-Only Learner',
      permissions: ['View courses', 'Submit assignments', 'Take assessments'],
      level: 1
    }
  ]

  const courseOwnershipTypes = [
    {
      name: 'Creator',
      icon: <Crown className="w-5 h-5 text-yellow-600" />,
      color: 'bg-yellow-50 border-yellow-200',
      description: 'Original course creator with full control',
      permissions: ['Full course control', 'Manage contributors', 'Change access settings', 'Delete course']
    },
    {
      name: 'Maintainer',
      icon: <Shield className="w-5 h-5 text-blue-600" />,
      color: 'bg-blue-50 border-blue-200',
      description: 'Course maintainer with extensive permissions',
      permissions: ['Manage course content', 'Manage contributors', 'Change access settings', 'Cannot delete course']
    },
    {
      name: 'Contributor',
      icon: <UserCog className="w-5 h-5 text-green-600" />,
      color: 'bg-green-50 border-green-200',
      description: 'Course contributor with limited permissions',
      permissions: ['Edit course content', 'Create activities', 'Cannot manage contributors', 'Cannot change access']
    }
  ]

  return (
    <div className="min-h-screen bg-[#f8f8f8] flex items-center justify-center p-6 pt-16 w-full">
      <div className="w-full max-w-none mx-auto px-4 sm:px-6 lg:px-8">
        {/* Top Icon */}
        <motion.div 
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          className="text-center mb-8"
        >
          <div className="inline-flex items-center justify-center w-16 h-16 bg-white rounded-full shadow-sm border border-gray-200 mb-6">
            <Shield className="w-8 h-8 text-blue-500" />
          </div>
        </motion.div>

        {/* Header */}
        <motion.div 
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.1 }}
          className="text-center mb-12"
        >
          <Link 
            href={getUriWithOrg(org?.slug, '/dash')}
            className="inline-flex items-center space-x-2 text-gray-600 hover:text-gray-900 mb-6 transition-colors"
          >
            <ArrowLeft className="w-4 h-4" />
            <span className="font-medium">Back to Dashboard</span>
          </Link>
          <div className="flex items-center justify-center space-x-3 mb-4">
            <h1 className="text-4xl font-bold text-gray-900">Authorizations & Rights Guide</h1>
          </div>
          <p className="text-gray-600 text-lg max-w-2xl mx-auto">
            Understanding LearnHouse permissions, roles, and access controls based on RBAC system
          </p>
        </motion.div>

        {/* Role Hierarchy Section */}
        <motion.section 
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.2 }}
          className="mb-16"
        >
          <h2 className="text-2xl font-bold text-gray-900 mb-8 text-center flex items-center justify-center space-x-2">
            <Crown className="w-6 h-6 text-purple-600" />
            <span>Role Hierarchy</span>
          </h2>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 max-w-7xl mx-auto">
            {roleHierarchy.map((role, index) => (
              <motion.div
                key={role.name}
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: 0.3 + index * 0.1 }}
                className={`bg-white rounded-xl border ${role.color} shadow-sm hover:shadow-lg transition-all duration-200 p-6 text-center`}
              >
                <div className="flex items-center justify-center space-x-3 mb-4">
                  {role.icon}
                  <h3 className="text-lg font-semibold text-gray-900">{role.name}</h3>
                </div>
                <p className="text-gray-600 text-sm mb-4">{role.description}</p>
                <ul className="space-y-2 text-left">
                  {role.permissions.map((permission, permIndex) => (
                    <li key={permIndex} className="flex items-center space-x-2 text-sm text-gray-700">
                      <CheckCircle className="w-3 h-3 text-green-600 flex-shrink-0" />
                      <span>{permission}</span>
                    </li>
                  ))}
                </ul>
              </motion.div>
            ))}
          </div>
        </motion.section>

        {/* Course Ownership Types */}
        <motion.section 
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.4 }}
          className="mb-16"
        >
          <h2 className="text-2xl font-bold text-gray-900 mb-8 text-center flex items-center justify-center space-x-2">
            <Users className="w-6 h-6 text-blue-600" />
            <span>Course Ownership Types</span>
          </h2>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-6xl mx-auto">
            {courseOwnershipTypes.map((type, index) => (
              <motion.div
                key={type.name}
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: 0.5 + index * 0.1 }}
                className={`bg-white rounded-xl border ${type.color} shadow-sm hover:shadow-lg transition-all duration-200 p-6 text-center`}
              >
                <div className="flex items-center justify-center space-x-3 mb-4">
                  {type.icon}
                  <h3 className="text-lg font-semibold text-gray-900">{type.name}</h3>
                </div>
                <p className="text-gray-600 text-sm mb-4">{type.description}</p>
                <ul className="space-y-2 text-left">
                  {type.permissions.map((permission, permIndex) => (
                    <li key={permIndex} className="flex items-center space-x-2 text-sm text-gray-700">
                      <CheckCircle className="w-3 h-3 text-green-600 flex-shrink-0" />
                      <span>{permission}</span>
                    </li>
                  ))}
                </ul>
              </motion.div>
            ))}
          </div>
        </motion.section>
      </div>
    </div>
  )
}

export default RightsDocumentation 


================================================
FILE: apps/web/app/orgs/[orgslug]/dash/org/settings/[subpage]/page.tsx
================================================
'use client'
import BreadCrumbs from '@components/Dashboard/Misc/BreadCrumbs'
import { getUriWithOrg } from '@services/config/config'
import { ImageIcon, TextIcon, LucideIcon, Share2Icon, LayoutDashboardIcon, CodeIcon } from 'lucide-react'
import Link from 'next/link'
import React, { useEffect, use } from 'react';
import { motion } from 'framer-motion'
import OrgEditGeneral from '@components/Dashboard/Pages/Org/OrgEditGeneral/OrgEditGeneral'
import OrgEditImages from '@components/Dashboard/Pages/Org/OrgEditImages/OrgEditImages'
import OrgEditSocials from '@components/Dashboard/Pages/Org/OrgEditSocials/OrgEditSocials'
import OrgEditLanding from '@components/Dashboard/Pages/Org/OrgEditLanding/OrgEditLanding'
import OrgEditOther from '@components/Dashboard/Pages/Org/OrgEditOther/OrgEditOther'

export type OrgParams = {
  subpage: string
  orgslug: string
}

interface TabItem {
  id: string
  label: string
  icon: LucideIcon
}

const SETTING_TABS: TabItem[] = [
  { id: 'general', label: 'General', icon: TextIcon },
  { id: 'landing', label: 'Landing Page', icon: LayoutDashboardIcon },
  { id: 'previews', label: 'Images & Previews', icon: ImageIcon },
  { id: 'socials', label: 'Socials', icon: Share2Icon },
  { id: 'other', label: 'Other', icon: CodeIcon },
]

function TabLink({ tab, isActive, orgslug }: { 
  tab: TabItem, 
  isActive: boolean, 
  orgslug: string 
}) {
  return (
    <Link href={getUriWithOrg(orgslug, '') + `/dash/org/settings/${tab.id}`}>
      <div
        className={`py-2 w-fit text-center border-black transition-all ease-linear ${
          isActive ? 'border-b-4' : 'opacity-50'
        } cursor-pointer`}
      >
        <div className="flex items-center space-x-2.5 mx-2.5">
          <tab.icon size={16} />
          <div>{tab.label}</div>
        </div>
      </div>
    </Link>
  )
}

function OrgPage(props: { params: Promise<OrgParams> }) {
  const params = use(props.params);
  const [H1Label, setH1Label] = React.useState('')
  const [H2Label, setH2Label] = React.useState('')

  function handleLabels() {
    if (params.subpage == 'general') {
      setH1Label('General')
      setH2Label('Manage your organization settings')
    } else if (params.subpage == 'previews') {
      setH1Label('Previews')
      setH2Label('Manage your organization previews')
    } else if (params.subpage == 'socials') {
      setH1Label('Socials')
      setH2Label('Manage your organization social media links')
    } else if (params.subpage == 'landing') {
      setH1Label('Landing Page')
      setH2Label('Customize your organization landing page')
    } else if (params.subpage == 'other') {
      setH1Label('Other')
      setH2Label('Manage additional organization settings')
    }
  }

  useEffect(() => {
    handleLabels()
  }, [params.subpage, params])

  return (
    <div className="h-full w-full bg-[#f8f8f8] flex flex-col">
      <div className="pl-10 pr-10 tracking-tight bg-[#fcfbfc] nice-shadow flex-shrink-0">
        <BreadCrumbs type="org"></BreadCrumbs>
        <div className="my-2  py-2">
          <div className="w-100 flex flex-col space-y-1">
            <div className="pt-3 flex font-bold text-4xl tracking-tighter">
              {H1Label}
            </div>
            <div className="flex font-medium text-gray-400 text-md">
              {H2Label}{' '}
            </div>
          </div>
        </div>
        <div className="flex space-x-0.5 font-black text-sm">
          {SETTING_TABS.map((tab) => (
            <TabLink
              key={tab.id}
              tab={tab}
              isActive={params.subpage === tab.id}
              orgslug={params.orgslug}
            />
          ))}
        </div>
      </div>
      <div className="h-6 flex-shrink-0"></div>
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
        transition={{ duration: 0.1, type: 'spring', stiffness: 80 }}
        className="flex-1 overflow-y-auto"
      >
        {params.subpage == 'general' ? <OrgEditGeneral /> : ''}
        {params.subpage == 'previews' ? <OrgEditImages /> : ''}
        {params.subpage == 'socials' ? <OrgEditSocials /> : ''}
        {params.subpage == 'landing' ? <OrgEditLanding /> : ''}
        {params.subpage == 'other' ? <OrgEditOther /> : ''}
      </motion.div>
    </div>
  )
}

export default OrgPage



================================================
FILE: apps/web/app/orgs/[orgslug]/dash/payments/[subpage]/page.tsx
================================================
'use client'
import React, { use } from 'react';
import { motion } from 'framer-motion'
import BreadCrumbs from '@components/Dashboard/Misc/BreadCrumbs'
import Link from 'next/link'
import { getUriWithOrg } from '@services/config/config'
import { Settings, Users, Gem } from 'lucide-react'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { useOrg } from '@components/Contexts/OrgContext'
import PaymentsConfigurationPage from '@components/Dashboard/Pages/Payments/PaymentsConfigurationPage'
import PaymentsProductPage from '@components/Dashboard/Pages/Payments/PaymentsProductPage'
import PaymentsCustomersPage from '@components/Dashboard/Pages/Payments/PaymentsCustomersPage'
import useFeatureFlag from '@components/Hooks/useFeatureFlag'

export type PaymentsParams = {
  subpage: string
  orgslug: string
}

function PaymentsPage(props: { params: Promise<PaymentsParams> }) {
  const params = use(props.params);
  const session = useLHSession() as any
  const org = useOrg() as any
  const subpage = params.subpage || 'customers'

  const isPaymentsEnabled = useFeatureFlag({
    path: ['features', 'payments', 'enabled'],
    defaultValue: false
  })

  const getPageTitle = () => {
    switch (subpage) {
      case 'customers':
        return {
          h1: 'Customers',
          h2: 'View and manage your customer information'
        }
      case 'paid-products':
        return {
          h1: 'Paid Products',
          h2: 'Manage your paid products and pricing'
        }
      case 'configuration':
        return {
          h1: 'Payment Configuration',
          h2: 'Set up and manage your payment gateway'
        }
      default:
        return {
          h1: 'Payments',
          h2: 'Overview of your payment settings and transactions'
        }
    }
  }

  if (!isPaymentsEnabled) {
    return (
      <div className="h-screen w-full bg-[#f8f8f8] flex items-center justify-center p-4">
        <div className="bg-white p-6 rounded-lg shadow-md text-center max-w-md">
          <h2 className="text-xl font-bold mb-4">Payments Not Available</h2>
          <p className="text-gray-600">The payments feature is not enabled for this organization.</p>
          <p className="text-gray-600 mt-2">Please contact your administrator to enable payments.</p>
        </div>
      </div>
    )
  }

  const { h1, h2 } = getPageTitle()

  return (
    <div className="h-screen w-full bg-[#f8f8f8] flex flex-col">
      <div className="pl-10 pr-10 tracking-tight bg-[#fcfbfc] z-10 nice-shadow flex-shrink-0">
        <BreadCrumbs type="payments" />
        <div className="my-2 py-2">
          <div className="w-100 flex flex-col space-y-1">
            <div className="pt-3 flex font-bold text-4xl tracking-tighter">
              {h1}
            </div>
            <div className="flex font-medium text-gray-400 text-md">
              {h2}
            </div>
          </div>
        </div>
        <div className="flex space-x-0.5 font-black text-sm">
          <TabLink
            href={getUriWithOrg(params.orgslug, '/dash/payments/customers')}
            icon={<Users size={16} />}
            label="Customers"
            isActive={subpage === 'customers'}
          />
          <TabLink
            href={getUriWithOrg(params.orgslug, '/dash/payments/paid-products')}
            icon={<Gem size={16} />}
            label="Products & Subscriptions"
            isActive={subpage === 'paid-products'}
          />
          <TabLink
            href={getUriWithOrg(params.orgslug, '/dash/payments/configuration')}
            icon={<Settings size={16} />}
            label="Configuration"
            isActive={subpage === 'configuration'}
          />
        </div>
      </div>
      <div className="h-6 flex-shrink-0"></div>
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
        transition={{ duration: 0.1, type: 'spring', stiffness: 80 }}
        className="flex-1 overflow-y-auto"
      >
        {subpage === 'configuration' && <PaymentsConfigurationPage />}
        {subpage === 'paid-products' && <PaymentsProductPage />}
        {subpage === 'customers' && <PaymentsCustomersPage />}
      </motion.div>
    </div>
  )
}

const TabLink = ({ href, icon, label, isActive }: { href: string, icon: React.ReactNode, label: string, isActive: boolean }) => (
  <Link href={href}>
    <div
      className={`py-2 w-fit text-center border-black transition-all ease-linear ${isActive ? 'border-b-4' : 'opacity-50'} cursor-pointer`}
    >
      <div className="flex items-center space-x-2.5 mx-2">
        {icon}
        <div>{label}</div>
      </div>
    </div>
  </Link>
)

export default PaymentsPage



================================================
FILE: apps/web/app/orgs/[orgslug]/dash/user-account/owned/page.tsx
================================================
'use client'

import React from 'react'
import { useOrg } from '@components/Contexts/OrgContext'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import useSWR from 'swr'
import { getOwnedCourses } from '@services/payments/payments'
import CourseThumbnail from '@components/Objects/Thumbnails/CourseThumbnail'
import PageLoading from '@components/Objects/Loaders/PageLoading'
import { BookOpen, Package2 } from 'lucide-react'

function OwnedCoursesPage() {
  const org = useOrg() as any
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token

  const { data: ownedCourses, error, isLoading } = useSWR(
    org ? [`/payments/${org.id}/courses/owned`, access_token] : null,
    ([url, token]) => getOwnedCourses(org.id, token)
  )

  if (isLoading) return <PageLoading />
  if (error) return <div>Error loading owned courses</div>

  return (
    <div className="h-full w-full bg-[#f8f8f8] pl-10 pr-10 pt-5 ">
      <div className="flex flex-col bg-white nice-shadow px-5 py-3 rounded-md mb-6">
        <div className="flex items-center gap-4">
          <Package2 className="w-8 h-8 text-gray-800" />
          <div className="flex flex-col -space-y-1">
            <h1 className="font-bold text-xl text-gray-800">My Courses</h1>
            <h2 className="text-gray-500 text-md">Courses you have purchased or subscribed to</h2>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 w-full">
        {ownedCourses?.map((course: any) => (
          <div key={course.course_uuid} className="p-3">
            <CourseThumbnail course={course} orgslug={org.slug} />
          </div>
        ))}

        {(!ownedCourses || ownedCourses.length === 0) && (
          <div className="col-span-full flex justify-center items-center py-8">
            <div className="text-center">
              <div className="mb-4">
                <BookOpen className="w-12 h-12 mx-auto text-gray-400" />
              </div>
              <h2 className="text-xl font-bold text-gray-600 mb-2">
                No purchased courses
              </h2>
              <p className="text-md text-gray-400">
                You haven't purchased any courses yet
              </p>
            </div>
          </div>
        )}
      </div>
    </div>
  )
}

export default OwnedCoursesPage



================================================
FILE: apps/web/app/orgs/[orgslug]/dash/user-account/settings/[subpage]/page.tsx
================================================
'use client'
import React, { useEffect, use } from 'react';
import { motion } from 'framer-motion'
import UserEditGeneral from '@components/Dashboard/Pages/UserAccount/UserEditGeneral/UserEditGeneral'
import UserEditPassword from '@components/Dashboard/Pages/UserAccount/UserEditPassword/UserEditPassword'
import Link from 'next/link'
import { getUriWithOrg } from '@services/config/config'
import { Info, Lock, LucideIcon, User } from 'lucide-react'
import BreadCrumbs from '@components/Dashboard/Misc/BreadCrumbs'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import UserProfile from '@components/Dashboard/Pages/UserAccount/UserProfile/UserProfile';

interface User {
  username: string;
  // Add other user properties as needed
}

interface Session {
  user?: User;
  // Add other session properties as needed
}

export type SettingsParams = {
  subpage: string
  orgslug: string
}

type NavigationItem = {
  id: string
  label: string
  icon: LucideIcon
  component: React.ComponentType
}

const navigationItems: NavigationItem[] = [
  {
    id: 'general',
    label: 'General',
    icon: Info,
    component: UserEditGeneral
  },
  {
    id: 'profile',
    label: 'Profile',
    icon: User,
    component: UserProfile
  },
  {
    id: 'security',
    label: 'Password',
    icon: Lock,
    component: UserEditPassword
  },
]

const SettingsNavigation = ({ 
  items, 
  currentPage, 
  orgslug 
}: { 
  items: NavigationItem[]
  currentPage: string
  orgslug: string 
}) => (
  <div className="flex space-x-5 font-black text-sm">
    {items.map((item) => (
      <Link
        key={item.id}
        href={getUriWithOrg(orgslug, `/dash/user-account/settings/${item.id}`)}
      >
        <div
          className={`py-2 w-fit text-center border-black transition-all ease-linear ${
            currentPage === item.id ? 'border-b-4' : 'opacity-50'
          } cursor-pointer`}
        >
          <div className="flex items-center space-x-2.5 mx-2">
            <item.icon size={16} />
            <div>{item.label}</div>
          </div>
        </div>
      </Link>
    ))}
  </div>
)

function SettingsPage({ params }: { params: Promise<SettingsParams> }) {
  const { subpage, orgslug } = use(params);
  const session = useLHSession() as Session;

  useEffect(() => {}, [session])

  const CurrentComponent = navigationItems.find(item => item.id === subpage)?.component;

  return (
    <div className="h-full w-full bg-[#f8f8f8] flex flex-col">
      <div className="pl-10 pr-10 tracking-tight bg-[#fcfbfc] z-10 nice-shadow flex-shrink-0">
        <BreadCrumbs
          type="user"
          last_breadcrumb={session?.user?.username}
        />
        <div className="my-2 tracking-tighter">
          <div className="w-100 flex justify-between">
            <div className="pt-3 flex font-bold text-4xl">Account Settings</div>
          </div>
        </div>
        <SettingsNavigation 
          items={navigationItems}
          currentPage={subpage}
          orgslug={orgslug}
        />
      </div>
      <div className="h-6 flex-shrink-0" />
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
        transition={{ duration: 0.1, type: 'spring', stiffness: 80 }}
        className="flex-1 overflow-y-auto"
      >
        {CurrentComponent && <CurrentComponent />}
      </motion.div>
    </div>
  )
}

export default SettingsPage



================================================
FILE: apps/web/app/orgs/[orgslug]/dash/users/settings/[subpage]/page.tsx
================================================
'use client'
import React, { useEffect, use } from 'react';
import { motion } from 'framer-motion'
import Link from 'next/link'
import { useMediaQuery } from 'usehooks-ts'
import { getUriWithOrg } from '@services/config/config'
import { Monitor, ScanEye, SquareUserRound, UserPlus, Users, Shield } from 'lucide-react'
import BreadCrumbs from '@components/Dashboard/Misc/BreadCrumbs'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { useOrg } from '@components/Contexts/OrgContext'
import OrgUsers from '@components/Dashboard/Pages/Users/OrgUsers/OrgUsers'
import OrgAccess from '@components/Dashboard/Pages/Users/OrgAccess/OrgAccess'
import OrgUsersAdd from '@components/Dashboard/Pages/Users/OrgUsersAdd/OrgUsersAdd'
import OrgUserGroups from '@components/Dashboard/Pages/Users/OrgUserGroups/OrgUserGroups'
import OrgRoles from '@components/Dashboard/Pages/Users/OrgRoles/OrgRoles'

export type SettingsParams = {
  subpage: string
  orgslug: string
}

function UsersSettingsPage(props: { params: Promise<SettingsParams> }) {
  const params = use(props.params);
  const session = useLHSession() as any
  const org = useOrg() as any
  const [H1Label, setH1Label] = React.useState('')
  const [H2Label, setH2Label] = React.useState('')
  const isMobile = useMediaQuery('(max-width: 767px)')

  function handleLabels() {
    if (params.subpage == 'users') {
      setH1Label('Users')
      setH2Label('Manage your organization users, assign roles and permissions')
    }
    if (params.subpage == 'signups') {
      setH1Label('Signups & Invite Codes')
      setH2Label('Choose from where users can join your organization')
    }
    if (params.subpage == 'add') {
      setH1Label('Invite Members')
      setH2Label('Invite members to join your organization')
    }
    if (params.subpage == 'usergroups') {
      setH1Label('UserGroups')
      setH2Label('Create and manage user groups')
    }
    if (params.subpage == 'roles') {
      setH1Label('Roles')
      setH2Label('Create and manage roles with specific permissions')
    }
  }

  useEffect(() => {
    handleLabels()
  }, [session, org, params.subpage, params])

  if (isMobile) {
    // TODO: Work on a better mobile experience
    return (
      <div className="h-screen w-full bg-[#f8f8f8] flex items-center justify-center p-4">
        <div className="bg-white p-6 rounded-lg shadow-md text-center">
          <h2 className="text-xl font-bold mb-4">Desktop Only</h2>
          <Monitor className='mx-auto my-5' size={60} />
          <p>This page is only accessible from a desktop device.</p>
          <p>Please switch to a desktop to view and manage user settings.</p>
        </div>
      </div>
    )
  }

  return (
    <div className="h-screen w-full bg-[#f8f8f8] grid grid-rows-[auto_1fr]">
      <div className="pl-10 pr-10  tracking-tight bg-[#fcfbfc] z-10 shadow-[0px_4px_16px_rgba(0,0,0,0.06)]">
        <BreadCrumbs type="orgusers"></BreadCrumbs>
        <div className="my-2  py-3">
          <div className="w-100 flex flex-col space-y-1">
            <div className="pt-3 flex font-bold text-4xl tracking-tighter">
              {H1Label}
            </div>
            <div className="flex font-medium text-gray-400 text-md">
              {H2Label}{' '}
            </div>
          </div>
        </div>
        <div className="flex space-x-5 font-black text-sm">
          <Link
            href={
              getUriWithOrg(params.orgslug, '') + `/dash/users/settings/users`
            }
          >
            <div
              className={`py-2 w-fit text-center border-black transition-all ease-linear ${params.subpage.toString() === 'users'
                  ? 'border-b-4'
                  : 'opacity-50'
                } cursor-pointer`}
            >
              <div className="flex items-center space-x-2.5 mx-2">
                <Users size={16} />
                <div>Users</div>
              </div>
            </div>
          </Link>
          <Link
            href={
              getUriWithOrg(params.orgslug, '') + `/dash/users/settings/usergroups`
            }
          >
            <div
              className={`py-2 w-fit text-center border-black transition-all ease-linear ${params.subpage.toString() === 'usergroups'
                  ? 'border-b-4'
                  : 'opacity-50'
                } cursor-pointer`}
            >
              <div className="flex items-center space-x-2.5 mx-2">
                <SquareUserRound size={16} />
                <div>UserGroups</div>
              </div>
            </div>
          </Link>
          <Link
            href={
              getUriWithOrg(params.orgslug, '') + `/dash/users/settings/roles`
            }
          >
            <div
              className={`py-2 w-fit text-center border-black transition-all ease-linear ${params.subpage.toString() === 'roles'
                  ? 'border-b-4'
                  : 'opacity-50'
                } cursor-pointer`}
            >
              <div className="flex items-center space-x-2.5 mx-2">
                <Shield size={16} />
                <div>Roles</div>
              </div>
            </div>
          </Link>
          <Link
            href={
              getUriWithOrg(params.orgslug, '') + `/dash/users/settings/signups`
            }
          >
            <div
              className={`py-2 w-fit text-center border-black transition-all ease-linear ${params.subpage.toString() === 'signups'
                  ? 'border-b-4'
                  : 'opacity-50'
                } cursor-pointer`}
            >
              <div className="flex items-center space-x-2.5 mx-2">
                <ScanEye size={16} />
                <div>Signups & Invite Codes</div>
              </div>
            </div>
          </Link>
          <Link
            href={
              getUriWithOrg(params.orgslug, '') + `/dash/users/settings/add`
            }
          >
            <div
              className={`py-2 w-fit text-center border-black transition-all ease-linear ${params.subpage.toString() === 'add'
                  ? 'border-b-4'
                  : 'opacity-50'
                } cursor-pointer`}
            >
              <div className="flex items-center space-x-2.5 mx-2">
                <UserPlus size={16} />
                <div>Invite Members</div>
              </div>
            </div>
          </Link>
          
        </div>
      </div>
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
        transition={{ duration: 0.1, type: 'spring', stiffness: 80 }}
        className="flex-1 overflow-y-auto"
      >
        {params.subpage == 'users' ? <OrgUsers /> : ''}
        {params.subpage == 'signups' ? <OrgAccess /> : ''}
        {params.subpage == 'add' ? <OrgUsersAdd /> : ''}
        {params.subpage == 'usergroups' ? <OrgUserGroups /> : ''}
        {params.subpage == 'roles' ? <OrgRoles /> : ''}
      </motion.div>
    </div>
  )
}

export default UsersSettingsPage



================================================
FILE: apps/web/app/payments/stripe/connect/oauth/page.tsx
================================================
'use client'
import React, { useEffect, useState } from 'react'
import { useRouter, useSearchParams } from 'next/navigation'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { Check, Loader2, AlertTriangle } from 'lucide-react'
import { motion } from 'framer-motion'
import toast from 'react-hot-toast'
import { verifyStripeConnection } from '@services/payments/payments'
import Image from 'next/image'
import learnhouseIcon from 'public/learnhouse_bigicon_1.png'

function StripeConnectCallback() {
  const router = useRouter()
  const searchParams = useSearchParams()
  const session = useLHSession() as any
  const [status, setStatus] = useState<'processing' | 'success' | 'error'>('processing')
  const [message, setMessage] = useState('')

  useEffect(() => {
    const verifyConnection = async () => {
      try {
        const code = searchParams.get('code')
        const state = searchParams.get('state')
        const orgId = state?.split('=')[1] // Extract org_id value after '='

        if (!code || !orgId) {
          throw new Error('Missing required parameters')
        }

        const response = await verifyStripeConnection(
          parseInt(orgId),
          code,
          session?.data?.tokens?.access_token
        )

        // Wait for 1 second to show processing state
        await new Promise(resolve => setTimeout(resolve, 1000))
        
        setStatus('success')
        setMessage('Successfully connected to Stripe!')
        
        // Close the window after 2 seconds of showing success
        setTimeout(() => {
          window.close()
        }, 2000)
        
      } catch (error) {
        console.error('Error verifying Stripe connection:', error)
        setStatus('error')
        setMessage('Failed to complete Stripe connection')
        toast.error('Failed to connect to Stripe')
      }
    }

    if (session) {
      verifyConnection()
    }
  }, [session, router, searchParams])

  return (
    <div className="h-screen w-full bg-[#f8f8f8] flex items-center justify-center">
      <div className="flex flex-col items-center">
        <div className="mb-10">
          <Image
            quality={100}
            width={50}
            height={50}
            src={learnhouseIcon}
            alt=""
          />
        </div>
        
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.3 }}
          className="bg-white p-8 rounded-xl nice-shadow max-w-md w-full mx-4"
        >
          <div className="flex flex-col items-center text-center space-y-4">
            {status === 'processing' && (
              <>
                <Loader2 className="h-12 w-12 text-blue-500 animate-spin" />
                <h2 className="text-xl font-semibold text-gray-800">
                  Completing Stripe Connection
                </h2>
                <p className="text-gray-500">
                  Please wait while we finish setting up your Stripe integration...
                </p>
              </>
            )}

            {status === 'success' && (
              <>
                <div className="bg-green-100 p-3 rounded-full">
                  <Check className="h-8 w-8 text-green-600" />
                </div>
                <h2 className="text-xl font-semibold text-gray-800">{message}</h2>
                <p className="text-gray-500">
                  You can now return to the dashboard to start using payments.
                </p>
              </>
            )}

            {status === 'error' && (
              <>
                <div className="bg-red-100 p-3 rounded-full">
                  <AlertTriangle className="h-8 w-8 text-red-600" />
                </div>
                <h2 className="text-xl font-semibold text-gray-800">{message}</h2>
                <p className="text-gray-500">
                  Please try again or contact support if the problem persists.
                </p>
              </>
            )}
          </div>
        </motion.div>
      </div>
    </div>
  )
}

export default StripeConnectCallback 


================================================
FILE: apps/web/components/Contexts/CourseContext.tsx
================================================
'use client'
import { getAPIUrl } from '@services/config/config'
import { swrFetcher } from '@services/utils/ts/requests'
import React, { createContext, useContext, useEffect, useReducer } from 'react'
import useSWR from 'swr'
import { useLHSession } from '@components/Contexts/LHSessionContext'

export const CourseContext = createContext(null)
export const CourseDispatchContext = createContext(null)

export function CourseProvider({ children, courseuuid, withUnpublishedActivities = false }: any) {
  const session = useLHSession() as any;
  const access_token = session?.data?.tokens?.access_token;

  const { data: courseStructureData, error } = useSWR(`${getAPIUrl()}courses/${courseuuid}/meta?with_unpublished_activities=${withUnpublishedActivities}`,
    url => swrFetcher(url, access_token)
  );

  const initialState = {
    courseStructure: {
      course_uuid: courseuuid,
    },
    courseOrder: {},
    isSaved: true,
    isLoading: true,
    withUnpublishedActivities: withUnpublishedActivities
  };

  const [state, dispatch] = useReducer(courseReducer, initialState) as any;

  useEffect(() => {
    if (courseStructureData) {
      dispatch({ type: 'setCourseStructure', payload: courseStructureData });
      dispatch({ type: 'setIsLoaded' });
    }
  }, [courseStructureData]);

  if (error) return <div>Failed to load course structure</div>;
  if (!courseStructureData) return '';

  if (courseStructureData) {
    return (
      <CourseContext.Provider value={state}>
        <CourseDispatchContext.Provider value={dispatch}>
          {children}
        </CourseDispatchContext.Provider>
      </CourseContext.Provider>
    )
  }
}

export function useCourse() {
  return useContext(CourseContext)
}

export function useCourseDispatch() {
  return useContext(CourseDispatchContext)
}

function courseReducer(state: any, action: any) {
  switch (action.type) {
    case 'setCourseStructure':
      return { ...state, courseStructure: action.payload }
    case 'setCourseOrder':
      return { ...state, courseOrder: action.payload }
    case 'setIsSaved':
      return { ...state, isSaved: true }
    case 'setIsNotSaved':
      return { ...state, isSaved: false }
    case 'setIsLoaded':
      return { ...state, isLoading: false }
    default:
      throw new Error(`Unhandled action type: ${action.type}`)
  }
}



================================================
FILE: apps/web/components/Contexts/LHSessionContext.tsx
================================================
'use client'
import PageLoading from '@components/Objects/Loaders/PageLoading';
import { useSession } from 'next-auth/react';
import React, { useContext, createContext } from 'react'

export const SessionContext = createContext({}) as any

function LHSessionProvider({ children }: { children: React.ReactNode }) {
    const session = useSession();

    if (session && session.status == 'loading') {
        return <PageLoading />
    }

    else if (session) {
        return (
            <SessionContext.Provider value={session}>
                {children}
            </SessionContext.Provider>
        )
    }
}

export function useLHSession() {
    return useContext(SessionContext)
}

export default LHSessionProvider


================================================
FILE: apps/web/components/Contexts/OrgContext.tsx
================================================
'use client'
import { getAPIUrl, getUriWithoutOrg } from '@services/config/config'
import { swrFetcher } from '@services/utils/ts/requests'
import React, { createContext, useContext, useMemo } from 'react'
import useSWR from 'swr'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import ErrorUI from '@components/Objects/StyledElements/Error/Error'
import { usePathname } from 'next/navigation'
import { signOut } from 'next-auth/react'
import { LogOut, PersonStanding, Home } from 'lucide-react'

export const OrgContext = createContext(null)

export function OrgProvider({ children, orgslug }: { children: React.ReactNode, orgslug: string }) {
  const session = useLHSession() as any
  const pathname = usePathname()
  const accessToken = session?.data?.tokens?.access_token
  const isAllowedPathname = ['/login', '/signup'].includes(pathname);

  const handleSignOut = async () => {
    await signOut({ 
      redirect: true, 
      callbackUrl: getUriWithoutOrg('/login?orgslug=' + orgslug) 
    })
  }

  const { data: org, error: orgError } = useSWR(
    `${getAPIUrl()}orgs/slug/${orgslug}`,
    (url) => swrFetcher(url, accessToken)
  )
  const { data: orgs, error: orgsError } = useSWR(
    `${getAPIUrl()}orgs/user/page/1/limit/10`,
    (url) => swrFetcher(url, accessToken)
  )


  const isOrgActive = useMemo(() => org?.config?.config?.general?.enabled !== false, [org])
  const isUserPartOfTheOrg = useMemo(() => orgs?.some((userOrg: any) => userOrg.id === org?.id), [orgs, org?.id])

  if (orgError || orgsError) return <ErrorUI message='An error occurred while fetching data' />
  if (!org || !orgs || !session) return <div></div>
  if (!isOrgActive) return <ErrorUI message='This organization is no longer active' />
  if (!isUserPartOfTheOrg && session.status == 'authenticated' && !isAllowedPathname) {
    return (
      <div className="flex flex-col py-10 mx-auto antialiased items-center space-y-6 bg-linear-to-b from-yellow-100 to-yellow-100/5 ">
        <div className="flex flex-row items-center space-x-5 rounded-xl ">
          <div className="text-yellow-700">
            <PersonStanding size={45} />
          </div>
          <div className='flex flex-col'>
            <p className="text-3xl font-bold text-yellow-700">You are not part of this Organization yet</p>
          </div>
        </div>
        <div className='flex space-x-4'>
          <a
            href={getUriWithoutOrg(`/signup?orgslug=${orgslug}`)}
            className="flex space-x-2 items-center rounded-full px-4 py-1 text-yellow-200 bg-yellow-700 hover:bg-yellow-800 transition-all ease-linear shadow-lg "
          >
            <PersonStanding className="text-yellow-200" size={17} />
            <span className="text-md font-bold">Join {org?.name}</span>
          </a>
          <a
            href={getUriWithoutOrg('/home')}
            className="flex space-x-2 items-center rounded-full px-4 py-1 text-gray-200 bg-gray-700 hover:bg-gray-800 transition-all ease-linear shadow-lg "
          >
            <Home className="text-gray-200" size={17} />
            <span className="text-md font-bold">Home</span>
          </a>
          <button
            onClick={handleSignOut}
            className="flex space-x-2 items-center rounded-full px-4 py-1 text-red-200 bg-red-700 hover:bg-red-800 transition-all ease-linear shadow-lg "
          >
            <LogOut className="text-red-200" size={17} />
            <span className="text-md font-bold">Sign Out</span>
          </button>
        </div>
      </div>
    )
  }

  return <OrgContext.Provider value={org}>{children}</OrgContext.Provider>
}

export function useOrg() {
  return useContext(OrgContext)
}



================================================
FILE: apps/web/components/Contexts/AI/AIChatBotContext.tsx
================================================
'use client'
import { AIMessage } from '@components/Objects/Activities/AI/AIActivityAsk'
import React, { createContext, useContext, useReducer } from 'react'
export const AIChatBotContext = createContext(null) as any
export const AIChatBotDispatchContext = createContext(null) as any

export type AIChatBotStateTypes = {
  messages: AIMessage[]
  isModalOpen: boolean
  aichat_uuid: string
  isWaitingForResponse: boolean
  chatInputValue: string
  error: AIError
}

type AIError = {
  isError: boolean
  status: number
  error_message: string
}

function AIChatBotProvider({ children }: { children: React.ReactNode }) {
  const [aiChatBotState, dispatchAIChatBot] = useReducer(aiChatBotReducer, {
    messages: [] as AIMessage[],
    isModalOpen: false,
    aichat_uuid: null,
    isWaitingForResponse: false,
    chatInputValue: '',
    error: { isError: false, status: 0, error_message: ' ' } as AIError,
  })
  return (
    <AIChatBotContext.Provider value={aiChatBotState}>
      <AIChatBotDispatchContext.Provider value={dispatchAIChatBot}>
        {children}
      </AIChatBotDispatchContext.Provider>
    </AIChatBotContext.Provider>
  )
}

export default AIChatBotProvider

export function useAIChatBot() {
  return useContext(AIChatBotContext)
}

export function useAIChatBotDispatch() {
  return useContext(AIChatBotDispatchContext)
}

function aiChatBotReducer(state: any, action: any) {
  switch (action.type) {
    case 'setMessages':
      return { ...state, messages: action.payload }
    case 'addMessage':
      return { ...state, messages: [...state.messages, action.payload] }
    case 'setIsModalOpen':
      return { ...state, isModalOpen: true }
    case 'setIsModalClose':
      return { ...state, isModalOpen: false }
    case 'setAichat_uuid':
      return { ...state, aichat_uuid: action.payload }
    case 'setIsWaitingForResponse':
      return { ...state, isWaitingForResponse: true }
    case 'setIsNoLongerWaitingForResponse':
      return { ...state, isWaitingForResponse: false }
    case 'setChatInputValue':
      return { ...state, chatInputValue: action.payload }
    case 'setError':
      return { ...state, error: action.payload }

    default:
      throw new Error(`Unhandled action type: ${action.type}`)
  }
}



================================================
FILE: apps/web/components/Contexts/AI/AIEditorContext.tsx
================================================
'use client'
import { AIMessage } from '@components/Objects/Activities/AI/AIActivityAsk'
import React, { createContext, useContext, useReducer } from 'react'
export const AIEditorContext = createContext(null) as any
export const AIEditorDispatchContext = createContext(null) as any

export type AIEditorStateTypes = {
  messages: AIMessage[]
  isModalOpen: boolean
  isFeedbackModalOpen: boolean
  aichat_uuid: string
  isWaitingForResponse: boolean
  chatInputValue: string
  selectedTool:
    | 'Writer'
    | 'ContinueWriting'
    | 'MakeLonger'
    | 'GenerateQuiz'
    | 'Translate'
  isUserInputEnabled: boolean
  error: AIError
}

type AIError = {
  isError: boolean
  status: number
  error_message: string
}

function AIEditorProvider({ children }: { children: React.ReactNode }) {
  const [aIEditorState, dispatchAIEditor] = useReducer(aIEditorReducer, {
    messages: [] as AIMessage[],
    isModalOpen: false,
    isFeedbackModalOpen: false,
    aichat_uuid: null,
    isWaitingForResponse: false,
    chatInputValue: '',
    selectedTool: 'Writer',
    isUserInputEnabled: true,
    error: { isError: false, status: 0, error_message: ' ' } as AIError,
  })
  return (
    <AIEditorContext.Provider value={aIEditorState}>
      <AIEditorDispatchContext.Provider value={dispatchAIEditor}>
        {children}
      </AIEditorDispatchContext.Provider>
    </AIEditorContext.Provider>
  )
}

export default AIEditorProvider

export function useAIEditor() {
  return useContext(AIEditorContext)
}

export function useAIEditorDispatch() {
  return useContext(AIEditorDispatchContext)
}

function aIEditorReducer(state: any, action: any) {
  switch (action.type) {
    case 'setMessages':
      return { ...state, messages: action.payload }
    case 'addMessage':
      return { ...state, messages: [...state.messages, action.payload] }
    case 'setIsModalOpen':
      return { ...state, isModalOpen: true }
    case 'setIsModalClose':
      return { ...state, isModalOpen: false }
    case 'setAichat_uuid':
      return { ...state, aichat_uuid: action.payload }
    case 'setIsWaitingForResponse':
      return { ...state, isWaitingForResponse: true }
    case 'setIsNoLongerWaitingForResponse':
      return { ...state, isWaitingForResponse: false }
    case 'setChatInputValue':
      return { ...state, chatInputValue: action.payload }
    case 'setSelectedTool':
      return { ...state, selectedTool: action.payload }
    case 'setIsFeedbackModalOpen':
      return { ...state, isFeedbackModalOpen: true }
    case 'setIsFeedbackModalClose':
      return { ...state, isFeedbackModalOpen: false }
    case 'setIsUserInputEnabled':
      return { ...state, isUserInputEnabled: action.payload }
    case 'setError':
      return { ...state, error: action.payload }

    default:
      throw new Error(`Unhandled action type: ${action.type}`)
  }
}



================================================
FILE: apps/web/components/Contexts/Assignments/AssignmentContext.tsx
================================================
'use client'
import { getAPIUrl } from '@services/config/config'
import { swrFetcher } from '@services/utils/ts/requests'
import React, { createContext, useContext, useEffect } from 'react'
import useSWR from 'swr'
import { useLHSession } from '@components/Contexts/LHSessionContext'

export const AssignmentContext = createContext({})

export function AssignmentProvider({ children, assignment_uuid }: { children: React.ReactNode, assignment_uuid: string }) {
    const session = useLHSession() as any
    const accessToken = session?.data?.tokens?.access_token
    const [assignmentsFull, setAssignmentsFull] = React.useState({ assignment_object: null, assignment_tasks: null, course_object: null , activity_object: null})

    const { data: assignment, error: assignmentError } = useSWR(
        `${getAPIUrl()}assignments/${assignment_uuid}`,
        (url) => swrFetcher(url, accessToken)
    )

    const { data: assignment_tasks, error: assignmentTasksError } = useSWR(
        `${getAPIUrl()}assignments/${assignment_uuid}/tasks`,
        (url) => swrFetcher(url, accessToken)
    )

    const course_id = assignment?.course_id

    const { data: course_object, error: courseObjectError } = useSWR(
        course_id ? `${getAPIUrl()}courses/id/${course_id}` : null,
        (url) => swrFetcher(url, accessToken)
    )

    const activity_id = assignment?.activity_id

    const { data: activity_object, error: activityObjectError } = useSWR(
        activity_id ? `${getAPIUrl()}activities/id/${activity_id}` : null,
        (url) => swrFetcher(url, accessToken)
    )

    useEffect(() => {
        if (assignment && assignment_tasks && (!course_id || course_object) && (!activity_id || activity_object)) {
            setAssignmentsFull({ assignment_object: assignment, assignment_tasks: assignment_tasks, course_object: course_object, activity_object: activity_object })
        }
    }, [assignment, assignment_tasks, course_object, activity_object, course_id, activity_id])

    if (assignmentError || assignmentTasksError || courseObjectError || activityObjectError) return <div></div>

    if (!assignment || !assignment_tasks || (course_id && !course_object) || (activity_id && !activity_object)) return <div></div>

    return <AssignmentContext.Provider value={assignmentsFull}>{children}</AssignmentContext.Provider>
}

export function useAssignments() {
    return useContext(AssignmentContext)
}



================================================
FILE: apps/web/components/Contexts/Assignments/AssignmentsTaskContext.tsx
================================================
'use client'
import React, { createContext, useContext, useEffect, useReducer } from 'react'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { getAssignmentTask } from '@services/courses/assignments'
import { useAssignments } from './AssignmentContext';
import { mutate } from 'swr';
import { getAPIUrl } from '@services/config/config';

interface State {
    selectedAssignmentTaskUUID: string | null;
    assignmentTask: Record<string, any>;
    reloadTrigger: number;
}

interface Action {
    type: string;
    payload?: any;
}

const initialState: State = {
    selectedAssignmentTaskUUID: null,
    assignmentTask: {},
    reloadTrigger: 0,
};

export const AssignmentsTaskContext = createContext<State | undefined>(undefined);
export const AssignmentsTaskDispatchContext = createContext<React.Dispatch<Action> | undefined>(undefined);

export function AssignmentsTaskProvider({ children }: { children: React.ReactNode }) {
    const session = useLHSession() as any;
    const access_token = session?.data?.tokens?.access_token;
    const assignment = useAssignments() as any

    const [state, dispatch] = useReducer(assignmentstaskReducer, initialState);

    async function fetchAssignmentTask(assignmentTaskUUID: string) {
        const res = await getAssignmentTask(assignmentTaskUUID, access_token);


        if (res.success) {
            dispatch({ type: 'setAssignmentTask', payload: res.data });
        }
    }

    useEffect(() => {

        if (state.selectedAssignmentTaskUUID) {
            fetchAssignmentTask(state.selectedAssignmentTaskUUID);
            mutate(`${getAPIUrl()}assignments/${assignment.assignment_object?.assignment_uuid}/tasks`);
        }
    }, [state.selectedAssignmentTaskUUID, state.reloadTrigger, assignment]);

    return (
        <AssignmentsTaskContext.Provider value={state}>
            <AssignmentsTaskDispatchContext.Provider value={dispatch}>
                {children}
            </AssignmentsTaskDispatchContext.Provider>
        </AssignmentsTaskContext.Provider>
    );
}

export function useAssignmentsTask() {
    const context = useContext(AssignmentsTaskContext);
    if (context === undefined) {
        throw new Error('useAssignmentsTask must be used within an AssignmentsTaskProvider');
    }
    return context;
}

export function useAssignmentsTaskDispatch() {
    const context = useContext(AssignmentsTaskDispatchContext);
    if (context === undefined) {
        throw new Error('useAssignmentsTaskDispatch must be used within an AssignmentsTaskProvider');
    }
    return context;
}

function assignmentstaskReducer(state: State, action: Action): State {
    switch (action.type) {
        case 'setSelectedAssignmentTaskUUID':
            return { ...state, selectedAssignmentTaskUUID: action.payload };
        case 'setAssignmentTask':
            return { ...state, assignmentTask: action.payload };
        case 'reload':
            return { ...state, reloadTrigger: state.reloadTrigger + 1 };
        case 'SET_MULTIPLE_STATES':
            return {
                ...state,
                ...action.payload,
            };
        default:
            return state;
    }
}



================================================
FILE: apps/web/components/Contexts/Assignments/AssignmentSubmissionContext.tsx
================================================
'use client'
import React from 'react'
import { useLHSession } from '../LHSessionContext'
import { getAPIUrl } from '@services/config/config'
import { swrFetcher } from '@services/utils/ts/requests'
import useSWR from 'swr'

export const AssignmentSubmissionContext = React.createContext({})

function AssignmentSubmissionProvider({ children, assignment_uuid }: { children: React.ReactNode, assignment_uuid: string }) {
    const session = useLHSession() as any
    const accessToken = session?.data?.tokens?.access_token

    const { data: assignmentSubmission, error: assignmentError } = useSWR(
        `${getAPIUrl()}assignments/${assignment_uuid}/submissions/me`,
        (url) => swrFetcher(url, accessToken)
    )

    return (
        <AssignmentSubmissionContext.Provider value={assignmentSubmission} >{children}</AssignmentSubmissionContext.Provider>
    )
}

export function useAssignmentSubmission() {
    return React.useContext(AssignmentSubmissionContext)
}

export default AssignmentSubmissionProvider


================================================
FILE: apps/web/components/Contexts/Editor/EditorContext.tsx
================================================
'use client'
import React, { useState } from 'react'

export const EditorProviderContext = React.createContext(null) as any

type EditorProviderProps = {
  children: React.ReactNode
  options: EditorProviderState
}

type EditorProviderState = {
  isEditable: boolean
}

function EditorOptionsProvider({ children, options }: EditorProviderProps) {
  const [editorOptions, setEditorOptions] =
    useState<EditorProviderState>(options)

  return (
    <EditorProviderContext.Provider value={editorOptions}>
      {children}
    </EditorProviderContext.Provider>
  )
}

export default EditorOptionsProvider

export function useEditorProvider() {
  return React.useContext(EditorProviderContext)
}



================================================
FILE: apps/web/components/Dashboard/Menus/DashLeftMenu.tsx
================================================
'use client'
import { useOrg } from '@components/Contexts/OrgContext'
import { signOut } from 'next-auth/react'
import ToolTip from '@components/Objects/StyledElements/Tooltip/Tooltip'
import LearnHouseDashboardLogo from '@public/dashLogo.png'
import { Backpack, BadgeDollarSign, BookCopy, Home, LogOut, Package2, School, Settings, Users } from 'lucide-react'
import Image from 'next/image'
import Link from 'next/link'
import React, { useEffect } from 'react'
import UserAvatar from '../../Objects/UserAvatar'
import AdminAuthorization from '@components/Security/AdminAuthorization'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { getUriWithOrg, getUriWithoutOrg } from '@services/config/config'
import useFeatureFlag from '@components/Hooks/useFeatureFlag'

function DashLeftMenu() {
  const org = useOrg() as any
  const session = useLHSession() as any
  const [loading, setLoading] = React.useState(true)
  const isPaymentsEnabled = useFeatureFlag({ path: ['features', 'payments', 'enabled'], defaultValue: false })

  function waitForEverythingToLoad() {
    if (org && session) {
      return true
    }
    return false
  }

  async function logOutUI() {
    const res = await signOut({ redirect: true, callbackUrl: getUriWithoutOrg('/login?orgslug=' + org.slug) })
    if (res) {
      getUriWithOrg(org.slug, '/')
    }
  }

  useEffect(() => {
    if (waitForEverythingToLoad()) {
      setLoading(false)
    }
  }, [loading])

  return (
    <div
      style={{
        background:
          'linear-gradient(0deg, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.2) 100%), radial-gradient(271.56% 105.16% at 50% -5.16%, rgba(255, 255, 255, 0.18) 0%, rgba(0, 0, 0, 0) 100%), rgb(20 19 19)',
      }}
      className="flex flex-col w-[90px] bg-black text-white shadow-xl h-screen sticky top-0"
    >
      <div className="flex flex-col h-full">
        <div className="flex h-20 mt-6">
          <Link
            className="flex flex-col items-center mx-auto space-y-3"
            href={'/'}
          >
            <ToolTip
              content={'Back to Home'}
              slateBlack
              sideOffset={8}
              side="right"
            >
              <Image
                alt="Learnhouse logo"
                width={40}
                src={LearnHouseDashboardLogo}
              />
            </ToolTip>
            <ToolTip
              content={'Your Organization'}
              slateBlack
              sideOffset={8}
              side="right"
            >
              <div className="py-1 px-3 bg-black/40 opacity-40 rounded-md text-[10px] justify-center text-center">
                {org?.name}
              </div>
            </ToolTip>
          </Link>
        </div>
        <div className="flex grow flex-col justify-center space-y-5 items-center mx-auto">
          {/* <ToolTip content={"Back to " + org?.name + "'s Home"} slateBlack sideOffset={8} side='right'  >
                        <Link className='bg-white text-black hover:text-white rounded-lg p-2 hover:bg-white/10 transition-all ease-linear' href={`/`} ><ArrowLeft className='hover:text-white' size={18} /></Link>
                    </ToolTip> */}
          <AdminAuthorization authorizationMode="component">
            <ToolTip content={'Home'} slateBlack sideOffset={8} side="right">
              <Link
                aria-label="Home"
                className="bg-white/5 rounded-lg p-2 hover:bg-white/10 transition-all ease-linear"
                href={`/dash`}
              >
                <Home size={18} />
              </Link>
            </ToolTip>
            <ToolTip content={'Courses'} slateBlack sideOffset={8} side="right">
              <Link
                aria-label="Courses"
                className="bg-white/5 rounded-lg p-2 hover:bg-white/10 transition-all ease-linear"
                href={`/dash/courses`}
              >
                <BookCopy size={18} />
              </Link>
            </ToolTip>
            <ToolTip content={'Assignments'} slateBlack sideOffset={8} side="right">
              <Link
                aria-label="Assignments"
                className="bg-white/5 rounded-lg p-2 hover:bg-white/10 transition-all ease-linear"
                href={`/dash/assignments`}
              >
                <Backpack size={18} />
              </Link>
            </ToolTip>
            <ToolTip content={'Users'} slateBlack sideOffset={8} side="right">
              <Link
                aria-label="Users"
                className="bg-white/5 rounded-lg p-2 hover:bg-white/10 transition-all ease-linear"
                href={`/dash/users/settings/users`}
              >
                <Users size={18} />
              </Link>
            </ToolTip>
            {isPaymentsEnabled && (
              <ToolTip content={'Payments'} slateBlack sideOffset={8} side="right">
                <Link
                  aria-label="Payments"
                  className="bg-white/5 rounded-lg p-2 hover:bg-white/10 transition-all ease-linear"
                  href={`/dash/payments/customers`}
                >
                  <BadgeDollarSign size={18} />
                </Link>
              </ToolTip>
            )}
            <ToolTip
              content={'Organization'}
              slateBlack
              sideOffset={8}
              side="right"
            >
              <Link
                aria-label="Organization"
                className="bg-white/5 rounded-lg p-2 hover:bg-white/10 transition-all ease-linear"
                href={`/dash/org/settings/general`}
              >
                <School size={18} />
              </Link>
            </ToolTip>
          </AdminAuthorization>
        </div>
        <div className="flex flex-col mx-auto pb-7 space-y-2">
          <div className="flex items-center flex-col space-y-2">
            <ToolTip
              content={'@' + session.data.user.username}
              slateBlack
              sideOffset={8}
              side="right"
            >
              <div className="mx-auto">
                <UserAvatar border="border-4" width={35} />
              </div>
            </ToolTip>
            <div className="flex items-center flex-col space-y-3">
              <div className="flex flex-col space-y-1 py-1">
                <ToolTip
                  content={session.data.user.username + "'s Owned Courses"}
                slateBlack
                sideOffset={8}
                side="right"
              >
                <Link
                    href={'/dash/user-account/owned'}
                    className="py-1"
                >
                  <Package2
                    className="mx-auto text-neutral-400 cursor-pointer"
                    size={18}
                  />
                </Link>
              </ToolTip>
                <ToolTip
                  content={session.data.user.username + "'s Settings"}
                slateBlack
                sideOffset={8}
                side="right"
              >
                <Link
                  href={'/dash/user-account/settings/general'}
                  className="py-1"
                >
                  <Settings
                    className="mx-auto text-neutral-400 cursor-pointer"
                    size={18}
                  />
                  </Link>
                </ToolTip>
              </div>
              <ToolTip
                content={'Logout'}
                slateBlack
                sideOffset={8}
                side="right"
              >
                <LogOut
                  onClick={() => logOutUI()}
                  className="mx-auto text-neutral-400 cursor-pointer"
                  size={14}
                />
              </ToolTip>
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}

export default DashLeftMenu



================================================
FILE: apps/web/components/Dashboard/Menus/DashMobileMenu.tsx
================================================
'use client'
import { useOrg } from '@components/Contexts/OrgContext'
import { Backpack, BadgeDollarSign, BookCopy, Home, School, Settings, Users } from 'lucide-react'
import Link from 'next/link'
import React from 'react'
import AdminAuthorization from '@components/Security/AdminAuthorization'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import ToolTip from '@components/Objects/StyledElements/Tooltip/Tooltip'

function DashMobileMenu() {
  const org = useOrg() as any
  const session = useLHSession() as any

  return (
    <div className="fixed bottom-0 left-0 right-0 bg-black/90 backdrop-blur-lg text-white shadow-xl">
      <div className="flex justify-around items-center h-16 px-2">
        <AdminAuthorization authorizationMode="component">
          <ToolTip content={'Home'} slateBlack sideOffset={8} side="top">
            <Link href={`/`} className="flex flex-col items-center p-2" aria-label="Go to dashboard home">
              <Home size={20} />
              <span className="text-xs mt-1">Home</span>
            </Link>
          </ToolTip>
          <ToolTip content={'Courses'} slateBlack sideOffset={8} side="top">
            <Link href={`/dash/courses`} className="flex flex-col items-center p-2" aria-label="Manage courses">
              <BookCopy size={20} />
              <span className="text-xs mt-1">Courses</span>
            </Link>
          </ToolTip>
          <ToolTip content={'Assignments'} slateBlack sideOffset={8} side="top">
            <Link href={`/dash/assignments`} className="flex flex-col items-center p-2" aria-label="Manage assignments">
              <Backpack size={20} />
              <span className="text-xs mt-1">Assignments</span>
            </Link>
          </ToolTip>
          <ToolTip content={'Payments'} slateBlack sideOffset={8} side="top">
            <Link href={`/dash/payments/customers`} className="flex flex-col items-center p-2" aria-label="Manage payments and billing">
              <BadgeDollarSign size={20} />
              <span className="text-xs mt-1">Payments</span>
            </Link>
          </ToolTip>
          <ToolTip content={'Users'} slateBlack sideOffset={8} side="top">
            <Link href={`/dash/users/settings/users`} className="flex flex-col items-center p-2" aria-label="Manage users">
              <Users size={20} />
              <span className="text-xs mt-1">Users</span>
            </Link>
          </ToolTip>
          <ToolTip content={'Organization'} slateBlack sideOffset={8} side="top">
            <Link href={`/dash/org/settings/general`} className="flex flex-col items-center p-2" aria-label="Organization settings">
              <School size={20} />
              <span className="text-xs mt-1">Org</span>
            </Link>
          </ToolTip>
        </AdminAuthorization>
        <ToolTip content={session.data.user.username + "'s Settings"} slateBlack sideOffset={8} side="top">
          <Link href={'/dash/user-account/settings/general'} className="flex flex-col items-center p-2" aria-label="User account settings">
            <Settings size={20} />
            <span className="text-xs mt-1">Settings</span>
          </Link>
        </ToolTip>
      </div>
    </div>
  )
}

export default DashMobileMenu



================================================
FILE: apps/web/components/Dashboard/Misc/BreadCrumbs.tsx
================================================
'use client';
import { useOrg } from '@components/Contexts/OrgContext';
import { Backpack, Book, ChevronRight, CreditCard, School, User, Users } from 'lucide-react'
import Link from 'next/link'
import React from 'react'

type BreadCrumbsProps = {
  type: 'courses' | 'user' | 'users' | 'org' | 'orgusers' | 'assignments' | 'payments'
  last_breadcrumb?: string
}

function BreadCrumbs(props: BreadCrumbsProps) {
  const org = useOrg() as any

  return (
    <div>
      <div className="h-7"></div>
      <div className="text-gray-400 tracking-tight font-medium text-sm flex space-x-1">
        <div className="flex items-center space-x-1">
          {props.type == 'courses' ? (
            <div className="flex space-x-2 items-center">
              {' '}
              <Book className="text-gray" size={14}></Book>
              <Link href="/dash/courses">Courses</Link>
            </div>
          ) : (
            ''
          )}
          {props.type == 'assignments' ? (
            <div className="flex space-x-2 items-center">
              {' '}
              <Backpack className="text-gray" size={14}></Backpack>
              <Link href="/dash/assignments">Assignments</Link>
            </div>
          ) : (
            ''
          )}
          {props.type == 'user' ? (
            <div className="flex space-x-2 items-center">
              {' '}
              <User className="text-gray" size={14}></User>
              <Link href="/dash/user-account/settings/general">
                Account Settings
              </Link>
            </div>
          ) : (
            ''
          )}
          {props.type == 'orgusers' ? (
            <div className="flex space-x-2 items-center">
              {' '}
              <Users className="text-gray" size={14}></Users>
              <Link href="/dash/users/settings/users">Organization users</Link>
            </div>
          ) : (
            ''
          )}

          {props.type == 'org' ? (
            <div className="flex space-x-2 items-center">
              {' '}
              <School className="text-gray" size={14}></School>
              <Link href="/dash/users">Organization Settings</Link>
            </div>
          ) : (
            ''
          )}
          {props.type == 'payments' ? (
            <div className="flex space-x-2 items-center">
              {' '}
              <CreditCard className="text-gray" size={14}></CreditCard>
              <Link href="/dash/payments">Payments</Link>
            </div>
          ) : (
            ''
          )}
          <div className="flex items-center space-x-1 first-letter:uppercase">
            {props.last_breadcrumb ? <ChevronRight size={17} /> : ''}
            <div className="first-letter:uppercase">
              {' '}
              {props.last_breadcrumb}
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}

export default BreadCrumbs



================================================
FILE: apps/web/components/Dashboard/Misc/CourseOverviewTop.tsx
================================================
import { useCourse } from '@components/Contexts/CourseContext'
import { useEffect } from 'react'
import BreadCrumbs from './BreadCrumbs'
import SaveState from './SaveState'
import { CourseOverviewParams } from 'app/orgs/[orgslug]/dash/courses/course/[courseuuid]/[subpage]/page'
import { getUriWithOrg } from '@services/config/config'
import { useOrg } from '@components/Contexts/OrgContext'
import { getCourseThumbnailMediaDirectory } from '@services/media/media'
import Link from 'next/link'
import Image from 'next/image'
import EmptyThumbnailImage from '../../../public/empty_thumbnail.png'
import { BookOpen } from 'lucide-react'

export function CourseOverviewTop({
  params,
}: {
  params: CourseOverviewParams
}) {
  const course = useCourse() as any
  const org = useOrg() as any

  useEffect(() => {}, [course, org])

  return (
    <>
      <BreadCrumbs
        type="courses"
        last_breadcrumb={course.courseStructure.name}
      ></BreadCrumbs>
      <div className="flex">
        <div className="flex py-3 grow items-center">
          <Link
            href={getUriWithOrg(org?.slug, '') + `/course/${params.courseuuid}`}
          >
            {course?.courseStructure?.thumbnail_image ? (
              <img
                className="w-[100px] h-[57px] rounded-md drop-shadow-md"
                src={`${getCourseThumbnailMediaDirectory(
                  org?.org_uuid,
                  'course_' + params.courseuuid,
                  course.courseStructure.thumbnail_image
                )}`}
                alt=""
              />
            ) : (
              <Image
                width={100}
                className="h-[57px] rounded-md drop-shadow-md"
                src={EmptyThumbnailImage}
                alt=""
              />
            )}
          </Link>
          <div className="flex flex-col course_metadata justify-center pl-5">
            <div className="text-gray-400 font-semibold text-sm">Course</div>
            <div className="text-black font-bold text-xl -mt-1 first-letter:uppercase">
              {course.courseStructure.name}
            </div>
          </div>
        </div>
        <div className="flex items-center space-x-4">
          <Link
            href={getUriWithOrg(org?.slug, '/dash/documentation/rights')}
            className="rounded-lg bg-black hover:scale-105 transition-all duration-100 ease-linear antialiased p-2 px-5 font text-xs font-bold text-white drop-shadow-lg flex space-x-2 items-center"
          >
            <BookOpen className="w-4 h-4" />
            <span>Rights Guide</span>
          </Link>
          <SaveState orgslug={params.orgslug} />
        </div>
      </div>
    </>
  )
}



================================================
FILE: apps/web/components/Dashboard/Misc/SaveState.tsx
================================================
'use client'
import { getAPIUrl } from '@services/config/config'
import { updateCourseOrderStructure } from '@services/courses/chapters'
import { revalidateTags } from '@services/utils/ts/requests'
import {
  useCourse,
  useCourseDispatch,
} from '@components/Contexts/CourseContext'
import { Check, SaveAllIcon, Timer, Loader2 } from 'lucide-react'
import { useRouter } from 'next/navigation'
import React, { useEffect, useState } from 'react'
import { mutate } from 'swr'
import { updateCourse } from '@services/courses/courses'
import { updateCertification } from '@services/courses/certifications'
import { useLHSession } from '@components/Contexts/LHSessionContext'

function SaveState(props: { orgslug: string }) {
  const [isLoading, setIsLoading] = useState(false)
  const course = useCourse() as any
  const session = useLHSession() as any;
  const router = useRouter()
  const saved = course ? course.isSaved : true
  const dispatchCourse = useCourseDispatch() as any
  const course_structure = course.courseStructure
  const withUnpublishedActivities = course ? course.withUnpublishedActivities : false
  const saveCourseState = async () => {
    if (saved || isLoading) return
    setIsLoading(true)
    try {
      // Course  order
      await changeOrderBackend()
      mutate(`${getAPIUrl()}courses/${course.courseStructure.course_uuid}/meta?with_unpublished_activities=${withUnpublishedActivities}`)
      // Course metadata
      await changeMetadataBackend()
      mutate(`${getAPIUrl()}courses/${course.courseStructure.course_uuid}/meta?with_unpublished_activities=${withUnpublishedActivities}`)
      // Certification data (if present)
      await saveCertificationData()
      await revalidateTags(['courses'], props.orgslug)
      dispatchCourse({ type: 'setIsSaved' })
    } finally {
      setIsLoading(false)
    }
  }

  //
  // Course Order
  const changeOrderBackend = async () => {
    mutate(`${getAPIUrl()}courses/${course.courseStructure.course_uuid}/meta?with_unpublished_activities=${withUnpublishedActivities}`)
    await updateCourseOrderStructure(
      course.courseStructure.course_uuid,
      course.courseOrder,
      session.data?.tokens?.access_token
    )
    await revalidateTags(['courses'], props.orgslug)
    router.refresh()
    dispatchCourse({ type: 'setIsSaved' })
  }

  // Course metadata
  const changeMetadataBackend = async () => {
    mutate(`${getAPIUrl()}courses/${course.courseStructure.course_uuid}/meta?with_unpublished_activities=${withUnpublishedActivities}`)
    await updateCourse(
      course.courseStructure.course_uuid,
      course.courseStructure,
      session.data?.tokens?.access_token
    )
    await revalidateTags(['courses'], props.orgslug)
    router.refresh()
    dispatchCourse({ type: 'setIsSaved' })
  }

  // Certification data
  const saveCertificationData = async () => {
    if (course.courseStructure._certificationData) {
      const certData = course.courseStructure._certificationData;
      try {
        await updateCertification(
          certData.certification_uuid,
          certData.config,
          session.data?.tokens?.access_token
        );
        console.log('Certification data saved successfully');
      } catch (error) {
        console.error('Failed to save certification data:', error);
        // Don't throw error to prevent breaking the main save flow
      }
    }
  }

  const handleCourseOrder = (course_structure: any) => {
    const chapters = course_structure.chapters
    const chapter_order_by_ids = chapters.map((chapter: any) => {
      return {
        chapter_id: chapter.id,
        activities_order_by_ids: chapter.activities.map((activity: any) => {
          return {
            activity_id: activity.id,
          }
        }),
      }
    })
    dispatchCourse({
      type: 'setCourseOrder',
      payload: { chapter_order_by_ids: chapter_order_by_ids },
    })
    dispatchCourse({ type: 'setIsNotSaved' })
  }

  const initOrderPayload = () => {
    if (course_structure && course_structure.chapters) {
      handleCourseOrder(course_structure)
      dispatchCourse({ type: 'setIsSaved' })
    }
  }

  const changeOrderPayload = () => {
    if (course_structure && course_structure.chapters) {
      handleCourseOrder(course_structure)
      dispatchCourse({ type: 'setIsNotSaved' })
    }
  }

  useEffect(() => {
    if (course_structure?.chapters) {
      initOrderPayload()
    }
    if (course_structure?.chapters && !saved) {
      changeOrderPayload()
    }
  }, [course_structure]) // This effect depends on the `course_structure` variable

  return (
    <div className="flex space-x-4">
      {saved ? (
        <></>
      ) : (
        <div className="text-gray-600 flex space-x-2 items-center antialiased">
          <Timer size={15} />
          <div>Unsaved changes</div>
        </div>
      )}
      <div
        className={
          `px-4 py-2 rounded-lg drop-shadow-md cursor-pointer flex space-x-2 items-center font-bold antialiased transition-all ease-linear ` +
          (saved
            ? 'bg-gray-600 text-white'
            : 'bg-black text-white border hover:bg-gray-900 ') +
          (isLoading ? 'opacity-50 cursor-not-allowed' : '')
        }
        onClick={saveCourseState}
      >
        {isLoading ? (
          <Loader2 size={20} className="animate-spin" />
        ) : saved ? (
          <Check size={20} />
        ) : (
          <SaveAllIcon size={20} />
        )}
        {isLoading ? (
          <div className="">Saving...</div>
        ) : saved ? (
          <div className="">Saved</div>
        ) : (
          <div className="">Save</div>
        )}
      </div>
    </div>
  )
}

export default SaveState



================================================
FILE: apps/web/components/Dashboard/Pages/Course/EditCourseAccess/EditCourseAccess.tsx
================================================
import { useCourse, useCourseDispatch } from '@components/Contexts/CourseContext'
import LinkToUserGroup from '@components/Objects/Modals/Dash/EditCourseAccess/LinkToUserGroup'
import ConfirmationModal from '@components/Objects/StyledElements/ConfirmationModal/ConfirmationModal'
import Modal from '@components/Objects/StyledElements/Modal/Modal'
import { getAPIUrl } from '@services/config/config'
import { unLinkResourcesToUserGroup } from '@services/usergroups/usergroups'
import { swrFetcher } from '@services/utils/ts/requests'
import { Globe, SquareUserRound, Users, X } from 'lucide-react'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import React, { useEffect, useState } from 'react'
import toast from 'react-hot-toast'
import useSWR, { mutate } from 'swr'

type EditCourseAccessProps = {
    orgslug: string
    course_uuid?: string
}

function EditCourseAccess(props: EditCourseAccessProps) {
    const session = useLHSession() as any;
    const access_token = session?.data?.tokens?.access_token;
    const course = useCourse() as any;
    const { isLoading, courseStructure } = course as any;
    const dispatchCourse = useCourseDispatch() as any;

    const { data: usergroups } = useSWR(courseStructure ? `${getAPIUrl()}usergroups/resource/${courseStructure.course_uuid}` : null, (url) => swrFetcher(url, access_token));
    const [isClientPublic, setIsClientPublic] = useState<boolean | undefined>(undefined);

    useEffect(() => {
        if (!isLoading && courseStructure?.public !== undefined) {
            setIsClientPublic(courseStructure.public);
        }
    }, [isLoading, courseStructure]);

    useEffect(() => {
        if (!isLoading && courseStructure?.public !== undefined && isClientPublic !== undefined) {
            if (isClientPublic !== courseStructure.public) {
                dispatchCourse({ type: 'setIsNotSaved' });
                const updatedCourse = {
                    ...courseStructure,
                    public: isClientPublic,
                };
                dispatchCourse({ type: 'setCourseStructure', payload: updatedCourse });
            }
        }
    }, [isLoading, isClientPublic, courseStructure, dispatchCourse]);

    return (
        <div>
            {courseStructure && (
                <div>
                    <div className="h-6"></div>
                    <div className="mx-4 sm:mx-10 bg-white rounded-xl shadow-xs px-4 py-4">
                        <div className="flex flex-col bg-gray-50 -space-y-1 px-3 sm:px-5 py-3 rounded-md mb-3">
                            <h1 className="font-bold text-lg sm:text-xl text-gray-800">Access to the course</h1>
                            <h2 className="text-gray-500 text-xs sm:text-sm">
                                Choose if you want your course to be publicly available on the internet or only accessible to signed in users
                            </h2>
                        </div>
                        <div className="flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0 mx-auto mb-3">
                            <ConfirmationModal
                                confirmationButtonText="Change to Public"
                                confirmationMessage="Are you sure you want this course to be publicly available on the internet?"
                                dialogTitle="Change to Public?"
                                dialogTrigger={
                                    <div className="w-full h-[200px] bg-slate-100 rounded-lg cursor-pointer hover:bg-slate-200 transition-all">
                                        {isClientPublic && (
                                            <div className="bg-green-200 text-green-600 font-bold w-fit my-3 mx-3 absolute text-sm px-3 py-1 rounded-lg">
                                                Active
                                            </div>
                                        )}
                                        <div className="flex flex-col space-y-1 justify-center items-center h-full p-2 sm:p-4">
                                            <Globe className="text-slate-400" size={32} />
                                            <div className="text-xl sm:text-2xl text-slate-700 font-bold">
                                                Public
                                            </div>
                                            <div className="text-gray-400 text-sm sm:text-md tracking-tight w-full sm:w-[500px] leading-5 text-center">
                                                The Course is publicly available on the internet, it is indexed by search engines and can be accessed by anyone
                                            </div>
                                        </div>
                                    </div>
                                }
                                functionToExecute={() => setIsClientPublic(true)}
                                status="info"
                            />
                            <ConfirmationModal
                                confirmationButtonText="Change to Users Only"
                                confirmationMessage="Are you sure you want this course to be only accessible to signed in users?"
                                dialogTitle="Change to Users Only?"
                                dialogTrigger={
                                    <div className="w-full h-[200px] bg-slate-100 rounded-lg cursor-pointer hover:bg-slate-200 transition-all">
                                        {!isClientPublic && (
                                            <div className="bg-green-200 text-green-600 font-bold w-fit my-3 mx-3 absolute text-sm px-3 py-1 rounded-lg">
                                                Active
                                            </div>
                                        )}
                                        <div className="flex flex-col space-y-1 justify-center items-center h-full p-2 sm:p-4">
                                            <Users className="text-slate-400" size={32} />
                                            <div className="text-xl sm:text-2xl text-slate-700 font-bold">
                                                Users Only
                                            </div>
                                            <div className="text-gray-400 text-sm sm:text-md tracking-tight w-full sm:w-[500px] leading-5 text-center">
                                                The Course is only accessible to signed in users, additionally you can choose which UserGroups can access this course
                                            </div>
                                        </div>
                                    </div>
                                }
                                functionToExecute={() => setIsClientPublic(false)}
                                status="info"
                            />
                        </div>
                        {!isClientPublic && <UserGroupsSection usergroups={usergroups} />}
                    </div>
                </div>
            )}
        </div>
    );
}

function UserGroupsSection({ usergroups }: { usergroups: any[] }) {
    const course = useCourse() as any;
    const [userGroupModal, setUserGroupModal] = useState(false);
    const session = useLHSession() as any;
    const access_token = session?.data?.tokens?.access_token;

    const removeUserGroupLink = async (usergroup_id: number) => {
        try {
            const res = await unLinkResourcesToUserGroup(usergroup_id, course.courseStructure.course_uuid, access_token);
            if (res.status === 200) {
                toast.success('Successfully unlinked from usergroup');
                mutate(`${getAPIUrl()}usergroups/resource/${course.courseStructure.course_uuid}`);
            } else {
                toast.error(`Error ${res.status}: ${res.data.detail}`);
            }
        } catch (error) {
            toast.error('An error occurred while unlinking the user group.');
        }
    };

    return (
        <>
            <div className="flex flex-col bg-gray-50 -space-y-1 px-3 sm:px-5 py-3 rounded-md mb-3">
                <h1 className="font-bold text-lg sm:text-xl text-gray-800">UserGroups</h1>
                <h2 className="text-gray-500 text-xs sm:text-sm">
                    You can choose to give access to this course to specific groups of users only by linking it to a UserGroup
                </h2>
            </div>
            <div className="overflow-x-auto">
                <table className="table-auto w-full text-left whitespace-nowrap rounded-md overflow-hidden">
                    <thead className="bg-gray-100 text-gray-500 rounded-xl uppercase">
                        <tr className="font-bolder text-sm">
                            <th className="py-3 px-4">Name</th>
                            <th className="py-3 px-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody className="mt-5 bg-white rounded-md">
                        {usergroups?.map((usergroup: any) => (
                            <tr key={usergroup.invite_code_uuid} className="border-b border-gray-100 text-sm">
                                <td className="py-3 px-4">{usergroup.name}</td>
                                <td className="py-3 px-4">
                                    <ConfirmationModal
                                        confirmationButtonText="Delete Link"
                                        confirmationMessage="Users from this UserGroup will no longer have access to this course"
                                        dialogTitle="Unlink UserGroup?"
                                        dialogTrigger={
                                            <button className="mr-2 flex space-x-2 hover:cursor-pointer p-1 px-3 bg-rose-700 rounded-md font-bold items-center text-sm text-rose-100">
                                                <X className="w-4 h-4" />
                                                <span>Delete link</span>
                                            </button>
                                        }
                                        functionToExecute={() => removeUserGroupLink(usergroup.id)}
                                        status="warning"
                                    />
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
            <div className="flex flex-row-reverse mt-3 mr-2">
                <Modal
                    isDialogOpen={userGroupModal}
                    onOpenChange={() => setUserGroupModal(!userGroupModal)}
                    minHeight="no-min"
                    minWidth="md"
                    dialogContent={<LinkToUserGroup setUserGroupModal={setUserGroupModal} />}
                    dialogTitle="Link Course to a UserGroup"
                    dialogDescription="Choose a UserGroup to link this course to. Users from this UserGroup will have access to this course."
                    dialogTrigger={
                        <button className="flex space-x-2 hover:cursor-pointer p-1 px-3 bg-green-700 rounded-md font-bold items-center text-xs sm:text-sm text-green-100">
                            <SquareUserRound className="w-3 h-3 sm:w-4 sm:h-4" />
                            <span>Link to a UserGroup</span>
                        </button>
                    }
                />
            </div>
        </>
    );
}

export default EditCourseAccess;



================================================
FILE: apps/web/components/Dashboard/Pages/Course/EditCourseCertification/CertificatePreview.tsx
================================================
import React, { useEffect, useState } from 'react';
import { Award, CheckCircle, QrCode, Building, User, Calendar, Hash } from 'lucide-react';
import QRCode from 'qrcode';
import { useOrg } from '@components/Contexts/OrgContext';
import { getOrgLogoMediaDirectory } from '@services/media/media';

interface CertificatePreviewProps {
  certificationName: string;
  certificationDescription: string;
  certificationType: string;
  certificatePattern: string;
  certificateInstructor?: string;
  certificateId?: string;
  awardedDate?: string;
  qrCodeLink?: string;
}

const CertificatePreview: React.FC<CertificatePreviewProps> = ({
  certificationName,
  certificationDescription,
  certificationType,
  certificatePattern,
  certificateInstructor,
  certificateId,
  awardedDate,
  qrCodeLink
}) => {
  const [qrCodeUrl, setQrCodeUrl] = useState<string>('');
  const org = useOrg() as any;

  // Generate QR code
  useEffect(() => {
    const generateQRCode = async () => {
      try {
        const certificateData = qrCodeLink || `${certificateId}`;
        const qrUrl = await QRCode.toDataURL(certificateData, {
          width: 185,
          margin: 1,
          color: {
            dark: '#000000',
            light: '#FFFFFF'
          },
          errorCorrectionLevel: 'M',
          type: 'image/png'
        });
        setQrCodeUrl(qrUrl);
      } catch (error) {
        console.error('Error generating QR code:', error);
      }
    };

    generateQRCode();
  }, [certificateId, qrCodeLink]);
  // Function to get theme colors for each pattern
  const getPatternTheme = (pattern: string) => {
    switch (pattern) {
      case 'royal':
        return {
          primary: 'text-amber-700',
          secondary: 'text-amber-600',
          icon: 'text-amber-600',
          badge: 'bg-amber-50 text-amber-700 border-amber-200'
        };
      case 'tech':
        return {
          primary: 'text-cyan-700',
          secondary: 'text-cyan-600',
          icon: 'text-cyan-600',
          badge: 'bg-cyan-50 text-cyan-700 border-cyan-200'
        };
      case 'nature':
        return {
          primary: 'text-green-700',
          secondary: 'text-green-600',
          icon: 'text-green-600',
          badge: 'bg-green-50 text-green-700 border-green-200'
        };
      case 'geometric':
        return {
          primary: 'text-purple-700',
          secondary: 'text-purple-600',
          icon: 'text-purple-600',
          badge: 'bg-purple-50 text-purple-700 border-purple-200'
        };
      case 'vintage':
        return {
          primary: 'text-orange-700',
          secondary: 'text-orange-600',
          icon: 'text-orange-600',
          badge: 'bg-orange-50 text-orange-700 border-orange-200'
        };
      case 'waves':
        return {
          primary: 'text-blue-700',
          secondary: 'text-blue-600',
          icon: 'text-blue-600',
          badge: 'bg-blue-50 text-blue-700 border-blue-200'
        };
      case 'minimal':
        return {
          primary: 'text-gray-700',
          secondary: 'text-gray-600',
          icon: 'text-gray-600',
          badge: 'bg-gray-50 text-gray-700 border-gray-200'
        };
      case 'professional':
        return {
          primary: 'text-slate-700',
          secondary: 'text-slate-600',
          icon: 'text-slate-600',
          badge: 'bg-slate-50 text-slate-700 border-slate-200'
        };
      case 'academic':
        return {
          primary: 'text-indigo-700',
          secondary: 'text-indigo-600',
          icon: 'text-indigo-600',
          badge: 'bg-indigo-50 text-indigo-700 border-indigo-200'
        };
      case 'modern':
        return {
          primary: 'text-blue-700',
          secondary: 'text-blue-600',
          icon: 'text-blue-600',
          badge: 'bg-blue-50 text-blue-700 border-blue-200'
        };
      default:
        return {
          primary: 'text-gray-700',
          secondary: 'text-gray-600',
          icon: 'text-gray-600',
          badge: 'bg-gray-50 text-gray-700 border-gray-200'
        };
    }
  };

  // Function to render different certificate patterns
  const renderCertificatePattern = (pattern: string) => {
    switch (pattern) {
      case 'royal':
        return (
          <>
            {/* Royal ornate border with crown elements */}
            <div className="absolute inset-3 border-4 border-amber-200 rounded-lg opacity-60"></div>
            <div className="absolute inset-4 border-2 border-amber-300 rounded-md opacity-40"></div>
            
            {/* Crown-like decorations in corners */}
            <div className="absolute top-1 left-1/2 transform -translate-x-1/2">
              <div className="w-8 h-4 bg-amber-200 opacity-50" style={{
                clipPath: 'polygon(0% 100%, 20% 0%, 40% 100%, 60% 0%, 80% 100%, 100% 0%, 100% 100%)'
              }}></div>
            </div>
            <div className="absolute bottom-1 left-1/2 transform -translate-x-1/2 rotate-180">
              <div className="w-8 h-4 bg-amber-200 opacity-50" style={{
                clipPath: 'polygon(0% 100%, 20% 0%, 40% 100%, 60% 0%, 80% 100%, 100% 0%, 100% 100%)'
              }}></div>
            </div>
            
            {/* Royal background pattern */}
            <div className="absolute inset-0 opacity-3">
              <div className="w-full h-full" style={{
                backgroundImage: `radial-gradient(circle at 25% 25%, #f59e0b 2px, transparent 2px), radial-gradient(circle at 75% 75%, #f59e0b 1px, transparent 1px)`,
                backgroundSize: '16px 16px'
              }}></div>
            </div>
          </>
        );
      
      case 'tech':
        return (
          <>
            {/* Tech circuit board borders */}
            <div className="absolute inset-3 border-2 border-cyan-200 opacity-50"></div>
            
            {/* Circuit-like corner elements */}
            <div className="absolute top-3 left-3 w-6 h-6 border-l-2 border-t-2 border-cyan-300 opacity-60"></div>
            <div className="absolute top-3 left-5 w-2 h-2 bg-cyan-300 opacity-60"></div>
            <div className="absolute top-5 left-3 w-2 h-2 bg-cyan-300 opacity-60"></div>
            
            <div className="absolute top-3 right-3 w-6 h-6 border-r-2 border-t-2 border-cyan-300 opacity-60"></div>
            <div className="absolute top-3 right-5 w-2 h-2 bg-cyan-300 opacity-60"></div>
            <div className="absolute top-5 right-3 w-2 h-2 bg-cyan-300 opacity-60"></div>
            
            <div className="absolute bottom-3 left-3 w-6 h-6 border-l-2 border-b-2 border-cyan-300 opacity-60"></div>
            <div className="absolute bottom-3 left-5 w-2 h-2 bg-cyan-300 opacity-60"></div>
            <div className="absolute bottom-5 left-3 w-2 h-2 bg-cyan-300 opacity-60"></div>
            
            <div className="absolute bottom-3 right-3 w-6 h-6 border-r-2 border-b-2 border-cyan-300 opacity-60"></div>
            <div className="absolute bottom-3 right-5 w-2 h-2 bg-cyan-300 opacity-60"></div>
            <div className="absolute bottom-5 right-3 w-2 h-2 bg-cyan-300 opacity-60"></div>
            
            {/* Tech grid background */}
            <div className="absolute inset-0 opacity-4">
              <div className="w-full h-full" style={{
                backgroundImage: `linear-gradient(90deg, #06b6d4 1px, transparent 1px), linear-gradient(0deg, #06b6d4 1px, transparent 1px)`,
                backgroundSize: '8px 8px'
              }}></div>
            </div>
          </>
        );
      
      case 'nature':
        return (
          <>
            {/* Nature organic border */}
            <div className="absolute inset-3 border-2 border-green-200 rounded-2xl opacity-50"></div>
            
            {/* Leaf-like decorations */}
            <div className="absolute top-2 left-2 w-4 h-6 bg-green-200 opacity-50 rounded-full transform rotate-45"></div>
            <div className="absolute top-2 left-4 w-3 h-4 bg-green-300 opacity-40 rounded-full transform rotate-12"></div>
            
            <div className="absolute top-2 right-2 w-4 h-6 bg-green-200 opacity-50 rounded-full transform -rotate-45"></div>
            <div className="absolute top-2 right-4 w-3 h-4 bg-green-300 opacity-40 rounded-full transform -rotate-12"></div>
            
            <div className="absolute bottom-2 left-2 w-4 h-6 bg-green-200 opacity-50 rounded-full transform -rotate-45"></div>
            <div className="absolute bottom-2 left-4 w-3 h-4 bg-green-300 opacity-40 rounded-full transform -rotate-12"></div>
            
            <div className="absolute bottom-2 right-2 w-4 h-6 bg-green-200 opacity-50 rounded-full transform rotate-45"></div>
            <div className="absolute bottom-2 right-4 w-3 h-4 bg-green-300 opacity-40 rounded-full transform rotate-12"></div>
            
            {/* Organic background pattern */}
            <div className="absolute inset-0 opacity-3">
              <div className="w-full h-full" style={{
                backgroundImage: `radial-gradient(ellipse at 30% 30%, #10b981 1px, transparent 1px), radial-gradient(ellipse at 70% 70%, #10b981 0.5px, transparent 0.5px)`,
                backgroundSize: '12px 8px'
              }}></div>
            </div>
          </>
        );
      
      case 'geometric':
        return (
          <>
            {/* Geometric angular borders */}
            <div className="absolute inset-2 border-2 border-purple-200 opacity-50" style={{
              clipPath: 'polygon(0 10px, 10px 0, calc(100% - 10px) 0, 100% 10px, 100% calc(100% - 10px), calc(100% - 10px) 100%, 10px 100%, 0 calc(100% - 10px))'
            }}></div>
            
            {/* Geometric corner elements */}
            <div className="absolute top-1 left-1 w-6 h-6 border-2 border-purple-300 opacity-60 transform rotate-45"></div>
            <div className="absolute top-1 right-1 w-6 h-6 border-2 border-purple-300 opacity-60 transform rotate-45"></div>
            <div className="absolute bottom-1 left-1 w-6 h-6 border-2 border-purple-300 opacity-60 transform rotate-45"></div>
            <div className="absolute bottom-1 right-1 w-6 h-6 border-2 border-purple-300 opacity-60 transform rotate-45"></div>
            
            {/* Abstract geometric shapes */}
            <div className="absolute top-1/4 left-1 w-2 h-8 bg-purple-200 opacity-30 transform rotate-12"></div>
            <div className="absolute top-1/4 right-1 w-2 h-8 bg-purple-200 opacity-30 transform -rotate-12"></div>
            <div className="absolute bottom-1/4 left-1 w-2 h-8 bg-purple-200 opacity-30 transform -rotate-12"></div>
            <div className="absolute bottom-1/4 right-1 w-2 h-8 bg-purple-200 opacity-30 transform rotate-12"></div>
            
            {/* Geometric background */}
            <div className="absolute inset-0 opacity-4">
              <div className="w-full h-full" style={{
                backgroundImage: `linear-gradient(45deg, #8b5cf6 25%, transparent 25%), linear-gradient(-45deg, #8b5cf6 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #8b5cf6 75%), linear-gradient(-45deg, transparent 75%, #8b5cf6 75%)`,
                backgroundSize: '6px 6px'
              }}></div>
            </div>
          </>
        );
      
      case 'vintage':
        return (
          <>
            {/* Art deco style borders */}
            <div className="absolute inset-2 border-2 border-orange-200 opacity-50"></div>
            <div className="absolute inset-3 border border-orange-300 opacity-40"></div>
            
            {/* Art deco corner decorations */}
            <div className="absolute top-2 left-2 w-8 h-8 border-2 border-orange-300 opacity-50" style={{
              clipPath: 'polygon(0 0, 100% 0, 100% 50%, 50% 100%, 0 100%)'
            }}></div>
            <div className="absolute top-2 right-2 w-8 h-8 border-2 border-orange-300 opacity-50" style={{
              clipPath: 'polygon(0 0, 100% 0, 100% 100%, 50% 100%, 0 50%)'
            }}></div>
            <div className="absolute bottom-2 left-2 w-8 h-8 border-2 border-orange-300 opacity-50" style={{
              clipPath: 'polygon(0 0, 50% 0, 100% 50%, 100% 100%, 0 100%)'
            }}></div>
            <div className="absolute bottom-2 right-2 w-8 h-8 border-2 border-orange-300 opacity-50" style={{
              clipPath: 'polygon(0 50%, 50% 0, 100% 0, 100% 100%, 0 100%)'
            }}></div>
            
            {/* Art deco sunburst pattern */}
            <div className="absolute inset-0 opacity-3">
              <div className="w-full h-full" style={{
                backgroundImage: `repeating-conic-gradient(from 0deg at 50% 50%, #f97316 0deg, #f97316 2deg, transparent 2deg, transparent 8deg)`,
                backgroundSize: '100% 100%'
              }}></div>
            </div>
          </>
        );
      
      case 'waves':
        return (
          <>
            {/* Flowing wave borders */}
            <div className="absolute inset-2 border-2 border-blue-200 rounded-3xl opacity-50"></div>
            
            {/* Wave decorations */}
            <div className="absolute top-2 left-0 right-0 h-4 opacity-30" style={{
              background: `radial-gradient(ellipse at center, #3b82f6 30%, transparent 30%)`,
              backgroundSize: '20px 8px'
            }}></div>
            <div className="absolute bottom-2 left-0 right-0 h-4 opacity-30" style={{
              background: `radial-gradient(ellipse at center, #3b82f6 30%, transparent 30%)`,
              backgroundSize: '20px 8px'
            }}></div>
            
            {/* Side wave patterns */}
            <div className="absolute left-2 top-0 bottom-0 w-4 opacity-30" style={{
              background: `radial-gradient(ellipse at center, #3b82f6 30%, transparent 30%)`,
              backgroundSize: '8px 20px'
            }}></div>
            <div className="absolute right-2 top-0 bottom-0 w-4 opacity-30" style={{
              background: `radial-gradient(ellipse at center, #3b82f6 30%, transparent 30%)`,
              backgroundSize: '8px 20px'
            }}></div>
            
            {/* Wave background */}
            <div className="absolute inset-0 opacity-4">
              <div className="w-full h-full" style={{
                backgroundImage: `repeating-linear-gradient(45deg, #3b82f6 0px, #3b82f6 1px, transparent 1px, transparent 8px), repeating-linear-gradient(-45deg, #3b82f6 0px, #3b82f6 1px, transparent 1px, transparent 8px)`,
                backgroundSize: '12px 12px'
              }}></div>
            </div>
          </>
        );
      
      case 'minimal':
        return (
          <>
            {/* Minimal clean border */}
            <div className="absolute inset-6 border border-gray-300 opacity-60"></div>
            
            {/* Subtle corner accents */}
            <div className="absolute top-5 left-5 w-3 h-3 border-l border-t border-gray-400 opacity-40"></div>
            <div className="absolute top-5 right-5 w-3 h-3 border-r border-t border-gray-400 opacity-40"></div>
            <div className="absolute bottom-5 left-5 w-3 h-3 border-l border-b border-gray-400 opacity-40"></div>
            <div className="absolute bottom-5 right-5 w-3 h-3 border-r border-b border-gray-400 opacity-40"></div>
          </>
        );
      
      case 'professional':
        return (
          <>
            {/* Professional double border */}
            <div className="absolute inset-2 border-2 border-slate-300 opacity-50"></div>
            <div className="absolute inset-3 border border-slate-400 opacity-40"></div>
            
            {/* Professional corner brackets */}
            <div className="absolute top-2 left-2 w-6 h-6 border-l-2 border-t-2 border-slate-400 opacity-60"></div>
            <div className="absolute top-2 right-2 w-6 h-6 border-r-2 border-t-2 border-slate-400 opacity-60"></div>
            <div className="absolute bottom-2 left-2 w-6 h-6 border-l-2 border-b-2 border-slate-400 opacity-60"></div>
            <div className="absolute bottom-2 right-2 w-6 h-6 border-r-2 border-b-2 border-slate-400 opacity-60"></div>
            
            {/* Subtle professional background */}
            <div className="absolute inset-0 opacity-2">
              <div className="w-full h-full" style={{
                backgroundImage: `linear-gradient(90deg, #64748b 1px, transparent 1px), linear-gradient(0deg, #64748b 1px, transparent 1px)`,
                backgroundSize: '20px 20px'
              }}></div>
            </div>
          </>
        );
      
      case 'academic':
        return (
          <>
            {/* Academic traditional border */}
            <div className="absolute inset-2 border-3 border-indigo-300 opacity-50"></div>
            <div className="absolute inset-3 border border-indigo-400 opacity-40"></div>
            
            {/* Academic shield-like corners */}
            <div className="absolute top-2 left-2 w-8 h-8 border-2 border-indigo-400 opacity-50 rounded-tl-lg"></div>
            <div className="absolute top-2 right-2 w-8 h-8 border-2 border-indigo-400 opacity-50 rounded-tr-lg"></div>
            <div className="absolute bottom-2 left-2 w-8 h-8 border-2 border-indigo-400 opacity-50 rounded-bl-lg"></div>
            <div className="absolute bottom-2 right-2 w-8 h-8 border-2 border-indigo-400 opacity-50 rounded-br-lg"></div>
            
            {/* Academic laurel-like decorations */}
            <div className="absolute top-1/2 left-1 transform -translate-y-1/2">
              <div className="w-1 h-6 bg-indigo-300 opacity-40 rounded-full"></div>
            </div>
            <div className="absolute top-1/2 right-1 transform -translate-y-1/2">
              <div className="w-1 h-6 bg-indigo-300 opacity-40 rounded-full"></div>
            </div>
            
            {/* Academic background pattern */}
            <div className="absolute inset-0 opacity-3">
              <div className="w-full h-full" style={{
                backgroundImage: `radial-gradient(circle at 50% 50%, #6366f1 1px, transparent 1px)`,
                backgroundSize: '15px 15px'
              }}></div>
            </div>
          </>
        );
      
      case 'modern':
        return (
          <>
            {/* Modern clean asymmetric border */}
            <div className="absolute inset-2 border-2 border-gray-300 opacity-50" style={{
              clipPath: 'polygon(0 0, calc(100% - 12px) 0, 100% 12px, 100% 100%, 12px 100%, 0 calc(100% - 12px))'
            }}></div>
            
            {/* Modern accent lines */}
            <div className="absolute top-2 left-2 w-8 h-0.5 bg-blue-400 opacity-60"></div>
            <div className="absolute top-2 left-2 w-0.5 h-8 bg-blue-400 opacity-60"></div>
            
            <div className="absolute bottom-2 right-2 w-8 h-0.5 bg-blue-400 opacity-60"></div>
            <div className="absolute bottom-2 right-2 w-0.5 h-8 bg-blue-400 opacity-60"></div>
            
            {/* Modern dot accents */}
            <div className="absolute top-4 right-4 w-2 h-2 bg-blue-400 opacity-50 rounded-full"></div>
            <div className="absolute bottom-4 left-4 w-2 h-2 bg-blue-400 opacity-50 rounded-full"></div>
            
            {/* Modern subtle background */}
            <div className="absolute inset-0 opacity-2">
              <div className="w-full h-full" style={{
                backgroundImage: `linear-gradient(135deg, #3b82f6 0%, transparent 1%), linear-gradient(225deg, #3b82f6 0%, transparent 1%)`,
                backgroundSize: '12px 12px'
              }}></div>
            </div>
          </>
        );
      
      default:
        return null;
    }
  };

  const theme = getPatternTheme(certificatePattern);

  return (
    <div className="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-4 w-full h-full">
      <div className="bg-white rounded-lg shadow-sm p-6 relative overflow-hidden w-full h-full flex flex-col">
        {/* Dynamic Certificate Pattern */}
        {renderCertificatePattern(certificatePattern)}

        {/* Certificate ID - Top Left */}
        <div className="absolute top-4 left-4 sm:top-6 sm:left-6 z-20">
          <div className="flex items-center space-x-1">
            <Hash className={`w-3 h-3 sm:w-4 sm:h-4 ${theme.icon}`} />
            <span className={`text-xs sm:text-sm ${theme.secondary} font-medium`}>ID: {certificateId || 'LH-2024-001'}</span>
          </div>
        </div>

        {/* QR Code Box - Top Right */}
        <div className="absolute top-4 right-4 sm:top-6 sm:right-6 z-20">
          <div className={`w-16 h-16 sm:w-24 sm:h-24 border-2 ${theme.secondary.replace('text-', 'border-')} rounded-md bg-white/90 backdrop-blur-sm p-1`}>
            {qrCodeUrl ? (
              <img
                src={qrCodeUrl}
                alt="Certificate QR Code"
                className="w-full h-full object-contain"
              />
            ) : (
              <div className="w-full h-full flex items-center justify-center">
                <QrCode className={`w-8 h-8 sm:w-12 sm:h-12 ${theme.icon}`} />
              </div>
            )}
          </div>
        </div>

        {/* Main Content */}
        <div className="relative z-10 flex-1 flex flex-col items-center justify-center text-center space-y-3 px-6 py-6">
          {/* Header with decorative line */}
          <div className="flex items-center justify-center space-x-2 mb-2">
            <div className={`w-6 sm:w-8 h-px bg-gradient-to-r from-transparent ${theme.secondary.replace('text-', 'to-')}`}></div>
            <div className={`text-xs sm:text-sm ${theme.secondary} font-medium uppercase tracking-wider`}>Certificate</div>
            <div className={`w-6 sm:w-8 h-px bg-gradient-to-l from-transparent ${theme.secondary.replace('text-', 'to-')}`}></div>
          </div>

          {/* Award Icon with decorative elements */}
          <div className="flex justify-center relative">
            <div className={`w-12 h-12 sm:w-16 sm:h-16 bg-gradient-to-br ${theme.icon.replace('text-', 'from-')}-100 ${theme.icon.replace('text-', 'to-')}-200 rounded-full flex items-center justify-center relative`}>
              <Award className={`w-6 h-6 sm:w-8 sm:h-8 ${theme.icon}`} />
              {/* Decorative rays */}
              <div className="absolute inset-0 rounded-full">
                <div className={`absolute top-0 left-1/2 w-px h-2 sm:h-3 ${theme.secondary.replace('text-', 'bg-')} transform -translate-x-1/2 -translate-y-1 opacity-60`}></div>
                <div className={`absolute bottom-0 left-1/2 w-px h-2 sm:h-3 ${theme.secondary.replace('text-', 'bg-')} transform -translate-x-1/2 translate-y-1 opacity-60`}></div>
                <div className={`absolute left-0 top-1/2 w-2 sm:w-3 h-px ${theme.secondary.replace('text-', 'bg-')} transform -translate-y-1/2 -translate-x-1 opacity-60`}></div>
                <div className={`absolute right-0 top-1/2 w-2 sm:w-3 h-px ${theme.secondary.replace('text-', 'bg-')} transform -translate-y-1/2 translate-x-1 opacity-60`}></div>
              </div>
            </div>
          </div>

          {/* Certificate Content */}
          <div className="flex flex-col justify-center items-center flex-1 max-w-full">
            <h4 className={`font-bold text-sm sm:text-base ${theme.primary} mb-2 text-center`}>
              {certificationName || 'Certification Name'}
            </h4>
            <p className={`text-xs sm:text-sm ${theme.secondary} text-center leading-relaxed max-w-xs sm:max-w-sm`}>
              {certificationDescription || 'Certification description will appear here...'}
            </p>
          </div>

          {/* Decorative divider */}
          <div className="flex items-center justify-center space-x-1 py-1">
            <div className={`w-2 h-px ${theme.secondary.replace('text-', 'bg-')} opacity-50`}></div>
            <div className={`w-1 h-1 ${theme.primary.replace('text-', 'bg-')} rounded-full opacity-60`}></div>
            <div className={`w-2 h-px ${theme.secondary.replace('text-', 'bg-')} opacity-50`}></div>
          </div>
          
          {/* Certification Type Badge */}
          <div className={`inline-flex items-center space-x-1 text-xs sm:text-sm ${theme.badge} px-3 py-1 rounded-full border`}>
            <CheckCircle size={12} />
            <span className="font-medium">
              {certificationType === 'completion' ? 'Course Completion' :
               certificationType === 'achievement' ? 'Achievement Based' :
               certificationType === 'assessment' ? 'Assessment Based' :
               certificationType === 'participation' ? 'Participation' :
               certificationType === 'mastery' ? 'Skill Mastery' :
               certificationType === 'professional' ? 'Professional Development' :
               certificationType === 'continuing' ? 'Continuing Education' :
               certificationType === 'workshop' ? 'Workshop Attendance' :
               certificationType === 'specialization' ? 'Specialization' : 'Course Completion'}
            </span>
          </div>
        </div>

        {/* Bottom Section */}
        <div className="relative z-10 mt-auto p-6 pt-8">
          <div className="flex items-end justify-between w-full">
            {/* Left: Teacher/Organization Signature */}
            <div className="flex flex-col items-start space-y-1 flex-1">
              <div className="flex items-center space-x-1">
                <User className={`w-2.5 h-2.5 sm:w-3 sm:h-3 ${theme.icon}`} />
                <span className={`text-xs ${theme.secondary} font-medium`}>Instructor</span>
              </div>
              <div className={`text-xs ${theme.primary} font-semibold`}>
                {certificateInstructor || 'Dr. Jane Smith'}
              </div>
              <div className={`h-px w-10 sm:w-12 ${theme.secondary.replace('text-', 'bg-')} opacity-50`}></div>
            </div>

            {/* Center: Logo */}
            <div className="flex flex-col items-center space-y-1 flex-1">
              <div className={`w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center`}>
                {org?.logo_image ? (
                  <img
                    src={`${getOrgLogoMediaDirectory(org.org_uuid, org?.logo_image)}`}
                    alt="Organization Logo"
                    className="w-full h-full object-contain"
                  />
                ) : (
                  <div className={`w-full h-full ${theme.icon.replace('text-', 'bg-')}-100 rounded-full flex items-center justify-center`}>
                    <Building className={`w-4 h-4 sm:w-5 sm:h-5 ${theme.icon}`} />
                  </div>
                )}
              </div>
              <div className={`text-xs ${theme.secondary} font-medium`}>
                {org?.name || 'LearnHouse'}
              </div>
            </div>

            {/* Right: Award Date */}
            <div className="flex flex-col items-end space-y-1 flex-1">
              <div className="flex items-center space-x-1">
                <Calendar className={`w-2.5 h-2.5 sm:w-3 sm:h-3 ${theme.icon}`} />
                <span className={`text-xs ${theme.secondary} font-medium`}>Awarded</span>
              </div>
              <div className={`text-xs ${theme.primary} font-semibold`}>
                {awardedDate || 'Dec 15, 2024'}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default CertificatePreview; 


================================================
FILE: apps/web/components/Dashboard/Pages/Course/EditCourseCertification/EditCourseCertification.tsx
================================================
import {
  FormField,
  FormLabelAndMessage,
  Input,
  Textarea,
} from '@components/Objects/StyledElements/Form/Form';
import { useFormik } from 'formik';
import { AlertTriangle, Award, FileText, Settings } from 'lucide-react';
import CertificatePreview from './CertificatePreview';
import * as Form from '@radix-ui/react-form';
import React, { useEffect, useState } from 'react';
import { useCourse, useCourseDispatch } from '@components/Contexts/CourseContext';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import { 
  createCertification, 
  deleteCertification 
} from '@services/courses/certifications';
import {
  CustomSelect,
  CustomSelectContent,
  CustomSelectItem,
  CustomSelectTrigger,
  CustomSelectValue,
} from "../EditCourseGeneral/CustomSelect";
import useSWR from 'swr';
import { getAPIUrl } from '@services/config/config';
import toast from 'react-hot-toast';

type EditCourseCertificationProps = {
  orgslug: string
  course_uuid?: string
}

const validate = (values: any) => {
  const errors = {} as any;

  if (values.enable_certification && !values.certification_name) {
    errors.certification_name = 'Required when certification is enabled';
  } else if (values.certification_name && values.certification_name.length > 100) {
    errors.certification_name = 'Must be 100 characters or less';
  }

  if (values.enable_certification && !values.certification_description) {
    errors.certification_description = 'Required when certification is enabled';
  } else if (values.certification_description && values.certification_description.length > 500) {
    errors.certification_description = 'Must be 500 characters or less';
  }

  return errors;
};

function EditCourseCertification(props: EditCourseCertificationProps) {
  const [error, setError] = useState('');
  const [isCreating, setIsCreating] = useState(false);
  const course = useCourse();
  const dispatchCourse = useCourseDispatch() as any;
  const { isLoading, courseStructure } = course as any;
  const session = useLHSession() as any;
  const access_token = session?.data?.tokens?.access_token;

  // Fetch existing certifications
  const { data: certifications, error: certificationsError, mutate: mutateCertifications } = useSWR(
    courseStructure?.course_uuid && access_token ? 
    `certifications/course/${courseStructure.course_uuid}` : null,
    async () => {
      if (!courseStructure?.course_uuid || !access_token) return null;
      const result = await fetch(
        `${getAPIUrl()}certifications/course/${courseStructure.course_uuid}`,
        {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${access_token}`,
          },
          credentials: 'include',
        }
      );
      const response = await result.json();
      

      
      if (result.status === 200) {
        return {
          success: true,
          data: response,
          status: result.status,
          HTTPmessage: result.statusText,
        };
      } else {
        return {
          success: false,
          data: response,
          status: result.status,
          HTTPmessage: result.statusText,
        };
      }
    }
  );

  const existingCertification = certifications?.data?.[0]; // Assuming one certification per course
  const hasExistingCertification = !!existingCertification;



  // Create initial values object
  const getInitialValues = () => {
    // Helper function to get instructor name from authors
    const getInstructorName = () => {
      if (courseStructure?.authors && courseStructure.authors.length > 0) {
        const author = courseStructure.authors[0];
        const firstName = author.first_name || '';
        const lastName = author.last_name || '';
        
        // Only return if at least one name exists
        if (firstName || lastName) {
          return `${firstName} ${lastName}`.trim();
        }
      }
      return '';
    };

    // Use existing certification data if available, otherwise fall back to course data
    const config = existingCertification?.config || {};
    
    return {
      enable_certification: hasExistingCertification,
      certification_name: config.certification_name || courseStructure?.name || '',
      certification_description: config.certification_description || courseStructure?.description || '',
      certification_type: config.certification_type || 'completion',
      certificate_pattern: config.certificate_pattern || 'professional',
      certificate_instructor: config.certificate_instructor || getInstructorName(),
    };
  };

  const formik = useFormik({
    initialValues: getInitialValues(),
    validate,
    onSubmit: async values => {
      // This is no longer used - saving is handled by the main Save button
    },
    enableReinitialize: true,
  }) as any;

  // Handle enabling/disabling certification
  const handleCertificationToggle = async (enabled: boolean) => {
    if (enabled && !hasExistingCertification) {
      // Create new certification
      setIsCreating(true);
      try {
        const config = {
          certification_name: formik.values.certification_name || courseStructure?.name || '',
          certification_description: formik.values.certification_description || courseStructure?.description || '',
          certification_type: formik.values.certification_type || 'completion',
          certificate_pattern: formik.values.certificate_pattern || 'professional',
          certificate_instructor: formik.values.certificate_instructor || '',
        };

        const result = await createCertification(
          courseStructure.id,
          config,
          access_token
        );



        // createCertification uses errorHandling which returns JSON directly on success
        if (result) {
          toast.success('Certification created successfully');
          mutateCertifications();
          formik.setFieldValue('enable_certification', true);
        } else {
          throw new Error('Failed to create certification');
        }
      } catch (e) {
        setError('Failed to create certification.');
        toast.error('Failed to create certification');
        formik.setFieldValue('enable_certification', false);
      } finally {
        setIsCreating(false);
      }
    } else if (!enabled && hasExistingCertification) {
      // Delete existing certification
      try {
        const result = await deleteCertification(
          existingCertification.certification_uuid,
          access_token
        );

        // deleteCertification uses errorHandling which returns JSON directly on success
        if (result) {
          toast.success('Certification removed successfully');
          mutateCertifications();
          formik.setFieldValue('enable_certification', false);
        } else {
          throw new Error('Failed to delete certification');
        }
      } catch (e) {
        setError('Failed to remove certification.');
        toast.error('Failed to remove certification');
        formik.setFieldValue('enable_certification', true);
      }
    } else {
      formik.setFieldValue('enable_certification', enabled);
    }
  };

  // Reset form when certifications data changes
  useEffect(() => {
    if (certifications && !isLoading) {
      const newValues = getInitialValues();
      formik.resetForm({ values: newValues });
    }
  }, [certifications, isLoading]);

  // Handle form changes - update course context with certification data
  useEffect(() => {
    if (!isLoading && hasExistingCertification) {
      const formikValues = formik.values as any;
      const initialValues = formik.initialValues as any;
      const valuesChanged = Object.keys(formikValues).some(
        key => formikValues[key] !== initialValues[key]
      );

      if (valuesChanged) {
        dispatchCourse({ type: 'setIsNotSaved' });
        
        // Store certification data in course context so it gets saved with the main save button
        const updatedCourse = {
          ...courseStructure,
          // Store certification data for the main save functionality
          _certificationData: {
            certification_uuid: existingCertification.certification_uuid,
            config: {
              certification_name: formikValues.certification_name,
              certification_description: formikValues.certification_description,
              certification_type: formikValues.certification_type,
              certificate_pattern: formikValues.certificate_pattern,
              certificate_instructor: formikValues.certificate_instructor,
            }
          }
        };
        dispatchCourse({ type: 'setCourseStructure', payload: updatedCourse });
      }
    }
  }, [formik.values, isLoading, hasExistingCertification, existingCertification]);

  if (isLoading || !courseStructure || (courseStructure.course_uuid && access_token && certifications === undefined)) {
    return <div>Loading...</div>;
  }

  if (certificationsError) {
    return <div>Error loading certifications</div>;
  }

  return (
    <div>
      {courseStructure && (
        <div>
          <div className="h-6"></div>
          <div className="mx-4 sm:mx-10 bg-white rounded-xl shadow-xs px-4 py-4">
            {/* Header Section */}
            <div className="flex items-center justify-between bg-gray-50 px-3 sm:px-5 py-3 rounded-md mb-3">
              <div className="flex flex-col -space-y-1">
                <h1 className="font-bold text-lg sm:text-xl text-gray-800">Course Certification</h1>
                <h2 className="text-gray-500 text-xs sm:text-sm">
                  Enable and configure certificates for students who complete this course
                </h2>
              </div>
              <div className="flex items-center space-x-3">
                <label className="relative inline-flex items-center cursor-pointer">
                  <input
                    type="checkbox"
                    className="sr-only peer"
                    checked={formik.values.enable_certification}
                    onChange={(e) => handleCertificationToggle(e.target.checked)}
                    disabled={isCreating}
                  />
                  <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
                {isCreating && (
                  <div className="animate-spin">
                    <Settings size={16} />
                  </div>
                )}
              </div>
            </div>

            {error && (
              <div className="flex justify-center bg-red-200 rounded-md text-red-950 space-x-2 items-center p-4 mb-6 transition-all shadow-xs">
                <AlertTriangle size={18} />
                <div className="font-bold text-sm">{error}</div>
              </div>
            )}

            {/* Certification Configuration - Only show if enabled and has existing certification */}
            {formik.values.enable_certification && hasExistingCertification && (
              <div className="grid grid-cols-1 lg:grid-cols-5 gap-6">
                {/* Form Section */}
                <div className="lg:col-span-3">
                  <Form.Root className="space-y-6">
                    {/* Basic Information Section */}
                    <div className="flex flex-col bg-gray-50 -space-y-1 px-3 sm:px-5 py-3 rounded-md mb-3">
                      <h3 className="font-bold text-md text-gray-800 flex items-center gap-2">
                        <FileText size={16} />
                        Basic Information
                      </h3>
                      <p className="text-gray-500 text-xs sm:text-sm">
                        Configure the basic details of your certification
                      </p>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {/* Certification Name */}
                      <FormField name="certification_name">
                        <FormLabelAndMessage 
                          label="Certification Name" 
                          message={formik.errors.certification_name} 
                        />
                        <Form.Control asChild>
                          <Input
                            style={{ backgroundColor: 'white' }}
                            onChange={formik.handleChange}
                            value={formik.values.certification_name}
                            type="text"
                            placeholder="e.g., Advanced JavaScript Certification"
                            required
                          />
                        </Form.Control>
                      </FormField>

                      {/* Certification Type */}
                      <FormField name="certification_type">
                        <FormLabelAndMessage label="Certification Type" />
                        <Form.Control asChild>
                          <CustomSelect
                            value={formik.values.certification_type}
                            onValueChange={(value) => {
                              if (!value) return;
                              formik.setFieldValue('certification_type', value);
                            }}
                          >
                            <CustomSelectTrigger className="w-full bg-white">
                              <CustomSelectValue>
                                {formik.values.certification_type === 'completion' ? 'Course Completion' :
                                 formik.values.certification_type === 'achievement' ? 'Achievement Based' :
                                 formik.values.certification_type === 'assessment' ? 'Assessment Based' :
                                 formik.values.certification_type === 'participation' ? 'Participation' :
                                 formik.values.certification_type === 'mastery' ? 'Skill Mastery' :
                                 formik.values.certification_type === 'professional' ? 'Professional Development' :
                                 formik.values.certification_type === 'continuing' ? 'Continuing Education' :
                                 formik.values.certification_type === 'workshop' ? 'Workshop Attendance' :
                                 formik.values.certification_type === 'specialization' ? 'Specialization' : 'Course Completion'}
                              </CustomSelectValue>
                            </CustomSelectTrigger>
                            <CustomSelectContent>
                              <CustomSelectItem value="completion">Course Completion</CustomSelectItem>
                              <CustomSelectItem value="achievement">Achievement Based</CustomSelectItem>
                              <CustomSelectItem value="assessment">Assessment Based</CustomSelectItem>
                              <CustomSelectItem value="participation">Participation</CustomSelectItem>
                              <CustomSelectItem value="mastery">Skill Mastery</CustomSelectItem>
                              <CustomSelectItem value="professional">Professional Development</CustomSelectItem>
                              <CustomSelectItem value="continuing">Continuing Education</CustomSelectItem>
                              <CustomSelectItem value="workshop">Workshop Attendance</CustomSelectItem>
                              <CustomSelectItem value="specialization">Specialization</CustomSelectItem>
                            </CustomSelectContent>
                          </CustomSelect>
                        </Form.Control>
                      </FormField>
                    </div>

                    {/* Certification Description */}
                    <FormField name="certification_description">
                      <FormLabelAndMessage 
                        label="Certification Description" 
                        message={formik.errors.certification_description} 
                      />
                      <Form.Control asChild>
                        <Textarea
                          style={{ backgroundColor: 'white', height: '120px', minHeight: '120px' }}
                          onChange={formik.handleChange}
                          value={formik.values.certification_description}
                          placeholder="Describe what this certification represents and its value..."
                          required
                        />
                      </Form.Control>
                    </FormField>

                    {/* Certificate Design Section */}
                    <div className="flex flex-col bg-gray-50 -space-y-1 px-3 sm:px-5 py-3 rounded-md mb-3">
                      <h3 className="font-bold text-md text-gray-800 flex items-center gap-2">
                        <Award size={16} />
                        Certificate Design
                      </h3>
                      <p className="text-gray-500 text-xs sm:text-sm">
                        Choose a decorative pattern for your certificate
                      </p>
                    </div>

                    {/* Pattern Selection */}
                    <FormField name="certificate_pattern">
                      <FormLabelAndMessage label="Certificate Pattern" />
                      <Form.Control asChild>
                        <div className="grid grid-cols-2 lg:grid-cols-5 gap-3">
                          {[
                            { value: 'royal', name: 'Royal', description: 'Ornate with crown motifs' },
                            { value: 'tech', name: 'Tech', description: 'Circuit-inspired patterns' },
                            { value: 'nature', name: 'Nature', description: 'Organic leaf patterns' },
                            { value: 'geometric', name: 'Geometric', description: 'Abstract shapes & lines' },
                            { value: 'vintage', name: 'Vintage', description: 'Art deco styling' },
                            { value: 'waves', name: 'Waves', description: 'Flowing water patterns' },
                            { value: 'minimal', name: 'Minimal', description: 'Clean and simple' },
                            { value: 'professional', name: 'Professional', description: 'Business-ready design' },
                            { value: 'academic', name: 'Academic', description: 'Traditional university style' },
                            { value: 'modern', name: 'Modern', description: 'Contemporary clean lines' }
                          ].map((pattern) => (
                            <div
                              key={pattern.value}
                              className={`p-3 border-2 rounded-lg cursor-pointer transition-all ${
                                formik.values.certificate_pattern === pattern.value
                                  ? 'border-blue-500 bg-blue-50'
                                  : 'border-gray-200 hover:border-gray-300'
                              }`}
                              onClick={() => formik.setFieldValue('certificate_pattern', pattern.value)}
                            >
                              <div className="text-center">
                                <div className="text-sm font-medium text-gray-900">{pattern.name}</div>
                                <div className="text-xs text-gray-500 mt-1">{pattern.description}</div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </Form.Control>
                    </FormField>

                    {/* Custom Instructor */}
                    <FormField name="certificate_instructor">
                      <FormLabelAndMessage label="Instructor Name (Optional)" />
                      <Form.Control asChild>
                        <Input
                          style={{ backgroundColor: 'white' }}
                          onChange={formik.handleChange}
                          value={formik.values.certificate_instructor}
                          type="text"
                          placeholder="e.g., Dr. Jane Smith"
                        />
                      </Form.Control>
                    </FormField>
                  </Form.Root>
                </div>

                {/* Preview Section */}
                <div className="lg:col-span-2">
                  <div className="bg-white rounded-xl shadow-xs border border-gray-200 sticky top-6 min-h-[320px]">
                    <div className="flex flex-col bg-gray-50 -space-y-1 px-3 sm:px-5 py-3 rounded-t-xl mb-3">
                      <h3 className="font-bold text-md text-gray-800 flex items-center gap-2">
                        <Award size={16} />
                        Certificate Preview
                      </h3>
                      <p className="text-gray-500 text-xs sm:text-sm">
                        Live preview of your certificate
                      </p>
                    </div>
                    
                    <div className="p-4">
                      <CertificatePreview
                        certificationName={formik.values.certification_name}
                        certificationDescription={formik.values.certification_description}
                        certificationType={formik.values.certification_type}
                        certificatePattern={formik.values.certificate_pattern}
                        certificateInstructor={formik.values.certificate_instructor}
                      />
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Disabled State */}
            {!formik.values.enable_certification && (
              <div className="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center">
                <Award className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                <h3 className="font-medium text-gray-700 mb-2">No Certification Configured</h3>
                <p className="text-sm text-gray-500 mb-4">
                  Enable certification to provide students with certificates upon course completion.
                </p>
                <button
                  type="button"
                  onClick={() => handleCertificationToggle(true)}
                  disabled={isCreating}
                  className="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <Award size={16} />
                  {isCreating ? 'Creating...' : 'Enable Certification'}
                </button>
              </div>
            )}

            {/* Creating State - when toggle is on but no certification exists yet */}
            {formik.values.enable_certification && !hasExistingCertification && isCreating && (
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-8 text-center">
                <div className="animate-spin mx-auto mb-4">
                  <Settings className="w-16 h-16 text-blue-500" />
                </div>
                <h3 className="font-medium text-blue-700 mb-2">Creating Certification...</h3>
                <p className="text-sm text-blue-600">
                  Please wait while we set up your course certification.
                </p>
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
}

export default EditCourseCertification; 


================================================
FILE: apps/web/components/Dashboard/Pages/Course/EditCourseContributors/EditCourseContributors.tsx
================================================
import { useCourse, useCourseDispatch } from '@components/Contexts/CourseContext'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { useOrg } from '@components/Contexts/OrgContext'
import ConfirmationModal from '@components/Objects/StyledElements/ConfirmationModal/ConfirmationModal'
import { getAPIUrl } from '@services/config/config'
import { bulkAddContributors, bulkRemoveContributors, editContributor } from '@services/courses/courses'
import { searchOrgContent } from '@services/search/search'
import { swrFetcher } from '@services/utils/ts/requests'
import { Check, ChevronDown, Search, UserPen, Users } from 'lucide-react'
import React, { useEffect, useState } from 'react'
import toast from 'react-hot-toast'
import useSWR, { mutate } from 'swr'
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
} from "@/components/ui/table"
import { Button } from "@/components/ui/button"
import UserAvatar from '@components/Objects/UserAvatar'
import { Input } from '@/components/ui/input'
import { useDebounce } from '@/hooks/useDebounce'
import { getUserAvatarMediaDirectory } from '@services/media/media'

type EditCourseContributorsProps = {
    orgslug: string
    course_uuid?: string
}

type ContributorRole = 'CREATOR' | 'CONTRIBUTOR' | 'MAINTAINER' | 'REPORTER'
type ContributorStatus = 'ACTIVE' | 'INACTIVE' | 'PENDING'

interface SearchUser {
    username: string;
    first_name: string;
    last_name: string;
    email: string;
    avatar_image: string;
    avatar_url?: string;
    id: number;
    user_uuid: string;
}

interface Contributor {
    id: string;
    user_id: string;
    authorship: ContributorRole;
    authorship_status: ContributorStatus;
    creation_date: string;
    user: {
        username: string;
        first_name: string;
        last_name: string;
        email: string;
        avatar_image: string;
        user_uuid: string;
    }
}

interface BulkAddResponse {
    successful: string[];
    failed: {
        username: string;
        reason: string;
    }[];
}

// Helper function for date formatting
const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
};

function EditCourseContributors(props: EditCourseContributorsProps) {
    const session = useLHSession() as any;
    const access_token = session?.data?.tokens?.access_token;
    const course = useCourse() as any;
    const { isLoading, courseStructure } = course as any;
    const dispatchCourse = useCourseDispatch() as any;
    const org = useOrg() as any;

    const { data: contributors } = useSWR<Contributor[]>(
        courseStructure ? `${getAPIUrl()}courses/${courseStructure.course_uuid}/contributors` : null,
        (url: string) => swrFetcher(url, access_token)
    );

    const [isOpenToContributors, setIsOpenToContributors] = useState<boolean | undefined>(undefined);
    const [searchQuery, setSearchQuery] = useState('');
    const [searchResults, setSearchResults] = useState<SearchUser[]>([]);
    const [selectedUsers, setSelectedUsers] = useState<string[]>([]);
    const [isSearching, setIsSearching] = useState(false);
    const debouncedSearch = useDebounce(searchQuery, 300);
    const [selectedContributors, setSelectedContributors] = useState<string[]>([]);
    const [masterCheckboxChecked, setMasterCheckboxChecked] = useState(false);

    useEffect(() => {
        if (!isLoading && courseStructure?.open_to_contributors !== undefined) {
            setIsOpenToContributors(courseStructure.open_to_contributors);
        }
    }, [isLoading, courseStructure]);

    useEffect(() => {
        if (!isLoading && courseStructure?.open_to_contributors !== undefined && isOpenToContributors !== undefined) {
            if (isOpenToContributors !== courseStructure.open_to_contributors) {
                dispatchCourse({ type: 'setIsNotSaved' });
                const updatedCourse = {
                    ...courseStructure,
                    open_to_contributors: isOpenToContributors,
                };
                dispatchCourse({ type: 'setCourseStructure', payload: updatedCourse });
            }
        }
    }, [isLoading, isOpenToContributors, courseStructure, dispatchCourse]);

    useEffect(() => {
        const searchUsers = async () => {
            if (debouncedSearch.trim().length === 0) {
                setSearchResults([]);
                setIsSearching(false);
                return;
            }

            setIsSearching(true);
            try {
                const response = await searchOrgContent(
                    org?.slug,
                    debouncedSearch,
                    1,
                    5,
                    null,
                    access_token
                );

                if (response.success && response.data?.users) {
                    const users = response.data.users.map((user: SearchUser) => ({
                        ...user,
                        avatar_url: user.avatar_image ? getUserAvatarMediaDirectory(user.user_uuid, user.avatar_image) : ''
                    }));
                    setSearchResults(users);
                } else {
                    setSearchResults([]);
                }
            } catch (error) {
                console.error('Error searching users:', error);
                setSearchResults([]);
            }
            setIsSearching(false);
        };

        if (org?.slug && access_token) {
            searchUsers();
        }
    }, [debouncedSearch, org?.slug, access_token]);

    useEffect(() => {
        if (contributors) {
            const nonCreatorContributors = contributors.filter(c => c.authorship !== 'CREATOR');
            setMasterCheckboxChecked(
                nonCreatorContributors.length > 0 && 
                selectedContributors.length === nonCreatorContributors.length
            );
        }
    }, [contributors, selectedContributors]);

    const handleUserSelect = (username: string) => {
        setSelectedUsers(prev => {
            if (prev.includes(username)) {
                return prev.filter(u => u !== username);
            }
            return [...prev, username];
        });
    };

    const handleAddContributors = async () => {
        if (selectedUsers.length === 0) return;

        try {
            const response = await bulkAddContributors(courseStructure.course_uuid, selectedUsers, access_token);
            if (response.status === 200) {
                const result = response.data as BulkAddResponse;
                
                // Show success message for successful adds
                if (result.successful.length > 0) {
                    toast.success(`Successfully added ${result.successful.length} contributor(s)`);
                }
                
                // Show error messages for failed adds
                result.failed.forEach(failure => {
                    toast.error(`Failed to add ${failure.username}: ${failure.reason}`);
                });

                // Refresh contributors list
                mutate(`${getAPIUrl()}courses/${courseStructure.course_uuid}/contributors`);
                // Clear selection and search
                setSelectedUsers([]);
                setSearchQuery('');
            }
        } catch (error) {
            console.error('Error adding contributors:', error);
            toast.error('Failed to add contributors');
        }
    };

    const updateContributor = async (contributorId: string, data: { authorship?: ContributorRole; authorship_status?: ContributorStatus }) => {
        try {
            // Find the current contributor to get their current values
            const currentContributor = contributors?.find(c => c.user_id === contributorId);
            if (!currentContributor) return;

            // Don't allow editing if the user is a CREATOR
            if (currentContributor.authorship === 'CREATOR') {
                toast.error('Cannot modify a creator\'s role or status');
                return;
            }

            // Always send both values in the request
            const updatedData = {
                authorship: data.authorship || currentContributor.authorship,
                authorship_status: data.authorship_status || currentContributor.authorship_status
            };

            const res = await editContributor(courseStructure.course_uuid, contributorId, updatedData.authorship, updatedData.authorship_status, access_token);
            if (res.status === 200 && res.data?.status === 'success') {
                toast.success(res.data.detail || 'Successfully updated contributor');
                mutate(`${getAPIUrl()}courses/${courseStructure.course_uuid}/contributors`);
            } else {
                toast.error(`Error: ${res.data?.detail || 'Failed to update contributor'}`);
            }
        } catch (error) {
            toast.error('An error occurred while updating the contributor.');
        }
    };

    const RoleDropdown = ({ contributor }: { contributor: Contributor }) => (
        <DropdownMenu>
            <DropdownMenuTrigger asChild>
                <Button
                    variant="outline"
                    className="w-[200px] justify-between"
                    disabled={contributor.authorship === 'CREATOR'}
                >
                    {contributor.authorship}
                    <ChevronDown className="ml-2 h-4 w-4 text-muted-foreground" />
                </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end" className="w-[200px]">
                {['CONTRIBUTOR', 'MAINTAINER', 'REPORTER'].map((role) => (
                    <DropdownMenuItem
                        key={role}
                        onClick={() => updateContributor(contributor.user_id, { authorship: role as ContributorRole })}
                        className="justify-between"
                    >
                        {role}
                        {contributor.authorship === role && <Check className="ml-2 h-4 w-4" />}
                    </DropdownMenuItem>
                ))}
            </DropdownMenuContent>
        </DropdownMenu>
    );

    const StatusDropdown = ({ contributor }: { contributor: Contributor }) => (
        <DropdownMenu>
            <DropdownMenuTrigger asChild>
                <Button
                    variant="outline"
                    className={`w-[200px] justify-between ${getStatusStyle(contributor.authorship_status)}`}
                    disabled={contributor.authorship === 'CREATOR'}
                >
                    {contributor.authorship_status}
                    <ChevronDown className="ml-2 h-4 w-4" />
                </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end" className="w-[200px]">
                {['ACTIVE', 'INACTIVE', 'PENDING'].map((status) => (
                    <DropdownMenuItem
                        key={status}
                        onClick={() => updateContributor(contributor.user_id, { authorship_status: status as ContributorStatus })}
                        className="justify-between"
                    >
                        {status}
                        {contributor.authorship_status === status && <Check className="ml-2 h-4 w-4" />}
                    </DropdownMenuItem>
                ))}
            </DropdownMenuContent>
        </DropdownMenu>
    );

    const getStatusStyle = (status: ContributorStatus) => {
        switch (status) {
            case 'ACTIVE':
                return 'bg-green-50 text-green-700 hover:bg-green-100 hover:text-green-800';
            case 'INACTIVE':
                return 'bg-gray-50 text-gray-700 hover:bg-gray-100 hover:text-gray-800';
            case 'PENDING':
                return 'bg-yellow-50 text-yellow-700 hover:bg-yellow-100 hover:text-yellow-800';
            default:
                return 'bg-gray-50 text-gray-700 hover:bg-gray-100 hover:text-gray-800';
        }
    };

    const sortContributors = (contributors: Contributor[] | undefined) => {
        if (!contributors) return [];
        
        // Find the creator and other contributors
        const creator = contributors.find(c => c.authorship === 'CREATOR');
        const otherContributors = contributors.filter(c => c.authorship !== 'CREATOR');
        
        // Return array with creator at the top, followed by other contributors in their original order
        return creator ? [creator, ...otherContributors] : otherContributors;
    };

    const handleContributorSelect = (userId: string) => {
        setSelectedContributors(prev => {
            if (prev.includes(userId)) {
                return prev.filter(id => id !== userId);
            }
            return [...prev, userId];
        });
    };

    const handleBulkRemove = async () => {
        if (selectedContributors.length === 0) return;

        try {
            // Get the usernames from the selected contributors
            const selectedUsernames = contributors
                ?.filter(c => selectedContributors.includes(c.user_id))
                .map(c => c.user.username) || [];

            console.log('Sending usernames:', selectedUsernames); // Debug log

            const response = await bulkRemoveContributors(
                courseStructure.course_uuid, 
                selectedUsernames, // Send as raw array, not stringified
                access_token
            );
            
            if (response.status === 200) {
                toast.success(`Successfully removed ${selectedContributors.length} contributor(s)`);
                // Refresh contributors list
                mutate(`${getAPIUrl()}courses/${courseStructure.course_uuid}/contributors`);
                // Clear selection
                setSelectedContributors([]);
            }
        } catch (error) {
            console.error('Error removing contributors:', error);
            toast.error('Failed to remove contributors');
        }
    };

    return (
        <div>
            {courseStructure && (
                <div>
                    <div className="h-6"></div>
                    <div className="mx-4 sm:mx-10 bg-white rounded-xl shadow-xs px-4 py-4">
                        <div className="flex flex-col bg-gray-50 -space-y-1 px-3 sm:px-5 py-3 rounded-md mb-3">
                            <h1 className="font-bold text-lg sm:text-xl text-gray-800">Course Contributors</h1>
                            <h2 className="text-gray-500 text-xs sm:text-sm">
                                Manage contributors and add new ones to your course
                            </h2>
                        </div>
                        <div className="flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0 mx-auto mb-3">
                            <ConfirmationModal
                                confirmationButtonText="Open to Contributors"
                                confirmationMessage="Are you sure you want to open this course to contributors?"
                                dialogTitle="Open to Contributors?"
                                dialogTrigger={
                                    <div className="w-full h-[200px] bg-slate-100 rounded-lg cursor-pointer hover:bg-slate-200 transition-all">
                                        {isOpenToContributors && (
                                            <div className="bg-green-200 text-green-600 font-bold w-fit my-3 mx-3 absolute text-sm px-3 py-1 rounded-lg">
                                                Active
                                            </div>
                                        )}
                                        <div className="flex flex-col space-y-1 justify-center items-center h-full p-2 sm:p-4">
                                            <UserPen className="text-slate-400" size={32} />
                                            <div className="text-xl sm:text-2xl text-slate-700 font-bold">
                                                Open to Contributors
                                            </div>
                                            <div className="text-gray-400 text-sm sm:text-md tracking-tight w-full sm:w-[500px] leading-5 text-center">
                                                The course is open for contributors. Users can apply to become contributors and help improve the course content.
                                            </div>
                                        </div>
                                    </div>
                                }
                                functionToExecute={() => setIsOpenToContributors(true)}
                                status="info"
                            />
                            <ConfirmationModal
                                confirmationButtonText="Close to Contributors"
                                confirmationMessage="Are you sure you want to close this course to contributors?"
                                dialogTitle="Close to Contributors?"
                                dialogTrigger={
                                    <div className="w-full h-[200px] bg-slate-100 rounded-lg cursor-pointer hover:bg-slate-200 transition-all">
                                        {!isOpenToContributors && (
                                            <div className="bg-green-200 text-green-600 font-bold w-fit my-3 mx-3 absolute text-sm px-3 py-1 rounded-lg">
                                                Active
                                            </div>
                                        )}
                                        <div className="flex flex-col space-y-1 justify-center items-center h-full p-2 sm:p-4">
                                            <Users className="text-slate-400" size={32} />
                                            <div className="text-xl sm:text-2xl text-slate-700 font-bold">
                                                Closed to Contributors
                                            </div>
                                            <div className="text-gray-400 text-sm sm:text-md tracking-tight w-full sm:w-[500px] leading-5 text-center">
                                                The course is closed for contributors. Only existing contributors can modify the course content.
                                            </div>
                                        </div>
                                    </div>
                                }
                                functionToExecute={() => setIsOpenToContributors(false)}
                                status="info"
                            />
                        </div>
                        <div className="space-y-4">
                            <div className="relative">
                                <Search className="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground" />
                                <Input
                                    placeholder="Search users by name or username to add as contributors..."
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    className="pl-8"
                                />
                            </div>
                            {searchQuery && (
                                <div className="bg-white rounded-xl nice-shadow divide-y">
                                    {isSearching ? (
                                        <div className="p-4 text-center text-sm text-gray-500">
                                            Searching...
                                        </div>
                                    ) : searchResults && searchResults.length > 0 ? (
                                        <>
                                            {selectedUsers.length > 0 && (
                                                <div className="p-3 bg-gray-100">
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">
                                                            {selectedUsers.length} user{selectedUsers.length > 1 ? 's' : ''} selected
                                                        </span>
                                                        <div className="flex gap-2">
                                                            <Button
                                                                onClick={() => setSelectedUsers([])}
                                                                variant="outline"
                                                                className="text-sm"
                                                            >
                                                                Clear
                                                            </Button>
                                                            <Button
                                                                onClick={handleAddContributors}
                                                                className="bg-gray-900 text-white hover:bg-gray-800 text-sm"
                                                            >
                                                                Add Selected
                                                            </Button>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                            {searchResults.map((user) => {
                                                const isSelected = selectedUsers.includes(user.username);
                                                const isExistingContributor = contributors?.some(
                                                    c => c.user.username === user.username
                                                );

                                                return (
                                                    <div
                                                        key={user.username}
                                                        className={`flex items-center justify-between p-4 ${
                                                            isSelected ? 'bg-gray-100' : ''
                                                        } ${!isExistingContributor ? 'cursor-pointer hover:bg-gray-50' : ''} transition-colors`}
                                                        onClick={(e) => {
                                                            // Don't handle click if it's on a checkbox
                                                            if (e.target instanceof HTMLElement && e.target.closest('input[type="checkbox"]')) {
                                                                return;
                                                            }
                                                            if (!isExistingContributor) {
                                                                handleUserSelect(user.username);
                                                            }
                                                        }}
                                                    >
                                                        <div className="flex items-center space-x-3">
                                                            <div onClick={(e) => e.stopPropagation()}>
                                                                <input
                                                                    type="checkbox"
                                                                    checked={isSelected || false}
                                                                    onChange={() => !isExistingContributor && handleUserSelect(user.username)}
                                                                    disabled={isExistingContributor}
                                                                    className="h-4 w-4 rounded border-gray-300 text-gray-600 focus:ring-gray-500 disabled:opacity-50"
                                                                />
                                                            </div>
                                                            <UserAvatar
                                                                width={40}
                                                                avatar_url={user.avatar_url}
                                                                predefined_avatar={user.avatar_image ? undefined : 'empty'}
                                                                userId={user.id.toString()}
                                                                showProfilePopup
                                                                rounded="rounded-full"
                                                                backgroundColor="bg-gray-100"
                                                            />
                                                            <div>
                                                                <div className="font-medium text-gray-900">
                                                                    {user.first_name} {user.last_name}
                                                                </div>
                                                                <div className="text-sm text-gray-500">
                                                                    @{user.username}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {isExistingContributor && (
                                                            <span className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">
                                                                Already a contributor
                                                            </span>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </>
                                    ) : (
                                        <div className="p-4 text-center text-sm text-gray-500">
                                            No users found
                                        </div>
                                    )}
                                </div>
                            )}
                            <div className="bg-white rounded-xl nice-shadow">
                                {selectedContributors.length > 0 && (
                                    <div className="p-3 bg-gray-100 rounded-t-xl border-b">
                                        <div className="flex items-center justify-between">
                                            <span className="text-sm text-gray-700">
                                                {selectedContributors.length} contributor{selectedContributors.length > 1 ? 's' : ''} selected
                                            </span>
                                            <div className="flex gap-2">
                                                <Button
                                                    onClick={() => setSelectedContributors([])}
                                                    variant="outline"
                                                    className="text-sm"
                                                >
                                                    Clear
                                                </Button>
                                                <Button
                                                    onClick={handleBulkRemove}
                                                    className="bg-red-600 text-white hover:bg-red-700 text-sm"
                                                >
                                                    Remove Selected
                                                </Button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                <div className="max-h-[600px] overflow-y-auto">
                                    <Table>
                                        <TableHeader>
                                            <TableRow>
                                                <TableHead className="w-[30px]">
                                                    <input
                                                        type="checkbox"
                                                        checked={masterCheckboxChecked}
                                                        onChange={(e) => {
                                                            setMasterCheckboxChecked(e.target.checked);
                                                            if (contributors) {
                                                                if (e.target.checked) {
                                                                    // Select all non-creator contributors
                                                                    const nonCreatorContributors = contributors
                                                                        .filter(c => c.authorship !== 'CREATOR')
                                                                        .map(c => c.user_id);
                                                                    setSelectedContributors(nonCreatorContributors);
                                                                } else {
                                                                    setSelectedContributors([]);
                                                                }
                                                            }
                                                        }}
                                                        className="h-4 w-4 rounded border-gray-300 text-gray-600 focus:ring-gray-500"
                                                    />
                                                </TableHead>
                                                <TableHead className="w-[50px]"></TableHead>
                                                <TableHead>Name</TableHead>
                                                <TableHead>Username</TableHead>
                                                <TableHead>Email</TableHead>
                                                <TableHead>Role</TableHead>
                                                <TableHead>Status</TableHead>
                                                <TableHead>Added On</TableHead>
                                            </TableRow>
                                        </TableHeader>
                                        <TableBody>
                                            {sortContributors(contributors)?.map((contributor) => (
                                                <TableRow 
                                                    key={`${contributor.user_id}-${contributor.id}`}
                                                    className={`${selectedContributors.includes(contributor.user_id) ? 'bg-gray-50' : ''} ${contributor.authorship !== 'CREATOR' ? 'cursor-pointer hover:bg-gray-50' : ''}`}
                                                    onClick={(e) => {
                                                        // Don't handle click if it's on a dropdown or checkbox
                                                        if (
                                                            e.target instanceof HTMLElement && 
                                                            (e.target.closest('button') || 
                                                             e.target.closest('input[type="checkbox"]'))
                                                        ) {
                                                            return;
                                                        }
                                                        if (contributor.authorship !== 'CREATOR') {
                                                            handleContributorSelect(contributor.user_id);
                                                        }
                                                    }}
                                                >
                                                    <TableCell onClick={(e) => e.stopPropagation()}>
                                                        <input
                                                            type="checkbox"
                                                            checked={selectedContributors.includes(contributor.user_id)}
                                                            onChange={() => handleContributorSelect(contributor.user_id)}
                                                            disabled={contributor.authorship === 'CREATOR'}
                                                            className="h-4 w-4 rounded border-gray-300 text-gray-600 focus:ring-gray-500 disabled:opacity-50"
                                                        />
                                                    </TableCell>
                                                    <TableCell>
                                                        <UserAvatar
                                                            width={30}
                                                            border='border-2'
                                                            avatar_url={contributor.user.avatar_image ? getUserAvatarMediaDirectory(contributor.user.user_uuid, contributor.user.avatar_image) : ''}
                                                            rounded="rounded"
                                                            predefined_avatar={contributor.user.avatar_image === '' ? 'empty' : undefined}
                                                        />
                                                    </TableCell>
                                                    <TableCell className="font-medium">
                                                        {contributor.user.first_name} {contributor.user.last_name}
                                                    </TableCell>
                                                    <TableCell className="text-gray-500">
                                                        @{contributor.user.username}
                                                    </TableCell>
                                                    <TableCell className="text-gray-500">
                                                        {contributor.user.email}
                                                    </TableCell>
                                                    <TableCell>
                                                        <RoleDropdown contributor={contributor} />
                                                    </TableCell>
                                                    <TableCell>
                                                        <StatusDropdown contributor={contributor} />
                                                    </TableCell>
                                                    <TableCell className="text-gray-500 text-sm">
                                                        {formatDate(contributor.creation_date)}
                                                    </TableCell>
                                                </TableRow>
                                            ))}
                                        </TableBody>
                                    </Table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

export default EditCourseContributors;


================================================
FILE: apps/web/components/Dashboard/Pages/Course/EditCourseGeneral/CustomSelect.tsx
================================================
import React, { useState, useEffect } from 'react';
import { ChevronDown } from 'lucide-react';

interface CustomSelectProps {
  value: string;
  onValueChange: (value: string) => void;
  placeholder?: string;
  className?: string;
  disabled?: boolean;
  children: React.ReactNode;
}

interface CustomSelectItemProps {
  value: string;
  children: React.ReactNode;
  className?: string;
}

interface CustomSelectTriggerProps {
  children: React.ReactNode;
  className?: string;
  disabled?: boolean;
}

interface CustomSelectContentProps {
  children: React.ReactNode;
  className?: string;
}

const CustomSelectContext = React.createContext<{
  isOpen: boolean;
  setIsOpen: (open: boolean) => void;
  selectedValue: string;
  setSelectedValue: (value: string) => void;
  onValueChange: (value: string) => void;
  disabled?: boolean;
} | null>(null);

export const CustomSelect: React.FC<CustomSelectProps> = ({
  value,
  onValueChange,
  placeholder,
  className = '',
  disabled = false,
  children
}) => {
  const [isOpen, setIsOpen] = useState(false);
  const [selectedValue, setSelectedValue] = useState(value);

  useEffect(() => {
    setSelectedValue(value);
  }, [value]);

  const handleValueChange = (newValue: string) => {
    if (disabled) return;
    setSelectedValue(newValue);
    onValueChange(newValue);
    setIsOpen(false);
  };

  return (
    <CustomSelectContext.Provider
      value={{
        isOpen,
        setIsOpen,
        selectedValue,
        setSelectedValue,
        onValueChange: handleValueChange,
        disabled
      }}
    >
      <div className={`relative ${className}`}>
        {children}
      </div>
    </CustomSelectContext.Provider>
  );
};

export const CustomSelectTrigger: React.FC<CustomSelectTriggerProps> = ({
  children,
  className = '',
  disabled = false
}) => {
  const context = React.useContext(CustomSelectContext);
  if (!context) {
    throw new Error('CustomSelectTrigger must be used within CustomSelect');
  }

  const { isOpen, setIsOpen, disabled: contextDisabled } = context;
  const isDisabled = disabled || contextDisabled;

  return (
    <button
      type="button"
      disabled={isDisabled}
      className={`flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-xs ring-offset-background placeholder:text-muted-foreground focus:outline-hidden focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1 ${className}`}
      onClick={() => !isDisabled && setIsOpen(!isOpen)}
    >
      {children}
      <ChevronDown className={`h-4 w-4 opacity-50 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
    </button>
  );
};

export const CustomSelectContent: React.FC<CustomSelectContentProps> = ({
  children,
  className = ''
}) => {
  const context = React.useContext(CustomSelectContext);
  if (!context) {
    throw new Error('CustomSelectContent must be used within CustomSelect');
  }

  const { isOpen, disabled } = context;

  if (!isOpen || disabled) return null;

  return (
    <div className={`absolute z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 slide-in-from-top-2 ${className}`}>
      <div className="p-1">
        {children}
      </div>
    </div>
  );
};

export const CustomSelectItem: React.FC<CustomSelectItemProps> = ({
  value,
  children,
  className = ''
}) => {
  const context = React.useContext(CustomSelectContext);
  if (!context) {
    throw new Error('CustomSelectItem must be used within CustomSelect');
  }

  const { selectedValue, onValueChange, disabled } = context;

  return (
    <div
      className={`relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-2 pr-8 text-sm outline-hidden focus:bg-accent focus:text-accent-foreground hover:bg-accent hover:text-accent-foreground ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`}
      onClick={() => !disabled && onValueChange(value)}
    >
      {children}
      {selectedValue === value && (
        <span className="absolute right-2 flex h-3.5 w-3.5 items-center justify-center">
          <svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
          </svg>
        </span>
      )}
    </div>
  );
};

export const CustomSelectValue: React.FC<{ children?: React.ReactNode }> = ({
  children
}) => {
  const context = React.useContext(CustomSelectContext);
  if (!context) {
    throw new Error('CustomSelectValue must be used within CustomSelect');
  }

  const { selectedValue } = context;

  return <span>{children || selectedValue}</span>;
}; 


================================================
FILE: apps/web/components/Dashboard/Pages/Course/EditCourseGeneral/EditCourseGeneral.tsx
================================================
import FormLayout, {
  FormField,
  FormLabelAndMessage,
  Input,
  Textarea,
} from '@components/Objects/StyledElements/Form/Form';
import { useFormik } from 'formik';
import { AlertTriangle } from 'lucide-react';
import * as Form from '@radix-ui/react-form';
import React, { useEffect, useState } from 'react';
import ThumbnailUpdate from './ThumbnailUpdate';
import { useCourse, useCourseDispatch } from '@components/Contexts/CourseContext';
import FormTagInput from '@components/Objects/StyledElements/Form/TagInput';
import LearningItemsList from './LearningItemsList';
import {
  CustomSelect,
  CustomSelectContent,
  CustomSelectItem,
  CustomSelectTrigger,
  CustomSelectValue,
} from "./CustomSelect";

type EditCourseStructureProps = {
  orgslug: string
  course_uuid?: string
}

const validate = (values: any) => {
  const errors = {} as any;

  if (!values.name) {
    errors.name = 'Required';
  } else if (values.name.length > 100) {
    errors.name = 'Must be 100 characters or less';
  }

  if (!values.description) {
    errors.description = 'Required';
  } else if (values.description.length > 1000) {
    errors.description = 'Must be 1000 characters or less';
  }

  if (!values.learnings) {
    errors.learnings = 'Required';
  } else {
    try {
      const learningItems = JSON.parse(values.learnings);
      if (!Array.isArray(learningItems)) {
        errors.learnings = 'Invalid format';
      } else if (learningItems.length === 0) {
        errors.learnings = 'At least one learning item is required';
      } else {
        // Check if any item has empty text
        const hasEmptyText = learningItems.some(item => !item.text || item.text.trim() === '');
        if (hasEmptyText) {
          errors.learnings = 'All learning items must have text';
        }
      }
    } catch (e) {
      errors.learnings = 'Invalid JSON format';
    }
  }

  return errors;
};

function EditCourseGeneral(props: EditCourseStructureProps) {
  const [error, setError] = useState('');
  const course = useCourse();
  const dispatchCourse = useCourseDispatch() as any;
  const { isLoading, courseStructure } = course as any;

  // Initialize learnings as a JSON array if it's not already
  const initializeLearnings = (learnings: any) => {
    if (!learnings) {
      return JSON.stringify([{ id: Date.now().toString(), text: '', emoji: 'ğŸ“' }]);
    }
    
    try {
      // Check if it's already a valid JSON array
      const parsed = JSON.parse(learnings);
      if (Array.isArray(parsed)) {
        return learnings;
      }
      
      // If it's a string but not a JSON array, convert it to a learning item
      if (typeof learnings === 'string') {
        return JSON.stringify([{ 
          id: Date.now().toString(), 
          text: learnings, 
          emoji: 'ğŸ“' 
        }]);
      }
      
      // Default empty array
      return JSON.stringify([{ id: Date.now().toString(), text: '', emoji: 'ğŸ“' }]);
    } catch (e) {
      // If it's not valid JSON, convert the string to a learning item
      if (typeof learnings === 'string') {
        return JSON.stringify([{ 
          id: Date.now().toString(), 
          text: learnings, 
          emoji: 'ğŸ“' 
        }]);
      }
      
      // Default empty array
      return JSON.stringify([{ id: Date.now().toString(), text: '', emoji: 'ğŸ“' }]);
    }
  };

  // Create initial values object
  const getInitialValues = () => {
    const thumbnailType = courseStructure?.thumbnail_type || 'image';
    return {
      name: courseStructure?.name || '',
      description: courseStructure?.description || '',
      about: courseStructure?.about || '',
      learnings: initializeLearnings(courseStructure?.learnings || ''),
      tags: courseStructure?.tags || '',
      public: courseStructure?.public || false,
      thumbnail_type: thumbnailType,
    };
  };

  const formik = useFormik({
    initialValues: getInitialValues(),
    validate,
    onSubmit: async values => {
      try {
        // Add your submission logic here
        dispatchCourse({ type: 'setIsSaved' });
      } catch (e) {
        setError('Failed to save course structure.');
      }
    },
    enableReinitialize: true,
  }) as any;

  // Reset form when courseStructure changes
  useEffect(() => {
    if (courseStructure && !isLoading) {
      const newValues = getInitialValues();
      formik.resetForm({ values: newValues });
    }
  }, [courseStructure, isLoading]);

  useEffect(() => {
    if (!isLoading) {
      const formikValues = formik.values as any;
      const initialValues = formik.initialValues as any;
      const valuesChanged = Object.keys(formikValues).some(
        key => formikValues[key] !== initialValues[key]
      );

      if (valuesChanged) {
        dispatchCourse({ type: 'setIsNotSaved' });
        const updatedCourse = {
          ...courseStructure,
          ...formikValues,
        };
        dispatchCourse({ type: 'setCourseStructure', payload: updatedCourse });
      }
    }
  }, [formik.values, isLoading]);

  if (isLoading || !courseStructure) {
    return <div>Loading...</div>;
  }

  return (
    <div className="h-full">
      <div className="h-6" />
      <div className="px-10 pb-10">
        <div className="bg-white rounded-xl shadow-xs">
          <FormLayout onSubmit={formik.handleSubmit} className="p-6">
            {error && (
              <div className="flex justify-center bg-red-200 rounded-md text-red-950 space-x-2 items-center p-4 mb-6 transition-all shadow-xs">
                <AlertTriangle size={18} />
                <div className="font-bold text-sm">{error}</div>
              </div>
            )}

            <div className="space-y-6">
              <FormField name="name">
                <FormLabelAndMessage label="Name" message={formik.errors.name} />
                <Form.Control asChild>
                  <Input
                    style={{ backgroundColor: 'white' }}
                    onChange={formik.handleChange}
                    value={formik.values.name}
                    type="text"
                    required
                  />
                </Form.Control>
              </FormField>

              <FormField name="description">
                <FormLabelAndMessage label="Description" message={formik.errors.description} />
                <Form.Control asChild>
                  <Input
                    style={{ backgroundColor: 'white' }}
                    onChange={formik.handleChange}
                    value={formik.values.description}
                    type="text"
                    required
                  />
                </Form.Control>
              </FormField>

              <FormField name="about">
                <FormLabelAndMessage label="About" message={formik.errors.about} />
                <Form.Control asChild>
                  <Textarea
                    style={{ backgroundColor: 'white', height: '200px', minHeight: '200px' }}
                    onChange={formik.handleChange}
                    value={formik.values.about}
                    required
                  />
                </Form.Control>
              </FormField>

              <FormField name="learnings">
                <FormLabelAndMessage label="Learnings" message={formik.errors.learnings} />
                <Form.Control asChild>
                  <LearningItemsList
                    value={formik.values.learnings}
                    onChange={(value) => formik.setFieldValue('learnings', value)}
                    error={formik.errors.learnings}
                  />
                </Form.Control>
              </FormField>

              <FormField name="tags">
                <FormLabelAndMessage label="Tags" message={formik.errors.tags} />
                <Form.Control asChild>
                  <FormTagInput
                    placeholder="Enter to add..."
                    onChange={(value) => formik.setFieldValue('tags', value)}
                    value={formik.values.tags}
                  />
                </Form.Control>
              </FormField>

              <FormField name="thumbnail_type">
                <FormLabelAndMessage label="Thumbnail Type" />
                <Form.Control asChild>
                  <CustomSelect
                    value={formik.values.thumbnail_type}
                    onValueChange={(value) => {
                      if (!value) return;
                      formik.setFieldValue('thumbnail_type', value);
                    }}
                  >
                    <CustomSelectTrigger className="w-full bg-white">
                      <CustomSelectValue>
                        {formik.values.thumbnail_type === 'image' ? 'Image' :
                         formik.values.thumbnail_type === 'video' ? 'Video' :
                         formik.values.thumbnail_type === 'both' ? 'Both' : 'Image'}
                      </CustomSelectValue>
                    </CustomSelectTrigger>
                    <CustomSelectContent>
                      <CustomSelectItem value="image">Image</CustomSelectItem>
                      <CustomSelectItem value="video">Video</CustomSelectItem>
                      <CustomSelectItem value="both">Both</CustomSelectItem>
                    </CustomSelectContent>
                  </CustomSelect>
                </Form.Control>
              </FormField>

              <FormField name="thumbnail">
                <FormLabelAndMessage label="Thumbnail" />
                <Form.Control asChild>
                  <ThumbnailUpdate thumbnailType={formik.values.thumbnail_type} />
                </Form.Control>
              </FormField>
            </div>
          </FormLayout>
        </div>
      </div>
    </div>
  );
}

export default EditCourseGeneral;



================================================
FILE: apps/web/components/Dashboard/Pages/Course/EditCourseGeneral/LearningItemsList.tsx
================================================
import React, { useState, useEffect, useRef } from 'react';
import { Plus, X, Link as LinkIcon } from 'lucide-react';
import Picker from '@emoji-mart/react';
import data from '@emoji-mart/data';
import { Input } from '@components/ui/input';

interface LearningItem {
  id: string;
  text: string;
  emoji: string;
  link?: string;
}

interface LearningItemsListProps {
  value: string;
  onChange: (value: string) => void;
  error?: string;
}

const LearningItemsList = ({ value, onChange, error }: LearningItemsListProps) => {
  const [items, setItems] = useState<LearningItem[]>([]);
  const [showEmojiPicker, setShowEmojiPicker] = useState<string | null>(null);
  const [showLinkInput, setShowLinkInput] = useState<string | null>(null);
  const [focusedItemId, setFocusedItemId] = useState<string | null>(null);
  const pickerRef = useRef<HTMLDivElement>(null);
  const linkInputRef = useRef<HTMLDivElement>(null);
  const initializedRef = useRef(false);
  const inputRefs = useRef<Record<string, HTMLInputElement | null>>({});
  const linkInputFieldRefs = useRef<Record<string, HTMLInputElement | null>>({});
  const scrollContainerRef = useRef<HTMLDivElement>(null);

  // Add a new empty item
  const addItem = () => {
    const newItem: LearningItem = {
      id: Date.now().toString(),
      text: '',
      emoji: 'ğŸ“',
    };
    const newItems = [...items, newItem];
    setItems(newItems);
    onChange(JSON.stringify(newItems));
    
    // Focus the newly added item after render
    setTimeout(() => {
      if (inputRefs.current[newItem.id]) {
        inputRefs.current[newItem.id]?.focus();
        setFocusedItemId(newItem.id);
      }
      
      // Scroll to the bottom when a new item is added
      if (scrollContainerRef.current && newItems.length > 5) {
        scrollContainerRef.current.scrollTop = scrollContainerRef.current.scrollHeight;
      }
    }, 0);
  };

  // Parse the JSON string to items array when the component mounts or value changes
  useEffect(() => {
    try {
      if (value) {
        const parsedItems = JSON.parse(value);
        if (Array.isArray(parsedItems)) {
          setItems(parsedItems);
          initializedRef.current = true;
        } else if (!initializedRef.current) {
          // Initialize with one empty item if no valid array and not already initialized
          const newItem: LearningItem = {
            id: Date.now().toString(),
            text: '',
            emoji: 'ğŸ“',
          };
          setItems([newItem]);
          onChange(JSON.stringify([newItem]));
          initializedRef.current = true;
        }
      } else if (!initializedRef.current) {
        // Initialize with one empty item if no value and not already initialized
        const newItem: LearningItem = {
          id: Date.now().toString(),
          text: '',
          emoji: 'ğŸ“',
        };
        setItems([newItem]);
        onChange(JSON.stringify([newItem]));
        initializedRef.current = true;
      }
    } catch (e) {
      console.error('Error parsing learning items:', e);
      // Initialize with one empty item on error if not already initialized
      if (!initializedRef.current) {
        const newItem: LearningItem = {
          id: Date.now().toString(),
          text: '',
          emoji: 'ğŸ“',
        };
        setItems([newItem]);
        onChange(JSON.stringify([newItem]));
        initializedRef.current = true;
      }
    }
  }, [value]);

  // Restore focus after re-render if an item was focused
  useEffect(() => {
    if (focusedItemId) {
      if (showLinkInput === focusedItemId) {
        // Focus the link input if it's open for the focused item
        if (linkInputFieldRefs.current[focusedItemId]) {
          linkInputFieldRefs.current[focusedItemId]?.focus();
        }
      } else {
        // Focus the text input
        if (inputRefs.current[focusedItemId]) {
          inputRefs.current[focusedItemId]?.focus();
        }
      }
      
      // Scroll the focused item into view if needed
      if (items.length > 5 && scrollContainerRef.current) {
        const focusedElement = document.getElementById(`learning-item-${focusedItemId}`);
        if (focusedElement) {
          const containerRect = scrollContainerRef.current.getBoundingClientRect();
          const elementRect = focusedElement.getBoundingClientRect();
          
          // Check if the element is outside the visible area
          if (elementRect.top < containerRect.top || elementRect.bottom > containerRect.bottom) {
            focusedElement.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
          }
        }
      }
    }
  }, [items, focusedItemId, showLinkInput]);

  // Handle clicks outside of emoji picker and link input
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (pickerRef.current && !pickerRef.current.contains(event.target as Node)) {
        setShowEmojiPicker(null);
      }
      if (linkInputRef.current && !linkInputRef.current.contains(event.target as Node)) {
        setShowLinkInput(null);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, []);

  // Update the parent component with the new JSON string when items change
  const updateItems = (newItems: LearningItem[]) => {
    setItems(newItems);
    onChange(JSON.stringify(newItems));
  };

  // Remove an item
  const removeItem = (id: string) => {
    if (focusedItemId === id) {
      setFocusedItemId(null);
    }
    updateItems(items.filter(item => item.id !== id));
  };

  // Update item text
  const updateItemText = (id: string, text: string) => {
    updateItems(
      items.map(item => (item.id === id ? { ...item, text } : item))
    );
  };

  // Update item emoji
  const updateItemEmoji = (id: string, emoji: string) => {
    updateItems(
      items.map(item => (item.id === id ? { ...item, emoji } : item))
    );
    setShowEmojiPicker(null);
    
    // Restore focus to the text input after emoji selection
    setTimeout(() => {
      if (inputRefs.current[id]) {
        inputRefs.current[id]?.focus();
        setFocusedItemId(id);
      }
    }, 0);
  };

  // Update item link
  const updateItemLink = (id: string, link: string) => {
    updateItems(
      items.map(item => (item.id === id ? { ...item, link } : item))
    );
  };

  // Handle emoji selection
  const handleEmojiSelect = (id: string, emojiData: any) => {
    updateItemEmoji(id, emojiData.native);
  };

  // Handle focus on input
  const handleInputFocus = (id: string) => {
    setFocusedItemId(id);
  };

  // Handle blur on input
  const handleInputBlur = () => {
    // Don't clear focusedItemId immediately as it might be needed for refocusing
    // We'll use a small delay to allow other focus events to occur first
    setTimeout(() => {
      // Only clear if we're not focusing another input in this component
      if (!document.activeElement || 
          !document.activeElement.classList.contains('learning-item-input')) {
        setFocusedItemId(null);
      }
    }, 100);
  };

  // Ref callback for text inputs
  const setInputRef = (id: string) => (el: HTMLInputElement | null) => {
    inputRefs.current[id] = el;
  };

  // Ref callback for link inputs
  const setLinkInputRef = (id: string) => (el: HTMLInputElement | null) => {
    linkInputFieldRefs.current[id] = el;
  };

  // Determine if we need to make the list scrollable
  const isScrollable = items.length > 5;

  return (
    <div className="space-y-2">
      {items.length === 0 && (
        <div className="text-center py-3 text-gray-500 bg-gray-50/50 rounded-lg text-sm">
          No learning items added yet. Click the button below to add one.
        </div>
      )}
      
      <div 
        ref={scrollContainerRef}
        className={`space-y-2 ${isScrollable ? 'max-h-[350px] overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-gray-200 scrollbar-track-transparent' : ''}`}
      >
        {items.map((item) => (
          <div key={item.id} id={`learning-item-${item.id}`} className="group relative">
            <div className="flex items-center gap-2 py-2 px-3 bg-gray-50/70 hover:bg-gray-50 border border-gray-100 rounded-lg transition-colors">
              <button
                type="button"
                onClick={() => {
                  setShowEmojiPicker(showEmojiPicker === item.id ? null : item.id);
                  setShowLinkInput(null);
                }}
                className="text-lg shrink-0"
              >
                <span>{item.emoji}</span>
              </button>
              
              <Input
                ref={setInputRef(item.id)}
                value={item.text}
                onChange={(e) => updateItemText(item.id, e.target.value)}
                onFocus={() => handleInputFocus(item.id)}
                onBlur={handleInputBlur}
                placeholder="Enter learning item..."
                className="grow border-0 bg-transparent focus-visible:ring-0 px-0 h-8 text-sm learning-item-input"
              />
              
              {item.link && (
                <div className="text-xs text-blue-500 flex items-center gap-1 bg-blue-50 px-2 py-0.5 rounded">
                  <LinkIcon size={12} />
                  <span className="truncate max-w-[100px]">{item.link}</span>
                </div>
              )}
              
              <div className="flex items-center gap-1">
                <button
                  type="button"
                  onClick={() => {
                    setShowLinkInput(showLinkInput === item.id ? null : item.id);
                    setShowEmojiPicker(null);
                    setFocusedItemId(item.id);
                    // Focus the link input after render
                    setTimeout(() => {
                      if (linkInputFieldRefs.current[item.id]) {
                        linkInputFieldRefs.current[item.id]?.focus();
                      }
                    }, 0);
                  }}
                  className="text-gray-400 hover:text-blue-500 transition-colors"
                  title={item.link ? "Edit link" : "Add link"}
                >
                  <LinkIcon size={15} />
                </button>
                
                <button
                  type="button"
                  onClick={() => removeItem(item.id)}
                  className="text-gray-300 hover:text-gray-500 transition-colors"
                  aria-label="Remove item"
                  title="Remove item"
                >
                  <X size={15} />
                </button>
              </div>
            </div>
            
            {showEmojiPicker === item.id && (
              <div ref={pickerRef} className="absolute z-10 mt-1 left-0">
                <Picker
                  data={data}
                  onEmojiSelect={(emoji: any) => handleEmojiSelect(item.id, emoji)}
                  theme="light"
                  previewPosition="none"
                  searchPosition="top"
                  maxFrequentRows={0}
                  autoFocus={false}
                />
              </div>
            )}
            
            {showLinkInput === item.id && (
              <div ref={linkInputRef} className="mt-1 p-2 bg-white border border-gray-200 rounded-lg shadow-xs">
                <Input
                  ref={setLinkInputRef(item.id)}
                  value={items.find(i => i.id === item.id)?.link || ''}
                  onChange={(e) => updateItemLink(item.id, e.target.value)}
                  onFocus={() => handleInputFocus(item.id)}
                  onBlur={handleInputBlur}
                  placeholder="Enter URL..."
                  className="w-full text-sm learning-item-input"
                  autoFocus
                />
              </div>
            )}
          </div>
        ))}
      </div>
      
      <button
        type="button"
        onClick={addItem}
        className="flex items-center gap-1.5 text-sm text-gray-500 hover:text-gray-700 transition-colors mt-2"
      >
        <Plus size={16} className="text-blue-500" />
        <span>Add learning item</span>
      </button>
    </div>
  );
};

export default LearningItemsList; 


================================================
FILE: apps/web/components/Dashboard/Pages/Course/EditCourseGeneral/ThumbnailUpdate.tsx
================================================
import { useCourse } from '@components/Contexts/CourseContext'
import { useOrg } from '@components/Contexts/OrgContext'
import { getAPIUrl } from '@services/config/config'
import { updateCourseThumbnail } from '@services/courses/courses'
import { getCourseThumbnailMediaDirectory } from '@services/media/media'
import { ArrowBigUpDash, UploadCloud, Image as ImageIcon, Video } from 'lucide-react'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import React, { useState, useEffect, useRef } from 'react'
import { mutate } from 'swr'
import UnsplashImagePicker from './UnsplashImagePicker'
import toast from 'react-hot-toast'

const MAX_FILE_SIZE = 8_000_000; // 8MB for images
const MAX_VIDEO_FILE_SIZE = 100_000_000; // 100MB for videos
const VALID_IMAGE_MIME_TYPES = ['image/jpeg', 'image/jpg', 'image/png'] as const;
const VALID_VIDEO_MIME_TYPES = ['video/mp4', 'video/webm'] as const;

type ValidImageMimeType = typeof VALID_IMAGE_MIME_TYPES[number];
type ValidVideoMimeType = typeof VALID_VIDEO_MIME_TYPES[number];

type ThumbnailUpdateProps = {
  thumbnailType: 'image' | 'video' | 'both';
}

type TabType = 'image' | 'video';

function ThumbnailUpdate({ thumbnailType }: ThumbnailUpdateProps) {
  const imageInputRef = useRef<HTMLInputElement>(null);
  const videoInputRef = useRef<HTMLInputElement>(null);
  const course = useCourse() as any
  const session = useLHSession() as any;
  const org = useOrg() as any
  const [localThumbnail, setLocalThumbnail] = useState<{ file: File; url: string; type: 'image' | 'video' } | null>(null)
  const [isLoading, setIsLoading] = useState(false)
  const [showUnsplashPicker, setShowUnsplashPicker] = useState(false)
  const [activeTab, setActiveTab] = useState<TabType>('image')
  const withUnpublishedActivities = course ? course.withUnpublishedActivities : false

  // Set initial active tab based on thumbnailType
  useEffect(() => {
    if (thumbnailType === 'video') {
      setActiveTab('video');
    } else {
      setActiveTab('image');
    }
  }, [thumbnailType]);

  // Cleanup blob URLs when component unmounts or when thumbnail changes
  useEffect(() => {
    return () => {
      if (localThumbnail?.url) {
        URL.revokeObjectURL(localThumbnail.url);
      }
    };
  }, [localThumbnail]);

  const showError = (message: string) => {
    toast.error(message, {
      duration: 3000,
      position: 'top-center',
    });
  };

  const validateFile = (file: File, type: 'image' | 'video'): boolean => {
    if (type === 'image') {
      if (!VALID_IMAGE_MIME_TYPES.includes(file.type as ValidImageMimeType)) {
        showError(`Invalid file type: ${file.type}. Please upload only PNG or JPG/JPEG images`);
        return false;
      }

      if (file.size > MAX_FILE_SIZE) {
        showError(`File size (${(file.size / 1024 / 1024).toFixed(2)}MB) exceeds the 8MB limit`);
        return false;
      }
    } else {
      if (!VALID_VIDEO_MIME_TYPES.includes(file.type as ValidVideoMimeType)) {
        showError(`Invalid file type: ${file.type}. Please upload only MP4 or WebM videos`);
        return false;
      }

      if (file.size > MAX_VIDEO_FILE_SIZE) {
        showError(`File size (${(file.size / 1024 / 1024).toFixed(2)}MB) exceeds the 100MB limit`);
        return false;
      }
    }

    return true;
  }

  const handleFileChange = async (event: React.ChangeEvent<HTMLInputElement>, type: 'image' | 'video') => {
    const file = event.target.files?.[0];
    
    if (!file) {
      showError('Please select a file');
      return;
    }
    
    if (!validateFile(file, type)) {
      event.target.value = '';
      return;
    }
    
    const blobUrl = URL.createObjectURL(file);
    setLocalThumbnail({ file, url: blobUrl, type });
    await updateThumbnail(file, type);
  }

  const handleUnsplashSelect = async (imageUrl: string) => {
    try {
      setIsLoading(true);
      const response = await fetch(imageUrl);
      const blob = await response.blob();
      
      if (!VALID_IMAGE_MIME_TYPES.includes(blob.type as ValidImageMimeType)) {
        throw new Error('Invalid image format from Unsplash');
      }

      const file = new File([blob], `unsplash_${Date.now()}.jpg`, { type: blob.type });
      
      if (!validateFile(file, 'image')) {
        return;
      }

      const blobUrl = URL.createObjectURL(file);
      setLocalThumbnail({ file, url: blobUrl, type: 'image' });
      await updateThumbnail(file, 'image');
    } catch (err) {
      showError('Failed to process Unsplash image');
      setIsLoading(false);
    }
  }

  const updateThumbnail = async (file: File, type: 'image' | 'video') => {
    setIsLoading(true);
    try {
      const formData = new FormData();
      formData.append('thumbnail', file);
      formData.append('thumbnail_type', type);

      const res = await updateCourseThumbnail(
        course.courseStructure.course_uuid,
        formData,
        session.data?.tokens?.access_token
      );
      
      await mutate(`${getAPIUrl()}courses/${course.courseStructure.course_uuid}/meta?with_unpublished_activities=${withUnpublishedActivities}`);
      await new Promise((r) => setTimeout(r, 1500));

      if (res.success === false) {
        showError(res.HTTPmessage);
      } else {
        setLocalThumbnail(null);
        toast.success('Thumbnail updated successfully', {
          duration: 3000,
          position: 'top-center',
        });
      }
    } catch (err) {
      showError('Failed to update thumbnail');
    } finally {
      setIsLoading(false);
    }
  }

  const getThumbnailUrl = (type: 'image' | 'video') => {
    if (type === 'image') {
      return course.courseStructure.thumbnail_image
        ? getCourseThumbnailMediaDirectory(
            org?.org_uuid,
            course.courseStructure.course_uuid,
            course.courseStructure.thumbnail_image
          )
        : '/empty_thumbnail.png';
    } else {
      return course.courseStructure.thumbnail_video
        ? getCourseThumbnailMediaDirectory(
            org?.org_uuid,
            course.courseStructure.course_uuid,
            course.courseStructure.thumbnail_video
          )
        : undefined;
    }
  };

  const renderThumbnailPreview = () => {
    if (localThumbnail) {
      if (localThumbnail.type === 'video') {
        return (
          <div className="max-w-[480px] mx-auto">
            <video
              src={localThumbnail.url}
              className={`${isLoading ? 'animate-pulse' : ''} w-full aspect-video object-cover rounded-lg border border-gray-200`}
              controls
            />
          </div>
        );
      } else {
        return (
          <div className="max-w-[480px] mx-auto">
            <img
              src={localThumbnail.url}
              alt="Course thumbnail preview"
              className={`${isLoading ? 'animate-pulse' : ''} w-full aspect-video object-cover rounded-lg border border-gray-200`}
            />
          </div>
        );
      }
    }

    const currentThumbnailUrl = getThumbnailUrl(activeTab);
    if (activeTab === 'video' && currentThumbnailUrl) {
      return (
        <div className="max-w-[480px] mx-auto">
          <video
            src={currentThumbnailUrl}
            className="w-full aspect-video object-cover rounded-lg border border-gray-200"
            controls
          />
        </div>
      );
    } else if (currentThumbnailUrl) {
      return (
        <div className="max-w-[480px] mx-auto">
          <img
            src={currentThumbnailUrl}
            alt="Current course thumbnail"
            className="w-full aspect-video object-cover rounded-lg border border-gray-200"
          />
        </div>
      );
    }

    return null;
  };

  const renderTabContent = () => {
    if (isLoading) {
      return (
        <div className="flex justify-center items-center mt-4">
          <div className="font-medium text-sm text-green-800 bg-green-50 rounded-full px-4 py-2 flex items-center">
            <ArrowBigUpDash size={16} className="mr-2 animate-bounce" />
            Uploading...
          </div>
        </div>
      );
    }

    if (activeTab === 'image') {
      return (
        <div className="flex gap-2 mt-4">
          <input
            ref={imageInputRef}
            type="file"
            className="hidden"
            accept=".jpg,.jpeg,.png"
            onChange={(e) => handleFileChange(e, 'image')}
          />
          <button
            type="button"
            className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            onClick={() => imageInputRef.current?.click()}
          >
            <UploadCloud size={16} />
            Upload Image
          </button>
          <button
            type="button"
            className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            onClick={() => setShowUnsplashPicker(true)}
          >
            <ImageIcon size={16} />
            Gallery
          </button>
        </div>
      );
    }

    return (
      <div className="flex gap-2 mt-4">
        <input
          ref={videoInputRef}
          type="file"
          className="hidden"
          accept=".mp4,.webm"
          onChange={(e) => handleFileChange(e, 'video')}
        />
        <button
          type="button"
          className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          onClick={() => videoInputRef.current?.click()}
        >
          <Video size={16} />
          Upload Video
        </button>
      </div>
    );
  };

  return (
    <div className="w-full bg-white rounded-xl">
      {/* Tabs Navigation */}
      {thumbnailType === 'both' && (
        <div className="flex border-b border-gray-100">
          <button
            className={`flex items-center gap-2 px-4 py-2.5 text-sm font-medium transition-colors ${
              activeTab === 'image'
                ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50/50'
                : 'text-gray-600 hover:text-gray-900'
            }`}
            onClick={() => setActiveTab('image')}
          >
            <ImageIcon size={16} />
            Image
          </button>
          <button
            className={`flex items-center gap-2 px-4 py-2.5 text-sm font-medium transition-colors ${
              activeTab === 'video'
                ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50/50'
                : 'text-gray-600 hover:text-gray-900'
            }`}
            onClick={() => setActiveTab('video')}
          >
            <Video size={16} />
            Video
          </button>
        </div>
      )}

      <div className="p-6">
        <div className="space-y-6">
          {renderThumbnailPreview()}
          {renderTabContent()}
          
          <p className="text-sm text-gray-500">
            {activeTab === 'image' && 'Supported formats: PNG, JPG/JPEG (max 8MB)'}
            {activeTab === 'video' && 'Supported formats: MP4, WebM (max 100MB)'}
          </p>
        </div>
      </div>
      
      {showUnsplashPicker && (
        <UnsplashImagePicker
          onSelect={handleUnsplashSelect}
          onClose={() => setShowUnsplashPicker(false)}
        />
      )}
    </div>
  )
}

export default ThumbnailUpdate


================================================
FILE: apps/web/components/Dashboard/Pages/Course/EditCourseGeneral/UnsplashImagePicker.tsx
================================================
import React, { useState, useEffect, useCallback } from 'react';
import { createApi } from 'unsplash-js';
import { Search, Cpu, Briefcase, GraduationCap, Heart, Palette, Plane, Utensils, 
  Dumbbell, Music, Shirt, Book, Building, Bike, Camera, Microscope, Coins, Coffee, Gamepad, 
  Flower} from 'lucide-react';
import Modal from '@components/Objects/StyledElements/Modal/Modal';

const unsplash = createApi({
  accessKey: process.env.NEXT_PUBLIC_UNSPLASH_ACCESS_KEY as string,
});

const IMAGES_PER_PAGE = 20;

const predefinedLabels = [
  { name: 'Nature', icon: Flower },
  { name: 'Technology', icon: Cpu },
  { name: 'Business', icon: Briefcase },
  { name: 'Education', icon: GraduationCap },
  { name: 'Health', icon: Heart },
  { name: 'Art', icon: Palette },
  { name: 'Science', icon: Microscope },
  { name: 'Travel', icon: Plane },
  { name: 'Food', icon: Utensils },
  { name: 'Sports', icon: Dumbbell },
  { name: 'Music', icon: Music },
  { name: 'Fashion', icon: Shirt },
  { name: 'History', icon: Book },
  { name: 'Architecture', icon: Building },
  { name: 'Fitness', icon: Bike },
  { name: 'Photography', icon: Camera },
  { name: 'Biology', icon: Microscope },
  { name: 'Finance', icon: Coins },
  { name: 'Lifestyle', icon: Coffee },
  { name: 'Gaming', icon: Gamepad },
];

interface UnsplashImagePickerProps {
  onSelect: (imageUrl: string) => void;
  onClose: () => void;
  isOpen?: boolean;
}

const UnsplashImagePicker: React.FC<UnsplashImagePickerProps> = ({ onSelect, onClose, isOpen = true }) => {
  const [query, setQuery] = useState('');
  const [images, setImages] = useState<any[]>([]);
  const [page, setPage] = useState(1);
  const [loading, setLoading] = useState(false);

  const fetchImages = useCallback(async (searchQuery: string, pageNum: number) => {
    setLoading(true);
    try {
      const result = await unsplash.search.getPhotos({
        query: searchQuery,
        page: pageNum,
        perPage: IMAGES_PER_PAGE,
      });
      if (result && result.response) {
        setImages(prevImages => pageNum === 1 ? result.response.results : [...prevImages, ...result.response.results]);
      }
    } catch (error) {
      console.error('Error fetching images:', error);
    } finally {
      setLoading(false);
    }
  }, []);

  const debouncedFetchImages = useCallback(
    debounce((searchQuery: string) => {
      setPage(1);
      fetchImages(searchQuery, 1);
    }, 300),
    [fetchImages]
  );

  useEffect(() => {
    if (query) {
      debouncedFetchImages(query);
    }
  }, [query, debouncedFetchImages]);

  const handleSearch = (e: React.ChangeEvent<HTMLInputElement>) => {
    setQuery(e.target.value);
  };

  const handleLabelClick = (label: string) => {
    setQuery(label);
  };

  const handleLoadMore = () => {
    const nextPage = page + 1;
    setPage(nextPage);
    fetchImages(query, nextPage);
  };

  const handleImageSelect = (imageUrl: string) => {
    onSelect(imageUrl);
    onClose();
  };

  const modalContent = (
    <div className="flex flex-col h-full">
      <div className="p-4 space-y-4">
        <div className="relative">
          <input
            type="text"
            value={query}
            onChange={handleSearch}
            placeholder="Search for images..."
            className="w-full p-2 pl-10 border rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
          />
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={20} />
        </div>
        <div className="flex flex-wrap gap-2">
          {predefinedLabels.map(label => (
            <button
              key={label.name}
              onClick={() => handleLabelClick(label.name)}
              className="px-3 py-1 bg-neutral-100 rounded-lg hover:bg-neutral-200 nice-shadow transition-colors flex items-center gap-1 space-x-1"
            >
              <label.icon size={16} />
              <span>{label.name}</span>
            </button>
          ))}
        </div>
      </div>

      <div className="flex-1 overflow-y-auto p-4 pt-0">
        <div className="grid grid-cols-3 gap-4">
          {images.map(image => (
            <div key={image.id} className="relative w-full pb-[56.25%]">
              <img
                src={image.urls.small}
                alt={image.alt_description}
                className="absolute inset-0 w-full h-full object-cover rounded-lg cursor-pointer hover:opacity-80 transition-opacity"
                onClick={() => handleImageSelect(image.urls.regular)}
              />
            </div>
          ))}
        </div>
        {loading && <p className="text-center mt-4">Loading...</p>}
        {!loading && images.length > 0 && (
          <button
            onClick={handleLoadMore}
            className="mt-4 w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
          >
            Load More
          </button>
        )}
      </div>
    </div>
  );

  return (
    <Modal
      dialogTitle="Choose an image from Unsplash"
      dialogContent={modalContent}
      onOpenChange={onClose}
      isDialogOpen={isOpen}
      minWidth="lg"
      minHeight="lg"
      customHeight="h-[80vh]"
    />
  );
};

// Custom debounce function
const debounce = (func: Function, delay: number) => {
  let timeoutId: NodeJS.Timeout;
  return (...args: any[]) => {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => func(...args), delay);
  };
};

export default UnsplashImagePicker;


================================================
FILE: apps/web/components/Dashboard/Pages/Course/EditCourseStructure/EditCourseStructure.tsx
================================================
'use client'
import { getAPIUrl } from '@services/config/config'
import { revalidateTags } from '@services/utils/ts/requests'
import React, { useEffect, useState } from 'react'
import { DragDropContext, Droppable } from '@hello-pangea/dnd'
import { mutate } from 'swr'
import ChapterElement from './DraggableElements/ChapterElement'
import PageLoading from '@components/Objects/Loaders/PageLoading'
import { createChapter } from '@services/courses/chapters'
import { useRouter } from 'next/navigation'
import {
  useCourse,
  useCourseDispatch,
} from '@components/Contexts/CourseContext'
import { Hexagon } from 'lucide-react'
import Modal from '@components/Objects/StyledElements/Modal/Modal'
import NewChapterModal from '@components/Objects/Modals/Chapters/NewChapter'
import { useLHSession } from '@components/Contexts/LHSessionContext'

type EditCourseStructureProps = {
  orgslug: string
  course_uuid?: string
}

export type OrderPayload =
  | {
      chapter_order_by_ids: [
        {
          chapter_id: string
          activities_order_by_ids: [
            {
              activity_id: string
            },
          ]
        },
      ]
    }
  | undefined

const EditCourseStructure = (props: EditCourseStructureProps) => {
  const router = useRouter()
  const session = useLHSession() as any;
  const access_token = session?.data?.tokens?.access_token;
  // Check window availability
  const [winReady, setwinReady] = useState(false)

  const dispatchCourse = useCourseDispatch() as any

  const [order, setOrder] = useState<OrderPayload>()
  const course = useCourse() as any
  const course_structure = course ? course.courseStructure : {}
  const course_uuid = course ? course.courseStructure.course_uuid : ''
  const withUnpublishedActivities = course ? course.withUnpublishedActivities : false
  // New Chapter creation
  const [newChapterModal, setNewChapterModal] = useState(false)

  const closeNewChapterModal = async () => {
    setNewChapterModal(false)
  }

  // Submit new chapter
  const submitChapter = async (chapter: any) => {
    await createChapter(chapter,access_token)
    mutate(`${getAPIUrl()}courses/${course.courseStructure.course_uuid}/meta?with_unpublished_activities=${withUnpublishedActivities}`)
    await revalidateTags(['courses'], props.orgslug)
    router.refresh()
    setNewChapterModal(false)
  }

  const updateStructure = (result: any) => {
    const { destination, source, draggableId, type } = result
    if (!destination) return
    if (
      destination.droppableId === source.droppableId &&
      destination.index === source.index
    )
      return

    const newCourseStructure = { ...course_structure }
    
    if (type === 'chapter') {
      const newChapterOrder = Array.from(newCourseStructure.chapters)
      const [movedChapter] = newChapterOrder.splice(source.index, 1)
      newChapterOrder.splice(destination.index, 0, movedChapter)
      newCourseStructure.chapters = newChapterOrder
    }

    if (type === 'activity') {
      const newChapterOrder = Array.from(newCourseStructure.chapters)
      const sourceChapter = newChapterOrder.find(
        (chapter: any) => chapter.chapter_uuid === source.droppableId
      ) as any
      const destinationChapter = newChapterOrder.find(
        (chapter: any) => chapter.chapter_uuid === destination.droppableId
      ) ?? sourceChapter

      const [movedActivity] = sourceChapter.activities.splice(source.index, 1)
      destinationChapter.activities.splice(destination.index, 0, movedActivity)
      newCourseStructure.chapters = newChapterOrder
    }

    dispatchCourse({
      type: 'setCourseStructure',
      payload: newCourseStructure,
    })
    dispatchCourse({ type: 'setIsNotSaved' })
  }

  useEffect(() => {
    setwinReady(true)
  }, [props.course_uuid, course_structure, course])

  if (!course) return <PageLoading></PageLoading>

  return (
    <div className="flex flex-col">
      <div className="h-6"></div>
      {winReady ? (
        <DragDropContext onDragEnd={updateStructure}>
          <Droppable type="chapter" droppableId="chapters" direction="vertical">
            {(provided, snapshot) => (
              <div
                className={`space-y-4 ${snapshot.isDraggingOver ? 'bg-gray-50/50' : ''}`}
                {...provided.droppableProps}
                ref={provided.innerRef}
              >
                {course_structure.chapters &&
                  course_structure.chapters.map((chapter: any, index: any) => {
                    return (
                      <ChapterElement
                        key={chapter.chapter_uuid}
                        chapterIndex={index}
                        orgslug={props.orgslug}
                        course_uuid={course_uuid}
                        chapter={chapter}
                      />
                    )
                  })}
                {provided.placeholder}
              </div>
            )}
          </Droppable>

          {/* New Chapter Modal */}
          <Modal
            isDialogOpen={newChapterModal}
            onOpenChange={setNewChapterModal}
            minHeight="sm"
            dialogContent={
              <NewChapterModal
                course={course ? course.courseStructure : null}
                closeModal={closeNewChapterModal}
                submitChapter={submitChapter}
              ></NewChapterModal>
            }
            dialogTitle="Create chapter"
            dialogDescription="Add a new chapter to the course"
            dialogTrigger={
              <div className="w-44 my-16 py-5 max-w-(--breakpoint-2xl) mx-auto bg-cyan-800 text-white rounded-xl shadow-xs px-6 items-center flex flex-row h-10">
                <div className="mx-auto flex space-x-2 items-center hover:cursor-pointer">
                  <Hexagon
                    strokeWidth={3}
                    size={16}
                    className="text-white text-sm "
                  />
                  <div className="font-bold text-sm">Add Chapter</div>
                </div>
              </div>
            }
          />
        </DragDropContext>
      ) : (
        <></>
      )}
    </div>
  )
}

export default EditCourseStructure



================================================
FILE: apps/web/components/Dashboard/Pages/Course/EditCourseStructure/Buttons/NewActivityButton.tsx
================================================
import { useCourse } from '@components/Contexts/CourseContext'
import NewActivityModal from '@components/Objects/Modals/Activities/Create/NewActivity'
import Modal from '@components/Objects/StyledElements/Modal/Modal'
import { getAPIUrl } from '@services/config/config'
import {
  createActivity,
  createExternalVideoActivity,
  createFileActivity,
} from '@services/courses/activities'
import { getOrganizationContextInfoWithoutCredentials } from '@services/organizations/orgs'
import { revalidateTags } from '@services/utils/ts/requests'
import { Layers } from 'lucide-react'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { useRouter } from 'next/navigation'
import React, { useEffect } from 'react'
import { mutate } from 'swr'
import toast from 'react-hot-toast'

type NewActivityButtonProps = {
  chapterId: string
  orgslug: string
}

function NewActivityButton(props: NewActivityButtonProps) {
  const [newActivityModal, setNewActivityModal] = React.useState(false)
  const router = useRouter()
  const course = useCourse() as any
  const session = useLHSession() as any;
  const access_token = session?.data?.tokens?.access_token;
  const withUnpublishedActivities = course ? course.withUnpublishedActivities : false

  const openNewActivityModal = async (chapterId: any) => {
    setNewActivityModal(true)
  }

  const closeNewActivityModal = async () => {
    setNewActivityModal(false)
  }

  // Submit new activity
  const submitActivity = async (activity: any) => {
    let org = await getOrganizationContextInfoWithoutCredentials(
      props.orgslug,
      { revalidate: 1800 }
    )
    const toast_loading = toast.loading('Creating activity...')
    await createActivity(activity, props.chapterId, org.org_id, access_token)
    mutate(`${getAPIUrl()}courses/${course.courseStructure.course_uuid}/meta?with_unpublished_activities=${withUnpublishedActivities}`)
    toast.dismiss(toast_loading)
    toast.success('Activity created successfully')
    setNewActivityModal(false)
    await revalidateTags(['courses'], props.orgslug)
    router.refresh()
  }

  // Submit File Upload
  const submitFileActivity = async (
    file: any,
    type: any,
    activity: any,
    chapterId: string
  ) => {
    toast.loading('Uploading file and creating activity...')
    await createFileActivity(file, type, activity, chapterId, access_token)
    mutate(`${getAPIUrl()}courses/${course.courseStructure.course_uuid}/meta?with_unpublished_activities=${withUnpublishedActivities}`)
    setNewActivityModal(false)
    toast.dismiss()
    toast.success('File uploaded successfully')
    toast.success('Activity created successfully')
    await revalidateTags(['courses'], props.orgslug)
    router.refresh()
  }

  // Submit YouTube Video Upload
  const submitExternalVideo = async (
    external_video_data: any,
    activity: any,
    chapterId: string
  ) => {
    const toast_loading = toast.loading('Creating activity and uploading file...')
    await createExternalVideoActivity(
      external_video_data,
      activity,
      props.chapterId, access_token
    )
    mutate(`${getAPIUrl()}courses/${course.courseStructure.course_uuid}/meta?with_unpublished_activities=${withUnpublishedActivities}`)
    setNewActivityModal(false)
    toast.dismiss(toast_loading)
    toast.success('Activity created successfully')
    await revalidateTags(['courses'], props.orgslug)
    router.refresh()
  }

  useEffect(() => { }, [course])

  return (
    <div className="flex justify-center">
      <Modal
        isDialogOpen={newActivityModal}
        onOpenChange={setNewActivityModal}
        minHeight="no-min"
        minWidth='md'
        addDefCloseButton={false}
        dialogContent={
          <NewActivityModal
            closeModal={closeNewActivityModal}
            submitFileActivity={submitFileActivity}
            submitExternalVideo={submitExternalVideo}
            submitActivity={submitActivity}
            chapterId={props.chapterId}
            course={course}
          ></NewActivityModal>
        }
        dialogTitle="Create Activity"
        dialogDescription="Choose between types of activities to add to the course"
      />
      <div
        onClick={() => {
          openNewActivityModal(props.chapterId)
        }}
        className="flex w-44 h-10 items-center justify-center py-2 my-3 rounded-xl text-white bg-black hover:cursor-pointer"
      >
        <Layers size={17} />
        <div className="text-sm font-bold ml-2">
          Add Activity
        </div>
      </div>
    </div>
  )
}

export default NewActivityButton



================================================
FILE: apps/web/components/Dashboard/Pages/Course/EditCourseStructure/DraggableElements/ActivityElement.tsx
================================================
import ConfirmationModal from '@components/Objects/StyledElements/ConfirmationModal/ConfirmationModal'
import { getAPIUrl, getUriWithOrg } from '@services/config/config'
import { deleteActivity, updateActivity } from '@services/courses/activities'
import { revalidateTags } from '@services/utils/ts/requests'
import {
  Backpack,
  Eye,
  File,
  FilePenLine,
  Globe,
  Loader2,
  Lock,
  Pencil,
  Save,
  Sparkles,
  Video,
  X,
} from 'lucide-react'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import Link from 'next/link'
import { useRouter } from 'next/navigation'
import React, { useEffect, useState } from 'react'
import { Draggable } from '@hello-pangea/dnd'
import { mutate } from 'swr'
import { deleteAssignmentUsingActivityUUID, getAssignmentFromActivityUUID } from '@services/courses/assignments'
import { useOrg } from '@components/Contexts/OrgContext'
import { useCourse } from '@components/Contexts/CourseContext'
import toast from 'react-hot-toast'
import { useMediaQuery } from 'usehooks-ts'
import ToolTip from '@components/Objects/StyledElements/Tooltip/Tooltip'

type ActivitiyElementProps = {
  orgslug: string
  activity: any
  activityIndex: any
  course_uuid: string
}

interface ModifiedActivityInterface {
  activityId: string
  activityName: string
}

function ActivityElement(props: ActivitiyElementProps) {
  const router = useRouter()
  const session = useLHSession() as any;
  const access_token = session?.data?.tokens?.access_token;
  const [modifiedActivity, setModifiedActivity] = React.useState<
    ModifiedActivityInterface | undefined
  >(undefined)
  const [selectedActivity, setSelectedActivity] = React.useState<
    string | undefined
  >(undefined)
  const [isUpdatingName, setIsUpdatingName] = React.useState<boolean>(false)
  const activityUUID = props.activity.activity_uuid
  const isMobile = useMediaQuery('(max-width: 767px)')
  const course = useCourse() as any;
  const withUnpublishedActivities = course ? course.withUnpublishedActivities : false

  async function deleteActivityUI() {
    const toast_loading = toast.loading('Deleting activity...')
    // Assignments 
    if (props.activity.activity_type === 'TYPE_ASSIGNMENT') {
      await deleteAssignmentUsingActivityUUID(props.activity.activity_uuid, access_token)
    }

    await deleteActivity(props.activity.activity_uuid, access_token)
    mutate(`${getAPIUrl()}courses/${props.course_uuid}/meta?with_unpublished_activities=${withUnpublishedActivities}`)
    await revalidateTags(['courses'], props.orgslug)
    toast.dismiss(toast_loading)
    toast.success('Activity deleted successfully')
    router.refresh()
  }

  async function changePublicStatus() {
    const toast_loading = toast.loading('Updating assignment...')
    await updateActivity(
      {
        ...props.activity,
        published: !props.activity.published,
      },
      props.activity.activity_uuid,
      access_token
    )
    mutate(`${getAPIUrl()}courses/${props.course_uuid}/meta?with_unpublished_activities=${withUnpublishedActivities}`)
    toast.dismiss(toast_loading)
    toast.success('The activity has been updated successfully')
    await revalidateTags(['courses'], props.orgslug)
    router.refresh()
  }

  async function updateActivityName(activityId: string) {
    if (
      modifiedActivity?.activityId === activityId &&
      selectedActivity !== undefined
    ) {
      setIsUpdatingName(true)
      
      let modifiedActivityCopy = {
        ...props.activity,
        name: modifiedActivity.activityName,
      }

      try {
        await updateActivity(modifiedActivityCopy, activityUUID, access_token)
        mutate(`${getAPIUrl()}courses/${props.course_uuid}/meta?with_unpublished_activities=${withUnpublishedActivities}`)
        await revalidateTags(['courses'], props.orgslug)
        toast.success('Activity name updated successfully')
        router.refresh()
      } catch (error) {
        toast.error('Failed to update activity name')
        console.error('Error updating activity name:', error)
      } finally {
        setIsUpdatingName(false)
        setSelectedActivity(undefined)
      }
    } else {
      setSelectedActivity(undefined)
    }
  }

  return (
    <Draggable
      key={props.activity.activity_uuid}
      draggableId={props.activity.activity_uuid}
      index={props.activityIndex}
    >
      {(provided, snapshot) => (
        <div
          className={`grid grid-cols-[auto_1fr_auto] gap-2 py-2 px-3 my-2 w-full rounded-md text-gray-500 
            ${snapshot.isDragging 
              ? 'nice-shadow bg-white ring-2 ring-blue-500/20 z-50 rotate-1 scale-[1.04]' 
              : 'nice-shadow bg-gray-50 hover:bg-gray-100 '
            }
            items-center border-1 border-gray-200`}
          key={props.activity.id}
          {...provided.draggableProps}
          {...provided.dragHandleProps}
          ref={provided.innerRef}
          style={{
            ...provided.draggableProps.style
          }}
        >
          {/*   Activity Type Icon  */}
          <ActivityTypeIndicator activityType={props.activity.activity_type} isMobile={isMobile} />

          {/*   Centered Activity Name  */}
          <div className="flex items-center space-x-2 justify-center">
            {selectedActivity === props.activity.id ? (
              <div className="chapter-modification-zone text-[7px] text-gray-600 shadow-inner bg-gray-200/60 py-1 px-4 rounded-lg space-x-3">
                <input
                  type="text"
                  className="bg-transparent outline-hidden text-xs text-gray-500"
                  placeholder="Activity name"
                  value={
                    modifiedActivity
                      ? modifiedActivity?.activityName
                      : props.activity.name
                  }
                  onChange={(e) =>
                    setModifiedActivity({
                      activityId: props.activity.id,
                      activityName: e.target.value,
                    })
                  }
                  disabled={isUpdatingName}
                />
                <button
                  onClick={() => updateActivityName(props.activity.id)}
                  className="bg-transparent text-neutral-700 hover:cursor-pointer hover:text-neutral-900 disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled={isUpdatingName}
                >
                  {isUpdatingName ? (
                    <Loader2 size={12} className="animate-spin" />
                  ) : (
                    <Save size={12} />
                  )}
                </button>
              </div>
            ) : (
              <p className="first-letter:uppercase text-center sm:text-left"> {props.activity.name} </p>
            )}
            <Pencil
              onClick={() => !isUpdatingName && setSelectedActivity(props.activity.id)}
              className={`text-neutral-400 hover:cursor-pointer size-3 min-w-3 ${isUpdatingName ? 'opacity-50 cursor-not-allowed' : ''}`}
            />
          </div>

          {/*   Edit, View, Publish, and Delete Buttons  */}
          <div className="flex items-center gap-2 justify-end">
            <ActivityElementOptions activity={props.activity} isMobile={isMobile} />
            {/*   Publishing  */}
            <button
              className={`p-1 px-2 sm:px-3 border shadow-md rounded-md font-bold text-xs flex items-center space-x-1 transition-colors duration-200 ${
                !props.activity.published
                  ? 'bg-linear-to-bl text-green-800 from-green-400/50 to-lime-200/80 border-green-600/10 hover:from-green-500/50 hover:to-lime-300/80'
                  : 'bg-linear-to-bl text-gray-800 from-gray-400/50 to-gray-200/80 border-gray-600/10 hover:from-gray-500/50 hover:to-gray-300/80'
              }`}
              onClick={() => changePublicStatus()}
            >
              {!props.activity.published ? (
                <Globe strokeWidth={2} size={12} className="text-green-600" />
              ) : (
                <Lock strokeWidth={2} size={12} className="text-gray-600" />
              )}
              <span>{!props.activity.published ? 'Publish' : 'Unpublish'}</span>
            </button>
            <div className="w-px h-3 bg-gray-300 mx-1 self-center rounded-full hidden sm:block" />
            <ToolTip content="Preview Activity" sideOffset={8}>
              <Link
                href={
                  getUriWithOrg(props.orgslug, '') +
                  `/course/${props.course_uuid.replace(
                    'course_',
                    ''
                  )}/activity/${props.activity.activity_uuid.replace(
                    'activity_',
                    ''
                  )}`
                }
                className="p-1 px-2 sm:px-3 bg-linear-to-bl text-cyan-800 from-sky-400/50 to-cyan-200/80 border border-cyan-600/10 shadow-md rounded-md font-bold text-xs flex items-center space-x-1 transition-colors duration-200 hover:from-sky-500/50 hover:to-cyan-300/80"
                rel="noopener noreferrer"
              >
                <Eye strokeWidth={2} size={14} className="text-sky-600" />
              </Link>
            </ToolTip>
            {/*   Delete Button  */}
            <ConfirmationModal
              confirmationMessage="Are you sure you want to delete this activity ?"
              confirmationButtonText="Delete Activity"
              dialogTitle={'Delete ' + props.activity.name + ' ?'}
              dialogTrigger={
                <button
                  className="p-1 px-2 sm:px-3 bg-red-600 rounded-md flex items-center space-x-1 shadow-md transition-colors duration-200 hover:bg-red-700"
                  rel="noopener noreferrer"
                >
                  <X size={15} className="text-rose-200 font-bold" />
                </button>
              }
              functionToExecute={() => deleteActivityUI()}
              status="warning"
            />
          </div>
        </div>
      )}
    </Draggable>
  )
}

const ACTIVITIES = {
  'TYPE_VIDEO': {
    displayName: 'Video',
    Icon: Video
  },
  'TYPE_DOCUMENT': {
    displayName: 'Document',
    Icon: File
  },
  'TYPE_ASSIGNMENT': {
    displayName: 'Assignment',
    Icon: Backpack
  },
  'TYPE_DYNAMIC': {
    displayName: 'Dynamic',
    Icon: Sparkles
  }
}

const ActivityTypeIndicator = ({activityType, isMobile} : { activityType: keyof typeof ACTIVITIES, isMobile: boolean}) => {
  const {displayName, Icon} = ACTIVITIES[activityType]

  return (
    <div className={`text-gray-300 space-x-1 w-28 flex ${isMobile ? 'flex-col' : ''}`}>
      <div className="flex space-x-2 items-center">
            <Icon className="size-4" />{' '}
            <div className="text-xs bg-gray-200 text-gray-400 font-bold px-2 py-1 rounded-full mx-auto justify-center align-middle">
              {displayName}
            </div>{' '}
          </div>
    </div>
  )
}

const ActivityElementOptions = ({ activity, isMobile }: { activity: any; isMobile: boolean }) => {
  const [assignmentUUID, setAssignmentUUID] = useState('');
  const org = useOrg() as any;
  const course = useCourse() as any;
  const session = useLHSession() as any;
  const access_token = session?.data?.tokens?.access_token;

  async function getAssignmentUUIDFromActivityUUID(activityUUID: string):  Promise<string | undefined> {
    const activity = await getAssignmentFromActivityUUID(activityUUID, access_token);
    if (activity) {
      return activity.data.assignment_uuid;
    }
  }

  const fetchAssignmentUUID = async () => {
    if (activity.activity_type === 'TYPE_ASSIGNMENT') {
      const assignment_uuid = await getAssignmentUUIDFromActivityUUID(activity.activity_uuid);
      if(assignment_uuid)
        setAssignmentUUID(assignment_uuid.replace('assignment_', ''));
    }
  };

  useEffect(() => {
    fetchAssignmentUUID();
  }, [activity, course]);

  return (
    <>
      {activity.activity_type === 'TYPE_DYNAMIC' && (
        <>
          <Link
            href={
              getUriWithOrg(org.slug, '') +
              `/course/${course?.courseStructure.course_uuid.replace(
                'course_',
                ''
              )}/activity/${activity.activity_uuid.replace(
                'activity_',
                ''
              )}/edit`
            }
            className={`hover:cursor-pointer p-1 ${isMobile ? 'px-2' : 'px-3'} bg-sky-700 rounded-md items-center`}
            target='_blank'
          >
            <div className="text-sky-100 font-bold text-xs flex items-center space-x-1">
              <FilePenLine size={12} />  <span>Edit Page</span>
            </div>
          </Link>
        </>
      )}
      {activity.activity_type === 'TYPE_ASSIGNMENT' && (
        <>
          <Link
            href={
              getUriWithOrg(org.slug, '') +
              `/dash/assignments/${assignmentUUID}`
            }
            className={`hover:cursor-pointer p-1 ${isMobile ? 'px-2' : 'px-3'} bg-teal-700 rounded-md items-center`}
          >
            <div className="text-sky-100 font-bold text-xs flex items-center space-x-1">
              <FilePenLine size={12} /> {!isMobile && <span>Edit Assignment</span>}
            </div>
          </Link>
        </>
      )}
    </> 
  );
};

export default ActivityElement



================================================
FILE: apps/web/components/Dashboard/Pages/Course/EditCourseStructure/DraggableElements/ChapterElement.tsx
================================================
import ConfirmationModal from '@components/Objects/StyledElements/ConfirmationModal/ConfirmationModal'
import {
  Hexagon,
  MoreHorizontal,
  MoreVertical,
  Pencil,
  Save,
  Trash2,
} from 'lucide-react'
import React from 'react'
import { Draggable, Droppable } from '@hello-pangea/dnd'
import ActivityElement from './ActivityElement'
import NewActivityButton from '../Buttons/NewActivityButton'
import { deleteChapter, updateChapter } from '@services/courses/chapters'
import { revalidateTags } from '@services/utils/ts/requests'
import { useRouter } from 'next/navigation'
import { getAPIUrl } from '@services/config/config'
import { mutate } from 'swr'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { useCourse } from '@components/Contexts/CourseContext'

type ChapterElementProps = {
  chapter: any
  chapterIndex: number
  orgslug: string
  course_uuid: string
}

interface ModifiedChapterInterface {
  chapterId: string
  chapterName: string
}

function ChapterElement(props: ChapterElementProps) {
  const activities = props.chapter.activities || []
  const session = useLHSession() as any;
  const access_token = session?.data?.tokens?.access_token;
  const [modifiedChapter, setModifiedChapter] = React.useState<
    ModifiedChapterInterface | undefined
  >(undefined)
  const [selectedChapter, setSelectedChapter] = React.useState<
    string | undefined
  >(undefined)
  const course = useCourse() as any;
  const withUnpublishedActivities = course ? course.withUnpublishedActivities : false

  const router = useRouter()

  const deleteChapterUI = async () => {
    await deleteChapter(props.chapter.id, access_token)
    mutate(`${getAPIUrl()}courses/${props.course_uuid}/meta?with_unpublished_activities=${withUnpublishedActivities}`)
    await revalidateTags(['courses'], props.orgslug)
    router.refresh()
  }

  async function updateChapterName(chapterId: string) {
    if (modifiedChapter?.chapterId === chapterId) {
      let modifiedChapterCopy = {
        name: modifiedChapter.chapterName,
      }
      await updateChapter(chapterId, modifiedChapterCopy, access_token)
      mutate(`${getAPIUrl()}courses/${props.course_uuid}/meta?with_unpublished_activities=${withUnpublishedActivities}`)
      await revalidateTags(['courses'], props.orgslug)
      router.refresh()
    }
    setSelectedChapter(undefined)
  }

  return (
    <Draggable
      key={props.chapter.chapter_uuid}
      draggableId={props.chapter.chapter_uuid}
      index={props.chapterIndex}
    >
      {(provided, snapshot) => (
        <div
          className={`mx-2 sm:mx-4 md:mx-6 lg:mx-10 bg-white rounded-xl nice-shadow px-3 sm:px-4 md:px-6 pt-4 sm:pt-6 ${
            snapshot.isDragging ? 'shadow-xl ring-2 ring-blue-500/20 rotate-1' : ''
          }`}
          key={props.chapter.chapter_uuid}
          {...provided.draggableProps}
          {...provided.dragHandleProps}
          ref={provided.innerRef}
        >
          <div className="flex flex-wrap items-center justify-between pb-3">
            <div className="flex grow items-center space-x-2 mb-2 sm:mb-0">
              <div className="bg-neutral-100 rounded-md p-2">
                <Hexagon
                  strokeWidth={3}
                  size={16}
                  className="text-neutral-600"
                />
              </div>
              <div className="flex items-center space-x-2">
                {selectedChapter === props.chapter.id ? (
                  <div className="chapter-modification-zone bg-neutral-100 py-1 px-2 sm:px-4 rounded-lg flex items-center space-x-2">
                    <input
                      type="text"
                      className="bg-transparent outline-hidden text-sm text-neutral-700 w-full max-w-[150px] sm:max-w-none"
                      placeholder="Chapter name"
                      value={
                        modifiedChapter
                          ? modifiedChapter?.chapterName
                          : props.chapter.name
                      }
                      onChange={(e) =>
                        setModifiedChapter({
                          chapterId: props.chapter.id,
                          chapterName: e.target.value,
                        })
                      }
                    />
                    <button
                      onClick={() => updateChapterName(props.chapter.id)}
                      className="bg-transparent text-neutral-700 hover:cursor-pointer hover:text-neutral-900"
                    >
                      <Save size={15} />
                    </button>
                  </div>
                ) : (
                  <p className="text-neutral-700 first-letter:uppercase text-sm sm:text-base">
                    {props.chapter.name}
                  </p>
                )}
                <Pencil
                  size={15}
                  onClick={() => setSelectedChapter(props.chapter.id)}
                  className="text-neutral-600 hover:cursor-pointer"
                />
              </div>
            </div>
            <div className="flex items-center space-x-2">
              <MoreVertical size={15} className="text-gray-300" />
              <ConfirmationModal
                confirmationButtonText="Delete Chapter"
                confirmationMessage="Are you sure you want to delete this chapter?"
                dialogTitle={'Delete ' + props.chapter.name + ' ?'}
                dialogTrigger={
                  <button
                    className="hover:cursor-pointer p-1 px-2 sm:px-3 bg-red-600 rounded-md shadow-sm flex items-center text-rose-100 text-sm"
                    rel="noopener noreferrer"
                  >
                    <Trash2 size={15} className="text-rose-200" />
                  </button>
                }
                functionToExecute={() => deleteChapterUI()}
                status="warning"
              />
            </div>
          </div>
          <Droppable
            key={props.chapter.chapter_uuid}
            droppableId={props.chapter.chapter_uuid}
            type="activity"
          >
            {(provided, snapshot) => (
              <div 
                {...provided.droppableProps} 
                ref={provided.innerRef}
                className={`min-h-[60px] rounded-lg transition-colors duration-75 ${
                  snapshot.isDraggingOver ? 'bg-blue-50/50' : ''
                }`}
              >
                {activities.map((activity: any, index: any) => (
                  <ActivityElement
                    key={activity.activity_uuid}
                    orgslug={props.orgslug}
                    course_uuid={props.course_uuid}
                    activityIndex={index}
                    activity={activity}
                  />
                ))}
                {provided.placeholder}
              </div>
            )}
          </Droppable>
          <NewActivityButton
            orgslug={props.orgslug}
            chapterId={props.chapter.id}
          />
          <div className="h-6">
            <div className="flex items-center">
              <MoreHorizontal size={19} className="text-gray-300 mx-auto" />
            </div>
          </div>
        </div>
      )}
    </Draggable>
  )
}

export default ChapterElement



================================================
FILE: apps/web/components/Dashboard/Pages/Org/OrgEditGeneral/OrgEditGeneral.tsx
================================================
'use client'
import React from 'react'
import { Form, Formik } from 'formik'
import * as Yup from 'yup'
import {
  updateOrganization,
} from '@services/settings/org'
import { revalidateTags } from '@services/utils/ts/requests'
import { useRouter } from 'next/navigation'
import { useOrg } from '@components/Contexts/OrgContext'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { toast } from 'react-hot-toast'
import { Input } from "@components/ui/input"
import { Textarea } from "@components/ui/textarea"
import { Button } from "@components/ui/button"
import { Label } from "@components/ui/label"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@components/ui/select"
import { Switch } from "@components/ui/switch"
import { mutate } from 'swr'
import { getAPIUrl } from '@services/config/config'
import Image from 'next/image'
import learnhouseIcon from '@public/learnhouse_logo.png'
import Link from 'next/link'

const ORG_LABELS = [
  { value: 'languages', label: 'ğŸŒ Languages' },
  { value: 'business', label: 'ğŸ’° Business' },
  { value: 'ecommerce', label: 'ğŸ› E-commerce' },
  { value: 'gaming', label: 'ğŸ® Gaming' },
  { value: 'music', label: 'ğŸ¸ Music' },
  { value: 'sports', label: 'âš½ Sports' },
  { value: 'cars', label: 'ğŸš— Cars' },
  { value: 'sales_marketing', label: 'ğŸš€ Sales & Marketing' },
  { value: 'tech', label: 'ğŸ’» Tech' },
  { value: 'photo_video', label: 'ğŸ“¸ Photo & Video' },
  { value: 'pets', label: 'ğŸ• Pets' },
  { value: 'personal_development', label: 'ğŸ“š Personal Development' },
  { value: 'real_estate', label: 'ğŸ  Real Estate' },
  { value: 'beauty_fashion', label: 'ğŸ‘  Beauty & Fashion' },
  { value: 'travel', label: 'âœˆï¸ Travel' },
  { value: 'productivity', label: 'â³ Productivity' },
  { value: 'health_fitness', label: 'ğŸ Health & Fitness' },
  { value: 'finance', label: 'ğŸ“ˆ Finance' },
  { value: 'arts_crafts', label: 'ğŸ¨ Arts & Crafts' },
  { value: 'education', label: 'ğŸ“š Education' },
  { value: 'stem', label: 'ğŸ”¬ STEM' },
  { value: 'humanities', label: 'ğŸ“– Humanities' },
  { value: 'professional_skills', label: 'ğŸ’¼ Professional Skills' },
  { value: 'digital_skills', label: 'ğŸ’» Digital Skills' },
  { value: 'creative_arts', label: 'ğŸ¨ Creative Arts' },
  { value: 'social_sciences', label: 'ğŸŒ Social Sciences' },
  { value: 'test_prep', label: 'âœï¸ Test Preparation' },
  { value: 'vocational', label: 'ğŸ”§ Vocational Training' },
  { value: 'early_education', label: 'ğŸ¯ Early Education' },
] as const

const validationSchema = Yup.object().shape({
  name: Yup.string()
    .required('Name is required')
    .max(60, 'Organization name must be 60 characters or less'),
  description: Yup.string()
    .required('Short description is required')
    .max(100, 'Short description must be 100 characters or less'),
  about: Yup.string()
    .optional()
    .max(400, 'About text must be 400 characters or less'),
  label: Yup.string().required('Organization label is required'),
  explore: Yup.boolean(),
})

interface OrganizationValues {
  name: string
  description: string
  about: string
  label: string
  explore: boolean
}

const OrgEditGeneral: React.FC = () => {
  const router = useRouter()
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token
  const org = useOrg() as any

  const initialValues: OrganizationValues = {
    name: org?.name,
    description: org?.description || '',
    about: org?.about || '',
    label: org?.label || '',
    explore: org?.explore ?? false,
  }

  const updateOrg = async (values: OrganizationValues) => {
    const loadingToast = toast.loading('Updating organization...')
    try {
      await updateOrganization(org.id, values, access_token)
      await revalidateTags(['organizations'], org.slug)
      mutate(`${getAPIUrl()}orgs/slug/${org.slug}`)
      toast.success('Organization Updated', { id: loadingToast })
    } catch (err) {
      toast.error('Failed to update organization', { id: loadingToast })
    }
  }

  return (
    <div className="sm:mx-10 mx-0 bg-white rounded-xl nice-shadow ">
      <Formik
        enableReinitialize
        initialValues={initialValues}
        validationSchema={validationSchema}
        onSubmit={(values, { setSubmitting }) => {
          setTimeout(() => {
            setSubmitting(false)
            updateOrg(values)
          }, 400)
        }}
      >
        {({ isSubmitting, values, handleChange, errors, touched, setFieldValue }) => (
          <Form>
            <div className="flex flex-col gap-0">
              <div className="flex flex-col bg-gray-50 -space-y-1 px-5 py-3 mx-3 my-3 rounded-md">
                <h1 className="font-bold text-xl text-gray-800">
                  Organization Settings
                </h1>
                <h2 className="text-gray-500 text-md">
                  Manage your organization's profile and settings
                </h2>
              </div>

              <div className="flex flex-col lg:flex-row lg:space-x-8 mt-0 mx-5 my-5">
                <div className="w-full space-y-6">
                  <div className="space-y-4">
                    <div>
                      <Label htmlFor="name">
                        Organization Name
                        <span className="text-gray-500 text-sm ml-2">
                          ({60 - (values.name?.length || 0)} characters left)
                        </span>
                      </Label>
                      <Input
                        id="name"
                        name="name"
                        value={values.name}
                        onChange={handleChange}
                        placeholder="Organization Name"
                        maxLength={60}
                      />
                      {touched.name && errors.name && (
                        <p className="text-red-500 text-sm mt-1">{errors.name}</p>
                      )}
                    </div>

                    <div>
                      <Label htmlFor="description">
                        Short Description
                        <span className="text-gray-500 text-sm ml-2">
                          ({100 - (values.description?.length || 0)} characters left)
                        </span>
                      </Label>
                      <Input
                        id="description"
                        name="description"
                        value={values.description}
                        onChange={handleChange}
                        placeholder="Brief description of your organization"
                        maxLength={100}
                      />
                      {touched.description && errors.description && (
                        <p className="text-red-500 text-sm mt-1">{errors.description}</p>
                      )}
                    </div>

                    <div>
                      <Label htmlFor="label">Organization Label</Label>
                      <Select
                        value={values.label}
                        onValueChange={(value) => setFieldValue('label', value)}
                      >
                        <SelectTrigger>
                          <SelectValue placeholder="Select organization label" />
                        </SelectTrigger>
                        <SelectContent>
                          {ORG_LABELS.map((type) => (
                            <SelectItem key={type.value} value={type.value}>
                              {type.label}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                      {touched.label && errors.label && (
                        <p className="text-red-500 text-sm mt-1">{errors.label}</p>
                      )}
                    </div>

                    <div>
                      <Label htmlFor="about">
                        About Organization
                        <span className="text-gray-500 text-sm ml-2">
                          ({400 - (values.about?.length || 0)} characters left)
                        </span>
                      </Label>
                      <Textarea
                        id="about"
                        name="about"
                        value={values.about}
                        onChange={handleChange}
                        placeholder="Detailed description of your organization"
                        className="min-h-[250px]"
                        maxLength={400}
                      />
                      {touched.about && errors.about && (
                        <p className="text-red-500 text-sm mt-1">{errors.about}</p>
                      )}
                    </div>

                    

                    <div className="flex items-center justify-between space-x-2 mt-6 bg-gray-50/50 p-4 rounded-lg nice-shadow">
                      <div className="flex items-center space-x-4">
                        <Link href="https://www.learnhouse.app/explore" target="_blank" className="flex items-center space-x-2">
                          <Image
                            quality={100}
                            width={120}
                            src={learnhouseIcon}
                            alt="LearnHouse"
                            className="rounded-lg"
                          />
                          <span className="px-2 py-1 mt-1 bg-black rounded-md text-[10px] font-semibold text-white">
                            EXPLORE
                          </span>
                        </Link>
                        <div className="space-y-0.5">
                          <Label className="text-base">Showcase in LearnHouse Explore</Label>
                          <p className="text-sm text-gray-500">
                            Share your organization's courses and content with the LearnHouse community. 
                            Enable this to help learners discover your valuable educational resources.
                          </p>
                        </div>
                      </div>
                      <Switch
                        name="explore"
                        checked={values.explore ?? false}
                        onCheckedChange={(checked) => setFieldValue('explore', checked)}
                      />
                    </div>
                  </div>
                </div>
              </div>
              <div className="flex flex-row-reverse mt-0 mx-5 mb-5">
                <Button 
                  type="submit" 
                  disabled={isSubmitting}
                  className="bg-black text-white hover:bg-black/90"
                >
                  {isSubmitting ? 'Saving...' : 'Save Changes'}
                </Button>
              </div>
            </div>
          </Form>
        )}
      </Formik>
    </div>
  )
}

export default OrgEditGeneral



================================================
FILE: apps/web/components/Dashboard/Pages/Org/OrgEditImages/OrgEditImages.tsx
================================================
'use client'
import React, { useState } from 'react'
import { UploadCloud, Info, Plus, X, GripVertical, Images, StarIcon, ImageIcon } from 'lucide-react'
import { useRouter } from 'next/navigation'
import { useOrg } from '@components/Contexts/OrgContext'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { getOrgLogoMediaDirectory, getOrgPreviewMediaDirectory, getOrgThumbnailMediaDirectory } from '@services/media/media'
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@components/ui/tabs"
import { toast } from 'react-hot-toast'
import { constructAcceptValue } from '@/lib/constants'
import { uploadOrganizationLogo, uploadOrganizationThumbnail, uploadOrganizationPreview, updateOrganization } from '@services/settings/org'
import { cn } from '@/lib/utils'
import { Input } from "@components/ui/input"
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@components/ui/dialog"
import { Button } from "@components/ui/button"
import { SiLoom, SiYoutube } from '@icons-pack/react-simple-icons'
import { DragDropContext, Droppable, Draggable, DropResult } from '@hello-pangea/dnd'

const SUPPORTED_FILES = constructAcceptValue(['png', 'jpg'])

type Preview = {
  id: string;
  url: string;
  type: 'image' | 'youtube' | 'loom';
  filename?: string;
  thumbnailUrl?: string;
  order: number;
};

// Update the height constant
const PREVIEW_HEIGHT = 'h-28' // Reduced height

// Add this type for the video service selection
type VideoService = 'youtube' | 'loom' | null;

// Add this constant for consistent sizing
const DIALOG_ICON_SIZE = 'w-16 h-16'

// Add this constant at the top with other constants
const ADD_PREVIEW_OPTIONS = [
  {
    id: 'image',
    title: 'Upload Images',
    description: 'PNG, JPG (max 5MB)',
    icon: UploadCloud,
    color: 'blue',
    onClick: () => document.getElementById('previewInput')?.click()
  },
  {
    id: 'youtube',
    title: 'YouTube',
    description: 'Add YouTube video',
    icon: SiYoutube,
    color: 'red',
    onClick: (setSelectedService: Function) => setSelectedService('youtube')
  },
  {
    id: 'loom',
    title: 'Loom',
    description: 'Add Loom video',
    icon: SiLoom,
    color: 'blue',
    onClick: (setSelectedService: Function) => setSelectedService('loom')
  }
] as const;

export default function OrgEditImages() {
  const router = useRouter()
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token
  const org = useOrg() as any
  const [localLogo, setLocalLogo] = useState<string | null>(null)
  const [localThumbnail, setLocalThumbnail] = useState<string | null>(null)
  const [isLogoUploading, setIsLogoUploading] = useState(false)
  const [isThumbnailUploading, setIsThumbnailUploading] = useState(false)
  const [previews, setPreviews] = useState<Preview[]>(() => {
    // Initialize with image previews
    const imagePreviews = (org?.previews?.images || [])
      .filter((item: any) => item?.filename) // Filter out empty filenames
      .map((item: any, index: number) => ({
        id: item.filename,
        url: getOrgThumbnailMediaDirectory(org?.org_uuid, item.filename),
        filename: item.filename,
        type: 'image' as const,
        order: item.order ?? index // Use existing order or fallback to index
      }));

    // Initialize with video previews
    const videoPreviews = (org?.previews?.videos || [])
      .filter((video: any) => video && video.id)
      .map((video: any, index: number) => ({
        id: video.id,
        url: video.url,
        type: video.type as 'youtube' | 'loom',
        thumbnailUrl: video.type === 'youtube' 
          ? `https://img.youtube.com/vi/${video.id}/maxresdefault.jpg`
          : '',
        filename: '',
        order: video.order ?? (imagePreviews.length + index) // Use existing order or fallback to index after images
      }));

    const allPreviews = [...imagePreviews, ...videoPreviews];
    return allPreviews.sort((a, b) => a.order - b.order);
  });
  const [isPreviewUploading, setIsPreviewUploading] = useState(false)
  const [videoUrl, setVideoUrl] = useState('')
  const [videoDialogOpen, setVideoDialogOpen] = useState(false)
  const [selectedService, setSelectedService] = useState<VideoService>(null)

  const handleFileChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
    if (event.target.files && event.target.files.length > 0) {
      const file = event.target.files[0]
      setLocalLogo(URL.createObjectURL(file))
      setIsLogoUploading(true)
      const loadingToast = toast.loading('Uploading logo...')
      try {
        await uploadOrganizationLogo(org.id, file, access_token)
        await new Promise((r) => setTimeout(r, 1500))
        toast.success('Logo Updated', { id: loadingToast })
        router.refresh()
      } catch (err) {
        toast.error('Failed to upload logo', { id: loadingToast })
      } finally {
        setIsLogoUploading(false)
      }
    }
  }

  const handleThumbnailChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
    if (event.target.files && event.target.files.length > 0) {
      const file = event.target.files[0]
      setLocalThumbnail(URL.createObjectURL(file))
      setIsThumbnailUploading(true)
      const loadingToast = toast.loading('Uploading thumbnail...')
      try {
        await uploadOrganizationThumbnail(org.id, file, access_token)
        await new Promise((r) => setTimeout(r, 1500))
        toast.success('Thumbnail Updated', { id: loadingToast })
        router.refresh()
      } catch (err) {
        toast.error('Failed to upload thumbnail', { id: loadingToast })
      } finally {
        setIsThumbnailUploading(false)
      }
    }
  }

  const handleImageButtonClick = (inputId: string) => (event: React.MouseEvent) => {
    event.preventDefault()
    document.getElementById(inputId)?.click()
  }

  const handlePreviewUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
    if (event.target.files && event.target.files.length > 0) {
      const files = Array.from(event.target.files)
      const remainingSlots = 4 - previews.length
      
      if (files.length > remainingSlots) {
        toast.error(`You can only upload ${remainingSlots} more preview${remainingSlots === 1 ? '' : 's'}`)
        return
      }

      setIsPreviewUploading(true)
      const loadingToast = toast.loading(`Uploading ${files.length} preview${files.length === 1 ? '' : 's'}...`)
      
      try {
        const uploadPromises = files.map(async (file) => {
          const response = await uploadOrganizationPreview(org.id, file, access_token)
          return {
            id: response.name_in_disk,
            url: URL.createObjectURL(file),
            filename: response.name_in_disk,
            type: 'image' as const,
            order: previews.length // Add new items at the end
          }
        })

        const newPreviews = await Promise.all(uploadPromises)
        const updatedPreviews = [...previews, ...newPreviews]
        
        await updateOrganization(org.id, {
          previews: {
            images: updatedPreviews
              .filter(p => p.type === 'image')
              .map(p => ({ 
                filename: p.filename,
                order: p.order 
              })),
            videos: updatedPreviews
              .filter(p => p.type === 'youtube' || p.type === 'loom')
              .map(p => ({ 
                type: p.type, 
                url: p.url, 
                id: p.id,
                order: p.order 
              }))
          }
        }, access_token)

        setPreviews(updatedPreviews)
        toast.success(`${files.length} preview${files.length === 1 ? '' : 's'} added`, { id: loadingToast })
        router.refresh()
      } catch (err) {
        toast.error('Failed to upload previews', { id: loadingToast })
      } finally {
        setIsPreviewUploading(false)
      }
    }
  }

  const removePreview = async (id: string) => {
    const loadingToast = toast.loading('Removing preview...')
    try {
      const updatedPreviews = previews.filter(p => p.id !== id)
      const updatedPreviewFilenames = updatedPreviews.map(p => p.filename)

      await updateOrganization(org.id, {
        previews: {
          images: updatedPreviewFilenames
        }
      }, access_token)

      setPreviews(updatedPreviews)
      toast.success('Preview removed', { id: loadingToast })
      router.refresh()
    } catch (err) {
      toast.error('Failed to remove preview', { id: loadingToast })
    }
  }

  const extractVideoId = (url: string, type: 'youtube' | 'loom'): string | null => {
    if (type === 'youtube') {
      const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/
      const match = url.match(regex)
      return match ? match[1] : null
    } else if (type === 'loom') {
      const regex = /(?:loom\.com\/(?:share|embed)\/)([a-zA-Z0-9]+)/
      const match = url.match(regex)
      return match ? match[1] : null
    }
    return null
  }

  const handleVideoSubmit = async (type: 'youtube' | 'loom') => {
    const videoId = extractVideoId(videoUrl, type);
    if (!videoId) {
      toast.error(`Invalid ${type} URL`);
      return;
    }

    // Check if video already exists
    if (previews.some(preview => preview.id === videoId)) {
      toast.error('This video has already been added');
      return;
    }

    const loadingToast = toast.loading('Adding video preview...');
    
    try {
      const thumbnailUrl = type === 'youtube' 
        ? `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`
        : '';

      const newPreview: Preview = {
        id: videoId,
        url: videoUrl,
        type,
        thumbnailUrl,
        filename: '',
        order: previews.length // Add new items at the end
      };

      const updatedPreviews = [...previews, newPreview];
      
      await updateOrganization(org.id, {
        previews: {
          images: updatedPreviews
            .filter(p => p.type === 'image')
            .map(p => ({ 
              filename: p.filename,
              order: p.order 
            })),
          videos: updatedPreviews
            .filter(p => p.type === 'youtube' || p.type === 'loom')
            .map(p => ({ 
              type: p.type, 
              url: p.url, 
              id: p.id,
              order: p.order 
            }))
        }
      }, access_token);

      setPreviews(updatedPreviews);
      setVideoUrl('');
      setVideoDialogOpen(false);
      toast.success('Video preview added', { id: loadingToast });
      router.refresh();
    } catch (err) {
      toast.error('Failed to add video preview', { id: loadingToast });
    }
  };

  const handleDragEnd = async (result: DropResult) => {
    if (!result.destination) return;

    const items = Array.from(previews);
    const [reorderedItem] = items.splice(result.source.index, 1);
    items.splice(result.destination.index, 0, reorderedItem);

    // Update order numbers
    const reorderedItems = items.map((item, index) => ({
      ...item,
      order: index
    }));

    setPreviews(reorderedItems);

    // Update the order in the backend
    const loadingToast = toast.loading('Updating preview order...');
    try {
      await updateOrganization(org.id, {
        previews: {
          images: reorderedItems
            .filter(p => p.type === 'image')
            .map(p => ({ 
              filename: p.filename,
              order: p.order 
            })),
          videos: reorderedItems
            .filter(p => p.type === 'youtube' || p.type === 'loom')
            .map(p => ({ 
              type: p.type, 
              url: p.url, 
              id: p.id,
              order: p.order 
            }))
        }
      }, access_token);
      
      toast.success('Preview order updated', { id: loadingToast });
      router.refresh();
    } catch (err) {
      toast.error('Failed to update preview order', { id: loadingToast });
      setPreviews(previews);
    }
  };

  // Add function to reset video dialog state
  const resetVideoDialog = () => {
    setSelectedService(null)
    setVideoUrl('')
  }

  return (
    <div className="sm:mx-10 mx-0 bg-white rounded-xl nice-shadow px-3 py-3 sm:mb-0 mb-16">
      <div className="flex flex-col bg-gray-50 -space-y-1 px-5 py-3 mb-2 rounded-md">
        <h1 className="font-bold text-xl text-gray-800">
          Images & Previews
        </h1>
        <h2 className="text-gray-500 text-md">
          Manage your organization's logo, thumbnail, and preview images
        </h2>
      </div>
      <Tabs defaultValue="logo" className="w-full">
        <TabsList className="grid w-full grid-cols-3 p-1 bg-gray-100 rounded-lg">
          <TabsTrigger 
            value="logo" 
            className="data-[state=active]:bg-white data-[state=active]:shadow-xs transition-all flex items-center space-x-2"
          >
            <StarIcon size={16} />
            <span>Logo</span>
          </TabsTrigger>
          <TabsTrigger 
            value="thumbnail"
            className="data-[state=active]:bg-white data-[state=active]:shadow-xs transition-all flex items-center space-x-2"
          >
            <ImageIcon size={16} />
            <span>Thumbnail</span>
          </TabsTrigger>
          <TabsTrigger 
            value="previews"
            className="data-[state=active]:bg-white data-[state=active]:shadow-xs transition-all flex items-center space-x-2"
          >
            <Images size={16} />
            <span>Previews</span>
          </TabsTrigger>
        </TabsList>

        <TabsContent value="logo" className="mt-2">
          <div className="flex flex-col space-y-5 w-full">
            <div className="w-full bg-linear-to-b from-gray-50 to-white rounded-xl  transition-all duration-300 py-8">
              <div className="flex flex-col justify-center items-center space-y-8">
                <div className="relative group">
                  <div
                    className={cn(
                      "w-[200px] sm:w-[250px] h-[100px] sm:h-[125px] bg-contain bg-no-repeat bg-center rounded-lg shadow-md bg-white",
                      "border-2 border-gray-100 hover:border-blue-200 transition-all duration-300",
                      isLogoUploading && "opacity-50"
                    )}
                    style={{ backgroundImage: `url(${localLogo || getOrgLogoMediaDirectory(org?.org_uuid, org?.logo_image)})` }}
                  />
                </div>

                <div className="flex flex-col items-center space-y-4">
                  <input
                    type="file"
                    id="fileInput"
                    accept={SUPPORTED_FILES}
                    className="hidden"
                    onChange={handleFileChange}
                  />
                  <button
                    type="button"
                    disabled={isLogoUploading}
                    className={cn(
                      "font-medium text-sm px-6 py-2.5 rounded-full",
                      "bg-linear-to-r from-blue-500 to-blue-600 text-white",
                      "hover:from-blue-600 hover:to-blue-700",
                      "shadow-xs hover:shadow-sm transition-all duration-300",
                      "flex items-center space-x-2",
                      isLogoUploading && "opacity-75 cursor-not-allowed"
                    )}
                    onClick={handleImageButtonClick('fileInput')}
                  >
                    <UploadCloud size={18} className={cn("", isLogoUploading && "animate-bounce")} />
                    <span>{isLogoUploading ? 'Uploading...' : 'Upload New Logo'}</span>
                  </button>

                  <div className="flex flex-col text-xs space-y-2 items-center text-gray-500">
                    <div className="flex items-center space-x-2 bg-blue-50 text-blue-700 px-3 py-1.5 rounded-full">
                      <Info size={14} />
                      <p className="font-medium">Accepts PNG, JPG (max 5MB)</p>
                    </div>
                    <p className="text-gray-400">Recommended size: 200x100 pixels</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </TabsContent>

        <TabsContent value="thumbnail" className="mt-2">
          <div className="flex flex-col space-y-5 w-full">
            <div className="w-full bg-linear-to-b from-gray-50 to-white rounded-xl  transition-all duration-300 py-8">
              <div className="flex flex-col justify-center items-center space-y-8">
                <div className="relative group">
                  <div
                    className={cn(
                      "w-[200px] sm:w-[250px] h-[100px] sm:h-[125px] bg-contain bg-no-repeat bg-center rounded-lg shadow-md bg-white",
                      "border-2 border-gray-100 hover:border-purple-200 transition-all duration-300",
                      isThumbnailUploading && "opacity-50"
                    )}
                    style={{ backgroundImage: `url(${localThumbnail || getOrgThumbnailMediaDirectory(org?.org_uuid, org?.thumbnail_image)})` }}
                  />
                </div>

                <div className="flex flex-col items-center space-y-4">
                  <input
                    type="file"
                    id="thumbnailInput"
                    accept={SUPPORTED_FILES}
                    className="hidden"
                    onChange={handleThumbnailChange}
                  />
                  <button
                    type="button"
                    disabled={isThumbnailUploading}
                    className={cn(
                      "font-medium text-sm px-6 py-2.5 rounded-full",
                      "bg-linear-to-r from-purple-500 to-purple-600 text-white",
                      "hover:from-purple-600 hover:to-purple-700",
                      "shadow-xs hover:shadow-sm transition-all duration-300",
                      "flex items-center space-x-2",
                      isThumbnailUploading && "opacity-75 cursor-not-allowed"
                    )}
                    onClick={handleImageButtonClick('thumbnailInput')}
                  >
                    <UploadCloud size={18} className={cn("", isThumbnailUploading && "animate-bounce")} />
                    <span>{isThumbnailUploading ? 'Uploading...' : 'Upload New Thumbnail'}</span>
                  </button>

                  <div className="flex flex-col text-xs space-y-2 items-center text-gray-500">
                    <div className="flex items-center space-x-2 bg-purple-50 text-purple-700 px-3 py-1.5 rounded-full">
                      <Info size={14} />
                      <p className="font-medium">Accepts PNG, JPG (max 5MB)</p>
                    </div>
                    <p className="text-gray-400">Recommended size: 200x100 pixels</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </TabsContent>

        <TabsContent value="previews" className="mt-4">
          <div className="flex flex-col space-y-5 w-full">
            <div className="w-full bg-linear-to-b from-gray-50 to-white rounded-xl transition-all duration-300 py-6">
              <div className="flex flex-col justify-center items-center space-y-6">
                <DragDropContext onDragEnd={handleDragEnd}>
                  <Droppable droppableId="previews" direction="horizontal">
                    {(provided) => (
                      <div 
                        className={cn(
                          "flex gap-4 w-full max-w-5xl p-4 overflow-x-auto pb-6",
                          previews.length === 0 && "justify-center"
                        )}
                        {...provided.droppableProps}
                        ref={provided.innerRef}
                      >
                        {previews.map((preview, index) => (
                          <Draggable 
                            key={preview.id} 
                            draggableId={preview.id} 
                            index={index}
                          >
                            {(provided, snapshot) => (
                              <div
                                ref={provided.innerRef}
                                {...provided.draggableProps}
                                className={cn(
                                  "relative group shrink-0",
                                  "w-48",
                                  snapshot.isDragging ? "scale-105 z-50" : "hover:scale-102",
                                )}
                              >
                                <button
                                  onClick={() => removePreview(preview.id)}
                                  className={cn(
                                    "absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full p-1.5",
                                    "opacity-0 group-hover:opacity-100 z-10 shadow-xs",
                                    "transition-opacity duration-200"
                                  )}
                                >
                                  <X size={14} />
                                </button>
                                <div
                                  {...provided.dragHandleProps}
                                  className={cn(
                                    "absolute -top-2 -left-2 bg-gray-600 hover:bg-gray-700 text-white rounded-full p-1.5",
                                    "opacity-0 group-hover:opacity-100 cursor-grab active:cursor-grabbing z-10 shadow-xs",
                                    "transition-opacity duration-200"
                                  )}
                                >
                                  <GripVertical size={14} />
                                </div>
                                {preview.type === 'image' ? (
                                  <div
                                    className={cn(
                                      `w-full ${PREVIEW_HEIGHT} bg-contain bg-no-repeat bg-center rounded-xl bg-white`,
                                      "border border-gray-200 hover:border-gray-300",
                                      "transition-colors duration-200",
                                      snapshot.isDragging ? "shadow-lg" : "shadow-xs hover:shadow-md"
                                    )}
                                    style={{ 
                                      backgroundImage: `url(${getOrgPreviewMediaDirectory(org?.org_uuid, preview.id)})`,
                                    }}
                                  />
                                ) : (
                                  <div className={cn(
                                    `w-full ${PREVIEW_HEIGHT} relative rounded-xl overflow-hidden`,
                                    "border border-gray-200 hover:border-gray-300 transition-colors duration-200",
                                    snapshot.isDragging ? "shadow-lg" : "shadow-xs hover:shadow-md"
                                  )}>
                                    <div
                                      className="absolute inset-0 bg-cover bg-center"
                                      style={{ backgroundImage: `url(${preview.thumbnailUrl})` }}
                                    />
                                    <div className="absolute inset-0 bg-black bg-opacity-40 backdrop-blur-[2px] flex items-center justify-center">
                                      {preview.type === 'youtube' ? (
                                        <SiYoutube className="w-10 h-10 text-red-500" />
                                      ) : (
                                        <SiLoom className="w-10 h-10 text-blue-500" />
                                      )}
                                    </div>
                                  </div>
                                )}
                              </div>
                            )}
                          </Draggable>
                        ))}
                        {provided.placeholder}
                        {previews.length < 4 && (
                          <div className={cn(
                            "shrink-0 w-48",
                            previews.length === 0 && "m-0"
                          )}>
                            <Dialog open={videoDialogOpen} onOpenChange={(open) => {
                              setVideoDialogOpen(open);
                              if (!open) resetVideoDialog();
                            }}>
                              <DialogTrigger asChild>
                                <button
                                  className={cn(
                                    `w-full ${PREVIEW_HEIGHT}`,
                                    "border-2 border-dashed border-gray-200 rounded-xl",
                                    "hover:border-blue-300 hover:bg-blue-50/50 transition-all duration-200",
                                    "flex flex-col items-center justify-center space-y-2 group"
                                  )}
                                >
                                  <div className="bg-blue-50 rounded-full p-2 group-hover:bg-blue-100 transition-colors duration-200">
                                    <Plus size={20} className="text-blue-500" />
                                  </div>
                                  <span className="text-sm font-medium text-gray-600">Add Preview</span>
                                </button>
                              </DialogTrigger>
                              <DialogContent className="sm:max-w-[600px]">
                                <DialogHeader>
                                  <DialogTitle>Add Preview</DialogTitle>
                                </DialogHeader>
                                <div className={cn(
                                  "p-6",
                                  selectedService ? "space-y-4" : "grid grid-cols-3 gap-6"
                                )}>
                                  {!selectedService ? (
                                    <>
                                      {ADD_PREVIEW_OPTIONS.map((option) => (
                                        <button
                                          key={option.id}
                                          onClick={() => option.id === 'image' 
                                            ? option.onClick()
                                            : option.onClick(setSelectedService)
                                          }
                                          className={cn(
                                            "w-full aspect-square rounded-2xl border-2 border-dashed",
                                            `hover:border-${option.color}-300 hover:bg-${option.color}-50/50`,
                                            "transition-all duration-200",
                                            "flex flex-col items-center justify-center space-y-4",
                                            option.id === 'image' && isPreviewUploading && "opacity-50 cursor-not-allowed"
                                          )}
                                        >
                                          <div className={cn(
                                            DIALOG_ICON_SIZE,
                                            `rounded-full bg-${option.color}-50`,
                                            "flex items-center justify-center"
                                          )}>
                                            <option.icon className={`w-8 h-8 text-${option.color}-500`} />
                                          </div>
                                          <div className="text-center">
                                            <p className="font-medium text-gray-700">{option.title}</p>
                                            <p className="text-sm text-gray-500 mt-1">{option.description}</p>
                                          </div>
                                        </button>
                                      ))}
                                      <input
                                        type="file"
                                        id="previewInput"
                                        accept={SUPPORTED_FILES}
                                        className="hidden"
                                        onChange={handlePreviewUpload}
                                        multiple
                                      />
                                    </>
                                  ) : (
                                    <div className="space-y-4">
                                      <div className="flex items-center justify-between">
                                        <div className="flex items-center space-x-3">
                                          <div className={cn(
                                            "w-10 h-10 rounded-full flex items-center justify-center",
                                            selectedService === 'youtube' ? "bg-red-50" : "bg-blue-50"
                                          )}>
                                            {selectedService === 'youtube' ? (
                                              <SiYoutube className="w-5 h-5 text-red-500" />
                                            ) : (
                                              <SiLoom className="w-5 h-5 text-blue-500" />
                                            )}
                                          </div>
                                          <div>
                                            <h3 className="font-medium text-gray-900">
                                              {selectedService === 'youtube' ? 'Add YouTube Video' : 'Add Loom Video'}
                                            </h3>
                                            <p className="text-sm text-gray-500">
                                              {selectedService === 'youtube' 
                                                ? 'Paste your YouTube video URL' 
                                                : 'Paste your Loom video URL'}
                                            </p>
                                          </div>
                                        </div>
                                        <button
                                          onClick={() => setSelectedService(null)}
                                          className="text-gray-400 hover:text-gray-500 transition-colors"
                                        >
                                          <X size={20} />
                                        </button>
                                      </div>

                                      <div className="space-y-3">
                                        <Input
                                          id="videoUrlInput"
                                          placeholder={selectedService === 'youtube' 
                                            ? 'https://youtube.com/watch?v=...' 
                                            : 'https://www.loom.com/share/...'}
                                          value={videoUrl}
                                          onChange={(e) => setVideoUrl(e.target.value)}
                                          className="w-full"
                                          autoFocus
                                        />
                                        <Button
                                          onClick={() => handleVideoSubmit(selectedService)}
                                          className={cn(
                                            "w-full",
                                            selectedService === 'youtube' 
                                              ? "bg-red-500 hover:bg-red-600" 
                                              : "bg-blue-500 hover:bg-blue-600"
                                          )}
                                          disabled={!videoUrl}
                                        >
                                          Add Video
                                        </Button>
                                      </div>
                                    </div>
                                  )}
                                </div>
                              </DialogContent>
                            </Dialog>
                          </div>
                        )}
                      </div>
                    )}
                  </Droppable>
                </DragDropContext>
                
                <div className="flex items-center space-x-2 bg-gray-50 text-gray-600 px-4 py-2 rounded-full">
                  <Info size={14} />
                  <p className="text-sm">Drag to reorder â€¢ Maximum 4 previews â€¢ Supports images & videos</p>
                </div>
              </div>
            </div>
          </div>
        </TabsContent>
      </Tabs>
    </div>
  )
}



================================================
FILE: apps/web/components/Dashboard/Pages/Org/OrgEditLanding/landing_types.ts
================================================
export interface LandingBackground {
  type: 'solid' | 'gradient' | 'image';
  color?: string;
  colors?: Array<string>;
  direction?: string;
  image?: string;
}

export interface LandingTestimonialContent {
  text: string;
  author: string;
}

export interface LandingImage {
  url: string;
  alt: string;
}

export interface LandingHeading {
  text: string;
  color: string;
  size: string;
}

export interface LandingButton {
  text: string;
  link: string;
  color: string;
  background: string;
}

export interface LandingLogos {
  type: 'logos';
  title: string;
  logos: LandingImage[];
}

export interface LandingUsers {
  user_uuid: string;
  name: string;
  description: string;
  image_url: string;
  username?: string;
}

export interface LandingPeople {
  type: 'people';
  title: string;
  people: LandingUsers[];
}

export interface LandingTextAndImageSection {
  type: 'text-and-image';
  title: string;
  text: string;
  flow: 'left' | 'right';
  image: LandingImage;
  buttons: LandingButton[];
}

export interface LandingCourse {
  course_uuid: string;
}

export interface LandingFeaturedCourses {
  type: 'featured-courses';
  courses: LandingCourse[];
  title: string;
}

export interface LandingHeroSection {
  type: 'hero';
  title: string;
  background: LandingBackground;
  heading: LandingHeading;
  subheading: LandingHeading;
  buttons: LandingButton[];
  illustration?: {
    image: LandingImage;
    position: 'left' | 'right';
    verticalAlign: 'top' | 'center' | 'bottom';
    size: 'small' | 'medium' | 'large';
  };
  contentAlign?: 'left' | 'center' | 'right';
}

export type LandingSection = LandingTextAndImageSection | LandingHeroSection | LandingLogos | LandingPeople | LandingFeaturedCourses;

export interface LandingObject {
  sections: LandingSection[];
  enabled?: boolean;
} 


================================================
FILE: apps/web/components/Dashboard/Pages/Org/OrgEditOther/OrgEditOther.tsx
================================================
'use client'
import React from 'react'
import { Form, Formik } from 'formik'
import * as Yup from 'yup'
import { updateOrganization } from '@services/settings/org'
import { revalidateTags } from '@services/utils/ts/requests'
import { useRouter } from 'next/navigation'
import { useOrg } from '@components/Contexts/OrgContext'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { toast } from 'react-hot-toast'
import { Button } from "@components/ui/button"
import { Label } from "@components/ui/label"
import { Textarea } from "@components/ui/textarea"
import { Code2, Plus, Trash2, PencilLine, AlertTriangle } from "lucide-react"
import { mutate } from 'swr'
import { getAPIUrl } from '@services/config/config'
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip"

interface Script {
  name: string
  content: string
}

interface OrganizationScripts {
  scripts: Script[]
}

const validationSchema = Yup.object().shape({
  name: Yup.string().required('Script name is required'),
  content: Yup.string().required('Script content is required')
})

const OrgEditOther: React.FC = () => {
  const router = useRouter()
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token
  const org = useOrg() as any
  const [selectedView, setSelectedView] = React.useState<'list' | 'edit'>('list')
  const [scripts, setScripts] = React.useState<Script[]>([])
  const [currentScript, setCurrentScript] = React.useState<Script | null>(null)

  // Initialize scripts from org
  React.useEffect(() => {
    if (org?.scripts?.scripts) {
      setScripts(Array.isArray(org.scripts.scripts) ? org.scripts.scripts : [])
    } else {
      setScripts([])
    }
  }, [org])

  const updateOrg = async (values: Script) => {
    const loadingToast = toast.loading('Updating organization...')
    try {
      let updatedScripts: Script[]
      
      if (currentScript) {
        // Edit existing script
        updatedScripts = scripts.map(script => 
          script.name === currentScript.name ? values : script
        )
      } else {
        // Add new script
        updatedScripts = [...scripts, values]
      }

      // Create a new organization object with scripts array wrapped in an object
      const updateData = {
        id: org.id,
        scripts: {
          scripts: updatedScripts
        }
      }
      
      await updateOrganization(org.id, updateData, access_token)
      await revalidateTags(['organizations'], org.slug)
      mutate(`${getAPIUrl()}orgs/slug/${org.slug}`)
      setScripts(updatedScripts)
      setSelectedView('list')
      setCurrentScript(null)
      toast.success('Script saved successfully', { id: loadingToast })
    } catch (err) {
      console.error('Error updating organization:', err)
      toast.error('Failed to save script', { id: loadingToast })
    }
  }

  const deleteScript = async (scriptToDelete: Script) => {
    const loadingToast = toast.loading('Deleting script...')
    try {
      const updatedScripts = scripts.filter(script => script.name !== scriptToDelete.name)
      
      // Create a new organization object with scripts array wrapped in an object
      const updateData = {
        id: org.id,
        scripts: {
          scripts: updatedScripts
        }
      }

      await updateOrganization(org.id, updateData, access_token)
      await revalidateTags(['organizations'], org.slug)
      mutate(`${getAPIUrl()}orgs/slug/${org.slug}`)
      setScripts(updatedScripts)
      toast.success('Script deleted successfully', { id: loadingToast })
    } catch (err) {
      console.error('Error deleting script:', err)
      toast.error('Failed to delete script', { id: loadingToast })
    }
  }

  return (
    <div className="sm:mx-10 mx-0 bg-white rounded-xl nice-shadow">
      <div className="pt-0.5">
        <div className="flex flex-col bg-gray-50 -space-y-1 px-5 py-3 mx-3 my-3 rounded-md">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="font-bold text-xl text-gray-800 flex items-center space-x-2">
                <Code2 className="h-5 w-5" />
                <span>Scripts</span>
                <TooltipProvider delayDuration={100}>
                  <Tooltip>
                    <TooltipTrigger>
                      <AlertTriangle className="h-4 w-4 text-orange-500 hover:text-orange-600 transition-colors" />
                    </TooltipTrigger>
                    <TooltipContent 
                      className="max-w-[400px] bg-orange-50 border-orange-100 text-orange-900 [&>p]:text-orange-800 data-[side=bottom]:slide-in-from-top-1 data-[side=left]:slide-in-from-right-1 data-[side=right]:slide-in-from-left-1 data-[side=top]:slide-in-from-bottom-1"
                      sideOffset={8}
                    >
                      <p className="p-2 leading-relaxed">For your organization's safety, please ensure you trust and understand any scripts before adding them. Scripts can interact with your organization's pages.</p>
                    </TooltipContent>
                  </Tooltip>
                </TooltipProvider>
              </h1>
              <h2 className="text-gray-500 text-md">
                Add custom JavaScript scripts to your organization
              </h2>
            </div>
            {selectedView === 'list' && (
              <Button
                onClick={() => {
                  setCurrentScript(null)
                  setSelectedView('edit')
                }}
                className="bg-black text-white hover:bg-black/90"
              >
                <Plus className="h-4 w-4 mr-2" />
                Add Script
              </Button>
            )}
          </div>
        </div>
      </div>

      <div className="p-4 pt-1">
        {selectedView === 'list' ? (
          <div className="space-y-4">
            {(!scripts || scripts.length === 0) ? (
              <div className="text-center py-8 px-4 text-gray-500 bg-gray-50/50 rounded-lg border border-dashed border-gray-200">
                <Code2 className="h-8 w-8 mx-auto mb-2 text-gray-400" />
                <p className="text-sm font-medium">No scripts added yet</p>
                <p className="text-xs text-gray-400 mt-1">Add your first script to get started</p>
              </div>
            ) : (
              scripts.map((script, index) => (
                <div
                  key={index}
                  className="group p-4 rounded-lg bg-gray-50/50 hover:bg-gray-100/80 transition-colors duration-150 border border-gray-200"
                >
                  <div className="flex items-start justify-between">
                    <div className="space-y-2 min-w-0 flex-1">
                      <div className="flex items-baseline space-x-2">
                        <h4 className="text-sm font-medium text-gray-800 truncate">{script.name}</h4>
                      </div>
                      <pre className="text-sm text-gray-600 font-mono bg-white/80 p-2 rounded border border-gray-200 overflow-x-auto">
                        {script.content.length > 100 
                          ? script.content.substring(0, 100) + '...' 
                          : script.content}
                      </pre>
                    </div>
                    <div className="ml-4 flex space-x-2">
                      <Button
                        variant="ghost"
                        size="icon"
                        className="text-gray-400 hover:text-blue-500 hover:bg-blue-50"
                        onClick={() => {
                          setCurrentScript(script)
                          setSelectedView('edit')
                        }}
                      >
                        <PencilLine className="h-4 w-4" />
                      </Button>
                      <Button
                        variant="ghost"
                        size="icon"
                        className="text-gray-400 hover:text-red-500 hover:bg-red-50"
                        onClick={() => deleteScript(script)}
                      >
                        <Trash2 className="h-4 w-4" />
                      </Button>
                    </div>
                  </div>
                </div>
              ))
            )}
          </div>
        ) : (
          <Formik
            initialValues={currentScript || { name: '', content: '' }}
            validationSchema={validationSchema}
            onSubmit={(values, { setSubmitting }) => {
              setSubmitting(false)
              updateOrg(values)
            }}
          >
            {({ values, handleChange, handleSubmit, errors, touched, isSubmitting }) => (
              <Form onSubmit={handleSubmit}>
                <div className="space-y-4">
                  <div>
                    <Label htmlFor="name">Script Name</Label>
                    <input
                      type="text"
                      id="name"
                      name="name"
                      value={values.name}
                      onChange={handleChange}
                      className="mt-1 w-full px-3 py-2 border rounded-md"
                      placeholder="Enter script name"
                    />
                    {touched.name && errors.name && (
                      <p className="text-red-500 text-sm mt-1">{errors.name}</p>
                    )}
                  </div>
                  <div>
                    <Label htmlFor="content">Script Content</Label>
                    <Textarea
                      id="content"
                      name="content"
                      value={values.content}
                      onChange={handleChange}
                      className="mt-1 font-mono"
                      placeholder="Enter JavaScript code"
                      rows={10}
                    />
                    {touched.content && errors.content && (
                      <p className="text-red-500 text-sm mt-1">{errors.content}</p>
                    )}
                  </div>
                  <div className="flex justify-end space-x-3">
                    <Button
                      type="button"
                      variant="outline"
                      onClick={() => {
                        setSelectedView('list')
                        setCurrentScript(null)
                      }}
                    >
                      Cancel
                    </Button>
                    <Button 
                      type="submit"
                      disabled={isSubmitting}
                      className="bg-black text-white hover:bg-black/90"
                    >
                      {isSubmitting ? 'Saving...' : 'Save Script'}
                    </Button>
                  </div>
                </div>
              </Form>
            )}
          </Formik>
        )}
      </div>
    </div>
  )
}

export default OrgEditOther 


================================================
FILE: apps/web/components/Dashboard/Pages/Org/OrgEditSocials/OrgEditSocials.tsx
================================================
'use client'
import React from 'react'
import { Form, Formik } from 'formik'
import { updateOrganization } from '@services/settings/org'
import { revalidateTags } from '@services/utils/ts/requests'
import { useOrg } from '@components/Contexts/OrgContext'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { toast } from 'react-hot-toast'
import { Input } from "@components/ui/input"
import { Button } from "@components/ui/button"
import { Label } from "@components/ui/label"
import { 
  SiX, 
  SiFacebook, 
  SiInstagram, 
  SiYoutube 
} from '@icons-pack/react-simple-icons'
import { Plus, X as XIcon } from "lucide-react"
import { useRouter } from 'next/navigation'
import { mutate } from 'swr'
import { getAPIUrl } from '@services/config/config'

interface OrganizationValues {
  socials: {
    twitter?: string
    facebook?: string
    instagram?: string
    linkedin?: string
    youtube?: string
  }
  links: {
    [key: string]: string
  }
}

export default function OrgEditSocials() {
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token
  const org = useOrg() as any
  const router = useRouter()
  const initialValues: OrganizationValues = {
    socials: org?.socials || {},
    links: org?.links || {}
  }

  const updateOrg = async (values: OrganizationValues) => {
    const loadingToast = toast.loading('Updating organization...')
    try {
      await updateOrganization(org.id, values, access_token)
      await revalidateTags(['organizations'], org.slug)

      mutate(`${getAPIUrl()}orgs/slug/${org.slug}`)
      toast.success('Organization Updated', { id: loadingToast })
    } catch (err) {
      toast.error('Failed to update organization', { id: loadingToast })
    }
  }

  return (
    <div className="sm:mx-10 mx-0 bg-white rounded-xl nice-shadow">
      <Formik
        enableReinitialize
        initialValues={initialValues}
        onSubmit={(values, { setSubmitting }) => {
          setTimeout(() => {
            setSubmitting(false)
            updateOrg(values)
          }, 400)
        }}
      >
        {({ isSubmitting, values, handleChange, setFieldValue }) => (
          <Form>
            <div className="flex flex-col gap-0">
              <div className="flex flex-col bg-gray-50 -space-y-1 px-5 py-3 mx-3 my-3 rounded-md">
                <h1 className="font-bold text-xl text-gray-800">
                  Social Links
                </h1>
                <h2 className="text-gray-500 text-md">
                  Manage your organization's social media presence
                </h2>
              </div>

              <div className="flex flex-col lg:flex-row lg:space-x-8 mt-0 mx-5 my-5">
                <div className="w-full space-y-6">
                  <div>
                    <Label className="text-lg font-semibold">Social Links</Label>
                    <div className="space-y-3 bg-gray-50/50 p-4 rounded-lg nice-shadow mt-2">
                      <div className="grid gap-3">
                        <div className="flex items-center space-x-3">
                          <div className="w-8 h-8 flex items-center justify-center bg-[#1DA1F2]/10 rounded-md">
                            <SiX size={16} color="#1DA1F2"/>
                          </div>
                          <Input
                            id="socials.twitter"
                            name="socials.twitter"
                            value={values.socials.twitter || ''}
                            onChange={handleChange}
                            placeholder="Twitter profile URL"
                            className="h-9 bg-white"
                          />
                        </div>

                        <div className="flex items-center space-x-3">
                          <div className="w-8 h-8 flex items-center justify-center bg-[#1877F2]/10 rounded-md">
                            <SiFacebook size={16} color="#1877F2"/>
                          </div>
                          <Input
                            id="socials.facebook"
                            name="socials.facebook"
                            value={values.socials.facebook || ''}
                            onChange={handleChange}
                            placeholder="Facebook profile URL"
                            className="h-9 bg-white"
                          />
                        </div>

                        <div className="flex items-center space-x-3">
                          <div className="w-8 h-8 flex items-center justify-center bg-[#E4405F]/10 rounded-md">
                            <SiInstagram size={16} color="#E4405F"/>
                          </div>
                          <Input
                            id="socials.instagram"
                            name="socials.instagram"
                            value={values.socials.instagram || ''}
                            onChange={handleChange}
                            placeholder="Instagram profile URL"
                            className="h-9 bg-white"
                          />
                        </div>

                        <div className="flex items-center space-x-3">
                          <div className="w-8 h-8 flex items-center justify-center bg-[#FF0000]/10 rounded-md">
                            <SiYoutube size={16} color="#FF0000"/>
                          </div>
                          <Input
                            id="socials.youtube"
                            name="socials.youtube"
                            value={values.socials.youtube || ''}
                            onChange={handleChange}
                            placeholder="YouTube channel URL"
                            className="h-9 bg-white"
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div className="w-full space-y-6">
                  <div>
                    <Label className="text-lg font-semibold">Custom Links</Label>
                    <div className="space-y-3 bg-gray-50/50 p-4 rounded-lg nice-shadow mt-2">
                      {Object.entries(values.links).map(([linkKey, linkValue], index) => (
                        <div key={index} className="flex gap-3 items-center">
                          <div className="w-8 h-8 flex items-center justify-center bg-gray-200/50 rounded-md text-xs font-medium text-gray-600">
                            {index + 1}
                          </div>
                          <div className="flex-1 flex gap-2">
                            <Input
                              placeholder="Label"
                              value={linkKey}
                              className="h-9 w-1/3 bg-white"
                              onChange={(e) => {
                                const newLinks = { ...values.links };
                                delete newLinks[linkKey];
                                newLinks[e.target.value] = linkValue;
                                setFieldValue('links', newLinks);
                              }}
                            />
                            <Input
                              placeholder="URL"
                              value={linkValue}
                              className="h-9 flex-1 bg-white"
                              onChange={(e) => {
                                const newLinks = { ...values.links };
                                newLinks[linkKey] = e.target.value;
                                setFieldValue('links', newLinks);
                              }}
                            />
                            <Button
                              type="button"
                              variant="ghost"
                              size="icon"
                              onClick={() => {
                                const newLinks = { ...values.links };
                                delete newLinks[linkKey];
                                setFieldValue('links', newLinks);
                              }}
                            >
                              <XIcon className="h-4 w-4" />
                            </Button>
                          </div>
                        </div>
                      ))}
                      
                      {Object.keys(values.links).length < 3 && (
                        <Button
                          type="button"
                          variant="outline"
                          size="sm"
                          className="mt-2"
                          onClick={() => {
                            const newLinks = { ...values.links };
                            newLinks[`Link ${Object.keys(newLinks).length + 1}`] = '';
                            setFieldValue('links', newLinks);
                          }}
                        >
                          <Plus className="h-4 w-4 mr-2" />
                          Add Link
                        </Button>
                      )}
                      
                      <p className="text-xs text-gray-500 mt-2">
                        Add up to 3 custom links that will appear on your organization's profile
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              <div className="flex flex-row-reverse mt-3 mx-5 mb-5">
                <Button 
                  type="submit" 
                  disabled={isSubmitting}
                  className="bg-black text-white hover:bg-black/90"
                >
                  {isSubmitting ? 'Saving...' : 'Save Changes'}
                </Button>
              </div>
            </div>
          </Form>
        )}
      </Formik>
    </div>
  )
}



================================================
FILE: apps/web/components/Dashboard/Pages/Payments/PaymentsConfigurationPage.tsx
================================================
'use client';
import React, { useState, useEffect } from 'react';
import { useOrg } from '@components/Contexts/OrgContext';
import { SiStripe } from '@icons-pack/react-simple-icons'
import { useLHSession } from '@components/Contexts/LHSessionContext';
import { getPaymentConfigs, initializePaymentConfig, deletePaymentConfig, updateStripeAccountID, getStripeOnboardingLink } from '@services/payments/payments';
import FormLayout, { ButtonBlack, Input, FormField, FormLabelAndMessage, Flex } from '@components/Objects/StyledElements/Form/Form';
import { BarChart2, Coins, CreditCard, ExternalLink, Info, Loader2, RefreshCcw, Trash2, UnplugIcon } from 'lucide-react';
import toast from 'react-hot-toast';
import useSWR, { mutate } from 'swr';
import Modal from '@components/Objects/StyledElements/Modal/Modal';
import ConfirmationModal from '@components/Objects/StyledElements/ConfirmationModal/ConfirmationModal';
import { Button } from '@components/ui/button';
import { Alert, AlertDescription, AlertTitle } from '@components/ui/alert';
import { useRouter } from 'next/navigation';
import { getUriWithoutOrg } from '@services/config/config';

const PaymentsConfigurationPage: React.FC = () => {
    const org = useOrg() as any;
    const session = useLHSession() as any;
    const router = useRouter();
    const access_token = session?.data?.tokens?.access_token;
    const { data: paymentConfigs, error, isLoading } = useSWR(
        () => (org && access_token ? [`/payments/${org.id}/config`, access_token] : null),
        ([url, token]) => getPaymentConfigs(org.id, token)
    );

    const stripeConfig = paymentConfigs?.find((config: any) => config.provider === 'stripe');
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [isOnboarding, setIsOnboarding] = useState(false);
    const [isOnboardingLoading, setIsOnboardingLoading] = useState(false);

    const enableStripe = async () => {
        try {
            setIsOnboarding(true);
            const newConfig = { provider: 'stripe', enabled: true };
            const config = await initializePaymentConfig(org.id, newConfig, 'stripe', access_token);
            toast.success('Stripe enabled successfully');
            mutate([`/payments/${org.id}/config`, access_token]);
        } catch (error) {
            console.error('Error enabling Stripe:', error);
            toast.error('Failed to enable Stripe');
        } finally {
            setIsOnboarding(false);
        }
    };

    const editConfig = async () => {
        setIsModalOpen(true);
    };

    const deleteConfig = async () => {
        try {
            await deletePaymentConfig(org.id, stripeConfig.id, access_token);
            toast.success('Stripe configuration deleted successfully');
            mutate([`/payments/${org.id}/config`, access_token]);
        } catch (error) {
            console.error('Error deleting Stripe configuration:', error);
            toast.error('Failed to delete Stripe configuration');
        }
    };

    const handleStripeOnboarding = async () => {
        try {
            setIsOnboardingLoading(true);
            const { connect_url } = await getStripeOnboardingLink(org.id, access_token, getUriWithoutOrg('/payments/stripe/connect/oauth'));
            window.open(connect_url, '_blank');
        } catch (error) {
            console.error('Error getting onboarding link:', error);
            toast.error('Failed to start Stripe onboarding');
        } finally {
            setIsOnboardingLoading(false);
        }
    };

    if (isLoading) {
        return <div>Loading...</div>;
    }

    if (error) {
        return <div>Error loading payment configuration</div>;
    }

    return (
        <div>
            <div className="ml-10 mr-10 mx-auto bg-white rounded-xl nice-shadow px-4 py-4">
                <div className="flex flex-col bg-gray-50 -space-y-1 px-5 py-3 rounded-md mb-3">
                    <h1 className="font-bold text-xl text-gray-800">Payments Configuration</h1>
                    <h2 className="text-gray-500 text-md">Manage your organization payments configuration</h2>
                </div>

                <Alert className="mb-3 p-6 border-2 border-blue-100 bg-blue-50/50">
                   
                    <AlertTitle className="text-lg font-semibold mb-2 flex items-center space-x-2"> <Info className="h-5 w-5 " /> <span>About the Stripe Integration</span></AlertTitle>
                    <AlertDescription className="space-y-5">
                        <div className="pl-2">
                            <ul className="list-disc list-inside space-y-1 text-gray-600 pl-2">
                                <li className="flex items-center space-x-2">
                                    <CreditCard className="h-4 w-4" />
                                    <span>Accept payments for courses and subscriptions</span>
                                </li>
                                <li className="flex items-center space-x-2">
                                    <RefreshCcw className="h-4 w-4" />
                                    <span>Manage recurring billing and subscriptions</span>
                                </li>
                                <li className="flex items-center space-x-2">
                                    <Coins className="h-4 w-4" />
                                    <span>Handle multiple currencies and payment methods</span>
                                </li>
                                <li className="flex items-center space-x-2">
                                    <BarChart2 className="h-4 w-4" />
                                    <span>Access detailed payment analytics</span>
                                </li>
                            </ul>
                        </div>
                        <a 
                            href="https://stripe.com/docs"
                            target="_blank"
                            rel="noopener noreferrer" 
                            className="text-blue-600 hover:text-blue-800 inline-flex items-center font-medium transition-colors duration-200 pl-2"
                        >
                            Learn more about Stripe
                            <ExternalLink className="ml-1.5 h-4 w-4" />
                        </a>
                    </AlertDescription>
                </Alert>

                <div className="flex flex-col rounded-lg light-shadow">
                    {stripeConfig ? (
                        <div className="flex items-center justify-between bg-linear-to-r from-indigo-500 to-purple-600 p-6 rounded-lg shadow-md">
                            <div className="flex items-center space-x-3">
                                <SiStripe className="text-white" size={32} />
                                <div className="flex flex-col">
                                    <div className="flex items-center space-x-2">
                                        <span className="text-xl font-semibold text-white">Stripe</span>
                                        {stripeConfig.provider_specific_id && stripeConfig.active ? (
                                            <div className="flex items-center space-x-1 bg-green-500/20 px-2 py-0.5 rounded-full">
                                                <div className="h-2 w-2 bg-green-500 rounded-full" />
                                                <span className="text-xs text-green-100">Connected</span>
                                            </div>
                                        ) : (
                                            <div className="flex items-center space-x-1 bg-red-500/20 px-2 py-0.5 rounded-full">
                                                <div className="h-2 w-2 bg-red-500 rounded-full" />
                                                <span className="text-xs text-red-100">Not Connected</span>
                                            </div>
                                        )}
                                    </div>
                                    <span className="text-white/80 text-sm">
                                        {stripeConfig.provider_specific_id ? 
                                            `Linked Account: ${stripeConfig.provider_specific_id}` : 
                                            'Account ID not configured'}
                                    </span>
                                </div>
                            </div>
                            <div className="flex space-x-2">
                                {(!stripeConfig.provider_specific_id || !stripeConfig.active) && (
                                    <Button
                                        onClick={handleStripeOnboarding}
                                        className="flex items-center space-x-2 px-4 py-2 bg-green-500 text-white text-sm rounded-full hover:bg-green-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed border-2 border-green-400 shadow-md"
                                        disabled={isOnboardingLoading}
                                    >
                                        {isOnboardingLoading ? (
                                            <Loader2 className="animate-spin h-4 w-4" />
                                        ) : (
                                            <UnplugIcon className="h-3 w-3" />
                                        )}
                                        <span className="font-semibold">Connect with Stripe</span>
                                    </Button>
                                )}
                                <ConfirmationModal
                                    confirmationButtonText="Remove Connection"
                                    confirmationMessage="Are you sure you want to remove the Stripe connection? This action cannot be undone."
                                    dialogTitle="Remove Stripe Connection"
                                    dialogTrigger={
                                        <Button 
                                            className="flex items-center space-x-2 bg-red-500 text-white text-sm rounded-full hover:bg-red-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            <Trash2 size={16} />
                                            <span>Remove Connection</span>
                                        </Button>
                                    }
                                    functionToExecute={deleteConfig}
                                    status="warning"
                                />
                            </div>
                        </div>
                    ) : (
                        <Button 
                            onClick={enableStripe} 
                            className="flex items-center justify-center space-x-2 bg-linear-to-r p-3 from-indigo-500 to-purple-600 text-white px-6 rounded-lg hover:from-indigo-600 hover:to-purple-700 transition duration-300 shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled={isOnboarding}
                        >
                            {isOnboarding ? (
                                <>
                                    <Loader2 className="animate-spin" size={24} />
                                    <span className="text-lg font-semibold">Connecting to Stripe...</span>
                                </>
                            ) : (
                                <>
                                    <SiStripe size={24} />
                                    <span className="text-lg font-semibold">Enable Stripe</span>
                                </>
                            )}
                        </Button>
                    )}
                </div>
            </div>
            {stripeConfig && (
                <EditStripeConfigModal
                    orgId={org.id}
                    configId={stripeConfig.id}
                    accessToken={access_token}
                    isOpen={isModalOpen}
                    onClose={() => setIsModalOpen(false)}
                />
            )}
        </div>
    );
};

interface EditStripeConfigModalProps {
    orgId: number;
    configId: string;
    accessToken: string;
    isOpen: boolean;
    onClose: () => void;
}

const EditStripeConfigModal: React.FC<EditStripeConfigModalProps> = ({ orgId, configId, accessToken, isOpen, onClose }) => {
    const [stripeAccountId, setStripeAccountId] = useState('');

    useEffect(() => {
        const fetchConfig = async () => {
            try {
                const config = await getPaymentConfigs(orgId, accessToken);
                const stripeConfig = config.find((c: any) => c.id === configId);
                if (stripeConfig && stripeConfig.provider_specific_id) {
                    setStripeAccountId(stripeConfig.provider_specific_id || '');
                }
            } catch (error) {
                console.error('Error fetching Stripe configuration:', error);
                toast.error('Failed to load existing configuration');
            }
        };

        if (isOpen) {
            fetchConfig();
        }
    }, [isOpen, orgId, configId, accessToken]);

    const handleSubmit = async () => {
        try {
            const stripe_config = {
                stripe_account_id: stripeAccountId,
            };
            await updateStripeAccountID(orgId, stripe_config, accessToken);
            toast.success('Configuration updated successfully');
            mutate([`/payments/${orgId}/config`, accessToken]);
            onClose();
        } catch (error) {
            console.error('Error updating config:', error);
            toast.error('Failed to update configuration');
        }
    };

    return (
        <Modal isDialogOpen={isOpen} dialogTitle="Edit Stripe Configuration" dialogDescription='Edit your stripe configuration' onOpenChange={onClose}
            dialogContent={
                <FormLayout onSubmit={handleSubmit}>
                    <FormField name="stripe-account-id">
                        <FormLabelAndMessage label="Stripe Account ID" />
                        <Input 
                            type="text" 
                            value={stripeAccountId} 
                            onChange={(e) => setStripeAccountId(e.target.value)} 
                            placeholder="acct_..."
                        />
                    </FormField>
                    <Flex css={{ marginTop: 25, justifyContent: 'flex-end' }}>
                        <ButtonBlack type="submit" className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-300">
                            Save
                        </ButtonBlack>
                    </Flex>
                </FormLayout>
            }
        />
    );
};

export default PaymentsConfigurationPage;



================================================
FILE: apps/web/components/Dashboard/Pages/Payments/PaymentsCustomersPage.tsx
================================================
import React from 'react'
import { useOrg } from '@components/Contexts/OrgContext'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import useSWR from 'swr'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@components/ui/table"
import { getOrgCustomers } from '@services/payments/payments'
import { Badge } from '@components/ui/badge'
import PageLoading from '@components/Objects/Loaders/PageLoading'
import { RefreshCcw, SquareCheck } from 'lucide-react'
import { getUserAvatarMediaDirectory } from '@services/media/media'
import UserAvatar from '@components/Objects/UserAvatar'
import { usePaymentsEnabled } from '@hooks/usePaymentsEnabled'
import UnconfiguredPaymentsDisclaimer from '@components/Pages/Payments/UnconfiguredPaymentsDisclaimer'

interface PaymentUserData {
  payment_user_id: number;
  user: {
    username: string;
    first_name: string;
    last_name: string;
    email: string;
    avatar_image: string;
    user_uuid: string;
  };
  product: {
    name: string;
    description: string;
    product_type: string;
    amount: number;
    currency: string;
  };
  status: string;
  creation_date: string;
}

function PaymentsUsersTable({ data }: { data: PaymentUserData[] }) {
  if (!data || data.length === 0) {
    return (
      <div className="text-center py-8 text-gray-500">
        No customers found
      </div>
    );
  }

  return (
    <Table>
      <TableHeader>
        <TableRow>
          <TableHead>User</TableHead>
          <TableHead>Product</TableHead>
          <TableHead>Type</TableHead>
          <TableHead>Amount</TableHead>
          <TableHead>Status</TableHead>
          <TableHead>Purchase Date</TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        {data.map((item) => (
          <TableRow key={item.payment_user_id}>
            <TableCell className="font-medium">
              <div className="flex items-center space-x-3">
                <UserAvatar
                  border="border-2"
                  rounded="rounded-md"
                  avatar_url={getUserAvatarMediaDirectory(item.user.user_uuid, item.user.avatar_image)}
                />
                <div className="flex flex-col">
                  <span className="font-medium">
                    {item.user.first_name || item.user.username}
                  </span>
                  <span className="text-sm text-gray-500">{item.user.email}</span>
                </div>
              </div>
            </TableCell>
            <TableCell>{item.product.name}</TableCell>
            <TableCell>
              <div className="flex items-center space-x-2">
                {item.product.product_type === 'subscription' ? (
                  <Badge variant="outline" className="flex items-center gap-1">
                    <RefreshCcw size={12} />
                    <span>Subscription</span>
                  </Badge>
                ) : (
                  <Badge variant="outline" className="flex items-center gap-1">
                    <SquareCheck size={12} />
                    <span>One-time</span>
                  </Badge>
                )}
              </div>
            </TableCell>
            <TableCell>
              {new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: item.product.currency
              }).format(item.product.amount)}
            </TableCell>
            <TableCell>
              <Badge
                variant={item.status === 'active' ? 'default' :
                  item.status === 'completed' ? 'default' : 'secondary'}
              >
                {item.status}
              </Badge>
            </TableCell>
            <TableCell>
              {new Date(item.creation_date).toLocaleDateString()}
            </TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
  );
}

function PaymentsCustomersPage() {
  const org = useOrg() as any
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token
  const { isEnabled, isLoading } = usePaymentsEnabled()

  const { data: customers, error, isLoading: customersLoading } = useSWR(
    org ? [`/payments/${org.id}/customers`, access_token] : null,
    ([url, token]) => getOrgCustomers(org.id, token)
  )

  if (!isEnabled && !isLoading) {
    return (
      <UnconfiguredPaymentsDisclaimer />
    )
  }

  if (isLoading || customersLoading) return <PageLoading />
  if (error) return <div>Error loading customers</div>
  if (!customers) return <div>No customer data available</div>

  return (
    <div className="ml-10 mr-10 mx-auto bg-white rounded-xl nice-shadow px-4 py-4">
      <div className="flex flex-col bg-gray-50 -space-y-1 px-5 py-3 rounded-md mb-3">
        <h1 className="font-bold text-xl text-gray-800">Customers</h1>
        <h2 className="text-gray-500 text-md">View and manage your customer information</h2>
      </div>

      <PaymentsUsersTable data={customers} />
    </div>
  )
}

export default PaymentsCustomersPage


================================================
FILE: apps/web/components/Dashboard/Pages/Payments/PaymentsProductPage.tsx
================================================
'use client';
import React, { useState, useEffect } from 'react'
import currencyCodes from 'currency-codes';
import { useOrg } from '@components/Contexts/OrgContext';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import useSWR, { mutate } from 'swr';
import { getProducts, updateProduct, archiveProduct } from '@services/payments/products';
import { Plus, Pencil, Info, RefreshCcw, SquareCheck, ChevronDown, ChevronUp, Archive } from 'lucide-react';
import Modal from '@components/Objects/StyledElements/Modal/Modal';
import ConfirmationModal from '@components/Objects/StyledElements/ConfirmationModal/ConfirmationModal';
import toast from 'react-hot-toast';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@components/ui/select"
import { Button } from "@components/ui/button"
import { Input } from "@components/ui/input"
import { Textarea } from "@components/ui/textarea"
import { Formik, Form, Field, ErrorMessage } from 'formik';
import * as Yup from 'yup';
import { Label } from '@components/ui/label';
import { Badge } from '@components/ui/badge';
import { getPaymentConfigs } from '@services/payments/payments';
import ProductLinkedCourses from './SubComponents/ProductLinkedCourses';
import { usePaymentsEnabled } from '@hooks/usePaymentsEnabled';
import UnconfiguredPaymentsDisclaimer from '@components/Pages/Payments/UnconfiguredPaymentsDisclaimer';
import CreateProductForm from './SubComponents/CreateProductForm';

const validationSchema = Yup.object().shape({
    name: Yup.string().required('Name is required'),
    description: Yup.string().required('Description is required'),
    amount: Yup.number().min(0, 'Amount must be positive').required('Amount is required'),
    benefits: Yup.string(),
    currency: Yup.string().required('Currency is required'),
});

function PaymentsProductPage() {
    const org = useOrg() as any;
    const session = useLHSession() as any;
    const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
    const [editingProductId, setEditingProductId] = useState<string | null>(null);
    const [expandedProducts, setExpandedProducts] = useState<{ [key: string]: boolean }>({});
    const [isStripeEnabled, setIsStripeEnabled] = useState(false);
    const { isEnabled, isLoading } = usePaymentsEnabled();

    const { data: products, error } = useSWR(
        () => org && session ? [`/payments/${org.id}/products`, session.data?.tokens?.access_token] : null,
        ([url, token]) => getProducts(org.id, token)
    );

    const { data: paymentConfigs, error: paymentConfigError } = useSWR(
        () => org && session ? [`/payments/${org.id}/config`, session.data?.tokens?.access_token] : null,
        ([url, token]) => getPaymentConfigs(org.id, token)
    );

    useEffect(() => {
        if (paymentConfigs) {
            const stripeConfig = paymentConfigs.find((config: any) => config.provider === 'stripe');
            setIsStripeEnabled(!!stripeConfig);
        }
    }, [paymentConfigs]);

    const handleArchiveProduct = async (productId: string) => {
        const res = await archiveProduct(org.id, productId, session.data?.tokens?.access_token);
        mutate([`/payments/${org.id}/products`, session.data?.tokens?.access_token]);
        if (res.status === 200) {
            toast.success('Product archived successfully');
        } else {
            toast.error(res.data.detail);
        }
    }

    const toggleProductExpansion = (productId: string) => {
        setExpandedProducts(prev => ({
            ...prev,
            [productId]: !prev[productId]
        }));
    };

    if (!isEnabled && !isLoading) {
        return (
            <UnconfiguredPaymentsDisclaimer />
        );
    }

    if (error) return <div>Failed to load products</div>;
    if (!products) return <div>Loading...</div>;

    return (
        <div className="h-full w-full bg-[#f8f8f8]">
            <div className="pl-10 pr-10 mx-auto">


                <Modal
                    isDialogOpen={isCreateModalOpen}
                    onOpenChange={setIsCreateModalOpen}
                    dialogTitle="Create New Product"
                    dialogDescription="Add a new product to your organization"
                    dialogContent={
                        <CreateProductForm onSuccess={() => setIsCreateModalOpen(false)} />
                    }
                />

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {products.data.map((product: any) => (
                        <div key={product.id} className="bg-white p-4 rounded-lg nice-shadow flex flex-col h-full">
                            {editingProductId === product.id ? (
                                <EditProductForm
                                    product={product}
                                    onSuccess={() => setEditingProductId(null)}
                                    onCancel={() => setEditingProductId(null)}
                                />
                            ) : (
                                <div className="flex flex-col h-full">
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="flex flex-col space-y-1 items-start">
                                            <Badge className='w-fit flex items-center space-x-2' variant="outline">
                                                {product.product_type === 'subscription' ? <RefreshCcw size={12} /> : <SquareCheck size={12} />}
                                                <span className='text-sm'>{product.product_type === 'subscription' ? 'Subscription' : 'One-time payment'}</span>
                                            </Badge>
                                            <h3 className="font-bold text-lg">{product.name}</h3>
                                        </div>
                                        <div className="flex space-x-2">
                                            <button
                                                onClick={() => setEditingProductId(product.id)}
                                                className={`text-blue-500 hover:text-blue-700 ${isStripeEnabled ? '' : 'opacity-50 cursor-not-allowed'}`}
                                                disabled={!isStripeEnabled}
                                            >
                                                <Pencil size={16} />
                                            </button>
                                            <ConfirmationModal
                                                confirmationButtonText="Archive Product"
                                                confirmationMessage="Are you sure you want to archive this product?"
                                                dialogTitle={`Archive ${product.name}?`}
                                                dialogTrigger={
                                                    <button className="text-red-500 hover:text-red-700">
                                                        <Archive size={16} />
                                                    </button>
                                                }
                                                functionToExecute={() => handleArchiveProduct(product.id)}
                                                status="warning"
                                            />
                                        </div>
                                    </div>
                                    <div className="grow overflow-hidden">
                                        <div className={`transition-all duration-300 ease-in-out ${expandedProducts[product.id] ? 'max-h-[1000px]' : 'max-h-24'} overflow-hidden`}>
                                            <p className="text-gray-600">
                                                {product.description}
                                            </p>
                                            {product.benefits && (
                                                <div className="mt-2">
                                                    <h4 className="font-semibold text-sm">Benefits:</h4>
                                                    <p className="text-sm text-gray-600">
                                                        {product.benefits}
                                                    </p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <div className="mt-2">
                                        <button
                                            onClick={() => toggleProductExpansion(product.id)}
                                            className="text-slate-500 hover:text-slate-700 text-sm flex items-center"
                                        >
                                            {expandedProducts[product.id] ? (
                                                <>
                                                    <ChevronUp size={16} />
                                                    <span>Show less</span>
                                                </>
                                            ) : (
                                                <>
                                                    <ChevronDown size={16} />
                                                    <span>Show more</span>
                                                </>
                                            )}
                                        </button>
                                    </div>
                                    <ProductLinkedCourses productId={product.id} />
                                    <div className="mt-2 flex items-center justify-between bg-gray-100 rounded-md p-2">
                                        <span className="text-sm text-gray-600">Price:</span>
                                        <span className="font-semibold text-lg">
                                            {new Intl.NumberFormat('en-US', { style: 'currency', currency: product.currency }).format(product.amount)}
                                        </span>
                                    </div>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
                {products.data.length === 0 && (
                    <div className="flex mx-auto space-x-2 font-semibold mt-3 text-gray-600 items-center">
                        <Info size={20} />
                        <p>No products available. Create a new product to get started.</p>
                    </div>
                )}

                <div className="flex justify-center items-center py-10">
                    <button
                        onClick={() => setIsCreateModalOpen(true)}
                        className={`mb-4 flex items-center space-x-2 px-3 py-1.5 rounded-lg bg-linear-to-bl text-white font-medium from-gray-700 to-gray-900 border border-gray-600 shadow-gray-900/20 nice-shadow transition duration-300 ${isStripeEnabled ? 'hover:from-gray-600 hover:to-gray-800' : 'opacity-50 cursor-not-allowed'
                            }`}
                        disabled={!isStripeEnabled}
                    >
                        <Plus size={18} />
                        <span className="text-sm font-bold">Create New Product</span>
                    </button>
                </div>
            </div>
        </div>
    )
}

const EditProductForm = ({ product, onSuccess, onCancel }: { product: any, onSuccess: () => void, onCancel: () => void }) => {
    const org = useOrg() as any;
    const session = useLHSession() as any;
    const [currencies, setCurrencies] = useState<{ code: string; name: string }[]>([]);

    useEffect(() => {
        const allCurrencies = currencyCodes.data.map(currency => ({
            code: currency.code,
            name: `${currency.code} - ${currency.currency}`
        }));
        setCurrencies(allCurrencies);
    }, []);

    const initialValues = {
        name: product.name,
        description: product.description,
        amount: product.amount,
        benefits: product.benefits || '',
        currency: product.currency || '',
        product_type: product.product_type,
    };

    const handleSubmit = async (values: typeof initialValues, { setSubmitting }: { setSubmitting: (isSubmitting: boolean) => void }) => {
        try {
            await updateProduct(org.id, product.id, values, session.data?.tokens?.access_token);
            mutate([`/payments/${org.id}/products`, session.data?.tokens?.access_token]);
            onSuccess();
            toast.success('Product updated successfully');
        } catch (error) {
            toast.error('Failed to update product');
        } finally {
            setSubmitting(false);
        }
    };

    return (
        <Formik
            initialValues={initialValues}
            validationSchema={validationSchema}
            onSubmit={handleSubmit}
        >
            {({ isSubmitting, values, setFieldValue }) => (
                <Form className="space-y-4">
                    <div className='px-1.5 py-2 flex-col space-y-3'>
                        <div>
                            <Label htmlFor="name">Product Name</Label>
                            <Field name="name" as={Input} placeholder="Product Name" />
                            <ErrorMessage name="name" component="div" className="text-red-500 text-sm mt-1" />
                        </div>

                        <div>
                            <Label htmlFor="description">Description</Label>
                            <Field name="description" as={Textarea} placeholder="Product Description" />
                            <ErrorMessage name="description" component="div" className="text-red-500 text-sm mt-1" />
                        </div>

                        <div className="flex space-x-2">
                            <div className="grow">
                                <Label htmlFor="amount">Price</Label>
                                <Field name="amount" as={Input} type="number" placeholder="Price" />
                                <ErrorMessage name="amount" component="div" className="text-red-500 text-sm mt-1" />
                            </div>
                            <div className="w-1/3">
                                <Label htmlFor="currency">Currency</Label>
                                <Select
                                    value={values.currency}
                                    onValueChange={(value) => setFieldValue('currency', value)}
                                >
                                    <SelectTrigger>
                                        <SelectValue placeholder="Currency" />
                                    </SelectTrigger>
                                    <SelectContent>
                                        {currencies.map((currency) => (
                                            <SelectItem key={currency.code} value={currency.code}>
                                                {currency.name}
                                            </SelectItem>
                                        ))}
                                    </SelectContent>
                                </Select>
                                <ErrorMessage name="currency" component="div" className="text-red-500 text-sm mt-1" />
                            </div>
                        </div>

                        <div>
                            <Label htmlFor="benefits">Benefits</Label>
                            <Field name="benefits" as={Textarea} placeholder="Product Benefits" />
                            <ErrorMessage name="benefits" component="div" className="text-red-500 text-sm mt-1" />
                        </div>
                    </div>

                    <div className="flex justify-end space-x-2">
                        <Button type="button" variant="outline" onClick={onCancel}>Cancel</Button>
                        <Button type="submit" disabled={isSubmitting}>
                            {isSubmitting ? 'Saving...' : 'Save'}
                        </Button>
                    </div>
                </Form>
            )}
        </Formik>
    );
};

export default PaymentsProductPage



================================================
FILE: apps/web/components/Dashboard/Pages/Payments/SubComponents/CreateProductForm.tsx
================================================
import React, { useEffect, useState } from 'react';
import { useOrg } from '@components/Contexts/OrgContext';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import { createProduct } from '@services/payments/products';
import { Formik, Form, Field, ErrorMessage } from 'formik';
import * as Yup from 'yup';
import toast from 'react-hot-toast';
import { mutate } from 'swr';
import { Button } from "@components/ui/button";
import { Input } from "@components/ui/input";
import { Textarea } from "@components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@components/ui/select";
import { Label } from "@components/ui/label";
import currencyCodes from 'currency-codes';

const validationSchema = Yup.object().shape({
  name: Yup.string().required('Name is required'),
  description: Yup.string().required('Description is required'),
  amount: Yup.number()
    .min(1, 'Amount must be greater than zero')
    .required('Amount is required'),
  benefits: Yup.string(),
  currency: Yup.string().required('Currency is required'),
  product_type: Yup.string().oneOf(['one_time', 'subscription']).required('Product type is required'),
  price_type: Yup.string().oneOf(['fixed_price', 'customer_choice']).required('Price type is required'),
});

interface ProductFormValues {
  name: string;
  description: string;
  product_type: 'one_time' | 'subscription';
  price_type: 'fixed_price' | 'customer_choice';
  benefits: string;
  amount: number;
  currency: string;
}

const CreateProductForm: React.FC<{ onSuccess: () => void }> = ({ onSuccess }) => {
  const org = useOrg() as any;
  const session = useLHSession() as any;
  const [currencies, setCurrencies] = useState<{ code: string; name: string }[]>([]);

  useEffect(() => {
    const allCurrencies = currencyCodes.data.map(currency => ({
      code: currency.code,
      name: `${currency.code} - ${currency.currency}`
    }));
    setCurrencies(allCurrencies);
  }, []);

  const initialValues: ProductFormValues = {
    name: '',
    description: '',
    product_type: 'one_time',
    price_type: 'fixed_price',
    benefits: '',
    amount: 1,
    currency: 'USD',
  };

  const handleSubmit = async (values: ProductFormValues, { setSubmitting, resetForm }: any) => {
    try {
      const res = await createProduct(org.id, values, session.data?.tokens?.access_token);
      if (res.success) {
        toast.success('Product created successfully');
        mutate([`/payments/${org.id}/products`, session.data?.tokens?.access_token]);
        resetForm();
        onSuccess();
      } else {
        toast.error('Failed to create product');
      }
    } catch (error) {
      console.error('Error creating product:', error);
      toast.error('An error occurred while creating the product');
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <Formik
      initialValues={initialValues}
      validationSchema={validationSchema}
      onSubmit={handleSubmit}
    >
      {({ isSubmitting, values, setFieldValue }) => (
        <Form className="space-y-4">
          <div className='px-1.5 py-2 flex-col space-y-3'>
            <div>
              <Label htmlFor="name">Product Name</Label>
              <Field name="name" as={Input} placeholder="Product Name" />
              <ErrorMessage name="name" component="div" className="text-red-500 text-sm mt-1" />
            </div>

            <div>
              <Label htmlFor="description">Description</Label>
              <Field name="description" as={Textarea} placeholder="Product Description" />
              <ErrorMessage name="description" component="div" className="text-red-500 text-sm mt-1" />
            </div>
            
            <div>
              <Label htmlFor="product_type">Product Type</Label>
              <Select
                value={values.product_type}
                onValueChange={(value) => setFieldValue('product_type', value)}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Product Type" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="one_time">One Time</SelectItem>
                  <SelectItem value="subscription">Subscription</SelectItem>
                </SelectContent>
              </Select>
              <ErrorMessage name="product_type" component="div" className="text-red-500 text-sm mt-1" />
            </div>

            <div>
              <Label htmlFor="price_type">Price Type</Label>
              <Select
                value={values.price_type}
                onValueChange={(value) => setFieldValue('price_type', value)}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Price Type" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="fixed_price">Fixed Price</SelectItem>
                  {values.product_type !== 'subscription' && (
                    <SelectItem value="customer_choice">Customer Choice</SelectItem>
                  )}
                </SelectContent>
              </Select>
              <ErrorMessage name="price_type" component="div" className="text-red-500 text-sm mt-1" />
            </div>

            <div className="flex space-x-2">
              <div className="grow">
                <Label htmlFor="amount">
                  {values.price_type === 'fixed_price' ? 'Price' : 'Minimum Amount'}
                </Label>
                <Field name="amount" as={Input} type="number" placeholder={values.price_type === 'fixed_price' ? 'Price' : 'Minimum Amount'} />
                <ErrorMessage name="amount" component="div" className="text-red-500 text-sm mt-1" />
              </div>
              <div className="w-1/3">
                <Label htmlFor="currency">Currency</Label>
                <Select
                  value={values.currency}
                  onValueChange={(value) => setFieldValue('currency', value)}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Currency" />
                  </SelectTrigger>
                  <SelectContent>
                    {currencies.map((currency) => (
                      <SelectItem key={currency.code} value={currency.code}>
                        {currency.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
                <ErrorMessage name="currency" component="div" className="text-red-500 text-sm mt-1" />
              </div>
            </div>

            <div>
              <Label htmlFor="benefits">Benefits</Label>
              <Field name="benefits" as={Textarea} placeholder="Product Benefits" />
              <ErrorMessage name="benefits" component="div" className="text-red-500 text-sm mt-1" />
            </div>
          </div>

          <div className="flex justify-end">
            <Button type="submit" disabled={isSubmitting}>
              {isSubmitting ? 'Creating...' : 'Create Product'}
            </Button>
          </div>
        </Form>
      )}
    </Formik>
  );
};

export default CreateProductForm;



================================================
FILE: apps/web/components/Dashboard/Pages/Payments/SubComponents/LinkCourseModal.tsx
================================================
import React, { useState } from 'react';
import { useOrg } from '@components/Contexts/OrgContext';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import { linkCourseToProduct } from '@services/payments/products';
import { Button } from "@components/ui/button";
import toast from 'react-hot-toast';
import { mutate } from 'swr';
import useSWR from 'swr';
import { getOrgCourses } from '@services/courses/courses';
import { getCoursesLinkedToProduct } from '@services/payments/products';
import { getCourseThumbnailMediaDirectory } from '@services/media/media';

interface LinkCourseModalProps {
  productId: string;
  onSuccess: () => void;
}

interface CoursePreviewProps {
  course: {
    id: string;
    name: string;
    description: string;
    thumbnail_image: string;
    course_uuid: string;
  };
  orgslug: string;
  onLink: (courseId: string) => void;
  isLinked: boolean;
}

const CoursePreview = ({ course, orgslug, onLink, isLinked }: CoursePreviewProps) => {
  const org = useOrg() as any;
  
  const thumbnailImage = course.thumbnail_image
    ? getCourseThumbnailMediaDirectory(org?.org_uuid, course.course_uuid, course.thumbnail_image)
    : '../empty_thumbnail.png';

  return (
    <div className="flex gap-4 p-4 bg-white rounded-lg border border-gray-100 hover:border-gray-200 transition-colors">
      {/* Thumbnail */}
      <div 
        className="shrink-0 w-[120px] h-[68px] rounded-md bg-cover bg-center ring-1 ring-inset ring-black/10"
        style={{ backgroundImage: `url(${thumbnailImage})` }}
      />
      
      {/* Content */}
      <div className="grow space-y-1">
        <h3 className="font-medium text-gray-900 line-clamp-1">
          {course.name}
        </h3>
        <p className="text-sm text-gray-500 line-clamp-2">
          {course.description}
        </p>
      </div>

      {/* Action Button */}
      <div className="shrink-0 flex items-center">
        {isLinked ? (
          <Button
            variant="outline"
            size="sm"
            disabled
            className="text-gray-500"
          >
            Already Linked
          </Button>
        ) : (
          <Button
            onClick={() => onLink(course.id)}
            size="sm"
          >
            Link Course
          </Button>
        )}
      </div>
    </div>
  );
};

export default function LinkCourseModal({ productId, onSuccess }: LinkCourseModalProps) {
  const [searchTerm, setSearchTerm] = useState('');
  const org = useOrg() as any;
  const session = useLHSession() as any;

  const { data: courses } = useSWR(
    () => org && session ? [org.slug, searchTerm, session.data?.tokens?.access_token] : null,
    ([orgSlug, search, token]) => getOrgCourses(orgSlug, null, token)
  );

  const { data: linkedCourses } = useSWR(
    () => org && session ? [`/payments/${org.id}/products/${productId}/courses`, session.data?.tokens?.access_token] : null,
    ([_, token]) => getCoursesLinkedToProduct(org.id, productId, token)
  );

  const handleLinkCourse = async (courseId: string) => {
    try {
      const response = await linkCourseToProduct(org.id, productId, courseId, session.data?.tokens?.access_token);
      if (response.success) {
        mutate([`/payments/${org.id}/products`, session.data?.tokens?.access_token]);
        toast.success('Course linked successfully');
        onSuccess();
      } else {
        toast.error(response.data?.detail || 'Failed to link course');
      }
    } catch (error) {
      toast.error('Failed to link course');
    }
  };

  const isLinked = (courseId: string) => {
    return linkedCourses?.data?.some((course: any) => course.id === courseId);
  };

  return (
    <div className="space-y-4">
     

      {/* Course List */}
      <div className="max-h-[400px] overflow-y-auto space-y-2 px-3">
        {courses?.map((course: any) => (
          <CoursePreview 
            key={course.course_uuid}
            course={course}
            orgslug={org.slug}
            onLink={handleLinkCourse}
            isLinked={isLinked(course.id)}
          />
        ))}
        
        {/* Empty State */}
        {(!courses || courses.length === 0) && (
          <div className="text-center py-6 text-gray-500">
            No courses found
          </div>
        )}
      </div>
    </div>
  );
} 


================================================
FILE: apps/web/components/Dashboard/Pages/Payments/SubComponents/ProductLinkedCourses.tsx
================================================
import React, { useEffect, useState } from 'react';
import { getCoursesLinkedToProduct, unlinkCourseFromProduct } from '@services/payments/products';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import { useOrg } from '@components/Contexts/OrgContext';
import { Trash2, Plus, BookOpen } from 'lucide-react';
import { Button } from "@components/ui/button";
import toast from 'react-hot-toast';
import { mutate } from 'swr';
import Modal from '@components/Objects/StyledElements/Modal/Modal';
import LinkCourseModal from './LinkCourseModal';

interface ProductLinkedCoursesProps {
  productId: string;
}

export default function ProductLinkedCourses({ productId }: ProductLinkedCoursesProps) {
  const [linkedCourses, setLinkedCourses] = useState<any[]>([]);
  const [isLinkModalOpen, setIsLinkModalOpen] = useState(false);
  const session = useLHSession() as any;
  const org = useOrg() as any;

  const fetchLinkedCourses = async () => {
    try {
      const response = await getCoursesLinkedToProduct(org.id, productId, session.data?.tokens?.access_token);
      setLinkedCourses(response.data || []);
    } catch (error) {
      toast.error('Failed to fetch linked courses');
    }
  };

  const handleUnlinkCourse = async (courseId: string) => {
    try {
      const response = await unlinkCourseFromProduct(org.id, productId, courseId, session.data?.tokens?.access_token);
      if (response.success) {
        await fetchLinkedCourses();
        mutate([`/payments/${org.id}/products`, session.data?.tokens?.access_token]);
        toast.success('Course unlinked successfully');
      } else {
        toast.error(response.data?.detail || 'Failed to unlink course');
      }
    } catch (error) {
      toast.error('Failed to unlink course');
    }
  };

  useEffect(() => {
    if (org && session && productId) {
      fetchLinkedCourses();
    }
  }, [org, session, productId]);

  return (
    <div className="mt-4">
      <div className="flex justify-between items-center mb-2">
        <h3 className="text-sm font-semibold text-gray-700">Linked Courses</h3>
        <Modal
          isDialogOpen={isLinkModalOpen}
          onOpenChange={setIsLinkModalOpen}
          dialogTitle="Link Course to Product"
          dialogDescription="Select a course to link to this product"
          dialogContent={
            <LinkCourseModal
              productId={productId}
              onSuccess={() => {
                setIsLinkModalOpen(false);
                fetchLinkedCourses();
              }}
            />
          }
          dialogTrigger={
            <Button variant="outline" size="sm" className="flex items-center gap-2">
              <Plus size={16} />
              <span>Link Course</span>
            </Button>
          }
        />
      </div>

      <div className="space-y-2">
        {linkedCourses.length === 0 ? (
          <div className="text-sm text-gray-500 flex items-center gap-2">
            <BookOpen size={16} />
            <span>No courses linked yet</span>
          </div>
        ) : (
          linkedCourses.map((course) => (
            <div
              key={course.id}
              className="flex items-center justify-between p-2 bg-gray-50 rounded-md"
            >
              <span className="text-sm font-medium">{course.name}</span>
              <Button
                variant="ghost"
                size="sm"
                onClick={() => handleUnlinkCourse(course.id)}
                className="text-red-500 hover:text-red-700"
              >
                <Trash2 size={16} />
              </Button>
            </div>
          ))
        )}
      </div>
    </div>
  );
} 


================================================
FILE: apps/web/components/Dashboard/Pages/UserAccount/UserEditGeneral/UserEditGeneral.tsx
================================================
'use client';
import { updateProfile } from '@services/settings/profile'
import { getUser } from '@services/users/users'
import React, { useEffect, useState, useCallback, useMemo } from 'react'
import { Formik, Form } from 'formik'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import {
  ArrowBigUpDash,
  Check,
  FileWarning,
  Info,
  UploadCloud,
  AlertTriangle,
  Briefcase,
  GraduationCap,
  MapPin,
  Building2,
  Globe,
  Laptop2,
  Award,
  BookOpen,
  Link,
  Users,
  Calendar,
  Lightbulb
} from 'lucide-react'
import UserAvatar from '@components/Objects/UserAvatar'
import { updateUserAvatar } from '@services/users/users'
import { constructAcceptValue } from '@/lib/constants'
import * as Yup from 'yup'
import { Input } from "@components/ui/input"
import { Textarea } from "@components/ui/textarea"
import { Button } from "@components/ui/button"
import { Label } from "@components/ui/label"
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@components/ui/select"
import { toast } from 'react-hot-toast'
import { signOut } from 'next-auth/react'
import { getUriWithoutOrg } from '@services/config/config';
import { useDebounce } from '@/hooks/useDebounce';

const SUPPORTED_FILES = constructAcceptValue(['jpg', 'png', 'webp', 'gif'])

const AVAILABLE_ICONS = [
  { name: 'briefcase', label: 'Briefcase', component: Briefcase },
  { name: 'graduation-cap', label: 'Education', component: GraduationCap },
  { name: 'map-pin', label: 'Location', component: MapPin },
  { name: 'building-2', label: 'Organization', component: Building2 },
  { name: 'speciality', label: 'Speciality', component: Lightbulb },
  { name: 'globe', label: 'Website', component: Globe },
  { name: 'laptop-2', label: 'Tech', component: Laptop2 },
  { name: 'award', label: 'Achievement', component: Award },
  { name: 'book-open', label: 'Book', component: BookOpen },
  { name: 'link', label: 'Link', component: Link },
  { name: 'users', label: 'Community', component: Users },
  { name: 'calendar', label: 'Calendar', component: Calendar },
] as const;

const IconComponent = ({ iconName }: { iconName: string }) => {
  const iconConfig = AVAILABLE_ICONS.find(i => i.name === iconName);
  if (!iconConfig) return null;
  const IconElement = iconConfig.component;
  return <IconElement className="w-4 h-4" />;
};

interface DetailItem {
  id: string;
  label: string;
  icon: string;
  text: string;
}

interface FormValues {
  username: string;
  first_name: string;
  last_name: string;
  email: string;
  bio: string;
  details: {
    [key: string]: DetailItem;
  };
}

const DETAIL_TEMPLATES = {
  general: [
    { id: 'title', label: 'Title', icon: 'briefcase', text: '' },
    { id: 'affiliation', label: 'Affiliation', icon: 'building-2', text: '' },
    { id: 'location', label: 'Location', icon: 'map-pin', text: '' },
    { id: 'website', label: 'Website', icon: 'globe', text: '' },
    { id: 'linkedin', label: 'LinkedIn', icon: 'link', text: '' }
  ],
  academic: [
    { id: 'institution', label: 'Institution', icon: 'building-2', text: '' },
    { id: 'department', label: 'Department', icon: 'graduation-cap', text: '' },
    { id: 'research', label: 'Research Area', icon: 'book-open', text: '' },
    { id: 'academic-title', label: 'Academic Title', icon: 'award', text: '' }
  ],
  professional: [
    { id: 'company', label: 'Company', icon: 'building-2', text: '' },
    { id: 'industry', label: 'Industry', icon: 'briefcase', text: '' },
    { id: 'expertise', label: 'Expertise', icon: 'laptop-2', text: '' },
    { id: 'community', label: 'Community', icon: 'users', text: '' }
  ]
} as const;

const validationSchema = Yup.object().shape({
  email: Yup.string().email('Invalid email').required('Email is required'),
  username: Yup.string().required('Username is required'),
  first_name: Yup.string().required('First name is required'),
  last_name: Yup.string().required('Last name is required'),
  bio: Yup.string().max(400, 'Bio must be 400 characters or less'),
  details: Yup.object().shape({})
});

// Memoized detail card component for better performance
const DetailCard = React.memo(({ 
  id,
  detail, 
  onUpdate, 
  onRemove,
  onLabelChange 
}: { 
  id: string;
  detail: DetailItem;
  onUpdate: (id: string, field: keyof DetailItem, value: string) => void;
  onRemove: (id: string) => void;
  onLabelChange: (id: string, newLabel: string) => void;
}) => {
  // Add local state for label input
  const [localLabel, setLocalLabel] = useState(detail.label);
  
  // Debounce the label change handler
  const debouncedLabelChange = useDebounce((newLabel: string) => {
    if (newLabel !== detail.label) {
      onLabelChange(id, newLabel);
    }
  }, 500);

  // Memoize handlers to prevent unnecessary re-renders
  const handleLabelChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const newLabel = e.target.value;
    setLocalLabel(newLabel);
    debouncedLabelChange(newLabel);
  }, [debouncedLabelChange]);

  const handleIconChange = useCallback((value: string) => {
    onUpdate(id, 'icon', value);
  }, [id, onUpdate]);

  const handleTextChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    onUpdate(id, 'text', e.target.value);
  }, [id, onUpdate]);

  const handleRemove = useCallback(() => {
    onRemove(id);
  }, [id, onRemove]);

  // Update local label when prop changes
  useEffect(() => {
    setLocalLabel(detail.label);
  }, [detail.label]);

  return (
    <div className="space-y-2 p-4 border rounded-lg bg-white shadow-sm">
      <div className="flex justify-between items-center mb-3">
        <Input
          value={localLabel}
          onChange={handleLabelChange}
          placeholder="Enter label (e.g., Title, Location)"
          className="max-w-[200px]"
        />
        <Button
          type="button"
          variant="ghost"
          size="sm"
          className="text-red-500 hover:text-red-700"
          onClick={handleRemove}
        >
          Remove
        </Button>
      </div>

      <div className="grid grid-cols-2 gap-3">
        <div>
          <Label>Icon</Label>
          <Select
            value={detail.icon}
            onValueChange={handleIconChange}
          >
            <SelectTrigger className="w-full">
              <SelectValue placeholder="Select icon">
                {detail.icon && (
                  <div className="flex items-center gap-2">
                    <IconComponent iconName={detail.icon} />
                    <span>
                      {AVAILABLE_ICONS.find(i => i.name === detail.icon)?.label}
                    </span>
                  </div>
                )}
              </SelectValue>
            </SelectTrigger>
            <SelectContent>
              {AVAILABLE_ICONS.map((icon) => (
                <SelectItem key={icon.name} value={icon.name}>
                  <div className="flex items-center gap-2">
                    <icon.component className="w-4 h-4" />
                    <span>{icon.label}</span>
                  </div>
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>
        <div>
          <Label>Text</Label>
          <Input
            value={detail.text}
            onChange={handleTextChange}
            placeholder="Enter detail text"
          />
        </div>
      </div>
    </div>
  );
});

DetailCard.displayName = 'DetailCard';

// Form component to handle the details section
const UserEditForm = ({
  values,
  setFieldValue,
  handleChange,
  errors,
  touched,
  isSubmitting,
  profilePicture
}: {
  values: FormValues;
  setFieldValue: (field: string, value: any) => void;
  handleChange: (e: React.ChangeEvent<any>) => void;
  errors: any;
  touched: any;
  isSubmitting: boolean;
  profilePicture: {
    error: string | undefined;
    success: string;
    isLoading: boolean;
    localAvatar: File | null;
    handleFileChange: (event: any) => Promise<void>;
  };
}) => {
  // Memoize template handlers
  const templateHandlers = useMemo(() => 
    Object.entries(DETAIL_TEMPLATES).reduce((acc, [key, template]) => ({
      ...acc,
      [key]: () => {
        const currentIds = new Set(Object.keys(values.details));
        const newDetails = { ...values.details };
        
        template.forEach((item) => {
          if (!currentIds.has(item.id)) {
            newDetails[item.id] = { ...item };
          }
        });
        
        setFieldValue('details', newDetails);
      }
    }), {} as Record<string, () => void>)
  , [values.details, setFieldValue]);

  // Memoize detail handlers
  const detailHandlers = useMemo(() => ({
    handleDetailUpdate: (id: string, field: keyof DetailItem, value: string) => {
      const newDetails = { ...values.details };
      newDetails[id] = { ...newDetails[id], [field]: value };
      setFieldValue('details', newDetails);
    },
    handleDetailRemove: (id: string) => {
      const newDetails = { ...values.details };
      delete newDetails[id];
      setFieldValue('details', newDetails);
    }
  }), [values.details, setFieldValue]);

  return (
    <Form>
      <div className="flex flex-col gap-0">
        <div className="flex flex-col bg-gray-50 -space-y-1 px-5 py-3 mx-3 my-3 rounded-md">
          <h1 className="font-bold text-xl text-gray-800">
            Account Settings
          </h1>
          <h2 className="text-gray-500 text-md">
            Manage your personal information and preferences
          </h2>
        </div>

        <div className="flex flex-col lg:flex-row mt-0 mx-5 my-5 gap-8">
          {/* Profile Information Section */}
          <div className="flex-1 min-w-0 space-y-4">
            <div>
              <Label htmlFor="email">Email</Label>
              <Input
                id="email"
                name="email"
                type="email"
                value={values.email}
                onChange={handleChange}
                placeholder="Your email address"
              />
              {touched.email && errors.email && (
                <p className="text-red-500 text-sm mt-1">{errors.email}</p>
              )}
              {values.email !== values.email && (
                <div className="flex items-center space-x-2 mt-2 text-amber-600 bg-amber-50 p-2 rounded-md">
                  <AlertTriangle size={16} />
                  <span className="text-sm">You will be logged out after changing your email</span>
                </div>
              )}
            </div>

            <div>
              <Label htmlFor="username">Username</Label>
              <Input
                id="username"
                name="username"
                value={values.username}
                onChange={handleChange}
                placeholder="Your username"
              />
              {touched.username && errors.username && (
                <p className="text-red-500 text-sm mt-1">{errors.username}</p>
              )}
            </div>

            <div>
              <Label htmlFor="first_name">First Name</Label>
              <Input
                id="first_name"
                name="first_name"
                value={values.first_name}
                onChange={handleChange}
                placeholder="Your first name"
              />
              {touched.first_name && errors.first_name && (
                <p className="text-red-500 text-sm mt-1">{errors.first_name}</p>
              )}
            </div>

            <div>
              <Label htmlFor="last_name">Last Name</Label>
              <Input
                id="last_name"
                name="last_name"
                value={values.last_name}
                onChange={handleChange}
                placeholder="Your last name"
              />
              {touched.last_name && errors.last_name && (
                <p className="text-red-500 text-sm mt-1">{errors.last_name}</p>
              )}
            </div>

            <div>
              <Label htmlFor="bio">
                Bio
                <span className="text-gray-500 text-sm ml-2">
                  ({400 - (values.bio?.length || 0)} characters left)
                </span>
              </Label>
              <Textarea
                id="bio"
                name="bio"
                value={values.bio}
                onChange={handleChange}
                placeholder="Tell us about yourself"
                className="min-h-[150px]"
                maxLength={400}
              />
              {touched.bio && errors.bio && (
                <p className="text-red-500 text-sm mt-1">{errors.bio}</p>
              )}
            </div>

            <div className="space-y-4">
              <div className="flex flex-col gap-3">
                <div className="flex justify-between items-center">
                  <Label>Additional Details</Label>
                  <div className="flex gap-2">
                    <Button
                      type="button"
                      variant="outline"
                      size="sm"
                      className="text-red-500 hover:text-red-700 hover:bg-red-50"
                      onClick={() => {
                        setFieldValue('details', {});
                      }}
                    >
                      Clear All
                    </Button>
                    <Button
                      type="button"
                      variant="outline"
                      size="sm"
                      onClick={() => {
                        const newDetails = { ...values.details };
                        const id = `detail-${Date.now()}`;
                        newDetails[id] = { 
                          id,
                          label: 'New Detail',
                          icon: '',
                          text: '' 
                        };
                        setFieldValue('details', newDetails);
                      }}
                    >
                      Add Detail
                    </Button>
                  </div>
                </div>
                
                <div className="flex flex-wrap gap-2">
                  {Object.entries(DETAIL_TEMPLATES).map(([key, template]) => (
                    <Button
                      key={key}
                      type="button"
                      variant="secondary"
                      size="sm"
                      className="flex items-center gap-2"
                      onClick={() => {
                        const currentIds = new Set(Object.keys(values.details));
                        const newDetails = { ...values.details };
                        
                        template.forEach((item) => {
                          if (!currentIds.has(item.id)) {
                            newDetails[item.id] = { ...item };
                          }
                        });
                        
                        setFieldValue('details', newDetails);
                      }}
                    >
                      {key === 'general' && <Briefcase className="w-4 h-4" />}
                      {key === 'academic' && <GraduationCap className="w-4 h-4" />}
                      {key === 'professional' && <Building2 className="w-4 h-4" />}
                      Add {key.charAt(0).toUpperCase() + key.slice(1)}
                    </Button>
                  ))}
                </div>
              </div>

              <div className="space-y-3">
                {Object.entries(values.details).map(([id, detail]) => (
                  <DetailCard
                    key={id}
                    id={id}
                    detail={detail}
                    onUpdate={(id, field, value) => {
                      const newDetails = { ...values.details };
                      newDetails[id] = { ...newDetails[id], [field]: value };
                      setFieldValue('details', newDetails);
                    }}
                    onRemove={(id) => {
                      const newDetails = { ...values.details };
                      delete newDetails[id];
                      setFieldValue('details', newDetails);
                    }}
                    onLabelChange={(id, newLabel) => {
                      const newDetails = { ...values.details };
                      newDetails[id] = { ...newDetails[id], label: newLabel };
                      setFieldValue('details', newDetails);
                    }}
                  />
                ))}
              </div>
            </div>
          </div>

          {/* Profile Picture Section */}
          <div className="lg:w-80 w-full">
            <div className="bg-gray-50/50 p-6 rounded-lg nice-shadow h-full">
              <div className="flex flex-col items-center space-y-6">
                <Label className="font-bold">Profile Picture</Label>
                {profilePicture.error && (
                  <div className="flex items-center bg-red-200 rounded-md text-red-950 px-4 py-2 text-sm">
                    <FileWarning size={16} className="mr-2" />
                    <span className="font-semibold first-letter:uppercase">{profilePicture.error}</span>
                  </div>
                )}
                {profilePicture.success && (
                  <div className="flex items-center bg-green-200 rounded-md text-green-950 px-4 py-2 text-sm">
                    <Check size={16} className="mr-2" />
                    <span className="font-semibold first-letter:uppercase">{profilePicture.success}</span>
                  </div>
                )}
                {profilePicture.localAvatar ? (
                  <UserAvatar
                    border="border-8"
                    width={120}
                    avatar_url={URL.createObjectURL(profilePicture.localAvatar)}
                  />
                ) : (
                  <UserAvatar border="border-8" width={120} />
                )}
                {profilePicture.isLoading ? (
                  <div className="font-bold animate-pulse antialiased bg-green-200 text-gray text-sm rounded-md px-4 py-2 flex items-center">
                    <ArrowBigUpDash size={16} className="mr-2" />
                    <span>Uploading</span>
                  </div>
                ) : (
                  <>
                    <input
                      type="file"
                      id="fileInput"
                      accept={SUPPORTED_FILES}
                      className="hidden"
                      onChange={profilePicture.handleFileChange}
                    />
                    <Button
                      type="button"
                      variant="outline"
                      onClick={() => document.getElementById('fileInput')?.click()}
                      className="w-full"
                    >
                      <UploadCloud size={16} className="mr-2" />
                      Change Avatar
                    </Button>
                  </>
                )}
                <div className="flex items-center text-xs text-gray-500">
                  <Info size={13} className="mr-2" />
                  <p>Recommended size 100x100</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div className="flex flex-row-reverse mt-0 mx-5 mb-5">
          <Button 
            type="submit" 
            disabled={isSubmitting}
            className="bg-black text-white hover:bg-black/90"
          >
            {isSubmitting ? 'Saving...' : 'Save Changes'}
          </Button>
        </div>
      </div>
    </Form>
  );
};

function UserEditGeneral() {
  const session = useLHSession() as any;
  const access_token = session?.data?.tokens?.access_token;
  const [localAvatar, setLocalAvatar] = React.useState(null) as any
  const [isLoading, setIsLoading] = React.useState(false) as any
  const [error, setError] = React.useState() as any
  const [success, setSuccess] = React.useState('') as any
  const [userData, setUserData] = useState<any>(null);

  useEffect(() => {
    const fetchUserData = async () => {
      if (session?.data?.user?.id) {
        try {
          const data = await getUser(session.data.user.id, access_token);
          setUserData(data);
        } catch (error) {
          console.error('Error fetching user data:', error);
          setError('Failed to load user data');
        }
      }
    };

    fetchUserData();
  }, [session?.data?.user?.id]);

  const handleFileChange = async (event: any) => {
    const file = event.target.files[0]
    setLocalAvatar(file)
    setIsLoading(true)
    const res = await updateUserAvatar(session.data.user_uuid, file, access_token)
    // wait for 1 second to show loading animation
    await new Promise((r) => setTimeout(r, 1500))
    if (res.success === false) {
      setError(res.HTTPmessage)
    } else {
      setIsLoading(false)
      setError('')
      setSuccess('Avatar Updated')
    }
  }

  const handleEmailChange = async (newEmail: string) => {
    toast.success('Profile Updated Successfully', { duration: 4000 })
    
    // Show message about logging in with new email
    toast((t: any) => (
      <div className="flex items-center gap-2">
        <span>Please login again with your new email: {newEmail}</span>
      </div>
    ), { 
      duration: 4000,
      icon: 'ğŸ“§'
    })

    // Wait for 4 seconds before signing out
    await new Promise(resolve => setTimeout(resolve, 4000))
    signOut({ redirect: true, callbackUrl: getUriWithoutOrg('/') })
  }

  if (!userData) {
    return (
      <div className="sm:mx-10 mx-0 bg-white rounded-xl nice-shadow p-8">
        <div className="flex items-center justify-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
        </div>
      </div>
    );
  }

  return (
    <div className="sm:mx-10 mx-0 bg-white rounded-xl nice-shadow">
      <Formik<FormValues>
        enableReinitialize
        initialValues={{
          username: userData.username,
          first_name: userData.first_name,
          last_name: userData.last_name,
          email: userData.email,
          bio: userData.bio || '',
          details: userData.details || {},
        }}
        validationSchema={validationSchema}
        onSubmit={(values, { setSubmitting }) => {
          const isEmailChanged = values.email !== userData.email
          const loadingToast = toast.loading('Updating profile...')
          
          setTimeout(() => {
            setSubmitting(false)
            updateProfile(values, userData.id, access_token)
              .then(() => {
                toast.dismiss(loadingToast)
                if (isEmailChanged) {
                  handleEmailChange(values.email)
                } else {
                  toast.success('Profile Updated Successfully')
                }
                // Refresh user data after successful update
                getUser(userData.id, access_token).then(setUserData);
              })
              .catch(() => {
                toast.error('Failed to update profile', { id: loadingToast })
              })
          }, 400)
        }}
      >
        {(formikProps) => (
          <UserEditForm
            {...formikProps}
            profilePicture={{
              error,
              success,
              isLoading,
              localAvatar,
              handleFileChange
            }}
          />
        )}
      </Formik>
    </div>
  );
}

export default UserEditGeneral



================================================
FILE: apps/web/components/Dashboard/Pages/UserAccount/UserEditPassword/UserEditPassword.tsx
================================================
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { updatePassword } from '@services/settings/password'
import { Formik, Form } from 'formik'
import React, { useEffect } from 'react'
import { AlertTriangle } from 'lucide-react'
import { Input } from "@components/ui/input"
import { Button } from "@components/ui/button"
import { Label } from "@components/ui/label"
import { toast } from 'react-hot-toast'
import { signOut } from 'next-auth/react'
import { getUriWithoutOrg } from '@services/config/config'
import * as Yup from 'yup'

const validationSchema = Yup.object().shape({
  old_password: Yup.string().required('Current password is required'),
  new_password: Yup.string()
    .required('New password is required')
    .min(8, 'Password must be at least 8 characters'),
})

function UserEditPassword() {
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token;

  const updatePasswordUI = async (values: any) => {
    const loadingToast = toast.loading('Updating password...')
    try {
      let user_id = session.data.user.id
      const response = await updatePassword(user_id, values, access_token)
      
      if (response.success) {
        toast.dismiss(loadingToast)
        
        // Show success message and notify about logout
        toast.success('Password updated successfully', { duration: 4000 })
        toast((t: any) => (
          <div className="flex items-center gap-2">
            <span>Please login again with your new password</span>
          </div>
        ), { 
          duration: 4000,
          icon: 'ğŸ”‘'
        })

        // Wait for 4 seconds before signing out
        await new Promise(resolve => setTimeout(resolve, 4000))
        signOut({ redirect: true, callbackUrl: getUriWithoutOrg('/') })
      } else {
        toast.error(response.data.detail || 'Failed to update password', { id: loadingToast })
      }
    } catch (error: any) {
      const errorMessage = error.data?.detail || 'Failed to update password. Please try again.'
      toast.error(errorMessage, { id: loadingToast })
      console.error('Password update error:', error)
    }
  }

  useEffect(() => { }, [session])

  return (
    <div className="sm:mx-10 mx-0 bg-white rounded-xl nice-shadow">
      <div className="flex flex-col">
        <div className="flex flex-col bg-gray-50 -space-y-1 px-5 py-3 mx-3 my-3 rounded-md">
          <h1 className="font-bold text-xl text-gray-800">
            Change Password
          </h1>
          <h2 className="text-gray-500 text-md">
            Update your password to keep your account secure
          </h2>
        </div>

        <div className="px-8 py-6">
          <Formik
            initialValues={{ old_password: '', new_password: '' }}
            validationSchema={validationSchema}
            onSubmit={(values, { setSubmitting }) => {
              setTimeout(() => {
                setSubmitting(false)
                updatePasswordUI(values)
              }, 400)
            }}
          >
            {({ isSubmitting, handleChange, errors, touched }) => (
              <Form className="w-full max-w-2xl mx-auto space-y-6">
                <div>
                  <Label htmlFor="old_password">Current Password</Label>
                  <Input
                    type="password"
                    id="old_password"
                    name="old_password"
                    onChange={handleChange}
                    className="mt-1"
                  />
                  {touched.old_password && errors.old_password && (
                    <p className="text-red-500 text-sm mt-1">{errors.old_password}</p>
                  )}
                </div>

                <div>
                  <Label htmlFor="new_password">New Password</Label>
                  <Input
                    type="password"
                    id="new_password"
                    name="new_password"
                    onChange={handleChange}
                    className="mt-1"
                  />
                  {touched.new_password && errors.new_password && (
                    <p className="text-red-500 text-sm mt-1">{errors.new_password}</p>
                  )}
                </div>

                <div className="flex items-center space-x-2 text-amber-600 bg-amber-50 p-3 rounded-md">
                  <AlertTriangle size={16} />
                  <span className="text-sm">You will be logged out after changing your password</span>
                </div>

                <div className="flex justify-end pt-2">
                  <Button 
                    type="submit" 
                    disabled={isSubmitting}
                    className="bg-black text-white hover:bg-black/90"
                  >
                    {isSubmitting ? 'Updating...' : 'Update Password'}
                  </Button>
                </div>
              </Form>
            )}
          </Formik>
        </div>
      </div>
    </div>
  )
}

export default UserEditPassword



================================================
FILE: apps/web/components/Dashboard/Pages/UserAccount/UserProfile/UserProfile.tsx
================================================
import React from 'react'
import UserProfileBuilder from './UserProfileBuilder'

function UserProfile() {
  return (
    <div>
      <UserProfileBuilder />
    </div>
  )
}

export default UserProfile


================================================
FILE: apps/web/components/Dashboard/Pages/UserAccount/UserProfile/UserProfileBuilder.tsx
================================================
import React from 'react'
import { DragDropContext, Droppable, Draggable } from '@hello-pangea/dnd'
import { Plus, Trash2, GripVertical, ImageIcon, Link as LinkIcon, Award, Edit, TextIcon, Briefcase, GraduationCap, MapPin, BookOpen } from 'lucide-react'
import { Input } from "@components/ui/input"
import { Textarea } from "@components/ui/textarea"
import { Label } from "@components/ui/label"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@components/ui/select"
import { Button } from "@components/ui/button"
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { updateProfile } from '@services/settings/profile'
import { getUser } from '@services/users/users'
import { toast } from 'react-hot-toast'

// Define section types and their configurations
const SECTION_TYPES = {
  'image-gallery': {
    icon: ImageIcon,
    label: 'Image Gallery',
    description: 'Add a collection of images'
  },
  'text': {
    icon: TextIcon,
    label: 'Text',
    description: 'Add formatted text content'
  },
  'links': {
    icon: LinkIcon,
    label: 'Links',
    description: 'Add social or professional links'
  },
  'skills': {
    icon: Award,
    label: 'Skills',
    description: 'Showcase your skills and expertise'
  },
  'experience': {
    icon: Briefcase,
    label: 'Experience',
    description: 'Add work or project experience'
  },
  'education': {
    icon: GraduationCap,
    label: 'Education',
    description: 'Add educational background'
  },
  'affiliation': {
    icon: MapPin,
    label: 'Affiliation',
    description: 'Add organizational affiliations'
  },
  'courses': {
    icon: BookOpen,
    label: 'Courses',
    description: 'Display authored courses'
  }
} as const

// Type definitions
interface ProfileImage {
  url: string;
  caption?: string;
}

interface ProfileLink {
  title: string;
  url: string;
  icon?: string;
}

interface ProfileSkill {
  name: string;
  level?: 'beginner' | 'intermediate' | 'advanced' | 'expert';
  category?: string;
}

interface ProfileExperience {
  title: string;
  organization: string;
  startDate: string;
  endDate?: string;
  current: boolean;
  description: string;
}

interface ProfileEducation {
  institution: string;
  degree: string;
  field: string;
  startDate: string;
  endDate?: string;
  current: boolean;
  description?: string;
}

interface ProfileAffiliation {
  name: string;
  description: string;
  logoUrl: string;
}

interface Course {
  id: string;
  title: string;
  description: string;
  thumbnail?: string;
  status: string;
}

interface BaseSection {
  id: string;
  type: keyof typeof SECTION_TYPES;
  title: string;
}

interface ImageGallerySection extends BaseSection {
  type: 'image-gallery';
  images: ProfileImage[];
}

interface TextSection extends BaseSection {
  type: 'text';
  content: string;
}

interface LinksSection extends BaseSection {
  type: 'links';
  links: ProfileLink[];
}

interface SkillsSection extends BaseSection {
  type: 'skills';
  skills: ProfileSkill[];
}

interface ExperienceSection extends BaseSection {
  type: 'experience';
  experiences: ProfileExperience[];
}

interface EducationSection extends BaseSection {
  type: 'education';
  education: ProfileEducation[];
}

interface AffiliationSection extends BaseSection {
  type: 'affiliation';
  affiliations: ProfileAffiliation[];
}

interface CoursesSection extends BaseSection {
  type: 'courses';
  // No need to store courses as they will be fetched from API
}

type ProfileSection = 
  | ImageGallerySection 
  | TextSection 
  | LinksSection 
  | SkillsSection 
  | ExperienceSection 
  | EducationSection
  | AffiliationSection
  | CoursesSection;

interface ProfileData {
  sections: ProfileSection[];
}

const UserProfileBuilder = () => {
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token
  const [profileData, setProfileData] = React.useState<ProfileData>({
    sections: []
  })
  const [selectedSection, setSelectedSection] = React.useState<number | null>(null)
  const [isSaving, setIsSaving] = React.useState(false)
  const [isLoading, setIsLoading] = React.useState(true)

  // Initialize profile data from user data
  React.useEffect(() => {
    const fetchUserData = async () => {
      if (session?.data?.user?.id && access_token) {
        try {
          setIsLoading(true)
          const userData = await getUser(session.data.user.id)
          
          if (userData.profile) {
            try {
              const profileSections = typeof userData.profile === 'string'
                ? JSON.parse(userData.profile).sections
                : userData.profile.sections;

              setProfileData({
                sections: profileSections || []
              });
            } catch (error) {
              console.error('Error parsing profile data:', error);
              setProfileData({ sections: [] });
            }
          }
        } catch (error) {
          console.error('Error fetching user data:', error);
          toast.error('Failed to load profile data');
        } finally {
          setIsLoading(false)
        }
      }
    };

    fetchUserData();
  }, [session?.data?.user?.id, access_token])

  const createEmptySection = (type: keyof typeof SECTION_TYPES): ProfileSection => {
    const baseSection = {
      id: `section-${Date.now()}`,
      type,
      title: `${SECTION_TYPES[type].label} Section`
    }

    switch (type) {
      case 'image-gallery':
        return {
          ...baseSection,
          type: 'image-gallery',
          images: []
        }
      case 'text':
        return {
          ...baseSection,
          type: 'text',
          content: ''
        }
      case 'links':
        return {
          ...baseSection,
          type: 'links',
          links: []
        }
      case 'skills':
        return {
          ...baseSection,
          type: 'skills',
          skills: []
        }
      case 'experience':
        return {
          ...baseSection,
          type: 'experience',
          experiences: []
        }
      case 'education':
        return {
          ...baseSection,
          type: 'education',
          education: []
        }
      case 'affiliation':
        return {
          ...baseSection,
          type: 'affiliation',
          affiliations: []
        }
      case 'courses':
        return {
          ...baseSection,
          type: 'courses'
        }
    }
  }

  const addSection = (type: keyof typeof SECTION_TYPES) => {
    const newSection = createEmptySection(type)
    setProfileData(prev => ({
      ...prev,
      sections: [...prev.sections, newSection]
    }))
    setSelectedSection(profileData.sections.length)
  }

  const updateSection = (index: number, updatedSection: ProfileSection) => {
    const newSections = [...profileData.sections]
    newSections[index] = updatedSection
    setProfileData(prev => ({
      ...prev,
      sections: newSections
    }))
  }

  const deleteSection = (index: number) => {
    setProfileData(prev => ({
      ...prev,
      sections: prev.sections.filter((_, i) => i !== index)
    }))
    setSelectedSection(null)
  }

  const onDragEnd = (result: any) => {
    if (!result.destination) return

    const items = Array.from(profileData.sections)
    const [reorderedItem] = items.splice(result.source.index, 1)
    items.splice(result.destination.index, 0, reorderedItem)

    setProfileData(prev => ({
      ...prev,
      sections: items
    }))
    setSelectedSection(result.destination.index)
  }

  const handleSave = async () => {
    setIsSaving(true)
    const loadingToast = toast.loading('Saving profile...')

    try {
      // Get fresh user data before update
      const userData = await getUser(session.data.user.id)
      
      // Update only the profile field
      userData.profile = profileData

      const res = await updateProfile(userData, userData.id, access_token)

      if (res.status === 200) {
        toast.success('Profile updated successfully', { id: loadingToast })
      } else {
        throw new Error('Failed to update profile')
      }
    } catch (error) {
      console.error('Error updating profile:', error)
      toast.error('Error updating profile', { id: loadingToast })
    } finally {
      setIsSaving(false)
    }
  }

  if (isLoading) {
    return (
      <div className="sm:mx-10 mx-0 bg-white rounded-xl nice-shadow p-6">
        <div className="flex items-center justify-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
        </div>
      </div>
    )
  }

  return (
    <div className="sm:mx-10 mx-0 bg-white rounded-xl nice-shadow">
      <div className="p-6 space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between border-b pb-4">
          <div>
            <h2 className="text-xl font-semibold flex items-center">Profile Builder <div className="text-xs ml-2 bg-gray-200 text-gray-700 px-2 py-1 rounded-full">BETA</div></h2>
            <p className="text-gray-600">Customize your professional profile</p>
          </div>
          <Button 
            variant="default" 
            onClick={handleSave}
            disabled={isSaving}
            className="bg-black hover:bg-black/90"
          >
            {isSaving ? 'Saving...' : 'Save Changes'}
          </Button>
        </div>

        {/* Main Content */}
        <div className="grid grid-cols-4 gap-6">
          {/* Sections Panel */}
          <div className="col-span-1 border-r pr-4">
            <h3 className="font-medium mb-4">Sections</h3>
            <DragDropContext onDragEnd={onDragEnd}>
              <Droppable droppableId="sections">
                {(provided) => (
                  <div
                    {...provided.droppableProps}
                    ref={provided.innerRef}
                    className="space-y-2"
                  >
                    {profileData.sections.map((section, index) => (
                      <Draggable
                        key={section.id}
                        draggableId={section.id}
                        index={index}
                      >
                        {(provided, snapshot) => (
                          <div
                            ref={provided.innerRef}
                            {...provided.draggableProps}
                            onClick={() => setSelectedSection(index)}
                            className={`p-4 bg-white/80 backdrop-blur-xs rounded-lg cursor-pointer border ${
                              selectedSection === index 
                                ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-500/20 shadow-xs' 
                                : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50/50 hover:shadow-xs'
                            } ${snapshot.isDragging ? 'shadow-lg ring-2 ring-blue-500/20 rotate-2' : ''}`}
                          >
                            <div className="flex items-center justify-between group">
                              <div className="flex items-center space-x-3">
                                <div {...provided.dragHandleProps} 
                                  className={`p-1.5 rounded-md transition-colors duration-200 ${
                                    selectedSection === index 
                                      ? 'text-blue-500 bg-blue-100/50' 
                                      : 'text-gray-400 hover:text-gray-600 hover:bg-gray-100'
                                  }`}>
                                  <GripVertical size={16} />
                                </div>
                                <div className={`p-1.5 rounded-md ${
                                  selectedSection === index 
                                    ? 'text-blue-600 bg-blue-100/50' 
                                    : 'text-gray-600 bg-gray-100/50'
                                }`}>
                                  {React.createElement(SECTION_TYPES[section.type].icon, {
                                    size: 16
                                  })}
                                </div>
                                <span className={`text-sm font-medium truncate ${
                                  selectedSection === index 
                                    ? 'text-blue-700' 
                                    : 'text-gray-700'
                                }`}>
                                  {section.title}
                                </span>
                              </div>
                              <div className="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation()
                                    setSelectedSection(index)
                                  }}
                                  className={`p-1.5 rounded-md transition-colors duration-200 ${
                                    selectedSection === index
                                      ? 'text-blue-500 hover:bg-blue-100'
                                      : 'text-gray-400 hover:text-gray-600 hover:bg-gray-100'
                                  }`}
                                >
                                  <Edit size={14} />
                                </button>
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation()
                                    deleteSection(index)
                                  }}
                                  className="p-1.5 text-red-400 hover:text-red-500 hover:bg-red-50 rounded-md transition-colors duration-200"
                                >
                                  <Trash2 size={14} />
                                </button>
                              </div>
                            </div>
                          </div>
                        )}
                      </Draggable>
                    ))}
                    {provided.placeholder}
                  </div>
                )}
              </Droppable>
            </DragDropContext>

            <div className="pt-4">
              <Select
                onValueChange={(value: keyof typeof SECTION_TYPES) => {
                  if (value) {
                    addSection(value)
                  }
                }}
              >
                <SelectTrigger className="w-full p-0 border-0 bg-black">
                  <div className="w-full">
                    <Button variant="default" className="w-full bg-black hover:bg-black/90 text-white">
                      <Plus className="h-4 w-4 mr-2" />
                      Add Section
                    </Button>
                  </div>
                </SelectTrigger>
                <SelectContent>
                  {Object.entries(SECTION_TYPES).map(([type, { icon: Icon, label, description }]) => (
                    <SelectItem key={type} value={type}>
                      <div className="flex items-center space-x-3 py-1">
                        <div className="p-1.5 bg-gray-50 rounded-md">
                          <Icon size={16} className="text-gray-600" />
                        </div>
                        <div className="flex-1">
                          <div className="font-medium text-sm text-gray-700">{label}</div>
                          <div className="text-xs text-gray-500">{description}</div>
                        </div>
                      </div>
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          </div>

          {/* Editor Panel */}
          <div className="col-span-3">
            {selectedSection !== null ? (
              <SectionEditor
                section={profileData.sections[selectedSection]}
                onChange={(updatedSection) => updateSection(selectedSection, updatedSection as ProfileSection)}
              />
            ) : (
              <div className="h-full flex items-center justify-center text-gray-500">
                Select a section to edit or add a new one
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  )
}

interface SectionEditorProps {
  section: ProfileSection;
  onChange: (section: ProfileSection) => void;
}

const SectionEditor: React.FC<SectionEditorProps> = ({ section, onChange }) => {
  switch (section.type) {
    case 'image-gallery':
      return <ImageGalleryEditor section={section} onChange={onChange} />
    case 'text':
      return <TextEditor section={section} onChange={onChange} />
    case 'links':
      return <LinksEditor section={section} onChange={onChange} />
    case 'skills':
      return <SkillsEditor section={section} onChange={onChange} />
    case 'experience':
      return <ExperienceEditor section={section} onChange={onChange} />
    case 'education':
      return <EducationEditor section={section} onChange={onChange} />
    case 'affiliation':
      return <AffiliationEditor section={section} onChange={onChange} />
    case 'courses':
      return <CoursesEditor section={section} onChange={onChange} />
    default:
      return <div>Unknown section type</div>
  }
}

const ImageGalleryEditor: React.FC<{
  section: ImageGallerySection;
  onChange: (section: ImageGallerySection) => void;
}> = ({ section, onChange }) => {
  return (
    <div className="space-y-6 p-6 bg-white rounded-lg nice-shadow">
      <div className="flex items-center space-x-2">
        <ImageIcon className="w-5 h-5 text-gray-500" />
        <h3 className="font-medium text-lg">Image Gallery</h3>
      </div>
      
      <div className="space-y-4">
        {/* Title */}
        <div>
          <Label htmlFor="title">Section Title</Label>
          <Input
            id="title"
            value={section.title}
            onChange={(e) => onChange({ ...section, title: e.target.value })}
            placeholder="Enter section title"
          />
        </div>

        {/* Images */}
        <div>
          <Label>Images</Label>
          <div className="space-y-3 mt-2">
            {section.images.map((image, index) => (
              <div key={index} className="grid grid-cols-[2fr_1fr_auto] gap-4 p-4 border rounded-lg">
                <div>
                  <Label>Image URL</Label>
                  <Input
                    value={image.url}
                    onChange={(e) => {
                      const newImages = [...section.images]
                      newImages[index] = { ...image, url: e.target.value }
                      onChange({ ...section, images: newImages })
                    }}
                    placeholder="Enter image URL"
                  />
                </div>
                <div>
                  <Label>Caption</Label>
                  <Input
                    value={image.caption || ''}
                    onChange={(e) => {
                      const newImages = [...section.images]
                      newImages[index] = { ...image, caption: e.target.value }
                      onChange({ ...section, images: newImages })
                    }}
                    placeholder="Image caption"
                  />
                </div>
                <div className="flex flex-col justify-between">
                  <Label>&nbsp;</Label>
                  <Button
                    variant="ghost"
                    size="icon"
                    onClick={() => {
                      const newImages = section.images.filter((_, i) => i !== index)
                      onChange({ ...section, images: newImages })
                    }}
                    className="text-red-500 hover:text-red-600 hover:bg-red-50"
                  >
                    <Trash2 className="h-4 w-4" />
                  </Button>
                </div>
                {image.url && (
                  <div className="col-span-3">
                    <img
                      src={image.url}
                      alt={image.caption || ''}
                      className="mt-2 max-h-32 rounded-lg object-cover"
                    />
                  </div>
                )}
              </div>
            ))}
            <Button
              variant="outline"
              onClick={() => {
                const newImage: ProfileImage = {
                  url: '',
                  caption: ''
                }
                onChange({
                  ...section,
                  images: [...section.images, newImage]
                })
              }}
              className="w-full"
            >
              <Plus className="h-4 w-4 mr-2" />
              Add Image
            </Button>
          </div>
        </div>
      </div>
    </div>
  )
}

const TextEditor: React.FC<{
  section: TextSection;
  onChange: (section: TextSection) => void;
}> = ({ section, onChange }) => {
  return (
    <div className="space-y-6 p-6 bg-white rounded-lg nice-shadow">
      <div className="flex items-center space-x-2">
        <TextIcon className="w-5 h-5 text-gray-500" />
        <h3 className="font-medium text-lg">Text Content</h3>
      </div>
      
      <div className="space-y-4">
        {/* Title */}
        <div>
          <Label htmlFor="title">Section Title</Label>
          <Input
            id="title"
            value={section.title}
            onChange={(e) => onChange({ ...section, title: e.target.value })}
            placeholder="Enter section title"
          />
        </div>

        {/* Content */}
        <div>
          <Label htmlFor="content">Content</Label>
          <Textarea
            id="content"
            value={section.content}
            onChange={(e) => onChange({ ...section, content: e.target.value })}
            placeholder="Enter your content here..."
            className="min-h-[200px]"
          />
        </div>
      </div>
    </div>
  )
}

const LinksEditor: React.FC<{
  section: LinksSection;
  onChange: (section: LinksSection) => void;
}> = ({ section, onChange }) => {
  return (
    <div className="space-y-6 p-6 bg-white rounded-lg nice-shadow">
      <div className="flex items-center space-x-2">
        <LinkIcon className="w-5 h-5 text-gray-500" />
        <h3 className="font-medium text-lg">Links</h3>
      </div>
      
      <div className="space-y-4">
        {/* Title */}
        <div>
          <Label htmlFor="title">Section Title</Label>
          <Input
            id="title"
            value={section.title}
            onChange={(e) => onChange({ ...section, title: e.target.value })}
            placeholder="Enter section title"
          />
        </div>

        {/* Links */}
        <div>
          <Label>Links</Label>
          <div className="space-y-3 mt-2">
            {section.links.map((link, index) => (
              <div key={index} className="grid grid-cols-[1fr_1fr_auto] gap-2 p-4 border rounded-lg">
                <Input
                  value={link.title}
                  onChange={(e) => {
                    const newLinks = [...section.links]
                    newLinks[index] = { ...link, title: e.target.value }
                    onChange({ ...section, links: newLinks })
                  }}
                  placeholder="Link title"
                />
                <Input
                  value={link.url}
                  onChange={(e) => {
                    const newLinks = [...section.links]
                    newLinks[index] = { ...link, url: e.target.value }
                    onChange({ ...section, links: newLinks })
                  }}
                  placeholder="URL"
                />
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={() => {
                    const newLinks = section.links.filter((_, i) => i !== index)
                    onChange({ ...section, links: newLinks })
                  }}
                  className="text-red-500 hover:text-red-600 hover:bg-red-50"
                >
                  <Trash2 className="h-4 w-4" />
                </Button>
              </div>
            ))}
            <Button
              variant="outline"
              onClick={() => {
                const newLink: ProfileLink = {
                  title: '',
                  url: ''
                }
                onChange({
                  ...section,
                  links: [...section.links, newLink]
                })
              }}
              className="w-full"
            >
              <Plus className="h-4 w-4 mr-2" />
              Add Link
            </Button>
          </div>
        </div>
      </div>
    </div>
  )
}

const SkillsEditor: React.FC<{
  section: SkillsSection;
  onChange: (section: SkillsSection) => void;
}> = ({ section, onChange }) => {
  return (
    <div className="space-y-6 p-6 bg-white rounded-lg nice-shadow">
      <div className="flex items-center space-x-2">
        <Award className="w-5 h-5 text-gray-500" />
        <h3 className="font-medium text-lg">Skills</h3>
      </div>
      
      <div className="space-y-4">
        {/* Title */}
        <div>
          <Label htmlFor="title">Section Title</Label>
          <Input
            id="title"
            value={section.title}
            onChange={(e) => onChange({ ...section, title: e.target.value })}
            placeholder="Enter section title"
          />
        </div>

        {/* Skills */}
        <div>
          <Label>Skills</Label>
          <div className="space-y-3 mt-2">
            {section.skills.map((skill, index) => (
              <div key={index} className="grid grid-cols-[1fr_1fr_1fr_auto] gap-2 p-4 border rounded-lg">
                <Input
                  value={skill.name}
                  onChange={(e) => {
                    const newSkills = [...section.skills]
                    newSkills[index] = { ...skill, name: e.target.value }
                    onChange({ ...section, skills: newSkills })
                  }}
                  placeholder="Skill name"
                />
                <Select
                  value={skill.level || 'intermediate'}
                  onValueChange={(value) => {
                    const newSkills = [...section.skills]
                    newSkills[index] = { ...skill, level: value as ProfileSkill['level'] }
                    onChange({ ...section, skills: newSkills })
                  }}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Select level" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="beginner">Beginner</SelectItem>
                    <SelectItem value="intermediate">Intermediate</SelectItem>
                    <SelectItem value="advanced">Advanced</SelectItem>
                    <SelectItem value="expert">Expert</SelectItem>
                  </SelectContent>
                </Select>
                <Input
                  value={skill.category || ''}
                  onChange={(e) => {
                    const newSkills = [...section.skills]
                    newSkills[index] = { ...skill, category: e.target.value }
                    onChange({ ...section, skills: newSkills })
                  }}
                  placeholder="Category (optional)"
                />
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={() => {
                    const newSkills = section.skills.filter((_, i) => i !== index)
                    onChange({ ...section, skills: newSkills })
                  }}
                  className="text-red-500 hover:text-red-600 hover:bg-red-50"
                >
                  <Trash2 className="h-4 w-4" />
                </Button>
              </div>
            ))}
            <Button
              variant="outline"
              onClick={() => {
                const newSkill: ProfileSkill = {
                  name: '',
                  level: 'intermediate'
                }
                onChange({
                  ...section,
                  skills: [...section.skills, newSkill]
                })
              }}
              className="w-full"
            >
              <Plus className="h-4 w-4 mr-2" />
              Add Skill
            </Button>
          </div>
        </div>
      </div>
    </div>
  )
}

const ExperienceEditor: React.FC<{
  section: ExperienceSection;
  onChange: (section: ExperienceSection) => void;
}> = ({ section, onChange }) => {
  return (
    <div className="space-y-6 p-6 bg-white rounded-lg nice-shadow">
      <div className="flex items-center space-x-2">
        <Briefcase className="w-5 h-5 text-gray-500" />
        <h3 className="font-medium text-lg">Experience</h3>
      </div>
      
      <div className="space-y-4">
        {/* Title */}
        <div>
          <Label htmlFor="title">Section Title</Label>
          <Input
            id="title"
            value={section.title}
            onChange={(e) => onChange({ ...section, title: e.target.value })}
            placeholder="Enter section title"
          />
        </div>

        {/* Experiences */}
        <div>
          <Label>Experience Items</Label>
          <div className="space-y-4 mt-2">
            {section.experiences.map((experience, index) => (
              <div key={index} className="space-y-4 p-4 border rounded-lg">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label>Title</Label>
                    <Input
                      value={experience.title}
                      onChange={(e) => {
                        const newExperiences = [...section.experiences]
                        newExperiences[index] = { ...experience, title: e.target.value }
                        onChange({ ...section, experiences: newExperiences })
                      }}
                      placeholder="Position or role"
                    />
                  </div>
                  <div>
                    <Label>Organization</Label>
                    <Input
                      value={experience.organization}
                      onChange={(e) => {
                        const newExperiences = [...section.experiences]
                        newExperiences[index] = { ...experience, organization: e.target.value }
                        onChange({ ...section, experiences: newExperiences })
                      }}
                      placeholder="Company or organization"
                    />
                  </div>
                </div>

                <div className="grid grid-cols-[1fr_1fr_auto] gap-4">
                  <div>
                    <Label>Start Date</Label>
                    <Input
                      type="date"
                      value={experience.startDate}
                      onChange={(e) => {
                        const newExperiences = [...section.experiences]
                        newExperiences[index] = { ...experience, startDate: e.target.value }
                        onChange({ ...section, experiences: newExperiences })
                      }}
                    />
                  </div>
                  <div>
                    <Label>End Date</Label>
                    <Input
                      type="date"
                      value={experience.endDate || ''}
                      onChange={(e) => {
                        const newExperiences = [...section.experiences]
                        newExperiences[index] = { ...experience, endDate: e.target.value }
                        onChange({ ...section, experiences: newExperiences })
                      }}
                      disabled={experience.current}
                    />
                  </div>
                  <div className="flex items-end">
                    <div className="flex items-center space-x-2">
                      <input
                        type="checkbox"
                        id={`current-${index}`}
                        checked={experience.current}
                        onChange={(e) => {
                          const newExperiences = [...section.experiences]
                          newExperiences[index] = { 
                            ...experience, 
                            current: e.target.checked,
                            endDate: e.target.checked ? undefined : experience.endDate 
                          }
                          onChange({ ...section, experiences: newExperiences })
                        }}
                        className="rounded border-gray-300"
                      />
                      <Label htmlFor={`current-${index}`}>Current</Label>
                    </div>
                  </div>
                </div>

                <div>
                  <Label>Description</Label>
                  <Textarea
                    value={experience.description}
                    onChange={(e) => {
                      const newExperiences = [...section.experiences]
                      newExperiences[index] = { ...experience, description: e.target.value }
                      onChange({ ...section, experiences: newExperiences })
                    }}
                    placeholder="Describe your role and achievements"
                    className="min-h-[100px]"
                  />
                </div>

                <div className="flex justify-end">
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => {
                      const newExperiences = section.experiences.filter((_, i) => i !== index)
                      onChange({ ...section, experiences: newExperiences })
                    }}
                    className="text-red-500 hover:text-red-600 hover:bg-red-50"
                  >
                    <Trash2 className="h-4 w-4 mr-2" />
                    Remove
                  </Button>
                </div>
              </div>
            ))}
            <Button
              variant="outline"
              onClick={() => {
                const newExperience: ProfileExperience = {
                  title: '',
                  organization: '',
                  startDate: new Date().toISOString().split('T')[0],
                  current: false,
                  description: ''
                }
                onChange({
                  ...section,
                  experiences: [...section.experiences, newExperience]
                })
              }}
              className="w-full"
            >
              <Plus className="h-4 w-4 mr-2" />
              Add Experience
            </Button>
          </div>
        </div>
      </div>
    </div>
  )
}

const EducationEditor: React.FC<{
  section: EducationSection;
  onChange: (section: EducationSection) => void;
}> = ({ section, onChange }) => {
  return (
    <div className="space-y-6 p-6 bg-white rounded-lg nice-shadow">
      <div className="flex items-center space-x-2">
        <GraduationCap className="w-5 h-5 text-gray-500" />
        <h3 className="font-medium text-lg">Education</h3>
      </div>
      
      <div className="space-y-4">
        {/* Title */}
        <div>
          <Label htmlFor="title">Section Title</Label>
          <Input
            id="title"
            value={section.title}
            onChange={(e) => onChange({ ...section, title: e.target.value })}
            placeholder="Enter section title"
          />
        </div>

        {/* Education Items */}
        <div>
          <Label>Education Items</Label>
          <div className="space-y-4 mt-2">
            {section.education.map((edu, index) => (
              <div key={index} className="space-y-4 p-4 border rounded-lg">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label>Institution</Label>
                    <Input
                      value={edu.institution}
                      onChange={(e) => {
                        const newEducation = [...section.education]
                        newEducation[index] = { ...edu, institution: e.target.value }
                        onChange({ ...section, education: newEducation })
                      }}
                      placeholder="School or university"
                    />
                  </div>
                  <div>
                    <Label>Degree</Label>
                    <Input
                      value={edu.degree}
                      onChange={(e) => {
                        const newEducation = [...section.education]
                        newEducation[index] = { ...edu, degree: e.target.value }
                        onChange({ ...section, education: newEducation })
                      }}
                      placeholder="Degree type"
                    />
                  </div>
                </div>

                <div>
                  <Label>Field of Study</Label>
                  <Input
                    value={edu.field}
                    onChange={(e) => {
                      const newEducation = [...section.education]
                      newEducation[index] = { ...edu, field: e.target.value }
                      onChange({ ...section, education: newEducation })
                    }}
                    placeholder="Major or concentration"
                  />
                </div>

                <div className="grid grid-cols-[1fr_1fr_auto] gap-4">
                  <div>
                    <Label>Start Date</Label>
                    <Input
                      type="date"
                      value={edu.startDate}
                      onChange={(e) => {
                        const newEducation = [...section.education]
                        newEducation[index] = { ...edu, startDate: e.target.value }
                        onChange({ ...section, education: newEducation })
                      }}
                    />
                  </div>
                  <div>
                    <Label>End Date</Label>
                    <Input
                      type="date"
                      value={edu.endDate || ''}
                      onChange={(e) => {
                        const newEducation = [...section.education]
                        newEducation[index] = { ...edu, endDate: e.target.value }
                        onChange({ ...section, education: newEducation })
                      }}
                      disabled={edu.current}
                    />
                  </div>
                  <div className="flex items-end">
                    <div className="flex items-center space-x-2">
                      <input
                        type="checkbox"
                        id={`current-edu-${index}`}
                        checked={edu.current}
                        onChange={(e) => {
                          const newEducation = [...section.education]
                          newEducation[index] = { 
                            ...edu, 
                            current: e.target.checked,
                            endDate: e.target.checked ? undefined : edu.endDate 
                          }
                          onChange({ ...section, education: newEducation })
                        }}
                        className="rounded border-gray-300"
                      />
                      <Label htmlFor={`current-edu-${index}`}>Current</Label>
                    </div>
                  </div>
                </div>

                <div>
                  <Label>Description</Label>
                  <Textarea
                    value={edu.description || ''}
                    onChange={(e) => {
                      const newEducation = [...section.education]
                      newEducation[index] = { ...edu, description: e.target.value }
                      onChange({ ...section, education: newEducation })
                    }}
                    placeholder="Additional details about your education"
                    className="min-h-[100px]"
                  />
                </div>

                <div className="flex justify-end">
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => {
                      const newEducation = section.education.filter((_, i) => i !== index)
                      onChange({ ...section, education: newEducation })
                    }}
                    className="text-red-500 hover:text-red-600 hover:bg-red-50"
                  >
                    <Trash2 className="h-4 w-4 mr-2" />
                    Remove
                  </Button>
                </div>
              </div>
            ))}
            <Button
              variant="outline"
              onClick={() => {
                const newEducation: ProfileEducation = {
                  institution: '',
                  degree: '',
                  field: '',
                  startDate: new Date().toISOString().split('T')[0],
                  current: false,
                  description: ''
                }
                onChange({
                  ...section,
                  education: [...section.education, newEducation]
                })
              }}
              className="w-full"
            >
              <Plus className="h-4 w-4 mr-2" />
              Add Education
            </Button>
          </div>
        </div>
      </div>
    </div>
  )
}

const AffiliationEditor: React.FC<{
  section: AffiliationSection;
  onChange: (section: AffiliationSection) => void;
}> = ({ section, onChange }) => {
  return (
    <div className="space-y-6 p-6 bg-white rounded-lg nice-shadow">
      <div className="flex items-center space-x-2">
        <MapPin className="w-5 h-5 text-gray-500" />
        <h3 className="font-medium text-lg">Affiliation</h3>
      </div>
      
      <div className="space-y-4">
        {/* Title */}
        <div>
          <Label htmlFor="title">Section Title</Label>
          <Input
            id="title"
            value={section.title}
            onChange={(e) => onChange({ ...section, title: e.target.value })}
            placeholder="Enter section title"
          />
        </div>

        {/* Affiliations */}
        <div>
          <Label>Affiliations</Label>
          <div className="space-y-3 mt-2">
            {section.affiliations.map((affiliation, index) => (
              <div key={index} className="space-y-4 p-4 border rounded-lg">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label>Name</Label>
                    <Input
                      value={affiliation.name}
                      onChange={(e) => {
                        const newAffiliations = [...section.affiliations]
                        newAffiliations[index] = { ...affiliation, name: e.target.value }
                        onChange({ ...section, affiliations: newAffiliations })
                      }}
                      placeholder="Name of the organization"
                    />
                  </div>
                  <div>
                    <Label>Logo URL</Label>
                    <Input
                      value={affiliation.logoUrl}
                      onChange={(e) => {
                        const newAffiliations = [...section.affiliations]
                        newAffiliations[index] = { ...affiliation, logoUrl: e.target.value }
                        onChange({ ...section, affiliations: newAffiliations })
                      }}
                      placeholder="URL to the organization's logo"
                    />
                  </div>
                </div>

                <div>
                  <Label>Description</Label>
                  <Textarea
                    value={affiliation.description}
                    onChange={(e) => {
                      const newAffiliations = [...section.affiliations]
                      newAffiliations[index] = { ...affiliation, description: e.target.value }
                      onChange({ ...section, affiliations: newAffiliations })
                    }}
                    placeholder="Description of the organization"
                    className="min-h-[100px]"
                  />
                </div>

                <div className="flex justify-end">
                  <Button
                    variant="ghost"
                    onClick={() => {
                      const newAffiliations = section.affiliations.filter((_, i) => i !== index)
                      onChange({ ...section, affiliations: newAffiliations })
                    }}
                    className="text-red-500 hover:text-red-600 hover:bg-red-50"
                  >
                    <Trash2 className="h-4 w-4 mr-2" />
                    Remove
                  </Button>
                </div>
              </div>
            ))}
            <Button
              variant="outline"
              onClick={() => {
                const newAffiliation: ProfileAffiliation = {
                  name: '',
                  description: '',
                  logoUrl: ''
                }
                onChange({
                  ...section,
                  affiliations: [...section.affiliations, newAffiliation]
                })
              }}
              className="w-full"
            >
              <Plus className="h-4 w-4 mr-2" />
              Add Affiliation
            </Button>
          </div>
        </div>
      </div>
    </div>
  )
}

const CoursesEditor: React.FC<{
  section: CoursesSection;
  onChange: (section: CoursesSection) => void;
}> = ({ section, onChange }) => {
  return (
    <div className="space-y-6 p-6 bg-white rounded-lg nice-shadow">
      <div className="flex items-center space-x-2">
        <BookOpen className="w-5 h-5 text-gray-500" />
        <h3 className="font-medium text-lg">Courses</h3>
      </div>
      
      <div className="space-y-4">
        {/* Title */}
        <div>
          <Label htmlFor="title">Section Title</Label>
          <Input
            id="title"
            value={section.title}
            onChange={(e) => onChange({ ...section, title: e.target.value })}
            placeholder="Enter section title"
          />
        </div>

        <div className="text-sm text-gray-500 italic">
          Your authored courses will be automatically displayed in this section.
        </div>
      </div>
    </div>
  )
}

export default UserProfileBuilder 


================================================
FILE: apps/web/components/Dashboard/Pages/Users/OrgAccess/OrgAccess.tsx
================================================
import { useOrg } from '@components/Contexts/OrgContext'
import PageLoading from '@components/Objects/Loaders/PageLoading'
import ConfirmationModal from '@components/Objects/StyledElements/ConfirmationModal/ConfirmationModal'
import { getAPIUrl, getUriWithoutOrg } from '@services/config/config'
import { swrFetcher } from '@services/utils/ts/requests'
import { Globe, Ticket, UserSquare, Users, X } from 'lucide-react'
import Link from 'next/link'
import React, { useEffect } from 'react'
import useSWR, { mutate } from 'swr'
import dayjs from 'dayjs'
import {
  changeSignupMechanism,
  deleteInviteCode,
} from '@services/organizations/invites'
import toast from 'react-hot-toast'
import { useRouter } from 'next/navigation'
import Modal from '@components/Objects/StyledElements/Modal/Modal'
import OrgInviteCodeGenerate from '@components/Objects/Modals/Dash/OrgAccess/OrgInviteCodeGenerate'
import { useLHSession } from '@components/Contexts/LHSessionContext'

function OrgAccess() {
  const org = useOrg() as any
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token;
  const { data: invites } = useSWR(
    org ? `${getAPIUrl()}orgs/${org?.id}/invites` : null,
    (url) => swrFetcher(url, access_token)
  )
  const [isLoading, setIsLoading] = React.useState(false)
  const [joinMethod, setJoinMethod] = React.useState('closed')
  const [invitesModal, setInvitesModal] = React.useState(false)
  const router = useRouter()

  async function getOrgJoinMethod() {
    if (org) {
      if (org.config.config.features.members.signup_mode == 'open') {
        setJoinMethod('open')
      } else {
        setJoinMethod('inviteOnly')
      }
    }
  }

  async function deleteInvite(invite: any) {
    const toastId = toast.loading("Deleting...")
    let res = await deleteInviteCode(org.id, invite.invite_code_uuid, access_token)
    if (res.status == 200) {
      mutate(`${getAPIUrl()}orgs/${org.id}/invites`)
      toast.success("Deleted invite code", {id:toastId})
    } else {
      toast.error('Error deleting', {id:toastId})
    }
  }

  async function changeJoinMethod(method: 'open' | 'inviteOnly') {
    const toastId = toast.loading("Changing join method...")
    let res = await changeSignupMechanism(org.id, method, access_token)
    if (res.status == 200) {
      router.refresh()
      mutate(`${getAPIUrl()}orgs/slug/${org?.slug}`)
      toast.success(`Changed join method to ${method}`, {id:toastId})
    } else {
      toast.error('Error changing join method', {id:toastId})
    }
  }

  useEffect(() => {
    if (invites && org) {
      getOrgJoinMethod()
      setIsLoading(false)
    }
  }, [org, invites])

  return (
    <>
      {!isLoading ? (
        <>
          <div className="h-6"></div>
          <div className="ml-10 mr-10 mx-auto bg-white rounded-xl shadow-xs px-4 py-4 anit ">
            <div className="flex flex-col bg-gray-50 -space-y-1  px-5 py-3 rounded-md mb-3 ">
              <h1 className="font-bold text-xl text-gray-800">Join method</h1>
              <h2 className="text-gray-500  text-md">
                {' '}
                Choose how users can join your organization{' '}
              </h2>
            </div>
            <div className="flex space-x-2 mx-auto">
              <ConfirmationModal
                confirmationButtonText="Change to open "
                confirmationMessage="Are you sure you want to change the signup mechanism to open ? This will allow users to join your organization freely."
                dialogTitle={'Change to open ?'}
                dialogTrigger={
                  <div className="w-full h-[160px] bg-slate-100 rounded-lg cursor-pointer hover:bg-slate-200 ease-linear transition-all">
                    {joinMethod == 'open' ? (
                      <div className="bg-green-200 text-green-600 font-bold w-fit my-3 mx-3 absolute text-sm px-3 py-1 rounded-lg">
                        Active
                      </div>
                    ) : null}
                    <div className="flex flex-col space-y-1 justify-center items-center h-full">
                      <Globe className="text-slate-400" size={40}></Globe>
                      <div className="text-2xl text-slate-700 font-bold">
                        Open
                      </div>
                      <div className="text-gray-400 text-center">
                        Users can join freely from the signup page
                      </div>
                    </div>
                  </div>
                }
                functionToExecute={() => {
                  changeJoinMethod('open')
                }}
                status="info"
              ></ConfirmationModal>
              <ConfirmationModal
                confirmationButtonText="Change to closed "
                confirmationMessage="Are you sure you want to change the signup mechanism to closed ? This will allow users to join your organization only by invitation."
                dialogTitle={'Change to closed ?'}
                dialogTrigger={
                  <div className="w-full h-[160px] bg-slate-100 rounded-lg cursor-pointer hover:bg-slate-200 ease-linear transition-all">
                    {joinMethod == 'inviteOnly' ? (
                      <div className="bg-green-200 text-green-600 font-bold w-fit my-3 mx-3 absolute text-sm px-3 py-1 rounded-lg">
                        Active
                      </div>
                    ) : null}
                    <div className="flex flex-col space-y-1 justify-center items-center h-full">
                      <Ticket className="text-slate-400" size={40}></Ticket>
                      <div className="text-2xl text-slate-700 font-bold">
                        Closed
                      </div>
                      <div className="text-gray-400 text-center">
                        Users can join only by invitation
                      </div>
                    </div>
                  </div>
                }
                functionToExecute={() => {
                  changeJoinMethod('inviteOnly')
                }}
                status="info"
              ></ConfirmationModal>
            </div>
            <div
              className={
                joinMethod == 'open'
                  ? 'opacity-20 pointer-events-none'
                  : 'pointer-events-auto'
              }
            >
              <div className="flex flex-col bg-gray-50 -space-y-1  px-5 py-3 rounded-md mt-3 mb-3 ">
                <h1 className="font-bold text-xl text-gray-800">
                  Invite codes
                </h1>
                <h2 className="text-gray-500  text-md">
                  Invite codes can be copied and used to join your organization{' '}
                </h2>
              </div>
              <table className="table-auto w-full text-left whitespace-nowrap rounded-md overflow-hidden">
                <thead className="bg-gray-100 text-gray-500 rounded-xl uppercase">
                  <tr className="font-bolder text-sm">
                    <th className="py-3 px-4">Code</th>
                    <th className="py-3 px-4">Signup link</th>
                    <th className="py-3 px-4">Type</th>
                    <th className="py-3 px-4">Expiration date</th>
                    <th className="py-3 px-4">Actions</th>
                  </tr>
                </thead>
                <>
                  <tbody className="mt-5 bg-white rounded-md">
                    {invites?.map((invite: any) => (
                      <tr
                        key={invite.invite_code_uuid}
                        className="border-b border-gray-100 text-sm"
                      >
                        <td className="py-3 px-4">{invite.invite_code}</td>
                        <td className="py-3 px-4 ">
                          <Link
                            className="outline bg-gray-50 text-gray-600 px-2 py-1 rounded-md outline-gray-300 outline-dashed outline-1"
                            target="_blank"
                            href={getUriWithoutOrg(
                              `/signup?inviteCode=${invite.invite_code}&orgslug=${org.slug}`
                            )}
                          >
                            {getUriWithoutOrg(
                              `/signup?inviteCode=${invite.invite_code}&orgslug=${org.slug}`
                            )}
                          </Link>
                        </td>
                        <td className="py-3 px-4">
                          {invite.usergroup_id ? (
                            <div className="flex space-x-2 items-center">
                              <UserSquare className="w-4 h-4" />
                              <span>Linked to a UserGroup</span>
                            </div>
                          ) : (
                            <div className="flex space-x-2 items-center">
                              <Users className="w-4 h-4" />
                              <span>Normal</span>
                            </div>
                          )}
                        </td>
                        <td className="py-3 px-4">
                          {dayjs(invite.expiration_date)
                            .add(1, 'year')
                            .format('DD/MM/YYYY')}{' '}
                        </td>
                        <td className="py-3 px-4">
                          <ConfirmationModal
                            confirmationButtonText="Delete Code"
                            confirmationMessage="Are you sure you want remove this invite code ?"
                            dialogTitle={'Delete code ?'}
                            dialogTrigger={
                              <button className="mr-2 flex space-x-2 hover:cursor-pointer p-1 px-3 bg-rose-700 rounded-md font-bold items-center text-sm text-rose-100">
                                <X className="w-4 h-4" />
                                <span> Delete code</span>
                              </button>
                            }
                            functionToExecute={() => {
                              deleteInvite(invite)
                            }}
                            status="warning"
                          ></ConfirmationModal>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </>
              </table>
              <div className='flex flex-row-reverse mt-3 mr-2'>
                <Modal
                  isDialogOpen={
                    invitesModal
                  }
                  onOpenChange={() =>
                    setInvitesModal(!invitesModal)
                  }
                  minHeight="no-min"
                  minWidth='lg'
                  dialogContent={
                    <OrgInviteCodeGenerate
                      setInvitesModal={setInvitesModal}
                    />
                  }
                  dialogTitle="Generate Invite Code"
                  dialogDescription={
                    'Generate a new invite code for your organization'
                  }
                  dialogTrigger={
                    <button
                      className=" flex space-x-2 hover:cursor-pointer p-1 px-3 bg-green-700 rounded-md font-bold items-center text-sm text-green-100"
                    >
                      <Ticket className="w-4 h-4" />
                      <span> Generate invite code</span>
                    </button>
                  }
                />

              </div>

            </div>
          </div>
        </>
      ) : (
        <PageLoading />
      )}
    </>
  )
}

export default OrgAccess



================================================
FILE: apps/web/components/Dashboard/Pages/Users/OrgRoles/OrgRoles.tsx
================================================
'use client'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { useOrg } from '@components/Contexts/OrgContext'
import AddRole from '@components/Objects/Modals/Dash/OrgRoles/AddRole'
import EditRole from '@components/Objects/Modals/Dash/OrgRoles/EditRole'
import ConfirmationModal from '@components/Objects/StyledElements/ConfirmationModal/ConfirmationModal'
import Modal from '@components/Objects/StyledElements/Modal/Modal'
import { getAPIUrl } from '@services/config/config'
import { deleteRole } from '@services/roles/roles'
import { swrFetcher } from '@services/utils/ts/requests'
import { Pencil, Shield, X, Globe } from 'lucide-react'
import React from 'react'
import toast from 'react-hot-toast'
import useSWR, { mutate } from 'swr'

function OrgRoles() {
    const org = useOrg() as any
    const session = useLHSession() as any
    const access_token = session?.data?.tokens?.access_token;
    const [createRoleModal, setCreateRoleModal] = React.useState(false)
    const [editRoleModal, setEditRoleModal] = React.useState(false)
    const [selectedRole, setSelectedRole] = React.useState(null) as any

    const { data: roles } = useSWR(
        org ? `${getAPIUrl()}roles/org/${org.id}` : null,
        (url) => swrFetcher(url, access_token)
    )

    const deleteRoleUI = async (role_id: any) => {
        const toastId = toast.loading("Deleting...");
        const res = await deleteRole(role_id, org.id, access_token)
        if (res.status === 200) {
            mutate(`${getAPIUrl()}roles/org/${org.id}`)
            toast.success("Deleted role", {id:toastId})
        }
        else {
            toast.error('Error deleting role', {id:toastId})
        }
    }

    const handleEditRoleModal = (role: any) => {
        setSelectedRole(role)
        setEditRoleModal(!editRoleModal)
    }

    const getRightsSummary = (rights: any) => {
        if (!rights) return 'No permissions'
        
        const totalPermissions = Object.keys(rights).reduce((acc, key) => {
            if (typeof rights[key] === 'object') {
                return acc + Object.keys(rights[key]).filter(k => rights[key][k] === true).length
            }
            return acc
        }, 0)
        
        return `${totalPermissions} permissions`
    }

    // Check if a role is system-wide (TYPE_GLOBAL or role_uuid starts with role_global_)
    const isSystemRole = (role: any) => {
        // Check for role_type field first
        if (role.role_type === 'TYPE_GLOBAL') {
            return true
        }
        
        // Check for role_uuid starting with role_global_
        if (role.role_uuid && role.role_uuid.startsWith('role_global_')) {
            return true
        }
        
        // Check for common system role IDs (1-4 are typically system roles)
        if (role.id && [1, 2, 3, 4].includes(role.id)) {
            return true
        }
        
        // Check if the role name indicates it's a system role
        if (role.name && ['Admin', 'Maintainer', 'Instructor', 'User'].includes(role.name)) {
            return true
        }
        
        return false
    }

    return (
        <>
            <div className="h-6"></div>
            <div className="mx-4 sm:mx-6 lg:mx-10 bg-white rounded-xl nice-shadow px-3 sm:px-4 py-4">
                <div className="flex flex-col bg-gray-50 -space-y-1 px-3 sm:px-5 py-3 rounded-md mb-3">
                    <h1 className="font-bold text-lg sm:text-xl text-gray-800">Manage Roles & Permissions</h1>
                    <h2 className="text-gray-500 text-xs sm:text-sm">
                        {' '}
                        Roles define what users can do within your organization. Create custom roles with specific permissions for different user types.{' '}
                    </h2>
                </div>
                
                {/* Mobile view - Cards */}
                <div className="block sm:hidden space-y-3">
                    {roles?.map((role: any) => {
                        const isSystem = isSystemRole(role)
                        return (
                            <div key={role.id} className="bg-white border border-gray-200 rounded-lg p-4 space-y-3 shadow-sm">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center space-x-2">
                                        <Shield className="w-4 h-4 text-gray-400" />
                                        <span className="font-medium text-sm">{role.name}</span>
                                        {isSystem && (
                                            <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                                <Globe className="w-3 h-3 mr-1" />
                                                System-wide
                                            </span>
                                        )}
                                    </div>
                                    <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        {getRightsSummary(role.rights)}
                                    </span>
                                </div>
                                <p className="text-gray-600 text-sm">{role.description || 'No description'}</p>
                                <div className="flex space-x-2">
                                    {!isSystem ? (
                                        <>
                                            <Modal
                                                isDialogOpen={
                                                    editRoleModal &&
                                                    selectedRole?.id === role.id
                                                }
                                                onOpenChange={() =>
                                                    handleEditRoleModal(role)
                                                }
                                                minHeight="lg"
                                                minWidth='xl'
                                                customWidth="max-w-7xl"
                                                dialogContent={
                                                    <EditRole
                                                        role={role}
                                                        setEditRoleModal={setEditRoleModal}
                                                    />
                                                }
                                                dialogTitle="Edit Role"
                                                dialogDescription={
                                                    'Edit the role permissions and details'
                                                }
                                                dialogTrigger={
                                                    <button className="flex-1 flex justify-center space-x-2 hover:cursor-pointer p-2 bg-black rounded-md font-bold items-center text-sm text-white hover:bg-gray-800 transition-colors shadow-sm">
                                                        <Pencil className="w-4 h-4" />
                                                        <span>Edit</span>
                                                    </button>
                                                }
                                            />
                                            <ConfirmationModal
                                                confirmationButtonText="Delete Role"
                                                confirmationMessage="This action cannot be undone. All users with this role will lose their permissions. Are you sure you want to delete this role?"
                                                dialogTitle={'Delete Role ?'}
                                                dialogTrigger={
                                                    <button className="flex-1 flex justify-center space-x-2 hover:cursor-pointer p-2 bg-red-600 rounded-md font-bold items-center text-sm text-white hover:bg-red-700 transition-colors shadow-sm">
                                                        <X className="w-4 h-4" />
                                                        <span>Delete</span>
                                                    </button>
                                                }
                                                functionToExecute={() => {
                                                    deleteRoleUI(role.id)
                                                }}
                                                status="warning"
                                            />
                                        </>
                                    ) : null}
                                </div>
                            </div>
                        )
                    })}
                </div>

                {/* Desktop view - Table */}
                <div className="hidden sm:block overflow-x-auto">
                    <table className="table-auto w-full text-left whitespace-nowrap rounded-md overflow-hidden">
                        <thead className="bg-gray-100 text-gray-500 rounded-xl uppercase">
                            <tr className="font-bolder text-sm">
                                <th className="py-3 px-4">Role Name</th>
                                <th className="py-3 px-4">Description</th>
                                <th className="py-3 px-4">Permissions</th>
                                <th className="py-3 px-4">Actions</th>
                            </tr>
                        </thead>
                        <>
                            <tbody className="mt-5 bg-white rounded-md">
                                {roles?.map((role: any) => {
                                    const isSystem = isSystemRole(role)
                                    return (
                                        <tr key={role.id} className="border-b border-gray-100 text-sm hover:bg-gray-50 transition-colors">
                                            <td className="py-3 px-4">
                                                <div className="flex items-center space-x-2">
                                                    <Shield className="w-4 h-4 text-gray-400" />
                                                    <span className="font-medium">{role.name}</span>
                                                    {isSystem && (
                                                        <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                                            <Globe className="w-3 h-3 mr-1" />
                                                            System-wide
                                                        </span>
                                                    )}
                                                </div>
                                            </td>
                                            <td className="py-3 px-4 text-gray-600">{role.description || 'No description'}</td>
                                            <td className="py-3 px-4">
                                                <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                    {getRightsSummary(role.rights)}
                                                </span>
                                            </td>
                                            <td className="py-3 px-4">
                                                <div className="flex space-x-2">
                                                    {!isSystem ? (
                                                        <>
                                                            <Modal
                                                                isDialogOpen={
                                                                    editRoleModal &&
                                                                    selectedRole?.id === role.id
                                                                }
                                                                onOpenChange={() =>
                                                                    handleEditRoleModal(role)
                                                                }
                                                                minHeight="lg"
                                                                minWidth='xl'
                                                                customWidth="max-w-7xl"
                                                                dialogContent={
                                                                    <EditRole
                                                                        role={role}
                                                                        setEditRoleModal={setEditRoleModal}
                                                                    />
                                                                }
                                                                dialogTitle="Edit Role"
                                                                dialogDescription={
                                                                    'Edit the role permissions and details'
                                                                }
                                                                dialogTrigger={
                                                                    <button className="flex space-x-2 hover:cursor-pointer p-1 px-3 bg-black rounded-md font-bold items-center text-sm text-white hover:bg-gray-800 transition-colors shadow-sm">
                                                                        <Pencil className="w-4 h-4" />
                                                                        <span>Edit</span>
                                                                    </button>
                                                                }
                                                            />
                                                            <ConfirmationModal
                                                                confirmationButtonText="Delete Role"
                                                                confirmationMessage="This action cannot be undone. All users with this role will lose their permissions. Are you sure you want to delete this role?"
                                                                dialogTitle={'Delete Role ?'}
                                                                dialogTrigger={
                                                                    <button className="flex space-x-2 hover:cursor-pointer p-1 px-3 bg-red-600 rounded-md font-bold items-center text-sm text-white hover:bg-red-700 transition-colors shadow-sm">
                                                                        <X className="w-4 h-4" />
                                                                        <span>Delete</span>
                                                                    </button>
                                                                }
                                                                functionToExecute={() => {
                                                                    deleteRoleUI(role.id)
                                                                }}
                                                                status="warning"
                                                            />
                                                        </>
                                                    ) : null}
                                                </div>
                                            </td>
                                        </tr>
                                    )
                                })}
                            </tbody>
                        </>
                    </table>
                </div>
                
                <div className='flex justify-end mt-3 mr-2'>
                    <Modal
                        isDialogOpen={createRoleModal}
                        onOpenChange={() => setCreateRoleModal(!createRoleModal)}
                        minHeight="no-min"
                        minWidth='xl'
                        customWidth="max-w-7xl"
                        dialogContent={
                            <AddRole
                                setCreateRoleModal={setCreateRoleModal}
                            />
                        }
                        dialogTitle="Create a Role"
                        dialogDescription={
                            'Create a new role with specific permissions'
                        }
                        dialogTrigger={
                            <button className="flex space-x-2 hover:cursor-pointer p-2 sm:p-1 sm:px-3 bg-black rounded-md font-bold items-center text-sm text-white w-full sm:w-auto justify-center hover:bg-gray-800 transition-colors shadow-sm">
                                <Shield className="w-4 h-4" />
                                <span>Create a Role</span>
                            </button>
                        }
                    />
                </div>
            </div>
        </>
    )
}

export default OrgRoles 


================================================
FILE: apps/web/components/Dashboard/Pages/Users/OrgUserGroups/OrgUserGroups.tsx
================================================
'use client'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { useOrg } from '@components/Contexts/OrgContext'
import AddUserGroup from '@components/Objects/Modals/Dash/OrgUserGroups/AddUserGroup'
import EditUserGroup from '@components/Objects/Modals/Dash/OrgUserGroups/EditUserGroup'
import ManageUsers from '@components/Objects/Modals/Dash/OrgUserGroups/ManageUsers'
import ConfirmationModal from '@components/Objects/StyledElements/ConfirmationModal/ConfirmationModal'
import Modal from '@components/Objects/StyledElements/Modal/Modal'
import { getAPIUrl } from '@services/config/config'
import { deleteUserGroup } from '@services/usergroups/usergroups'
import { swrFetcher } from '@services/utils/ts/requests'
import { Pencil, SquareUserRound, Users, X } from 'lucide-react'
import React from 'react'
import toast from 'react-hot-toast'
import useSWR, { mutate } from 'swr'

function OrgUserGroups() {
    const org = useOrg() as any
    const session = useLHSession() as any
    const access_token = session?.data?.tokens?.access_token;
    const [userGroupManagementModal, setUserGroupManagementModal] = React.useState(false)
    const [createUserGroupModal, setCreateUserGroupModal] = React.useState(false)
    const [editUserGroupModal, setEditUserGroupModal] = React.useState(false)
    const [selectedUserGroup, setSelectedUserGroup] = React.useState(null) as any

    const { data: usergroups } = useSWR(
        org ? `${getAPIUrl()}usergroups/org/${org.id}` : null,
        (url) => swrFetcher(url, access_token)
    )

    const deleteUserGroupUI = async (usergroup_id: any) => {
        const toastId = toast.loading("Deleting...");
        const res = await deleteUserGroup(usergroup_id, access_token)
        if (res.status == 200) {
            mutate(`${getAPIUrl()}usergroups/org/${org.id}`)
            toast.success("Deleted usergroup", {id:toastId})
        }
        else {
            toast.error('Error deleting usergroup', {id:toastId})
        }

    }

    const handleUserGroupManagementModal = (usergroup_id: any) => {
        setSelectedUserGroup(usergroup_id)
        setUserGroupManagementModal(!userGroupManagementModal)
    }

    return (
        <>
            <div className="h-6"></div>
            <div className="ml-10 mr-10 mx-auto bg-white rounded-xl shadow-xs px-4 py-4">
                <div className="flex flex-col bg-gray-50 -space-y-1  px-5 py-3 rounded-md mb-3 ">
                    <h1 className="font-bold text-xl text-gray-800">Manage UserGroups & Users</h1>
                    <h2 className="text-gray-500 text-sm">
                        {' '}
                        UserGroups are a way to group users together to manage their access to the resources (Courses) in your organization.{' '}
                    </h2>
                </div>
                <div className="overflow-x-auto">
                    <table className="table-auto w-full text-left whitespace-nowrap rounded-md overflow-hidden">
                        <thead className="bg-gray-100 text-gray-500 rounded-xl uppercase">
                            <tr className="font-bolder text-sm">
                                <th className="py-3 px-4">UserGroup</th>
                                <th className="py-3 px-4">Description</th>
                                <th className="py-3 px-4">Manage Users</th>
                                <th className="py-3 px-4">Actions</th>
                            </tr>
                        </thead>
                        <>
                            <tbody className="mt-5 bg-white rounded-md">
                                {usergroups?.map((usergroup: any) => (
                                    <tr key={usergroup.id} className="border-b border-gray-100 text-sm">
                                        <td className="py-3 px-4">{usergroup.name}</td>
                                        <td className="py-3 px-4 ">{usergroup.description}</td>
                                        <td className="py-3 px-4 ">
                                            <Modal
                                                isDialogOpen={
                                                    userGroupManagementModal &&
                                                    selectedUserGroup === usergroup.id
                                                }
                                                onOpenChange={() =>
                                                    handleUserGroupManagementModal(usergroup.id)
                                                }
                                                minHeight="lg"
                                                minWidth='lg'
                                                dialogContent={
                                                    <ManageUsers
                                                        usergroup_id={usergroup.id}
                                                    />
                                                }
                                                dialogTitle="Manage UserGroup Users"
                                                dialogDescription={
                                                    'Manage the users in this UserGroup'
                                                }
                                                dialogTrigger={
                                                    <button className="flex space-x-2 hover:cursor-pointer p-1 px-3 bg-yellow-700 rounded-md font-bold items-center text-sm text-yellow-100">
                                                        <Users className="w-4 h-4" />
                                                        <span> Manage Users</span>
                                                    </button>
                                                }
                                            />
                                        </td>
                                        <td className="py-3 px-4 flex space-x-2">
                                            <Modal
                                            isDialogOpen={editUserGroupModal}
                                            dialogTrigger={
                                                <button className="flex space-x-2 hover:cursor-pointer p-1 px-3 bg-sky-700 rounded-md font-bold items-center text-sm text-sky-100">
                                                    <Pencil className="size-4" />
                                                    <span>Edit</span>
                                                </button>
                                            }
                                            minHeight='sm'
                                            minWidth='sm'
                                            onOpenChange={() => {
                                                setEditUserGroupModal(!editUserGroupModal)
                                            }}
                                            dialogContent={
                                                <EditUserGroup usergroup={usergroup} />
                                            }
                                            />
                                            <ConfirmationModal
                                                confirmationButtonText="Delete UserGroup"
                                                confirmationMessage="Access to all resources will be removed for all users in this UserGroup. Are you sure you want to delete this UserGroup ?"
                                                dialogTitle={'Delete UserGroup ?'}
                                                dialogTrigger={
                                                    <button className="flex space-x-2 hover:cursor-pointer p-1 px-3 bg-rose-700 rounded-md font-bold items-center text-sm text-rose-100">
                                                        <X className="w-4 h-4" />
                                                        <span>Delete</span>
                                                    </button>
                                                }
                                                functionToExecute={() => {
                                                    deleteUserGroupUI(usergroup.id)
                                                }}
                                                status="warning"
                                            ></ConfirmationModal>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </>
                    </table>
                </div>
                <div className='flex justify-end mt-3 mr-2'>
                    <Modal
                        isDialogOpen={
                            createUserGroupModal
                        }
                        onOpenChange={() =>
                            setCreateUserGroupModal(!createUserGroupModal)
                        }
                        minHeight="no-min"
                        dialogContent={
                            <AddUserGroup
                                setCreateUserGroupModal={setCreateUserGroupModal}
                            />
                        }
                        dialogTitle="Create a UserGroup"
                        dialogDescription={
                            'Create a new UserGroup to manage users'
                        }
                        dialogTrigger={
                            <button
                                className=" flex space-x-2 hover:cursor-pointer p-1 px-3 bg-green-700 rounded-md font-bold items-center text-sm text-green-100"
                            >
                                <SquareUserRound className="w-4 h-4" />
                                <span>Create a UserGroup</span>
                            </button>
                        }
                    />
                </div>

            </div>



        </>
    )
}

export default OrgUserGroups


================================================
FILE: apps/web/components/Dashboard/Pages/Users/OrgUsers/OrgUsers.tsx
================================================
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { useOrg } from '@components/Contexts/OrgContext'
import PageLoading from '@components/Objects/Loaders/PageLoading'
import RolesUpdate from '@components/Objects/Modals/Dash/OrgUsers/RolesUpdate'
import ConfirmationModal from '@components/Objects/StyledElements/ConfirmationModal/ConfirmationModal'
import Modal from '@components/Objects/StyledElements/Modal/Modal'
import Toast from '@components/Objects/StyledElements/Toast/Toast'
import { getAPIUrl } from '@services/config/config'
import { removeUserFromOrg } from '@services/organizations/orgs'
import { swrFetcher } from '@services/utils/ts/requests'
import { KeyRound, LogOut } from 'lucide-react'
import React, { useEffect } from 'react'
import toast from 'react-hot-toast'
import useSWR, { mutate } from 'swr'

function OrgUsers() {
  const org = useOrg() as any
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token;
  const { data: orgUsers } = useSWR(
    org ? `${getAPIUrl()}orgs/${org?.id}/users` : null,
    (url) => swrFetcher(url, access_token)
  )
  const [rolesModal, setRolesModal] = React.useState(false)
  const [selectedUser, setSelectedUser] = React.useState(null) as any
  const [isLoading, setIsLoading] = React.useState(true)

  const handleRolesModal = (user_uuid: any) => {
    setSelectedUser(user_uuid)
    setRolesModal(!rolesModal)
  }

  const handleRemoveUser = async (user_id: any) => {
    const toastId = toast.loading("Removing...");
    const res = await removeUserFromOrg(org.id, user_id,access_token)
    if (res.status === 200) {
      await mutate(`${getAPIUrl()}orgs/${org.id}/users`)
      toast.success("Removed user from org", {id:toastId});
    } else {
      toast.error('Error removing user', {id:toastId});
    }
  }

  useEffect(() => {
    if (orgUsers) {
      setIsLoading(false)
    }
  }, [org, orgUsers])

  return (
    <div>
      {isLoading ? (
        <div>
          <PageLoading />
        </div>
      ) : (
        <>
          <Toast></Toast>
          <div className="h-6"></div>
          <div className="ml-10 mr-10 mx-auto bg-white rounded-xl shadow-xs px-4 py-4  ">
            <div className="flex flex-col bg-gray-50 -space-y-1  px-5 py-3 rounded-md mb-3 ">
              <h1 className="font-bold text-xl text-gray-800">Active users</h1>
              <h2 className="text-gray-500  text-md">
                {' '}
                Manage your organization users, assign roles and permissions{' '}
              </h2>
            </div>
            <table className="table-auto w-full text-left whitespace-nowrap rounded-md overflow-hidden">
              <thead className="bg-gray-100 text-gray-500 rounded-xl uppercase">
                <tr className="font-bolder text-sm">
                  <th className="py-3 px-4">User</th>
                  <th className="py-3 px-4">Role</th>
                  <th className="py-3 px-4">Actions</th>
                </tr>
              </thead>
              <>
                <tbody className="mt-5 bg-white rounded-md">
                  {orgUsers?.map((user: any) => (
                    <tr
                      key={user.user.id}
                      className="border-b border-gray-200 border-dashed"
                    >
                      <td className="py-3 px-4 flex space-x-2 items-center">
                        <span>
                          {user.user.first_name + ' ' + user.user.last_name}
                        </span>
                        <span className="text-xs bg-neutral-100 p-1 px-2 rounded-full text-neutral-400 font-semibold">
                          @{user.user.username}
                        </span>
                      </td>
                      <td className="py-3 px-4">{user.role.name}</td>
                      <td className="py-3 px-4 flex space-x-2 items-end">
                        <Modal
                          isDialogOpen={
                            rolesModal && selectedUser === user.user.user_uuid
                          }
                          onOpenChange={() =>
                            handleRolesModal(user.user.user_uuid)
                          }
                          minHeight="no-min"
                          dialogContent={
                            <RolesUpdate
                              alreadyAssignedRole={user.role.role_uuid}
                              setRolesModal={setRolesModal}
                              user={user}
                            />
                          }
                          dialogTitle="Update Role"
                          dialogDescription={
                            'Update @' + user.user.username + "'s role"
                          }
                          dialogTrigger={
                            <button className="flex space-x-2 hover:cursor-pointer p-1 px-3 bg-yellow-700 rounded-md font-bold items-center text-sm text-yellow-100">
                              <KeyRound className="w-4 h-4" />
                              <span> Edit Role</span>
                            </button>
                          }
                        />

                        <ConfirmationModal
                          confirmationButtonText="Remove User"
                          confirmationMessage="Are you sure you want remove this user from the organization?"
                          dialogTitle={'Delete ' + user.user.username + ' ?'}
                          dialogTrigger={
                            <button className="mr-2 flex space-x-2 hover:cursor-pointer p-1 px-3 bg-rose-700 rounded-md font-bold items-center text-sm text-rose-100">
                              <LogOut className="w-4 h-4" />
                              <span> Remove from organization</span>
                            </button>
                          }
                          functionToExecute={() => {
                            handleRemoveUser(user.user.id)
                          }}
                          status="warning"
                        ></ConfirmationModal>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </>
            </table>
          </div>
        </>
      )}
    </div>
  )
}

export default OrgUsers



================================================
FILE: apps/web/components/Dashboard/Pages/Users/OrgUsersAdd/OrgUsersAdd.tsx
================================================
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { useOrg } from '@components/Contexts/OrgContext'
import PageLoading from '@components/Objects/Loaders/PageLoading'
import Toast from '@components/Objects/StyledElements/Toast/Toast'
import ToolTip from '@components/Objects/StyledElements/Tooltip/Tooltip'
import { getAPIUrl } from '@services/config/config'
import { inviteBatchUsers } from '@services/organizations/invites'
import { swrFetcher } from '@services/utils/ts/requests'
import { Info, UserPlus } from 'lucide-react'
import React, { useEffect } from 'react'
import toast from 'react-hot-toast'
import useSWR, { mutate } from 'swr'

function OrgUsersAdd() {
    const org = useOrg() as any
    const session = useLHSession() as any
    const access_token = session?.data?.tokens?.access_token;
    const [isLoading, setIsLoading] = React.useState(false)
    const [invitedUsers, setInvitedUsers] = React.useState('');
    const [selectedInviteCode, setSelectedInviteCode] = React.useState('');

    async function sendInvites() {
        const toastId = toast.loading("Sending invite...")
        setIsLoading(true)
        let res = await inviteBatchUsers(org.id, invitedUsers, selectedInviteCode,access_token)
        if (res.status == 200) {
            mutate(`${getAPIUrl()}orgs/${org?.id}/invites/users`)
            setIsLoading(false)
            toast.success("Invite sent", {id:toastId})
        } else {
            toast.error('Error sending invite', {id:toastId})
            setIsLoading(false)
        }

    }

    const { data: invites } = useSWR(
        org ? `${getAPIUrl()}orgs/${org?.id}/invites` : null,
        (url) => swrFetcher(url, access_token)
    )
    const { data: invited_users } = useSWR(
        org ? `${getAPIUrl()}orgs/${org?.id}/invites/users` : null,
        (url) => swrFetcher(url, access_token)
    )

    useEffect(() => {
        if (invites) {
            setSelectedInviteCode(invites?.[0]?.invite_code_uuid)
        }
    }
        , [invites, invited_users])

    return (
        <>
            <Toast></Toast>
            {!isLoading ? (
                <>
                    <div className="h-6"></div>
                    <div className="ml-10 mr-10 mx-auto bg-white rounded-xl shadow-xs px-4 py-4 anit ">
                        <div className="flex flex-col bg-gray-50 -space-y-1  px-5 py-3 rounded-md mb-3 ">
                            <h1 className="font-bold text-xl text-gray-800">Invite users to your Organization</h1>
                            <h2 className="text-gray-500  text-md">
                                {' '}
                                Send invite via email, separated by comma{' '}
                            </h2>
                        </div>
                        <div className="flex space-x-2 mx-auto">
                            <textarea
                                onChange={(e) => setInvitedUsers(e.target.value)}
                                className='w-full h-[200px] rounded-md border px-3 py-2 bg-gray-100/40 placeholder:italic placeholder:text-slate-300' placeholder='Example : spike.spiegel@bepop.space, michael.scott@dundermifflin.com' name="" id="" ></textarea>
                        </div>
                        <div className="flex space-x-2 mx-auto my-5 ml-2 items-center space-x-4 justify-between">

                            <div className='flex space-x-2 items-center'>
                                <p className='flex items-center'>Invite Code </p>
                                <select
                                    onChange={(e) => setSelectedInviteCode(e.target.value)}
                                    defaultValue={selectedInviteCode}
                                    className='text-gray-400 border rounded-md px-3 py-1' name="" id="">
                                    {invites?.map((invite: any) => (
                                        <option key={invite.invite_code_uuid} value={invite.invite_code_uuid}>{invite.invite_code}</option>
                                    ))}
                                </select>
                                <ToolTip content={'Use one of the invite codes that you generated from the signup access page'} sideOffset={8} side="right"><Info className='text-gray-400' size={14} /></ToolTip>
                            </div>
                            <div className='flex flex-row-reverse '>
                                <button
                                    onClick={sendInvites}
                                    className="flex space-x-2 hover:cursor-pointer p-1 px-3 bg-green-700 rounded-md font-bold items-center text-sm text-green-100"
                                >
                                    <UserPlus className="w-4 h-4" />
                                    <span>Send invites via email</span>
                                </button>
                            </div>
                        </div>


                        <div className="flex flex-col bg-gray-50 -space-y-1  px-5 py-3 rounded-md mt-3 mb-3 ">
                            <h1 className="font-bold text-xl text-gray-800">
                                Invited Users
                            </h1>
                            <h2 className="text-gray-500  text-md">
                                {' '}
                                Users who have been invited to join your organization{' '}
                            </h2>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="table-auto w-full text-left whitespace-nowrap rounded-md overflow-hidden">
                                <thead className="bg-gray-100 text-gray-500 rounded-xl uppercase">
                                    <tr className="font-bolder text-sm">
                                        <th className="py-3 px-4">Email</th>
                                        <th className="py-3 px-4">Signup Status</th>
                                        <th className="py-3 px-4">Email sent</th>
                                    </tr>
                                </thead>
                                <>
                                    <tbody className="mt-5 bg-white rounded-md">
                                        {invited_users?.map((invited_user: any) => (
                                            <tr
                                                key={invited_user.email}
                                                className="border-b border-gray-100 text-sm"
                                            >
                                                <td className="py-3 px-4">{invited_user.email}</td>
                                                <td className="py-3 px-4">{invited_user.pending ? <div className='bg-orange-400 text-orange-100 w-fit px-2 py1 rounded-md'>Pending</div> : <div className='bg-green-400 text-green-100 w-fit px-2 py1 rounded-md'>Signed</div>}</td>
                                                <td className="py-3 px-4">{invited_user.email_sent ? <div className='bg-green-600 text-green-100 w-fit px-2 py1 rounded-md'>Sent</div> : <div className='bg-red-400 text-red-100 w-fit px-2 py1 rounded-md'>No</div>}</td>


                                            </tr>
                                        ))}
                                    </tbody>
                                </>
                            </table>
                        </div>
                    </div>
                </>
            ) : (
                <PageLoading />
            )
            }
        </>
    )
}

export default OrgUsersAdd


================================================
FILE: apps/web/components/Footer/Footer.tsx
================================================
'use client'

import React from 'react'
import OrgScripts from '@/components/OrgScripts/OrgScripts'
import { usePathname } from 'next/navigation'

const Footer: React.FC = () => {
  const pathname = usePathname()
  const isDashboard = pathname?.startsWith('/dashboard')

  // Don't run scripts in dashboard pages
  if (isDashboard) {
    return null
  }

  return <OrgScripts />
}

export default Footer 


================================================
FILE: apps/web/components/Hooks/useAdminStatus.tsx
================================================
import { useOrg } from '@components/Contexts/OrgContext';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import { useEffect, useState, useMemo } from 'react';

interface Role {
    org: { id: number; org_uuid: string };
    role: { 
        id: number; 
        role_uuid: string;
        rights?: {
            [key: string]: {
                [key: string]: boolean;
            };
        };
    };
}

interface Rights {
    courses: {
        action_create: boolean;
        action_read: boolean;
        action_read_own: boolean;
        action_update: boolean;
        action_update_own: boolean;
        action_delete: boolean;
        action_delete_own: boolean;
    };
    users: {
        action_create: boolean;
        action_read: boolean;
        action_update: boolean;
        action_delete: boolean;
    };
    usergroups: {
        action_create: boolean;
        action_read: boolean;
        action_update: boolean;
        action_delete: boolean;
    };
    collections: {
        action_create: boolean;
        action_read: boolean;
        action_update: boolean;
        action_delete: boolean;
    };
    organizations: {
        action_create: boolean;
        action_read: boolean;
        action_update: boolean;
        action_delete: boolean;
    };
    coursechapters: {
        action_create: boolean;
        action_read: boolean;
        action_update: boolean;
        action_delete: boolean;
    };
    activities: {
        action_create: boolean;
        action_read: boolean;
        action_update: boolean;
        action_delete: boolean;
    };
    roles: {
        action_create: boolean;
        action_read: boolean;
        action_update: boolean;
        action_delete: boolean;
    };
    dashboard: {
        action_access: boolean;
    };
}

interface UseAdminStatusReturn {
    isAdmin: boolean | null;
    loading: boolean;
    userRoles: Role[];
    rights: Rights | null;
}

function useAdminStatus(): UseAdminStatusReturn {
    const session = useLHSession() as any;
    const org = useOrg() as any;
    const [isAdmin, setIsAdmin] = useState<boolean | null>(null);
    const [loading, setLoading] = useState<boolean>(true);
    const [rights, setRights] = useState<Rights | null>(null);

    const userRoles = useMemo(() => session?.data?.roles || [], [session?.data?.roles]);

    useEffect(() => {
        if (session.status === 'authenticated' && org?.id) {
            // Extract rights from the backend session data
            const extractRightsFromRoles = (): Rights | null => {
                if (!userRoles || userRoles.length === 0) return null;
                
                // Find roles for the current organization
                const orgRoles = userRoles.filter((role: Role) => role.org.id === org.id);
                if (orgRoles.length === 0) return null;
                
                // Merge rights from all roles for this organization
                const mergedRights: Rights = {
                    courses: {
                        action_create: false,
                        action_read: false,
                        action_read_own: false,
                        action_update: false,
                        action_update_own: false,
                        action_delete: false,
                        action_delete_own: false
                    },
                    users: {
                        action_create: false,
                        action_read: false,
                        action_update: false,
                        action_delete: false
                    },
                    usergroups: {
                        action_create: false,
                        action_read: false,
                        action_update: false,
                        action_delete: false
                    },
                    collections: {
                        action_create: false,
                        action_read: false,
                        action_update: false,
                        action_delete: false
                    },
                    organizations: {
                        action_create: false,
                        action_read: false,
                        action_update: false,
                        action_delete: false
                    },
                    coursechapters: {
                        action_create: false,
                        action_read: false,
                        action_update: false,
                        action_delete: false
                    },
                    activities: {
                        action_create: false,
                        action_read: false,
                        action_update: false,
                        action_delete: false
                    },
                    roles: {
                        action_create: false,
                        action_read: false,
                        action_update: false,
                        action_delete: false
                    },
                    dashboard: {
                        action_access: false
                    }
                };
                
                // Merge rights from all roles
                orgRoles.forEach((role: Role) => {
                    if (role.role.rights) {
                        Object.keys(role.role.rights).forEach((resourceType) => {
                            if (mergedRights[resourceType as keyof Rights]) {
                                Object.keys(role.role.rights![resourceType]).forEach((action) => {
                                    if (role.role.rights![resourceType][action] === true) {
                                        (mergedRights[resourceType as keyof Rights] as any)[action] = true;
                                    }
                                });
                            }
                        });
                    }
                });
                
                return mergedRights;
            };
            
            const extractedRights = extractRightsFromRoles();
            setRights(extractedRights);
            
            // User is admin only if they have dashboard access
            const isAdminVar = extractedRights?.dashboard?.action_access === true;
            setIsAdmin(isAdminVar);
            
            setLoading(false);
        } else {
            setIsAdmin(false);
            setRights(null);
            setLoading(false);
        }
    }, [session.status, userRoles, org.id]);

    return { isAdmin, loading, userRoles, rights };
}

export default useAdminStatus;




================================================
FILE: apps/web/components/Hooks/useCourseRights.tsx
================================================
'use client'
import { getAPIUrl } from '@services/config/config'
import { swrFetcher } from '@services/utils/ts/requests'
import useSWR from 'swr'
import { useLHSession } from '@components/Contexts/LHSessionContext'

export interface CourseRights {
  course_uuid: string
  user_id: number
  is_anonymous: boolean
  permissions: {
    read: boolean
    create: boolean
    update: boolean
    delete: boolean
    create_content: boolean
    update_content: boolean
    delete_content: boolean
    manage_contributors: boolean
    manage_access: boolean
    grade_assignments: boolean
    mark_activities_done: boolean
    create_certifications: boolean
  }
  ownership: {
    is_owner: boolean
    is_creator: boolean
    is_maintainer: boolean
    is_contributor: boolean
    authorship_status: string
  }
  roles: {
    is_admin: boolean
    is_maintainer_role: boolean
    is_instructor: boolean
    is_user: boolean
  }
}

export function useCourseRights(courseuuid: string) {
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token

  const { data: rights, error, isLoading } = useSWR<CourseRights>(
    courseuuid ? `${getAPIUrl()}courses/${courseuuid}/rights` : null,
    (url: string) => swrFetcher(url, access_token)
  )

  return {
    rights,
    error,
    isLoading,
    hasPermission: (permission: keyof CourseRights['permissions']) => {
      return rights?.permissions?.[permission] ?? false
    },
    hasRole: (role: keyof CourseRights['roles']) => {
      return rights?.roles?.[role] ?? false
    },
    isOwner: rights?.ownership?.is_owner ?? false,
    isCreator: rights?.ownership?.is_creator ?? false,
    isMaintainer: rights?.ownership?.is_maintainer ?? false,
    isContributor: rights?.ownership?.is_contributor ?? false
  }
} 


================================================
FILE: apps/web/components/Hooks/useFeatureFlag.tsx
================================================
import { useOrg } from '@components/Contexts/OrgContext'
import { useEffect, useState } from 'react'

type FeatureType = {
  path: string[]
  defaultValue?: boolean
}

function useFeatureFlag(feature: FeatureType) {
  const org = useOrg() as any
  const [isEnabled, setIsEnabled] = useState<boolean>(!!feature.defaultValue)

  useEffect(() => {
    if (org?.config?.config) {
      let currentValue = org.config.config
      
      // Traverse the path to get the feature flag value
      for (const key of feature.path) {
        if (currentValue && typeof currentValue === 'object') {
          currentValue = currentValue[key]
        } else {
          currentValue = feature.defaultValue || false
          break
        }
      }

      setIsEnabled(!!currentValue)
    } else {
      setIsEnabled(!!feature.defaultValue)
    }
  }, [org, feature])

  return isEnabled
}

export default useFeatureFlag


================================================
FILE: apps/web/components/Hooks/useGetAIFeatures.tsx
================================================
import { useOrg } from '@components/Contexts/OrgContext'
import React from 'react'

interface UseGetAIFeatures {
  feature: 'editor' | 'activity_ask' | 'course_ask' | 'global_ai_ask'
}

function useGetAIFeatures(props: UseGetAIFeatures) {
  const org = useOrg() as any
  const [isEnabled, setisEnabled] = React.useState(false)

  function checkAvailableAIFeaturesOnOrg(feature: string) {
    const config = org?.config?.config?.features.ai.enabled

    return config
  }

  React.useEffect(() => {
    if (org) {
      // Check if org is not null or undefined
      let isEnabledStatus = checkAvailableAIFeaturesOnOrg(props.feature)
      setisEnabled(isEnabledStatus)
    }
  }, [org])

  return isEnabled
}

export default useGetAIFeatures



================================================
FILE: apps/web/components/Hooks/usePaymentsEnabled.tsx
================================================
// hooks/usePaymentsEnabled.ts
import { useOrg } from '@components/Contexts/OrgContext';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import useSWR from 'swr';
import { getPaymentConfigs } from '@services/payments/payments';

export function usePaymentsEnabled() {
  const org = useOrg() as any;
  const session = useLHSession() as any;
  const access_token = session?.data?.tokens?.access_token;

  const { data: paymentConfigs, error, isLoading } = useSWR(
    org && access_token ? [`/payments/${org.id}/config`, access_token] : null,
    ([url, token]) => getPaymentConfigs(org.id, token)
  );

  const isStripeEnabled = paymentConfigs?.some(
    (config: any) => config.provider === 'stripe' && config.active
  );

  return {
    isEnabled: !!isStripeEnabled,
    isLoading,
    error
  };
}


================================================
FILE: apps/web/components/Landings/LandingClassic.tsx
================================================
import React from 'react'
import GeneralWrapperStyled from '@components/Objects/StyledElements/Wrappers/GeneralWrapper'
import TypeOfContentTitle from '@components/Objects/StyledElements/Titles/TypeOfContentTitle'
import CourseThumbnail from '@components/Objects/Thumbnails/CourseThumbnail'
import CollectionThumbnail from '@components/Objects/Thumbnails/CollectionThumbnail'
import AuthenticatedClientElement from '@components/Security/AuthenticatedClientElement'
import NewCourseButton from '@components/Objects/StyledElements/Buttons/NewCourseButton'
import NewCollectionButton from '@components/Objects/StyledElements/Buttons/NewCollectionButton'
import ContentPlaceHolderIfUserIsNotAdmin from '@components/Objects/ContentPlaceHolder'
import Link from 'next/link'
import { getUriWithOrg } from '@services/config/config'

interface LandingClassicProps {
  courses: any[]
  collections: any[]
  orgslug: string
  org_id: string
}

function LandingClassic({ courses, collections, orgslug, org_id }: LandingClassicProps) {
  return (
    <div className="w-full">
      <GeneralWrapperStyled>
        {/* Collections */}
        <div className="flex flex-col space-y-4 mb-8">
          <div className="flex items-center justify-between">
            <TypeOfContentTitle title="Collections" type="col" />
            <AuthenticatedClientElement
              checkMethod="roles"
              ressourceType="collections"
              action="create"
              orgId={org_id}
            >
              <Link href={getUriWithOrg(orgslug, '/collections/new')}>
                <NewCollectionButton />
              </Link>
            </AuthenticatedClientElement>
          </div>
          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            {collections.map((collection: any) => (
              <div key={collection.collection_id} className="flex flex-col p-3">
                <CollectionThumbnail
                  collection={collection}
                  orgslug={orgslug}
                  org_id={org_id}
                />
              </div>
            ))}
            {collections.length === 0 && (
              <div className="col-span-full flex justify-center items-center py-8">
                <div className="text-center">
                  <div className="mb-4">
                    <svg
                      width="50"
                      height="50"
                      viewBox="0 0 295 295"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                      className="mx-auto"
                    >
                      <rect
                        opacity="0.51"
                        x="10"
                        y="10"
                        width="275"
                        height="275"
                        rx="75"
                        stroke="#4B5564"
                        strokeOpacity="0.15"
                        strokeWidth="20"
                      />
                      <path
                        d="M135.8 200.8V130L122.2 114.6L135.8 110.4V102.8L122.2 87.4L159.8 76V200.8L174.6 218H121L135.8 200.8Z"
                        fill="#4B5564"
                        fillOpacity="0.08"
                      />
                    </svg>
                  </div>
                  <h1 className="text-xl font-bold text-gray-600 mb-2">
                    No collections yet
                  </h1>
                  <p className="text-md text-gray-400">
                    <ContentPlaceHolderIfUserIsNotAdmin
                      text="Create collections to group courses together"
                    />
                  </p>
                </div>
              </div>
            )}
          </div>
        </div>

        {/* Courses */}
        <div className="flex flex-col space-y-4">
          <div className="flex items-center justify-between">
            <TypeOfContentTitle title="Courses" type="cou" />
            <AuthenticatedClientElement
              ressourceType="courses"
              action="create"
              checkMethod="roles"
              orgId={org_id}
            >
              <Link href={getUriWithOrg(orgslug, '/courses?new=true')}>
                <NewCourseButton />
              </Link>
            </AuthenticatedClientElement>
          </div>
          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            {courses.map((course: any) => (
              <div key={course.course_uuid} className="p-3">
                <CourseThumbnail course={course} orgslug={orgslug} />
              </div>
            ))}
            {courses.length === 0 && (
              <div className="col-span-full flex justify-center items-center py-8">
                <div className="text-center">
                  <div className="mb-4 ">
                    <svg
                      width="50"
                      height="50"
                      className="mx-auto"
                      viewBox="0 0 295 295"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <rect
                        opacity="0.51"
                        x="10"
                        y="10"
                        width="275"
                        height="275"
                        rx="75"
                        stroke="#4B5564"
                        strokeOpacity="0.15"
                        strokeWidth="20"
                      />
                      <path
                        d="M135.8 200.8V130L122.2 114.6L135.8 110.4V102.8L122.2 87.4L159.8 76V200.8L174.6 218H121L135.8 200.8Z"
                        fill="#4B5564"
                        fillOpacity="0.08"
                      />
                    </svg>
                  </div>
                  <h1 className="text-xl font-bold text-gray-600 mb-2">
                    No courses yet
                  </h1>
                  <p className="text-md text-gray-400">
                    <ContentPlaceHolderIfUserIsNotAdmin text='Create courses to add content' />
                  </p>
                </div>
              </div>
            )}
          </div>
        </div>
      </GeneralWrapperStyled>
    </div>
  )
}

export default LandingClassic


================================================
FILE: apps/web/components/Landings/LandingCustom.tsx
================================================
'use client'

import React from 'react'
import { LandingSection } from '@components/Dashboard/Pages/Org/OrgEditLanding/landing_types'
import useSWR from 'swr'
import { getOrgCourses } from '@services/courses/courses'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import CourseThumbnailLanding from '@components/Objects/Thumbnails/CourseThumbnailLanding'
import UserAvatar from '@components/Objects/UserAvatar'

interface LandingCustomProps {
  landing: {
    sections: LandingSection[]
    enabled: boolean
  }
  orgslug: string
}

function LandingCustom({ landing, orgslug }: LandingCustomProps) {
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token

  // Fetch all courses for the organization
  const { data: allCourses } = useSWR(
    orgslug ? [orgslug, access_token] : null,
    ([slug, token]) => getOrgCourses(slug, null, token)
  )

  const renderSection = (section: LandingSection) => {
    switch (section.type) {
      case 'hero':
        return (
          <div 
            key={`hero-${section.title}`}
            className="min-h-[400px] sm:min-h-[500px] mt-[20px] sm:mt-[40px] mx-2 sm:mx-4 lg:mx-16 w-full flex items-center justify-center rounded-xl border border-gray-100"
            style={{
              background: section.background.type === 'solid' 
                ? section.background.color 
                : section.background.type === 'gradient'
                ? `linear-gradient(${section.background.direction || '45deg'}, ${section.background.colors?.join(', ')})`
                : `url(${section.background.image}) center/cover`
            }}
          >
            <div className={`w-full h-full flex flex-col sm:flex-row ${
              section.illustration?.position === 'right' ? 'sm:flex-row-reverse' : 'sm:flex-row'
            } items-stretch`}>
              {/* Logo */}
              {section.illustration?.image.url && (
                <div className={`flex items-${section.illustration.verticalAlign} p-6 w-full ${
                  section.illustration.size === 'small' ? 'sm:w-1/4' :
                  section.illustration.size === 'medium' ? 'sm:w-1/3' :
                  'sm:w-2/5'
                }`}>
                  <img
                    src={section.illustration.image.url}
                    alt={section.illustration.image.alt}
                    className="w-full object-contain"
                  />
                </div>
              )}

              {/* Content */}
              <div className={`flex-1 flex items-center ${
                section.contentAlign === 'left' ? 'justify-start text-left' :
                section.contentAlign === 'right' ? 'justify-end text-right' :
                'justify-center text-center'
              } p-6`}>
                <div className="max-w-2xl">
                  <h1 
                    className="text-xl sm:text-2xl md:text-3xl font-bold mb-2 sm:mb-4"
                    style={{ color: section.heading.color }}
                  >
                    {section.heading.text}
                  </h1>
                  <h2
                    className="text-sm sm:text-base md:text-lg mb-4 sm:mb-6 md:mb-8 font-medium"
                    style={{ color: section.subheading.color }}
                  >
                    {section.subheading.text}
                  </h2>
                  <div className={`flex flex-col sm:flex-row gap-3 sm:gap-4 ${
                    section.contentAlign === 'left' ? 'justify-start' :
                    section.contentAlign === 'right' ? 'justify-end' :
                    'justify-center'
                  } items-center`}>
                    {section.buttons.map((button, index) => (
                      <a
                        key={index}
                        href={button.link}
                        className="w-full sm:w-auto px-6 py-2.5 rounded-lg text-sm font-extrabold shadow-sm transition-transform hover:scale-105"
                        style={{
                          backgroundColor: button.background,
                          color: button.color
                        }}
                      >
                        {button.text}
                      </a>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>
        )
      case 'text-and-image':
        return (
          <div 
            key={`text-image-${section.title}`}
            className="py-16 mx-2 sm:mx-4 lg:mx-16 w-full"
          >
            <div className={`flex flex-col md:flex-row items-center gap-8 md:gap-12 bg-white rounded-xl p-6 md:p-8 lg:p-12 nice-shadow ${
              section.flow === 'right' ? 'md:flex-row-reverse' : ''
            }`}>
              <div className="flex-1 w-full max-w-2xl">
                <h2 className="text-2xl md:text-3xl font-bold mb-4 text-gray-900 tracking-tight">{section.title}</h2>
                <div className="prose prose-lg prose-gray max-w-none">
                  <p className="text-base md:text-lg leading-relaxed text-gray-600 whitespace-pre-line">
                    {section.text}
                  </p>
                </div>
                <div className="flex flex-wrap gap-4 mt-8">
                  {section.buttons.map((button, index) => (
                    <a
                      key={index}
                      href={button.link}
                      className="px-6 py-3 rounded-xl font-medium shadow-xs transition-all duration-200 hover:scale-105"
                      style={{
                        backgroundColor: button.background,
                        color: button.color
                      }}
                    >
                      {button.text}
                    </a>
                  ))}
                </div>
              </div>
              <div className="flex-1 w-full md:w-auto">
                <div className="relative w-full max-w-[500px] mx-auto px-4 md:px-8">
                  <div className="relative w-full aspect-4/3">
                    <img
                      src={section.image.url}
                      alt={section.image.alt}
                      className="object-contain w-full h-full rounded-lg"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
        )
      case 'logos':
        return (
          <div 
            key={`logos-${section.type}`}
            className="py-16 mx-2 sm:mx-4 lg:mx-16 w-full"
          >
            {section.title && (
              <h2 className="text-2xl md:text-3xl font-bold text-left mb-16 text-gray-900">{section.title}</h2>
            )}
            <div className="flex justify-center w-full">
              <div className="flex flex-wrap justify-center gap-16 max-w-7xl">
                {section.logos.map((logo, index) => (
                  <div key={index} className="flex items-center justify-center w-[220px] h-[120px]">
                    <img
                      src={logo.url}
                      alt={logo.alt}
                      className="max-h-24 max-w-[200px] object-contain hover:opacity-80 transition-opacity"
                    />
                  </div>
                ))}
              </div>
            </div>
          </div>
        )
      case 'people':
        return (
          <div 
            key={`people-${section.title}`}
            className="py-16 mx-2 sm:mx-4 lg:mx-16 w-full"
          >
            <h2 className="text-2xl md:text-3xl font-bold text-left mb-10 text-gray-900">{section.title}</h2>
            <div className="flex flex-wrap justify-center gap-x-20 gap-y-8">
              {section.people.map((person, index) => (
                <div key={index} className="w-[140px] flex flex-col items-center">
                  <div className="w-24 h-24 mb-4">
                    {person.username ? (
                      <UserAvatar
                        username={person.username}
                        width={96}
                        rounded="rounded-full"
                        border="border-4"
                        showProfilePopup
                      />
                    ) : (
                      <img
                        src={person.image_url}
                        alt={person.name}
                        className="w-full h-full rounded-full object-cover border-4 border-white nice-shadow"
                      />
                    )}
                  </div>
                  <h3 className="text-lg font-semibold text-center text-gray-900">{person.name}</h3>
                  <p className="text-sm text-center text-gray-600 mt-1">{person.description}</p>
                </div>
              ))}
            </div>
          </div>
        )
      case 'featured-courses':
        if (!allCourses) {
          return (
            <div 
              key={`featured-courses-${section.title}`}
              className="py-16 mx-2 sm:mx-4 lg:mx-16 w-full"
            >
              <h2 className="text-2xl md:text-3xl font-bold text-left mb-6 text-gray-900">{section.title}</h2>
              <div className="text-center py-6 text-gray-500">Loading courses...</div>
            </div>
          )
        }

        const featuredCourses = allCourses.filter((course: any) => 
          section.courses.includes(course.course_uuid)
        )

        return (
          <div 
            key={`featured-courses-${section.title}`}
            className="py-16 mx-2 sm:mx-4 lg:mx-16 w-full"
          >
            <h2 className="text-2xl md:text-3xl font-bold text-left mb-6 text-gray-900">{section.title}</h2>
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 w-full">
              {featuredCourses.map((course: any) => (
                <div key={course.course_uuid} className="w-full flex justify-center">
                  <CourseThumbnailLanding
                    course={course}
                    orgslug={orgslug}
                  />
                </div>
              ))}
              {featuredCourses.length === 0 && (
                <div className="col-span-full text-center py-6 text-gray-500">
                  No featured courses selected
                </div>
              )}
            </div>
          </div>
        )
      default:
        return null
    }
  }

  return (
    <div className="flex flex-col items-center justify-between w-full max-w-(--breakpoint-2xl) mx-auto px-4 sm:px-6 lg:px-16 h-full">
      {landing.sections.map((section) => renderSection(section))}
    </div>
  )
}

export default LandingCustom


================================================
FILE: apps/web/components/Objects/ContentPlaceHolder.tsx
================================================
'use client';
import React from 'react'
import useAdminStatus from '../Hooks/useAdminStatus'


// Terrible name and terible implementation, need to be refactored asap 
function ContentPlaceHolderIfUserIsNotAdmin({ text }: { text: string }) {
    const isUserAdmin = useAdminStatus() as any
    return (
        <span>{isUserAdmin ? text : 'No content yet'}</span>
    )
}

export default ContentPlaceHolderIfUserIsNotAdmin


================================================
FILE: apps/web/components/Objects/MiniInfoTooltip.tsx
================================================
import React from 'react';
import { motion } from 'framer-motion';

interface MiniInfoTooltipProps {
  icon?: React.ReactNode;
  message: string;
  onClose: () => void;
  iconColor?: string;
  iconSize?: number;
  width?: string;
}

export default function MiniInfoTooltip({
  icon,
  message,
  onClose,
  iconColor = 'text-teal-600',
  iconSize = 20,
  width = 'w-48'
}: MiniInfoTooltipProps) {
  return (
    <motion.div
      initial={{ opacity: 0, y: 10 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, y: 10 }}
      className={`absolute -top-20 left-1/2 transform -translate-x-1/2 bg-white rounded-lg nice-shadow p-3 ${width}`}
    >
      <div className="flex items-center space-x-3">
        {icon && (
          <div className={`${iconColor} flex-shrink-0`} style={{ width: iconSize, height: iconSize }}>
            {icon}
          </div>
        )}
        <p className="text-sm text-gray-700">{message}</p>
      </div>
      <div className="absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-4 h-4 bg-white rotate-45"></div>
      <button
        onClick={onClose}
        className="absolute top-1 right-1 text-gray-400 hover:text-gray-600"
      >
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M18 6L6 18M6 6l12 12" />
        </svg>
      </button>
    </motion.div>
  );
} 


================================================
FILE: apps/web/components/Objects/UserAvatar.tsx
================================================
import React, { useEffect, useState } from 'react'
import { getUriWithOrg } from '@services/config/config'
import { useParams } from 'next/navigation'
import { getUserAvatarMediaDirectory } from '@services/media/media'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import UserProfilePopup from './UserProfilePopup'
import { getUserByUsername } from '@services/users/users'

type UserAvatarProps = {
  width?: number
  avatar_url?: string
  use_with_session?: boolean
  rounded?: 'rounded-md' | 'rounded-xl' | 'rounded-lg' | 'rounded-full' | 'rounded'
  border?: 'border-2' | 'border-4' | 'border-8'
  borderColor?: string
  predefined_avatar?: 'ai' | 'empty'
  backgroundColor?: 'bg-white' | 'bg-gray-100' 
  showProfilePopup?: boolean
  userId?: string
  username?: string
}

function UserAvatar(props: UserAvatarProps) {
  const session = useLHSession() as any
  const params = useParams() as any
  const [userData, setUserData] = useState<any>(null)

  useEffect(() => {
    const fetchUserByUsername = async () => {
      if (props.username) {
        try {
          const data = await getUserByUsername(props.username)
          setUserData(data)
        } catch (error) {
          console.error('Error fetching user by username:', error)
        }
      }
    }

    fetchUserByUsername()
  }, [props.username])

  const isExternalUrl = (url: string): boolean => {
    return url.startsWith('http://') || url.startsWith('https://')
  }

  const extractExternalUrl = (url: string): string | null => {
    // Check if the URL contains an embedded external URL
    const matches = url.match(/avatars\/(https?:\/\/[^/]+.*$)/)
    if (matches && matches[1]) {
      return matches[1]
    }
    return null
  }

  const getAvatarUrl = (): string => {
    // If predefined avatar is specified
    if (props.predefined_avatar) {
      const avatarType = props.predefined_avatar === 'ai' ? 'ai_avatar.png' : 'empty_avatar.png'
      return getUriWithOrg(params.orgslug, `/${avatarType}`)
    }

    // If avatar_url prop is provided
    if (props.avatar_url) {
      // Check if it's a malformed URL (external URL processed through getUserAvatarMediaDirectory)
      const extractedUrl = extractExternalUrl(props.avatar_url)
      if (extractedUrl) {
        return extractedUrl
      }
      // If it's a direct external URL
      if (isExternalUrl(props.avatar_url)) {
        return props.avatar_url
      }
      // Otherwise use as is
      return props.avatar_url
    }

    // If we have user data from username fetch
    if (userData?.avatar_image) {
      const avatarUrl = userData.avatar_image
      // If it's an external URL (e.g., from Google, Facebook, etc.), use it directly
      if (isExternalUrl(avatarUrl)) {
        return avatarUrl
      }
      // Otherwise, get the local avatar URL
      return getUserAvatarMediaDirectory(userData.user_uuid, avatarUrl)
    }

    // If user has an avatar in session (only if session exists)
    if (session?.data?.user?.avatar_image) {
      const avatarUrl = session.data.user.avatar_image
      // If it's an external URL (e.g., from Google, Facebook, etc.), use it directly
      if (isExternalUrl(avatarUrl)) {
        return avatarUrl
      }
      // Otherwise, get the local avatar URL
      return getUserAvatarMediaDirectory(session.data.user.user_uuid, avatarUrl)
    }

    // Fallback to empty avatar
    return getUriWithOrg(params.orgslug, '/empty_avatar.png')
  }

  const avatarImage = (
    <img
      alt="User Avatar"
      width={props.width ?? 50}
      height={props.width ?? 50}
      src={getAvatarUrl()}
      className={`
        ${props.avatar_url && session?.data?.user?.avatar_image ? '' : 'bg-gray-700'}
        ${props.border ? `border ${props.border}` : ''}
        ${props.borderColor ?? 'border-white'}
        ${props.backgroundColor ?? 'bg-gray-100'}
        shadow-md shadow-gray-300/45
        aspect-square
        w-[${props.width ?? 50}px]
        h-[${props.width ?? 50}px]
        ${props.rounded ?? 'rounded-xl'}
      `}
    />
  )

  if (props.showProfilePopup && (props.userId || (userData?.id))) {
    return (
      <UserProfilePopup userId={props.userId || userData?.id}>
        {avatarImage}
      </UserProfilePopup>
    )
  }

  return avatarImage
}

export default UserAvatar



================================================
FILE: apps/web/components/Objects/UserProfilePopup.tsx
================================================
import React, { useEffect, useState } from 'react'
import { HoverCard, HoverCardContent, HoverCardTrigger } from "@/components/ui/hover-card"
import { MapPin, Building2, Globe, Briefcase, GraduationCap, Link, Users, Calendar, Lightbulb, Loader2, ExternalLink } from 'lucide-react'
import { getUser } from '@services/users/users'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { useRouter } from 'next/navigation'

type UserProfilePopupProps = {
  children: React.ReactNode
  userId: string
}

type UserData = {
  first_name: string
  last_name: string
  username: string
  bio?: string
  avatar_image?: string
  details?: {
    [key: string]: {
      id: string
      label: string
      icon: string
      text: string
    }
  }
}

const ICON_MAP = {
  'briefcase': Briefcase,
  'graduation-cap': GraduationCap,
  'map-pin': MapPin,
  'building-2': Building2,
  'speciality': Lightbulb,
  'globe': Globe,
  'link': Link,
  'users': Users,
  'calendar': Calendar,
} as const

const UserProfilePopup = ({ children, userId }: UserProfilePopupProps) => {
  const session = useLHSession() as any
  const router = useRouter()
  const [userData, setUserData] = useState<UserData | null>(null)
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    const fetchUserData = async () => {
      if (!userId) return
      
      setIsLoading(true)
      setError(null)
      
      try {
        const data = await getUser(userId, session?.data?.tokens?.access_token)
        setUserData(data)
      } catch (err) {
        setError('Failed to load user data')
        console.error('Error fetching user data:', err)
      } finally {
        setIsLoading(false)
      }
    }

    fetchUserData()
  }, [userId, session?.data?.tokens?.access_token])

  const IconComponent = ({ iconName }: { iconName: string }) => {
    const IconElement = ICON_MAP[iconName as keyof typeof ICON_MAP]
    if (!IconElement) return null
    return <IconElement className="w-4 h-4 text-gray-500" />
  }

  return (
    <HoverCard openDelay={100} closeDelay={150}>
      <HoverCardTrigger asChild>
        {children}
      </HoverCardTrigger>
      <HoverCardContent className="w-96 bg-white/95 backdrop-blur-md p-0 nice-shadow">
        {isLoading ? (
          <div className="flex items-center justify-center py-8">
            <Loader2 className="w-6 h-6 animate-spin text-gray-400" />
          </div>
        ) : error ? (
          <div className="text-sm text-red-500 p-4">{error}</div>
        ) : userData ? (
          <div>
            {/* Header with Avatar and Name */}
            <div className="relative">
              {/* Background gradient */}
              <div className="absolute inset-0 bg-gradient-to-b from-gray-100/30 to-transparent h-28 rounded-t-lg" />
              
              {/* Content */}
              <div className="relative px-5 pt-5 pb-4">
                <div className="flex items-start gap-4">
                  {/* Avatar */}
                  <div className="flex-shrink-0">
                    <div className="rounded-full">
                      {children}
                    </div>
                  </div>

                  {/* Name, Bio, and Button */}
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center justify-between gap-2">
                      <div className="flex items-center gap-2 min-w-0">
                        <h4 className="font-semibold text-gray-900 truncate">
                          {userData.first_name} {userData.last_name}
                        </h4>
                        {userData.username && (
                          <Badge variant="outline" className="text-xs font-normal text-gray-500 px-2 truncate">
                            @{userData.username}
                          </Badge>
                        )}
                      </div>
                      <Button
                        variant="ghost"
                        size="icon"
                        className="h-6 w-6 text-gray-600 hover:text-gray-900 flex-shrink-0"
                        onClick={() => userData.username && router.push(`/user/${userData.username}`)}
                      >
                        <ExternalLink className="w-4 h-4" />
                      </Button>
                    </div>
                    {userData.bio && (
                      <p className="text-sm text-gray-500 mt-1.5 line-clamp-4 leading-normal">
                        {userData.bio}
                      </p>
                    )}
                  </div>
                </div>
              </div>
            </div>

            {/* Details */}
            {userData.details && Object.values(userData.details).length > 0 && (
              <div className="px-5 pb-4 space-y-2.5 border-t border-gray-100 pt-3.5">
                {Object.values(userData.details).map((detail) => (
                  <div key={detail.id} className="flex items-center gap-2.5">
                    <IconComponent iconName={detail.icon} />
                    <div className="flex flex-col">
                      <span className="text-xs text-gray-500">{detail.label}</span>
                      <span className="text-sm text-gray-700">{detail.text}</span>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        ) : null}
      </HoverCardContent>
    </HoverCard>
  )
}

export default UserProfilePopup 


================================================
FILE: apps/web/components/Objects/Watermark.tsx
================================================
import Image from 'next/image'
import Link from 'next/link'
import blacklogo from '@public/black_logo.png'
import React, { useEffect } from 'react'
import { useOrg } from '../Contexts/OrgContext'

function Watermark() {
    const org = useOrg() as any

    useEffect(() => {
    }
        , [org]);

    if (org?.config?.config?.general?.watermark) {
        return (
            <div className='fixed bottom-8 right-8'>
                <Link href={`https://www.learnhouse.app/?source=in-app`} className="flex items-center cursor-pointer bg-white/80 backdrop-blur-lg text-gray-700 rounded-2xl p-2 light-shadow text-xs px-5 font-semibold space-x-2">
                    <p>Made with</p>
                    <Image unoptimized src={blacklogo} alt="logo" quality={100} width={85} />
                </Link>
            </div>
        )
    }
    return null
}

export default Watermark


================================================
FILE: apps/web/components/Objects/Activities/AI/AIActivityAsk.tsx
================================================
import { useLHSession } from '@components/Contexts/LHSessionContext'
import {
  sendActivityAIChatMessage,
  startActivityAIChatSession,
} from '@services/ai/ai'
import { AlertTriangle, BadgeInfo, NotebookTabs } from 'lucide-react'
import { motion, AnimatePresence } from 'framer-motion'
import { FlaskConical, MessageCircle, X } from 'lucide-react'
import Image from 'next/image'
import learnhouseAI_icon from 'public/learnhouse_ai_simple.png'
import learnhouseAI_logo_black from 'public/learnhouse_ai_black_logo.png'
import React, { useEffect, useRef } from 'react'
import {
  AIChatBotStateTypes,
  useAIChatBot,
  useAIChatBotDispatch,
} from '@components/Contexts/AI/AIChatBotContext'
import useGetAIFeatures from '../../../Hooks/useGetAIFeatures'
import UserAvatar from '@components/Objects/UserAvatar'

type AIActivityAskProps = {
  activity: any
}

function AIActivityAsk(props: AIActivityAskProps) {
  const is_ai_feature_enabled = useGetAIFeatures({ feature: 'activity_ask' })
  const [isButtonAvailable, setIsButtonAvailable] = React.useState(false)
  const dispatchAIChatBot = useAIChatBotDispatch() as any

  useEffect(() => {
    if (is_ai_feature_enabled) {
      setIsButtonAvailable(true)
    }
  }, [is_ai_feature_enabled])

  return (
    <>
      {isButtonAvailable && (
        <div>
          <ActivityChatMessageBox activity={props.activity} />
          <div
            onClick={() => dispatchAIChatBot({ type: 'setIsModalOpen' })}
            style={{
              background:
                'conic-gradient(from 32deg at 53.75% 50%, rgb(35, 40, 93) 4deg, rgba(20, 0, 52, 0.95) 59deg, rgba(164, 45, 238, 0.88) 281deg)',
            }}
            className="rounded-full px-5 drop-shadow-md flex  items-center space-x-1.5 p-2.5 text-sm text-white hover:cursor-pointer transition delay-150 duration-300 ease-in-out hover:scale-105"
          >
            {' '}
            <i>
              <Image
                className="outline outline-1 outline-neutral-200/20 rounded-md"
                width={20}
                src={learnhouseAI_icon}
                alt=""
              />
            </i>{' '}
            <i className="not-italic text-xs font-bold">Ask AI</i>
          </div>
        </div>
      )}
    </>
  )
}

export type AIMessage = {
  sender: string
  message: any
  type: 'ai' | 'user'
}

type ActivityChatMessageBoxProps = {
  activity: any
}

function ActivityChatMessageBox(props: ActivityChatMessageBoxProps) {
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token;
  const aiChatBotState = useAIChatBot() as AIChatBotStateTypes
  const dispatchAIChatBot = useAIChatBotDispatch() as any

  // TODO : come up with a better way to handle this
  const inputClass = aiChatBotState.isWaitingForResponse
    ? 'ring-1 ring-inset ring-white/10 bg-gray-950/40 w-full rounded-lg outline-hidden px-4 py-2 text-white text-sm placeholder:text-white/30 opacity-30 '
    : 'ring-1 ring-inset ring-white/10 bg-gray-950/40 w-full rounded-lg outline-hidden px-4 py-2 text-white text-sm placeholder:text-white/30'

  useEffect(() => {
    if (aiChatBotState.isModalOpen) {
      document.body.style.overflow = 'hidden'
    } else {
      document.body.style.overflow = 'unset'
    }
  }, [aiChatBotState.isModalOpen])

  function handleKeyDown(event: React.KeyboardEvent<HTMLInputElement>) {
    if (event.key === 'Enter') {
      // Perform the sending action here
      sendMessage(event.currentTarget.value)
    }
  }

  const handleChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
    await dispatchAIChatBot({
      type: 'setChatInputValue',
      payload: event.currentTarget.value,
    })
  }

  const sendMessage = async (message: string) => {
    if (aiChatBotState.aichat_uuid) {
      await dispatchAIChatBot({
        type: 'addMessage',
        payload: { sender: 'user', message: message, type: 'user' },
      })
      await dispatchAIChatBot({ type: 'setIsWaitingForResponse' })
      const response = await sendActivityAIChatMessage(
        message,
        aiChatBotState.aichat_uuid,
        props.activity.activity_uuid,
        access_token
      )
      if (response.success == false) {
        await dispatchAIChatBot({ type: 'setIsNoLongerWaitingForResponse' })
        await dispatchAIChatBot({ type: 'setChatInputValue', payload: '' })
        await dispatchAIChatBot({
          type: 'setError',
          payload: {
            isError: true,
            status: response.status,
            error_message: response.data.detail,
          },
        })
        return
      }
      await dispatchAIChatBot({ type: 'setIsNoLongerWaitingForResponse' })
      await dispatchAIChatBot({ type: 'setChatInputValue', payload: '' })
      await dispatchAIChatBot({
        type: 'addMessage',
        payload: { sender: 'ai', message: response.data.message, type: 'ai' },
      })
    } else {
      await dispatchAIChatBot({
        type: 'addMessage',
        payload: { sender: 'user', message: message, type: 'user' },
      })
      await dispatchAIChatBot({ type: 'setIsWaitingForResponse' })
      const response = await startActivityAIChatSession(
        message,access_token,
        props.activity.activity_uuid

      )
      if (response.success == false) {
        await dispatchAIChatBot({ type: 'setIsNoLongerWaitingForResponse' })
        await dispatchAIChatBot({ type: 'setChatInputValue', payload: '' })
        await dispatchAIChatBot({
          type: 'setError',
          payload: {
            isError: true,
            status: response.status,
            error_message: response.data.detail,
          },
        })
        return
      }
      await dispatchAIChatBot({
        type: 'setAichat_uuid',
        payload: response.data.aichat_uuid,
      })
      await dispatchAIChatBot({ type: 'setIsNoLongerWaitingForResponse' })
      await dispatchAIChatBot({ type: 'setChatInputValue', payload: '' })
      await dispatchAIChatBot({
        type: 'addMessage',
        payload: { sender: 'ai', message: response.data.message, type: 'ai' },
      })
    }
  }

  function closeModal() {
    dispatchAIChatBot({ type: 'setIsModalClose' })
  }

  const messagesEndRef = useRef<HTMLDivElement>(null)

  useEffect(() => {
    if (messagesEndRef.current) {
      messagesEndRef.current.scrollIntoView({ behavior: 'smooth' })
    }
  }, [aiChatBotState.messages, session])

  return (
    <AnimatePresence>
      {aiChatBotState.isModalOpen && (
        <>
          <motion.div
            initial={{ y: 20, opacity: 0.3, filter: 'blur(5px)' }}
            animate={{ y: 0, opacity: 1, filter: 'blur(0px)' }}
            exit={{ y: 50, opacity: 0, filter: 'blur(25px)' }}
            transition={{
              type: 'spring',
              bounce: 0.35,
              duration: 1.7,
              mass: 0.2,
              velocity: 2,
            }}
            className="fixed top-0 left-0 w-full h-full z-50 flex justify-center items-center "
            style={{ pointerEvents: 'none' }}
          >
            <div
              style={{
                pointerEvents: 'auto',
                background:
                  'linear-gradient(0deg, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.2) 100%), radial-gradient(105.16% 105.16% at 50% -5.16%, rgba(255, 255, 255, 0.18) 0%, rgba(0, 0, 0, 0) 100%), rgb(2 1 25 / 98%)',
              }}
              className="bg-black z-50 rounded-2xl max-w-(--breakpoint-2xl) w-10/12 my-10 mx-auto h-[350px] fixed bottom-0 left-1/2 transform -translate-x-1/2 shadow-lg ring-1 ring-inset ring-white/10 text-white p-4 flex-col-reverse backdrop-blur-md"
            >
              <div className="flex flex-row-reverse pb-3 justify-between items-center">
                <div className="flex space-x-2 items-center">
                  <X
                    size={20}
                    className="text-white/50 hover:cursor-pointer bg-white/10 p-1 rounded-full items-center"
                    onClick={closeModal}
                  />
                </div>
                <div
                  className={`flex space-x-2 items-center -ml-[100px] ${aiChatBotState.isWaitingForResponse ? 'animate-pulse' : ''
                    }`}
                >
                  <Image
                    className={`outline outline-1 outline-neutral-200/20 rounded-lg ${aiChatBotState.isWaitingForResponse ? 'animate-pulse' : ''
                      }`}
                    width={24}
                    src={learnhouseAI_icon}
                    alt=""
                  />
                  <span className="text-sm font-semibold text-white/70">
                    {' '}
                    AI
                  </span>
                </div>
                <div className="bg-white/5 text-white/40 py-0.5 px-3 flex space-x-1 rounded-full items-center">
                  <FlaskConical size={14} />
                  <span className="text-xs font-semibold antialiased ">
                    Experimental
                  </span>
                </div>
              </div>
              <div
                className={`w-100 h-0.5 bg-white/5 rounded-full mx-auto mb-3 ${aiChatBotState.isWaitingForResponse ? 'animate-pulse' : ''
                  }`}
              ></div>
              {aiChatBotState.messages.length > 0 &&
                !aiChatBotState.error.isError ? (
                <div className="flex-col h-[237px] w-full space-y-4 overflow-scroll scrollbar-hide">
                  {aiChatBotState.messages.map(
                    (message: AIMessage, index: number) => {
                      return (
                        <AIMessage
                          key={index}
                          message={message}
                          animated={message.sender == 'ai' ? true : false}
                        />
                      )
                    }
                  )}
                  <div ref={messagesEndRef} />
                </div>
              ) : (
                <AIMessagePlaceHolder
                  sendMessage={sendMessage}
                  activity_uuid={props.activity.activity_uuid}
                />
              )}
              {aiChatBotState.error.isError && (
                <div className="flex items-center h-[237px]">
                  <div className="flex flex-col mx-auto w-[600px] space-y-2 p-5 rounded-lg bg-red-500/20 outline outline-1 outline-red-500">
                    <AlertTriangle size={20} className="text-red-500" />
                    <div className="flex flex-col">
                      <h3 className="font-semibold text-red-200">
                        Something wrong happened
                      </h3>
                      <span className="text-red-100 text-sm ">
                        {aiChatBotState.error.error_message}
                      </span>
                    </div>
                  </div>
                </div>
              )}
              <div className="flex space-x-2 items-center">
                <div className="">
                  <UserAvatar
                    rounded="rounded-lg"
                    border="border-2"
                    width={35}
                  />
                </div>
                <div className="w-full">
                  <input
                    onKeyDown={handleKeyDown}
                    onChange={handleChange}
                    disabled={aiChatBotState.isWaitingForResponse}
                    value={aiChatBotState.chatInputValue}
                    placeholder="Ask AI About this Lecture"
                    type="text"
                    className={inputClass}
                    name=""
                    id=""
                  />
                </div>
                <div className="">
                  <MessageCircle
                    size={20}
                    className="text-white/50 hover:cursor-pointer"
                    onClick={() => sendMessage(aiChatBotState.chatInputValue)}
                  />
                </div>
              </div>
            </div>
          </motion.div>
        </>
      )}
    </AnimatePresence>
  )
}

type AIMessageProps = {
  message: AIMessage
  animated: boolean
}

function AIMessage(props: AIMessageProps) {
  const session = useLHSession() as any

  const words = props.message.message.split(' ')

  return (
    <div className="flex space-x-2 w-full antialiased font-medium">
      <div className="">
        {props.message.sender == 'ai' ? (
          <UserAvatar
            rounded="rounded-lg"
            border="border-2"
            predefined_avatar="ai"
            width={35}
          />
        ) : (
          <UserAvatar rounded="rounded-lg" border="border-2" width={35} />
        )}
      </div>
      <div className="w-full">
        <p
          className="w-full rounded-lg outline-hidden px-2 py-1 text-white text-md placeholder:text-white/30"
          id=""
        >
          <AnimatePresence>
            {words.map((word: string, i: number) => (
              <motion.span
                key={i}
                initial={
                  props.animated ? { opacity: 0, y: -10 } : { opacity: 1, y: 0 }
                }
                animate={{ opacity: 1, y: 0 }}
                exit={
                  props.animated ? { opacity: 0, y: 10 } : { opacity: 1, y: 0 }
                }
                transition={props.animated ? { delay: i * 0.1 } : {}}
              >
                {word + ' '}
              </motion.span>
            ))}
          </AnimatePresence>
        </p>
      </div>
    </div>
  )
}

const AIMessagePlaceHolder = (props: {
  activity_uuid: string
  sendMessage: any
}) => {
  const session = useLHSession() as any
  const [feedbackModal, setFeedbackModal] = React.useState(false)
  const aiChatBotState = useAIChatBot() as AIChatBotStateTypes

  if (!aiChatBotState.error.isError) {
    return (
      <div className="flex-col h-[237px] w-full">
        <div className="flex flex-col text-center justify-center pt-12">
          <motion.div
            initial={{ y: 20, opacity: 0, filter: 'blur(5px)' }}
            animate={{ y: 0, opacity: 1, filter: 'blur(0px)' }}
            exit={{ y: 50, opacity: 0 }}
            transition={{
              type: 'spring',
              bounce: 0.35,
              duration: 1.7,
              mass: 0.2,
              velocity: 2,
              delay: 0.17,
            }}
          >
            <Image
              width={100}
              className="mx-auto"
              src={learnhouseAI_logo_black}
              alt=""
            />
            <p className="pt-3 text-2xl font-semibold text-white/70 flex justify-center space-x-2 items-center">
              <span className="items-center">Hello</span>
              <span className="capitalize flex space-x-2 items-center">
                <UserAvatar rounded="rounded-lg" border="border-2" width={35} />
                <span>{session.data.user.username},</span>
              </span>
              <span>how can we help today ?</span>
            </p>
          </motion.div>
          <motion.div
            initial={{ y: 20, opacity: 0, filter: 'blur(5px)' }}
            animate={{ y: 0, opacity: 1, filter: 'blur(0px)' }}
            exit={{ y: 50, opacity: 0 }}
            transition={{
              type: 'spring',
              bounce: 0.35,
              duration: 1.7,
              mass: 0.2,
              velocity: 2,
              delay: 0.27,
            }}
            className="questions flex space-x-3 mx-auto pt-6 flex-wrap justify-center"
          >
            <AIChatPredefinedQuestion
              sendMessage={props.sendMessage}
              label="about"
            />
            <AIChatPredefinedQuestion
              sendMessage={props.sendMessage}
              label="flashcards"
            />
            <AIChatPredefinedQuestion
              sendMessage={props.sendMessage}
              label="examples"
            />
          </motion.div>
        </div>
      </div>
    )
  }
}

const AIChatPredefinedQuestion = (props: {
  sendMessage: any
  label: string
}) => {
  function getQuestion(label: string) {
    if (label === 'about') {
      return `What is this Activity about ?`
    } else if (label === 'flashcards') {
      return `Generate flashcards about this Activity`
    } else if (label === 'examples') {
      return `Explain this Activity in practical examples`
    }
  }

  return (
    <div
      onClick={() => props.sendMessage(getQuestion(props.label))}
      className="flex space-x-1.5 items-center bg-white/5 cursor-pointer px-4 py-1.5 rounded-xl outline outline-1 outline-neutral-100/10 text-xs font-semibold text-white/40 hover:text-white/60 hover:bg-white/10 hover:outline-neutral-200/40 delay-75 ease-linear transition-all"
    >
      {props.label === 'about' && <BadgeInfo size={15} />}
      {props.label === 'flashcards' && <NotebookTabs size={15} />}
      {props.label === 'examples' && <div className="text-white/50">Ex</div>}
      <span>{getQuestion(props.label)}</span>
    </div>
  )
}

export default AIActivityAsk



================================================
FILE: apps/web/components/Objects/Activities/Assignment/AssignmentBoxUI.tsx
================================================
import { useAssignmentSubmission } from '@components/Contexts/Assignments/AssignmentSubmissionContext'
import { BookPlus, BookUser, EllipsisVertical, FileUp, Forward, InfoIcon, ListTodo, Save, Type } from 'lucide-react'
import React, { useEffect } from 'react'
import { useLHSession } from '@components/Contexts/LHSessionContext'

type AssignmentBoxProps = {
    type: 'quiz' | 'file' | 'form'
    view?: 'teacher' | 'student' | 'grading' | 'custom-grading'
    maxPoints?: number
    currentPoints?: number
    saveFC?: () => void
    submitFC?: () => void
    gradeFC?: () => void
    gradeCustomFC?: (grade: number) => void
    showSavingDisclaimer?: boolean
    children: React.ReactNode
}

function AssignmentBoxUI({ type, view, currentPoints, maxPoints, saveFC, submitFC, gradeFC, gradeCustomFC, showSavingDisclaimer, children }: AssignmentBoxProps) {
    const [customGrade, setCustomGrade] = React.useState<number>(0)
    const submission = useAssignmentSubmission() as any
    const session = useLHSession() as any
    
    useEffect(() => {
        console.log(submission)
    }, [submission])

    // Check if user is authenticated
    const isAuthenticated = session?.status === 'authenticated'

    return (
        <div className='flex flex-col px-3 sm:px-6 py-4 nice-shadow rounded-md bg-slate-100/30'>
            <div className='flex flex-col sm:flex-row sm:justify-between sm:space-x-2 pb-2 text-slate-400 sm:items-center'>
                {/* Left side with type and badges */}
                <div className='flex flex-wrap gap-2 items-center mb-2 sm:mb-0'>
                    <div className='text-lg font-semibold'>
                        {type === 'quiz' &&
                            <div className='flex space-x-1.5 items-center'>
                                <ListTodo size={17} />
                                <p>Quiz</p>
                            </div>}
                        {type === 'file' &&
                            <div className='flex space-x-1.5 items-center'>
                                <FileUp size={17} />
                                <p>File Submission</p>
                            </div>}
                        {type === 'form' &&
                            <div className='flex space-x-1.5 items-center'>
                                <Type size={17} />
                                <p>Form</p>
                            </div>}
                    </div>

                    <div className='flex items-center space-x-1'>
                        <EllipsisVertical size={15} />
                    </div>
                    {view === 'teacher' &&
                        <div className='flex bg-amber-200/20 text-xs rounded-full space-x-1 px-2 py-0.5 font-bold outline items-center text-amber-600 outline-1 outline-amber-300/40'>
                            <BookUser size={12} />
                            <p>Teacher view</p>
                        </div>
                    }
                    {maxPoints &&
                        <div className='flex bg-emerald-200/20 text-xs rounded-full space-x-1 px-2 py-0.5 font-bold outline items-center text-emerald-600 outline-1 outline-emerald-300/40'>
                            <BookPlus size={12} />
                            <p>{maxPoints} points</p>
                        </div>
                    }
                </div>

                {/* Right side with buttons and actions */}
                <div className='flex flex-wrap gap-2 items-center'>
                    {showSavingDisclaimer &&
                        <div className='flex space-x-2 items-center font-semibold px-3 py-1 outline-dashed outline-red-200 text-red-400 sm:mr-5 rounded-full w-full sm:w-auto mb-2 sm:mb-0'>
                            <InfoIcon size={14} />
                            <p className='text-xs'>Don't forget to save your progress</p>
                        </div>
                    }

                    {/* Teacher button */}
                    {view === 'teacher' &&
                        <div
                            onClick={() => saveFC && saveFC()}
                            className='flex px-2 py-1 cursor-pointer rounded-md space-x-2 items-center bg-linear-to-bl text-emerald-700 bg-emerald-300/20 hover:bg-emerald-300/10 hover:outline-offset-4 active:outline-offset-1 linear transition-all outline-offset-2 outline-dashed outline-emerald-500/60'>
                            <Save size={14} />
                            <p className='text-xs font-semibold'>Save</p>
                        </div>
                    }

                    {/* Student button - only show if authenticated */}
                    {view === 'student' && isAuthenticated && submission && submission.length <= 0 &&
                        <div
                            onClick={() => submitFC && submitFC()}
                            className='flex px-2 py-1 cursor-pointer rounded-md space-x-2 items-center justify-center mx-auto w-full sm:w-auto bg-linear-to-bl text-emerald-700 bg-emerald-300/20 hover:bg-emerald-300/10 hover:outline-offset-4 active:outline-offset-1 linear transition-all outline-offset-2 outline-dashed outline-emerald-500/60'>
                            <Forward size={14} />
                            <p className='text-xs font-semibold'>Save your progress</p>
                        </div>
                    }

                    {/* Grading button */}
                    {view === 'grading' &&
                        <div
                            className='flex flex-wrap sm:flex-nowrap w-full sm:w-auto px-0.5 py-0.5 cursor-pointer rounded-md gap-2 sm:space-x-2 items-center bg-linear-to-bl hover:outline-offset-4 active:outline-offset-1 linear transition-all outline-offset-2 outline-dashed outline-orange-500/60'>
                            <p className='font-semibold px-2 text-xs text-orange-700'>Current points: {currentPoints}</p>
                            <div
                                onClick={() => gradeFC && gradeFC()}
                                className='bg-linear-to-bl text-orange-700 bg-orange-300/20 hover:bg-orange-300/10 items-center flex rounded-md px-2 py-1 space-x-2 ml-auto'>
                                <BookPlus size={14} />
                                <p className='text-xs font-semibold'>Grade</p>
                            </div>
                        </div>
                    }

                    {/* CustomGrading button */}
                    {view === 'custom-grading' && maxPoints &&
                        <div
                            className='flex flex-wrap sm:flex-nowrap w-full sm:w-auto px-0.5 py-0.5 cursor-pointer rounded-md gap-2 sm:space-x-2 items-center bg-linear-to-bl hover:outline-offset-4 active:outline-offset-1 linear transition-all outline-offset-2 outline-dashed outline-orange-500/60'>
                            <p className='font-semibold px-2 text-xs text-orange-700 w-full sm:w-auto'>Current points: {currentPoints}</p>
                            <div className='flex items-center gap-2 w-full sm:w-auto'>
                                <input
                                    onChange={(e) => setCustomGrade(parseInt(e.target.value))}
                                    placeholder={maxPoints.toString()} 
                                    className='w-full sm:w-[100px] light-shadow text-sm py-0.5 outline outline-gray-200 rounded-lg px-2' 
                                    type="number" 
                                />
                                <div
                                    onClick={() => gradeCustomFC && gradeCustomFC(customGrade)}
                                    className='bg-linear-to-bl text-orange-700 bg-orange-300/20 hover:bg-orange-300/10 items-center flex rounded-md px-2 py-1 space-x-2 whitespace-nowrap'>
                                    <BookPlus size={14} />
                                    <p className='text-xs font-semibold'>Grade</p>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
            {children}
        </div>
    )
}

export default AssignmentBoxUI


================================================
FILE: apps/web/components/Objects/Activities/Assignment/AssignmentStudentActivity.tsx
================================================
import { useAssignments } from '@components/Contexts/Assignments/AssignmentContext';
import { useCourse } from '@components/Contexts/CourseContext';
import { useOrg } from '@components/Contexts/OrgContext';
import { getTaskRefFileDir } from '@services/media/media';
import TaskFileObject from 'app/orgs/[orgslug]/dash/assignments/[assignmentuuid]/_components/TaskEditor/Subs/TaskTypes/TaskFileObject';
import TaskQuizObject from 'app/orgs/[orgslug]/dash/assignments/[assignmentuuid]/_components/TaskEditor/Subs/TaskTypes/TaskQuizObject'
import TaskFormObject from 'app/orgs/[orgslug]/dash/assignments/[assignmentuuid]/_components/TaskEditor/Subs/TaskTypes/TaskFormObject'
import { Backpack, Calendar, Download, EllipsisVertical, Info } from 'lucide-react';
import Link from 'next/link';
import React, { useEffect } from 'react'

function AssignmentStudentActivity() {
  const assignments = useAssignments() as any;
  const course = useCourse() as any;
  const org = useOrg() as any;

  useEffect(() => {
  }, [assignments, org])


  return (
    <div className='flex flex-col space-y-4 md:space-y-6'>
      <div className='flex flex-col md:flex-row justify-center md:space-x-3 space-y-3 md:space-y-0 items-center'>
        <div className='text-xs h-fit flex space-x-3 items-center'>
          <div className='flex gap-2 py-2 px-4 md:px-5 h-fit text-sm text-slate-700 bg-slate-100/5 rounded-full nice-shadow items-center'>
            <Backpack size={14} className="md:size-[14px]" />
            <p className='font-semibold'>Assignment</p>
          </div>
        </div>
        <div>
          <div className='flex gap-2 items-center'>
            <EllipsisVertical className='text-slate-400 hidden md:block' size={18} />
            <div className='flex gap-2 items-center'>
              <div className='flex gap-1 md:space-x-2 text-xs items-center text-slate-400'>
                <Calendar size={14} />
                <p className='font-semibold'>Due Date</p>
                <p className='font-semibold'>{assignments?.assignment_object?.due_date}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      
      
      {assignments?.assignment_object?.description && (
        <div className='flex flex-col space-y-2 p-4 md:p-6 bg-slate-100/30 rounded-md nice-shadow'>
          <div className='flex flex-col space-y-3'>
            <div className='flex items-center gap-2 text-slate-700'>
              <Info size={16} className="text-slate-500" />
              <h3 className='text-sm font-semibold'>Assignment Description</h3>
            </div>
            <div className='pl-6'>
              <p className='text-sm leading-relaxed text-slate-600'>{assignments.assignment_object.description}</p>
            </div>
          </div>
        </div>
      )}
      
      
      {assignments && assignments?.assignment_tasks?.sort((a: any, b: any) => a.id - b.id).map((task: any, index: number) => {
        return (
          <div className='flex flex-col space-y-2' key={task.assignment_task_uuid}>
            <div className='flex flex-col md:flex-row md:justify-between py-2 space-y-2 md:space-y-0'>
              <div className='flex flex-wrap space-x-2 font-semibold text-slate-800'>
                <p>Task {index + 1} : </p>
                <p className='text-slate-500 break-words'>{task.description}</p>
              </div>
              <div className='flex flex-wrap gap-2'>
                <div
                  onClick={() => alert(task.hint)}
                  className='px-3 py-1 flex items-center nice-shadow bg-amber-50/40 text-amber-900 rounded-full space-x-2 cursor-pointer'>
                  <Info size={13} />
                  <p className='text-xs font-semibold'>Hint</p>
                </div>
                <Link
                  href={getTaskRefFileDir(
                    org?.org_uuid,
                    assignments?.course_object.course_uuid,
                    assignments?.activity_object.activity_uuid,
                    assignments?.assignment_object.assignment_uuid,
                    task.assignment_task_uuid,
                    task.reference_file
                  )}
                  target='_blank'
                  download={true}
                  className='px-3 py-1 flex items-center nice-shadow bg-cyan-50/40 text-cyan-900 rounded-full space-x-1 md:space-x-2 cursor-pointer'>
                  <Download size={13} />
                  <div className='flex items-center space-x-1 md:space-x-2'>
                    {task.reference_file && (
                      <span className='relative'>
                        <span className='absolute right-0 top-0 block h-2 w-2 rounded-full ring-2 ring-white bg-green-400'></span>
                      </span>
                    )}
                    <p className='text-xs font-semibold'>Reference Document</p>
                  </div>
                </Link>
              </div>
            </div>
            <div className='w-full'>
              {task.assignment_type === 'QUIZ' && <TaskQuizObject key={task.assignment_task_uuid} view='student' assignmentTaskUUID={task.assignment_task_uuid} />}
              {task.assignment_type === 'FILE_SUBMISSION' && <TaskFileObject key={task.assignment_task_uuid} view='student' assignmentTaskUUID={task.assignment_task_uuid} />}
              {task.assignment_type === 'FORM' && <TaskFormObject key={task.assignment_task_uuid} view='student' assignmentTaskUUID={task.assignment_task_uuid} />}
            </div>
          </div>
        )
      })}
    </div>
  )
}

export default AssignmentStudentActivity


================================================
FILE: apps/web/components/Objects/Activities/DocumentPdf/DocumentPdf.tsx
================================================
import { useOrg } from '@components/Contexts/OrgContext'
import { getActivityMediaDirectory } from '@services/media/media'
import React from 'react'

function DocumentPdfActivity({
  activity,
  course,
}: {
  activity: any
  course: any
}) {
  const org = useOrg() as any

  React.useEffect(() => {
  }, [activity, org])

  return (
    <div className="m-8 bg-zinc-900 rounded-md mt-14">
      <iframe
        className="rounded-lg w-full h-[900px]"
        src={getActivityMediaDirectory(
          org?.org_uuid,
          course?.course_uuid,
          activity.activity_uuid,
          activity.content.filename,
          'documentpdf'
        )}
      />
    </div>
  )
}

export default DocumentPdfActivity



================================================
FILE: apps/web/components/Objects/Activities/DynamicCanva/CustomHeadingExtenstion.tsx
================================================
import Heading from '@tiptap/extension-heading'

// Custom Heading extension that adds IDs
export const CustomHeading = Heading.extend({
  renderHTML({ node, HTMLAttributes }: { node: any; HTMLAttributes: any }) {
    const hasLevel = this.options.levels.includes(node.attrs.level)
    const level = hasLevel ? node.attrs.level : this.options.levels[0]

    // Generate ID from heading text
    const headingText = node.textContent || ''
    const slug = headingText
      .toLowerCase()
      .trim()
      .replace(/[^\w\s-]/g, '') // Remove special characters
      .replace(/[\s_-]+/g, '-') // Replace spaces and underscores with hyphens
      .replace(/^-+|-+$/g, '') // Remove leading/trailing hyphens
    
    const id = slug ? `heading-${slug}` : `heading-${Math.random().toString(36).substr(2, 9)}`

    return [
      `h${level}`,
      {
        ...HTMLAttributes,
        id,
      },
      0,
    ]
  },
})


================================================
FILE: apps/web/components/Objects/Activities/DynamicCanva/DynamicCanva.tsx
================================================
import { useEditor, EditorContent } from '@tiptap/react'
import StarterKit from '@tiptap/starter-kit'
import styled from 'styled-components'
import Youtube from '@tiptap/extension-youtube'
// Custom Extensions
import InfoCallout from '@components/Objects/Editor/Extensions/Callout/Info/InfoCallout'
import WarningCallout from '@components/Objects/Editor/Extensions/Callout/Warning/WarningCallout'
import ImageBlock from '@components/Objects/Editor/Extensions/Image/ImageBlock'
import VideoBlock from '@components/Objects/Editor/Extensions/Video/VideoBlock'
import MathEquationBlock from '@components/Objects/Editor/Extensions/MathEquation/MathEquationBlock'
import PDFBlock from '@components/Objects/Editor/Extensions/PDF/PDFBlock'
import QuizBlock from '@components/Objects/Editor/Extensions/Quiz/QuizBlock'

// Lowlight
import { common, createLowlight } from 'lowlight'
const lowlight = createLowlight(common)
import CodeBlockLowlight from '@tiptap/extension-code-block-lowlight'
import css from 'highlight.js/lib/languages/css'
import js from 'highlight.js/lib/languages/javascript'
import ts from 'highlight.js/lib/languages/typescript'
import html from 'highlight.js/lib/languages/xml'
import python from 'highlight.js/lib/languages/python'
import java from 'highlight.js/lib/languages/java'
import { NoTextInput } from '@components/Objects/Editor/Extensions/NoTextInput/NoTextInput'
import EditorOptionsProvider from '@components/Contexts/Editor/EditorContext'
import AICanvaToolkit from './AI/AICanvaToolkit'
import EmbedObjects from '@components/Objects/Editor/Extensions/EmbedObjects/EmbedObjects'
import Badges from '@components/Objects/Editor/Extensions/Badges/Badges'
import Buttons from '@components/Objects/Editor/Extensions/Buttons/Buttons'
import Flipcard from '@components/Objects/Editor/Extensions/Flipcard/Flipcard'
import Scenarios from '@components/Objects/Editor/Extensions/Scenarios/Scenarios'
import { Table } from '@tiptap/extension-table'
import TableHeader from '@tiptap/extension-table-header'
import TableRow from '@tiptap/extension-table-row'
import TableCell from '@tiptap/extension-table-cell'
import UserBlock from '@components/Objects/Editor/Extensions/Users/UserBlock'
import { getLinkExtension } from '@components/Objects/Editor/EditorConf'
import TableOfContents from './TableOfContents'
import { CustomHeading } from './CustomHeadingExtenstion'
import WebPreview from '@components/Objects/Editor/Extensions/WebPreview/WebPreview'

interface Editor {
  content: string
  activity: any
}



function Canva(props: Editor) {
  /**
   * Important Note : This is a workaround to enable user interaction features to be implemented easily, like text selection, AI features and other planned features, this is set to true but otherwise it should be set to false.
   * Another workaround is implemented below to disable the editor from being edited by the user by setting the caret-color to transparent and using a custom extension to filter out transactions that add/edit/remove text.
   * To let the various Custom Extensions know that the editor is not editable, React context (EditorOptionsProvider) will be used instead of props.extension.options.editable.
   */
  const isEditable = true

  // Code Block Languages for Lowlight
  lowlight.register('html', html)
  lowlight.register('css', css)
  lowlight.register('js', js)
  lowlight.register('ts', ts)
  lowlight.register('python', python)
  lowlight.register('java', java)

  const editor: any = useEditor({
    editable: isEditable,
    extensions: [
      StarterKit.configure({
        heading: false,
        bulletList: {
          HTMLAttributes: {
            class: 'bullet-list',
          },
        },
        orderedList: {
          HTMLAttributes: {
            class: 'ordered-list',
          },
        },
      }),
      CustomHeading,
      NoTextInput,
      // Custom Extensions
      InfoCallout.configure({
        editable: isEditable,
      }),
      WarningCallout.configure({
        editable: isEditable,
      }),
      ImageBlock.configure({
        editable: isEditable,
        activity: props.activity,
      }),
      VideoBlock.configure({
        editable: true,
        activity: props.activity,
      }),
      MathEquationBlock.configure({
        editable: false,
        activity: props.activity,
      }),
      PDFBlock.configure({
        editable: true,
        activity: props.activity,
      }),
      QuizBlock.configure({
        editable: isEditable,
        activity: props.activity,
      }),
      Youtube.configure({
        controls: true,
        modestBranding: true,
      }),
      CodeBlockLowlight.configure({
        lowlight,
      }),
      EmbedObjects.configure({
        editable: isEditable,
        activity: props.activity,
      }),
      Badges.configure({
        editable: isEditable,
        activity: props.activity,
      }),
      Buttons.configure({
        editable: isEditable,
        activity: props.activity,
      }),
      UserBlock.configure({
        editable: isEditable,
        activity: props.activity,
      }),
      Table.configure({
        resizable: true,
      }),
      getLinkExtension(),
      WebPreview.configure({
        editable: true,
        activity: props.activity,
      }),
      Flipcard.configure({
        editable: false,
        activity: props.activity,
      }),
      Scenarios.configure({
        editable: false,
        activity: props.activity,
      }),
      TableRow,
      TableHeader,
      TableCell,
    ],

    content: props.content,
  })

  return (
    <EditorOptionsProvider options={{ isEditable: false }}>
      <CanvaWrapper>
        <AICanvaToolkit activity={props.activity} editor={editor} />
        <ContentWrapper>
          <TableOfContents editor={editor} />
          <EditorContent editor={editor} />
        </ContentWrapper>
      </CanvaWrapper>
    </EditorOptionsProvider>
  )
}

const CanvaWrapper = styled.div`
  width: 100%;
  margin: 0 auto;
`

const ContentWrapper = styled.div`
  display: flex;
  width: 100%;
  height: 100%;

  > div:first-child {
    width: 20%;
    padding-right: 1rem;
  }

  > div:last-child {
    width: 80%;
  }

  // Only apply flex layout when there are multiple children (table of contents present)
  &:has(> div:first-child:not(:last-child)) {
    > div:first-child {
      width: 20%;
      padding-right: 1rem;
    }

    > div:last-child {
      width: 80%;
    }
  }

  // When there's only one child (no table of contents), make it full width
  &:has(> div:first-child:last-child) {
    > div:first-child {
      width: 100%;
      padding-right: 0;
    }
  }

  .ProseMirror {
    flex: 1;
    padding: 1rem;
    // disable chrome outline
    caret-color: transparent;

    h1 {
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 24px;
    }

    h2 {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 24px;
    }

    h3 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 24px;
    }

    h4 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 24px;
    }

    h5 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 24px;
    }

    // Link styling
    a {
      color: #2563eb;
      text-decoration: underline;
      cursor: pointer;
      transition: color 0.2s ease;

      &:hover {
        color: #1d4ed8;
        text-decoration: none;
      }
    }

    ul,
    ol {
      padding: 0 1rem;
      padding-left: 20px;
    }

    ul {
      list-style-type: disc;
    }

    ol {
      list-style-type: decimal;
    }

    table {
    border-collapse: collapse;
    margin: 0;
    overflow: hidden;
    table-layout: fixed;
    width: 100%;

    td,
    th {
      border: 1px solid rgba(139, 139, 139, 0.4);
      box-sizing: border-box;
      min-width: 1em;
      padding: 6px 8px;
      position: relative;
      vertical-align: top;

      > * {
        margin-bottom: 0;
      }
    }

    th {
      background-color: rgba(217, 217, 217, 0.4);
      font-weight: bold;
      text-align: left;
    }

    .selectedCell:after {
      background: rgba(139, 139, 139, 0.2);
      content: "";
      left: 0; right: 0; top: 0; bottom: 0;
      pointer-events: none;
      position: absolute;
      z-index: 2;
    }

    .column-resize-handle {
      background-color: #8d78eb;
      bottom: -2px;
      pointer-events: none;
      position: absolute;
      right: -2px;
      top: 0;
      width: 4px;
      }
    }

    &:focus {
      outline: none !important;
      outline-style: none !important;
      box-shadow: none !important;
    }

    // Code Block
    pre {
      background: #0d0d0d;
      border-radius: 0.5rem;
      color: #fff;
      font-family: 'JetBrainsMono', monospace;
      padding: 0.75rem 1rem;

      code {
        background: none;
        color: inherit;
        font-size: 0.8rem;
        padding: 0;
      }

      .hljs-comment,
      .hljs-quote {
        color: #616161;
      }

      .hljs-variable,
      .hljs-template-variable,
      .hljs-attribute,
      .hljs-tag,
      .hljs-name,
      .hljs-regexp,
      .hljs-link,
      .hljs-name,
      .hljs-selector-id,
      .hljs-selector-class {
        color: #f98181;
      }

      .hljs-number,
      .hljs-meta,
      .hljs-built_in,
      .hljs-builtin-name,
      .hljs-literal,
      .hljs-type,
      .hljs-params {
        color: #fbbc88;
      }

      .hljs-string,
      .hljs-symbol,
      .hljs-bullet {
        color: #b9f18d;
      }

      .hljs-title,
      .hljs-section {
        color: #faf594;
      }

      .hljs-keyword,
      .hljs-selector-tag {
        color: #70cff8;
      }

      .hljs-emphasis {
        font-style: italic;
      }

      .hljs-strong {
        font-weight: 700;
      }
    }
  }
`

export default Canva



================================================
FILE: apps/web/components/Objects/Activities/DynamicCanva/TableOfContents.tsx
================================================
import { useEffect, useState } from 'react'
import styled from 'styled-components'
import { Editor } from '@tiptap/react'
import { Check } from 'lucide-react'

interface TableOfContentsProps {
  editor: Editor | null
}

interface HeadingItem {
  level: number
  text: string
  id: string
}


const TableOfContents = ({ editor }: TableOfContentsProps) => {
  const [headings, setHeadings] = useState<HeadingItem[]>([])
  const [open, setOpen] = useState(true)

  useEffect(() => {
    if (!editor) return

    const updateHeadings = () => {
      const items: HeadingItem[] = []
      editor.state.doc.descendants((node) => {
        if (node.type.name.startsWith('heading')) {
          const level = node.attrs.level || 1
          const headingText = node.textContent || ''
          
          // Create slug from heading text (same logic as CustomHeading in DynamicCanva)
          const slug = headingText
            .toLowerCase()
            .trim()
            .replace(/[^\w\s-]/g, '') // Remove special characters
            .replace(/[\s_-]+/g, '-') // Replace spaces and underscores with hyphens
            .replace(/^-+|-+$/g, '') // Remove leading/trailing hyphens
          
          const id = slug ? `heading-${slug}` : `heading-${Math.random().toString(36).substr(2, 9)}`
          
          items.push({
            level,
            text: node.textContent,
            id,
          })
        }
      })
      setHeadings(items)
    }

    editor.on('update', updateHeadings)
    updateHeadings()

    return () => {
      editor.off('update', updateHeadings)
    }
  }, [editor])

  if (headings.length === 0) return null

  return (
    <TOCCard>
      <TOCList>
        {headings.map((heading, index) => (
          <TOCItem key={index} level={heading.level}>
            <span className="toc-check"><Check size={15} strokeWidth={1.7} /></span>
            <a className={`toc-link toc-link-h${heading.level}`} href={`#${heading.id}`}>{heading.text}</a>
          </TOCItem>
        ))}
      </TOCList>
    </TOCCard>
  )
}

const TOCCard = styled.div`
  width: 100%;
  background: none;
  border: none;
  box-shadow: none;
  padding: 0;
  margin: 0;
  font-family: inherit;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  height: fit-content;
`

const TOCList = styled.ul`
  list-style: none !important;
  padding: 0 !important;
  margin: 0;
`

const TOCItem = styled.li<{ level: number }>`
  margin: 0.5rem 0;
  padding-left: ${({ level }) => `${(level - 1) * 1.2}rem`};
  list-style: none !important;
  display: flex;
  align-items: flex-start;
  gap: 0.5rem;

  .toc-check {
    display: flex;
    align-items: center;
    color: #23272f;
    flex-shrink: 0;
    margin-top: 0.1rem;
  }

  .toc-link {
    color: #23272f;
    text-decoration: none;
    display: block;
    font-size: ${({ level }) => (level === 1 ? '1rem' : level === 2 ? '0.97rem' : '0.95rem')};
    font-weight: ${({ level }) => (level === 1 ? 500 : 400)};
    line-height: 1.4;
    padding: 0;
    background: none;
    border-radius: 0;
    transition: none;
    flex: 1;
    min-width: 0;
    word-break: break-word;
    hyphens: auto;
    
    &:hover {
      color: #007acc;
    }
  }
`

export default TableOfContents 


================================================
FILE: apps/web/components/Objects/Activities/DynamicCanva/AI/AICanvaToolkit.tsx
================================================
import React, { useState, useEffect, useCallback } from 'react'
import { createPortal } from 'react-dom'
import { Editor } from '@tiptap/core'
import learnhouseAI_icon from 'public/learnhouse_ai_simple.png'
import Image from 'next/image'
import { BookOpen, FormInput, Languages, MoreVertical } from 'lucide-react'
import ToolTip from '@components/Objects/StyledElements/Tooltip/Tooltip'
import {
  AIChatBotStateTypes,
  useAIChatBot,
  useAIChatBotDispatch,
} from '@components/Contexts/AI/AIChatBotContext'
import {
  sendActivityAIChatMessage,
  startActivityAIChatSession,
} from '@services/ai/ai'
import useGetAIFeatures from '../../../../Hooks/useGetAIFeatures'
import { useLHSession } from '@components/Contexts/LHSessionContext'

type AICanvaToolkitProps = {
  editor: Editor
  activity: any
}

function AICanvaToolkit(props: AICanvaToolkitProps) {
  const is_ai_feature_enabled = useGetAIFeatures({ feature: 'activity_ask' })
  const [bubbleState, setBubbleState] = useState({
    visible: false,
    top: 0,
    left: 0,
  })

  const updateBubblePosition = useCallback(() => {
    if (!props.editor) return

    const { selection } = props.editor.state
    const { from, to } = selection

    // Hide if no selection
    if (from === to) {
      setBubbleState(prev => ({ ...prev, visible: false }))
      return
    }

    // Get selection bounds using native selection API
    const nativeSelection = window.getSelection()
    if (!nativeSelection || nativeSelection.rangeCount === 0) {
      setBubbleState(prev => ({ ...prev, visible: false }))
      return
    }

    const range = nativeSelection.getRangeAt(0)
    const rect = range.getBoundingClientRect()

    // Calculate position - always above the selection
    const bubbleHeight = 50
    const bubbleWidth = 350
    
    // Position above selection with margin
    const top = rect.top + window.scrollY - bubbleHeight - 2
    
    // Center horizontally on selection
    const centerX = rect.left + rect.width / 2
    const left = centerX - bubbleWidth / 2

    // Keep within viewport bounds
    const adjustedLeft = Math.max(10, Math.min(left, window.innerWidth - bubbleWidth - 10))
    const adjustedTop = Math.max(10, top)

    setBubbleState({
      visible: true,
      top: adjustedTop,
      left: adjustedLeft,
    })
  }, [props.editor])

  useEffect(() => {
    if (!props.editor || !is_ai_feature_enabled) return

    const handleSelectionUpdate = () => {
      // Small delay to ensure DOM is updated
      requestAnimationFrame(() => {
        updateBubblePosition()
      })
    }

    const handleScroll = () => {
      updateBubblePosition()
    }

    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element
      const bubbleElement = document.getElementById('ai-bubble-portal')
      const editorElement = props.editor.view.dom

      if (
        !editorElement.contains(target) &&
        !bubbleElement?.contains(target)
      ) {
        setBubbleState(prev => ({ ...prev, visible: false }))
      }
    }

    // Listen to editor events
    props.editor.on('selectionUpdate', handleSelectionUpdate)
    
    // Listen to scroll and click events
    window.addEventListener('scroll', handleScroll, true)
    document.addEventListener('mousedown', handleClickOutside)

    return () => {
      props.editor.off('selectionUpdate', handleSelectionUpdate)
      window.removeEventListener('scroll', handleScroll, true)
      document.removeEventListener('mousedown', handleClickOutside)
    }
  }, [props.editor, is_ai_feature_enabled, updateBubblePosition])

  if (!is_ai_feature_enabled || !bubbleState.visible) {
    return null
  }

  const bubbleContent = (
    <div
      id="ai-bubble-portal"
      style={{
        position: 'fixed',
        top: `${bubbleState.top}px`,
        left: `${bubbleState.left}px`,
        zIndex: 9999,
        pointerEvents: 'auto',
      }}
    >
      <div
        style={{
          background:
            'linear-gradient(0deg, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.2) 100%), radial-gradient(105.16% 105.16% at 50% -5.16%, rgba(255, 255, 255, 0.18) 0%, rgba(0, 0, 0, 0) 100%), rgba(2, 1, 25, 0.98)',
        }}
        className="py-1 h-10 px-2 w-max text-white rounded-xl shadow-md cursor-pointer flex items-center space-x-2 antialiased animate-in fade-in-0 zoom-in-95 duration-200"
      >
        <div className="flex w-full space-x-2 font-bold text-white/80">
          <Image
            className="outline-1 outline-neutral-200/10 rounded-lg"
            width={24}
            src={learnhouseAI_icon}
            alt=""
          />
          <div>AI</div>
        </div>
        <div>
          <MoreVertical className="text-white/50" size={12} />
        </div>
        <div className="flex space-x-2">
          <AIActionButton
            editor={props.editor}
            activity={props.activity}
            label="Explain"
          />
          <AIActionButton
            editor={props.editor}
            activity={props.activity}
            label="Summarize"
          />
          <AIActionButton
            editor={props.editor}
            activity={props.activity}
            label="Translate"
          />
          <AIActionButton
            editor={props.editor}
            activity={props.activity}
            label="Examples"
          />
        </div>
      </div>
    </div>
  )

  // Render using portal to document.body
  return typeof window !== 'undefined' ? createPortal(bubbleContent, document.body) : null
}

function AIActionButton(props: {
  editor: Editor
  label: string
  activity: any
}) {
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token;
  const dispatchAIChatBot = useAIChatBotDispatch() as any
  const aiChatBotState = useAIChatBot() as AIChatBotStateTypes

  async function handleAction(label: string) {
    const selection = getTipTapEditorSelectedText()
    const prompt = getPrompt(label, selection)
    dispatchAIChatBot({ type: 'setIsModalOpen' })
    await sendMessage(prompt)
  }

  const getTipTapEditorSelectedText = () => {
    const selection = props.editor.state.selection
    const from = selection.from
    const to = selection.to
    const text = props.editor.state.doc.textBetween(from, to)
    return text
  }

  const getPrompt = (label: string, selection: string) => {
    if (label === 'Explain') {
      return `Explain this part of the course "${selection}" keep this course context in mind.`
    } else if (label === 'Summarize') {
      return `Summarize this "${selection}" with the course context in mind.`
    } else if (label === 'Translate') {
      return `Translate "${selection}" to another language.`
    } else {
      return `Give examples to understand "${selection}" better, if possible give context in the course.`
    }
  }

  const sendMessage = async (message: string) => {
    if (aiChatBotState.aichat_uuid) {
      await dispatchAIChatBot({
        type: 'addMessage',
        payload: { sender: 'user', message: message, type: 'user' },
      })
      await dispatchAIChatBot({ type: 'setIsWaitingForResponse' })
      const response = await sendActivityAIChatMessage(
        message,
        aiChatBotState.aichat_uuid,
        props.activity.activity_uuid, access_token
      )
      if (response.success == false) {
        await dispatchAIChatBot({ type: 'setIsNoLongerWaitingForResponse' })
        await dispatchAIChatBot({ type: 'setChatInputValue', payload: '' })
        await dispatchAIChatBot({
          type: 'setError',
          payload: {
            isError: true,
            status: response.status,
            error_message: response.data.detail,
          },
        })
        return
      }
      await dispatchAIChatBot({ type: 'setIsNoLongerWaitingForResponse' })
      await dispatchAIChatBot({ type: 'setChatInputValue', payload: '' })
      await dispatchAIChatBot({
        type: 'addMessage',
        payload: { sender: 'ai', message: response.data.message, type: 'ai' },
      })
    } else {
      await dispatchAIChatBot({
        type: 'addMessage',
        payload: { sender: 'user', message: message, type: 'user' },
      })
      await dispatchAIChatBot({ type: 'setIsWaitingForResponse' })
      const response = await startActivityAIChatSession(
        message,
        access_token,
        props.activity.activity_uuid
      )
      if (response.success == false) {
        await dispatchAIChatBot({ type: 'setIsNoLongerWaitingForResponse' })
        await dispatchAIChatBot({ type: 'setChatInputValue', payload: '' })
        await dispatchAIChatBot({
          type: 'setError',
          payload: {
            isError: true,
            status: response.status,
            error_message: response.data.detail,
          },
        })
        return
      }
      await dispatchAIChatBot({
        type: 'setAichat_uuid',
        payload: response.data.aichat_uuid,
      })
      await dispatchAIChatBot({ type: 'setIsNoLongerWaitingForResponse' })
      await dispatchAIChatBot({ type: 'setChatInputValue', payload: '' })
      await dispatchAIChatBot({
        type: 'addMessage',
        payload: { sender: 'ai', message: response.data.message, type: 'ai' },
      })
    }
  }

  const tooltipLabel =
    props.label === 'Explain'
      ? 'Explain a word or a sentence with AI'
      : props.label === 'Summarize'
        ? 'Summarize a long paragraph or text with AI'
        : props.label === 'Translate'
          ? 'Translate to different languages with AI'
          : 'Give examples to understand better with AI'
  return (
    <div className="flex space-x-2">
      <ToolTip sideOffset={10} slateBlack content={tooltipLabel}>
        <button
          onClick={() => handleAction(props.label)}
          className="flex space-x-1.5 items-center bg-white/10 px-2 py-0.5 rounded-md outline-1 outline-neutral-200/20 text-sm font-semibold text-white/70 hover:bg-white/20 hover:outline-neutral-200/40 delay-75 ease-linear transition-all"
        >
          {props.label === 'Explain' && <BookOpen size={16} />}
          {props.label === 'Summarize' && <FormInput size={16} />}
          {props.label === 'Translate' && <Languages size={16} />}
          {props.label === 'Examples' && (
            <div className="text-white/50">Ex</div>
          )}
          <div>{props.label}</div>
        </button>
      </ToolTip>
    </div>
  )
}

export default AICanvaToolkit



================================================
FILE: apps/web/components/Objects/Activities/Video/LearnHousePlayer.tsx
================================================
import React, { useEffect, useRef } from 'react'
import Plyr from 'plyr'
import 'plyr/dist/plyr.css'

interface VideoDetails {
  startTime?: number
  endTime?: number | null
  autoplay?: boolean
  muted?: boolean
}

interface LearnHousePlayerProps {
  src: string
  details?: VideoDetails
  onReady?: () => void
}

const LearnHousePlayer: React.FC<LearnHousePlayerProps> = ({ src, details, onReady }) => {
  const videoRef = useRef<HTMLVideoElement>(null)
  const playerRef = useRef<Plyr | null>(null)

  useEffect(() => {
    if (videoRef.current) {
      // Initialize Plyr
      playerRef.current = new Plyr(videoRef.current, {
        controls: [
          'play-large',
          'play',
          'progress',
          'current-time',
          'mute',
          'volume',
          'settings',
          'pip',
          'fullscreen'
        ],
        settings: ['quality', 'speed', 'loop'],
        speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 2] },
        tooltips: { controls: true, seek: true },
        keyboard: { focused: true, global: true },
        seekTime: 10,
        volume: 1,
        muted: details?.muted ?? false,
        autoplay: details?.autoplay ?? false,
        disableContextMenu: true,
        hideControls: true,
        resetOnEnd: false,
        invertTime: false,
        ratio: '16:9',
        fullscreen: { enabled: true, iosNative: true }
      })

      // Set initial time if specified
      if (details?.startTime) {
        playerRef.current.currentTime = details.startTime
      }

      // Handle end time
      if (details?.endTime) {
        playerRef.current.on('timeupdate', () => {
          if (playerRef.current && playerRef.current.currentTime >= details.endTime!) {
            playerRef.current.pause()
          }
        })
      }

      // Call onReady if provided
      if (onReady) {
        playerRef.current.on('ready', onReady)
      }

      // Cleanup
      return () => {
        if (playerRef.current) {
          playerRef.current.destroy()
        }
      }
    }
  }, [details, onReady])

  return (
    <div className="w-full aspect-video rounded-lg overflow-hidden">
      <style jsx global>{`
        .plyr--video {
          --plyr-color-main: #ffffff;
          --plyr-video-background: #000000;
          --plyr-menu-background: #ffffff;
          --plyr-menu-color: #000000;
          --plyr-tooltip-background: #ffffff;
          --plyr-tooltip-color: #000000;
          --plyr-range-track-height: 4px;
          --plyr-range-thumb-height: 12px;
          --plyr-range-thumb-background: #ffffff;
          --plyr-range-fill-background: #ffffff;
          --plyr-control-icon-size: 18px;
          --plyr-control-spacing: 10px;
          --plyr-control-radius: 4px;
          --plyr-video-controls-background: linear-gradient(rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.5));
        }
        .plyr--full-ui input[type=range] {
          color: #ffffff;
        }
        .plyr__control--overlaid {
          background: rgba(255, 255, 255, 0.9);
          border: 2px solid #000;
        }
        .plyr__control--overlaid svg {
          fill: #000 !important;
        }
        .plyr__control--overlaid:hover {
          background: rgba(255, 255, 255, 1);
        }
        .plyr__control.plyr__tab-focus,
        .plyr__control:hover,
        .plyr__control[aria-expanded=true] {
          background: rgba(0, 0, 0, 0.1);
        }
        .plyr__menu__container {
          background: #ffffff;
          border: 1px solid #e5e5e5;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .plyr__menu__container > div {
          background: #ffffff;
        }
        .plyr__menu__container,
        .plyr__menu__container *,
        .plyr__menu__container button,
        .plyr__menu__container button:focus,
        .plyr__menu__container button:active,
        .plyr__menu__container button[aria-selected="true"] {
          color: #000 !important;
        }
        .plyr__menu__container button:hover {
          background: #f5f5f5;
          color: #000 !important;
        }
        .plyr__control svg {
          fill: #ffffff;
        }
        .plyr__control:hover svg {
          fill: #ffffff;
        }
        /* Settings (gear) icon: white by default, black on hover/open */
        .plyr__controls .plyr__control[data-plyr="settings"] svg {
          fill: #fff;
        }
        .plyr__controls .plyr__control[data-plyr="settings"]:hover svg,
        .plyr__controls .plyr__control[data-plyr="settings"][aria-expanded="true"] svg {
          fill: #000;
        }
        .plyr__time {
          color: #ffffff;
        }
        .plyr__progress__buffer {
          background: rgba(255, 255, 255, 0.3);
        }
        .plyr__volume--display {
          color: #ffffff;
        }
        .plyr__control[aria-expanded=true] svg {
          fill: #000000;
        }
        .plyr__control[aria-expanded=true] .plyr__tooltip {
          background: #ffffff;
          color: #000000;
        }
        .plyr__tooltip {
          background: #ffffff;
          color: #000000;
        }
        .plyr__tooltip::before {
          border-top-color: #ffffff;
        }
        /* Menu and settings icons */
        .plyr__menu__container .plyr__control svg,
        .plyr__menu__container button svg {
          fill: #000000;
        }
        .plyr__menu__container .plyr__control:hover svg,
        .plyr__menu__container button:hover svg {
          fill: #000000;
        }
        /* Settings button when menu is open */
        .plyr__control[aria-expanded=true] svg {
          fill: #000000;
        }
        /* Settings button hover */
        .plyr__control[aria-expanded=true]:hover svg {
          fill: #000000;
        }
      `}</style>
      <video
        ref={videoRef}
        className="plyr-react plyr"
        playsInline
        controls
      >
        <source src={src} type="video/mp4" />
      </video>
    </div>
  )
}

export default LearnHousePlayer 


================================================
FILE: apps/web/components/Objects/Activities/Video/Video.tsx
================================================
import React from 'react'
import YouTube from 'react-youtube'
import { getActivityMediaDirectory } from '@services/media/media'
import { useOrg } from '@components/Contexts/OrgContext'
import LearnHousePlayer from './LearnHousePlayer'

interface VideoDetails {
  startTime?: number
  endTime?: number | null
  autoplay?: boolean
  muted?: boolean
}

interface VideoActivityProps {
  activity: {
    activity_sub_type: string
    activity_uuid: string
    content: {
      filename?: string
      uri?: string
    }
    details?: VideoDetails
  }
  course: {
    course_uuid: string
  }
}

function VideoActivity({ activity, course }: VideoActivityProps) {
  const org = useOrg() as any
  const [videoId, setVideoId] = React.useState('')

  React.useEffect(() => {
    if (activity?.content?.uri) {
      var getYouTubeID = require('get-youtube-id')
      setVideoId(getYouTubeID(activity.content.uri))
    }
  }, [activity, org])

  const getVideoSrc = () => {
    if (!activity.content?.filename) return ''
    return getActivityMediaDirectory(
      org?.org_uuid,
      course?.course_uuid,
      activity.activity_uuid,
      activity.content.filename,
      'video'
    )
  }

  return (
    <div className="w-full max-w-full px-2 sm:px-4">
      {activity && (
        <>
          {console.log('Activity type:', activity.activity_sub_type)}
          {console.log('Video source:', getVideoSrc())}
          {activity.activity_sub_type === 'SUBTYPE_VIDEO_HOSTED' && (
            <div className="my-3 md:my-5 w-full">
              <div className="relative w-full aspect-video rounded-lg overflow-hidden ring-1 ring-gray-300/30 dark:ring-gray-600/30 sm:ring-gray-200/10 sm:dark:ring-gray-700/20 shadow-xs sm:shadow-none">
                {(() => {
                  const src = getVideoSrc()
                  return src ? (
                    <LearnHousePlayer
                      src={src}
                      details={activity.details}
                    />
                  ) : null
                })()}
              </div>
            </div>
          )}
          {activity.activity_sub_type === 'SUBTYPE_VIDEO_YOUTUBE' && (
            <div className="my-3 md:my-5 w-full">
              <div className="relative w-full aspect-video rounded-lg overflow-hidden ring-1 ring-gray-300/30 dark:ring-gray-600/30 sm:ring-gray-200/10 sm:dark:ring-gray-700/20 shadow-xs sm:shadow-none">
                <YouTube
                  className="w-full h-full"
                  opts={{
                    width: '100%',
                    height: '100%',
                    playerVars: {
                      autoplay: activity.details?.autoplay ? 1 : 0,
                      mute: activity.details?.muted ? 1 : 0,
                      start: activity.details?.startTime || 0,
                      end: activity.details?.endTime || undefined,
                      controls: 1,
                      modestbranding: 1,
                      rel: 0
                    },
                  }}
                  videoId={videoId}
                  onReady={(event) => {
                    if (activity.details?.startTime) {
                      event.target.seekTo(activity.details.startTime, true)
                    }
                  }}
                />
              </div>
            </div>
          )}
        </>
      )}
    </div>
  )
}

export default VideoActivity



================================================
FILE: apps/web/components/Objects/Courses/CourseActions/CourseActionsMobile.tsx
================================================
import React, { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { getUriWithoutOrg, getUriWithOrg } from '@services/config/config'
import { getProductsByCourse } from '@services/payments/products'
import { LogIn, LogOut, ShoppingCart, AlertCircle } from 'lucide-react'
import Modal from '@components/Objects/StyledElements/Modal/Modal'
import CoursePaidOptions from './CoursePaidOptions'
import { checkPaidAccess } from '@services/payments/payments'
import { removeCourse, startCourse } from '@services/courses/activity'
import { revalidateTags } from '@services/utils/ts/requests'
import UserAvatar from '../../UserAvatar'
import { getUserAvatarMediaDirectory } from '@services/media/media'

interface Author {
  user: {
    user_uuid: string
    avatar_image: string
    first_name: string
    last_name: string
    username: string
  }
  authorship: 'CREATOR' | 'CONTRIBUTOR' | 'MAINTAINER' | 'REPORTER'
  authorship_status: 'ACTIVE' | 'INACTIVE' | 'PENDING'
}

interface CourseRun {
  status: string
  course_id: string
}

interface Course {
  id: string
  course_uuid: string
  authors: Author[]
  trail?: {
    runs: CourseRun[]
  }
  chapters?: Array<{
    name: string
    activities: Array<{
      activity_uuid: string
      name: string
      activity_type: string
    }>
  }>
}

interface CourseActionsMobileProps {
  courseuuid: string
  orgslug: string
  course: Course & {
    org_id: number
  }
  trailData?: any
}

// Component for displaying multiple authors
const MultipleAuthors = ({ authors }: { authors: Author[] }) => {
  const displayedAvatars = authors.slice(0, 3)
  const remainingCount = Math.max(0, authors.length - 3)
  
  // Avatar size for mobile
  const avatarSize = 36
  const borderSize = "border-2"

  return (
    <div className="flex items-center gap-3">
      <div className="flex -space-x-3 relative">
        {displayedAvatars.map((author, index) => (
          <div
            key={author.user.user_uuid}
            className="relative"
            style={{ zIndex: displayedAvatars.length - index }}
          >
            <UserAvatar
              border={borderSize}
              rounded='rounded-full'
              avatar_url={author.user.avatar_image ? getUserAvatarMediaDirectory(author.user.user_uuid, author.user.avatar_image) : ''}
              predefined_avatar={author.user.avatar_image ? undefined : 'empty'}
              width={avatarSize}
            />
          </div>
        ))}
        {remainingCount > 0 && (
          <div 
            className="relative"
            style={{ zIndex: 0 }}
          >
            <div 
              className="flex items-center justify-center bg-neutral-100 text-neutral-600 font-medium rounded-full border-2 border-white shadow-sm"
              style={{ 
                width: `${avatarSize}px`, 
                height: `${avatarSize}px`,
                fontSize: '12px'
              }}
            >
              +{remainingCount}
            </div>
          </div>
        )}
      </div>
      
      <div className="flex flex-col">
        <span className="text-xs text-neutral-400 font-medium">
          {authors.length > 1 ? 'Authors' : 'Author'}
        </span>
        {authors.length === 1 ? (
          <span className="text-sm font-semibold text-neutral-800">
            {authors[0].user.first_name && authors[0].user.last_name 
              ? `${authors[0].user.first_name} ${authors[0].user.last_name}` 
              : `@${authors[0].user.username}`}
          </span>
        ) : (
          <span className="text-sm font-semibold text-neutral-800">
            {authors[0].user.first_name && authors[0].user.last_name
              ? `${authors[0].user.first_name} ${authors[0].user.last_name}`
              : `@${authors[0].user.username}`}
            {authors.length > 1 && ` & ${authors.length - 1} more`}
          </span>
        )}
      </div>
    </div>
  )
}

const CourseActionsMobile = ({ courseuuid, orgslug, course, trailData }: CourseActionsMobileProps) => {
  const router = useRouter()
  const session = useLHSession() as any
  const [linkedProducts, setLinkedProducts] = useState<any[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [isActionLoading, setIsActionLoading] = useState(false)
  const [isModalOpen, setIsModalOpen] = useState(false)
  const [hasAccess, setHasAccess] = useState<boolean | null>(null)

  // Clean up course UUID by removing 'course_' prefix if it exists
  const cleanCourseUuid = course.course_uuid?.replace('course_', '');

  const isStarted = trailData?.runs?.find(
    (run: any) => {
      const cleanRunCourseUuid = run.course?.course_uuid?.replace('course_', '');
      return cleanRunCourseUuid === cleanCourseUuid;
    }
  ) ?? false;

  useEffect(() => {
    const fetchLinkedProducts = async () => {
      try {
        const response = await getProductsByCourse(
          course.org_id,
          course.id,
          session.data?.tokens?.access_token
        )
        setLinkedProducts(response.data || [])
      } catch (error) {
        console.error('Failed to fetch linked products')
      } finally {
        setIsLoading(false)
      }
    }

    fetchLinkedProducts()
  }, [course.id, course.org_id, session.data?.tokens?.access_token])

  useEffect(() => {
    const checkAccess = async () => {
      if (!session.data?.user) return
      try {
        const response = await checkPaidAccess(
          parseInt(course.id),
          course.org_id,
          session.data?.tokens?.access_token
        )
        setHasAccess(response.has_access)
      } catch (error) {
        console.error('Failed to check course access')
        setHasAccess(false)
      }
    }

    if (linkedProducts.length > 0) {
      checkAccess()
    }
  }, [course.id, course.org_id, session.data?.tokens?.access_token, linkedProducts])

  const handleCourseAction = async () => {
    if (!session.data?.user) {
      router.push(getUriWithoutOrg(`/signup?orgslug=${orgslug}`))
      return
    }

    setIsActionLoading(true)
    try {
      if (isStarted) {
        await removeCourse('course_' + courseuuid, orgslug, session.data?.tokens?.access_token)
        await revalidateTags(['courses'], orgslug)
        router.refresh()
      } else {
        await startCourse('course_' + courseuuid, orgslug, session.data?.tokens?.access_token)
        await revalidateTags(['courses'], orgslug)
        
        // Get the first activity from the first chapter
        const firstChapter = course.chapters?.[0]
        const firstActivity = firstChapter?.activities?.[0]
        
        if (firstActivity) {
          // Redirect to the first activity
          await revalidateTags(['activities'], orgslug)
          router.push(
            getUriWithOrg(orgslug, '') +
            `/course/${courseuuid}/activity/${firstActivity.activity_uuid.replace('activity_', '')}`
          )
        } else {
          router.refresh()
        }
      }
    } catch (error) {
      console.error('Failed to perform course action:', error)
    } finally {
      setIsActionLoading(false)
      await revalidateTags(['courses'], orgslug)
    }
  }

  if (isLoading) {
    return <div className="animate-pulse h-16 bg-gray-100 rounded-lg mt-4 mb-8" />
  }

  // Filter active authors and sort by role priority
  const sortedAuthors = [...course.authors]
    .filter(author => author.authorship_status === 'ACTIVE')
    .sort((a, b) => {
      const rolePriority: Record<string, number> = {
        'CREATOR': 0,
        'MAINTAINER': 1,
        'CONTRIBUTOR': 2,
        'REPORTER': 3
      };
      return rolePriority[a.authorship] - rolePriority[b.authorship];
    });

  return (
    <div className="bg-white/90 backdrop-blur-sm shadow-md shadow-gray-300/25 outline outline-1 outline-neutral-200/40 rounded-lg overflow-hidden p-4 my-6 mx-2">
      <div className="flex flex-col space-y-4">
        <MultipleAuthors authors={sortedAuthors} />
        
        {linkedProducts.length > 0 ? (
          <div className="space-y-3">
            {hasAccess ? (
              <div className="p-3 bg-green-50 border border-green-200 rounded-lg">
                <div className="flex items-center gap-2">
                  <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse" />
                  <span className="text-green-800 text-sm font-semibold">You Own This Course</span>
                </div>
              </div>
            ) : (
              <div className="p-3 bg-amber-50 border border-amber-200 rounded-lg">
                <div className="flex items-center gap-2">
                  <AlertCircle className="w-4 h-4 text-amber-800" />
                  <span className="text-amber-800 text-sm font-semibold">Paid Course</span>
                </div>
              </div>
            )}
            
            {hasAccess ? (
              <button
                onClick={handleCourseAction}
                disabled={isActionLoading}
                className={`w-full py-2 px-4 rounded-lg font-semibold text-sm transition-colors flex items-center justify-center gap-2 ${
                  isStarted
                    ? 'bg-red-500 text-white hover:bg-red-600 disabled:bg-red-400'
                    : 'bg-neutral-900 text-white hover:bg-neutral-800 disabled:bg-neutral-700'
                }`}
              >
                {isActionLoading ? (
                  <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                ) : isStarted ? (
                  <>
                    <LogOut className="w-4 h-4" />
                    Leave Course
                  </>
                ) : (
                  <>
                    <LogIn className="w-4 h-4" />
                    Start Course
                  </>
                )}
              </button>
            ) : (
              <>
                <Modal
                  isDialogOpen={isModalOpen}
                  onOpenChange={setIsModalOpen}
                  dialogContent={<CoursePaidOptions course={course} />}
                  dialogTitle="Purchase Course"
                  dialogDescription="Select a payment option to access this course"
                  minWidth="sm"
                />
                <button
                  onClick={() => setIsModalOpen(true)}
                  disabled={isActionLoading}
                  className="w-full py-2 px-4 rounded-lg bg-neutral-900 text-white font-semibold text-sm hover:bg-neutral-800 transition-colors flex items-center justify-center gap-2 disabled:bg-neutral-700"
                >
                  {isActionLoading ? (
                    <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                  ) : (
                    <>
                      <ShoppingCart className="w-4 h-4" />
                      Purchase Course
                    </>
                  )}
                </button>
              </>
            )}
          </div>
        ) : (
          <button
            onClick={handleCourseAction}
            disabled={isActionLoading}
            className={`w-full py-2 px-4 rounded-lg font-semibold text-sm transition-colors flex items-center justify-center gap-2 ${
              isStarted
                ? 'bg-red-500 text-white hover:bg-red-600 disabled:bg-red-400'
                : 'bg-neutral-900 text-white hover:bg-neutral-800 disabled:bg-neutral-700'
            }`}
          >
            {isActionLoading ? (
              <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
            ) : !session.data?.user ? (
              <>
                <LogIn className="w-4 h-4" />
                Sign In
              </>
            ) : isStarted ? (
              <>
                <LogOut className="w-4 h-4" />
                Leave Course
              </>
            ) : (
              <>
                <LogIn className="w-4 h-4" />
                Start Course
              </>
            )}
          </button>
        )}
      </div>
    </div>
  )
}

export default CourseActionsMobile 


================================================
FILE: apps/web/components/Objects/Courses/CourseActions/CoursePaidOptions.tsx
================================================
import React, { useState } from 'react'
import { useOrg } from '@components/Contexts/OrgContext'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import useSWR from 'swr'
import { getProductsByCourse, getStripeProductCheckoutSession } from '@services/payments/products'
import { RefreshCcw, SquareCheck, ChevronDown, ChevronUp } from 'lucide-react'
import { Badge } from '@components/ui/badge'
import { Button } from '@components/ui/button'
import toast from 'react-hot-toast'
import { useRouter } from 'next/navigation'
import { getUriWithOrg } from '@services/config/config'

interface CoursePaidOptionsProps {
  course: {
    id: string;
    org_id: number;
  }
}

function CoursePaidOptions({ course }: CoursePaidOptionsProps) {
  const org = useOrg() as any
  const session = useLHSession() as any
  const [expandedProducts, setExpandedProducts] = useState<{ [key: string]: boolean }>({})
  const [isProcessing, setIsProcessing] = useState<{ [key: string]: boolean }>({})
  const router = useRouter()

  const { data: linkedProducts, error } = useSWR(
    () => org && session ? [`/payments/${course.org_id}/courses/${course.id}/products`, session.data?.tokens?.access_token] : null,
    ([url, token]) => getProductsByCourse(course.org_id, course.id, token)
  )

  const handleCheckout = async (productId: number) => {
    if (!session.data?.user) {
      // Redirect to login if user is not authenticated
      router.push(`/signup?orgslug=${org.slug}`)
      return
    }

    try {
      setIsProcessing(prev => ({ ...prev, [productId]: true }))
      const redirect_uri = getUriWithOrg(org.slug, '/courses')
      const response = await getStripeProductCheckoutSession(
        course.org_id,
        productId,
        redirect_uri,
        session.data?.tokens?.access_token
      )

      if (response.success) {
        router.push(response.data.checkout_url)
      } else {
        toast.error('Failed to initiate checkout process')
      }
    } catch (error) {
      toast.error('An error occurred while processing your request')
    } finally {
      setIsProcessing(prev => ({ ...prev, [productId]: false }))
    }
  }

  const toggleProductExpansion = (productId: string) => {
    setExpandedProducts(prev => ({
      ...prev,
      [productId]: !prev[productId]
    }))
  }

  if (error) return <div>Failed to load product options</div>
  if (!linkedProducts) return <div>Loading...</div>

  return (
    <div className="space-y-4 p-1">
      {linkedProducts.data.map((product: any) => (
        <div key={product.id} className="bg-slate-50/30 p-4 rounded-lg nice-shadow flex flex-col">
          <div className="flex justify-between items-start mb-2">
            <div className="flex flex-col space-y-1 items-start">
              <Badge className='w-fit flex items-center space-x-2 bg-gray-100/50' variant="outline">
                {product.product_type === 'subscription' ? <RefreshCcw size={12} /> : <SquareCheck size={12} />}
                <span className='text-sm'>
                  {product.product_type === 'subscription' ? 'Subscription' : 'One-time payment'}
                  {product.product_type === 'subscription' && ' (per month)'}
                </span>
              </Badge>
              <h3 className="font-bold text-lg">{product.name}</h3>
            </div>
          </div>

          <div className="grow overflow-hidden">
            <div className={`transition-all duration-300 ease-in-out ${expandedProducts[product.id] ? 'max-h-[1000px]' : 'max-h-24'
              } overflow-hidden`}>
              <p className="text-gray-600">
                {product.description}
              </p>
              {product.benefits && (
                <div className="mt-2">
                  <h4 className="font-semibold text-sm">Benefits:</h4>
                  <p className="text-sm text-gray-600">
                    {product.benefits}
                  </p>
                </div>
              )}
            </div>
          </div>

          <div className="mt-2">
            <button
              onClick={() => toggleProductExpansion(product.id)}
              className="text-slate-500 hover:text-slate-700 text-sm flex items-center"
            >
              {expandedProducts[product.id] ? (
                <>
                  <ChevronUp size={16} />
                  <span>Show less</span>
                </>
              ) : (
                <>
                  <ChevronDown size={16} />
                  <span>Show more</span>
                </>
              )}
            </button>
          </div>

          <div className="mt-2 flex items-center justify-between bg-gray-100 rounded-md p-2">
            <span className="text-sm text-gray-600">
              {product.price_type === 'customer_choice' ? 'Minimum Price:' : 'Price:'}
            </span>
            <div className="flex flex-col items-end">
              <span className="font-semibold text-lg">
                {new Intl.NumberFormat('en-US', {
                  style: 'currency',
                  currency: product.currency
                }).format(product.amount)}
                {product.product_type === 'subscription' && <span className="text-sm text-gray-500 ml-1">/month</span>}
              </span>
              {product.price_type === 'customer_choice' && (
                <span className="text-sm text-gray-500">Choose your price</span>
              )}
            </div>
          </div>

          <Button
            className="mt-4 w-full"
            variant="default"
            onClick={() => handleCheckout(product.id)}
            disabled={isProcessing[product.id]}
          >
            {isProcessing[product.id]
              ? 'Processing...'
              : product.product_type === 'subscription'
                ? 'Subscribe Now'
                : 'Purchase Now'
            }
          </Button>
        </div>
      ))}
    </div>
  )
}

export default CoursePaidOptions



================================================
FILE: apps/web/components/Objects/Courses/CourseActions/CoursesActions.tsx
================================================
import React, { useState, useEffect } from 'react'
import { removeCourse, startCourse } from '@services/courses/activity'
import { revalidateTags } from '@services/utils/ts/requests'
import { useRouter } from 'next/navigation'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { getAPIUrl, getUriWithOrg, getUriWithoutOrg } from '@services/config/config'
import { getProductsByCourse } from '@services/payments/products'
import { ShoppingCart, AlertCircle, UserPen, ClockIcon, ArrowRight, BookOpen } from 'lucide-react'
import Modal from '@components/Objects/StyledElements/Modal/Modal'
import CoursePaidOptions from './CoursePaidOptions'
import { checkPaidAccess } from '@services/payments/payments'
import { applyForContributor } from '@services/courses/courses'
import toast from 'react-hot-toast'
import { useContributorStatus } from '../../../../hooks/useContributorStatus'
import CourseProgress from '../CourseProgress/CourseProgress'
import UserAvatar from '@components/Objects/UserAvatar'
import { useOrg } from '@components/Contexts/OrgContext'
import { mutate } from 'swr'

interface CourseRun {
  status: string
  course_id: string
  steps: Array<{
    activity_id: string
    complete: boolean
  }>
}

interface Course {
  id: string
  course_uuid: string
  trail?: {
    runs: CourseRun[]
  }
  chapters?: Array<{
    name: string
    activities: Array<{
      activity_uuid: string
      name: string
      activity_type: string
    }>
  }>
  open_to_contributors?: boolean
}

interface CourseActionsProps {
  courseuuid: string
  orgslug: string
  course: Course & {
    org_id: number
  }
  trailData?: any
}

function CoursesActions({ courseuuid, orgslug, course, trailData }: CourseActionsProps) {
  const router = useRouter()
  const session = useLHSession() as any
  const [linkedProducts, setLinkedProducts] = useState<any[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [isActionLoading, setIsActionLoading] = useState(false)
  const [isContributeLoading, setIsContributeLoading] = useState(false)
  const [isModalOpen, setIsModalOpen] = useState(false)
  const [hasAccess, setHasAccess] = useState<boolean | null>(null)
  const { contributorStatus, refetch } = useContributorStatus(courseuuid)
  const [isProgressOpen, setIsProgressOpen] = useState(false)
  const org = useOrg() as any

  // Clean up course UUID by removing 'course_' prefix if it exists
  const cleanCourseUuid = course.course_uuid?.replace('course_', '');

  const isStarted = trailData?.runs?.find(
    (run: any) => {
      const cleanRunCourseUuid = run.course?.course_uuid?.replace('course_', '');
      return cleanRunCourseUuid === cleanCourseUuid;
    }
  ) ?? false;

  useEffect(() => {
    const fetchLinkedProducts = async () => {
      try {
        const response = await getProductsByCourse(
          course.org_id,
          course.id,
          session.data?.tokens?.access_token
        )
        setLinkedProducts(response.data || [])
      } catch (error) {
        console.error('Failed to fetch linked products')
      } finally {
        setIsLoading(false)
      }
    }

    fetchLinkedProducts()
  }, [course.id, course.org_id, session.data?.tokens?.access_token])

  useEffect(() => {
    const checkAccess = async () => {
      if (!session.data?.user) return
      try {
        const response = await checkPaidAccess(
          parseInt(course.id),
          course.org_id,
          session.data?.tokens?.access_token
        )
        setHasAccess(response.has_access)
        
      } catch (error) {
        console.error('Failed to check course access')
        toast.error('Failed to check course access. Please try again later.')
        setHasAccess(false)
      }
    }

    if (linkedProducts.length > 0) {
      checkAccess()
    }
  }, [course.id, course.org_id, session.data?.tokens?.access_token, linkedProducts])

  const handleCourseAction = async () => {
    if (!session.data?.user) {
      router.push(getUriWithoutOrg(`/signup?orgslug=${orgslug}`))
      return
    }

    setIsActionLoading(true)
    const loadingToast = toast.loading(
      isStarted ? 'Leaving course...' : 'Starting course...'
    )
    
    try {
      if (isStarted) {
        await removeCourse('course_' + courseuuid, orgslug, session.data?.tokens?.access_token)
        mutate(`${getAPIUrl()}trail/org/${org?.id}/trail`)
        toast.success('Successfully left the course', { id: loadingToast })
      } else {
        await startCourse('course_' + courseuuid, orgslug, session.data?.tokens?.access_token)
        mutate(`${getAPIUrl()}trail/org/${org?.id}/trail`)
        toast.success('Successfully started the course', { id: loadingToast })
        
        // Get the first activity from the first chapter
        const firstChapter = course.chapters?.[0]
        const firstActivity = firstChapter?.activities?.[0]
        
        if (firstActivity) {
          // Redirect to the first activity
          router.push(
            getUriWithOrg(orgslug, '') +
            `/course/${courseuuid}/activity/${firstActivity.activity_uuid.replace('activity_', '')}`
          )
        } else {
          mutate(`${getAPIUrl()}trail/org/${org?.id}/trail`)
        }
      }
    } catch (error) {
      console.error('Failed to perform course action:', error)
      toast.error(
        isStarted
          ? 'Failed to leave the course. Please try again later.'
          : 'Failed to start the course. Please try again later.',
        { id: loadingToast }
      )
    } finally {
      setIsActionLoading(false)
    }
  }

  const handleApplyToContribute = async () => {
    if (!session.data?.user) {
      router.push(getUriWithoutOrg(`/signup?orgslug=${orgslug}`))
      return
    }

    setIsContributeLoading(true)
    const loadingToast = toast.loading('Submitting contributor application...')
    
    try {
      const data = {
        message: "I would like to contribute to this course."
      }
      
      await applyForContributor('course_' + courseuuid, data, session.data?.tokens?.access_token)
      await revalidateTags(['courses'], orgslug)
      await refetch()
      toast.success('Your application to contribute has been submitted successfully', { id: loadingToast })
    } catch (error) {
      console.error('Failed to apply as contributor:', error)
      toast.error('Failed to submit your application. Please try again later.', { id: loadingToast })
    } finally {
      setIsContributeLoading(false)
    }
  }

  const renderActionButton = (action: 'start' | 'leave') => {
    if (!session.data?.user) {
      return (
        <>
          <UserAvatar width={24} predefined_avatar="empty" rounded="rounded-full" border="border-2" borderColor="border-white" />
          <span>{action === 'start' ? 'Start Course' : 'Leave Course'}</span>
          <ArrowRight className="w-5 h-5" />
        </>
      );
    }

    return (
      <>
        <UserAvatar 
          width={24} 
          use_with_session={true} 
          rounded="rounded-full" 
          border="border-2" 
          borderColor="border-white"
        />
        <span>{action === 'start' ? 'Start Course' : 'Leave Course'}</span>
        <ArrowRight className="w-5 h-5" />
      </>
    );
  };

  const renderContributorButton = () => {
    if (contributorStatus === 'INACTIVE' || course.open_to_contributors !== true) {
      return null;
    }
    
    if (!session.data?.user) {
      return (
        <button
          onClick={() => router.push(getUriWithoutOrg(`/signup?orgslug=${orgslug}`))}
          aria-label="Sign up to apply as course contributor"
          className="w-full bg-white text-neutral-700 border border-neutral-200 py-3 rounded-lg nice-shadow font-semibold hover:bg-neutral-50 transition-colors flex items-center justify-center gap-2 mt-3 cursor-pointer"
        >
          <UserPen className="w-5 h-5" />
          Authenticate to contribute
        </button>
      );
    }

    if (contributorStatus === 'ACTIVE') {
      return (
        <div className="w-full bg-green-50 text-green-700 border border-green-200 py-3 rounded-lg nice-shadow font-semibold flex items-center justify-center gap-2 mt-3">
          <UserPen className="w-5 h-5" />
          You are a contributor
        </div>
      );
    }

    if (contributorStatus === 'PENDING') {
      return (
        <div className="w-full bg-amber-50 text-amber-700 border border-amber-200 py-3 rounded-lg nice-shadow font-semibold flex items-center justify-center gap-2 mt-3">
          <ClockIcon className="w-5 h-5" />
          Contributor application pending
        </div>
      );
    }

    return (
      <button
        onClick={handleApplyToContribute}
        disabled={isContributeLoading}
        aria-label="Apply to become a course contributor"
        className="w-full bg-white text-neutral-700 py-3 rounded-lg nice-shadow font-semibold hover:bg-neutral-50 transition-colors flex items-center justify-center gap-2 mt-3 cursor-pointer disabled:cursor-not-allowed"
      >
        {isContributeLoading ? (
          <div className="w-5 h-5 border-2 border-neutral-700 border-t-transparent rounded-full animate-spin" />
        ) : (
          <>
            <UserPen className="w-5 h-5" />
            Apply to contribute
          </>
        )}
      </button>
    );
  };

  const renderProgressSection = () => {
    const totalActivities = course.chapters?.reduce((acc: number, chapter: any) => acc + chapter.activities.length, 0) || 0;
    
    // Find the correct run using the cleaned UUID
    const run = trailData?.runs?.find(
      (run: any) => {
        const cleanRunCourseUuid = run.course?.course_uuid?.replace('course_', '');
        return cleanRunCourseUuid === cleanCourseUuid;
      }
    );
    
    const completedActivities = run?.steps?.filter((step: any) => step.complete)?.length || 0;
    const progressPercentage = Math.round((completedActivities / totalActivities) * 100);

    if (!isStarted) {
      return (
        <div className="relative bg-white nice-shadow rounded-lg overflow-hidden">
          <div 
            className="absolute inset-0 opacity-[0.05]" 
            style={{
              backgroundImage: 'radial-gradient(circle at center, #101010 1px, transparent 1px)',
              backgroundSize: '12px 12px'
            }}
          />
          <div className="relative p-4">
            <div className="flex items-center gap-4">
              <div className="flex-1">
                <div className="flex items-center gap-4">
                  <div className="relative w-16 h-16">
                    <svg className="w-full h-full transform -rotate-90">
                      <circle
                        cx="32"
                        cy="32"
                        r="28"
                        stroke="#e5e7eb"
                        strokeWidth="6"
                        fill="none"
                      />
                    </svg>
                    <div className="absolute inset-0 flex items-center justify-center">
                      <BookOpen className="w-6 h-6 text-neutral-400" />
                    </div>
                  </div>
                  <div className="flex-1">
                    <div className="text-sm font-medium text-gray-900">Ready to Begin?</div>
                    <div className="text-sm text-gray-500">
                      Start your learning journey with {totalActivities} exciting {totalActivities === 1 ? 'activity' : 'activities'}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    return (
        <div className="relative bg-white nice-shadow rounded-lg overflow-hidden">
          <div 
          className="absolute inset-0 opacity-[0.05]" 
          style={{
            backgroundImage: 'radial-gradient(circle at center, #000 1px, transparent 1px)',
            backgroundSize: '24px 24px'
          }}
        />
        <div className="relative p-4">
          <div className="flex items-center gap-4">
            <div className="flex-1">
              <div className="flex items-center gap-4">
                <div className="relative w-16 h-16">
                  <svg className="w-full h-full transform -rotate-90">
                    <circle
                      cx="32"
                      cy="32"
                      r="28"
                      stroke="#e5e7eb"
                      strokeWidth="6"
                      fill="none"
                    />
                    <circle
                      cx="32"
                      cy="32"
                      r="28"
                      stroke="#10b981"
                      strokeWidth="6"
                      fill="none"
                      strokeLinecap="round"
                      strokeDasharray={2 * Math.PI * 28}
                      strokeDashoffset={2 * Math.PI * 28 * (1 - completedActivities / totalActivities)}
                      className="transition-all duration-500 ease-out"
                    />
                  </svg>
                  <div className="absolute inset-0 flex items-center justify-center">
                    <span className="text-lg font-bold text-gray-800">
                      {progressPercentage}%
                    </span>
                  </div>
                </div>
                <button
                  onClick={() => setIsProgressOpen(true)}
                  aria-label={`View course progress: ${completedActivities} of ${totalActivities} activities completed`}
                  className="flex-1 text-left hover:bg-neutral-50/50 p-2 rounded-lg transition-colors"
                >
                  <div className="text-sm font-medium text-gray-900">Course Progress</div>
                  <div className="text-sm text-gray-500">
                    {completedActivities} of {totalActivities} completed
                  </div>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  };

  if (isLoading) {
    return <div className="animate-pulse h-20 bg-gray-100 rounded-lg nice-shadow" />
  }

  if (linkedProducts.length > 0) {
    return (
      <div className="bg-white shadow-md shadow-gray-300/25 outline outline-1 outline-neutral-200/40 rounded-lg overflow-hidden p-4">
        <div className="space-y-4">
          {hasAccess ? (
            <>
              <div className="p-4 bg-green-50 border border-green-200 rounded-lg nice-shadow">
                <div className="flex items-center gap-3">
                  <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse" />
                  <h3 className="text-green-800 font-semibold">You Own This Course</h3>
                </div>
                <p className="text-green-700 text-sm mt-1">
                  You have purchased this course and have full access to all content.
                </p>
              </div>
              <button
                onClick={handleCourseAction}
                disabled={isActionLoading}
                aria-label={isStarted ? 'Leave this course' : 'Start this course'}
                className={`w-full py-3 rounded-lg nice-shadow font-semibold transition-colors flex items-center justify-center gap-2 cursor-pointer ${
                  isStarted
                    ? 'bg-red-500 text-white hover:bg-red-600 disabled:bg-red-400'
                    : 'bg-neutral-900 text-white hover:bg-neutral-800 disabled:bg-neutral-700'
                }`}
              >
                {isActionLoading ? (
                  <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
                ) : (
                  renderActionButton(isStarted ? 'leave' : 'start')
                )}
              </button>
              {renderContributorButton()}
            </>
          ) : (
            <>
              <div className="p-4 bg-amber-50 border border-amber-200 rounded-lg nice-shadow">
                <div className="flex items-center gap-3">
                  <AlertCircle className="w-5 h-5 text-amber-800" />
                  <h3 className="text-amber-800 font-semibold">Paid Course</h3>
                </div>
                <p className="text-amber-700 text-sm mt-1">
                  This course requires purchase to access its content.
                </p>
              </div>
              <Modal
                isDialogOpen={isModalOpen}
                onOpenChange={setIsModalOpen}
                dialogContent={<CoursePaidOptions course={course} />}
                dialogTitle="Purchase Course"
                dialogDescription="Select a payment option to access this course"
                minWidth="sm"
              />
              <button
                className="w-full bg-neutral-900 text-white py-3 rounded-lg nice-shadow font-semibold hover:bg-neutral-800 transition-colors flex items-center justify-center gap-2"
                onClick={() => setIsModalOpen(true)}
                aria-label="Purchase this course to gain access"
              >
                <ShoppingCart className="w-5 h-5" />
                Purchase Course
              </button>
              {renderContributorButton()}
            </>
          )}
        </div>
      </div>
    )
  }

  return (
    <div className="bg-white shadow-md shadow-gray-300/25 outline outline-1 outline-neutral-200/40 rounded-lg overflow-hidden p-4">
      <div className="space-y-4">
        {/* Progress Section */}
        {renderProgressSection()}

        {/* Start/Leave Course Button */}
        <button
          onClick={handleCourseAction}
          disabled={isActionLoading}
          aria-label={isStarted ? 'Leave this course' : 'Start this course'}
          className={`w-full py-3 rounded-lg nice-shadow font-semibold transition-colors flex items-center justify-center gap-2 cursor-pointer ${
            isStarted
              ? 'bg-red-500 text-white hover:bg-red-600 disabled:bg-red-400'
              : 'bg-neutral-900 text-white hover:bg-neutral-800 disabled:bg-neutral-700'
          }`}
        >
          {isActionLoading ? (
            <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
          ) : (
            renderActionButton(isStarted ? 'leave' : 'start')
          )}
        </button>

        {/* Contributor Button */}
        {renderContributorButton()}

        {/* Course Progress Modal */}
        <CourseProgress
          course={course}
          orgslug={orgslug}
          isOpen={isProgressOpen}
          onClose={() => setIsProgressOpen(false)}
          trailData={trailData}
        />
      </div>
    </div>
  )
}

export default CoursesActions


================================================
FILE: apps/web/components/Objects/Courses/CourseActions/PaidCourseActivityDisclaimer.tsx
================================================
import React from 'react'
import { AlertCircle } from 'lucide-react'
import CoursePaidOptions from './CoursePaidOptions'

interface PaidCourseActivityProps {
  course: any;
}

function PaidCourseActivityDisclaimer({ course }: PaidCourseActivityProps) {
  return (
    <div className="space-y-4 max-w-lg mx-auto">
      <div className="p-4 bg-amber-50 border border-amber-200 rounded-lg ">
        <div className="flex items-center gap-3">
          <AlertCircle className="w-5 h-5 text-amber-800" />
          <h3 className="text-amber-800 font-semibold">Paid Content</h3>
        </div>
        <p className="text-amber-700 text-sm mt-1">
          This content requires a course purchase to access. 
        </p>
      </div>
      <CoursePaidOptions course={course} />
    </div>
  )
}

export default PaidCourseActivityDisclaimer


================================================
FILE: apps/web/components/Objects/Courses/CourseAuthors/CourseAuthors.tsx
================================================
import React from 'react'
import UserAvatar from '../../UserAvatar'
import { getUserAvatarMediaDirectory } from '@services/media/media'
import { useMediaQuery } from 'usehooks-ts'
import { Rss, PencilLine, TentTree } from 'lucide-react'
import { useCourse } from '@components/Contexts/CourseContext'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import useSWR, { mutate } from 'swr'
import { getAPIUrl } from '@services/config/config'
import { swrFetcher } from '@services/utils/ts/requests'
import useAdminStatus from '@components/Hooks/useAdminStatus'
import { useOrg } from '@components/Contexts/OrgContext'
import { createCourseUpdate, deleteCourseUpdate } from '@services/courses/updates'
import toast from 'react-hot-toast'
import ConfirmationModal from '@components/Objects/StyledElements/ConfirmationModal/ConfirmationModal'
import dayjs from 'dayjs'
import relativeTime from 'dayjs/plugin/relativeTime'
import * as Form from '@radix-ui/react-form'
import FormLayout, {
  FormField,
  FormLabelAndMessage,
  Input,
  Textarea,
} from '@components/Objects/StyledElements/Form/Form'
import { useFormik } from 'formik'
import { motion } from 'framer-motion'

dayjs.extend(relativeTime)

interface Author {
  user: {
    id: string
    user_uuid: string
    avatar_image: string
    first_name: string
    last_name: string
    username: string
  }
  authorship: 'CREATOR' | 'CONTRIBUTOR' | 'MAINTAINER' | 'REPORTER'
  authorship_status: 'ACTIVE' | 'INACTIVE' | 'PENDING'
}

interface CourseAuthorsProps {
  authors: Author[]
}

const MultipleAuthors = ({ authors, isMobile }: { authors: Author[], isMobile: boolean }) => {
  const displayedAvatars = authors.slice(0, 3)
  const displayedNames = authors.slice(0, 2)
  const remainingCount = Math.max(0, authors.length - 3)
  
  // Consistent sizes for both avatars and badge
  const avatarSize = isMobile ? 72 : 86
  const borderSize = "border-4"

  return (
    <div className="flex flex-col items-center space-y-4 px-2 py-2">
      <div className="text-[12px] text-neutral-400 font-semibold self-start">Authors & Updates </div>
      
      {/* Avatars row */}
      <div className="flex justify-center -space-x-6 relative">
        {displayedAvatars.map((author, index) => (
          <div
            key={author.user.user_uuid}
            className="relative"
            style={{ zIndex: displayedAvatars.length - index }}
          >
            <div className="ring-white">
              <UserAvatar
                border={borderSize}
                rounded='rounded-full'
                avatar_url={author.user.avatar_image ? getUserAvatarMediaDirectory(author.user.user_uuid, author.user.avatar_image) : ''}
                predefined_avatar={author.user.avatar_image ? undefined : 'empty'}
                width={avatarSize}
                showProfilePopup={true}
                userId={author.user.id}
              />
            </div>
          </div>
        ))}
        {remainingCount > 0 && (
          <div 
            className="relative"
            style={{ zIndex: 0 }}
          >
            <div 
              className="flex items-center justify-center bg-neutral-100 text-neutral-600 font-medium rounded-full border-4 border-white shadow-sm"
              style={{ 
                width: `${avatarSize}px`, 
                height: `${avatarSize}px`,
                fontSize: isMobile ? '14px' : '16px'
              }}
            >
              +{remainingCount}
            </div>
          </div>
        )}
      </div>

      {/* Names row - improved display logic */}
      <div className="text-center mt-2">
        <div className="text-sm font-medium text-neutral-800">
          {authors.length === 1 ? (
            <span>
              {authors[0].user.first_name && authors[0].user.last_name
                ? `${authors[0].user.first_name} ${authors[0].user.last_name}`
                : `@${authors[0].user.username}`}
            </span>
          ) : (
            <>
              {displayedNames.map((author, index) => (
                <span key={author.user.user_uuid}>
                  {author.user.first_name && author.user.last_name
                    ? `${author.user.first_name} ${author.user.last_name}`
                    : `@${author.user.username}`}
                  {index === 0 && authors.length > 1 && index < displayedNames.length - 1 && " & "}
                </span>
              ))}
              {authors.length > 2 && (
                <span className="text-neutral-500 ml-1">
                  & {authors.length - 2} more
                </span>
              )}
            </>
          )}
        </div>
        <div className="text-xs text-neutral-500 mt-0.5">
          {authors.length === 1 ? (
            <span>@{authors[0].user.username}</span>
          ) : (
            <>
              {displayedNames.map((author, index) => (
                <span key={author.user.user_uuid}>
                  @{author.user.username}
                  {index === 0 && authors.length > 1 && index < displayedNames.length - 1 && " & "}
                </span>
              ))}
            </>
          )}
        </div>
      </div>
    </div>
  )
}

const UpdatesSection = () => {
  const [selectedView, setSelectedView] = React.useState('list')
  const adminStatus = useAdminStatus()
  const course = useCourse() as any
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token
  const { data: updates } = useSWR(
    `${getAPIUrl()}courses/${course?.courseStructure.course_uuid}/updates`,
    (url) => swrFetcher(url, access_token)
  )

  return (
    <div className="mt-2 pt-2">
      <div className="flex justify-between items-center mb-4">
        <div className="flex items-center space-x-3">
          <div className="flex items-center space-x-2">
            <Rss size={14} className="text-neutral-400" />
            <span className="text-sm font-semibold text-neutral-600">Course Updates</span>
          </div>
          {updates && updates.length > 0 && (
            <span className="px-2 py-0.5 text-[11px] font-medium bg-neutral-100 text-neutral-500 rounded-full">
              {updates.length} {updates.length === 1 ? 'update' : 'updates'}
            </span>
          )}
        </div>
        {adminStatus.isAdmin && (
          <button
            onClick={() => setSelectedView(selectedView === 'new' ? 'list' : 'new')}
            className={`
              inline-flex items-center space-x-1.5 px-2.5 py-1 rounded-full text-xs font-medium
              transition-colors duration-150
              ${selectedView === 'new' 
                ? 'bg-neutral-200 text-neutral-700 hover:bg-neutral-300' 
                : 'bg-neutral-100 text-neutral-600 hover:bg-neutral-200'
              }
            `}
          >
            <PencilLine size={12} />
            <span>{selectedView === 'new' ? 'Cancel' : 'New Update'}</span>
          </button>
        )}
      </div>
      
      <motion.div
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.2 }}
        className="relative"
      >
        <div className="max-h-[300px] overflow-y-auto pr-1 -mr-1">
          {selectedView === 'list' ? (
            <UpdatesListView />
          ) : (
            <NewUpdateForm setSelectedView={setSelectedView} />
          )}
        </div>
      </motion.div>
    </div>
  )
}

const NewUpdateForm = ({ setSelectedView }: { setSelectedView: (view: string) => void }) => {
  const org = useOrg() as any
  const course = useCourse() as any
  const session = useLHSession() as any

  const formik = useFormik({
    initialValues: {
      title: '',
      content: ''
    },
    validate: (values) => {
      const errors: any = {}
      if (!values.title) errors.title = 'Title is required'
      if (!values.content) errors.content = 'Content is required'
      return errors
    },
    onSubmit: async (values) => {
      const body = {
        title: values.title,
        content: values.content,
        course_uuid: course.courseStructure.course_uuid,
        org_id: org.id
      }
      const res = await createCourseUpdate(body, session.data?.tokens?.access_token)
      if (res.status === 200) {
        toast.success('Update added successfully')
        setSelectedView('list')
        mutate(`${getAPIUrl()}courses/${course?.courseStructure.course_uuid}/updates`)
      } else {
        toast.error('Failed to add update')
      }
    }
  })

  return (
    <div className="space-y-4">
      <FormLayout onSubmit={formik.handleSubmit} className="space-y-4">
        <FormField name="title">
          <FormLabelAndMessage
            label="Update Title"
            message={formik.errors.title}
          />
          <Form.Control asChild>
            <Input
              onChange={formik.handleChange}
              value={formik.values.title}
              type="text"
              required
              placeholder="What's new in this update?"
              className="bg-white border-neutral-200 focus:border-neutral-300 focus:ring-neutral-200"
            />
          </Form.Control>
        </FormField>
        <FormField name="content">
          <FormLabelAndMessage
            label="Update Content"
            message={formik.errors.content}
          />
          <Form.Control asChild>
            <Textarea
              onChange={formik.handleChange}
              value={formik.values.content}
              required
              placeholder="Share the details of your update..."
              className="bg-white h-[120px] border-neutral-200 focus:border-neutral-300 focus:ring-neutral-200 resize-none"
            />
          </Form.Control>
        </FormField>
        <div className="flex justify-end space-x-2 pt-2">
          <button
            type="submit"
            className="px-4 py-1.5 bg-neutral-900 hover:bg-black text-white text-xs font-medium rounded-full transition-colors duration-150"
          >
            Publish Update
          </button>
        </div>
      </FormLayout>
    </div>
  )
}

const UpdatesListView = () => {
  const course = useCourse() as any
  const adminStatus = useAdminStatus()
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token
  const { data: updates } = useSWR(
    `${getAPIUrl()}courses/${course?.courseStructure?.course_uuid}/updates`,
    (url) => swrFetcher(url, access_token)
  )

  if (!updates || updates.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center py-8 px-4 text-center bg-neutral-50/50 rounded-lg border border-dashed border-neutral-200">
        <TentTree size={28} className="text-neutral-400 mb-2" />
        <p className="text-sm text-neutral-600 font-medium">No updates yet</p>
        <p className="text-xs text-neutral-400 mt-1">Updates about this course will appear here</p>
      </div>
    )
  }

  return (
    <div className="space-y-4">
      {updates.map((update: any) => (
        <motion.div
          key={update.id}
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ duration: 0.2 }}
          className="group p-3 rounded-lg bg-neutral-50/50 hover:bg-neutral-100/80 transition-colors duration-150"
        >
          <div className="flex items-start justify-between">
            <div className="space-y-1 min-w-0 flex-1">
              <div className="flex items-baseline space-x-2">
                <h4 className="text-sm font-medium text-neutral-800 truncate">{update.title}</h4>
                <span
                  title={dayjs(update.creation_date).format('MMMM D, YYYY')}
                  className="text-[11px] font-medium text-neutral-400 whitespace-nowrap"
                >
                  {dayjs(update.creation_date).fromNow()}
                </span>
              </div>
              <p className="text-sm text-neutral-600 line-clamp-3">{update.content}</p>
            </div>
            {adminStatus.isAdmin && !adminStatus.loading && (
              <div className="ml-4 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                <DeleteUpdateButton update={update} />
              </div>
            )}
          </div>
        </motion.div>
      ))}
    </div>
  )
}

const DeleteUpdateButton = ({ update }: any) => {
  const session = useLHSession() as any
  const course = useCourse() as any

  const handleDelete = async () => {
    const toast_loading = toast.loading('Deleting update...')
    const res = await deleteCourseUpdate(
      course.courseStructure.course_uuid,
      update.courseupdate_uuid,
      session.data?.tokens?.access_token
    )
    
    if (res.status === 200) {
      toast.dismiss(toast_loading)
      toast.success('Update deleted successfully')
      mutate(`${getAPIUrl()}courses/${course?.courseStructure.course_uuid}/updates`)
    } else {
      toast.error('Failed to delete update')
    }
  }

  return (
    <ConfirmationModal
      confirmationButtonText="Delete Update"
      confirmationMessage="Are you sure you want to delete this update?"
      dialogTitle="Delete Update?"
      buttonid="delete-update-button"
      dialogTrigger={
        <button
          id="delete-update-button"
          className="p-1.5 text-neutral-400 hover:text-rose-500 rounded-full hover:bg-rose-50 transition-all duration-150"
        >
          <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        </button>
      }
      functionToExecute={handleDelete}
      status="warning"
    />
  )
}

const CourseAuthors = ({ authors }: CourseAuthorsProps) => {
  const isMobile = useMediaQuery('(max-width: 768px)')

  // Filter active authors and sort by role priority
  const sortedAuthors = [...authors]
    .filter(author => author.authorship_status === 'ACTIVE')
    .sort((a, b) => {
      const rolePriority: Record<string, number> = {
        'CREATOR': 0,
        'MAINTAINER': 1,
        'CONTRIBUTOR': 2,
        'REPORTER': 3
      };
      return rolePriority[a.authorship] - rolePriority[b.authorship];
    });

  return (
    <div className="antialiased">
      <MultipleAuthors authors={sortedAuthors} isMobile={isMobile} />
      <UpdatesSection />
    </div>
  )
}

export default CourseAuthors 


================================================
FILE: apps/web/components/Objects/Courses/CourseProgress/CourseProgress.tsx
================================================
import React, { useState, useEffect } from 'react'
import { Check, Square, ArrowRight, Folder, FileText, Video, Layers, BookOpenCheck } from 'lucide-react'
import { getUriWithOrg } from '@services/config/config'
import Link from 'next/link'
import Modal from '@components/Objects/StyledElements/Modal/Modal'

interface CourseProgressProps {
  course: any
  orgslug: string
  isOpen: boolean
  onClose: () => void
  trailData: any
}

const CourseProgress: React.FC<CourseProgressProps> = ({ course, orgslug, isOpen, onClose, trailData }) => {
  const [completedActivities, setCompletedActivities] = useState(0)
  const [totalActivities, setTotalActivities] = useState(0)

  useEffect(() => {
    let total = 0
    let completed = 0

    course.chapters.forEach((chapter: any) => {
      chapter.activities.forEach((activity: any) => {
        total++
        if (isActivityDone(activity)) {
          completed++
        }
      })
    })

    setTotalActivities(total)
    setCompletedActivities(completed)
  }, [course])

  const isActivityDone = (activity: any) => {
    const cleanCourseUuid = course.course_uuid?.replace('course_', '');
    const run = trailData?.runs?.find(
      (run: any) => {
        const cleanRunCourseUuid = run.course?.course_uuid?.replace('course_', '');
        return cleanRunCourseUuid === cleanCourseUuid;
      }
    );
    if (run) {
      return run.steps.find((step: any) => step.activity_id === activity.id)
    }
    return false
  }

  const getActivityTypeIcon = (activityType: string) => {
    switch (activityType) {
      case 'TYPE_VIDEO':
        return <Video size={16} className="text-gray-400" />
      case 'TYPE_DOCUMENT':
        return <FileText size={16} className="text-gray-400" />
      case 'TYPE_DYNAMIC':
        return <Layers size={16} className="text-gray-400" />
      case 'TYPE_ASSIGNMENT':
        return <BookOpenCheck size={16} className="text-gray-400" />
      default:
        return <FileText size={16} className="text-gray-400" />
    }
  }

  const progressPercentage = totalActivities > 0 ? (completedActivities / totalActivities) * 100 : 0
  const radius = 40
  const circumference = 2 * Math.PI * radius
  const strokeDashoffset = circumference - (progressPercentage / 100) * circumference

  const dialogContent = (
    <div className="space-y-4">
      {course.chapters.map((chapter: any) => (
        <div key={chapter.chapter_uuid} className="bg-gray-50 rounded-lg overflow-hidden">
          <div className="px-4 py-3 bg-gray-100 font-semibold text-gray-700 flex items-center space-x-2">
            <Folder size={16} className="text-gray-400" />
            <span>{chapter.name}</span>
          </div>
          <div className="divide-y divide-gray-100">
            {chapter.activities.map((activity: any) => {
              const activityId = activity.activity_uuid.replace('activity_', '')
              const courseId = course.course_uuid.replace('course_', '')
              return (
                <Link
                  key={activity.activity_uuid}
                  href={getUriWithOrg(orgslug, '') + `/course/${courseId}/activity/${activityId}`}
                >
                  <div className="px-4 py-3 hover:bg-gray-100 transition-colors flex items-center group">
                    <div className="flex items-center space-x-3 flex-1">
                      {isActivityDone(activity) ? (
                        <div className="relative">
                          <Square size={18} className="stroke-[2] text-teal-600" />
                          <Check size={18} className="stroke-[2.5] text-teal-600 absolute top-0 left-0" />
                        </div>
                      ) : (
                        <Square size={18} className="stroke-[2] text-gray-300" />
                      )}
                      <div className="flex items-center space-x-2">
                        {getActivityTypeIcon(activity.activity_type)}
                        <span className="text-gray-700 group-hover:text-gray-900">
                          {activity.name}
                        </span>
                      </div>
                    </div>
                    <ArrowRight size={16} className="text-gray-400 group-hover:text-gray-600" />
                  </div>
                </Link>
              )
            })}
          </div>
        </div>
      ))}
    </div>
  )

  return (
    <Modal
      isDialogOpen={isOpen}
      onOpenChange={onClose}
      dialogContent={dialogContent}
      dialogTitle="Course Progress"
      dialogDescription={`${completedActivities} of ${totalActivities} activities completed`}
      minWidth="md"
    />
  )
}

export default CourseProgress 


================================================
FILE: apps/web/components/Objects/Courses/CourseUpdates/CourseUpdates.tsx
================================================
import { PencilLine, Rss, TentTree } from 'lucide-react'
import React, { useEffect } from 'react'
import { motion } from 'framer-motion'
import { useFormik } from 'formik'
import * as Form from '@radix-ui/react-form'
import FormLayout, {
  FormField,
  FormLabelAndMessage,
  Input,
  Textarea,
} from '@components/Objects/StyledElements/Form/Form'
import { useCourse } from '@components/Contexts/CourseContext'
import useSWR, { mutate } from 'swr'
import { getAPIUrl } from '@services/config/config'
import { swrFetcher } from '@services/utils/ts/requests'
import useAdminStatus from '@components/Hooks/useAdminStatus'
import { useOrg } from '@components/Contexts/OrgContext'
import { createCourseUpdate, deleteCourseUpdate } from '@services/courses/updates'
import toast from 'react-hot-toast'
import ConfirmationModal from '@components/Objects/StyledElements/ConfirmationModal/ConfirmationModal'
import dayjs from 'dayjs';
import relativeTime from 'dayjs/plugin/relativeTime';
import { useLHSession } from '@components/Contexts/LHSessionContext'

dayjs.extend(relativeTime);

function CourseUpdates() {
  const course = useCourse() as any;
  const session = useLHSession() as any;
  const access_token = session?.data?.tokens?.access_token;
  const { data: updates } = useSWR(`${getAPIUrl()}courses/${course?.courseStructure.course_uuid}/updates`, (url) => swrFetcher(url, access_token))
  const [isModelOpen, setIsModelOpen] = React.useState(false)

  function handleModelOpen() {
    setIsModelOpen(!isModelOpen)
  }

  // if user clicks outside the model, close the model
  React.useLayoutEffect(() => {
    function handleClickOutside(event: any) {
      if (event.target.closest('.bg-white') || event.target.id === 'delete-update-button') return;
      setIsModelOpen(false);
    }
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);


  return (
    <div style={{ position: 'relative' }} className='bg-white hover:bg-neutral-50 transition-all ease-linear nice-shadow rounded-full z-20 px-5 py-1'>
      <div onClick={handleModelOpen} className='flex items-center space-x-2 font-normal hover:cursor-pointer text-gray-600'>
        <div><Rss size={16} /> </div>
        <div className='flex space-x-2 items-center'>
          <span>Updates</span>
          {updates && <span className='text-xs px-2 font-bold py-0.5 rounded-full bg-rose-100 text-rose-900'>{updates.length}</span>}
        </div>
      </div>
      {isModelOpen && <motion.div
        initial={{ opacity: 0, y: -10 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{
          type: 'spring',
          stiffness: 1300,
          damping: 70,
        }}
        style={{ position: 'absolute', top: '130%', right: 0 }}
      >
        <UpdatesSection />
      </motion.div>}
    </div>
  )
}

const UpdatesSection = () => {
  const [selectedView, setSelectedView] = React.useState('list')
  const adminStatus = useAdminStatus() ;
  return (
    <div className='bg-white/95 backdrop-blur-md nice-shadow rounded-lg w-[700px] overflow-hidden'>
      <div className='bg-gray-50/70 flex justify-between outline outline-1 rounded-lg outline-neutral-200/40'>
        <div className='py-2 px-4 font-bold text-gray-500 flex space-x-2 items-center'>
          <Rss size={16} />
          <span>Updates</span>

        </div>
        {adminStatus.isAdmin && <div
          onClick={() => setSelectedView('new')}
          className='py-2 px-4 space-x-2 items-center flex cursor-pointer text-xs font-medium hover:bg-gray-200 bg-gray-100 outline outline-1  outline-neutral-200/40'>
          <PencilLine size={14} />
          <span>New Update</span>
        </div>}
      </div>
      <div className=''>
        {selectedView === 'list' && <UpdatesListView />}
        {selectedView === 'new' && <NewUpdateForm setSelectedView={setSelectedView} />}
      </div>
    </div>
  )
}

const NewUpdateForm = ({ setSelectedView }: any) => {
  const org = useOrg() as any;
  const course = useCourse() as any;
  const session = useLHSession() as any;

  const validate = (values: any) => {
    const errors: any = {}

    if (!values.title) {
      errors.title = 'Title is required'
    }
    if (!values.content) {
      errors.content = 'Content is required'
    }

    return errors
  }
  const formik = useFormik({
    initialValues: {
      title: '',
      content: ''
    },
    validate,
    onSubmit: async (values) => {
      const body = {
        title: values.title,
        content: values.content,
        course_uuid: course.courseStructure.course_uuid,
        org_id: org.id
      }
      const res = await createCourseUpdate(body, session.data?.tokens?.access_token)
      if (res.status === 200) {
        toast.success('Update added successfully')
        setSelectedView('list')
        mutate(`${getAPIUrl()}courses/${course?.courseStructure.course_uuid}/updates`)
      }
      else {
        toast.error('Failed to add update')
      }
    },
    enableReinitialize: true,
  })

  useEffect(() => {

  }
    , [course, org])


  return (
    <div className='bg-white/95 backdrop-blur-md nice-shadow rounded-lg w-[700px] overflow-hidden flex flex-col -space-y-2'>
      <div className='flex flex-col -space-y-2 px-4 pt-4'>
        <div className='text-gray-500 px-3 py-0.5 rounded-full font-semibold text-xs'>Test Course </div>
        <div className='text-black px-3 py-0.5 rounded-full text-lg font-bold'>Add new Course Update</div>
      </div>
      <div className='px-5 -py-2'>
        <FormLayout onSubmit={formik.handleSubmit}>
          <FormField name="title">
            <FormLabelAndMessage
              label="Title"
              message={formik.errors.title}
            />
            <Form.Control asChild>
              <Input
                style={{ backgroundColor: 'white' }}
                onChange={formik.handleChange}
                value={formik.values.title}
                type="text"
                required
              />
            </Form.Control>
          </FormField>
          <FormField name="content">
            <FormLabelAndMessage
              label="Content"
              message={formik.errors.content}
            />
            <Form.Control asChild>
              <Textarea
                style={{ backgroundColor: 'white', height: '100px' }}
                onChange={formik.handleChange}
                value={formik.values.content}
                required
              />
            </Form.Control>
          </FormField>
          <div className='flex justify-end py-2'>
            <button onClick={() => setSelectedView('list')} className='text-gray-500 px-4 py-2 rounded-md text-sm font-bold antialiased'>Cancel</button>
            <button className='bg-black  text-white px-4 py-2 rounded-md text-sm font-bold antialiased'>Add Update</button>
          </div>
        </FormLayout>
      </div>
    </div>
  )
}

const UpdatesListView = () => {
  const course = useCourse() as any;
  const adminStatus = useAdminStatus() ;
  const session = useLHSession() as any;
  const access_token = session?.data?.tokens?.access_token;
  const { data: updates } = useSWR(`${getAPIUrl()}courses/${course?.courseStructure?.course_uuid}/updates`, (url) => swrFetcher(url, access_token))

  return (
    <div className='px-5 bg-white overflow-y-auto' style={{ maxHeight: '400px' }}>
      {updates && !adminStatus.loading && updates.map((update: any) => (
        <div key={update.id} className='py-2 border-b border-neutral-200 antialiased'>
          <div className='font-bold text-gray-500 flex space-x-2 items-center justify-between '>
            <div className='flex space-x-2 items-center'>
              <span> {update.title}</span>
              <span
                title={"Created at " + dayjs(update.creation_date).format('MMMM D, YYYY')}
                className='text-xs font-semibold text-gray-300'>
                {dayjs(update.creation_date).fromNow()}
              </span>
            </div>
            {adminStatus.isAdmin &&  !adminStatus.loading && <DeleteUpdateButton update={update} />}</div>
          <div className='text-gray-600'>{update.content}</div>
        </div>
      ))}
      {(!updates || updates.length === 0) &&
        <div className='text-gray-500 text-center my-10 py-2 flex flex-col space-y-2'>
          <TentTree className='mx-auto' size={40} />
          <p>No updates yet</p>
        </div>
      }
    </div>
  )
}

const DeleteUpdateButton = ({ update }: any) => {
  const session = useLHSession() as any;
  const course = useCourse() as any;
  const org = useOrg() as any;

  const handleDelete = async () => {
    const res = await deleteCourseUpdate(course.courseStructure.course_uuid, update.courseupdate_uuid, session.data?.tokens?.access_token)
    const toast_loading = toast.loading('Deleting update...')
    if (res.status === 200) {
      toast.dismiss(toast_loading)
      toast.success('Update deleted successfully')
      mutate(`${getAPIUrl()}courses/${course?.courseStructure.course_uuid}/updates`)
    }
    else {
      toast.error('Failed to delete update')
    }
  }

  return (
    <ConfirmationModal
      confirmationButtonText="Delete Update"
      confirmationMessage="Are you sure you want to delete this update?"
      dialogTitle={'Delete Update ?'}
      buttonid='delete-update-button'
      dialogTrigger={
        <div id='delete-update-button' className='text-rose-600 text-xs bg-rose-100 rounded-full px-2 py-0.5 hover:cursor-pointer'>
          Delete
        </div>
      }
      functionToExecute={() => {
        handleDelete()
      }}
      status="warning"
    ></ConfirmationModal>
  )
}


export default CourseUpdates


================================================
FILE: apps/web/components/Objects/Editor/Editor.tsx
================================================
'use client'
import React from 'react'
import { useEditor, EditorContent } from '@tiptap/react'
import StarterKit from '@tiptap/starter-kit'
import learnhouseIcon from 'public/learnhouse_icon.png'
import { ToolbarButtons } from './Toolbar/ToolbarButtons'
import { motion } from 'framer-motion'
import Image from 'next/image'
import styled from 'styled-components'
import { DividerVerticalIcon, SlashIcon } from '@radix-ui/react-icons'
import learnhouseAI_icon from 'public/learnhouse_ai_simple.png'
import {
  AIEditorStateTypes,
  useAIEditor,
  useAIEditorDispatch,
} from '@components/Contexts/AI/AIEditorContext'

// Extensions
import InfoCallout from './Extensions/Callout/Info/InfoCallout'
import WarningCallout from './Extensions/Callout/Warning/WarningCallout'
import ImageBlock from './Extensions/Image/ImageBlock'
import Youtube from '@tiptap/extension-youtube'
import VideoBlock from './Extensions/Video/VideoBlock'
import { Eye, Monitor } from 'lucide-react'
import MathEquationBlock from './Extensions/MathEquation/MathEquationBlock'
import PDFBlock from './Extensions/PDF/PDFBlock'
import QuizBlock from './Extensions/Quiz/QuizBlock'
import { Table } from '@tiptap/extension-table'
import TableCell from '@tiptap/extension-table-cell'
import TableHeader from '@tiptap/extension-table-header'
import TableRow from '@tiptap/extension-table-row'
import ToolTip from '@components/Objects/StyledElements/Tooltip/Tooltip'
import Link from 'next/link'
import { getCourseThumbnailMediaDirectory } from '@services/media/media'
import { getLinkExtension } from './EditorConf'
import WebPreview from './Extensions/WebPreview/WebPreview'

// Lowlight
import { common, createLowlight } from 'lowlight'
const lowlight = createLowlight(common)
import CodeBlockLowlight from '@tiptap/extension-code-block-lowlight'
import css from 'highlight.js/lib/languages/css'
import js from 'highlight.js/lib/languages/javascript'
import ts from 'highlight.js/lib/languages/typescript'
import html from 'highlight.js/lib/languages/xml'
import python from 'highlight.js/lib/languages/python'
import java from 'highlight.js/lib/languages/java'
import { CourseProvider } from '@components/Contexts/CourseContext'
import AIEditorToolkit from './AI/AIEditorToolkit'
import useGetAIFeatures from '@components/Hooks/useGetAIFeatures'
import { getUriWithOrg } from '@services/config/config'
import EmbedObjects from './Extensions/EmbedObjects/EmbedObjects'
import Badges from './Extensions/Badges/Badges'
import Buttons from './Extensions/Buttons/Buttons'
import Flipcard from './Extensions/Flipcard/Flipcard'
import Scenarios from './Extensions/Scenarios/Scenarios'
import { useMediaQuery } from 'usehooks-ts'
import UserAvatar from '../UserAvatar'
import UserBlock from './Extensions/Users/UserBlock'

interface Editor {
  content: string
  activity: any
  course: any
  org: any
  session: any
  setContent: (content: any) => void
}

function Editor(props: Editor) {
  const dispatchAIEditor = useAIEditorDispatch() as any
  const aiEditorState = useAIEditor() as AIEditorStateTypes
  const is_ai_feature_enabled = useGetAIFeatures({ feature: 'editor' })
  const [isButtonAvailable, setIsButtonAvailable] = React.useState(false)


  React.useEffect(() => {
    if (is_ai_feature_enabled) {
      setIsButtonAvailable(true)
    }

  }, [is_ai_feature_enabled])

  // remove course_ from course_uuid
  const course_uuid = props.course.course_uuid.substring(7)

  // remove activity_ from activity_uuid
  const activity_uuid = props.activity.activity_uuid.substring(9)

  // Code Block Languages for Lowlight
  lowlight.register('html', html)
  lowlight.register('css', css)
  lowlight.register('js', js)
  lowlight.register('ts', ts)
  lowlight.register('python', python)
  lowlight.register('java', java)

  const editor: any = useEditor({
    editable: true,
    extensions: [
      StarterKit.configure({
        bulletList: {
          HTMLAttributes: {
            class: 'bullet-list',
          },
        },
        orderedList: {
          HTMLAttributes: {
            class: 'ordered-list',
          },
        },
      }),
      InfoCallout.configure({
        editable: true,
      }),
      WarningCallout.configure({
        editable: true,
      }),
      ImageBlock.configure({
        editable: true,
        activity: props.activity,
      }),
      VideoBlock.configure({
        editable: true,
        activity: props.activity,
      }),
      MathEquationBlock.configure({
        editable: true,
        activity: props.activity,
      }),
      PDFBlock.configure({
        editable: true,
        activity: props.activity,
      }),
      QuizBlock.configure({
        editable: true,
        activity: props.activity,
      }),
      Youtube.configure({
        controls: true,
        modestBranding: true,
      }),
      CodeBlockLowlight.configure({
        lowlight,
      }),
      EmbedObjects.configure({
        editable: true,
        activity: props.activity,
      }),
      Badges.configure({
        editable: true,
        activity: props.activity,
      }),
      Buttons.configure({
        editable: true,
        activity: props.activity,
      }),
      UserBlock.configure({
        editable: true,
        activity: props.activity,
      }),
      Table.configure({
        resizable: true,
      }),
      TableRow,
      TableHeader,
      TableCell,
      getLinkExtension(),
      WebPreview.configure({
        editable: true,
        activity: props.activity,
      }),
      Flipcard.configure({
        editable: true,
        activity: props.activity,
      }),
      Scenarios.configure({
        editable: true,
        activity: props.activity,
      }),
    ],
    content: props.content,
    immediatelyRender: false,
  })


  const isMobile = useMediaQuery('(max-width: 767px)')
  if (isMobile) {
    // TODO: Work on a better editor mobile experience
    return (
      <div className="h-screen w-full bg-[#f8f8f8] flex items-center justify-center p-4">
        <div className="bg-white p-6 rounded-lg shadow-md text-center">
          <h2 className="text-xl font-bold mb-4">Desktop Only</h2>
          <Monitor className='mx-auto my-5' size={60} />
          <p>The editor is only accessible from a desktop device.</p>
          <p>Please switch to a desktop to view.</p>
        </div>
      </div>
    )
  }

  return (
    <Page>
      <CourseProvider courseuuid={props.course.course_uuid}>
        <motion.div
          initial={{ opacity: 0, scale: 0.98 }}
          animate={{ opacity: 1, scale: 1 }}
          key="modal"
          transition={{
            type: 'spring',
            stiffness: 360,
            damping: 70,
            delay: 0.02,
          }}
          exit={{ opacity: 0 }}
        >
          <EditorTop className="fixed bg-white bg-opacity-95 backdrop-blur-sm backdrop-brightness-125">
            <EditorDocSection>
              <EditorInfoWrapper>
                <Link href="/">
                  <EditorInfoLearnHouseLogo
                    width={25}
                    height={25}
                    src={learnhouseIcon}
                    alt=""
                  />
                </Link>
                <Link target="_blank" href={`/course/${course_uuid}`}>
                  <EditorInfoThumbnail
                    src={`${props.course.thumbnail_image ? getCourseThumbnailMediaDirectory(
                      props.org?.org_uuid,
                      props.course.course_uuid,
                      props.course.thumbnail_image
                    ) : getUriWithOrg(props.org?.slug, '/empty_thumbnail.png')}`}
                    alt=""
                  ></EditorInfoThumbnail>
                </Link>
                <EditorInfoDocName>
                  {' '}
                  <b>{props.course.name}</b> <SlashIcon /> {props.activity.name}{' '}
                </EditorInfoDocName>
              </EditorInfoWrapper>
              <EditorButtonsWrapper>
                <ToolbarButtons editor={editor} />
              </EditorButtonsWrapper>
            </EditorDocSection>
            <EditorUsersSection className="space-x-2">
              <div>
                <div className="transition-all ease-linear text-teal-100 rounded-md hover:cursor-pointer">
                  {isButtonAvailable && (
                    <div
                      onClick={() =>
                        dispatchAIEditor({
                          type: aiEditorState.isModalOpen
                            ? 'setIsModalClose'
                            : 'setIsModalOpen',
                        })
                      }
                      style={{
                        background:
                          'conic-gradient(from 32deg at 53.75% 50%, rgb(35, 40, 93) 4deg, rgba(20, 0, 52, 0.95) 59deg, rgba(164, 45, 238, 0.88) 281deg)',
                      }}
                      className="rounded-md px-3 py-2 drop-shadow-md flex  items-center space-x-1.5 text-sm text-white hover:cursor-pointer transition delay-150 duration-300 ease-in-out hover:scale-105"
                    >
                      {' '}
                      <i>
                        <Image
                          className=""
                          width={20}
                          src={learnhouseAI_icon}
                          alt=""
                        />
                      </i>{' '}
                      <i className="not-italic text-xs font-bold">AI Editor</i>
                    </div>
                  )}
                </div>
              </div>
              <DividerVerticalIcon
                style={{
                  marginTop: 'auto',
                  marginBottom: 'auto',
                  color: 'grey',
                  opacity: '0.5',
                }}
              />
              <EditorLeftOptionsSection className="space-x-2 ">
                <div
                  className="bg-sky-600 hover:bg-sky-700 transition-all ease-linear px-3 py-2 font-black text-sm shadow-sm text-teal-100 rounded-lg hover:cursor-pointer"
                  onClick={() => props.setContent(editor.getJSON())}
                >
                  {' '}
                  Save{' '}
                </div>
                <ToolTip content="Preview">
                  <Link
                    target="_blank"
                    href={`/course/${course_uuid}/activity/${activity_uuid}`}
                  >
                    <div className="flex bg-neutral-600 hover:bg-neutral-700 transition-all ease-linear h-9 px-3 py-2 font-black justify-center items-center text-sm shadow-sm text-neutral-100 rounded-lg hover:cursor-pointer">
                      <Eye className="mx-auto items-center" size={15} />
                    </div>
                  </Link>
                </ToolTip>
              </EditorLeftOptionsSection>
              <DividerVerticalIcon
                style={{
                  marginTop: 'auto',
                  marginBottom: 'auto',
                  color: 'grey',
                  opacity: '0.5',
                }}
              />

              <EditorUserProfileWrapper>
                <UserAvatar border="border-4" use_with_session={true} width={45} />
              </EditorUserProfileWrapper>
            </EditorUsersSection>
          </EditorTop>
        </motion.div>
        <motion.div
          initial={{ opacity: 0, scale: 0.99 }}
          animate={{ opacity: 1, scale: 1 }}
          transition={{
            type: 'spring',
            stiffness: 360,
            damping: 70,
            delay: 0.5,
          }}
          exit={{ opacity: 0 }}
        >
          <EditorContentWrapper>
            <AIEditorToolkit activity={props.activity} editor={editor} />
            <EditorContent editor={editor} />
          </EditorContentWrapper>
        </motion.div>
      </CourseProvider>
    </Page>
  )
}

const Page = styled.div`
  height: 100vh;
  width: 100%;
  padding-top: 30px;

  // dots background
  background-image: radial-gradient(#4744446b 1px, transparent 1px),
    radial-gradient(#4744446b 1px, transparent 1px);
  background-position:
    0 0,
    25px 25px;
  background-size: 50px 50px;
  background-attachment: fixed;
  background-repeat: repeat;
`

const EditorTop = styled.div`
  border-radius: 15px;
  margin: 40px;
  margin-top: 0px;
  margin-bottom: 20px;
  padding: 10px;
  display: flex;
  justify-content: space-between;
  box-shadow: 0px 4px 16px rgba(0, 0, 0, 0.03);
  position: fixed;
  z-index: 303;
  width: -webkit-fill-available;
  width: -moz-available;
`

// Inside EditorTop
const EditorDocSection = styled.div`
  display: flex;
  flex-direction: column;
`
const EditorUsersSection = styled.div`
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
`

const EditorLeftOptionsSection = styled.div`
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
`

// Inside EditorDocSection
const EditorInfoWrapper = styled.div`
  display: flex;
  flex-direction: row;
  margin-bottom: 5px;
`
const EditorButtonsWrapper = styled.div``

// Inside EditorUsersSection
const EditorUserProfileWrapper = styled.div`
  padding-right: 8px;
  svg {
    border-radius: 7px;
  }
`

// Inside EditorInfoWrapper
//..todo
const EditorInfoLearnHouseLogo = styled(Image)`
  border-radius: 6px;
  margin-right: 0px;
`
const EditorInfoDocName = styled.div`
  font-size: 16px;
  justify-content: center;
  align-items: center;
  display: flex;
  margin-left: 10px;
  color: #494949;

  svg {
    margin-left: 4px;
    margin-right: 4px;
    padding: 3px;
    color: #353535;
  }
`

const EditorInfoThumbnail = styled.img`
  height: 25px;
  width: 56px;
  object-fit: cover;
  object-position: top;
  border-radius: 7px;
  margin-left: 5px;

  &:hover {
    cursor: pointer;
  }
`

export const EditorContentWrapper = styled.div`
  margin: 40px;
  margin-top: 90px;
  background-color: white;
  border-radius: 10px;
  z-index: 300;
  box-shadow: 0px 4px 16px rgba(0, 0, 0, 0.03);

  // disable chrome outline

  .ProseMirror {
    h1 {
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 24px;
    }

    h2 {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 24px;
    }

    h3 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 24px;
    }

    h4 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 24px;
    }

    h5 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 24px;
    }

    // Link styling
    a {
      color: #2563eb;
      text-decoration: underline;
      cursor: pointer;
      transition: color 0.2s ease;

      &:hover {
        color: #1d4ed8;
        text-decoration: none;
      }
    }

    padding-left: 20px;
    padding-right: 20px;
    padding-bottom: 20px;
    padding-top: 20px;

    &:focus {
      outline: none !important;
      outline-style: none !important;
      box-shadow: none !important;
    }

    // Code Block
    pre {
      background: #0d0d0d;
      border-radius: 0.5rem;
      color: #fff;
      font-family: 'JetBrainsMono', monospace;
      padding: 0.75rem 1rem;

      code {
        background: none;
        color: inherit;
        font-size: 0.8rem;
        padding: 0;
      }

      .hljs-comment,
      .hljs-quote {
        color: #616161;
      }

      .hljs-variable,
      .hljs-template-variable,
      .hljs-attribute,
      .hljs-tag,
      .hljs-name,
      .hljs-regexp,
      .hljs-link,
      .hljs-name,
      .hljs-selector-id,
      .hljs-selector-class {
        color: #f98181;
      }

      .hljs-number,
      .hljs-meta,
      .hljs-built_in,
      .hljs-builtin-name,
      .hljs-literal,
      .hljs-type,
      .hljs-params {
        color: #fbbc88;
      }

      .hljs-string,
      .hljs-symbol,
      .hljs-bullet {
        color: #b9f18d;
      }

      .hljs-title,
      .hljs-section {
        color: #faf594;
      }

      .hljs-keyword,
      .hljs-selector-tag {
        color: #70cff8;
      }

      .hljs-emphasis {
        font-style: italic;
      }

      .hljs-strong {
        font-weight: 700;
      }
    }

    &.resize-cursor {
      cursor: ew-resize;
      cursor: col-resize;
    }

    .tableWrapper {
      margin: 1.5rem 0;
      overflow-x: auto;
    }
  }

  iframe {
    border-radius: 6px;
    border: none;
    min-width: 200px;
    width: 100%;
    height: 440px;
    min-height: 200px;
    display: block;
    outline: 0px solid transparent;
  }

  ul,
  ol {
    padding: 0 1rem;
    padding-left: 20px;
  }

  ul {
    list-style-type: disc;
  }

  ol {
    list-style-type: decimal;
  }

  table {
    border-collapse: collapse;
    margin: 0;
    overflow: hidden;
    table-layout: fixed;
    width: 100%;

    td,
    th {
      border: 1px solid rgba(139, 139, 139, 0.4);
      box-sizing: border-box;
      min-width: 1em;
      padding: 6px 8px;
      position: relative;
      vertical-align: top;

      > * {
        margin-bottom: 0;
      }
    }

    th {
      background-color: rgba(217, 217, 217, 0.4);
      font-weight: bold;
      text-align: left;
    }

    .selectedCell:after {
      background: rgba(139, 139, 139, 0.2);
      content: "";
      left: 0; right: 0; top: 0; bottom: 0;
      pointer-events: none;
      position: absolute;
      z-index: 2;
    }

    .column-resize-handle {
      background-color: #8d78eb;
      bottom: -2px;
      pointer-events: none;
      position: absolute;
      right: -2px;
      top: 0;
      width: 4px;
    }
  }
`

export default Editor



================================================
FILE: apps/web/components/Objects/Editor/EditorConf.ts
================================================
import { Link as LinkExtension } from '@tiptap/extension-link'

export const getLinkExtension = () => {
  return LinkExtension.configure({
    openOnClick: true,
    HTMLAttributes: {
      target: '_blank',
      rel: 'noopener noreferrer',
    },
    autolink: true,
    defaultProtocol: 'https',
    protocols: ['http', 'https'],
    isAllowedUri: (url: string, ctx: any) => {
      try {
        // construct URL
        const parsedUrl = url.includes(':') ? new URL(url) : new URL(`${ctx.defaultProtocol}://${url}`)

        // use default validation
        if (!ctx.defaultValidate(parsedUrl.href)) {
          return false
        }

        // disallowed protocols
        const disallowedProtocols = ['ftp', 'file', 'mailto']
        const protocol = parsedUrl.protocol.replace(':', '')

        if (disallowedProtocols.includes(protocol)) {
          return false
        }

        // only allow protocols specified in ctx.protocols
        const allowedProtocols = ctx.protocols.map((p: any) => (typeof p === 'string' ? p : p.scheme))

        if (!allowedProtocols.includes(protocol)) {
          return false
        }

        // all checks have passed
        return true
      } catch {
        return false
      }
    },
    shouldAutoLink: (url: string) => {
      try {
        // construct URL
        const parsedUrl = url.includes(':') ? new URL(url) : new URL(`https://${url}`)

        // only auto-link if the domain is not in the disallowed list
        const disallowedDomains = ['example-no-autolink.com', 'another-no-autolink.com']
        const domain = parsedUrl.hostname

        return !disallowedDomains.includes(domain)
      } catch {
        return false
      }
    },
  })
} 


================================================
FILE: apps/web/components/Objects/Editor/EditorWrapper.tsx
================================================
'use client'
import { default as React, type JSX } from 'react';
import Editor from './Editor'
import { updateActivity } from '@services/courses/activities'
import { toast } from 'react-hot-toast'
import Toast from '@components/Objects/StyledElements/Toast/Toast'
import { OrgProvider } from '@components/Contexts/OrgContext'
import { useLHSession } from '@components/Contexts/LHSessionContext'

interface EditorWrapperProps {
  content: string
  activity: any
  course: any
  org: any
}

function EditorWrapper(props: EditorWrapperProps): JSX.Element {
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token;

  async function setContent(content: any) {
    let activity = props.activity
    activity.content = content

    toast.promise(
      updateActivity(activity, activity.activity_uuid, access_token).then(res => {
        if (!res.success) {
          throw res;
        }
        return res;
      }),
      {
        loading: 'Saving...',
        success: () => <b>Activity saved!</b>,
        error: (err) => {
          const errorMessage = err?.data?.detail || err?.data?.message || `Error ${err?.status}: Could not save`;
          return <b>{errorMessage}</b>;
        },
      }
    )
  }


  {
    return (
      <>
        <Toast></Toast>
        <OrgProvider orgslug={props.org.slug}>
          {!session.isLoading && (<Editor
            org={props.org}
            course={props.course}
            activity={props.activity}
            content={props.content}
            setContent={setContent}
            session={session}
          ></Editor>)}
        </OrgProvider>
      </>
    )
  }
}



export default EditorWrapper


================================================
FILE: apps/web/components/Objects/Editor/FileUploadBlock.tsx
================================================
import { Loader } from 'lucide-react'
import { UploadIcon } from '@radix-ui/react-icons'
import React, {
  ButtonHTMLAttributes,
  HTMLAttributes,
  InputHTMLAttributes,
} from 'react'
import { cn } from '@/lib/utils'

const FileUploadBlockInput: React.FC<InputHTMLAttributes<HTMLInputElement>> = ({
  onChange,
  className,
  ...props
}) => {
  return (
    <input
      className={cn(
        'p-3 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 hover:file:cursor-pointer file:file:bg-gray-200 cursor-pointer file:text-gray-500',
        className
      )}
      onChange={onChange}
      type="file"
      required
      {...props}
    />
  )
}

const FileUploadBlockButton: React.FC<
  ButtonHTMLAttributes<HTMLButtonElement>
> = ({ onClick, className, ...props }) => {
  return (
    <button
      className={cn(
        'p-2 px-3 bg-gray-200 rounded-lg text-gray-500 enabled:hover:bg-gray-300 transition space-x-2 items-center flex disabled:opacity-50 disabled:cursor-not-allowed',
        className
      )}
      onClick={onClick}
      {...props}
    >
      <UploadIcon />
      <p>Submit</p>
    </button>
  )
}

interface UploadBlockComponentProps extends HTMLAttributes<HTMLDivElement> {
  isLoading: boolean
  isEditable: boolean
  isEmpty: boolean
  Icon: any
  children: React.ReactNode
}

function FileUploadBlock({
  isLoading,
  isEditable,
  isEmpty,
  Icon,
  children,
}: UploadBlockComponentProps) {
  if (isLoading)
    return <Loader className="animate-spin text-gray-200" size={50} />

  if (!isEditable && isEmpty)
    return (
      <div className="flex items-center gap-5">
        {<Icon className="text-gray-200" size={50} />}
        <p>No file available for preview.</p>
      </div>
    )

  return (
    <>
      {<Icon className="text-gray-200" size={50} />}
        {children}
    </>
  )
}

function FileUploadBlockWrapper({
  children,
  isEmpty,
  ...props
}: UploadBlockComponentProps) {
  return (
    isEmpty && (
    <div className="flex items-center justify-center space-x-3 py-7 bg-gray-50 rounded-xl text-gray-900 px-3 border-dashed border-gray-150 border-2 text-sm" contentEditable={false}>
      <FileUploadBlock isEmpty {...props}>{children}</FileUploadBlock>
    </div>
    )
  )
}

export {
  FileUploadBlockWrapper as FileUploadBlock,
  FileUploadBlockInput,
  FileUploadBlockButton,
}



================================================
FILE: apps/web/components/Objects/Editor/AI/AIEditorToolkit.tsx
================================================
import React from 'react'
import learnhouseAI_icon from 'public/learnhouse_ai_simple.png'
import { motion, AnimatePresence } from 'framer-motion'
import Image from 'next/image'
import {
  AlertTriangle,
  BetweenHorizontalStart,
  FastForward,
  Feather,
  FileStack,
  HelpCircle,
  Languages,
  MoreVertical,
  X,
} from 'lucide-react'
import { Editor } from '@tiptap/react'
import {
  AIEditorStateTypes,
  useAIEditor,
  useAIEditorDispatch,
} from '@components/Contexts/AI/AIEditorContext'
import {
  sendActivityAIChatMessage,
  startActivityAIChatSession,
} from '@services/ai/ai'
import useGetAIFeatures from '@components/Hooks/useGetAIFeatures'
import { useLHSession } from '@components/Contexts/LHSessionContext'

type AIEditorToolkitProps = {
  editor: Editor
  activity: any
}

type AIPromptsLabels = {
  label:
  | 'Writer'
  | 'ContinueWriting'
  | 'MakeLonger'
  | 'GenerateQuiz'
  | 'Translate'
  selection: string
}

function AIEditorToolkit(props: AIEditorToolkitProps) {
  const dispatchAIEditor = useAIEditorDispatch() as any
  const aiEditorState = useAIEditor() as AIEditorStateTypes
  const is_ai_feature_enabled = useGetAIFeatures({ feature: 'editor' })
  const [isToolkitAvailable, setIsToolkitAvailable] = React.useState(true)

  React.useEffect(() => {
    if (is_ai_feature_enabled) {
      setIsToolkitAvailable(true)
    }
  }, [is_ai_feature_enabled])

  return (
    <>
      {isToolkitAvailable && (
        <div className="flex space-x-2">
          <AnimatePresence>
            {aiEditorState.isModalOpen && (
              <motion.div
                initial={{ y: 20, opacity: 0.3, filter: 'blur(5px)' }}
                animate={{ y: 0, opacity: 1, filter: 'blur(0px)' }}
                exit={{ y: 50, opacity: 0, filter: 'blur(3px)' }}
                transition={{
                  type: 'spring',
                  bounce: 0.35,
                  duration: 1.7,
                  mass: 0.2,
                  velocity: 2,
                }}
                className="fixed top-0 left-0 w-full h-full z-50 flex justify-center items-center "
                style={{ pointerEvents: 'none' }}
              >
                <>
                  {aiEditorState.isFeedbackModalOpen && (
                    <UserFeedbackModal
                      activity={props.activity}
                      editor={props.editor}
                    />
                  )}
                  <div
                    style={{
                      pointerEvents: 'auto',
                      background:
                        'linear-gradient(0deg, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.2) 100%), radial-gradient(105.16% 105.16% at 50% -5.16%, rgba(255, 255, 255, 0.18) 0%, rgba(0, 0, 0, 0) 100%), rgb(2 1 25 / 98%)',
                    }}
                    className="z-50 rounded-2xl max-w-(--breakpoint-2xl) my-10 mx-auto w-fit fixed bottom-0 left-1/2 transform -translate-x-1/2 shadow-xl ring-1 ring-inset ring-white/10 text-white p-3 flex-col-reverse backdrop-blur-md"
                  >
                    <div className="flex space-x-2">
                      <div className="pr-1">
                        <div className="flex w-full space-x-2 font-bold text-white/80 items-center">
                          <Image
                            className="outline outline-1 outline-neutral-200/20 rounded-lg"
                            width={24}
                            src={learnhouseAI_icon}
                            alt=""
                          />
                          <div className="flex items-center">
                            AI Editor{' '}
                            <span className="text-[10px] px-2 py-1 rounded-3xl ml-3 bg-white/10 uppercase">
                              PRE-ALPHA
                            </span>
                          </div>
                          <MoreVertical className="text-white/50" size={12} />
                        </div>
                      </div>
                      <div className="tools flex space-x-2">
                        <AiEditorToolButton label="Writer" />
                        <AiEditorToolButton label="ContinueWriting" />
                        <AiEditorToolButton label="MakeLonger" />

                        <AiEditorToolButton label="Translate" />
                      </div>
                      <div className="flex space-x-2 items-center">
                        <X
                          onClick={() =>
                            Promise.all([
                              dispatchAIEditor({ type: 'setIsModalClose' }),
                              dispatchAIEditor({
                                type: 'setIsFeedbackModalClose',
                              }),
                            ])
                          }
                          size={20}
                          className="text-white/50 hover:cursor-pointer bg-white/10 p-1 rounded-full items-center"
                        />
                      </div>
                    </div>
                  </div>
                </>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      )}
    </>
  )
}

const UserFeedbackModal = (props: AIEditorToolkitProps) => {
  const dispatchAIEditor = useAIEditorDispatch() as any
  const aiEditorState = useAIEditor() as AIEditorStateTypes
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token;

  const handleChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
    await dispatchAIEditor({
      type: 'setChatInputValue',
      payload: event.currentTarget.value,
    })
  }

  const sendReqWithMessage = async (message: string) => {
    if (aiEditorState.aichat_uuid) {
      await dispatchAIEditor({
        type: 'addMessage',
        payload: { sender: 'user', message: message, type: 'user' },
      })
      await dispatchAIEditor({ type: 'setIsWaitingForResponse' })
      const response = await sendActivityAIChatMessage(
        message,
        aiEditorState.aichat_uuid,
        props.activity.activity_uuid, access_token
      )
      if (response.success === false) {
        await dispatchAIEditor({ type: 'setIsNoLongerWaitingForResponse' })
        await dispatchAIEditor({ type: 'setIsModalClose' })
        // wait for 200ms before opening the modal again
        await new Promise((resolve) => setTimeout(resolve, 200))
        await dispatchAIEditor({
          type: 'setError',
          payload: {
            isError: true,
            status: response.status,
            error_message: response.data.detail,
          },
        })
        await dispatchAIEditor({ type: 'setIsModalOpen' })
        return ''
      }
      await dispatchAIEditor({ type: 'setIsNoLongerWaitingForResponse' })
      await dispatchAIEditor({ type: 'setChatInputValue', payload: '' })
      await dispatchAIEditor({
        type: 'addMessage',
        payload: { sender: 'ai', message: response.data.message, type: 'ai' },
      })
      return response.data.message
    } else {
      await dispatchAIEditor({
        type: 'addMessage',
        payload: { sender: 'user', message: message, type: 'user' },
      })
      await dispatchAIEditor({ type: 'setIsWaitingForResponse' })
      const response = await startActivityAIChatSession(
        message, access_token,
        props.activity.activity_uuid
      )
      if (response.success === false) {
        await dispatchAIEditor({ type: 'setIsNoLongerWaitingForResponse' })
        await dispatchAIEditor({ type: 'setIsModalClose' })
        // wait for 200ms before opening the modal again
        await new Promise((resolve) => setTimeout(resolve, 200))
        await dispatchAIEditor({
          type: 'setError',
          payload: {
            isError: true,
            status: response.status,
            error_message: response.data.detail,
          },
        })
        await dispatchAIEditor({ type: 'setIsModalOpen' })
        return ''
      }
      await dispatchAIEditor({
        type: 'setAichat_uuid',
        payload: response.data.aichat_uuid,
      })
      await dispatchAIEditor({ type: 'setIsNoLongerWaitingForResponse' })
      await dispatchAIEditor({ type: 'setChatInputValue', payload: '' })
      await dispatchAIEditor({
        type: 'addMessage',
        payload: { sender: 'ai', message: response.data.message, type: 'ai' },
      })
      return response.data.message
    }
  }

  const handleKeyPress = async (
    event: React.KeyboardEvent<HTMLInputElement>
  ) => {
    if (event.key === 'Enter') {
      await handleOperation(
        aiEditorState.selectedTool,
        aiEditorState.chatInputValue
      )
    }
  }

  const handleOperation = async (
    label:
      | 'Writer'
      | 'ContinueWriting'
      | 'MakeLonger'
      | 'GenerateQuiz'
      | 'Translate',
    message: string
  ) => {
    // Set selected tool
    await dispatchAIEditor({ type: 'setSelectedTool', payload: label })

    // Check what operation that was
    if (label === 'Writer') {
      let ai_message = ''
      let prompt = getPrompt({ label: label, selection: message })
      await dispatchAIEditor({ type: 'setIsUserInputEnabled', payload: true })
      if (prompt) {
        await dispatchAIEditor({
          type: 'setIsUserInputEnabled',
          payload: false,
        })
        await dispatchAIEditor({ type: 'setIsWaitingForResponse' })
        ai_message = await sendReqWithMessage(prompt)
        await fillEditorWithText(ai_message)
        await dispatchAIEditor({ type: 'setIsNoLongerWaitingForResponse' })
        await dispatchAIEditor({ type: 'setIsUserInputEnabled', payload: true })
      }
    } else if (label === 'ContinueWriting') {
      let ai_message = ''
      let text_selection = getTipTapEditorSelectedTextGlobal()
      let prompt = getPrompt({ label: label, selection: text_selection })
      if (prompt) {
        await dispatchAIEditor({ type: 'setIsWaitingForResponse' })
        ai_message = await sendReqWithMessage(prompt)
        const message_without_original_text = await removeSentences(
          text_selection,
          ai_message
        )
        await fillEditorWithText(message_without_original_text)
        await dispatchAIEditor({ type: 'setIsNoLongerWaitingForResponse' })
      }
    } else if (label === 'MakeLonger') {
      let ai_message = ''
      let text_selection = getTipTapEditorSelectedText()
      let prompt = getPrompt({ label: label, selection: text_selection })
      if (prompt) {
        await dispatchAIEditor({ type: 'setIsWaitingForResponse' })
        ai_message = await sendReqWithMessage(prompt)
        await replaceSelectedTextWithText(ai_message)
        await dispatchAIEditor({ type: 'setIsNoLongerWaitingForResponse' })
      }
    } else if (label === 'GenerateQuiz') {
      // will be implemented in future stages
    } else if (label === 'Translate') {
      let ai_message = ''
      let text_selection = getTipTapEditorSelectedText()
      let prompt = getPrompt({ label: label, selection: text_selection })
      if (prompt) {
        await dispatchAIEditor({ type: 'setIsWaitingForResponse' })
        ai_message = await sendReqWithMessage(prompt)
        await replaceSelectedTextWithText(ai_message)
        await dispatchAIEditor({ type: 'setIsNoLongerWaitingForResponse' })
      }
    }
  }

  const removeSentences = async (
    textToRemove: string,
    originalText: string
  ) => {
    const phrase = textToRemove.toLowerCase()
    const original = originalText.toLowerCase()

    if (original.includes(phrase)) {
      const regex = new RegExp(phrase, 'g')
      const newText = original.replace(regex, '')
      return newText
    } else {
      return originalText
    }
  }

  async function fillEditorWithText(text: string) {
    const words = text.split(' ')

    for (let i = 0; i < words.length; i++) {
      const textNode = {
        type: 'text',
        text: words[i],
      }

      props.editor.chain().focus().insertContent(textNode).run()

      // Add a space after each word except the last one
      if (i < words.length - 1) {
        const spaceNode = {
          type: 'text',
          text: ' ',
        }

        props.editor.chain().focus().insertContent(spaceNode).run()
      }

      // Wait for 0.3 seconds before adding the next word
      await new Promise((resolve) => setTimeout(resolve, 120))
    }
  }

  async function replaceSelectedTextWithText(text: string) {
    const words = text.split(' ')

    // Delete the selected text
    props.editor.chain().focus().deleteSelection().run()

    for (let i = 0; i < words.length; i++) {
      const textNode = {
        type: 'text',
        text: words[i],
      }

      props.editor.chain().focus().insertContent(textNode).run()

      // Add a space after each word except the last one
      if (i < words.length - 1) {
        const spaceNode = {
          type: 'text',
          text: ' ',
        }

        props.editor.chain().focus().insertContent(spaceNode).run()
      }

      // Wait for 0.3 seconds before adding the next word
      await new Promise((resolve) => setTimeout(resolve, 120))
    }
  }

  const getPrompt = (args: AIPromptsLabels) => {
    const { label, selection } = args

    if (label === 'Writer') {
      return `Write 3 sentences about ${selection}`
    } else if (label === 'ContinueWriting') {
      return `Continue writing 3 more sentences based on "${selection}"`
    } else if (label === 'MakeLonger') {
      return `Make longer this text longer : "${selection}"`
    } else if (label === 'GenerateQuiz') {
      return `Generate a quiz about "${selection}", only return an array of objects, every object should respect the following interface:
            interface Answer {
                answer_id: string;
                answer: string;
                correct: boolean;
              }
              interface Question {
                question_id: string;
                question: string;
                type: "multiple_choice" 
                answers: Answer[];
              }
            " `
    } else if (label === 'Translate') {
      return (
        `Translate "${selection}" to the ` +
        aiEditorState.chatInputValue +
        ` language`
      )
    }
  }

  const getTipTapEditorSelectedTextGlobal = () => {
    // Get the entire node/paragraph that the user is in
    const pos = props.editor.state.selection.$from.pos // get the cursor position
    const resolvedPos = props.editor.state.doc.resolve(pos) // resolve the position in the document
    const start = resolvedPos.before(1) // get the start position of the node
    const end = resolvedPos.after(1) // get the end position of the node
    const paragraph = props.editor.state.doc.textBetween(start, end, '\n', '\n') // get the text of the node
    return paragraph
  }

  const getTipTapEditorSelectedText = () => {
    const selection = props.editor.state.selection
    const from = selection.from
    const to = selection.to
    const text = props.editor.state.doc.textBetween(from, to)
    return text
  }

  return (
    <motion.div
      initial={{ y: 20, opacity: 0.3, filter: 'blur(5px)' }}
      animate={{ y: 0, opacity: 1, filter: 'blur(0px)' }}
      exit={{ y: 50, opacity: 0, filter: 'blur(3px)' }}
      transition={{
        type: 'spring',
        bounce: 0.35,
        duration: 1.7,
        mass: 0.2,
        velocity: 2,
      }}
      className="backdrop-blur-md	fixed top-0 left-0 w-full h-full z-50 flex justify-center items-center "
      style={{ pointerEvents: 'none' }}
    >
      <div
        style={{
          pointerEvents: 'auto',
          background:
            'linear-gradient(0deg, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.2) 100%), radial-gradient(105.16% 105.16% at 50% -5.16%, rgba(255, 255, 255, 0.18) 0%, rgba(0, 0, 0, 0) 100%), rgb(2 1 25 / 95%)',
        }}
        className="backdrop-blur-md	z-50 rounded-2xl max-w-(--breakpoint-2xl) my-10 mx-auto w-[500px] h-[200px] fixed bottom-16 left-1/2 transform -translate-x-1/2 shadow-xl ring-1 ring-inset ring-white/10 text-white p-3 flex-col-reverse"
      >
        <div className="flex space-x-2 justify-center">
          <Image
            className="outline outline-1 outline-neutral-200/20 rounded-lg"
            width={24}
            src={learnhouseAI_icon}
            alt=""
          />
        </div>
        <div className="flex h-[115px] justify-center mx-auto antialiased">
          <div className="flex items-center justify-center ">
            <AiEditorActionScreen handleOperation={handleOperation} />
          </div>
        </div>
        {aiEditorState.isUserInputEnabled && !aiEditorState.error.isError && (
          <div className="flex items-center space-x-2 cursor-pointer">
            <input
              onKeyDown={handleKeyPress}
              value={aiEditorState.chatInputValue}
              onChange={handleChange}
              placeholder="Ask AI"
              className="ring-1 ring-inset ring-white/20 w-full bg-gray-950/20 rounded-lg outline-hidden px-4 py-2 text-white text-sm placeholder:text-white/30"
            ></input>
            <div
              onClick={() =>
                handleOperation(
                  aiEditorState.selectedTool,
                  aiEditorState.chatInputValue
                )
              }
              className="bg-white/10 px-3  rounded-md outline outline-1 outline-neutral-200/20 py-2 hover:bg-white/20 hover:outline-neutral-200/40 delay-75 ease-linear transition-all"
            >
              <BetweenHorizontalStart
                size={20}
                className="text-white/50 hover:cursor-pointer"
              />
            </div>
          </div>
        )}
      </div>
    </motion.div>
  )
}

const AiEditorToolButton = (props: any) => {
  const dispatchAIEditor = useAIEditorDispatch() as any
  const aiEditorState = useAIEditor() as AIEditorStateTypes

  const handleToolButtonClick = async (
    label:
      | 'Writer'
      | 'ContinueWriting'
      | 'MakeLonger'
      | 'GenerateQuiz'
      | 'Translate'
  ) => {
    if (label === 'Writer') {
      await dispatchAIEditor({ type: 'setSelectedTool', payload: label })
      await dispatchAIEditor({ type: 'setIsUserInputEnabled', payload: true })
      await dispatchAIEditor({ type: 'setIsFeedbackModalOpen' })
    }
    if (label === 'ContinueWriting') {
      await dispatchAIEditor({ type: 'setSelectedTool', payload: label })
      await dispatchAIEditor({ type: 'setIsUserInputEnabled', payload: false })
      await dispatchAIEditor({ type: 'setIsFeedbackModalOpen' })
    }
    if (label === 'MakeLonger') {
      await dispatchAIEditor({ type: 'setSelectedTool', payload: label })
      await dispatchAIEditor({ type: 'setIsUserInputEnabled', payload: false })
      await dispatchAIEditor({ type: 'setIsFeedbackModalOpen' })
    }
    if (label === 'GenerateQuiz') {
      await dispatchAIEditor({ type: 'setSelectedTool', payload: label })
      await dispatchAIEditor({ type: 'setIsUserInputEnabled', payload: false })
      await dispatchAIEditor({ type: 'setIsFeedbackModalOpen' })
    }
    if (label === 'Translate') {
      await dispatchAIEditor({ type: 'setSelectedTool', payload: label })
      await dispatchAIEditor({ type: 'setIsUserInputEnabled', payload: false })
      await dispatchAIEditor({ type: 'setIsFeedbackModalOpen' })
    }
  }

  return (
    <button
      onClick={() => handleToolButtonClick(props.label)}
      className="flex space-x-1.5 items-center bg-white/10 px-2 py-0.5 rounded-md outline outline-1 outline-neutral-200/20 text-sm font-semibold text-white/70 hover:bg-white/20 hover:outline-neutral-200/40 delay-75 ease-linear transition-all"
    >
      {props.label === 'Writer' && <Feather size={14} />}
      {props.label === 'ContinueWriting' && <FastForward size={14} />}
      {props.label === 'MakeLonger' && <FileStack size={14} />}
      {props.label === 'GenerateQuiz' && <HelpCircle size={14} />}
      {props.label === 'Translate' && <Languages size={14} />}
      <span>{props.label}</span>
    </button>
  )
}

const AiEditorActionScreen = ({
  handleOperation,
}: {
  handleOperation: any
}) => {
  const dispatchAIEditor = useAIEditorDispatch() as any
  const aiEditorState = useAIEditor() as AIEditorStateTypes

  const handleChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
    await dispatchAIEditor({
      type: 'setChatInputValue',
      payload: event.currentTarget.value,
    })
  }

  return (
    <div>
      {aiEditorState.selectedTool === 'Writer' &&
        !aiEditorState.isWaitingForResponse &&
        !aiEditorState.error.isError && (
          <div className="text-xl text-white/90 font-extrabold space-x-2">
            <span>Write about...</span>
          </div>
        )}
      {aiEditorState.selectedTool === 'ContinueWriting' &&
        !aiEditorState.isWaitingForResponse &&
        !aiEditorState.error.isError && (
          <div className="flex flex-col mx-auto justify-center align-middle items-center">
            <p className="mx-auto flex p-2 text-white/80 mt-4 font-bold justify-center text-sm align-middle">
              Place your cursor at the end of a sentence to continue writing{' '}
            </p>
            <div
              onClick={() => {
                handleOperation(
                  aiEditorState.selectedTool,
                  aiEditorState.chatInputValue
                )
              }}
              className="flex cursor-pointer space-x-1.5 p-4 mt-4 items-center bg-white/10  rounded-md outline outline-1 outline-neutral-200/20 text-2xl font-semibold text-white/70 hover:bg-white/20 hover:outline-neutral-200/40 delay-75 ease-linear transition-all"
            >
              <FastForward size={24} />
            </div>
          </div>
        )}
      {aiEditorState.selectedTool === 'MakeLonger' &&
        !aiEditorState.isWaitingForResponse &&
        !aiEditorState.error.isError && (
          <div className="flex flex-col mx-auto justify-center align-middle items-center">
            <p className="mx-auto flex p-2 text-white/80 mt-4 font-bold justify-center text-sm align-middle">
              Select text to make longer{' '}
            </p>
            <div
              onClick={() => {
                handleOperation(
                  aiEditorState.selectedTool,
                  aiEditorState.chatInputValue
                )
              }}
              className="flex cursor-pointer space-x-1.5 p-4 mt-4 items-center bg-white/10  rounded-md outline outline-1 outline-neutral-200/20 text-2xl font-semibold text-white/70 hover:bg-white/20 hover:outline-neutral-200/40 delay-75 ease-linear transition-all"
            >
              <FileStack size={24} />
            </div>
          </div>
        )}
      {aiEditorState.selectedTool === 'Translate' &&
        !aiEditorState.isWaitingForResponse &&
        !aiEditorState.error.isError && (
          <div className="flex flex-col mx-auto justify-center align-middle items-center">
            <div className="mx-auto flex p-2 text-white/80 mt-4 font-bold justify-center text-sm align-middle space-x-6">
              <p>Translate selected text to </p>
              <input
                value={aiEditorState.chatInputValue}
                onChange={handleChange}
                placeholder="Japanese, Arabic, German, etc. "
                className="ring-1 ring-inset ring-white/20 w-full bg-gray-950/20 rounded-lg outline-hidden px-4 py- text-white text-sm placeholder:text-white/30"
              ></input>
            </div>
            <div
              onClick={() => {
                handleOperation(
                  aiEditorState.selectedTool,
                  aiEditorState.chatInputValue
                )
              }}
              className="flex cursor-pointer space-x-1.5 p-4 mt-4 items-center bg-white/10  rounded-md outline outline-1 outline-neutral-200/20 text-2xl font-semibold text-white/70 hover:bg-white/20 hover:outline-neutral-200/40 delay-75 ease-linear transition-all"
            >
              <Languages size={24} />
            </div>
          </div>
        )}
      {aiEditorState.isWaitingForResponse && !aiEditorState.error.isError && (
        <div className="flex flex-col mx-auto justify-center align-middle items-center">
          <svg
            className="animate-spin mt-10 h-10 w-10 text-white"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              className="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              className="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          <p className="font-bold mt-4 text-white/90">Thinking...</p>
        </div>
      )}

      {aiEditorState.error.isError && (
        <div className="flex items-center h-auto pt-7">
          <div className="flex flex-col mx-auto w-full space-y-2 p-5 rounded-lg bg-red-500/20 outline outline-1 outline-red-500">
            <AlertTriangle size={20} className="text-red-500" />
            <div className="flex flex-col">
              <h3 className="font-semibold text-red-200">
                Something wrong happened
              </h3>
              <span className="text-red-100 text-sm ">
                {aiEditorState.error.error_message}
              </span>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

export default AIEditorToolkit



================================================
FILE: apps/web/components/Objects/Editor/Extensions/Badges/Badges.ts
================================================
import { ReactNodeViewRenderer } from "@tiptap/react";
import { mergeAttributes, Node } from "@tiptap/core";
import BadgesExtension from "@/components/Objects/Editor/Extensions/Badges/BadgesExtension";

export default Node.create({
  name: "badge",
  group: "block",
  draggable: true,
  content: "text*",

  // TODO : multi line support

  addAttributes() {
    return {
      color: {
        default: 'sky',
      },
      emoji: {
        default: 'ğŸ’¡',
      },
    };
  },

  parseHTML() {
    return [
      {
        tag: "badge",
      },
    ];
  },

  renderHTML({ HTMLAttributes }) {
    return ["badge", mergeAttributes(HTMLAttributes), 0];
  },

  addNodeView() {
    return ReactNodeViewRenderer(BadgesExtension);
  },
});



================================================
FILE: apps/web/components/Objects/Editor/Extensions/Badges/BadgesExtension.tsx
================================================
import { NodeViewContent, NodeViewWrapper } from '@tiptap/react'
import React, { useState, useRef, useEffect } from 'react'
import Picker from '@emoji-mart/react'
import { ChevronDown, ChevronRight, Palette } from 'lucide-react'
import { twMerge } from 'tailwind-merge'
import { useEditorProvider } from '@components/Contexts/Editor/EditorContext'

const BadgesExtension: React.FC = (props: any) => {
  const [color, setColor] = useState(props.node.attrs.color)
  const [emoji, setEmoji] = useState(props.node.attrs.emoji)
  const [showEmojiPicker, setShowEmojiPicker] = useState(false)
  const [showColorPicker, setShowColorPicker] = useState(false)
  const [showPredefinedCallouts, setShowPredefinedCallouts] = useState(false)
  const pickerRef = useRef<HTMLDivElement>(null)
  const colorPickerRef = useRef<HTMLDivElement>(null)
  const editorState = useEditorProvider() as any
  const isEditable = editorState.isEditable

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (
        (pickerRef.current && !pickerRef.current.contains(event.target as Node)) ||
        (colorPickerRef.current && !colorPickerRef.current.contains(event.target as Node))
      ) {
        setShowEmojiPicker(false)
        setShowColorPicker(false)
      }
    }

    document.addEventListener('mousedown', handleClickOutside)
    return () => {
      document.removeEventListener('mousedown', handleClickOutside)
    }
  }, [])

  const handleEmojiSelect = (emoji: any) => {
    setEmoji(emoji.native)
    setShowEmojiPicker(false)
    props.updateAttributes({
      emoji: emoji.native,
    })
  }

  const handleColorSelect = (selectedColor: string) => {
    setColor(selectedColor)
    setShowColorPicker(false)
    props.updateAttributes({
      color: selectedColor,
    })
  }

  const handlePredefinedBadgeSelect = (badge: typeof predefinedBadges[0]) => {
    setEmoji(badge.emoji)
    setColor(badge.color)

    props.updateAttributes({
      emoji: badge.emoji,
      color: badge.color,
    })

    // Insert the predefined content
    const { editor } = props
    if (editor) {
      editor.commands.setTextSelection({ from: props.getPos() + 1, to: props.getPos() + props.node.nodeSize - 1 })
      editor.commands.insertContent(badge.content)
    }

    setShowPredefinedCallouts(false)
  }

  const colors = ['sky', 'green', 'yellow', 'red', 'purple', 'teal', 'amber', 'indigo', 'neutral']
  const predefinedBadges = [
    {
      emoji: 'ğŸ“',
      color: 'sky',
      content: 'Key Concept'
    },
    {
      emoji: 'ğŸ’¡',
      color: 'yellow',
      content: 'Example'
    },
    {
      emoji: 'ğŸ”',
      color: 'teal',
      content: 'Deep Dive'
    },
    {
      emoji: 'âš ï¸',
      color: 'red',
      content: 'Important Note'
    },
    {
      emoji: 'ğŸ§ ',
      color: 'purple',
      content: 'Remember This'
    },
    {
      emoji: 'ğŸ‹ï¸',
      color: 'green',
      content: 'Exercise'
    },
    {
      emoji: 'ğŸ¯',
      color: 'amber',
      content: 'Learning Objective'
    },
    {
      emoji: 'ğŸ“š',
      color: 'indigo',
      content: 'Further Reading'
    },
    {
      emoji: 'ğŸ’¬',
      color: 'neutral',
      content: 'Discussion Topic'
    }
  ]

  const getBadgeColor = (color: string) => {
    switch (color) {
      case 'sky': return 'bg-sky-400 text-sky-50';
      case 'green': return 'bg-green-400 text-green-50';
      case 'yellow': return 'bg-yellow-400 text-black';
      case 'red': return 'bg-red-500 text-red-50';
      case 'purple': return 'bg-purple-400 text-purple-50';
      case 'pink': return 'bg-pink-400 text-pink-50';
      case 'teal': return 'bg-teal-400 text-teal-900';
      case 'amber': return 'bg-amber-600 text-amber-100';
      case 'indigo': return 'bg-indigo-400 text-indigo-50';
      case 'neutral': return 'bg-neutral-800 text-white';
      default: return 'bg-sky-400 text-white';
    }
  }

  return (
    <NodeViewWrapper>
      <div className='flex space-x-2 items-center relative'>
        <div className={twMerge(
          'flex space-x-1 py-1.5 items-center w-fit rounded-full outline outline-2 outline-white/20 px-3.5 font-semibold nice-shadow text-sm my-2',
          getBadgeColor(color)
        )}>
          <div className="flex items-center justify-center space-x-1">
            <span className='text'>{emoji}</span>
            {isEditable && (
              <button onClick={() => setShowEmojiPicker(!showEmojiPicker)}>
                <ChevronDown size={14} />
              </button>
            )}
          </div>
          <NodeViewContent
            contentEditable={isEditable}
            className="content capitalize text tracking-wide "
          >
          </NodeViewContent>
          {isEditable && (
            <div className="flex items-center justify-center space-x-2 relative">
              <button onClick={() => setShowColorPicker(!showColorPicker)}>
                <Palette size={14} />
              </button>
              {showColorPicker && (
                <div ref={colorPickerRef} className="absolute left-full ml-2 p-2 bg-white rounded-full nice-shadow">
                  <div className="flex space-x-2">
                    {colors.map((c) => (
                      <button
                        key={c}
                        className={`w-8 h-8 rounded-full ${getBadgeColor(c)} hover:ring-2 hover:ring-opacity-50 focus:outline-hidden focus:ring-2 focus:ring-opacity-50`}
                        onClick={() => handleColorSelect(c)}
                      />
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
        
        {isEditable && (
          <button
            onClick={() => setShowPredefinedCallouts(!showPredefinedCallouts)}
            className="text-neutral-300 hover:text-neutral-400 transition-colors"
          >
            <ChevronRight size={16} />
          </button>
        )}

        {isEditable && showPredefinedCallouts && (
          <div className='flex flex-wrap gap-2 absolute top-full mt-2 left-0 bg-white/90 backdrop-blur-md p-2 rounded-lg nice-shadow z-10'>
            {predefinedBadges.map((badge, index) => (
              <button
                key={index}
                onClick={() => handlePredefinedBadgeSelect(badge)}
                className={`flex text-xs items-center px-3 py-1 rounded-xl space-x-2 ${getBadgeColor(badge.color)} text-gray-600 font-bold light-shadow hover:opacity-80 transition-all duration-100 ease-linear`}
              >
                <span className='text-xs'>{badge.emoji}</span>
                <span className="content capitalize">{badge.content}</span>
              </button>
            ))}
          </div>
        )}
      </div>

      {isEditable && showEmojiPicker && (
        <div ref={pickerRef}>
          <Picker
            searchPosition="top"
            theme="light"
            previewPosition="none"
            maxFrequentRows={0}
            autoFocus={false}
            onEmojiSelect={handleEmojiSelect}
          />
        </div>
      )}


    </NodeViewWrapper>
  )
}

export default BadgesExtension;



================================================
FILE: apps/web/components/Objects/Editor/Extensions/Buttons/Buttons.ts
================================================
import { ReactNodeViewRenderer } from "@tiptap/react";
import { mergeAttributes, Node } from "@tiptap/core";
import ButtonsExtension from "./ButtonsExtension";

export default Node.create({
  name: "button",
  group: "block",
  draggable: true,
  content: "text*",

  addAttributes() {
    return {
      emoji: {
        default: 'ğŸ”—',
      },
      link: {
        default: '',
      },
      color: {
        default: 'blue',
      },
      alignment: {
        default: 'left',
      },
    };
  },

  parseHTML() {
    return [
      {
        tag: "button-block",
      },
    ];
  },

  renderHTML({ HTMLAttributes }) {
    return ["button-block", mergeAttributes(HTMLAttributes), 0];
  },

  addNodeView() {
    return ReactNodeViewRenderer(ButtonsExtension);
  },
});


================================================
FILE: apps/web/components/Objects/Editor/Extensions/Buttons/ButtonsExtension.tsx
================================================
import { NodeViewContent, NodeViewWrapper } from '@tiptap/react'
import React, { useState, useRef, useEffect } from 'react'
import Picker from '@emoji-mart/react'
import { ArrowRight, ChevronDown, Link, AlignLeft, AlignCenter, AlignRight, Palette } from 'lucide-react'
import { twMerge } from 'tailwind-merge'
import { useEditorProvider } from '@components/Contexts/Editor/EditorContext'

const ButtonsExtension: React.FC = (props: any) => {
  const [emoji, setEmoji] = useState(props.node.attrs.emoji)
  const [link, setLink] = useState(props.node.attrs.link)
  const [alignment, setAlignment] = useState(props.node.attrs.alignment)
  const [showEmojiPicker, setShowEmojiPicker] = useState(false)
  const [showLinkInput, setShowLinkInput] = useState(false)
  const [color, setColor] = useState(props.node.attrs.color || 'blue')
  const [showColorPicker, setShowColorPicker] = useState(false)
  const pickerRef = useRef<HTMLDivElement>(null)
  const linkInputRef = useRef<HTMLInputElement>(null)
  const colorPickerRef = useRef<HTMLDivElement>(null)
  const editorState = useEditorProvider() as any
  const isEditable = editorState.isEditable

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (pickerRef.current && !pickerRef.current.contains(event.target as Node)) {
        setShowEmojiPicker(false)
      }
      if (linkInputRef.current && !linkInputRef.current.contains(event.target as Node)) {
        setShowLinkInput(false)
      }
      if (colorPickerRef.current && !colorPickerRef.current.contains(event.target as Node)) {
        setShowColorPicker(false)
      }
    }

    document.addEventListener('mousedown', handleClickOutside)
    return () => {
      document.removeEventListener('mousedown', handleClickOutside)
    }
  }, [])

  const handleEmojiSelect = (emoji: any) => {
    setEmoji(emoji.native)
    setShowEmojiPicker(false)
    props.updateAttributes({
      emoji: emoji.native,
    })
  }

  const handleLinkChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setLink(e.target.value)
    props.updateAttributes({
      link: e.target.value,
    })
  }

  const handleAlignmentChange = (newAlignment: 'left' | 'center' | 'right') => {
    setAlignment(newAlignment)
    props.updateAttributes({
      alignment: newAlignment,
    })
  }

  const getAlignmentClass = () => {
    switch (alignment) {
      case 'left': return 'text-left';
      case 'center': return 'text-center';
      case 'right': return 'text-right';
      default: return 'text-left';
    }
  }

  const handleColorSelect = (selectedColor: string) => {
    setColor(selectedColor)
    setShowColorPicker(false)
    props.updateAttributes({
      color: selectedColor,
    })
  }

  const getButtonColor = (color: string) => {
    switch (color) {
      case 'sky': return 'bg-sky-500 hover:bg-sky-600';
      case 'green': return 'bg-green-500 hover:bg-green-600';
      case 'yellow': return 'bg-yellow-500 hover:bg-yellow-600';
      case 'red': return 'bg-red-500 hover:bg-red-600';
      case 'purple': return 'bg-purple-500 hover:bg-purple-600';
      case 'teal': return 'bg-teal-500 hover:bg-teal-600';
      case 'amber': return 'bg-amber-500 hover:bg-amber-600';
      case 'indigo': return 'bg-indigo-500 hover:bg-indigo-600';
      case 'neutral': return 'bg-neutral-500 hover:bg-neutral-600';
      default: return 'bg-blue-500 hover:bg-blue-600';
    }
  }

  const colors = ['sky', 'green', 'yellow', 'red', 'purple', 'teal', 'amber', 'indigo', 'neutral', 'blue']

  return (
    <NodeViewWrapper className={`block-button ${getAlignmentClass()}`}>
      <div className='inline-block'>
        <button
          onClick={isEditable ? undefined : () => window.open(link, '_blank')}
          className={twMerge(
            'flex items-center space-x-2 py-2 px-4 rounded-xl text-white transition-colors',
            getButtonColor(color),
            isEditable && 'pointer-events-none',
            !link && 'opacity-60'
          )}
        >
          <span>{emoji}</span>
          <NodeViewContent className="content" />
          <ArrowRight size={14} />
        </button>
        {isEditable && (
          <div className="flex mt-2 space-x-2">
            <button onClick={() => setShowEmojiPicker(!showEmojiPicker)} className="p-1 bg-gray-200 rounded-md">
              <ChevronDown size={14} />
            </button>
            <button onClick={() => setShowLinkInput(!showLinkInput)} className="p-1 bg-gray-200 rounded-md">
              <Link size={14} />
            </button>
            <button onClick={() => handleAlignmentChange('left')} className="p-1 bg-gray-200 rounded-md">
              <AlignLeft size={14} />
            </button>
            <button onClick={() => handleAlignmentChange('center')} className="p-1 bg-gray-200 rounded-md">
              <AlignCenter size={14} />
            </button>
            <button onClick={() => handleAlignmentChange('right')} className="p-1 bg-gray-200 rounded-md">
              <AlignRight size={14} />
            </button>
            <button onClick={() => setShowColorPicker(!showColorPicker)} className="p-1 bg-gray-200 rounded-md">
              <Palette size={14} />
            </button>
          </div>
        )}
      </div>
      {isEditable && showEmojiPicker && (
        <div ref={pickerRef}>
          <Picker onEmojiSelect={handleEmojiSelect} />
        </div>
      )}
      {isEditable && showLinkInput && (
        <input
          ref={linkInputRef}
          type="text"
          value={link}
          onChange={handleLinkChange}
          placeholder="Enter link URL"
          className="mt-2 p-2 w-full border rounded-md"
        />
      )}
      {isEditable && showColorPicker && (
        <div ref={colorPickerRef} className="absolute mt-2 p-2 bg-white rounded-md nice-shadow">
          <div className="flex flex-wrap gap-2">
            {colors.map((c) => (
              <button
                key={c}
                className={`w-6 h-6 rounded-full ${getButtonColor(c)} hover:ring-2 hover:ring-opacity-50 focus:outline-hidden focus:ring-2 focus:ring-opacity-50`}
                onClick={() => handleColorSelect(c)}
              />
            ))}
          </div>
        </div>
      )}
    </NodeViewWrapper>
  )
}

export default ButtonsExtension



================================================
FILE: apps/web/components/Objects/Editor/Extensions/Callout/Info/InfoCallout.ts
================================================
import { mergeAttributes, Node } from '@tiptap/core'
import { ReactNodeViewRenderer } from '@tiptap/react'

import InfoCalloutComponent from './InfoCalloutComponent'

export default Node.create({
  name: 'calloutInfo',
  group: 'block',
  draggable: true,
  content: 'text*',

  // TODO : multi line support

  parseHTML() {
    return [
      {
        tag: 'callout-info',
      },
    ]
  },

  renderHTML({ HTMLAttributes }) {
    return ['callout-info', mergeAttributes(HTMLAttributes), 0]
  },

  addNodeView() {
    return ReactNodeViewRenderer(InfoCalloutComponent)
  },
})



================================================
FILE: apps/web/components/Objects/Editor/Extensions/Callout/Info/InfoCalloutComponent.tsx
================================================
import { useEditorProvider } from '@components/Contexts/Editor/EditorContext'
import { NodeViewContent, NodeViewWrapper } from '@tiptap/react'
import { Info, X } from 'lucide-react'
import React, { useState } from 'react'
import styled from 'styled-components'

interface CalloutOptions {
  dismissible?: boolean;
  variant?: 'default' | 'filled' | 'outlined';
  size?: 'sm' | 'md' | 'lg';
}

const IconWrapper = styled.div<{ size?: string }>`
  display: flex;
  align-items: center;
  justify-content: center;
  shrink: 0;
  margin-right: 0.5rem;
  padding-left: 0.5rem;
  
  svg {
    width: 20px;
    height: 20px;
    min-width: 20px;
  }
  
  @media (max-width: 640px) {
    margin-right: 0.25rem;
    padding-left: 0.375rem;
    padding-top: ${props => props.size === 'sm' ? '0' : '0.5rem'};
    align-self: ${props => props.size === 'sm' ? 'center' : 'flex-start'};
  }
`

const ContentWrapper = styled.div`
  width: 100%;
  overflow-wrap: break-word;
`

const DismissButton = styled.button`
  background: transparent;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 4px;
  margin-left: 8px;
  border-radius: 50%;
  
  &:hover {
    background-color: rgba(0, 0, 0, 0.1);
  }
`

const InfoCalloutWrapper = styled.div<{ size?: string }>`
  width: 100%;
  display: flex;
  position: relative;
  margin: 1rem 0;
  
  @media (max-width: 640px) {
    flex-direction: ${props => props.size === 'sm' ? 'row' : 'column'};
    align-items: ${props => props.size === 'sm' ? 'center' : 'flex-start'};
  }

  svg {
    padding: 0;
  }

  .content {
    margin: 5px;
    padding: 0.5rem;
    border: ${(props) =>
      props.contentEditable ? '2px dashed #1f3a8a12' : 'none'};
    border-radius: 0.5rem;
    
    @media (max-width: 640px) {
      margin: ${props => props.size === 'sm' ? '3px' : '5px 0'};
      padding: ${props => props.size === 'sm' ? '0.25rem' : '0.5rem'};
      width: 100%;
    }
  }
`

function InfoCalloutComponent(props: any) {
  const editorState = useEditorProvider() as any
  const isEditable = editorState.isEditable
  const [dismissed, setDismissed] = useState(false)
  
  // Extract options from props or use defaults
  const options: CalloutOptions = {
    dismissible: props.node?.attrs?.dismissible || false,
    variant: props.node?.attrs?.variant || 'default',
    size: props.node?.attrs?.size || 'md',
  }
  
  if (dismissed) return null;
  
  const getVariantClasses = () => {
    switch(options.variant) {
      case 'filled':
        return 'bg-gray-300 text-gray-700';
      case 'outlined':
        return 'bg-transparent border-2 border-gray-300 text-gray-500';
      default:
        return 'bg-gray-100 text-gray-600';
    }
  }
  
  const getSizeClasses = () => {
    switch(options.size) {
      case 'sm': return 'py-1 px-2 text-sm';
      case 'lg': return 'py-3 px-4 text-lg';
      default: return 'py-2 px-3';
    }
  }

  return (
    <NodeViewWrapper>
      <InfoCalloutWrapper
        className={`flex items-center rounded-xl shadow-inner ${getVariantClasses()} ${getSizeClasses()}`}
        contentEditable={isEditable}
        size={options.size}
      >
        <IconWrapper size={options.size}>
          <Info />
        </IconWrapper>
        <ContentWrapper className="grow">
          <NodeViewContent contentEditable={isEditable} className="content" />
        </ContentWrapper>
        {options.dismissible && !isEditable && (
          <DismissButton onClick={() => setDismissed(true)}>
            <X size={16} />
          </DismissButton>
        )}
      </InfoCalloutWrapper>
    </NodeViewWrapper>
  )
}

export default InfoCalloutComponent



================================================
FILE: apps/web/components/Objects/Editor/Extensions/Callout/Warning/WarningCallout.ts
================================================
import { mergeAttributes, Node } from '@tiptap/core'
import { ReactNodeViewRenderer } from '@tiptap/react'

import WarningCalloutComponent from './WarningCalloutComponent'

export default Node.create({
  name: 'calloutWarning',
  group: 'block',
  draggable: true,
  content: 'text*',

  // TODO : multi line support

  parseHTML() {
    return [
      {
        tag: 'callout-warning',
      },
    ]
  },

  renderHTML({ HTMLAttributes }) {
    return ['callout-info', mergeAttributes(HTMLAttributes), 0]
  },

  addNodeView() {
    return ReactNodeViewRenderer(WarningCalloutComponent)
  },
})



================================================
FILE: apps/web/components/Objects/Editor/Extensions/Callout/Warning/WarningCalloutComponent.tsx
================================================
import { useEditorProvider } from '@components/Contexts/Editor/EditorContext'
import { NodeViewContent, NodeViewWrapper } from '@tiptap/react'
import { AlertTriangle, X } from 'lucide-react'
import React, { useState } from 'react'
import styled from 'styled-components'

interface CalloutOptions {
  dismissible?: boolean;
  variant?: 'default' | 'filled' | 'outlined';
  size?: 'sm' | 'md' | 'lg';
}

const IconWrapper = styled.div<{ size?: string }>`
  display: flex;
  align-items: center;
  justify-content: center;
  shrink: 0;
  margin-right: 0.5rem;
  padding-left: 0.5rem;
  
  svg {
    width: 20px;
    height: 20px;
    min-width: 20px;
  }
  
  @media (max-width: 640px) {
    margin-right: 0.25rem;
    padding-left: 0.375rem;
    padding-top: ${props => props.size === 'sm' ? '0' : '0.5rem'};
    align-self: ${props => props.size === 'sm' ? 'center' : 'flex-start'};
  }
`

const ContentWrapper = styled.div`
  width: 100%;
  overflow-wrap: break-word;
`

const DismissButton = styled.button`
  background: transparent;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 4px;
  margin-left: 8px;
  border-radius: 50%;
  
  &:hover {
    background-color: rgba(0, 0, 0, 0.1);
  }
`

const CalloutWrapper = styled.div<{ size?: string }>`
  width: 100%;
  display: flex;
  position: relative;
  margin: 1rem 0;
  
  @media (max-width: 640px) {
    flex-direction: ${props => props.size === 'sm' ? 'row' : 'column'};
    align-items: ${props => props.size === 'sm' ? 'center' : 'flex-start'};
  }

  svg {
    padding: 0;
  }

  .content {
    margin: 5px;
    padding: 0.5rem;
    border: ${(props) =>
      props.contentEditable ? '2px dashed #713f1117' : 'none'};
    border-radius: 0.5rem;
    
    @media (max-width: 640px) {
      margin: ${props => props.size === 'sm' ? '3px' : '5px 0'};
      padding: ${props => props.size === 'sm' ? '0.25rem' : '0.5rem'};
      width: 100%;
    }
  }
`

function WarningCalloutComponent(props: any) {
  const editorState = useEditorProvider() as any
  const isEditable = editorState.isEditable
  const [dismissed, setDismissed] = useState(false)
  
  // Extract options from props or use defaults
  const options: CalloutOptions = {
    dismissible: props.node?.attrs?.dismissible || false,
    variant: props.node?.attrs?.variant || 'default',
    size: props.node?.attrs?.size || 'md',
  }
  
  if (dismissed) return null;
  
  const getVariantClasses = () => {
    switch(options.variant) {
      case 'filled':
        return 'bg-yellow-500 text-white';
      case 'outlined':
        return 'bg-transparent border-2 border-yellow-500 text-yellow-700';
      default:
        return 'bg-yellow-200 text-yellow-900';
    }
  }
  
  const getSizeClasses = () => {
    switch(options.size) {
      case 'sm': return 'py-1 px-2 text-sm';
      case 'lg': return 'py-3 px-4 text-lg';
      default: return 'py-2 px-3';
    }
  }

  return (
    <NodeViewWrapper>
      <CalloutWrapper
        className={`flex items-center rounded-lg shadow-inner ${getVariantClasses()} ${getSizeClasses()}`}
        contentEditable={isEditable}
        size={options.size}
      >
        <IconWrapper size={options.size}>
          <AlertTriangle />
        </IconWrapper>
        <ContentWrapper className="grow">
          <NodeViewContent contentEditable={isEditable} className="content" />
        </ContentWrapper>
        {options.dismissible && !isEditable && (
          <DismissButton onClick={() => setDismissed(true)}>
            <X size={16} />
          </DismissButton>
        )}
      </CalloutWrapper>
    </NodeViewWrapper>
  )
}

export default WarningCalloutComponent


================================================
FILE: apps/web/components/Objects/Editor/Extensions/EmbedObjects/EmbedObjects.ts
================================================
import { mergeAttributes, Node } from '@tiptap/core'
import { ReactNodeViewRenderer } from '@tiptap/react'
import EmbedObjectsComponent from './EmbedObjectsComponent'


export default Node.create({
  name: 'blockEmbed',
  group: 'block',

  addAttributes() {
    return {
      embedUrl: {
        default: null,
      },
      embedCode: {
        default: null,
      },
      embedType: {
        default: null,
      },
      embedHeight: {
        default: 300,
      },
      embedWidth: {
        default: '100%',
      },
      alignment: {
        default: 'left',
      },
    }
  },

  parseHTML() {
    return [
      {
        tag: 'block-embed',
      },
    ]
  },

  renderHTML({ HTMLAttributes }) {
    return ['block-embed', mergeAttributes(HTMLAttributes), 0]
  },

  addNodeView() {
    return ReactNodeViewRenderer(EmbedObjectsComponent)
  },
  
})


================================================
FILE: apps/web/components/Objects/Editor/Extensions/EmbedObjects/EmbedObjectsComponent.tsx
================================================
import { NodeViewWrapper } from '@tiptap/react'
import React, { useState, useRef, useEffect, useMemo } from 'react'
import { Link as LinkIcon, GripVertical, GripHorizontal, AlignCenter, Code } from 'lucide-react'
import { useEditorProvider } from '@components/Contexts/Editor/EditorContext'
import { SiGithub, SiReplit, SiSpotify, SiLoom, SiGooglemaps, SiCodepen, SiCanva, SiNotion, SiGoogledocs, SiX, SiFigma, SiGiphy, SiYoutube } from '@icons-pack/react-simple-icons'
import { useRouter } from 'next/navigation'
import DOMPurify from 'dompurify'

// Add new type for script-based embeds
const SCRIPT_BASED_EMBEDS = {
  twitter: { src: 'https://platform.twitter.com/widgets.js', identifier: 'twitter-tweet' },
  instagram: { src: 'https://www.instagram.com/embed.js', identifier: 'instagram-media' },
  tiktok: { src: 'https://www.tiktok.com/embed.js', identifier: 'tiktok-embed' },
  // Add more platforms as needed
};

// Helper function to convert YouTube URLs to embed format
const getYouTubeEmbedUrl = (url: string): string => {
  try {
    // First validate that this is a proper URL
    const parsedUrl = new URL(url);
    
    // Ensure the hostname is actually YouTube
    const isYoutubeHostname = 
      parsedUrl.hostname === 'youtube.com' || 
      parsedUrl.hostname === 'www.youtube.com' || 
      parsedUrl.hostname === 'youtu.be' || 
      parsedUrl.hostname === 'www.youtu.be';
    
    if (!isYoutubeHostname) {
      return url; // Not a YouTube URL, return as is
    }
    
    // Handle different YouTube URL formats with a more precise regex
    const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i;
    const match = url.match(youtubeRegex);
    
    if (match && match[1]) {
      // Validate the video ID format (should be exactly 11 characters)
      const videoId = match[1];
      if (videoId.length === 11) {
        // Return the embed URL with the video ID and secure protocol
        return `https://www.youtube.com/embed/${videoId}?autoplay=0&rel=0`;
      }
    }
    
    // If no valid match found, return the original URL
    return url;
  } catch (e) {
    // If URL parsing fails, return the original URL
    return url;
  }
};

// Add new memoized component for the embed content
const MemoizedEmbed = React.memo(({ embedUrl, sanitizedEmbedCode, embedType }: {
  embedUrl: string;
  sanitizedEmbedCode: string;
  embedType: 'url' | 'code';
}) => {
  useEffect(() => {
    if (embedType === 'code' && sanitizedEmbedCode) {
      // Check for any matching script-based embeds
      const matchingPlatform = Object.entries(SCRIPT_BASED_EMBEDS).find(([_, config]) => 
        sanitizedEmbedCode.includes(config.identifier)
      );

      if (matchingPlatform) {
        const [_, config] = matchingPlatform;
        const script = document.createElement('script');
        script.src = config.src;
        script.async = true;
        script.charset = 'utf-8';
        document.body.appendChild(script);

        return () => {
          document.body.removeChild(script);
        };
      }
    }
  }, [embedType, sanitizedEmbedCode]);

  if (embedType === 'url' && embedUrl) {
    // Process the URL if it's a YouTube URL - using proper URL validation
    let isYoutubeUrl = false;
    
    try {
      const url = new URL(embedUrl);
      // Check if the hostname is exactly youtube.com or youtu.be (or www variants)
      isYoutubeUrl = url.hostname === 'youtube.com' || 
                     url.hostname === 'www.youtube.com' || 
                     url.hostname === 'youtu.be' || 
                     url.hostname === 'www.youtu.be';
    } catch (e) {
      // Invalid URL format, not a YouTube URL
      isYoutubeUrl = false;
    }
    
    const processedUrl = isYoutubeUrl ? getYouTubeEmbedUrl(embedUrl) : embedUrl;
      
    return (
      <iframe 
        src={processedUrl} 
        className="w-full h-full"
        frameBorder="0"
        allowFullScreen
      />
    );
  }
  
  if (embedType === 'code' && sanitizedEmbedCode) {
    return <div dangerouslySetInnerHTML={{ __html: sanitizedEmbedCode }} className="w-full h-full" />;
  }
  
  return null;
});
MemoizedEmbed.displayName = 'MemoizedEmbed';

function EmbedObjectsComponent(props: any) {
  const [embedType, setEmbedType] = useState<'url' | 'code'>(props.node.attrs.embedType || 'url')
  const [embedUrl, setEmbedUrl] = useState(props.node.attrs.embedUrl || '')
  const [embedCode, setEmbedCode] = useState(props.node.attrs.embedCode || '')
  const [embedHeight, setEmbedHeight] = useState(props.node.attrs.embedHeight || 300)
  const [embedWidth, setEmbedWidth] = useState(props.node.attrs.embedWidth || '100%')
  const [alignment, setAlignment] = useState(props.node.attrs.alignment || 'left')
  const [isResizing, setIsResizing] = useState(false)
  const [parentWidth, setParentWidth] = useState<number | null>(null)
  const [isMobile, setIsMobile] = useState(false)

  const resizeRef = useRef<HTMLDivElement>(null)
  const containerRef = useRef<HTMLDivElement>(null)
  const editorState = useEditorProvider() as any
  const isEditable = editorState.isEditable
  const router = useRouter()

  // Add ResizeObserver to track parent container size changes
  useEffect(() => {
    const updateDimensions = () => {
      if (containerRef.current && containerRef.current.parentElement) {
        const parentElement = containerRef.current.parentElement;
        const newParentWidth = parentElement.offsetWidth;
        setParentWidth(newParentWidth);
        
        // Check if we're in a mobile viewport
        setIsMobile(newParentWidth < 640); // 640px is a common breakpoint for small screens
        
        // If embedWidth is set to a percentage, maintain that percentage
        // Otherwise, adjust to fit parent width
        if (typeof embedWidth === 'string' && embedWidth.endsWith('%')) {
          const percentage = parseInt(embedWidth, 10);
          const newWidth = `${Math.min(100, percentage)}%`;
          setEmbedWidth(newWidth);
          props.updateAttributes({ embedWidth: newWidth });
        } else if (newParentWidth < parseInt(String(embedWidth), 10)) {
          // If parent is smaller than current width, adjust to fit
          setEmbedWidth('100%');
          props.updateAttributes({ embedWidth: '100%' });
        }
      }
    };

    // Initialize dimensions
    updateDimensions();

    // Set up ResizeObserver
    const resizeObserver = new ResizeObserver(() => {
      updateDimensions();
    });

    if (containerRef.current && containerRef.current.parentElement) {
      resizeObserver.observe(containerRef.current.parentElement);
    }

    // Clean up
    return () => {
      resizeObserver.disconnect();
    };
  }, []);

  const supportedProducts = [
    { name: 'YouTube', icon: SiYoutube, color: '#FF0000', guide: 'https://support.google.com/youtube/answer/171780?hl=en' },
    { name: 'GitHub', icon: SiGithub, color: '#181717', guide: 'https://emgithub.com/' },
    { name: 'Replit', icon: SiReplit, color: '#F26207', guide: 'https://docs.replit.com/hosting/embedding-repls' },
    { name: 'Spotify', icon: SiSpotify, color: '#1DB954', guide: 'https://developer.spotify.com/documentation/embeds' },
    { name: 'Loom', icon: SiLoom, color: '#625DF5', guide: 'https://support.loom.com/hc/en-us/articles/360002208317-How-to-embed-your-video-into-a-webpage' },
    { name: 'GMaps', icon: SiGooglemaps, color: '#4285F4', guide: 'https://developers.google.com/maps/documentation/embed/get-started' },
    { name: 'CodePen', icon: SiCodepen, color: '#000000', guide: 'https://blog.codepen.io/documentation/embedded-pens/' },
    { name: 'Canva', icon: SiCanva, color: '#00C4CC', guide: 'https://www.canva.com/help/article/embed-designs' },
    { name: 'Notion', icon: SiNotion, color: '#878787', guide: 'https://www.notion.so/help/embed-and-connect-other-apps#7a70ac4b5c5f4ec889e69d262e0de9e7' },
    { name: 'G Docs', icon: SiGoogledocs, color: '#4285F4', guide: 'https://support.google.com/docs/answer/183965?hl=en&co=GENIE.Platform%3DDesktop' },
    { name: 'X', icon: SiX, color: '#000000', guide: 'https://help.twitter.com/en/using-twitter/how-to-embed-a-tweet' },
    { name: 'Figma', icon: SiFigma, color: '#F24E1E', guide: 'https://help.figma.com/hc/en-us/articles/360041057214-Embed-files-and-prototypes' },
    { name: 'Giphy', icon: SiGiphy, color: '#FF6666', guide: 'https://developers.giphy.com/docs/embed/' },
  ]

  const [sanitizedEmbedCode, setSanitizedEmbedCode] = useState('')

  useEffect(() => {
    if (embedType === 'code' && embedCode) {
      const sanitized = DOMPurify.sanitize(embedCode, {
        ADD_TAGS: ['iframe'],
        ADD_ATTR: ['*']
      })
      setSanitizedEmbedCode(sanitized)
    }
  }, [embedCode, embedType])

  const handleEmbedTypeChange = (type: 'url' | 'code') => {
    setEmbedType(type)
    props.updateAttributes({ embedType: type })
  }

  const handleUrlChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    const newUrl = event.target.value;
    const trimmedUrl = newUrl.trim();
    
    // Only update if URL is not just whitespace
    if (newUrl === '' || trimmedUrl) {
      // First sanitize with DOMPurify
      const sanitizedUrl = DOMPurify.sanitize(newUrl);
      
      // Additional URL validation for security
      let validatedUrl = sanitizedUrl;
      
      if (sanitizedUrl) {
        try {
          // Ensure it's a valid URL by parsing it
          const url = new URL(sanitizedUrl);
          
          // Only allow http and https protocols
          if (url.protocol !== 'http:' && url.protocol !== 'https:') {
            // If invalid protocol, default to https
            url.protocol = 'https:';
            validatedUrl = url.toString();
          }
        } catch (e) {
          // If it's not a valid URL, prepend https:// to make it valid
          // Only do this if it's not empty and doesn't already start with a protocol
          if (sanitizedUrl && !sanitizedUrl.match(/^[a-zA-Z]+:\/\//)) {
            validatedUrl = `https://${sanitizedUrl}`;
          }
        }
      }
      
      setEmbedUrl(validatedUrl);
      props.updateAttributes({
        embedUrl: validatedUrl,
        embedType: 'url',
      });
    }
  };

  const handleCodeChange = (event: React.ChangeEvent<HTMLTextAreaElement>) => {
    const newCode = event.target.value;
    const trimmedCode = newCode.trim();
    // Only update if code is not just whitespace
    if (newCode === '' || trimmedCode) {
      setEmbedCode(newCode);
      props.updateAttributes({
        embedCode: newCode,
        embedType: 'code',
      });
    }
  };

  // Add refs for storing dimensions during resize
  const dimensionsRef = useRef({
    width: props.node.attrs.embedWidth || '100%',
    height: props.node.attrs.embedHeight || 300
  })

  const handleResizeStart = (event: React.MouseEvent<HTMLDivElement>, direction: 'horizontal' | 'vertical') => {
    event.preventDefault()
    setIsResizing(true)
    const startX = event.clientX
    const startY = event.clientY
    const startWidth = resizeRef.current?.offsetWidth || 0
    const startHeight = resizeRef.current?.offsetHeight || 0

    const handleMouseMove = (e: MouseEvent) => {
      if (resizeRef.current) {
        if (direction === 'horizontal') {
          const newWidth = startWidth + e.clientX - startX
          const parentWidth = resizeRef.current.parentElement?.offsetWidth || 1
          const widthPercentage = Math.min(100, Math.max(10, (newWidth / parentWidth) * 100))
          const newWidthValue = `${widthPercentage}%`
          
          // Update ref and DOM directly during resize
          dimensionsRef.current.width = newWidthValue
          resizeRef.current.style.width = newWidthValue
        } else {
          const newHeight = Math.max(100, startHeight + e.clientY - startY)
          
          // Update ref and DOM directly during resize
          dimensionsRef.current.height = newHeight
          resizeRef.current.style.height = `${newHeight}px`
        }
      }
    }

    const handleMouseUp = () => {
      setIsResizing(false)
      // Only update state and attributes after resize is complete
      setEmbedWidth(dimensionsRef.current.width)
      setEmbedHeight(dimensionsRef.current.height)
      props.updateAttributes({ 
        embedWidth: dimensionsRef.current.width,
        embedHeight: dimensionsRef.current.height
      })
      document.removeEventListener('mousemove', handleMouseMove)
      document.removeEventListener('mouseup', handleMouseUp)
    }

    document.addEventListener('mousemove', handleMouseMove)
    document.addEventListener('mouseup', handleMouseUp)
  }

  const handleCenterBlock = () => {
    const newAlignment = alignment === 'center' ? 'left' : 'center'
    setAlignment(newAlignment)
    props.updateAttributes({ alignment: newAlignment })
  }

  const handleProductClick = (guide: string) => {
    window.open(guide, '_blank', 'noopener,noreferrer')
  }

  // Calculate responsive styles based on parent width
  const getResponsiveStyles = () => {
    // Default styles
    const styles: React.CSSProperties = {
      height: `${embedHeight}px`,
      width: embedWidth,
    };

    // If parent width is available, ensure we don't exceed it
    if (parentWidth) {
      // For mobile viewports, always use 100% width
      if (isMobile) {
        styles.width = '100%';
        styles.minWidth = 'unset';
      } else {
        // For desktop, use the set width but ensure it's not wider than parent
        styles.minWidth = Math.min(parentWidth, 400) + 'px';
        styles.maxWidth = '100%';
      }
    }

    return styles;
  };

  // Memoize the embed content
  const embedContent = useMemo(() => (
    !isResizing && (embedUrl || sanitizedEmbedCode) ? (
      <MemoizedEmbed 
        embedUrl={embedUrl}
        sanitizedEmbedCode={sanitizedEmbedCode}
        embedType={embedType}
      />
    ) : (
      <div className="w-full h-full bg-gray-200" />
    )
  ), [embedUrl, sanitizedEmbedCode, embedType, isResizing]);

  // Input states
  const [activeInput, setActiveInput] = useState<'none' | 'url' | 'code'>('none');
  const [selectedProduct, setSelectedProduct] = useState<typeof supportedProducts[0] | null>(null);
  const urlInputRef = useRef<HTMLInputElement>(null);
  const codeInputRef = useRef<HTMLTextAreaElement>(null);

  // Handle direct input from product selection
  const handleProductSelection = (product: typeof supportedProducts[0]) => {
    // Set the input type to URL by default
    setEmbedType('url');
    setActiveInput('url');
    
    // Store the selected product for the popup
    setSelectedProduct(product);
    
    // Focus the URL input after a short delay to allow rendering
    setTimeout(() => {
      if (urlInputRef.current) {
        urlInputRef.current.focus();
      }
    }, 50);
  };

  // Handle input submission
  const handleInputSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    setActiveInput('none');
  };

  // Handle escape key to cancel input
  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Escape') {
      setActiveInput('none');
    }
  };

  // Handle opening documentation
  const handleOpenDocs = (guide: string) => {
    window.open(guide, '_blank', 'noopener,noreferrer');
  };

  return (
    <NodeViewWrapper className="embed-block w-full" ref={containerRef}>
      <div 
        ref={resizeRef}
        className={`relative bg-gray-100 rounded-lg overflow-hidden flex justify-center items-center ${alignment === 'center' ? 'mx-auto' : ''}`}
        style={getResponsiveStyles()}
      >
        {(embedUrl || sanitizedEmbedCode) ? (
          // Show the embed content if we have a URL or code
          <>
            {embedContent}
            
            {/* Minimal toolbar for existing embeds */}
            {isEditable && (
              <div className="absolute top-2 right-2 flex items-center gap-1.5 bg-white bg-opacity-90 backdrop-blur-xs rounded-lg p-1 shadow-xs transition-opacity opacity-70 hover:opacity-100">
                <button
                  onClick={() => setActiveInput(embedType)}
                  className="p-1.5 rounded-md hover:bg-gray-100 text-gray-600"
                  title="Edit embed"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3Z"></path>
                  </svg>
                </button>
                <button
                  onClick={handleCenterBlock}
                  className="p-1.5 rounded-md hover:bg-gray-100 text-gray-600"
                  title={alignment === 'center' ? 'Align left' : 'Center align'}
                >
                  <AlignCenter size={16} />
                </button>
                <button
                  onClick={() => {
                    setEmbedUrl('');
                    setEmbedCode('');
                    props.updateAttributes({ 
                      embedUrl: '',
                      embedCode: ''
                    });
                  }}
                  className="p-1.5 rounded-md hover:bg-gray-100 text-gray-600"
                  title="Remove embed"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M3 6h18"></path>
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                  </svg>
                </button>
              </div>
            )}
          </>
        ) : (
          // Show the embed selection UI if we don't have content yet
          <div className="w-full h-full flex flex-col items-center justify-center p-2 sm:p-6">
            <p className="text-gray-500 mb-2 sm:mb-4 font-medium tracking-tighter text-base sm:text-lg text-center">Add an embed from :</p>
            <div className="flex flex-wrap gap-2 sm:gap-5 justify-center">
              {supportedProducts.map((product) => (
                <button
                  key={product.name}
                  className="flex flex-col items-center group transition-transform hover:scale-110"
                  onClick={() => handleProductSelection(product)}
                  title={`Add ${product.name} embed`}
                >
                  <div className="w-8 h-8 sm:w-12 sm:h-12 rounded-lg flex items-center justify-center shadow-md group-hover:shadow-lg transition-shadow" style={{ backgroundColor: product.color }}>
                    <product.icon size={isMobile ? 16 : 24} color="#FFFFFF" />
                  </div>
                  <span className="text-xs mt-1 sm:mt-2 text-gray-700 group-hover:text-gray-900 font-medium">{product.name}</span>
                </button>
              ))}
            </div>
            
            <p className="text-xs text-gray-500 mt-3 mb-2 text-center max-w-md">
              Click a service to add an embed
            </p>
            
            {/* Direct input options */}
            {isEditable && (
              <div className="mt-4 flex gap-3 justify-center">
                <button
                  onClick={() => {
                    setEmbedType('url');
                    setActiveInput('url');
                  }}
                  className="flex items-center gap-1.5 px-3 py-1.5 bg-white rounded-lg shadow-xs hover:shadow-md transition-all text-sm text-gray-700"
                >
                  <LinkIcon size={14} />
                  <span>URL</span>
                </button>
                <button
                  onClick={() => {
                    setEmbedType('code');
                    setActiveInput('code');
                  }}
                  className="flex items-center gap-1.5 px-3 py-1.5 bg-white rounded-lg shadow-xs hover:shadow-md transition-all text-sm text-gray-700"
                >
                  <Code size={14} />
                  <span>Code</span>
                </button>
              </div>
            )}
          </div>
        )}
        
        {/* Inline input UI - appears in place without covering content */}
        {isEditable && activeInput !== 'none' && (
          <div className="absolute inset-0 bg-gray-100 bg-opacity-95 backdrop-blur-xs flex items-center justify-center p-4 z-10">
            <form 
              onSubmit={handleInputSubmit}
              className="w-full max-w-lg bg-white rounded-xl shadow-lg p-4"
              onKeyDown={handleKeyDown}
            >
              <div className="flex justify-between items-center mb-3">
                <div className="flex items-center gap-2">
                  {selectedProduct && activeInput === 'url' && (
                    <div 
                      className="w-8 h-8 rounded-lg flex items-center justify-center" 
                      style={{ backgroundColor: selectedProduct.color }}
                    >
                      <selectedProduct.icon size={18} color="#FFFFFF" />
                    </div>
                  )}
                  <h3 className="text-lg font-medium text-gray-800">
                    {activeInput === 'url' 
                      ? (selectedProduct ? `Add ${selectedProduct.name} Embed` : 'Add Embed URL') 
                      : 'Add Embed Code'}
                  </h3>
                </div>
                <button
                  type="button"
                  onClick={() => setActiveInput('none')}
                  className="p-1 rounded-full hover:bg-gray-100 text-gray-500"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
              
              {activeInput === 'url' ? (
                <>
                  <div className="relative mb-2">
                    <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-blue-500">
                      <LinkIcon size={16} />
                    </div>
                    <input
                      ref={urlInputRef}
                      type="text"
                      value={embedUrl}
                      onChange={handleUrlChange}
                      className="w-full pl-10 pr-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-hidden transition-all"
                      placeholder={selectedProduct ? `Paste ${selectedProduct.name} embed URL` : "Paste embed URL (YouTube, Spotify, etc.)"}
                      autoFocus
                    />
                  </div>
                  <div className="flex justify-between items-center mb-4">
                    <p className="text-xs text-gray-500">
                      Tip: Paste any {selectedProduct?.name || "YouTube, Spotify, or other"} embed URL directly
                    </p>
                    {selectedProduct && (
                      <button
                        type="button"
                        onClick={() => handleOpenDocs(selectedProduct.guide)}
                        className="text-xs text-blue-500 hover:text-blue-700 flex items-center gap-1"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                          <circle cx="12" cy="12" r="10"></circle>
                          <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                          <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        How to embed {selectedProduct.name}
                      </button>
                    )}
                  </div>
                </>
              ) : (
                <>
                  <div className="relative mb-2">
                    <textarea
                      ref={codeInputRef}
                      value={embedCode}
                      onChange={handleCodeChange}
                      className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl h-32 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-hidden transition-all font-mono text-sm"
                      placeholder="Paste embed code (iframe, embed script, etc.)"
                      autoFocus
                    />
                  </div>
                  <div className="flex justify-between items-center mb-4">
                    <p className="text-xs text-gray-500">
                      Tip: Paste iframe or embed code from any platform
                    </p>
                    {selectedProduct && (
                      <button
                        type="button"
                        onClick={() => handleOpenDocs(selectedProduct.guide)}
                        className="text-xs text-blue-500 hover:text-blue-700 flex items-center gap-1"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                          <circle cx="12" cy="12" r="10"></circle>
                          <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                          <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        How to embed {selectedProduct.name}
                      </button>
                    )}
                  </div>
                </>
              )}
              
              <div className="flex justify-end gap-2">
                <button
                  type="button"
                  onClick={() => setActiveInput('none')}
                  className="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 rounded-lg"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors"
                  disabled={(activeInput === 'url' && !embedUrl) || (activeInput === 'code' && !embedCode)}
                >
                  Apply
                </button>
              </div>
            </form>
          </div>
        )}
        
        {/* Resize handles */}
        {isEditable && (
          <>
            <div
              className="absolute right-0 top-0 bottom-0 w-4 cursor-ew-resize flex items-center justify-center bg-white bg-opacity-70 hover:bg-opacity-100 transition-opacity"
              onMouseDown={(e) => handleResizeStart(e, 'horizontal')}
            >
              <GripVertical size={16} className="text-gray-600" />
            </div>
            <div
              className="absolute left-0 right-0 bottom-0 h-4 cursor-ns-resize flex items-center justify-center bg-white bg-opacity-70 hover:bg-opacity-100 transition-opacity"
              onMouseDown={(e) => handleResizeStart(e, 'vertical')}
            >
              <GripHorizontal size={16} className="text-gray-600" />
            </div>
          </>
        )}
      </div>
    </NodeViewWrapper>
  )
}

export default EmbedObjectsComponent




================================================
FILE: apps/web/components/Objects/Editor/Extensions/Flipcard/Flipcard.ts
================================================
import { ReactNodeViewRenderer } from "@tiptap/react";
import { mergeAttributes, Node } from "@tiptap/core";
import FlipcardExtension from "./FlipcardExtension";

export default Node.create({
  name: "flipcard",
  group: "block",
  draggable: true,
  content: "text*",

  addAttributes() {
    return {
      question: {
        default: 'Click to reveal the answer',
      },
      answer: {
        default: 'This is the answer',
      },
      color: {
        default: 'blue',
      },
      alignment: {
        default: 'center',
      },
      size: {
        default: 'medium',
      },
    };
  },

  parseHTML() {
    return [
      {
        tag: "flipcard-block",
      },
    ];
  },

  renderHTML({ HTMLAttributes }) {
    return ["flipcard-block", mergeAttributes(HTMLAttributes), 0];
  },

  addNodeView() {
    return ReactNodeViewRenderer(FlipcardExtension);
  },
});



================================================
FILE: apps/web/components/Objects/Editor/Extensions/Flipcard/FlipcardExtension.tsx
================================================
import { NodeViewWrapper } from '@tiptap/react'
import React, { useState, useRef, useEffect } from 'react'
import { RotateCw, Edit, AlignLeft, AlignCenter, AlignRight, Palette, Maximize2, Minimize2, Square } from 'lucide-react'
import { twMerge } from 'tailwind-merge'
import { useEditorProvider } from '@components/Contexts/Editor/EditorContext'

const FlipcardExtension: React.FC = (props: any) => {
  const [isFlipped, setIsFlipped] = useState(false)
  const [question, setQuestion] = useState(props.node.attrs.question)
  const [answer, setAnswer] = useState(props.node.attrs.answer)
  const [color, setColor] = useState(props.node.attrs.color || 'blue')
  const [alignment, setAlignment] = useState(props.node.attrs.alignment || 'center')
  const [size, setSize] = useState(props.node.attrs.size || 'medium')
  const [showColorPicker, setShowColorPicker] = useState(false)
  const [isEditingQuestion, setIsEditingQuestion] = useState(false)
  const [isEditingAnswer, setIsEditingAnswer] = useState(false)
  const colorPickerRef = useRef<HTMLDivElement>(null)
  const questionInputRef = useRef<HTMLTextAreaElement>(null)
  const answerInputRef = useRef<HTMLTextAreaElement>(null)
  const editorState = useEditorProvider() as any
  const isEditable = editorState.isEditable

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (colorPickerRef.current && !colorPickerRef.current.contains(event.target as Node)) {
        setShowColorPicker(false)
      }
    }

    document.addEventListener('mousedown', handleClickOutside)
    return () => {
      document.removeEventListener('mousedown', handleClickOutside)
    }
  }, [])

  const handleFlip = () => {
    // Allow flipping in both edit and view modes, but prevent when editing text
    if (!isEditingQuestion && !isEditingAnswer) {
      setIsFlipped(!isFlipped)
    }
  }

  const handleQuestionChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    setQuestion(e.target.value)
    props.updateAttributes({
      question: e.target.value,
    })
  }

  const handleAnswerChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    setAnswer(e.target.value)
    props.updateAttributes({
      answer: e.target.value,
    })
  }

  const handleAlignmentChange = (newAlignment: 'left' | 'center' | 'right') => {
    setAlignment(newAlignment)
    props.updateAttributes({
      alignment: newAlignment,
    })
  }

  const handleColorSelect = (selectedColor: string) => {
    setColor(selectedColor)
    setShowColorPicker(false)
    props.updateAttributes({
      color: selectedColor,
    })
  }

  const handleSizeChange = (newSize: 'small' | 'medium' | 'large') => {
    setSize(newSize)
    props.updateAttributes({
      size: newSize,
    })
  }

  const getAlignmentClass = () => {
    switch (alignment) {
      case 'left': return 'text-left justify-start';
      case 'center': return 'text-center justify-center';
      case 'right': return 'text-right justify-end';
      default: return 'text-center justify-center';
    }
  }

  const getSizeClass = () => {
    switch (size) {
      case 'small': return 'w-64 h-36';
      case 'medium': return 'w-80 h-48';
      case 'large': return 'w-96 h-60';
      default: return 'w-80 h-48';
    }
  }

  const getFontSizeClass = () => {
    switch (size) {
      case 'small': return 'text-sm';
      case 'medium': return 'text-lg';
      case 'large': return 'text-xl';
      default: return 'text-lg';
    }
  }

  const getIconSizeClass = () => {
    switch (size) {
      case 'small': return 16;
      case 'medium': return 20;
      case 'large': return 24;
      default: return 20;
    }
  }

  const getCardColor = (color: string, isBack: boolean = false) => {
    const baseColors = {
      sky: isBack ? 'bg-sky-600 border-sky-700' : 'bg-sky-500 border-sky-600',
      green: isBack ? 'bg-green-600 border-green-700' : 'bg-green-500 border-green-600',
      yellow: isBack ? 'bg-yellow-600 border-yellow-700' : 'bg-yellow-500 border-yellow-600',
      red: isBack ? 'bg-red-600 border-red-700' : 'bg-red-500 border-red-600',
      purple: isBack ? 'bg-purple-600 border-purple-700' : 'bg-purple-500 border-purple-600',
      teal: isBack ? 'bg-teal-600 border-teal-700' : 'bg-teal-500 border-teal-600',
      amber: isBack ? 'bg-amber-600 border-amber-700' : 'bg-amber-500 border-amber-600',
      indigo: isBack ? 'bg-indigo-600 border-indigo-700' : 'bg-indigo-500 border-indigo-600',
      neutral: isBack ? 'bg-neutral-700 border-neutral-800' : 'bg-neutral-600 border-neutral-700',
      blue: isBack ? 'bg-blue-600 border-blue-700' : 'bg-blue-500 border-blue-600',
    }
    return baseColors[color as keyof typeof baseColors] || baseColors.blue
  }

  const colors = ['sky', 'green', 'yellow', 'red', 'purple', 'teal', 'amber', 'indigo', 'neutral', 'blue']

  const handleQuestionEdit = () => {
    setIsEditingQuestion(true)
    setTimeout(() => questionInputRef.current?.focus(), 0)
  }

  const handleAnswerEdit = () => {
    setIsEditingAnswer(true)
    setTimeout(() => answerInputRef.current?.focus(), 0)
  }

  const handleQuestionBlur = () => {
    setIsEditingQuestion(false)
  }

  const handleAnswerBlur = () => {
    setIsEditingAnswer(false)
  }

  return (
    <NodeViewWrapper className={`flipcard-wrapper flex ${getAlignmentClass()} my-4`}>
      <div className={`flipcard-container ${getSizeClass()} relative`}>
        <div 
          className={`flipcard-inner cursor-pointer ${
            isFlipped ? 'flipped' : ''
          }`}
          onClick={handleFlip}
        >
          {/* Front Side (Question) */}
          <div 
            className={twMerge(
              'flipcard-front border-2 text-white p-6 nice-shadow flex flex-col items-center justify-center text-center',
              getCardColor(color, false)
            )}
          >
            <div className="flex items-center justify-center mb-3 select-none pointer-events-none">
              <RotateCw size={getIconSizeClass()} className="opacity-70" />
            </div>
            <div className="flex-1 flex items-center justify-center">
              {isEditable && isEditingQuestion ? (
                <textarea
                  ref={questionInputRef}
                  value={question}
                  onChange={handleQuestionChange}
                  onBlur={handleQuestionBlur}
                  className="bg-white/20 backdrop-blur-sm text-white placeholder-white/70 p-2 rounded-lg w-full h-20 resize-none border-none outline-none text-center"
                  placeholder="Enter your question..."
                />
              ) : (
                <div className={`text-center font-medium ${getFontSizeClass()} leading-relaxed flex items-center justify-center select-none`}>
                  <span className="select-none pointer-events-none">{question}</span>
                  {isEditable && (
                    <button 
                      onClick={(e) => {
                        e.stopPropagation()
                        handleQuestionEdit()
                      }}
                      className="ml-2 opacity-60 hover:opacity-100 flex-shrink-0 pointer-events-auto"
                    >
                      <Edit size={14} />
                    </button>
                  )}
                </div>
              )}
            </div>
            {!isEditingQuestion && (
              <div className="text-xs opacity-70 mt-3 select-none pointer-events-none">Click to flip</div>
            )}
          </div>

          {/* Back Side (Answer) */}
          <div 
            className={twMerge(
              'flipcard-back border-2 text-white p-6 nice-shadow flex flex-col items-center justify-center text-center',
              getCardColor(color, true)
            )}
          >
            <div className="flex items-center justify-center mb-3 select-none pointer-events-none">
              <RotateCw size={getIconSizeClass()} className="opacity-70 rotate-180" />
            </div>
            <div className="flex-1 flex items-center justify-center">
              {isEditable && isEditingAnswer ? (
                <textarea
                  ref={answerInputRef}
                  value={answer}
                  onChange={handleAnswerChange}
                  onBlur={handleAnswerBlur}
                  className="bg-white/20 backdrop-blur-sm text-white placeholder-white/70 p-2 rounded-lg w-full h-20 resize-none border-none outline-none text-center"
                  placeholder="Enter your answer..."
                />
              ) : (
                <div className={`text-center font-medium ${getFontSizeClass()} leading-relaxed flex items-center justify-center select-none`}>
                  <span className="select-none pointer-events-none">{answer}</span>
                  {isEditable && (
                    <button 
                      onClick={(e) => {
                        e.stopPropagation()
                        handleAnswerEdit()
                      }}
                      className="ml-2 opacity-60 hover:opacity-100 flex-shrink-0 pointer-events-auto"
                    >
                      <Edit size={14} />
                    </button>
                  )}
                </div>
              )}
            </div>
            {!isEditingAnswer && (
              <div className="text-xs opacity-70 mt-3">Click to flip back</div>
            )}
          </div>
        </div>

        {/* Editor Controls */}
        {isEditable && (
          <div className="flex mt-3 space-x-1 justify-center opacity-60 hover:opacity-100 transition-opacity">
            <button 
              onClick={(e) => {
                e.stopPropagation()
                handleAlignmentChange('left')
              }} 
              className={`p-1.5 rounded-md transition-colors text-xs ${alignment === 'left' ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'}`}
              title="Align Left"
            >
              <AlignLeft size={12} />
            </button>
            <button 
              onClick={(e) => {
                e.stopPropagation()
                handleAlignmentChange('center')
              }} 
              className={`p-1.5 rounded-md transition-colors text-xs ${alignment === 'center' ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'}`}
              title="Align Center"
            >
              <AlignCenter size={12} />
            </button>
            <button 
              onClick={(e) => {
                e.stopPropagation()
                handleAlignmentChange('right')
              }} 
              className={`p-1.5 rounded-md transition-colors text-xs ${alignment === 'right' ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'}`}
              title="Align Right"
            >
              <AlignRight size={12} />
            </button>
            
            {/* Size Controls */}
            <div className="w-px h-4 bg-gray-300 self-center mx-1"></div>
            
            <button 
              onClick={(e) => {
                e.stopPropagation()
                handleSizeChange('small')
              }} 
              className={`p-1.5 rounded-md transition-colors text-xs ${size === 'small' ? 'bg-green-100 text-green-600' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'}`}
              title="Small Size"
            >
              <Minimize2 size={12} />
            </button>
            <button 
              onClick={(e) => {
                e.stopPropagation()
                handleSizeChange('medium')
              }} 
              className={`p-1.5 rounded-md transition-colors text-xs ${size === 'medium' ? 'bg-green-100 text-green-600' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'}`}
              title="Medium Size"
            >
              <Square size={12} />
            </button>
            <button 
              onClick={(e) => {
                e.stopPropagation()
                handleSizeChange('large')
              }} 
              className={`p-1.5 rounded-md transition-colors text-xs ${size === 'large' ? 'bg-green-100 text-green-600' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'}`}
              title="Large Size"
            >
              <Maximize2 size={12} />
            </button>
            
            <div className="w-px h-4 bg-gray-300 self-center mx-1"></div>
            
            <button 
              onClick={(e) => {
                e.stopPropagation()
                setShowColorPicker(!showColorPicker)
              }} 
              className="p-1.5 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-md transition-colors text-xs"
              title="Change Color"
            >
              <Palette size={12} />
            </button>
            <button
              onClick={(e) => {
                e.stopPropagation()
                setIsFlipped(!isFlipped)
              }}
              className="p-1.5 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-md transition-colors text-xs"
              title="Preview Flip"
            >
              <RotateCw size={12} />
            </button>
          </div>
        )}

        {/* Color Picker */}
        {isEditable && showColorPicker && (
          <div ref={colorPickerRef} className="absolute top-full mt-2 left-1/2 transform -translate-x-1/2 p-3 bg-white rounded-lg nice-shadow z-10">
            <div className="flex flex-wrap gap-2 max-w-xs">
              {colors.map((c) => (
                <button
                  key={c}
                  className={`w-8 h-8 rounded-full border-2 border-white hover:scale-110 transform transition-transform ${getCardColor(c)} ${color === c ? 'ring-2 ring-offset-2 ring-gray-400' : ''}`}
                  onClick={() => handleColorSelect(c)}
                  title={c.charAt(0).toUpperCase() + c.slice(1)}
                />
              ))}
            </div>
          </div>
        )}
      </div>
    </NodeViewWrapper>
  )
}

export default FlipcardExtension



================================================
FILE: apps/web/components/Objects/Editor/Extensions/Image/ImageBlock.ts
================================================
import { mergeAttributes, Node } from '@tiptap/core'
import { ReactNodeViewRenderer } from '@tiptap/react'

import ImageBlockComponent from './ImageBlockComponent'

export default Node.create({
  name: 'blockImage',
  group: 'block',

  atom: true,

  addAttributes() {
    return {
      blockObject: {
        default: null,
      },
      size: {
        width: 300,
      },
      alignment: {
        default: 'center',
      },
    }
  },

  parseHTML() {
    return [
      {
        tag: 'block-image',
      },
    ]
  },

  renderHTML({ HTMLAttributes }) {
    return ['block-image', mergeAttributes(HTMLAttributes), 0]
  },

  addNodeView() {
    return ReactNodeViewRenderer(ImageBlockComponent)
  },
})



================================================
FILE: apps/web/components/Objects/Editor/Extensions/Image/ImageBlockComponent.tsx
================================================
import { NodeViewWrapper } from '@tiptap/react'
import React, { useEffect } from 'react'
import { Resizable } from 're-resizable'
import { AlertTriangle, Image, Download, AlignLeft, AlignCenter, AlignRight, Expand } from 'lucide-react'
import { uploadNewImageFile } from '../../../../../services/blocks/Image/images'
import { getActivityBlockMediaDirectory } from '@services/media/media'
import { useOrg } from '@components/Contexts/OrgContext'
import { useCourse } from '@components/Contexts/CourseContext'
import { useEditorProvider } from '@components/Contexts/Editor/EditorContext'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { FileUploadBlock, FileUploadBlockButton, FileUploadBlockInput } from '../../FileUploadBlock'
import { constructAcceptValue } from '@/lib/constants';
import Modal from '@components/Objects/StyledElements/Modal/Modal'

const SUPPORTED_FILES = constructAcceptValue(['jpg', 'png', 'webp', 'gif'])

function ImageBlockComponent(props: any) {
  const org = useOrg() as any
  const course = useCourse() as any
  const editorState = useEditorProvider() as any
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token;

  const isEditable = editorState.isEditable
  const [image, setImage] = React.useState(null)
  const [isLoading, setIsLoading] = React.useState(false)
  const [blockObject, setblockObject] = React.useState(
    props.node.attrs.blockObject
  )
  const [imageSize, setImageSize] = React.useState({
    width: props.node.attrs.size ? props.node.attrs.size.width : 300,
  })
  const [alignment, setAlignment] = React.useState(props.node.attrs.alignment || 'center')
  const [isModalOpen, setIsModalOpen] = React.useState(false)
  
  const fileId = blockObject
    ? `${blockObject.content.file_id}.${blockObject.content.file_format}`
    : null

  const handleImageChange = (event: React.ChangeEvent<any>) => {
    setImage(event.target.files[0])
  }

  const handleSubmit = async (e: any) => {
    e.preventDefault()
    setIsLoading(true)
    let object = await uploadNewImageFile(
      image,
      props.extension.options.activity.activity_uuid,access_token
    )
    setIsLoading(false)
    setblockObject(object)
    props.updateAttributes({
      blockObject: object,
      size: imageSize,
      alignment: alignment,
    })
  }

  const handleDownload = () => {
    if (!fileId) return;
    
    const imageUrl = getActivityBlockMediaDirectory(
      org?.org_uuid,
      course?.courseStructure.course_uuid,
      props.extension.options.activity.activity_uuid,
      blockObject.block_uuid,
      fileId,
      'imageBlock'
    );
    
    const link = document.createElement('a');
    link.href = imageUrl || '';
    link.download = `image-${blockObject?.block_uuid || 'download'}.${blockObject?.content.file_format || 'jpg'}`;
    link.setAttribute('download', '');
    link.setAttribute('target', '_blank');
    link.setAttribute('rel', 'noopener noreferrer');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const handleExpand = () => {
    setIsModalOpen(true);
  };

  const handleAlignmentChange = (newAlignment: string) => {
    setAlignment(newAlignment);
    props.updateAttributes({
      alignment: newAlignment,
    });
  };

  const imageUrl = blockObject ? getActivityBlockMediaDirectory(
    org?.org_uuid,
    course?.courseStructure.course_uuid,
    props.extension.options.activity.activity_uuid,
    blockObject.block_uuid,
    fileId || '',
    'imageBlock'
  ) : null;

  useEffect(() => {}, [course, org])

  const getAlignmentClass = () => {
    switch (alignment) {
      case 'left':
        return 'justify-start';
      case 'right':
        return 'justify-end';
      default:
        return 'justify-center';
    }
  };

  return (
    <>
      <NodeViewWrapper className="block-image w-full">
       <FileUploadBlock isEditable={isEditable} isLoading={isLoading} isEmpty={!blockObject} Icon={Image}>
          <FileUploadBlockInput onChange={handleImageChange} accept={SUPPORTED_FILES} />
          <FileUploadBlockButton onClick={handleSubmit} disabled={!image}/>
        </FileUploadBlock>
        
        {blockObject && isEditable && (
          <div className={`w-full flex ${getAlignmentClass()}`}>
            <Resizable
              defaultSize={{ width: imageSize.width, height: '100%' }}
              handleStyles={{
                right: {
                  position: 'unset',
                  width: 7,
                  height: 30,
                  borderRadius: 20,
                  cursor: 'col-resize',
                  backgroundColor: 'black',
                  opacity: '0.3',
                  margin: 'auto',
                  marginLeft: 5,
                },
              }}
              style={{
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center',
                height: '100%',
                maxWidth: '100%',
              }}
              maxWidth="100%"
              minWidth={200}
              enable={{ right: true }}
              onResizeStop={(e, direction, ref, d) => {
                const newWidth = Math.min(imageSize.width + d.width, ref.parentElement?.clientWidth || 1000);
                props.updateAttributes({
                  size: {
                    width: newWidth,
                  },
                })
                setImageSize({
                  width: newWidth,
                })
              }}
            >
              <div className="relative">
                <img
                  src={imageUrl || ''}
                  alt=""
                  className="rounded-lg shadow-sm max-w-full h-auto"
                  style={{ width: '100%' }}
                />
                <div className="absolute top-2 right-2 flex items-center gap-1.5 bg-white bg-opacity-90 backdrop-blur-xs rounded-lg p-1 shadow-xs transition-opacity opacity-70 hover:opacity-100">
                  <button
                    onClick={() => handleAlignmentChange('left')}
                    className={`p-1.5 rounded-md hover:bg-gray-100 text-gray-600 ${alignment === 'left' ? 'bg-gray-100' : ''}`}
                    title="Align left"
                  >
                    <AlignLeft size={16} />
                  </button>
                  <button
                    onClick={() => handleAlignmentChange('center')}
                    className={`p-1.5 rounded-md hover:bg-gray-100 text-gray-600 ${alignment === 'center' ? 'bg-gray-100' : ''}`}
                    title="Center align"
                  >
                    <AlignCenter size={16} />
                  </button>
                  <button
                    onClick={() => handleAlignmentChange('right')}
                    className={`p-1.5 rounded-md hover:bg-gray-100 text-gray-600 ${alignment === 'right' ? 'bg-gray-100' : ''}`}
                    title="Align right"
                  >
                    <AlignRight size={16} />
                  </button>
                  <div className="w-px h-4 bg-gray-300"></div>
                  <button
                    onClick={handleExpand}
                    className="p-1.5 rounded-md hover:bg-gray-100 text-gray-600"
                    title="Expand image"
                  >
                    <Expand size={16} />
                  </button>
                </div>
              </div>
            </Resizable>
          </div>
        )}

        {blockObject && !isEditable && (
          <div className={`w-full flex ${getAlignmentClass()}`}>
            <div className="relative">
              <img
                src={imageUrl || ''}
                alt=""
                className="rounded-lg shadow-sm max-w-full h-auto"
                style={{ width: imageSize.width, maxWidth: '100%' }}
              />
              <div className="absolute top-2 right-2 flex gap-1">
                <button
                  onClick={handleExpand}
                  className="p-2 bg-black/50 hover:bg-black/70 rounded-full transition-colors"
                  title="Expand image"
                >
                  <Expand className="w-4 h-4 text-white" />
                </button>
                <button
                  onClick={handleDownload}
                  className="p-2 bg-black/50 hover:bg-black/70 rounded-full transition-colors"
                  title="Download image"
                >
                  <Download className="w-4 h-4 text-white" />
                </button>
              </div>
            </div>
          </div>
        )}

        {isLoading && (
          <div>
            <AlertTriangle color="#e1e0e0" size={50} />
          </div>
        )}
      </NodeViewWrapper>
      
      {blockObject && imageUrl && (
        <Modal
          isDialogOpen={isModalOpen}
          onOpenChange={setIsModalOpen}
          dialogTitle="Image Viewer"
          minWidth="lg"
          minHeight="lg"
          dialogContent={
            <div className="w-full flex items-center justify-center">
              <img
                src={imageUrl}
                alt=""
                className="max-w-full max-h-[80vh] object-contain rounded-lg shadow-lg"
              />
            </div>
          }
        />
      )}
    </>
  )
}

export default ImageBlockComponent


================================================
FILE: apps/web/components/Objects/Editor/Extensions/MathEquation/MathEquationBlock.ts
================================================
import { mergeAttributes, Node } from '@tiptap/core'
import { ReactNodeViewRenderer } from '@tiptap/react'

import MathEquationBlockComponent from './MathEquationBlockComponent'

export default Node.create({
  name: 'blockMathEquation',
  group: 'block',

  atom: true,

  addAttributes() {
    return {
      math_equation: {
        default: '',
      },
    }
  },

  parseHTML() {
    return [
      {
        tag: 'block-math-equation',
      },
    ]
  },

  renderHTML({ HTMLAttributes }) {
    return ['block-math-equation', mergeAttributes(HTMLAttributes), 0]
  },

  addNodeView() {
    return ReactNodeViewRenderer(MathEquationBlockComponent)
  },
})



================================================
FILE: apps/web/components/Objects/Editor/Extensions/MathEquation/MathEquationBlockComponent.tsx
================================================
import { NodeViewWrapper } from '@tiptap/react'
import React from 'react'
import styled from 'styled-components'
import 'katex/dist/katex.min.css'
import { BlockMath } from 'react-katex'
import { Save, Sigma, ExternalLink, ChevronDown, BookOpen, Lightbulb } from 'lucide-react'
import Link from 'next/link'
import { useEditorProvider } from '@components/Contexts/Editor/EditorContext'
import { motion } from 'framer-motion'

// Predefined LaTeX templates
const mathTemplates = [
  { 
    name: 'Fraction', 
    latex: '\\frac{a}{b}',
    description: 'Simple fraction'
  },
  { 
    name: 'Square Root', 
    latex: '\\sqrt{x}',
    description: 'Square root'
  },
  { 
    name: 'Summation', 
    latex: '\\sum_{i=1}^{n} x_i',
    description: 'Sum with limits'
  },
  { 
    name: 'Integral', 
    latex: '\\int_{a}^{b} f(x) \\, dx',
    description: 'Definite integral'
  },
  { 
    name: 'Limit', 
    latex: '\\lim_{x \\to \\infty} f(x)',
    description: 'Limit expression'
  },
  { 
    name: 'Matrix 2Ã—2', 
    latex: '\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix}',
    description: '2Ã—2 matrix with parentheses'
  },
  { 
    name: 'Binomial', 
    latex: '\\binom{n}{k}',
    description: 'Binomial coefficient'
  },
  { 
    name: 'Quadratic Formula', 
    latex: 'x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}',
    description: 'Solution to quadratic equation'
  },
  { 
    name: 'Vector', 
    latex: '\\vec{v} = \\begin{pmatrix} x \\\\ y \\\\ z \\end{pmatrix}',
    description: '3D vector'
  },
  { 
    name: 'System of Equations', 
    latex: '\\begin{cases} a_1x + b_1y = c_1 \\\\ a_2x + b_2y = c_2 \\end{cases}',
    description: 'System of linear equations'
  }
];

// Common LaTeX symbols
const mathSymbols = [
  { symbol: '\\alpha', display: 'Î±' },
  { symbol: '\\beta', display: 'Î²' },
  { symbol: '\\gamma', display: 'Î³' },
  { symbol: '\\delta', display: 'Î´' },
  { symbol: '\\theta', display: 'Î¸' },
  { symbol: '\\pi', display: 'Ï€' },
  { symbol: '\\sigma', display: 'Ïƒ' },
  { symbol: '\\infty', display: 'âˆ' },
  { symbol: '\\pm', display: 'Â±' },
  { symbol: '\\div', display: 'Ã·' },
  { symbol: '\\cdot', display: 'Â·' },
  { symbol: '\\leq', display: 'â‰¤' },
  { symbol: '\\geq', display: 'â‰¥' },
  { symbol: '\\neq', display: 'â‰ ' },
  { symbol: '\\approx', display: 'â‰ˆ' },
];

// Styled components
const MathEqWrapper = styled.div`
  transition: all 0.2s ease;
  background-color: #f9f9f9;
  border: 1px solid #eaeaea;
`

const EditBar = styled.div`
  display: flex;
  justify-content: space-between;
  border-radius: 8px;
  padding: 0 5px 0 12px;
  background-color: white;
  color: #5252528d;
  align-items: center;
  height: 45px;
  border: solid 1px #e2e2e2;
  transition: all 0.2s ease;
  
  &:focus-within {
    border-color: #d1d1d1;
    box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.03);
  }

  input {
    border: none;
    background: none;
    font-size: 14px;
    color: #494949;
    width: 100%;
    font-family: 'DM Sans', sans-serif;
    
    &:focus {
      outline: none;
    }

    &::placeholder {
      color: #49494980;
    }
  }
`

const SaveButton = styled(motion.button)`
  display: flex;
  align-items: center;
  justify-content: center;
  width: 30px;
  height: 30px;
  border-radius: 6px;
  border: none;
  background: rgba(217, 217, 217, 0.5);
  color: #494949;
  cursor: pointer;
`

const InfoLink = styled.div`
  padding-left: 2px;
`

const TemplateButton = styled.button`
  display: flex;
  align-items: center;
  padding: 6px 10px;
  background: rgba(217, 217, 217, 0.4);
  border-radius: 6px;
  border: none;
  font-size: 13px;
  color: #494949;
  cursor: pointer;
`

const TemplateDropdown = styled.div`
  background: white;
  border-radius: 8px;
  border: 1px solid #e2e2e2;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  overflow: hidden;
`

const TemplateItem = styled.div`
  padding: 8px 12px;
  cursor: pointer;
  transition: background 0.15s;
  
  &:hover {
    background: rgba(217, 217, 217, 0.24);
  }
`

const SymbolsDropdown = styled.div`
  background: white;
  border-radius: 8px;
  border: 1px solid #e2e2e2;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  overflow: hidden;
`

const SymbolButton = styled.button`
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  margin: 2px;
  background: rgba(217, 217, 217, 0.3);
  border-radius: 4px;
  border: none;
  font-size: 16px;
  color: #494949;
  cursor: pointer;
`

const HelpDropdown = styled.div`
  background: white;
  border-radius: 8px;
  border: 1px solid #e2e2e2;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  overflow: hidden;
`

function MathEquationBlockComponent(props: any) {
  const [equation, setEquation] = React.useState(props.node.attrs.math_equation)
  const [isEditing, setIsEditing] = React.useState(true)
  const [showTemplates, setShowTemplates] = React.useState(false)
  const [showSymbols, setShowSymbols] = React.useState(false)
  const [showHelp, setShowHelp] = React.useState(false)
  const editorState = useEditorProvider() as any
  const isEditable = editorState.isEditable
  const inputRef = React.useRef<HTMLInputElement>(null)
  const templatesRef = React.useRef<HTMLDivElement>(null)
  const symbolsRef = React.useRef<HTMLDivElement>(null)
  const helpRef = React.useRef<HTMLDivElement>(null)

  // Close dropdowns when clicking outside
  React.useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (templatesRef.current && !templatesRef.current.contains(event.target as Node)) {
        setShowTemplates(false)
      }
      if (symbolsRef.current && !symbolsRef.current.contains(event.target as Node)) {
        setShowSymbols(false)
      }
      if (helpRef.current && !helpRef.current.contains(event.target as Node)) {
        setShowHelp(false)
      }
    }

    document.addEventListener('mousedown', handleClickOutside)
    return () => {
      document.removeEventListener('mousedown', handleClickOutside)
    }
  }, [])

  const handleEquationChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    setEquation(event.target.value)
    props.updateAttributes({
      math_equation: event.target.value,
    })
  }

  const saveEquation = () => {
    props.updateAttributes({
      math_equation: equation,
    })
    //setIsEditing(false);
  }

  const insertTemplate = (template: string) => {
    setEquation(template)
    props.updateAttributes({
      math_equation: template,
    })
    setShowTemplates(false)
    
    // Focus the input and place cursor at the end
    if (inputRef.current) {
      inputRef.current.focus()
      inputRef.current.setSelectionRange(template.length, template.length)
    }
  }

  const insertSymbol = (symbol: string) => {
    const cursorPosition = inputRef.current?.selectionStart || equation.length
    const newEquation = equation.substring(0, cursorPosition) + symbol + equation.substring(cursorPosition)
    
    setEquation(newEquation)
    props.updateAttributes({
      math_equation: newEquation,
    })
    
    // Focus the input and place cursor after the inserted symbol
    setTimeout(() => {
      if (inputRef.current) {
        inputRef.current.focus()
        inputRef.current.setSelectionRange(cursorPosition + symbol.length, cursorPosition + symbol.length)
      }
    }, 0)
  }

  return (
    <NodeViewWrapper className="block-math-equation">
      <motion.div
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.3 }}
      >
        <MathEqWrapper className="flex flex-col space-y-3 rounded-lg py-6 px-5">
          <div className="flex items-center space-x-2 text-sm text-zinc-500 mb-1">
            <Sigma size={16} />
            <span className="font-medium">Math Equation</span>
          </div>
          
          <div className="bg-white p-4 rounded-md nice-shadow">
            <BlockMath>{equation}</BlockMath>
          </div>
          
          {isEditing && isEditable && (
            <motion.div
              initial={{ opacity: 0, height: 0 }}
              animate={{ opacity: 1, height: 'auto' }}
              transition={{ duration: 0.2 }}
              className="space-y-3"
            >
              <div className="flex space-x-2">
                <div ref={templatesRef} className="relative">
                  <TemplateButton 
                    onClick={() => setShowTemplates(!showTemplates)}
                    className="flex items-center space-x-1"
                  >
                    <BookOpen size={14} />
                    <span>Templates</span>
                    <ChevronDown size={14} className={`transition-transform ${showTemplates ? 'rotate-180' : ''}`} />
                  </TemplateButton>
                  
                  {showTemplates && (
                    <TemplateDropdown className="absolute left-0 mt-1 z-10 w-64 max-h-80 overflow-y-auto">
                      <div className="p-2 text-xs text-zinc-500 border-b">
                        Select a template to insert
                      </div>
                      {mathTemplates.map((template, index) => (
                        <TemplateItem 
                          key={index} 
                          onClick={() => insertTemplate(template.latex)}
                        >
                          <div className="flex flex-col">
                            <span className="font-medium">{template.name}</span>
                            <span className="text-xs text-zinc-500">{template.description}</span>
                          </div>
                        </TemplateItem>
                      ))}
                    </TemplateDropdown>
                  )}
                </div>
                
                <div ref={symbolsRef} className="relative">
                  <TemplateButton 
                    onClick={() => setShowSymbols(!showSymbols)}
                    className="flex items-center space-x-1"
                  >
                    <Sigma size={14} />
                    <span>Symbols</span>
                    <ChevronDown size={14} className={`transition-transform ${showSymbols ? 'rotate-180' : ''}`} />
                  </TemplateButton>
                  
                  {showSymbols && (
                    <SymbolsDropdown className="absolute left-0 mt-1 z-10 w-64">
                      <div className="p-2 text-xs text-zinc-500 border-b">
                        Click a symbol to insert
                      </div>
                      <div className="flex flex-wrap p-2">
                        {mathSymbols.map((symbol, index) => (
                          <SymbolButton 
                            key={index} 
                            onClick={() => insertSymbol(symbol.symbol)}
                            title={symbol.symbol}
                          >
                            {symbol.display}
                          </SymbolButton>
                        ))}
                      </div>
                    </SymbolsDropdown>
                  )}
                </div>
                
                <div ref={helpRef} className="relative">
                  <TemplateButton 
                    onClick={() => setShowHelp(!showHelp)}
                    className="flex items-center space-x-1"
                  >
                    <Lightbulb size={14} />
                    <span>Help</span>
                    <ChevronDown size={14} className={`transition-transform ${showHelp ? 'rotate-180' : ''}`} />
                  </TemplateButton>
                  
                  {showHelp && (
                    <HelpDropdown className="absolute left-0 mt-1 z-10 w-72">
                      <div className="p-2 text-xs font-medium text-zinc-700 border-b">
                        LaTeX Math Quick Reference
                      </div>
                      <div className="p-3 text-xs space-y-2">
                        <div>
                          <span className="font-medium">Fractions:</span> \frac{'{'}'numerator'{'}'}{'{'}denominator{'}'}
                        </div>
                        <div>
                          <span className="font-medium">Exponents:</span> x^{'{'}'power'{'}'}
                        </div>
                        <div>
                          <span className="font-medium">Subscripts:</span> x_{'{'}'subscript'{'}'}
                        </div>
                        <div>
                          <span className="font-medium">Square root:</span> \sqrt{'{'}'x'{'}'}
                        </div>
                        <div>
                          <span className="font-medium">Summation:</span> \sum_{'{'}'lower'{'}'}^{'{'}'upper'{'}'}
                        </div>
                        <div>
                          <span className="font-medium">Integral:</span> \int_{'{'}'lower'{'}'}^{'{'}'upper'{'}'}
                        </div>
                        <div className="pt-1 border-t">
                          <Link
                            className="text-blue-600 hover:text-blue-800 font-medium flex items-center"
                            href="https://katex.org/docs/supported.html"
                            target="_blank"
                          >
                            View complete reference
                            <ExternalLink size={10} className="ml-1" />
                          </Link>
                        </div>
                      </div>
                    </HelpDropdown>
                  )}
                </div>
              </div>
              
              <EditBar>
                <input
                  ref={inputRef}
                  value={equation}
                  onChange={handleEquationChange}
                  placeholder="Insert a Math Equation (LaTeX)"
                  type="text"
                  className="focus:ring-1 focus:ring-blue-300"
                />
                <SaveButton 
                  onClick={() => saveEquation()}
                  whileHover={{ scale: 1.05 }}
                  whileTap={{ scale: 0.95 }}
                >
                  <Save size={15} />
                </SaveButton>
              </EditBar>
              
              <InfoLink className="flex items-center text-zinc-500 text-sm">
                <span>Please refer to this</span>
                <Link
                  className="inline-flex items-center mx-1 text-blue-600 hover:text-blue-800 font-medium"
                  href="https://katex.org/docs/supported.html"
                  target="_blank"
                >
                  guide
                  <ExternalLink size={12} className="ml-1" />
                </Link>
                <span>for supported TeX functions</span>
              </InfoLink>
            </motion.div>
          )}
        </MathEqWrapper>
      </motion.div>
    </NodeViewWrapper>
  )
}

export default MathEquationBlockComponent



================================================
FILE: apps/web/components/Objects/Editor/Extensions/NoTextInput/NoTextInput.tsx
================================================
import { Extension } from '@tiptap/core'
import { Plugin, PluginKey } from 'prosemirror-state'

export const NoTextInput = Extension.create({
  name: 'noTextInput',

  addProseMirrorPlugins() {
    return [
      new Plugin({
        key: new PluginKey('noTextInput'),
        filterTransaction: (transaction) => {
          // Block all content-changing transactions
          return !transaction.docChanged
        },
      }),
    ]
  },
})



================================================
FILE: apps/web/components/Objects/Editor/Extensions/PDF/PDFBlock.ts
================================================
import { mergeAttributes, Node } from '@tiptap/core'
import { ReactNodeViewRenderer } from '@tiptap/react'

import PDFBlockComponent from './PDFBlockComponent'

export default Node.create({
  name: 'blockPDF',
  group: 'block',

  atom: true,

  addAttributes() {
    return {
      blockObject: {
        default: null,
      },
    }
  },

  parseHTML() {
    return [
      {
        tag: 'block-pdf',
      },
    ]
  },

  renderHTML({ HTMLAttributes }) {
    return ['block-pdf', mergeAttributes(HTMLAttributes), 0]
  },

  addNodeView() {
    return ReactNodeViewRenderer(PDFBlockComponent)
  },
})



================================================
FILE: apps/web/components/Objects/Editor/Extensions/PDF/PDFBlockComponent.tsx
================================================
import { NodeViewWrapper } from '@tiptap/react'
import React, { useEffect } from 'react'
import styled from 'styled-components'
import { AlertTriangle, FileText, Download, Expand } from 'lucide-react'
import { uploadNewPDFFile } from '../../../../../services/blocks/Pdf/pdf'
import { getActivityBlockMediaDirectory } from '@services/media/media'
import { useOrg } from '@components/Contexts/OrgContext'
import { useCourse } from '@components/Contexts/CourseContext'
import { useEditorProvider } from '@components/Contexts/Editor/EditorContext'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { FileUploadBlock, FileUploadBlockButton, FileUploadBlockInput } from '../../FileUploadBlock'
import { constructAcceptValue } from '@/lib/constants';
import Modal from '@components/Objects/StyledElements/Modal/Modal'

const SUPPORTED_FILES = constructAcceptValue(['pdf'])

function PDFBlockComponent(props: any) {
  const org = useOrg() as any
  const course = useCourse() as any
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token;
  const [pdf, setPDF] = React.useState(null)
  const [isLoading, setIsLoading] = React.useState(false)
  const [blockObject, setblockObject] = React.useState(
    props.node.attrs.blockObject
  )
  const [isModalOpen, setIsModalOpen] = React.useState(false)
  const fileId = blockObject
    ? `${blockObject.content.file_id}.${blockObject.content.file_format}`
    : null
  const editorState = useEditorProvider() as any
  const isEditable = editorState.isEditable

  const handlePDFChange = (event: React.ChangeEvent<any>) => {
    setPDF(event.target.files[0])
  }

  const handleSubmit = async (e: any) => {
    e.preventDefault()
    setIsLoading(true)
    let object = await uploadNewPDFFile(
      pdf,
      props.extension.options.activity.activity_uuid, access_token
    )
    setIsLoading(false)
    setblockObject(object)
    props.updateAttributes({
      blockObject: object,
    })
  }

  const handleDownload = () => {
    if (!fileId) return;
    
    const pdfUrl = getActivityBlockMediaDirectory(
      org?.org_uuid,
      course?.courseStructure.course_uuid,
      props.extension.options.activity.activity_uuid,
      blockObject.block_uuid,
      fileId,
      'pdfBlock'
    );
    
    const link = document.createElement('a');
    link.href = pdfUrl || '';
    link.download = `document-${blockObject?.block_uuid || 'download'}.${blockObject?.content.file_format || 'pdf'}`;
    link.setAttribute('download', '');
    link.setAttribute('target', '_blank');
    link.setAttribute('rel', 'noopener noreferrer');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const handleExpand = () => {
    setIsModalOpen(true);
  };

  const pdfUrl = blockObject ? getActivityBlockMediaDirectory(
    org?.org_uuid,
    course?.courseStructure.course_uuid,
    props.extension.options.activity.activity_uuid,
    blockObject.block_uuid,
    fileId || '',
    'pdfBlock'
  ) : null;

  useEffect(() => { }, [course, org])

  return (
    <>
      <NodeViewWrapper className="block-pdf">
        <FileUploadBlock isEditable={isEditable} isLoading={isLoading} isEmpty={!blockObject} Icon={FileText}>
          <FileUploadBlockInput onChange={handlePDFChange} accept={SUPPORTED_FILES} />
          <FileUploadBlockButton onClick={handleSubmit} disabled={!pdf}/>
        </FileUploadBlock>
        
        {blockObject && (
          <BlockPDF>
            <div className="relative">
              <iframe
                className="shadow-sm rounded-lg h-96 w-full object-scale-down bg-black"
                src={pdfUrl || ''}
              />
              <div className="absolute top-2 right-2 flex gap-1">
                <button
                  onClick={handleExpand}
                  className="p-2 bg-black/50 hover:bg-black/70 rounded-full transition-colors"
                  title="Expand PDF"
                >
                  <Expand className="w-4 h-4 text-white" />
                </button>
                {!isEditable && (
                  <button
                    onClick={handleDownload}
                    className="p-2 bg-black/50 hover:bg-black/70 rounded-full transition-colors"
                    title="Download PDF"
                  >
                    <Download className="w-4 h-4 text-white" />
                  </button>
                )}
              </div>
            </div>
          </BlockPDF>
        )}
        {isLoading && (
          <div>
            <AlertTriangle color="#e1e0e0" size={50} />
          </div>
        )}
      </NodeViewWrapper>
      
      {blockObject && pdfUrl && (
        <Modal
          isDialogOpen={isModalOpen}
          onOpenChange={setIsModalOpen}
          dialogTitle="PDF Document"
          minWidth="xl"
          minHeight="xl"
          dialogContent={
            <div className="w-full h-[80vh]">
              <iframe
                className="w-full h-full rounded-lg shadow-lg border"
                src={pdfUrl}
                title="PDF Document"
              />
            </div>
          }
        />
      )}
    </>
  )
}

export default PDFBlockComponent

const BlockPDF = styled.div`
  display: flex;
  flex-direction: column;
  img {
    width: 100%;
    border-radius: 6px;
    height: 300px;
    // cover
    object-fit: cover;
  }
`
const PDFNotFound = styled.div``



================================================
FILE: apps/web/components/Objects/Editor/Extensions/Quiz/QuizBlock.ts
================================================
import { mergeAttributes, Node } from '@tiptap/core'
import { ReactNodeViewRenderer } from '@tiptap/react'

import QuizBlockComponent from './QuizBlockComponent'

export default Node.create({
  name: 'blockQuiz',
  group: 'block',
  atom: true,

  addAttributes() {
    return {
      quizId: {
        value: null,
      },
      questions: {
        default: [],
      },
    }
  },

  parseHTML() {
    return [
      {
        tag: 'block-quiz',
      },
    ]
  },

  renderHTML({ HTMLAttributes }) {
    return ['block-quiz', mergeAttributes(HTMLAttributes), 0]
  },

  addNodeView() {
    return ReactNodeViewRenderer(QuizBlockComponent)
  },
})



================================================
FILE: apps/web/components/Objects/Editor/Extensions/Quiz/QuizBlockComponent.tsx
================================================
import { NodeViewWrapper } from '@tiptap/react'
import { v4 as uuidv4 } from 'uuid'
import { twMerge } from 'tailwind-merge'
import React from 'react'
import { BadgeHelp, Check, Minus, Plus, RefreshCcw } from 'lucide-react'
import ReactConfetti from 'react-confetti'
import { useEditorProvider } from '@components/Contexts/Editor/EditorContext'

interface Answer {
  answer_id: string
  answer: string
  correct: boolean
}
interface Question {
  question_id: string
  question: string
  type: 'multiple_choice' | 'custom_answer'
  answers: Answer[]
}

function QuizBlockComponent(props: any) {
  const [questions, setQuestions] = React.useState(
    props.node.attrs.questions
  ) as [Question[], any]
  const [userAnswers, setUserAnswers] = React.useState([]) as [any[], any]
  const [submitted, setSubmitted] = React.useState(false) as [boolean, any]
  const [submissionMessage, setSubmissionMessage] = React.useState('') as [
    string,
    any,
  ]
  const editorState = useEditorProvider() as any
  const isEditable = editorState.isEditable

  const handleAnswerClick = (question_id: string, answer_id: string) => {
    if (submitted) return;

    const existingAnswerIndex = userAnswers.findIndex(
      (answer: any) => answer.question_id === question_id && answer.answer_id === answer_id
    );

    if (existingAnswerIndex !== -1) {
      // Remove the answer if it's already selected
      setUserAnswers(userAnswers.filter((_, index) => index !== existingAnswerIndex));
    } else {
      // Add the answer
      setUserAnswers([...userAnswers, { question_id, answer_id }]);
    }
  }

  const refreshUserSubmission = () => {
    setUserAnswers([])
    setSubmitted(false)
    setSubmissionMessage('')
  }

  const handleUserSubmission = () => {
    setSubmitted(true);

    const correctAnswers = questions.every((question: Question) => {
      const correctAnswers = question.answers.filter((answer: Answer) => answer.correct);
      const userAnswersForQuestion = userAnswers.filter(
        (userAnswer: any) => userAnswer.question_id === question.question_id
      );

      // If no correct answers are set and user didn't select any, it's correct
      if (correctAnswers.length === 0 && userAnswersForQuestion.length === 0) {
        return true;
      }

      // Check if user selected all correct answers and no incorrect ones
      return (
        correctAnswers.length === userAnswersForQuestion.length &&
        correctAnswers.every((correctAnswer: Answer) =>
          userAnswersForQuestion.some(
            (userAnswer: any) => userAnswer.answer_id === correctAnswer.answer_id
          )
        )
      );
    });

    setSubmissionMessage(correctAnswers ? 'All answers are correct!' : 'Some answers are incorrect!');
  }

  const getAnswerID = (answerIndex: number, questionId: string) => {
    const alphabet = Array.from({ length: 26 }, (_, i) =>
      String.fromCharCode('A'.charCodeAt(0) + i)
    )
    let alphabetID = alphabet[answerIndex]

    // Get question index
    const questionIndex = questions.findIndex(
      (question: Question) => question.question_id === questionId
    )
    let questionID = questionIndex + 1

    return `${alphabetID}`
  }

  const saveQuestions = (questions: any) => {
    props.updateAttributes({
      questions: questions,
    })
    setQuestions(questions)
  }
  const addSampleQuestion = () => {
    const newQuestion = {
      question_id: uuidv4(),
      question: '',
      type: 'multiple_choice',
      answers: [
        {
          answer_id: uuidv4(),
          answer: '',
          correct: false,
        },
      ],
    }
    setQuestions([...questions, newQuestion])
  }

  const addAnswer = (question_id: string) => {
    const newAnswer = {
      answer_id: uuidv4(),
      answer: '',
      correct: false,
    }

    // check if there is already more than 5 answers
    const question: any = questions.find(
      (question: Question) => question.question_id === question_id
    )
    if (question.answers.length >= 5) {
      return
    }

    const newQuestions = questions.map((question: Question) => {
      if (question.question_id === question_id) {
        question.answers.push(newAnswer)
      }
      return question
    })

    saveQuestions(newQuestions)
  }

  const changeAnswerValue = (
    question_id: string,
    answer_id: string,
    value: string
  ) => {
    const newQuestions = questions.map((question: Question) => {
      if (question.question_id === question_id) {
        question.answers.map((answer: Answer) => {
          if (answer.answer_id === answer_id) {
            answer.answer = value
          }
          return answer
        })
      }
      return question
    })
    saveQuestions(newQuestions)
  }

  const changeQuestionValue = (question_id: string, value: string) => {
    const newQuestions = questions.map((question: Question) => {
      if (question.question_id === question_id) {
        question.question = value
      }
      return question
    })
    saveQuestions(newQuestions)
  }

  const deleteQuestion = (question_id: string) => {
    const newQuestions = questions.filter(
      (question: Question) => question.question_id !== question_id
    )
    saveQuestions(newQuestions)
  }

  const deleteAnswer = (question_id: string, answer_id: string) => {
    const newQuestions = questions.map((question: Question) => {
      if (question.question_id === question_id) {
        question.answers = question.answers.filter(
          (answer: Answer) => answer.answer_id !== answer_id
        )
      }
      return question
    })
    saveQuestions(newQuestions)
  }

  const markAnswerCorrect = (question_id: string, answer_id: string) => {
    const newQuestions = questions.map((question: Question) => {
      if (question.question_id === question_id) {
        question.answers = question.answers.map((answer: Answer) => ({
          ...answer,
          correct: answer.answer_id === answer_id ? !answer.correct : answer.correct,
        }));
      }
      return question;
    });
    saveQuestions(newQuestions);
  }

  return (
    <NodeViewWrapper className="block-quiz">
      <div
        className="rounded-xl px-3 sm:px-5 py-2 bg-slate-100 transition-all ease-linear"
      >
        {/* Header section */}
        <div className="flex flex-wrap gap-2 pt-1 items-center text-sm">
          {submitted && submissionMessage === 'All answers are correct!' && (
            <ReactConfetti
              numberOfPieces={submitted ? 1400 : 0}
              recycle={false}
              className="w-full h-screen"
            />
          )}
          <div className="flex space-x-2 items-center text-sm">
            <BadgeHelp className="text-slate-400" size={15} />
            <p className="uppercase tracking-widest text-xs font-bold py-1 text-slate-400">
              Quiz
            </p>
          </div>
          
          {/* Submission message */}
          {submitted && (
            <div className={`text-xs font-medium px-2 py-1 rounded-md ${
              submissionMessage === 'All answers are correct!' 
                ? 'bg-lime-100 text-lime-700' 
                : 'bg-red-100 text-red-700'
            }`}>
              {submissionMessage}
            </div>
          )}
          
          <div className="grow"></div>
          
          {/* Action buttons */}
          {isEditable ? (
            <div>
              <button
                onClick={addSampleQuestion}
                className="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-1 px-2 rounded-lg text-xs"
              >
                Add Question
              </button>
            </div>
          ) : (
            <div className="flex space-x-1 items-center">
              <div
                onClick={() => refreshUserSubmission()}
                className="cursor-pointer p-1.5 rounded-md hover:bg-slate-200"
                title="Reset answers"
              >
                <RefreshCcw
                  className="text-slate-500"
                  size={15}
                />
              </div>
              <button
                onClick={() => handleUserSubmission()}
                className="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-1 px-2 rounded-lg text-xs"
              >
                Submit
              </button>
            </div>
          )}
        </div>

        {/* Questions section */}
        {questions.map((question: Question) => (
          <div key={question.question_id} className="pt-3 space-y-2">
            <div className="question">
              <div className="flex space-x-2 items-center">
                <div className="grow">
                  {isEditable ? (
                    <input
                      value={question.question}
                      placeholder="Your Question"
                      onChange={(e) =>
                        changeQuestionValue(
                          question.question_id,
                          e.target.value
                        )
                      }
                      className="text-slate-800 bg-[#00008b00] border-2 border-gray-200 rounded-md border-dotted text-md font-bold w-full p-2"
                    ></input>
                  ) : (
                    <p className="text-slate-800 bg-[#00008b00] rounded-md text-md font-bold w-full p-2 break-words">
                      {question.question}
                    </p>
                  )}
                </div>
                {isEditable && (
                  <div
                    onClick={() => deleteQuestion(question.question_id)}
                    className="w-[24px] flex-none flex items-center h-[24px] rounded-lg bg-slate-200 hover:bg-slate-300 text-sm transition-all ease-linear cursor-pointer"
                  >
                    <Minus className="mx-auto text-slate-500" size={14} />
                  </div>
                )}
              </div>
              
              {/* Answers section - changed to vertical layout for better responsiveness */}
              <div className="answers flex flex-col py-2 space-y-2">
                {question.answers.map((answer: Answer) => (
                  <div
                    key={answer.answer_id}
                    className={twMerge(
                      'outline outline-2 pr-2 shadow-sm w-full flex items-stretch space-x-2 min-h-[36px] bg-opacity-50 hover:bg-opacity-100 hover:shadow-md rounded-lg bg-white text-sm duration-150 cursor-pointer ease-linear',
                      answer.correct && isEditable ? 'outline-lime-300' : 'outline-white',
                      userAnswers.some(
                        (userAnswer: any) =>
                          userAnswer.question_id === question.question_id &&
                          userAnswer.answer_id === answer.answer_id &&
                          !isEditable && !submitted
                      ) ? 'outline-blue-400' : '',
                      submitted && answer.correct ? 'outline-lime-300 text-lime' : '',
                      submitted &&
                        !answer.correct &&
                        userAnswers.some(
                          (userAnswer: any) =>
                            userAnswer.question_id === question.question_id &&
                            userAnswer.answer_id === answer.answer_id
                        ) ? 'outline-red-400' : ''
                    )}
                    onClick={() =>
                      handleAnswerClick(question.question_id, answer.answer_id)
                    }
                  >
                    <div
                      className={twMerge(
                        'font-bold text-base flex items-center justify-center self-stretch w-[40px] rounded-l-md text-slate-800 bg-white',
                        answer.correct && isEditable
                          ? 'bg-lime-300 text-lime-800 outline-hidden'
                          : 'bg-white',
                        userAnswers.some(
                          (userAnswer: any) =>
                            userAnswer.question_id === question.question_id &&
                            userAnswer.answer_id === answer.answer_id &&
                            !isEditable && !submitted
                        ) ? 'bg-blue-400 text-white outline-hidden' : '',
                        submitted && answer.correct
                          ? 'bg-lime-300 text-lime-800 outline-hidden'
                          : '',
                        submitted &&
                          !answer.correct &&
                          userAnswers.some(
                            (userAnswer: any) =>
                              userAnswer.question_id === question.question_id &&
                              userAnswer.answer_id === answer.answer_id
                          )
                          ? 'bg-red-400 text-red-800 outline-hidden'
                          : ''
                      )}
                    >
                      <p className="font-bold text-sm">
                        {getAnswerID(
                          question.answers.indexOf(answer),
                          question.question_id
                        )}
                      </p>
                    </div>
                    {isEditable ? (
                      <input
                        value={answer.answer}
                        onChange={(e) =>
                          changeAnswerValue(
                            question.question_id,
                            answer.answer_id,
                            e.target.value
                          )
                        }
                        placeholder="Answer"
                        className="w-full mx-2 px-3 pr-6 text-neutral-600 bg-[#00008b00] border-2 border-gray-200 rounded-md border-dotted text-sm font-bold py-1.5"
                      ></input>
                    ) : (
                      <p className="w-full mx-2 px-3 pr-6 text-neutral-600 bg-[#00008b00] rounded-md text-sm font-bold py-1.5 break-words">
                        {answer.answer}
                      </p>
                    )}
                    {isEditable && (
                      <div className="flex space-x-1 items-center">
                        <div
                          onClick={(e) => {
                            e.stopPropagation();
                            markAnswerCorrect(
                              question.question_id,
                              answer.answer_id
                            );
                          }}
                          className="w-[24px] flex-none flex items-center h-[24px] rounded-lg bg-lime-300 hover:bg-lime-400 transition-all ease-linear text-sm cursor-pointer"
                          title={answer.correct ? "Mark as incorrect" : "Mark as correct"}
                        >
                          <Check className="mx-auto text-lime-800" size={14} />
                        </div>
                        <div
                          onClick={(e) => {
                            e.stopPropagation();
                            deleteAnswer(question.question_id, answer.answer_id);
                          }}
                          className="w-[24px] flex-none flex items-center h-[24px] rounded-lg bg-slate-200 hover:bg-slate-300 text-sm transition-all ease-linear cursor-pointer"
                          title="Delete answer"
                        >
                          <Minus className="mx-auto text-slate-500" size={14} />
                        </div>
                      </div>
                    )}
                  </div>
                ))}
                {isEditable && (
                  <div
                    onClick={() => addAnswer(question.question_id)}
                    className="outline outline-2 w-full flex-none flex items-center h-[36px] outline-white hover:bg-opacity-100 hover:shadow-md rounded-lg bg-white text-sm hover:scale-[1.01] active:scale-[1.02] duration-150 cursor-pointer ease-linear justify-center"
                  >
                    <Plus className="text-slate-800 mr-1" size={15} />
                    <span className="text-slate-800 text-sm">Add Answer</span>
                  </div>
                )}
              </div>
            </div>
          </div>
        ))}
      </div>
    </NodeViewWrapper>
  )
}

export default QuizBlockComponent



================================================
FILE: apps/web/components/Objects/Editor/Extensions/Scenarios/Scenarios.ts
================================================
import { ReactNodeViewRenderer } from "@tiptap/react";
import { mergeAttributes, Node } from "@tiptap/core";
import ScenariosExtension from "./ScenariosExtension";

export default Node.create({
  name: "scenarios",
  group: "block",
  draggable: true,
  atom: true,

  addAttributes() {
    return {
      title: {
        default: 'Interactive Scenario',
      },
      scenarios: {
        default: [
          {
            id: '1',
            text: 'Welcome to this interactive scenario. What would you like to do?',
            imageUrl: '',
            options: [
              { id: 'opt1', text: 'Continue exploring', nextScenarioId: '2' },
              { id: 'opt2', text: 'Learn more about the topic', nextScenarioId: '3' }
            ]
          },
          {
            id: '2',
            text: 'Great choice! You are now exploring further. What\'s your next step?',
            imageUrl: '',
            options: [
              { id: 'opt3', text: 'Go back to start', nextScenarioId: '1' },
              { id: 'opt4', text: 'Finish scenario', nextScenarioId: null }
            ]
          },
          {
            id: '3',
            text: 'Here\'s more information about the topic. This helps you understand better.',
            imageUrl: '',
            options: [
              { id: 'opt5', text: 'Go back to start', nextScenarioId: '1' },
              { id: 'opt6', text: 'Finish scenario', nextScenarioId: null }
            ]
          }
        ],
      },
      currentScenarioId: {
        default: '1',
      },
    };
  },

  parseHTML() {
    return [
      {
        tag: "scenarios-block",
      },
    ];
  },

  renderHTML({ HTMLAttributes }) {
    return ["scenarios-block", mergeAttributes(HTMLAttributes), 0];
  },

  addNodeView() {
    return ReactNodeViewRenderer(ScenariosExtension);
  },
});



================================================
FILE: apps/web/components/Objects/Editor/Extensions/Scenarios/ScenariosExtension.tsx
================================================
import { NodeViewWrapper } from '@tiptap/react'
import React, { useState } from 'react'
import { RotateCcw, ArrowRight, CheckCircle, GitBranch, RefreshCcw } from 'lucide-react'
import { useEditorProvider } from '@components/Contexts/Editor/EditorContext'
import ScenariosModal from './ScenariosModal'

interface ScenarioOption {
  id: string
  text: string
  nextScenarioId: string | null
}

interface Scenario {
  id: string
  text: string
  imageUrl?: string
  options: ScenarioOption[]
}

const ScenariosExtension: React.FC = (props: any) => {
  const [title, setTitle] = useState(props.node.attrs.title)
  const [scenarios, setScenarios] = useState<Scenario[]>(props.node.attrs.scenarios)
  const [currentScenarioId, setCurrentScenarioId] = useState(props.node.attrs.currentScenarioId)
  const [isModalOpen, setIsModalOpen] = useState(false)
  const [scenarioComplete, setScenarioComplete] = useState(false)
  const editorState = useEditorProvider() as any
  const isEditable = editorState?.isEditable ?? true

  const getCurrentScenario = (scenarioId: string = currentScenarioId): Scenario | null => {
    return scenarios.find(s => s.id === scenarioId) || null
  }

  const handleSave = (newTitle: string, newScenarios: Scenario[], newCurrentScenarioId: string) => {
    setTitle(newTitle)
    setScenarios(newScenarios)
    setCurrentScenarioId(newCurrentScenarioId)
    
    props.updateAttributes({
      title: newTitle,
      scenarios: newScenarios,
      currentScenarioId: newCurrentScenarioId,
    })
  }

  const handleOptionClick = (nextScenarioId: string | null) => {
    if (nextScenarioId) {
      setCurrentScenarioId(nextScenarioId)
      setScenarioComplete(false)
    } else {
      setScenarioComplete(true)
    }
  }

  const resetScenario = () => {
    setCurrentScenarioId(scenarios[0]?.id || '1')
    setScenarioComplete(false)
  }

  const getOptionLetter = (index: number) => {
    return String.fromCharCode('A'.charCodeAt(0) + index)
  }

  return (
    <NodeViewWrapper className="block-scenarios">
      <div className="rounded-xl px-3 sm:px-5 py-2 bg-slate-100 transition-all ease-linear">
        {/* Header section */}
        <div className="flex flex-wrap gap-2 pt-1 items-center text-sm">
          <div className="flex space-x-2 items-center text-sm">
            <GitBranch className="text-slate-400" size={15} />
            <p className="uppercase tracking-widest text-xs font-bold py-1 text-slate-400">
              Interactive Scenario
            </p>
          </div>
          
          {/* Completion message */}
          {scenarioComplete && !isEditable && (
            <div className="text-xs font-medium px-2 py-1 rounded-md bg-lime-100 text-lime-700">
              Scenario Complete!
            </div>
          )}
          
          <div className="grow"></div>
          
          {/* Action buttons */}
          {isEditable ? (
            <div>
              <button
                onClick={() => setIsModalOpen(true)}
                className="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-1 px-2 rounded-lg text-xs"
              >
                Edit Scenarios
              </button>
            </div>
          ) : (
            <div className="flex space-x-1 items-center">
              <div
                onClick={resetScenario}
                className="cursor-pointer p-1.5 rounded-md hover:bg-slate-200"
                title="Reset scenario"
              >
                <RefreshCcw className="text-slate-500" size={15} />
              </div>
            </div>
          )}
        </div>

        {/* Scenario content */}
        {isEditable ? (
          <div className="pt-3 space-y-2">
            <div className="scenario-editor">
              <div className="flex space-x-2 items-center">
                <div className="grow">
                  <input
                    value={title}
                    placeholder="Scenario Title"
                    onChange={(e) => {
                      setTitle(e.target.value)
                      props.updateAttributes({ title: e.target.value })
                    }}
                    className="text-slate-800 bg-[#00008b00] border-2 border-gray-200 rounded-md border-dotted text-md font-bold w-full p-2"
                  />
                </div>
              </div>
              
              <div className="mt-3 p-3 bg-white rounded-lg border-2 border-dotted border-gray-200">
                <p className="text-slate-600 text-sm text-center">
                  {scenarios.length}/40 scenarios configured
                </p>
                <p className="text-slate-500 text-xs text-center mt-1">
                  Click "Edit Scenarios" to configure your interactive branching story
                </p>
              </div>
            </div>
          </div>
        ) : scenarioComplete ? (
          <div className="pt-3 space-y-2">
            <div className="text-center py-8 max-w-md mx-auto">
              <div className="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <CheckCircle size={24} className="text-emerald-600" />
              </div>
              <h4 className="text-xl font-bold text-slate-900 mb-2">Scenario Complete!</h4>
              <p className="text-slate-600 mb-6 leading-relaxed">
                You've successfully navigated through this interactive scenario.
              </p>
              <button
                onClick={resetScenario}
                className="flex items-center gap-2 px-4 py-2 bg-slate-900 hover:bg-slate-800 text-white rounded-lg transition-all font-medium text-sm shadow-sm hover:shadow-md mx-auto"
              >
                <RotateCcw size={16} />
                Start Over
              </button>
            </div>
          </div>
        ) : (
          <div className="pt-3 space-y-2">
            {(() => {
              const currentScenario = getCurrentScenario()
              if (!currentScenario) {
                return (
                  <div className="text-center py-8 max-w-md mx-auto">
                    <div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3">
                      <GitBranch size={20} className="text-slate-400" />
                    </div>
                    <h3 className="text-base font-medium text-slate-900 mb-2">Scenario Not Found</h3>
                    <p className="text-slate-500 text-sm">Please check your scenario configuration and try again.</p>
                  </div>
                )
              }

              return (
                <div className="w-full max-w-xl mx-auto space-y-4 p-4">
                  {/* Scenario Text */}
                  <div className="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
                    {currentScenario.imageUrl && (
                      <div className="mb-4">
                        <img 
                          src={currentScenario.imageUrl} 
                          alt="Scenario illustration"
                          className="w-full h-48 object-cover rounded-lg border border-slate-200"
                          onError={(e) => {
                            e.currentTarget.style.display = 'none'
                          }}
                        />
                      </div>
                    )}
                    <p className="text-base text-slate-800 leading-relaxed font-medium">
                      {currentScenario.text}
                    </p>
                  </div>
                  
                  {/* Response Options */}
                  <div className="space-y-2">
                    {currentScenario.options.map((option, index) => (
                      <button
                        key={option.id}
                        onClick={() => handleOptionClick(option.nextScenarioId)}
                        className="w-full bg-white border border-slate-200 hover:border-blue-300 hover:bg-blue-50 rounded-lg p-3 transition-all group text-left shadow-sm hover:shadow-md"
                      >
                        <div className="flex items-center gap-3">
                          <div className="w-6 h-6 bg-slate-100 group-hover:bg-blue-100 rounded flex items-center justify-center flex-shrink-0 transition-colors">
                            <span className="text-sm font-bold text-slate-600 group-hover:text-blue-600">
                              {getOptionLetter(index)}
                            </span>
                          </div>
                          <div className="flex-1 text-slate-800 font-medium group-hover:text-blue-900 transition-colors">
                            {option.text}
                          </div>
                          <ArrowRight size={16} className="text-slate-400 group-hover:text-blue-500 group-hover:translate-x-1 transition-all" />
                        </div>
                      </button>
                    ))}
                  </div>
                </div>
              )
            })()}
          </div>
        )}

        <ScenariosModal
          isOpen={isModalOpen}
          onClose={() => setIsModalOpen(false)}
          title={title}
          scenarios={scenarios}
          currentScenarioId={currentScenarioId}
          onSave={handleSave}
        />
      </div>
    </NodeViewWrapper>
  )
}

export default ScenariosExtension



================================================
FILE: apps/web/components/Objects/Editor/Extensions/Scenarios/ScenariosModal.tsx
================================================
import React, { useState, useEffect } from 'react'
import { Plus, Trash2, Settings, Play, RotateCcw, ArrowRight, CheckCircle, Save, GitBranch, Image } from 'lucide-react'
import Modal from '@components/Objects/StyledElements/Modal/Modal'
import { ButtonBlack } from '@components/Objects/StyledElements/Form/Form'

interface ScenarioOption {
  id: string
  text: string
  nextScenarioId: string | null
}

interface Scenario {
  id: string
  text: string
  imageUrl?: string
  options: ScenarioOption[]
}

interface ScenariosModalProps {
  isOpen: boolean
  onClose: () => void
  title: string
  scenarios: Scenario[]
  currentScenarioId: string
  onSave: (title: string, scenarios: Scenario[], currentScenarioId: string) => void
}

const ScenariosModal: React.FC<ScenariosModalProps> = ({
  isOpen,
  onClose,
  title: initialTitle,
  scenarios: initialScenarios,
  currentScenarioId: initialCurrentScenarioId,
  onSave
}) => {
  const [title, setTitle] = useState(initialTitle)
  const [scenarios, setScenarios] = useState<Scenario[]>(initialScenarios)
  const [currentScenarioId, setCurrentScenarioId] = useState(initialCurrentScenarioId)
  const [showPreview, setShowPreview] = useState(false)
  const [previewCurrentId, setPreviewCurrentId] = useState('1')
  const [showImageInputs, setShowImageInputs] = useState<Record<string, boolean>>({})

  useEffect(() => {
    setTitle(initialTitle)
    setScenarios(initialScenarios)
    setCurrentScenarioId(initialCurrentScenarioId)
    setPreviewCurrentId(initialCurrentScenarioId)
    setShowImageInputs({})
  }, [initialTitle, initialScenarios, initialCurrentScenarioId])

  const handleSave = () => {
    onSave(title, scenarios, currentScenarioId)
    onClose()
  }

  const handleClose = () => {
    setShowPreview(false)
    onClose()
  }

  const getPreviewScenario = (): Scenario | null => {
    return scenarios.find(s => s.id === previewCurrentId) || null
  }

  const handleOptionClick = (nextScenarioId: string | null) => {
    if (nextScenarioId) {
      setPreviewCurrentId(nextScenarioId)
    } else {
      setPreviewCurrentId('end')
    }
  }

  const addNewScenario = () => {
    if (scenarios.length >= 40) {
      alert('Maximum of 40 scenarios allowed')
      return
    }

    const newId = (Math.max(...scenarios.map(s => parseInt(s.id))) + 1).toString()
    const newScenario: Scenario = {
      id: newId,
      text: 'New scenario text...',
      imageUrl: '',
      options: [
        { id: `opt${Date.now()}`, text: 'Option 1', nextScenarioId: null },
        { id: `opt${Date.now() + 1}`, text: 'Option 2', nextScenarioId: null }
      ]
    }
    setScenarios([...scenarios, newScenario])
  }

  const deleteScenario = (scenarioId: string) => {
    if (scenarios.length <= 1) {
      alert('At least one scenario is required')
      return
    }
    
    const updatedScenarios = scenarios.filter(s => s.id !== scenarioId)
    setScenarios(updatedScenarios)
    
    // Update references to deleted scenario
    const cleanedScenarios = updatedScenarios.map(scenario => ({
      ...scenario,
      options: scenario.options.map(option => ({
        ...option,
        nextScenarioId: option.nextScenarioId === scenarioId ? null : option.nextScenarioId
      }))
    }))
    setScenarios(cleanedScenarios)
    
    if (currentScenarioId === scenarioId) {
      setCurrentScenarioId(updatedScenarios[0]?.id || '1')
    }
  }

  const updateScenario = (scenarioId: string, updates: Partial<Scenario>) => {
    setScenarios(scenarios.map(s => 
      s.id === scenarioId ? { ...s, ...updates } : s
    ))
  }

  const addOption = (scenarioId: string) => {
    const scenario = scenarios.find(s => s.id === scenarioId)
    if (!scenario || scenario.options.length >= 4) {
      alert('Maximum of 4 options per scenario')
      return
    }

    const newOption: ScenarioOption = {
      id: `opt${Date.now()}`,
      text: 'New option',
      nextScenarioId: null
    }

    updateScenario(scenarioId, {
      options: [...scenario.options, newOption]
    })
  }

  const deleteOption = (scenarioId: string, optionId: string) => {
    const scenario = scenarios.find(s => s.id === scenarioId)
    if (!scenario || scenario.options.length <= 1) {
      alert('At least one option is required per scenario')
      return
    }

    updateScenario(scenarioId, {
      options: scenario.options.filter(opt => opt.id !== optionId)
    })
  }

  const updateOption = (scenarioId: string, optionId: string, updates: Partial<ScenarioOption>) => {
    const scenario = scenarios.find(s => s.id === scenarioId)
    if (!scenario) return

    updateScenario(scenarioId, {
      options: scenario.options.map(opt => 
        opt.id === optionId ? { ...opt, ...updates } : opt
      )
    })
  }

  const resetPreview = () => {
    setPreviewCurrentId(currentScenarioId)
  }

  const toggleImageInput = (scenarioId: string) => {
    setShowImageInputs(prev => ({
      ...prev,
      [scenarioId]: !prev[scenarioId]
    }))
  }

  const renderPreviewContent = () => {
    const previewScenario = getPreviewScenario()
    
    return (
      <div className="flex flex-col h-[calc(75vh-220px)] p-2">
        {/* Preview Header */}
        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 p-4 -mx-2 -mt-2 mb-4 flex-shrink-0">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                <Play size={16} className="text-blue-600" />
              </div>
              <div>
                <h3 className="text-lg font-bold text-slate-900">{title}</h3>
                <p className="text-sm text-slate-600">Interactive Preview</p>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <button
                onClick={resetPreview}
                className="flex items-center gap-2 px-3 py-2 bg-white hover:bg-slate-50 text-slate-700 border border-slate-300 rounded-lg transition-all text-sm font-medium shadow-sm"
              >
                <RotateCcw size={14} />
                Reset
              </button>
              <button
                onClick={() => setShowPreview(false)}
                className="flex items-center gap-2 px-3 py-2 bg-slate-900 hover:bg-slate-800 text-white rounded-lg transition-all text-sm font-medium shadow-sm"
              >
                <Settings size={14} />
                Back to Edit
              </button>
            </div>
          </div>
        </div>

        {/* Preview Content */}
        <div className="flex-1 flex items-center justify-center overflow-y-auto">
          {previewCurrentId === 'end' ? (
            <div className="text-center py-8 max-w-md mx-auto">
              <div className="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <CheckCircle size={24} className="text-emerald-600" />
              </div>
              <h4 className="text-xl font-bold text-slate-900 mb-2">Scenario Complete!</h4>
              <p className="text-slate-600 mb-6 leading-relaxed">
                You've successfully navigated through this interactive scenario.
              </p>
              <button
                onClick={resetPreview}
                className="flex items-center gap-2 px-4 py-2 bg-slate-900 hover:bg-slate-800 text-white rounded-lg transition-all font-medium text-sm shadow-sm hover:shadow-md mx-auto"
              >
                <RotateCcw size={16} />
                Start Over
              </button>
            </div>
          ) : previewScenario ? (
            <div className="w-full max-w-xl mx-auto space-y-4 p-4">
              {/* Scenario Text */}
              <div className="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
                {previewScenario.imageUrl && (
                  <div className="mb-4">
                    <img 
                      src={previewScenario.imageUrl} 
                      alt="Scenario illustration"
                      className="w-full h-48 object-cover rounded-lg border border-slate-200"
                      onError={(e) => {
                        e.currentTarget.style.display = 'none'
                      }}
                    />
                  </div>
                )}
                <p className="text-base text-slate-800 leading-relaxed font-medium">
                  {previewScenario.text}
                </p>
              </div>
              
              {/* Response Options */}
              <div className="space-y-2">
                {previewScenario.options.map((option, index) => (
                  <button
                    key={option.id}
                    onClick={() => handleOptionClick(option.nextScenarioId)}
                    className="w-full bg-white border border-slate-200 hover:border-blue-300 hover:bg-blue-50 rounded-lg p-3 transition-all group text-left shadow-sm hover:shadow-md"
                  >
                    <div className="flex items-center gap-3">
                      <div className="w-6 h-6 bg-slate-100 group-hover:bg-blue-100 rounded flex items-center justify-center flex-shrink-0 transition-colors">
                        <span className="text-sm font-bold text-slate-600 group-hover:text-blue-600">
                          {String.fromCharCode('A'.charCodeAt(0) + index)}
                        </span>
                      </div>
                      <div className="flex-1 text-slate-800 font-medium group-hover:text-blue-900 transition-colors">
                        {option.text}
                      </div>
                      <ArrowRight size={16} className="text-slate-400 group-hover:text-blue-500 group-hover:translate-x-1 transition-all" />
                    </div>
                  </button>
                ))}
              </div>
            </div>
          ) : (
            <div className="text-center py-8 max-w-md mx-auto">
              <div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <GitBranch size={20} className="text-slate-400" />
              </div>
              <h3 className="text-base font-medium text-slate-900 mb-2">Scenario Not Found</h3>
              <p className="text-slate-500 text-sm">Please check your scenario configuration and try again.</p>
            </div>
          )}
        </div>
      </div>
    )
  }

  const renderEditContent = () => (
    <div className="flex flex-col h-[calc(75vh-220px)] p-2">
      {/* Header Section */}
      <div className="bg-white border-b border-slate-200 p-4 -mx-2 -mt-2 mb-4 flex-shrink-0">
        <div className="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
          <div className="flex-1 min-w-0">
            <label className="block text-sm font-semibold text-slate-900 mb-2">
              Scenario Title
            </label>
            <input
              type="text"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              className="w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-slate-900 placeholder-slate-400 transition-all"
              placeholder="Enter your scenario title..."
            />
          </div>
          <div className="flex items-center gap-2">
            <div className="flex items-center gap-2 px-2 py-1.5 bg-slate-100 rounded-lg">
              <div className="w-2 h-2 bg-slate-400 rounded-full"></div>
              <span className="text-xs font-medium text-slate-600">
                {scenarios.length}/40
              </span>
            </div>
            <button
              onClick={() => setShowPreview(true)}
              className="flex items-center gap-2 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all font-medium text-sm shadow-sm hover:shadow-md"
            >
              <Play size={14} />
              Preview
            </button>
            <button
              onClick={addNewScenario}
              disabled={scenarios.length >= 40}
              className="flex items-center gap-2 px-3 py-2 bg-slate-900 hover:bg-slate-800 text-white rounded-lg transition-all font-medium text-sm shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-slate-900"
            >
              <Plus size={14} />
              Add
            </button>
          </div>
        </div>
      </div>

      {/* Scenarios List */}
      <div className="flex-1 overflow-hidden min-h-0">
        <div className="h-full overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-transparent hover:scrollbar-thumb-gray-400">
          <div className="space-y-4 pb-4">
            {scenarios.map((scenario, scenarioIndex) => (
              <div key={scenario.id} className="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                {/* Scenario Header */}
                <div className="bg-gradient-to-r from-slate-50 to-slate-100 px-4 py-3 border-b border-slate-200">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="w-7 h-7 bg-slate-200 rounded-lg flex items-center justify-center">
                        <span className="text-sm font-bold text-slate-700">{scenarioIndex + 1}</span>
                      </div>
                      <div>
                        <h3 className="text-base font-semibold text-slate-900">Scenario {scenario.id}</h3>
                        {scenario.id === currentScenarioId && (
                          <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-emerald-100 text-emerald-700 text-xs font-medium rounded-full mt-1">
                            <div className="w-1.5 h-1.5 bg-emerald-500 rounded-full"></div>
                            Starting Point
                          </span>
                        )}
                      </div>
                    </div>
                    <div className="flex items-center gap-1">
                      <button
                        onClick={() => setCurrentScenarioId(scenario.id)}
                        className={`px-2 py-1 rounded-md transition-all text-xs font-medium ${
                          scenario.id === currentScenarioId 
                            ? 'bg-emerald-500 text-white shadow-sm' 
                            : 'bg-slate-200 hover:bg-slate-300 text-slate-700'
                        }`}
                        title="Set as starting scenario"
                      >
                        {scenario.id === currentScenarioId ? 'Start' : 'Set Start'}
                      </button>
                      <button
                        onClick={() => deleteScenario(scenario.id)}
                        disabled={scenarios.length <= 1}
                        className="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-md transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:text-slate-400 disabled:hover:bg-transparent"
                        title="Delete scenario"
                      >
                        <Trash2 size={14} />
                      </button>
                    </div>
                  </div>
                </div>

                {/* Scenario Content */}
                <div className="p-4 space-y-4">
                  {/* Scenario Text */}
                  <div>
                    <div className="flex items-center justify-between mb-2">
                      <label className="text-sm font-medium text-slate-700">
                        Scenario Description
                      </label>
                      <button
                        onClick={() => toggleImageInput(scenario.id)}
                        className={`flex items-center gap-2 px-3 py-1.5 rounded-lg transition-all text-xs font-medium border ${
                          showImageInputs[scenario.id] 
                            ? 'text-blue-700 bg-blue-50 border-blue-200 hover:bg-blue-100 shadow-sm' 
                            : scenario.imageUrl && scenario.imageUrl.trim() !== ''
                            ? 'text-blue-700 bg-blue-50 border-blue-200 hover:bg-blue-100'
                            : 'text-slate-600 bg-white border-slate-200 hover:text-blue-600 hover:bg-blue-50 hover:border-blue-200'
                        }`}
                        title={scenario.imageUrl && scenario.imageUrl.trim() !== '' ? "Edit image" : "Add image"}
                      >
                        <Image size={14} />
                        <span>
                          {scenario.imageUrl && scenario.imageUrl.trim() !== '' ? 'Image' : 'Add Image'}
                        </span>
                        {scenario.imageUrl && scenario.imageUrl.trim() !== '' && (
                          <span className="inline-flex items-center justify-center w-4 h-4 text-xs font-bold text-white bg-blue-600 rounded-full">
                            1
                          </span>
                        )}
                      </button>
                    </div>
                    <textarea
                      value={scenario.text}
                      onChange={(e) => updateScenario(scenario.id, { text: e.target.value })}
                      className="w-full p-3 border border-slate-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-slate-900 placeholder-slate-400 transition-all"
                      rows={2}
                      placeholder="Describe what happens in this scenario..."
                    />
                  </div>

                  {/* Scenario Image */}
                  {showImageInputs[scenario.id] && (
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-2">
                        Image URL
                      </label>
                      <input
                        type="url"
                        value={scenario.imageUrl || ''}
                        onChange={(e) => updateScenario(scenario.id, { imageUrl: e.target.value })}
                        className="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-slate-900 placeholder-slate-400 transition-all"
                        placeholder="https://example.com/image.jpg"
                      />
                      {scenario.imageUrl && (
                        <div className="mt-2">
                          <img 
                            src={scenario.imageUrl} 
                            alt="Scenario preview"
                            className="w-full h-32 object-cover rounded-lg border border-slate-200"
                            onError={(e) => {
                              e.currentTarget.style.display = 'none'
                            }}
                          />
                        </div>
                      )}
                    </div>
                  )}

                  {/* Response Options */}
                  <div>
                    <div className="flex items-center justify-between mb-3">
                      <label className="text-sm font-medium text-slate-700">
                        Response Options ({scenario.options.length}/4)
                      </label>
                      <button
                        onClick={() => addOption(scenario.id)}
                        disabled={scenario.options.length >= 4}
                        className="flex items-center gap-1 px-2 py-1 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-md transition-all text-xs font-medium disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-slate-100"
                        title="Add response option"
                      >
                        <Plus size={12} />
                        Add
                      </button>
                    </div>
                    
                    <div className="space-y-2">
                      {scenario.options.map((option, index) => (
                        <div key={option.id} className="group bg-slate-50 border border-slate-200 rounded-lg p-3 hover:bg-slate-100 transition-all">
                          <div className="flex items-start gap-2">
                            <div className="w-6 h-6 bg-white border border-slate-300 rounded flex items-center justify-center flex-shrink-0 mt-0.5">
                              <span className="text-xs font-bold text-slate-600">
                                {String.fromCharCode('A'.charCodeAt(0) + index)}
                              </span>
                            </div>
                            <div className="flex-1 space-y-2">
                              <input
                                type="text"
                                value={option.text}
                                onChange={(e) => updateOption(scenario.id, option.id, { text: e.target.value })}
                                className="w-full px-2 py-2 border border-slate-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white placeholder-slate-400 transition-all"
                                placeholder="Enter response option..."
                              />
                              <div className="flex items-center gap-2">
                                <span className="text-xs text-slate-500 font-medium">â†’</span>
                                <select
                                  value={option.nextScenarioId || ''}
                                  onChange={(e) => updateOption(scenario.id, option.id, { 
                                    nextScenarioId: e.target.value || null 
                                  })}
                                  className="flex-1 px-2 py-1.5 border border-slate-300 rounded text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white transition-all"
                                >
                                  <option value="">End scenario</option>
                                  {scenarios.map((s) => (
                                    <option key={s.id} value={s.id}>
                                      Scenario {s.id}
                                    </option>
                                  ))}
                                </select>
                              </div>
                            </div>
                            <button
                              onClick={() => deleteOption(scenario.id, option.id)}
                              disabled={scenario.options.length <= 1}
                              className="p-1 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-all opacity-0 group-hover:opacity-100 disabled:opacity-0 disabled:cursor-not-allowed flex-shrink-0"
                              title="Delete option"
                            >
                              <Trash2 size={12} />
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            ))}
            
            {scenarios.length === 0 && (
              <div className="text-center py-8">
                <div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3">
                  <GitBranch size={20} className="text-slate-400" />
                </div>
                <h3 className="text-base font-medium text-slate-900 mb-2">No scenarios yet</h3>
                <p className="text-slate-500 text-sm mb-4">Create your first scenario to get started.</p>
                <button
                  onClick={addNewScenario}
                  className="flex items-center gap-2 px-3 py-2 bg-slate-900 hover:bg-slate-800 text-white rounded-lg transition-all font-medium text-sm shadow-sm hover:shadow-md mx-auto"
                >
                  <Plus size={14} />
                  Create First Scenario
                </button>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  )

  return (
    <Modal
      isDialogOpen={isOpen}
      onOpenChange={handleClose}
      dialogTitle={showPreview ? "Scenario Preview" : "Edit Scenarios"}
      dialogDescription={showPreview ? "Test your interactive scenario" : "Create and manage your interactive scenarios"}
      customHeight="max-h-[75vh]"
      customWidth="!w-[70vw] !max-w-[70vw] !sm:w-[70vw] !sm:max-w-[70vw] !md:w-[70vw] !md:max-w-[70vw] !lg:max-w-[70vw] !xl:max-w-[70vw]"
      dialogContent={showPreview ? renderPreviewContent() : renderEditContent()}
      dialogClose={
        <>
          <ButtonBlack 
            onClick={handleClose}
            css={{ 
              backgroundColor: '$gray200', 
              color: '$gray700',
              '&:hover': { backgroundColor: '$gray300' }
            }}
          >
            Cancel
          </ButtonBlack>
          {!showPreview && (
            <ButtonBlack onClick={handleSave}>
              <div className="flex items-center gap-2">
                <Save size={16} />
                Save Changes
              </div>
            </ButtonBlack>
          )}
        </>
      }
    />
  )
}

export default ScenariosModal



================================================
FILE: apps/web/components/Objects/Editor/Extensions/Users/UserBlock.ts
================================================
import { mergeAttributes, Node } from '@tiptap/core'
import { ReactNodeViewRenderer } from '@tiptap/react'

import UserBlockComponent from './UserBlockComponent'

export default Node.create({
  name: 'blockUser',
  group: 'block',

  atom: true,

  addAttributes() {
    return {
      user_id: {
        default: '',
      },
    }
  },

  parseHTML() {
    return [
      {
        tag: 'block-user',
      },
    ]
  },

  renderHTML({ HTMLAttributes }) {
    return ['block-user', mergeAttributes(HTMLAttributes), 0]
  },

  addNodeView() {
    return ReactNodeViewRenderer(UserBlockComponent)
  },
})



================================================
FILE: apps/web/components/Objects/Editor/Extensions/Users/UserBlockComponent.tsx
================================================
import { NodeViewWrapper } from '@tiptap/react'
import React, { useEffect, useState } from 'react'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { getUserByUsername, getUser } from '@services/users/users'
import { Input } from "@components/ui/input"
import { Button } from "@components/ui/button"
import { Label } from "@components/ui/label"
import { 
  Loader2, 
  User, 
  ExternalLink,
  Briefcase,
  GraduationCap,
  MapPin,
  Building2,
  Globe,
  Laptop2,
  Award,
  BookOpen,
  Link,
  Users,
  Calendar,
  Lightbulb
} from 'lucide-react'
import { Badge } from "@components/ui/badge"
import { useRouter } from 'next/navigation'
import UserAvatar from '@components/Objects/UserAvatar'
import { useEditorProvider } from '@components/Contexts/Editor/EditorContext'
import { getUserAvatarMediaDirectory } from '@services/media/media'

type UserData = {
  id: string
  user_uuid: string
  first_name: string
  last_name: string
  username: string
  bio?: string
  avatar_image?: string
  details?: {
    [key: string]: {
      id: string
      label: string
      icon: string
      text: string
    }
  }
}

const AVAILABLE_ICONS = {
  'briefcase': Briefcase,
  'graduation-cap': GraduationCap,
  'map-pin': MapPin,
  'building-2': Building2,
  'speciality': Lightbulb,
  'globe': Globe,
  'laptop-2': Laptop2,
  'award': Award,
  'book-open': BookOpen,
  'link': Link,
  'users': Users,
  'calendar': Calendar,
} as const;

const IconComponent = ({ iconName }: { iconName: string }) => {
  const IconElement = AVAILABLE_ICONS[iconName as keyof typeof AVAILABLE_ICONS]
  if (!IconElement) return <User className="w-4 h-4 text-gray-600" />
  return <IconElement className="w-4 h-4 text-gray-600" />
}

function UserBlockComponent(props: any) {
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token
  const editorState = useEditorProvider() as any
  const isEditable = editorState.isEditable
  const router = useRouter()

  const [username, setUsername] = useState('')
  const [userData, setUserData] = useState<UserData | null>(null)
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    if (props.node.attrs.user_id) {
      fetchUserById(props.node.attrs.user_id)
    }
  }, [props.node.attrs.user_id])

  const fetchUserById = async (userId: string) => {
    setIsLoading(true)
    setError(null)
    try {
      const data = await getUser(userId)
      if (!data) {
        throw new Error('User not found')
      }
      setUserData(data)
      setUsername(data.username)
    } catch (err: any) {
      console.error('Error fetching user by ID:', err)
      setError(err.detail || 'User not found')
      // Clear the invalid user_id from the node attributes
      props.updateAttributes({
        user_id: null
      })
    } finally {
      setIsLoading(false)
    }
  }

  const fetchUserByUsername = async (username: string) => {
    setIsLoading(true)
    setError(null)
    try {
      const data = await getUserByUsername(username)
      if (!data) {
        throw new Error('User not found')
      }
      setUserData(data)
      props.updateAttributes({
        user_id: data.id
      })
    } catch (err: any) {
      console.error('Error fetching user by username:', err)
      setError(err.detail || 'User not found')
    } finally {
      setIsLoading(false)
    }
  }

  const handleUsernameSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!username.trim()) return
    await fetchUserByUsername(username)
  }

  if (isEditable && !userData) {
    return (
      <NodeViewWrapper className="block-user">
        <div className="bg-gray-50 rounded-lg p-6 border border-dashed border-gray-200">
          <form onSubmit={handleUsernameSubmit} className="space-y-4">
            <div>
              <Label htmlFor="username">Username</Label>
              <div className="flex gap-2 mt-2">
                <Input
                  id="username"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  placeholder="Enter username"
                  className="flex-1"
                />
                <Button type="submit" disabled={isLoading}>
                  {isLoading ? (
                    <Loader2 className="w-4 h-4 animate-spin" />
                  ) : (
                    'Load User'
                  )}
                </Button>
              </div>
              {error && (
                <p className="text-sm text-red-500 mt-2">{error}</p>
              )}
            </div>
          </form>
        </div>
      </NodeViewWrapper>
    )
  }

  if (isLoading) {
    return (
      <NodeViewWrapper className="block-user">
        <div className="flex items-center justify-center py-8">
          <Loader2 className="w-6 h-6 animate-spin text-gray-400" />
        </div>
      </NodeViewWrapper>
    )
  }

  if (error) {
    return (
      <NodeViewWrapper className="block-user">
        <div className="bg-red-50 text-red-500 p-4 rounded-lg">
          {error}
        </div>
      </NodeViewWrapper>
    )
  }

  if (!userData) {
    return (
      <NodeViewWrapper className="block-user">
        <div className="bg-gray-50 rounded-lg p-6 border border-dashed border-gray-200">
          <div className="flex items-center gap-2 text-gray-500">
            <User className="w-5 h-5" />
            <span>No user selected</span>
          </div>
        </div>
      </NodeViewWrapper>
    )
  }

  return (
    <NodeViewWrapper className="block-user">
      <div className="bg-white rounded-lg nice-shadow overflow-hidden">
        {/* Header with Avatar and Name */}
        <div className="relative">
          {/* Background gradient */}
          <div className="absolute inset-0 bg-gradient-to-b from-gray-100/30 to-transparent h-28 rounded-t-lg" />
          
          {/* Content */}
          <div className="relative px-5 pt-5 pb-4">
            <div className="flex items-start gap-4">
              {/* Avatar */}
              <div className="flex-shrink-0">
                <div className="rounded-full">
                  <UserAvatar
                    width={80}
                    avatar_url={userData.avatar_image ? getUserAvatarMediaDirectory(userData.user_uuid, userData.avatar_image) : ''}
                    predefined_avatar={userData.avatar_image ? undefined : 'empty'}
                    userId={userData.id}
                    showProfilePopup
                    rounded="rounded-full"
                  />
                </div>
              </div>

              {/* Name, Bio, and Button */}
              <div className="flex-1 min-w-0">
                <div className="flex items-center justify-between gap-2">
                  <div className="flex items-center gap-2 min-w-0">
                    <h4 className="font-semibold text-gray-900 truncate">
                      {userData.first_name} {userData.last_name}
                    </h4>
                    {userData.username && (
                      <Badge variant="outline" className="text-xs font-normal text-gray-500 px-2 truncate">
                        @{userData.username}
                      </Badge>
                    )}
                  </div>
                  <Button
                    variant="ghost"
                    size="icon"
                    className="h-6 w-6 text-gray-600 hover:text-gray-900 flex-shrink-0"
                    onClick={() => userData.username && router.push(`/user/${userData.username}`)}
                  >
                    <ExternalLink className="w-4 h-4" />
                  </Button>
                </div>
                {userData.bio && (
                  <p className="text-sm text-gray-500 mt-1.5 line-clamp-4 leading-normal">
                    {userData.bio}
                  </p>
                )}
              </div>
            </div>
          </div>
        </div>

        {/* Details */}
        {userData.details && Object.values(userData.details).length > 0 && (
          <div className="px-5 pb-4 space-y-2.5 border-t border-gray-100 pt-3.5">
            {Object.values(userData.details).map((detail) => (
              <div key={detail.id} className="flex items-center gap-2.5">
                <IconComponent iconName={detail.icon} />
                <div className="flex flex-col">
                  <span className="text-xs text-gray-500">{detail.label}</span>
                  <span className="text-sm text-gray-700">{detail.text}</span>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </NodeViewWrapper>
  )
}

export default UserBlockComponent


================================================
FILE: apps/web/components/Objects/Editor/Extensions/Video/VideoBlock.ts
================================================
import { mergeAttributes, Node } from '@tiptap/core'
import { ReactNodeViewRenderer } from '@tiptap/react'

import VideoBlockComponent from './VideoBlockComponent'

export default Node.create({
  name: 'blockVideo',
  group: 'block',
  atom: true,

  addAttributes() {
    return {
      blockObject: {
        default: null,
      },
    }
  },

  parseHTML() {
    return [
      {
        tag: 'block-video',
      },
    ]
  },

  renderHTML({ HTMLAttributes }) {
    return ['block-video', mergeAttributes(HTMLAttributes), 0]
  },

  addNodeView() {
    return ReactNodeViewRenderer(VideoBlockComponent)
  },
})



================================================
FILE: apps/web/components/Objects/Editor/Extensions/Video/VideoBlockComponent.tsx
================================================
import { NodeViewProps, NodeViewWrapper } from '@tiptap/react'
import { Node } from '@tiptap/core'
import { 
  Loader2, Video, Upload, X, ArrowLeftRight, 
  CheckCircle2, AlertCircle, Download, Expand
} from 'lucide-react'
import React from 'react'
import { uploadNewVideoFile } from '../../../../../services/blocks/Video/video'
import { getActivityBlockMediaDirectory } from '@services/media/media'
import { useOrg } from '@components/Contexts/OrgContext'
import { useCourse } from '@components/Contexts/CourseContext'
import { useEditorProvider } from '@components/Contexts/Editor/EditorContext'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { constructAcceptValue } from '@/lib/constants'
import { cn } from '@/lib/utils'
import { motion, AnimatePresence } from 'framer-motion'
import styled from 'styled-components'
import Modal from '@components/Objects/StyledElements/Modal/Modal'

const SUPPORTED_FILES = constructAcceptValue(['webm', 'mp4'])

const VIDEO_SIZES = {
  small: { width: 480, label: 'Small' },
  medium: { width: 720, label: 'Medium' },
  large: { width: 960, label: 'Large' },
  full: { width: '100%', label: 'Full Width' }
} as const

type VideoSize = keyof typeof VIDEO_SIZES

// Helper function to determine video size from width
const getVideoSizeFromWidth = (width: number | string | undefined): VideoSize => {
  if (!width) return 'medium'
  if (width === '100%') return 'full'
  
  const numWidth = typeof width === 'string' ? parseInt(width) : width
  
  if (numWidth <= VIDEO_SIZES.small.width) return 'small'
  if (numWidth <= VIDEO_SIZES.medium.width) return 'medium'
  if (numWidth <= VIDEO_SIZES.large.width) return 'large'
  return 'full'
}

const VideoWrapper = styled.div`
  transition: all 0.2s ease;
  background-color: #f9f9f9;
  border: 1px solid #eaeaea;
`

const VideoContainer = styled.div`
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
`

const UploadZone = styled(motion.div)<{ isDragging: boolean }>`
  border: 2px dashed ${props => props.isDragging ? '#3b82f6' : '#e5e7eb'};
  background: ${props => props.isDragging ? 'rgba(59, 130, 246, 0.05)' : '#ffffff'};
  transition: all 0.2s ease;
  border-radius: 0.75rem;
  padding: 2rem;
  text-align: center;
  cursor: pointer;

  &:hover {
    border-color: #3b82f6;
    background: rgba(59, 130, 246, 0.05);
  }
`

const SizeButton = styled(motion.button)<{ isActive: boolean }>`
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 0.75rem;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  color: ${props => props.isActive ? '#ffffff' : '#4b5563'};
  background: ${props => props.isActive ? '#3b82f6' : 'transparent'};
  border: 1px solid ${props => props.isActive ? '#3b82f6' : '#e5e7eb'};
  transition: all 0.2s ease;

  &:hover {
    background: ${props => props.isActive ? '#2563eb' : '#f9fafb'};
  }

  &:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
`

interface Organization {
  org_uuid: string
}

interface Course {
  courseStructure: {
    course_uuid: string
  }
}

interface EditorState {
  isEditable: boolean
}

interface Session {
  data?: {
    tokens?: {
      access_token?: string
    }
  }
}

// Legacy interface for backward compatibility
interface LegacyVideoBlockObject {
  block_uuid: string
  content: {
    file_id: string
    file_format: string
  }
  size?: {
    width?: number | string
  }
}

interface VideoBlockObject {
  block_uuid: string
  content: {
    file_id: string
    file_format: string
  }
  size: VideoSize
}

interface VideoBlockAttrs {
  blockObject: VideoBlockObject | LegacyVideoBlockObject | null
}

interface VideoBlockExtension {
  options: {
    activity: {
      activity_uuid: string
    }
  }
}

interface ExtendedNodeViewProps extends Omit<NodeViewProps, 'extension'> {
  extension: Node & {
    options: {
      activity: {
        activity_uuid: string
      }
    }
  }
}

function VideoBlockComponent(props: ExtendedNodeViewProps) {
  const { node, extension, updateAttributes } = props
  const org = useOrg() as Organization | null
  const course = useCourse() as Course | null
  const editorState = useEditorProvider() as EditorState
  const session = useLHSession() as Session
  const fileInputRef = React.useRef<HTMLInputElement>(null)
  const uploadZoneRef = React.useRef<HTMLDivElement>(null)
  
  // Convert legacy block object to new format
  const convertLegacyBlock = React.useCallback((block: LegacyVideoBlockObject): VideoBlockObject => {
    const videoSize = getVideoSizeFromWidth(block.size?.width)
    return {
      ...block,
      size: videoSize
    }
  }, [])

  const initialBlockObject = React.useMemo(() => {
    if (!node.attrs.blockObject) return null
    if ('size' in node.attrs.blockObject && typeof node.attrs.blockObject.size === 'string') {
      return node.attrs.blockObject as VideoBlockObject
    }
    return convertLegacyBlock(node.attrs.blockObject as LegacyVideoBlockObject)
  }, [node.attrs.blockObject, convertLegacyBlock])

  const [video, setVideo] = React.useState<File | null>(null)
  const [isLoading, setIsLoading] = React.useState(false)
  const [error, setError] = React.useState<string | null>(null)
  const [isDragging, setIsDragging] = React.useState(false)
  const [uploadProgress, setUploadProgress] = React.useState(0)
  const [blockObject, setBlockObject] = React.useState<VideoBlockObject | null>(initialBlockObject)
  const [selectedSize, setSelectedSize] = React.useState<VideoSize>(initialBlockObject?.size || 'medium')
  const [isModalOpen, setIsModalOpen] = React.useState(false)

  // Update block object when size changes
  React.useEffect(() => {
    if (blockObject && blockObject.size !== selectedSize) {
      const newBlockObject = {
        ...blockObject,
        size: selectedSize
      }
      setBlockObject(newBlockObject)
      updateAttributes({ blockObject: newBlockObject })
    }
  }, [selectedSize])

  const isEditable = editorState?.isEditable
  const access_token = session?.data?.tokens?.access_token
  const fileId = blockObject ? `${blockObject.content.file_id}.${blockObject.content.file_format}` : null

  const handleVideoChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0]
    if (file) {
      setVideo(file)
      setError(null)
      handleUpload(file)
    }
  }

  const handleDragEnter = (e: React.DragEvent) => {
    e.preventDefault()
    e.stopPropagation()
    setIsDragging(true)
  }

  const handleDragLeave = (e: React.DragEvent) => {
    e.preventDefault()
    e.stopPropagation()
    if (e.currentTarget === uploadZoneRef.current) {
      setIsDragging(false)
    }
  }

  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault()
    e.stopPropagation()
    setIsDragging(false)

    const file = e.dataTransfer.files[0]
    const fileExtension = file?.name.split('.').pop()?.toLowerCase()
    
    if (file && fileExtension && ['mp4', 'webm'].includes(fileExtension)) {
      setVideo(file)
      setError(null)
      handleUpload(file)
    } else {
      setError('Please upload a supported video format (MP4 or WebM)')
    }
  }

  const handleUpload = async (file: File) => {
    if (!access_token) return

    try {
      setIsLoading(true)
      setError(null)
      setUploadProgress(0)

      // Simulate upload progress
      const progressInterval = setInterval(() => {
        setUploadProgress(prev => Math.min(prev + 10, 90))
      }, 200)

      const object = await uploadNewVideoFile(
        file,
        extension.options.activity.activity_uuid,
        access_token
      )

      clearInterval(progressInterval)
      setUploadProgress(100)

      const newBlockObject = {
        ...object,
        size: selectedSize
      }
      setBlockObject(newBlockObject)
      updateAttributes({ blockObject: newBlockObject })
      setVideo(null)

      // Reset progress after a delay
      setTimeout(() => {
        setUploadProgress(0)
      }, 1000)
    } catch (err) {
      setError('Failed to upload video. Please try again.')
    } finally {
      setIsLoading(false)
    }
  }

  const handleRemove = () => {
    setBlockObject(null)
    updateAttributes({ blockObject: null })
    setVideo(null)
    setError(null)
    setUploadProgress(0)
  }

  const handleSizeChange = (size: VideoSize) => {
    setSelectedSize(size)
  }

  const videoUrl = blockObject && org?.org_uuid && course?.courseStructure.course_uuid ? getActivityBlockMediaDirectory(
    org.org_uuid,
    course.courseStructure.course_uuid,
    extension.options.activity.activity_uuid,
    blockObject.block_uuid,
    fileId || '',
    'videoBlock'
  ) : null

  const handleDownload = () => {
    if (!videoUrl) return;
    
    // Create a temporary link element
    const link = document.createElement('a');
    link.href = videoUrl;
    link.download = `video-${blockObject?.block_uuid || 'download'}.${blockObject?.content.file_format || 'mp4'}`;
    link.setAttribute('download', '');
    link.setAttribute('target', '_blank');
    link.setAttribute('rel', 'noopener noreferrer');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const handleExpand = () => {
    setIsModalOpen(true);
  };

  // If we're in preview mode and have a video, show only the video player
  if (!isEditable && blockObject && videoUrl) {
    const width = VIDEO_SIZES[blockObject.size].width
    return (
      <>
        <NodeViewWrapper className="block-video w-full">
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ duration: 0.3 }}
            className="w-full flex justify-center relative"
          >
            <div
              style={{ 
                maxWidth: typeof width === 'number' ? width : '100%',
                width: '100%'
              }}
            >
              <div className="relative">
                <video
                  controls
                  className="w-full aspect-video object-contain rounded-lg shadow-sm"
                  src={videoUrl}
                />
                <div className="absolute top-2 right-2 flex gap-1">
                  <button
                    onClick={handleExpand}
                    className="p-2 bg-black/50 hover:bg-black/70 rounded-full transition-colors"
                    title="Expand video"
                  >
                    <Expand className="w-4 h-4 text-white" />
                  </button>
                  <button
                    onClick={handleDownload}
                    className="p-2 bg-black/50 hover:bg-black/70 rounded-full transition-colors"
                    title="Download video"
                  >
                    <Download className="w-4 h-4 text-white" />
                  </button>
                </div>
              </div>
            </div>
          </motion.div>
        </NodeViewWrapper>
        
        <Modal
          isDialogOpen={isModalOpen}
          onOpenChange={setIsModalOpen}
          dialogTitle="Video Player"
          minWidth="lg"
          minHeight="lg"
          dialogContent={
            <div className="w-full">
              <video
                controls
                autoPlay
                className="w-full aspect-video object-contain rounded-lg shadow-lg bg-black"
                src={videoUrl}
              />
            </div>
          }
        />
      </>
    )
  }

  // If we're in preview mode but don't have a video, show nothing
  if (!isEditable && (!blockObject || !videoUrl)) {
    return null
  }

  // Show the full editor UI when in edit mode
  return (
    <NodeViewWrapper className="block-video w-full">
      <motion.div
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.3 }}
      >
        <VideoWrapper className="flex flex-col space-y-4 rounded-lg py-6 px-5">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-2 text-sm text-zinc-500">
              <Video size={16} />
              <span className="font-medium">Video Block</span>
            </div>
            {blockObject && (
              <motion.button
                whileHover={{ scale: 1.05 }}
                whileTap={{ scale: 0.95 }}
                onClick={handleRemove}
                className="text-zinc-400 hover:text-red-500 transition-colors"
              >
                <X size={16} />
              </motion.button>
            )}
          </div>

          {(!blockObject || !videoUrl) && (
            <motion.div
              initial={{ opacity: 0, height: 0 }}
              animate={{ opacity: 1, height: 'auto' }}
              transition={{ duration: 0.2 }}
              className="space-y-4"
            >
              <input
                ref={fileInputRef}
                type="file"
                onChange={handleVideoChange}
                accept={SUPPORTED_FILES}
                className="hidden"
              />

              <UploadZone
                ref={uploadZoneRef}
                isDragging={isDragging}
                onDragEnter={handleDragEnter}
                onDragOver={handleDragEnter}
                onDragLeave={handleDragLeave}
                onDrop={handleDrop}
                onClick={() => fileInputRef.current?.click()}
                className="relative"
              >
                <AnimatePresence>
                  {isLoading ? (
                    <motion.div
                      initial={{ opacity: 0 }}
                      animate={{ opacity: 1 }}
                      exit={{ opacity: 0 }}
                      className="space-y-3"
                    >
                      <Loader2 className="w-8 h-8 animate-spin mx-auto text-blue-500" />
                      <div className="text-sm text-zinc-600">Uploading video... {uploadProgress}%</div>
                      <div className="w-48 h-1 bg-gray-200 rounded-full mx-auto overflow-hidden">
                        <motion.div
                          className="h-full bg-blue-500 rounded-full"
                          initial={{ width: 0 }}
                          animate={{ width: `${uploadProgress}%` }}
                          transition={{ duration: 0.2 }}
                        />
                      </div>
                    </motion.div>
                  ) : (
                    <motion.div
                      initial={{ opacity: 0 }}
                      animate={{ opacity: 1 }}
                      exit={{ opacity: 0 }}
                      className="space-y-3"
                    >
                      <Upload className="w-8 h-8 mx-auto text-blue-500" />
                      <div>
                        <div className="text-sm font-medium text-zinc-700">
                          Drop your video here or click to browse
                        </div>
                        <div className="text-xs text-zinc-500 mt-1">
                          Supports MP4 and WebM formats
                        </div>
                      </div>
                    </motion.div>
                  )}
                </AnimatePresence>
              </UploadZone>

              {error && (
                <div className="flex items-center gap-2 text-sm text-red-500 font-medium bg-red-50 rounded-lg p-3">
                  <AlertCircle size={16} />
                  {error}
                </div>
              )}
            </motion.div>
          )}

          {blockObject && videoUrl && (
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ duration: 0.3 }}
              className="space-y-4"
            >
              <div className="flex items-center gap-2 flex-wrap">
                <div className="text-sm text-zinc-500 font-medium flex items-center gap-1">
                  <ArrowLeftRight size={14} />
                  Video Size:
                </div>
                {(Object.keys(VIDEO_SIZES) as VideoSize[]).map((size) => (
                  <SizeButton
                    key={size}
                    isActive={selectedSize === size}
                    onClick={() => handleSizeChange(size)}
                    whileHover={{ scale: 1.02 }}
                    whileTap={{ scale: 0.98 }}
                  >
                    {size === selectedSize && <CheckCircle2 size={14} />}
                    {VIDEO_SIZES[size].label}
                  </SizeButton>
                ))}
                <SizeButton
                  isActive={false}
                  onClick={handleDownload}
                  whileHover={{ scale: 1.02 }}
                  whileTap={{ scale: 0.98 }}
                  className="ml-auto"
                >
                  <Download size={14} />
                  Download
                </SizeButton>
              </div>

              <VideoContainer>
                <div
                  style={{ 
                    maxWidth: typeof VIDEO_SIZES[selectedSize].width === 'number' 
                      ? VIDEO_SIZES[selectedSize].width 
                      : '100%',
                    width: '100%'
                  }}
                >
                  <div className="relative rounded-lg overflow-hidden bg-black/5">
                    {isLoading && (
                      <div className="absolute inset-0 flex items-center justify-center bg-black/10 backdrop-blur-sm">
                        <Loader2 className="w-8 h-8 animate-spin text-white" />
                      </div>
                    )}
                    <video
                      controls
                      className={cn(
                        "w-full aspect-video object-contain bg-black/95 shadow-sm transition-all duration-200",
                        isLoading && "opacity-50 blur-sm"
                      )}
                      src={videoUrl}
                    />
                    <div className="absolute top-2 right-2 flex gap-1">
                      <button
                        onClick={handleExpand}
                        className="p-2 bg-black/50 hover:bg-black/70 rounded-full transition-colors"
                        title="Expand video"
                      >
                        <Expand className="w-4 h-4 text-white" />
                      </button>
                      <button
                        onClick={handleDownload}
                        className="p-2 bg-black/50 hover:bg-black/70 rounded-full transition-colors"
                        title="Download video"
                      >
                        <Download className="w-4 h-4 text-white" />
                      </button>
                    </div>
                  </div>
                </div>
              </VideoContainer>
            </motion.div>
          )}
        </VideoWrapper>
        
        {blockObject && videoUrl && (
          <Modal
            isDialogOpen={isModalOpen}
            onOpenChange={setIsModalOpen}
            dialogTitle="Video Player"
            minWidth="lg"
            minHeight="lg"
            dialogContent={
              <div className="w-full">
                <video
                  controls
                  autoPlay
                  className="w-full aspect-video object-contain rounded-lg shadow-lg bg-black"
                  src={videoUrl}
                />
              </div>
            }
          />
        )}
      </motion.div>
    </NodeViewWrapper>
  )
}

export default VideoBlockComponent



================================================
FILE: apps/web/components/Objects/Editor/Extensions/WebPreview/WebPreview.ts
================================================
import { mergeAttributes, Node } from '@tiptap/core'
import { ReactNodeViewRenderer } from '@tiptap/react'
import WebPreviewComponent from './WebPreviewComponent'

const WebPreview = Node.create({
  name: 'blockWebPreview',
  group: 'block',
  atom: true,

  addAttributes() {
    return {
      url: { default: null },
      title: { default: null },
      description: { default: null },
      og_image: { default: null },
      favicon: { default: null },
      og_type: { default: null },
      og_url: { default: null },
      alignment: { default: 'left' },
      buttonLabel: { default: 'Visit Site' },
      showButton: { default: false },
      openInPopup: { default: false },
    }
  },

  parseHTML() {
    return [
      { tag: 'web-preview' },
    ]
  },

  renderHTML({ HTMLAttributes }) {
    return ['web-preview', mergeAttributes(HTMLAttributes), 0]
  },

  addNodeView() {
    return ReactNodeViewRenderer(WebPreviewComponent)
  },
})

export default WebPreview; 


================================================
FILE: apps/web/components/Objects/Editor/Extensions/WebPreview/WebPreviewComponent.tsx
================================================
import React, { useState, useEffect, useRef } from 'react';
import { NodeViewWrapper } from '@tiptap/react';
import { Edit2, Save, X, AlignLeft, AlignCenter, AlignRight, Trash } from 'lucide-react';
import { useEditorProvider } from '@components/Contexts/Editor/EditorContext';
import { getUrlPreview } from '@services/courses/activities';
import Modal from '@components/Objects/StyledElements/Modal/Modal';
import { Input } from '@components/ui/input';
import { Label } from '@components/ui/label';
import { Checkbox } from '@components/ui/checkbox';
import { Button } from '@components/ui/button';
import toast from 'react-hot-toast';

interface EditorContext {
  isEditable: boolean;
  [key: string]: any;
}

interface WebPreviewProps {
  node: any;
  updateAttributes: (attrs: any) => void;
  extension: any;
  deleteNode?: () => void;
}

const ALIGNMENTS = [
  { value: 'left', label: <AlignLeft size={16} /> },
  { value: 'center', label: <AlignCenter size={16} /> },
  { value: 'right', label: <AlignRight size={16} /> },
];

const WebPreviewComponent: React.FC<WebPreviewProps> = ({ node, updateAttributes, deleteNode }) => {
  const [inputUrl, setInputUrl] = useState(node.attrs.url || '');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [editing, setEditing] = useState(!node.attrs.url);
  const inputRef = useRef<HTMLInputElement>(null);
  const editorContext = useEditorProvider() as EditorContext;
  const isEditable = editorContext?.isEditable ?? true;

  const previewData = {
    title: node.attrs.title,
    description: node.attrs.description,
    og_image: node.attrs.og_image,
    favicon: node.attrs.favicon,
    og_type: node.attrs.og_type,
    og_url: node.attrs.og_url,
    url: node.attrs.url,
  };

  const alignment = node.attrs.alignment || 'left';
  const hasPreview = !!previewData.title;

  const [buttonLabel, setButtonLabel] = useState(node.attrs.buttonLabel || 'Visit Site');
  const [showButton, setShowButton] = useState(node.attrs.showButton !== false);
  const [openInPopup, setOpenInPopup] = useState(node.attrs.openInPopup || false);
  const [popupOpen, setPopupOpen] = useState(false);
  const [modalOpen, setModalOpen] = useState(!node.attrs.url);

  const fetchPreview = async (url: string) => {
    setLoading(true);
    setError(null);
    try {
      const res = await getUrlPreview(url);
      if (!res) throw new Error('Failed to fetch preview');
      const data = res;
      
      // Check if metadata is insufficient (only has basic fields like favicon/url but no title/description)
      const hasMinimalMetadata = !data.title && !data.description && !data.og_image;
      
      if (hasMinimalMetadata) {
        toast.error("Unable to get metadata from this website. The preview card may appear incomplete.", {
          duration: 4000,
        });
      }
      
      updateAttributes({ ...data, url });
      setEditing(false);
    } catch (err: any) {
      setError(err.message || 'Error fetching preview');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    if (node.attrs.url && !hasPreview) {
      fetchPreview(node.attrs.url);
    }
    // eslint-disable-next-line
  }, []);

  useEffect(() => {
    if (editing && inputRef.current) {
      inputRef.current.focus();
    }
  }, [editing]);

  useEffect(() => {
    setButtonLabel(node.attrs.buttonLabel || 'Visit Site');
    setShowButton(!!node.attrs.showButton);
    setOpenInPopup(!!node.attrs.openInPopup);
  }, [node.attrs.buttonLabel, node.attrs.showButton, node.attrs.openInPopup]);

  useEffect(() => {
    if (!node.attrs.url) {
      setEditing(true);
      setModalOpen(true);
    }
  }, [node.attrs.url]);

  const handleAlignmentChange = (value: string) => {
    updateAttributes({ alignment: value });
  };

  const handleEdit = () => {
    setEditing(true);
    setInputUrl(node.attrs.url || '');
    setModalOpen(true);
  };

  const handleSaveEdit = () => {
    if (inputUrl && inputUrl !== node.attrs.url) {
      fetchPreview(inputUrl);
    } else {
      setEditing(false);
      setModalOpen(false);
    }
    updateAttributes({ buttonLabel, showButton, openInPopup });
    setModalOpen(false);
  };

  const handleCancelEdit = () => {
    setEditing(false);
    setInputUrl(node.attrs.url || '');
    setError(null);
    setModalOpen(false);
  };

  const handleDelete = () => {
    if (typeof deleteNode === 'function') {
      deleteNode();
    } else {
      updateAttributes({ url: null, title: null, description: null, og_image: null, favicon: null, og_type: null, og_url: null });
    }
  };

  // Compute alignment class for CardWrapper
  let alignClass = 'justify-start';
  if (alignment === 'center') alignClass = 'justify-center';
  else if (alignment === 'right') alignClass = 'justify-end';

  return (
    <NodeViewWrapper className="web-preview-block relative">
      {/* Popup Modal for Embedded Website */}
      <Modal
        isDialogOpen={popupOpen}
        onOpenChange={setPopupOpen}
        dialogTitle={previewData.title || 'Website Preview'}
        minWidth="xl"
        minHeight="xl"
        dialogContent={
          <iframe
            src={previewData.url}
            title="Embedded Website Preview"
            className="w-full h-full border-0 bg-white"
            style={{ display: 'block', borderRadius: 0 }}
            allowFullScreen
          />
        }
      />
      <div className={`flex w-full ${alignClass}`}> {/* CardWrapper */}
        <div className="bg-white nice-shadow rounded-xl max-w-[420px] min-w-[260px] my-2 px-6 pt-6 pb-4 relative "> {/* PreviewCard */}
          {/* Floating edit and delete buttons (only if not editing and isEditable) */}
          {isEditable && !editing && (
            <div className="flex flex-col gap-2 absolute -top-3 -right-3 z-20">
              <button
                className="flex items-center justify-center bg-yellow-50 text-yellow-700 border border-yellow-200 shadow-md rounded-md p-1.5 hover:bg-yellow-100"
                onClick={handleEdit}
                title="Edit URL"
                type="button"
              >
                <Edit2 size={16} />
              </button>
              <button
                className="flex items-center justify-center bg-red-50 text-red-700 border border-red-200 shadow-md rounded-md p-1.5 hover:bg-red-100"
                onClick={handleDelete}
                title="Delete Card"
                type="button"
              >
                <Trash size={16} />
              </button>
            </div>
          )}
          {/* Modal for editing */}
          <Modal
            isDialogOpen={modalOpen}
            onOpenChange={(open) => {
              setModalOpen(open);
              if (!open) handleCancelEdit();
            }}
            dialogTitle="Edit Web Preview Card"
            dialogDescription="Update the website preview, button, and display options."
            minWidth="md"
            dialogContent={
              <form className="space-y-6" onSubmit={e => { e.preventDefault(); handleSaveEdit(); }}>
                <div className="space-y-2">
                  <Label htmlFor="web-url-input">Website URL</Label>
                  <Input
                    id="web-url-input"
                    ref={inputRef}
                    type="text"
                    placeholder="Enter website URL..."
                    value={inputUrl}
                    onChange={e => setInputUrl(e.target.value)}
                    disabled={loading}
                    autoFocus
                  />
                </div>
                <div className="space-y-2">
                  <Label>Button Options</Label>
                  <div className="flex flex-col gap-3  pt-3">
                    <div className="flex items-center gap-2">
                      <Checkbox
                        id="show-button"
                        checked={showButton}
                        onCheckedChange={checked => setShowButton(!!checked)}
                      />
                      <Label htmlFor="show-button" className="text-sm">Show button</Label>
                    </div>
                    {showButton && (
                      <>
                      <div className="flex items-center gap-2">
                          <Checkbox
                            id="open-in-popup"
                            checked={openInPopup}
                            onCheckedChange={checked => setOpenInPopup(!!checked)}
                          />
                          <Label htmlFor="open-in-popup" className="text-sm">Open in-app popup (might not work on all websites)</Label>
                        </div>
                        <div className="flex  gap-2 flex-col ">
                          <Label htmlFor="button-label" className="text-sm">Button label</Label>
                          <Input
                            id="button-label"
                            type="text"
                            value={buttonLabel}
                            onChange={e => setButtonLabel(e.target.value)}
                            placeholder="Button label"
                            className="w-36"
                          />
                        </div>
                        
                      </>
                    )}
                  </div>
                </div>
                <div className="space-y-">
                  <Label>Alignment</Label>
                  <div className="flex gap-2 pt-3">
                    {ALIGNMENTS.map(opt => (
                      <Button
                        key={opt.value}
                        type="button"
                        variant={alignment === opt.value ? 'default' : 'outline'}
                        size="sm"
                        aria-pressed={alignment === opt.value}
                        onClick={() => handleAlignmentChange(opt.value)}
                        className={`rounded-full px-2 py-1 ${alignment === opt.value ? 'bg-black text-white' : ''}`}
                      >
                        {opt.label}
                      </Button>
                    ))}
                  </div>
                </div>
                {error && <div className="text-red-600 text-xs mt-2">{error}</div>}
                <div className="flex justify-end gap-2 mt-2">
                  <Button type="button" variant="outline" onClick={handleCancelEdit}>
                    <span className="flex items-center"><X size={16} className="mr-1" /> Cancel</span>
                  </Button>
                  <Button type="submit" disabled={loading || !inputUrl}>
                    <span className="flex items-center"><Save size={16} className="mr-1" /> Save</span>
                  </Button>
                </div>
              </form>
            }
          />
          {/* Only show preview card when not editing */}
          {hasPreview && !editing && (
            <>
              <a
                href={previewData.url}
                target="_blank"
                rel="noopener noreferrer"
                className="no-underline hover:no-underline focus:no-underline active:no-underline"
                style={{ textDecoration: 'none', borderBottom: 'none' }}
              >
                {previewData.og_image && (
                  <div className="-mt-6 -mx-6 mb-0 rounded-t-xl overflow-hidden">
                    <img
                      src={previewData.og_image}
                      alt="preview"
                      className="w-full h-40 object-cover block"
                    />
                  </div>
                )}
                <div className="pt-4 pb-2">
                  <a
                    href={previewData.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="no-underline hover:no-underline focus:no-underline active:no-underline"
                    style={{ textDecoration: 'none', borderBottom: 'none' }}
                  >
                    <span
                      className="font-semibold text-lg text-[#232323] mb-1.5 leading-tight no-underline hover:no-underline focus:no-underline active:no-underline"
                      style={{ textDecoration: 'none', borderBottom: 'none' }}
                    >
                      {previewData.title}
                    </span>
                    <span
                      className="block text-gray-700 text-sm mb-3 leading-snug no-underline hover:no-underline focus:no-underline active:no-underline"
                      style={{ textDecoration: 'none', borderBottom: 'none' }}
                    >
                      {previewData.description}
                    </span>
                  </a>
                </div>
              </a>
              <div className="flex items-center mt-0 pt-2 border-t border-gray-100">
                {previewData.favicon && (
                  <img
                    src={previewData.favicon}
                    alt="favicon"
                    className="w-[18px] h-[18px] mr-2 rounded bg-gray-100"
                  />
                )}
                <span className="text-gray-500 text-xs truncate">{previewData.url}</span>
              </div>
              {showButton && previewData.url && (
                openInPopup ? (
                  <button
                    type="button"
                    className="block w-full mt-4 rounded-xl bg-black nice-shadow text-[16px] font-semibold text-white py-2.5 px-4 text-center no-underline hover:bg-gray-900 hover:shadow-lg transition-all"
                    style={{ textDecoration: 'none', color: 'white' }}
                    onClick={() => setPopupOpen(true)}
                  >
                    {buttonLabel || 'Visit Site'}
                  </button>
                ) : (
                  <a
                    href={previewData.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="block w-full mt-4 rounded-xl bg-black nice-shadow text-[16px] font-semibold text-white py-2.5 px-4 text-center no-underline hover:bg-gray-900 hover:shadow-lg transition-all"
                    style={{ textDecoration: 'none', color: 'white' }}
                  >
                    {buttonLabel || 'Visit Site'}
                  </a>
                )
              )}
              {/* Alignment bar in view mode */}
              {isEditable && (
                <div className="flex flex-col items-center mt-4">
                  <div className="flex items-center gap-1"> {/* AlignmentBar */}
                    <span className="text-xs text-gray-500 mr-1">Align:</span>
                    {ALIGNMENTS.map(opt => (
                      <button
                        key={opt.value}
                        aria-pressed={alignment === opt.value}
                        onClick={() => handleAlignmentChange(opt.value)}
                        title={`Align ${opt.value}`}
                        type="button"
                        className={`flex items-center justify-center border transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-blue-300 p-1.5 rounded-full text-gray-600
                          ${alignment === opt.value
                            ? 'bg-gray-600 text-white border-gray-600 hover:bg-gray-700'
                            : 'bg-white border-gray-200 hover:bg-gray-100'}
                        `}
                      >
                        {opt.label}
                      </button>
                    ))}
                  </div>
                </div>
              )}
            </>
          )}
        </div>
      </div>
    </NodeViewWrapper>
  );
};

export default WebPreviewComponent; 


================================================
FILE: apps/web/components/Objects/Editor/Toolbar/LinkInputTooltip.tsx
================================================
import React, { useState, useEffect } from 'react'
import styled from 'styled-components'
import { CheckIcon, Cross2Icon } from '@radix-ui/react-icons'

interface LinkInputTooltipProps {
  onSave: (url: string) => void
  onCancel: () => void
  currentUrl?: string
}

const LinkInputTooltip: React.FC<LinkInputTooltipProps> = ({ onSave, onCancel, currentUrl }) => {
  const [url, setUrl] = useState(currentUrl || '')

  useEffect(() => {
    setUrl(currentUrl || '')
  }, [currentUrl])

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault()
    if (url) {
      // Ensure the URL has a protocol
      const formattedUrl = url.startsWith('http://') || url.startsWith('https://') 
        ? url 
        : `https://${url}`
      onSave(formattedUrl)
    }
  }

  return (
    <TooltipContainer>
      <Form onSubmit={handleSubmit}>
        <Input
          type="text"
          placeholder="Enter URL"
          value={url}
          onChange={(e) => setUrl(e.target.value)}
          autoFocus
        />
        <ButtonGroup>
          <SaveButton type="submit" disabled={!url}>
            <CheckIcon />
          </SaveButton>
          <CancelButton type="button" onClick={onCancel}>
            <Cross2Icon />
          </CancelButton>
        </ButtonGroup>
      </Form>
    </TooltipContainer>
  )
}

const TooltipContainer = styled.div`
  position: absolute;
  top: 100%;
  left: 0;
  background: white;
  border: 1px solid rgba(217, 217, 217, 0.5);
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  padding: 8px;
  margin-top: 4px;
`

const Form = styled.form`
  display: flex;
  align-items: center;
  gap: 4px;
`

const Input = styled.input`
  padding: 4px 8px;
  border: 1px solid rgba(217, 217, 217, 0.5);
  border-radius: 4px;
  font-size: 12px;
  width: 200px;

  &:focus {
    outline: none;
    border-color: rgba(217, 217, 217, 0.8);
  }
`

const ButtonGroup = styled.div`
  display: flex;
  gap: 2px;
`

const Button = styled.button`
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 4px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  background: rgba(217, 217, 217, 0.24);
  transition: background 0.2s;

  &:hover {
    background: rgba(217, 217, 217, 0.48);
  }

  &:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
`

const SaveButton = styled(Button)`
  color: #4CAF50;
`

const CancelButton = styled(Button)`
  color: #F44336;
`

export default LinkInputTooltip 


================================================
FILE: apps/web/components/Objects/Editor/Toolbar/ToolbarButtons.tsx
================================================
import styled from 'styled-components'
import {
  FontBoldIcon,
  FontItalicIcon,
  StrikethroughIcon,
  ArrowLeftIcon,
  ArrowRightIcon,
  DividerVerticalIcon,
  ListBulletIcon,
  TableIcon,
  RowsIcon,
  ColumnsIcon,
  SectionIcon,
  ContainerIcon,
  ChevronDownIcon,
} from '@radix-ui/react-icons'
import {
  AlertCircle,
  AlertTriangle,
  BadgeHelp,
  Code,
  Cuboid,
  FileText,
  ImagePlus,
  Link2,
  MousePointerClick,
  RotateCw,
  Sigma,
  Tags,
  User,
  Video,
  List,
  ListOrdered,
  Globe,
  GitBranch,
} from 'lucide-react'
import { SiYoutube } from '@icons-pack/react-simple-icons'
import ToolTip from '@components/Objects/StyledElements/Tooltip/Tooltip'
import React from 'react'
import LinkInputTooltip from './LinkInputTooltip'

export const ToolbarButtons = ({ editor, props }: any) => {
  const [showTableMenu, setShowTableMenu] = React.useState(false)
  const [showListMenu, setShowListMenu] = React.useState(false)
  const [showLinkInput, setShowLinkInput] = React.useState(false)
  const linkButtonRef = React.useRef<HTMLDivElement>(null)

  if (!editor) {
    return null
  }


  const tableOptions = [
    {
      label: 'Insert new table (3Ã—3)',
      icon: <TableIcon />,
      action: () => editor.chain().focus().insertTable({ rows: 3, cols: 3, withHeaderRow: true }).run()
    },
    {
      label: 'Add row below',
      icon: <RowsIcon />,
      action: () => editor.chain().focus().addRowAfter().run()
    },
    {
      label: 'Add column right',
      icon: <ColumnsIcon />,
      action: () => editor.chain().focus().addColumnAfter().run()
    },
    {
      label: 'Delete current row',
      icon: <SectionIcon />,
      action: () => editor.chain().focus().deleteRow().run()
    },
    {
      label: 'Delete current column',
      icon: <ContainerIcon />,
      action: () => editor.chain().focus().deleteColumn().run()
    }
  ]

  const listOptions = [
    {
      label: 'Bullet List',
      icon: <List size={15} />,
      action: () => {
        if (editor.isActive('bulletList')) {
          editor.chain().focus().toggleBulletList().run()
        } else {
          editor.chain().focus().toggleOrderedList().run()
          editor.chain().focus().toggleBulletList().run()
        }
      }
    },
    {
      label: 'Ordered List',
      icon: <ListOrdered size={15} />,
      action: () => {
        if (editor.isActive('orderedList')) {
          editor.chain().focus().toggleOrderedList().run()
        } else {
          editor.chain().focus().toggleBulletList().run()
          editor.chain().focus().toggleOrderedList().run()
        }
      }
    }
  ]

  const handleLinkClick = () => {
    // Store the current selection
    const { from, to } = editor.state.selection
    
    if (editor.isActive('link')) {
      const currentLink = editor.getAttributes('link')
      setShowLinkInput(true)
    } else {
      setShowLinkInput(true)
    }

    // Restore the selection after a small delay to ensure the tooltip is rendered
    setTimeout(() => {
      editor.commands.setTextSelection({ from, to })
    }, 0)
  }

  const getCurrentLinkUrl = () => {
    if (editor.isActive('link')) {
      return editor.getAttributes('link').href
    }
    return ''
  }

  const handleLinkSave = (url: string) => {
    editor
      .chain()
      .focus()
      .setLink({ 
        href: url,
        target: '_blank',
        rel: 'noopener noreferrer'
      })
      .run()
    setShowLinkInput(false)
  }

  const handleLinkCancel = () => {
    setShowLinkInput(false)
  }

  return (
    <ToolButtonsWrapper>
      <ToolBtn onClick={() => editor.chain().focus().undo().run()} aria-label="Undo last action">
        <ArrowLeftIcon />
      </ToolBtn>
      <ToolBtn onClick={() => editor.chain().focus().redo().run()} aria-label="Redo last action">
        <ArrowRightIcon />
      </ToolBtn>
      <ToolBtn
        onClick={() => editor.chain().focus().toggleBold().run()}
        className={editor.isActive('bold') ? 'is-active' : ''}
        aria-label="Toggle bold formatting"
      >
        <FontBoldIcon />
      </ToolBtn>
      <ToolBtn
        onClick={() => editor.chain().focus().toggleItalic().run()}
        className={editor.isActive('italic') ? 'is-active' : ''}
        aria-label="Toggle italic formatting"
      >
        <FontItalicIcon />
      </ToolBtn>
      <ToolBtn
        onClick={() => editor.chain().focus().toggleStrike().run()}
        className={editor.isActive('strike') ? 'is-active' : ''}
        aria-label="Toggle strikethrough formatting"
      >
        <StrikethroughIcon />
      </ToolBtn>
      <ListMenuWrapper>
        <ToolBtn
          onClick={() => setShowListMenu(!showListMenu)}
          className={showListMenu || editor.isActive('bulletList') || editor.isActive('orderedList') ? 'is-active' : ''}
          aria-label="Insert list"
        >
          <ListBulletIcon />
          <ChevronDownIcon />
        </ToolBtn>
        {showListMenu && (
          <ListDropdown>
            {listOptions.map((option, index) => (
              <ListMenuItem 
                key={index}
                onClick={() => {
                  option.action()
                  setShowListMenu(false)
                }}
                className={editor.isActive(option.label === 'Bullet List' ? 'bulletList' : 'orderedList') ? 'is-active' : ''}
              >
                <span className="icon">{option.icon}</span>
                <span className="label">{option.label}</span>
              </ListMenuItem>
            ))}
          </ListDropdown>
        )}
      </ListMenuWrapper>
      <ToolSelect
        value={
          editor.isActive('heading', { level: 1 }) ? "1" :
          editor.isActive('heading', { level: 2 }) ? "2" :
          editor.isActive('heading', { level: 3 }) ? "3" :
          editor.isActive('heading', { level: 4 }) ? "4" :
          editor.isActive('heading', { level: 5 }) ? "5" :
          editor.isActive('heading', { level: 6 }) ? "6" : "0"
        }
        onChange={(e) => {
          const value = e.target.value;
          if (value === "0") {
            editor.chain().focus().setParagraph().run();
          } else {
            editor.chain().focus().toggleHeading({ level: parseInt(value) }).run();
          }
        }}
      >
        <option value="0">Paragraph</option>
        <option value="1">Heading 1</option>
        <option value="2">Heading 2</option>
        <option value="3">Heading 3</option>
        <option value="4">Heading 4</option>
        <option value="5">Heading 5</option>
        <option value="6">Heading 6</option>
      </ToolSelect>
      <TableMenuWrapper>
        <ToolBtn
          onClick={() => setShowTableMenu(!showTableMenu)}
          className={showTableMenu ? 'is-active' : ''}
          aria-label="Insert table"
        >
          <TableIcon width={18} />
          <ChevronDownIcon  />
        </ToolBtn>
        {showTableMenu && (
          <TableDropdown>
            {tableOptions.map((option, index) => (
              <TableMenuItem 
                key={index}
                onClick={() => {
                  option.action()
                  setShowTableMenu(false)
                }}
              >
                <span className="icon">{option.icon}</span>
                <span className="label">{option.label}</span>
              </TableMenuItem>
            ))}
          </TableDropdown>
        )}
      </TableMenuWrapper>
      <DividerVerticalIcon
        style={{ marginTop: 'auto', marginBottom: 'auto', color: 'grey' }}
      />
      <ToolTip content={'Info Callout'}>
        <ToolBtn
          onClick={() => editor.chain().focus().toggleNode('calloutInfo').run()}
          aria-label="Insert info callout"
        >
          <AlertCircle size={15} />
        </ToolBtn>
      </ToolTip>
      <ToolTip content={'Warning Callout'}>
        <ToolBtn
          onClick={() =>
            editor.chain().focus().toggleNode('calloutWarning').run()
          }
          aria-label="Insert warning callout"
        >
          <AlertTriangle size={15} />
        </ToolBtn>
      </ToolTip>
      <ToolTip content={'Link'}>
        <div style={{ position: 'relative' }}>
          <ToolBtn
            ref={linkButtonRef}
            onClick={handleLinkClick}
            className={editor.isActive('link') ? 'is-active' : ''}
            aria-label="Insert or edit link"
          >
            <Link2 size={15} />
          </ToolBtn>
          {showLinkInput && (
            <LinkInputTooltip
              onSave={handleLinkSave}
              onCancel={handleLinkCancel}
              currentUrl={getCurrentLinkUrl()}
            />
          )}
        </div>
      </ToolTip>
      <ToolTip content={'Image'}>
        <ToolBtn
          onClick={() =>
            editor
              .chain()
              .focus()
              .insertContent({
                type: 'blockImage',
              })
              .run()
          }
          aria-label="Insert image"
        >
          <ImagePlus size={15} />
        </ToolBtn>
      </ToolTip>
      <ToolTip content={'Video'}>
        <ToolBtn
          onClick={() =>
            editor
              .chain()
              .focus()
              .insertContent({
                type: 'blockVideo',
              })
              .run()
          }
          aria-label="Insert video"
        >
          <Video size={15} />
        </ToolBtn>
      </ToolTip>
      <ToolTip content={'YouTube video'}>
        <ToolBtn onClick={() => editor.chain().focus().insertContent({ type: 'blockEmbed' }).run()} aria-label="Insert YouTube video">
          <SiYoutube size={15} />
        </ToolBtn>
      </ToolTip>
      <ToolTip content={'Math Equation (LaTeX)'}>
        <ToolBtn
          onClick={() =>
            editor
              .chain()
              .focus()
              .insertContent({
                type: 'blockMathEquation',
              })
              .run()
          }
          aria-label="Insert math equation (LaTeX)"
        >
          <Sigma size={15} />
        </ToolBtn>
      </ToolTip>
      <ToolTip content={'PDF Document'}>
        <ToolBtn
          onClick={() =>
            editor
              .chain()
              .focus()
              .insertContent({
                type: 'blockPDF',
              })
              .run()
          }
          aria-label="Insert PDF document"
        >
          <FileText size={15} />
        </ToolBtn>
      </ToolTip>
      <ToolTip content={'Interactive Quiz'}>
        <ToolBtn
          onClick={() =>
            editor
              .chain()
              .focus()
              .insertContent({
                type: 'blockQuiz',
              })
              .run()
          }
          aria-label="Insert interactive quiz"
        >
          <BadgeHelp size={15} />
        </ToolBtn>
      </ToolTip>
      <ToolTip content={'Code Block'}>
        <ToolBtn
          onClick={() => editor.chain().focus().toggleCodeBlock().run()}
          className={editor.isActive('codeBlock') ? 'is-active' : ''}
          aria-label="Insert code block"
        >
          <Code size={15} />
        </ToolBtn>
      </ToolTip>
      <ToolTip content={'External Object (Embed)'}>
        <ToolBtn
          onClick={() => editor.chain().focus().insertContent({ type: 'blockEmbed' }).run()}
          aria-label="Insert external object or embed"
        >
          <Cuboid size={15} />
        </ToolBtn>
      </ToolTip>
      <ToolTip content={'Badges'}>
        <ToolBtn
          onClick={() => editor.chain().focus().insertContent({
            type: 'badge',
            content: [
              {
                type: 'text',
                text: 'This is a Badge'
              }
            ]
          }).run()}
          aria-label="Insert badge"
        >
          <Tags size={15} />
        </ToolBtn>
      </ToolTip>
      <ToolTip content={'Button'}>
        <ToolBtn
          onClick={() => editor.chain().focus().insertContent({
            type: 'button',
            content: [
              {
                type: 'text',
                text: 'Click me'
              }
            ]
          }).run()}
          aria-label="Insert button"
        >
          <MousePointerClick size={15} />
        </ToolBtn>
      </ToolTip>
      <ToolTip content={'User'}>
        <ToolBtn
          onClick={() => editor.chain().focus().insertContent({ type: 'blockUser' }).run()}
          aria-label="Insert user reference"
        >
          <User size={15} />
        </ToolBtn>
      </ToolTip>
      <ToolTip content={'Web Preview'}>
        <ToolBtn
          onClick={() =>
            editor.chain().focus().insertContent({
              type: 'blockWebPreview',
            }).run()
          }
          aria-label="Insert web preview"
        >
          <Globe size={15} />
        </ToolBtn>
      </ToolTip>
      <ToolTip content={'Flipcard'}>
        <ToolBtn
          onClick={() =>
            editor.chain().focus().insertContent({
              type: 'flipcard',
              attrs: {
                question: 'Click to reveal the answer',
                answer: 'This is the answer',
                color: 'blue',
                alignment: 'center',
                size: 'medium'
              }
            }).run()
          }
          aria-label="Insert flipcard"
        >
          <RotateCw size={15} />
        </ToolBtn>
      </ToolTip>
      <ToolTip content={'Interactive Scenarios'}>
        <ToolBtn
          onClick={() =>
            editor.chain().focus().insertContent({
              type: 'scenarios',
              attrs: {
                title: 'Interactive Scenario',
                scenarios: [
                  {
                    id: '1',
                    text: 'Welcome to this interactive scenario. What would you like to do?',
                    imageUrl: '',
                    options: [
                      { id: 'opt1', text: 'Continue exploring', nextScenarioId: '2' },
                      { id: 'opt2', text: 'Learn more about the topic', nextScenarioId: '3' }
                    ]
                  },
                  {
                    id: '2',
                    text: 'Great choice! You are now exploring further. What\'s your next step?',
                    imageUrl: '',
                    options: [
                      { id: 'opt3', text: 'Go back to start', nextScenarioId: '1' },
                      { id: 'opt4', text: 'Finish scenario', nextScenarioId: null }
                    ]
                  },
                  {
                    id: '3',
                    text: 'Here\'s more information about the topic. This helps you understand better.',
                    imageUrl: '',
                    options: [
                      { id: 'opt5', text: 'Go back to start', nextScenarioId: '1' },
                      { id: 'opt6', text: 'Finish scenario', nextScenarioId: null }
                    ]
                  }
                ],
                currentScenarioId: '1'
              }
            }).run()
          }
          aria-label="Insert interactive scenarios"
        >
          <GitBranch size={15} />
        </ToolBtn>
      </ToolTip>
    </ToolButtonsWrapper>
  )
}

const ToolButtonsWrapper = styled.div`
  display: flex;
  flex-direction: row;
  align-items: left;
  justify-content: left;
`

const ToolBtn = styled.div`
  display: flex;
  background: rgba(217, 217, 217, 0.24);
  border-radius: 6px;
  min-width: 25px;
  height: 25px;
  padding: 5px;
  margin-right: 5px;
  transition: all 0.2s ease-in-out;

  svg {
    padding: 1px;
  }

  &.is-active {
    background: rgba(176, 176, 176, 0.5);

    &:hover {
      background: rgba(139, 139, 139, 0.5);
      cursor: pointer;
    }
  }

  &:hover {
    background: rgba(217, 217, 217, 0.48);
    cursor: pointer;
  }
`

const ToolSelect = styled.select`
  display: flex;
  background: rgba(217, 217, 217, 0.185);
  border-radius: 6px;
  width: 120px;
  border: none;
  height: 25px;
  padding: 2px 5px;
  font-size: 11px;
  font-family: 'DM Sans';
  margin-right: 5px;
  cursor: pointer;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 5px center;
  background-size: 12px;
  padding-right: 20px;

  &:hover {
    background-color: rgba(217, 217, 217, 0.3);
  }

  &:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(217, 217, 217, 0.5);
  }
`

const TableMenuWrapper = styled.div`
  position: relative;
  display: inline-block;
`

const TableDropdown = styled.div`
  position: absolute;
  top: 100%;
  left: 0;
  background: white;
  border: 1px solid rgba(217, 217, 217, 0.5);
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  min-width: 180px;
  margin-top: 4px;
`

const TableMenuItem = styled.div`
  display: flex;
  align-items: center;
  padding: 8px 12px;
  cursor: pointer;
  transition: background 0.2s;

  &:hover {
    background: rgba(217, 217, 217, 0.24);
  }

  .icon {
    margin-right: 8px;
    display: flex;
    align-items: center;
  }

  .label {
    font-size: 12px;
    font-family: 'DM Sans';
  }
`

const ListMenuWrapper = styled.div`
  position: relative;
  display: inline-block;
`

const ListDropdown = styled.div`
  position: absolute;
  top: 100%;
  left: 0;
  background: white;
  border: 1px solid rgba(217, 217, 217, 0.5);
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  min-width: 180px;
  margin-top: 4px;
`

const ListMenuItem = styled.div`
  display: flex;
  align-items: center;
  padding: 8px 12px;
  cursor: pointer;
  transition: background 0.2s;

  &:hover {
    background: rgba(217, 217, 217, 0.24);
  }

  &.is-active {
    background: rgba(176, 176, 176, 0.5);
  }

  .icon {
    margin-right: 8px;
    display: flex;
    align-items: center;
  }

  .label {
    font-size: 12px;
    font-family: 'DM Sans';
  }
`


================================================
FILE: apps/web/components/Objects/Loaders/PageLoading.tsx
================================================
'use client'
import { Loader2 } from 'lucide-react'
import { motion } from 'framer-motion'

function PageLoading() {
  return (
    <div className="fixed inset-0 flex items-center justify-center">
      <motion.div
        initial={{ opacity: 0, scale: 0.95 }}
        animate={{ 
          opacity: [0, 0.5, 1], 
          scale: 1,
          transition: {
            duration: 0.8,
            scale: {
              type: "spring",
              stiffness: 50,
              damping: 15,
              delay: 0.2
            },
            opacity: {
              duration: 0.6,
              times: [0, 0.6, 1]
            }
          }
        }}
        exit={{ 
          opacity: 0, 
          scale: 0.95,
          transition: {
            duration: 0.4,
            ease: "easeOut"
          }
        }}
      >
        <Loader2 className="w-10 h-10 text-gray-400 animate-spin" />
      </motion.div>
    </div>
  )
}

export default PageLoading



================================================
FILE: apps/web/components/Objects/Menus/OrgMenu.tsx
================================================
'use client'
import React, { useEffect, useState } from 'react'
import Link from 'next/link'
import { getUriWithOrg } from '@services/config/config'
import { HeaderProfileBox } from '@components/Security/HeaderProfileBox'
import MenuLinks from './OrgMenuLinks'
import { getOrgLogoMediaDirectory } from '@services/media/media'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { useOrg } from '@components/Contexts/OrgContext'
import { SearchBar } from '@components/Objects/Search/SearchBar'
import { usePathname } from 'next/navigation'

export const OrgMenu = (props: any) => {
  const orgslug = props.orgslug
  const session = useLHSession() as any;
  const access_token = session?.data?.tokens?.access_token;
  const [feedbackModal, setFeedbackModal] = React.useState(false)
  const org = useOrg() as any;
  const [isMenuOpen, setIsMenuOpen] = React.useState(false)
  const [isFocusMode, setIsFocusMode] = useState(false)
  const pathname = usePathname()

  useEffect(() => {
    // Only check focus mode if we're in an activity page
    if (typeof window !== 'undefined' && pathname?.includes('/activity/')) {
      const saved = localStorage.getItem('globalFocusMode');
      setIsFocusMode(saved === 'true');
    } else {
      setIsFocusMode(false);
    }

    // Add storage event listener for cross-window changes
    const handleStorageChange = (e: StorageEvent) => {
      if (e.key === 'globalFocusMode' && pathname?.includes('/activity/')) {
        setIsFocusMode(e.newValue === 'true');
      }
    };

    // Add custom event listener for same-window changes
    const handleFocusModeChange = (e: CustomEvent) => {
      if (pathname?.includes('/activity/')) {
        setIsFocusMode(e.detail.isFocusMode);
      }
    };

    window.addEventListener('storage', handleStorageChange);
    window.addEventListener('focusModeChange', handleFocusModeChange as EventListener);

    // Cleanup
    return () => {
      window.removeEventListener('storage', handleStorageChange);
      window.removeEventListener('focusModeChange', handleFocusModeChange as EventListener);
    };
  }, [pathname]);

  function closeFeedbackModal() {
    setFeedbackModal(false)
  }

  function toggleMenu() {
    setIsMenuOpen(!isMenuOpen)
  }

  // Only hide menu if we're in an activity page and focus mode is enabled
  if (pathname?.includes('/activity/') && isFocusMode) {
    return null;
  }

  return (
    <>
      <div className="backdrop-blur-lg h-[60px] blur-3xl -z-10"></div>
      <div className="backdrop-blur-lg bg-white/90 fixed top-0 left-0 right-0 h-[60px] ring-1 ring-inset ring-gray-500/10 shadow-[0px_4px_16px_rgba(0,0,0,0.03)] z-50">
        <div className="flex items-center justify-between w-full max-w-(--breakpoint-2xl) mx-auto px-4 sm:px-6 lg:px-16 h-full">
          <div className="flex items-center space-x-5 md:w-auto w-full">
            <div className="logo flex md:w-auto w-full justify-center">
              <Link href={getUriWithOrg(orgslug, '/')}>
                <div className="flex w-auto h-9 rounded-md items-center m-auto py-1 justify-center">
                  {org?.logo_image ? (
                    <img
                      src={`${getOrgLogoMediaDirectory(org.org_uuid, org?.logo_image)}`}
                      alt="Learnhouse"
                      style={{ width: 'auto', height: '100%' }}
                      className="rounded-md"
                    />
                  ) : (
                    <LearnHouseLogo />
                  )}
                </div>
              </Link>
            </div>
            <div className="hidden md:flex">
              <MenuLinks orgslug={orgslug} />
            </div>
          </div>
          
          {/* Search Section */}
          <div className="hidden md:flex flex-1 justify-center max-w-lg px-4">
            <SearchBar orgslug={orgslug} className="w-full" />
          </div>

          <div className="flex items-center space-x-4">
            <div className="hidden md:flex">
              <HeaderProfileBox />
            </div>
            <button
              className="md:hidden text-gray-600 focus:outline-hidden"
              onClick={toggleMenu}
            >
              {isMenuOpen ? (
                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              ) : (
                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
                </svg>
              )}
            </button>
          </div>
        </div>
      </div>
      <div
        className={`fixed inset-x-0 z-40 bg-white/80 backdrop-blur-lg md:hidden shadow-lg transition-all duration-300 ease-in-out ${
          isMenuOpen ? 'top-[60px] opacity-100' : '-top-full opacity-0'
        }`}
      >
        <div className="flex flex-col px-4 py-3 space-y-4 justify-center items-center">
          {/* Mobile Search */}
          <div className="w-full px-2">
            <SearchBar orgslug={orgslug} isMobile={true} />
          </div>
          <div className='py-4'>
            <MenuLinks orgslug={orgslug} />
          </div>
          <div className="border-t border-gray-200">
            <HeaderProfileBox />
          </div>
        </div>
      </div>
    </>
  )
}

const LearnHouseLogo = () => {
  return (
    <svg
      width="133"
      height="80"
      viewBox="0 0 433 80"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <rect width="80" height="80" rx="24" fill="black" />
      <rect
        width="80"
        height="80"
        rx="24"
        fill="url(#paint0_angular_1555_220)"
      />
      <rect
        x="0.5"
        y="0.5"
        width="79"
        height="79"
        rx="23.5"
        stroke="white"
        strokeOpacity="0.12"
      />
      <path
        d="M37.546 55.926V35.04L33.534 30.497L37.546 29.258V27.016L33.534 22.473L44.626 19.11V55.926L48.992 61H33.18L37.546 55.926Z"
        fill="white"
      />
      <path
        d="M113.98 54.98V30.2L109.22 24.81L113.98 23.34V20.68L109.22 15.29L122.38 11.3V54.98L127.56 61H108.8L113.98 54.98ZM157.704 41.19V41.26H135.234C136.004 50.29 140.834 54.07 146.294 54.07C151.054 54.07 155.254 51.69 156.304 48.75L157.354 49.17C154.834 55.54 149.864 61.98 141.534 61.98C132.364 61.98 127.184 53.79 127.184 45.39C127.184 36.36 132.784 26 144.194 26C152.524 26 157.634 31.6 157.704 41.05L157.774 41.19H157.704ZM148.674 39.16V38.53C148.674 31.04 145.664 28.1 142.584 28.1C137.264 28.1 135.094 34.47 135.094 38.67V39.16H148.674ZM178.717 61V55.12C176.057 57.71 171.157 61.7 166.537 61.7C161.707 61.7 158.137 59.32 158.137 53.65C158.137 46.51 166.607 42.87 178.717 38.6C178.717 33 178.577 28.66 172.837 28.66C167.237 28.66 163.877 32.58 160.307 37.9H159.817V26.7H188.657L187.117 32.72V56.45H187.187L192.367 61H178.717ZM178.717 53.23V40.56C167.727 44.97 167.377 47.98 167.377 51.34C167.377 54.7 169.687 56.17 172.627 56.17C174.797 56.17 176.967 55.05 178.717 53.23ZM221.429 39.09H220.869C217.789 31.74 213.659 29.29 210.439 29.29C205.609 29.29 205.609 32.79 205.609 39.93V54.98L212.119 61H192.029L197.209 54.98V32.09L192.449 26.7H221.429V39.09ZM261.467 61H242.707L247.747 54.98V39.44C247.747 34.05 246.977 30.62 241.587 30.62C238.997 30.62 236.337 31.74 234.097 34.75V54.98L239.137 61H220.377L225.697 54.98V36.08L220.937 30.69L234.097 26V32.37C236.897 28.03 241.447 25.86 245.647 25.86C252.787 25.86 256.147 30.48 256.147 37.06V54.98L261.467 61ZM274.343 11.3V32.23C277.143 27.89 281.693 25.72 285.893 25.72C293.033 25.72 296.393 30.34 296.393 36.92V54.98H296.463L301.643 61H282.883L287.993 55.05V39.3C287.993 33.91 287.223 30.48 281.833 30.48C279.243 30.48 276.583 31.6 274.343 34.61V54.98L279.523 61H260.763L265.943 54.98V21.38L261.183 15.99L274.343 11.3ZM335.945 42.31C335.945 51.34 329.855 61.84 316.835 61.84C306.895 61.84 301.645 53.79 301.645 45.39C301.645 36.36 307.735 25.86 320.755 25.86C330.695 25.86 335.945 33.91 335.945 42.31ZM316.975 28.52C311.165 28.52 310.535 34.82 310.535 39.02C310.535 49.94 314.525 59.18 320.685 59.18C325.865 59.18 327.195 52.32 327.195 48.68C327.195 37.76 323.135 28.52 316.975 28.52ZM349.01 26.63V48.12C349.01 53.51 349.78 56.94 355.17 56.94C357.55 56.94 360 55.75 361.82 53.65V32.72L356.64 26.63H370.22V55.26L374.98 61L361.82 61.42V55.82C359.3 59.32 356.08 61.7 351.11 61.7C343.97 61.7 340.61 57.08 340.61 50.5V32.72L335.36 26.63H349.01ZM374.617 47.77H375.177C376.997 53.79 382.527 59.04 388.267 59.04C391.137 59.04 393.517 57.64 393.517 54.49C393.517 46.23 374.967 50.29 374.967 36.43C374.967 31.25 379.517 26.7 386.657 26.7H394.357L396.947 25.23V36.85L396.527 36.78C394.007 32.23 389.807 28.87 385.327 28.94C382.387 29.01 380.707 30.83 380.707 33.56C380.707 40.77 399.887 37.62 399.887 50.43C399.887 58.55 391.697 61.7 386.167 61.7C382.667 61.7 377.907 61.21 375.247 60.09L374.617 47.77ZM430.416 41.19V41.26H407.946C408.716 50.29 413.546 54.07 419.006 54.07C423.766 54.07 427.966 51.69 429.016 48.75L430.066 49.17C427.546 55.54 422.576 61.98 414.246 61.98C405.076 61.98 399.896 53.79 399.896 45.39C399.896 36.36 405.496 26 416.906 26C425.236 26 430.346 31.6 430.416 41.05L430.486 41.19H430.416ZM421.386 39.16V38.53C421.386 31.04 418.376 28.1 415.296 28.1C409.976 28.1 407.806 34.47 407.806 38.67V39.16H421.386Z"
        fill="#121212"
      />
      <defs>
        <radialGradient
          id="paint0_angular_1555_220"
          cx="0"
          cy="0"
          r="1"
          gradientUnits="userSpaceOnUse"
          gradientTransform="translate(40 40) rotate(90) scale(40)"
        >
          <stop stopColor="#FBFBFB" stopOpacity="0.15" />
          <stop offset="0.442708" stopOpacity="0.1" />
        </radialGradient>
      </defs>
    </svg>
  )
}



================================================
FILE: apps/web/components/Objects/Menus/OrgMenuLinks.tsx
================================================
import AuthenticatedClientElement from '@components/Security/AuthenticatedClientElement'
import { getUriWithOrg } from '@services/config/config'
import { BookCopy, Signpost, SquareLibrary } from 'lucide-react'
import Link from 'next/link'
import React from 'react'

function MenuLinks(props: { orgslug: string }) {
  return (
    <div className='pl-1'>
      <ul className="flex space-x-5">
        <LinkItem
          link="/courses"
          type="courses"
          orgslug={props.orgslug}
        ></LinkItem>
        <LinkItem
          link="/collections"
          type="collections"
          orgslug={props.orgslug}
        ></LinkItem>
        <AuthenticatedClientElement checkMethod="authentication">
          <LinkItem
            link="/trail"
            type="trail"
            orgslug={props.orgslug}
          ></LinkItem>
        </AuthenticatedClientElement>
      </ul>
    </div>
  )
}
const LinkItem = (props: any) => {
  const link = props.link
  const orgslug = props.orgslug
  return (
    <Link href={getUriWithOrg(orgslug, link)}>
      <li className="flex space-x-2 items-center text-[#909192] font-medium">
        {props.type == 'courses' && (
          <>
            <BookCopy size={20}  />{' '}
            <span>Courses</span>
          </>
        )}

        {props.type == 'collections' && (
          <>
            <SquareLibrary size={20} />{' '}
            <span>Collections</span>
          </>
        )}

        {props.type == 'trail' && (
          <>
            <Signpost size={20} />{' '}
            <span>Progress</span>
          </>
        )}
      </li>
    </Link>
  )
}
export default MenuLinks



================================================
FILE: apps/web/components/Objects/Modals/Activities/Assignments/EditAssignmentModal.tsx
================================================
import React from 'react';
import { updateAssignment } from '@services/courses/assignments';
import { mutate } from 'swr';
import { getAPIUrl } from '@services/config/config';
import toast from 'react-hot-toast';
import FormLayout, {
    FormField,
    Input,
    Textarea,
    Flex,
    FormLabel,
    FormMessage
} from '@components/Objects/StyledElements/Form/Form';
import * as Form from '@radix-ui/react-form';
import { useFormik } from 'formik';
import Modal from '@components/Objects/StyledElements/Modal/Modal';

interface Assignment {
    assignment_uuid: string;
    title: string;
    description: string;
    due_date?: string;
    grading_type?: 'ALPHABET' | 'NUMERIC' | 'PERCENTAGE';
}

interface EditAssignmentFormProps {
    onClose: () => void;
    assignment: Assignment;
    accessToken: string;
}

interface EditAssignmentModalProps {
    isOpen: boolean;
    onClose: () => void;
    assignment: Assignment;
    accessToken: string;
}

const EditAssignmentForm: React.FC<EditAssignmentFormProps> = ({
    onClose,
    assignment,
    accessToken
}) => {
    const formik = useFormik({
        initialValues: {
            title: assignment.title || '',
            description: assignment.description || '',
            due_date: assignment.due_date || '',
            grading_type: assignment.grading_type || 'ALPHABET'
        },
        enableReinitialize: true,
        onSubmit: async (values, { setSubmitting }) => {
            const toast_loading = toast.loading('Updating assignment...');
            try {
                const res = await updateAssignment(values, assignment.assignment_uuid, accessToken);
                if (res.success) {
                    mutate(`${getAPIUrl()}assignments/${assignment.assignment_uuid}`);
                    toast.success('Assignment updated successfully');
                    onClose();
                } else {
                    toast.error('Failed to update assignment');
                }
            } catch (error) {
                toast.error('An error occurred while updating the assignment');
            } finally {
                toast.dismiss(toast_loading);
                setSubmitting(false);
            }
        }
    });

    return (
        <FormLayout onSubmit={formik.handleSubmit}>
            <FormField name="title">
                <Flex css={{ alignItems: 'baseline', justifyContent: 'space-between' }}>
                    <FormLabel>Assignment Title</FormLabel>
                    <FormMessage match="valueMissing">
                        Please provide a name for your assignment
                    </FormMessage>
                </Flex>
                <Form.Control asChild>
                    <Input
                        onChange={formik.handleChange}
                        value={formik.values.title}
                        type="text"
                        required
                    />
                </Form.Control>
            </FormField>

            <FormField name="description">
                <Flex css={{ alignItems: 'baseline', justifyContent: 'space-between' }}>
                    <FormLabel>Assignment Description</FormLabel>
                    <FormMessage match="valueMissing">
                        Please provide a description for your assignment
                    </FormMessage>
                </Flex>
                <Form.Control asChild>
                    <Textarea
                        onChange={formik.handleChange}
                        value={formik.values.description}
                        required
                    />
                </Form.Control>
            </FormField>

            <FormField name="due_date">
                <Flex css={{ alignItems: 'baseline', justifyContent: 'space-between' }}>
                    <FormLabel>Due Date</FormLabel>
                    <FormMessage match="valueMissing">
                        Please provide a due date for your assignment
                    </FormMessage>
                </Flex>
                <Form.Control asChild>
                    <Input
                        type="date"
                        onChange={formik.handleChange}
                        value={formik.values.due_date}
                        required
                    />
                </Form.Control>
            </FormField>

            <FormField name="grading_type">
                <Flex css={{ alignItems: 'baseline', justifyContent: 'space-between' }}>
                    <FormLabel>Grading Type</FormLabel>
                    <FormMessage match="valueMissing">
                        Please provide a grading type for your assignment
                    </FormMessage>
                </Flex>
                <select 
                    id="grading_type"
                    name="grading_type"
                    className='w-full bg-gray-100/40 rounded-lg px-3 py-2 outline outline-1 outline-gray-100'
                    onChange={(e) => formik.setFieldValue('grading_type', e.target.value, true)}
                    value={formik.values.grading_type}
                    required
                >
                    <option value="ALPHABET">Alphabet</option>
                    <option value="NUMERIC">Numeric</option>
                    <option value="PERCENTAGE">Percentage</option>
                </select>
            </FormField>

            <div className="flex justify-end space-x-3 mt-6">
                <button
                    type="button"
                    onClick={onClose}
                    className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md"
                >
                    Cancel
                </button>
                <Form.Submit asChild>
                    <button
                        type="submit"
                        disabled={formik.isSubmitting}
                        className="px-4 py-2 bg-black text-white font-bold rounded-md hover:bg-black/90"
                    >
                        {formik.isSubmitting ? 'Saving...' : 'Save Changes'}
                    </button>
                </Form.Submit>
            </div>
        </FormLayout>
    );
};

const EditAssignmentModal: React.FC<EditAssignmentModalProps> = ({
    isOpen,
    onClose,
    assignment,
    accessToken
}) => {
    return (
        <Modal
            isDialogOpen={isOpen}
            onOpenChange={onClose}
            minHeight="md"
            minWidth="lg"
            dialogContent={
                <EditAssignmentForm
                    onClose={onClose}
                    assignment={assignment}
                    accessToken={accessToken}
                />
            }
            dialogTitle="Edit Assignment"
            dialogDescription="Update assignment details"
            dialogTrigger={null}
        />
    );
};

export default EditAssignmentModal; 


================================================
FILE: apps/web/components/Objects/Modals/Activities/Create/NewActivity.tsx
================================================
import React, { useState } from 'react'
import DynamicPageActivityImage from 'public/activities_types/dynamic-page-activity.png'
import VideoPageActivityImage from 'public//activities_types/video-page-activity.png'
import DocumentPdfPageActivityImage from 'public//activities_types/documentpdf-page-activity.png'
import AssignmentActivityImage from 'public//activities_types/assignment-page-activity.png'

import DynamicCanvaModal from './NewActivityModal/DynamicActivityModal'
import VideoModal from './NewActivityModal/VideoActivityModal'
import Image from 'next/image'
import DocumentPdfModal from './NewActivityModal/DocumentActivityModal'
import Assignment from './NewActivityModal/AssignmentActivityModal'

function NewActivityModal({
  closeModal,
  submitActivity,
  submitFileActivity,
  submitExternalVideo,
  chapterId,
  course,
}: any) {
  const [selectedView, setSelectedView] = useState('home')

  return (
    <>
      {selectedView === 'home' && (
        <div className="grid grid-cols-4 gap-2 mt-2.5 w-full">
          <ActivityOption
            onClick={() => {
              setSelectedView('dynamic')
            }}
          >
            <div className="h-20 rounded-lg m-0.5 flex flex-col items-center justify-end text-center bg-white hover:cursor-pointer">
              <Image unoptimized quality={100} alt="Dynamic Page" src={DynamicPageActivityImage}></Image>
            </div>
            <div className="flex text-sm h-5 font-medium text-gray-500 items-center justify-center text-center">
              Dynamic Page
            </div>
          </ActivityOption>
          <ActivityOption
            onClick={() => {
              setSelectedView('video')
            }}
          >
            <div className="h-20 rounded-lg m-0.5 flex flex-col items-center justify-end text-center bg-white hover:cursor-pointer">
              <Image unoptimized quality={100} alt="Video Page" src={VideoPageActivityImage}></Image>
            </div>
            <div className="flex text-sm h-5 font-medium text-gray-500 items-center justify-center text-center">
              Video
            </div>
          </ActivityOption>
          <ActivityOption
            onClick={() => {
              setSelectedView('documentpdf')
            }}
          >
            <div className="h-20 rounded-lg m-0.5 flex flex-col items-center justify-end text-center bg-white hover:cursor-pointer">
              <Image unoptimized quality={100} alt="Document PDF Page" src={DocumentPdfPageActivityImage}></Image>
            </div>
            <div className="flex text-sm h-5 font-medium text-gray-500 items-center justify-center text-center">
              Document
            </div>
          </ActivityOption>
          <ActivityOption
            onClick={() => {
              setSelectedView('assignments')
            }}
          >
            <div className="h-20 rounded-lg m-0.5 flex flex-col items-center justify-end text-center bg-white hover:cursor-pointer">
              <Image unoptimized quality={100} alt="Assignment Page" src={AssignmentActivityImage}></Image>
            </div>
            <div className="flex text-sm h-5 font-medium text-gray-500 items-center justify-center text-center">
              Assignments
            </div>
          </ActivityOption>
        </div>
      )}

      {selectedView === 'dynamic' && (
        <DynamicCanvaModal
          submitActivity={submitActivity}
          chapterId={chapterId}
          course={course}
        />
      )}

      {selectedView === 'video' && (
        <VideoModal
          submitFileActivity={submitFileActivity}
          submitExternalVideo={submitExternalVideo}
          chapterId={chapterId}
          course={course}
        />
      )}

      {selectedView === 'documentpdf' && (
        <DocumentPdfModal
          submitFileActivity={submitFileActivity}
          chapterId={chapterId}
          course={course}
        />
      )}

      {selectedView === 'assignments' && (
        <Assignment
          submitActivity={submitActivity}
          chapterId={chapterId}
          course={course}
          closeModal={closeModal}
        />)
      }
    </>
  )
}

const ActivityOption = ({ onClick, children }: any) => (
  <div
    onClick={onClick}
    className="w-full text-center rounded-xl bg-gray-100 border-4 border-gray-100 mx-auto hover:bg-gray-200 hover:border-gray-200 transition duration-200 ease-in-out cursor-pointer"
  >
    {children}
  </div>
)

export default NewActivityModal



================================================
FILE: apps/web/components/Objects/Modals/Activities/Create/NewActivityModal/AssignmentActivityModal.tsx
================================================
import React from 'react'
import FormLayout, {
    ButtonBlack,
    Flex,
    FormField,
    FormLabel,
    FormMessage,
    Input,

} from '@components/Objects/StyledElements/Form/Form'
import * as Form from '@radix-ui/react-form'
import { BarLoader } from 'react-spinners'
import { useOrg } from '@components/Contexts/OrgContext'
import { getAPIUrl } from '@services/config/config'
import { mutate } from 'swr'
import { createAssignment } from '@services/courses/assignments'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { createActivity, deleteActivity } from '@services/courses/activities'
import toast from 'react-hot-toast'

function NewAssignment({ submitActivity, chapterId, course, closeModal }: any) {
    const org = useOrg() as any;
    const session = useLHSession() as any
    const [activityName, setActivityName] = React.useState('')
    const [isSubmitting, setIsSubmitting] = React.useState(false)
    const [activityDescription, setActivityDescription] = React.useState('')
    const [dueDate, setDueDate] = React.useState('')
    const [gradingType, setGradingType] = React.useState('ALPHABET')

    const handleNameChange = (e: any) => {
        setActivityName(e.target.value)
    }

    const handleDescriptionChange = (e: any) => {
        setActivityDescription(e.target.value)
    }

    const handleDueDateChange = (e: any) => {
        setDueDate(e.target.value)
    }

    const handleGradingTypeChange = (e: any) => {
        setGradingType(e.target.value)
    }

    const handleSubmit = async (e: any) => {
        e.preventDefault()
        setIsSubmitting(true)
        const activity = {
            name: activityName,
            chapter_id: chapterId,
            activity_type: 'TYPE_ASSIGNMENT',
            activity_sub_type: 'SUBTYPE_ASSIGNMENT_ANY',
            published: false,
            course_id: course?.courseStructure.id,
        }

        const activity_res = await createActivity(activity, chapterId, org?.id, session.data?.tokens?.access_token)
        const res = await createAssignment({
            title: activityName,
            description: activityDescription,
            due_date: dueDate,
            grading_type: gradingType,
            course_id: course?.courseStructure.id,
            org_id: org?.id,
            chapter_id: chapterId,
            activity_id: activity_res?.id,
        }, session.data?.tokens?.access_token)
        const toast_loading = toast.loading('Creating assignment...')

        if (res.success) {
            toast.dismiss(toast_loading)
            toast.success('Assignment created successfully')
        } else {
            toast.error(res.data.detail)
            await deleteActivity(activity_res.activity_uuid, session.data?.tokens?.access_token)

        }

        mutate(`${getAPIUrl()}courses/${course.courseStructure.course_uuid}/meta`)
        setIsSubmitting(false)
        closeModal()
    }


    return (
        <FormLayout onSubmit={handleSubmit}>
            <FormField name="assignment-activity-title">
                <Flex css={{ alignItems: 'baseline', justifyContent: 'space-between' }}>
                    <FormLabel>Assignment Title</FormLabel>
                    <FormMessage match="valueMissing">
                        Please provide a name for your assignment
                    </FormMessage>
                </Flex>
                <Form.Control asChild>
                    <Input onChange={handleNameChange} type="text" required />
                </Form.Control>
            </FormField>

            {/* Description  */}
            <FormField name="assignment-activity-description">
                <Flex css={{ alignItems: 'baseline', justifyContent: 'space-between' }}>
                    <FormLabel>Assignment Description</FormLabel>
                    <FormMessage match="valueMissing">
                        Please provide a description for your assignment
                    </FormMessage>
                </Flex>
                <Form.Control asChild>
                    <Input onChange={handleDescriptionChange} type="text" required />
                </Form.Control>
            </FormField>

            {/* Due date  */}
            <FormField name="assignment-activity-due-date">
                <Flex css={{ alignItems: 'baseline', justifyContent: 'space-between' }}>
                    <FormLabel>Due Date</FormLabel>
                    <FormMessage match="valueMissing">
                        Please provide a due date for your assignment
                    </FormMessage>
                </Flex>
                <Form.Control asChild>
                    <Input onChange={handleDueDateChange} type="date" required />
                </Form.Control>
            </FormField>

            {/* Grading type  */}
            <FormField name="assignment-activity-grading-type">
                <Flex css={{ alignItems: 'baseline', justifyContent: 'space-between' }}>
                    <FormLabel>Grading Type</FormLabel>
                    <FormMessage match="valueMissing">
                        Please provide a grading type for your assignment
                    </FormMessage>
                </Flex>
                <Form.Control asChild>
                    <select className='bg-gray-100/40 rounded-lg px-1 py-2 outline outline-1 outline-gray-100' onChange={handleGradingTypeChange} required>
                        <option value="ALPHABET">Alphabet</option>
                        <option value="NUMERIC">Numeric</option>
                        <option value="PERCENTAGE">Percentage</option>
                    </select>
                </Form.Control>
            </FormField>

            <Flex css={{ marginTop: 25, justifyContent: 'flex-end' }}>
                <Form.Submit asChild>
                    <ButtonBlack type="submit" css={{ marginTop: 10 }}>
                        {isSubmitting ? (
                            <BarLoader
                                cssOverride={{ borderRadius: 60 }}
                                width={60}
                                color="#ffffff"
                            />
                        ) : (
                            'Create activity'
                        )}
                    </ButtonBlack>
                </Form.Submit>
            </Flex>
        </FormLayout>
    )
}

export default NewAssignment


================================================
FILE: apps/web/components/Objects/Modals/Activities/Create/NewActivityModal/DocumentActivityModal.tsx
================================================
import FormLayout, {
  ButtonBlack,
  Flex,
  FormField,
  FormLabel,
  FormMessage,
  Input,
} from '@components/Objects/StyledElements/Form/Form'
import React, { useState } from 'react'
import * as Form from '@radix-ui/react-form'
import BarLoader from 'react-spinners/BarLoader'
import { constructAcceptValue } from '@/lib/constants';

const SUPPORTED_FILES = constructAcceptValue(['pdf'])

function DocumentPdfModal({ submitFileActivity, chapterId, course }: any) {
  const [documentpdf, setDocumentPdf] = React.useState(null) as any
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [name, setName] = React.useState('')

  const handleDocumentPdfChange = (event: React.ChangeEvent<any>) => {
    setDocumentPdf(event.target.files[0])
  }

  const handleNameChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    setName(event.target.value)
  }

  const handleSubmit = async (e: any) => {
    e.preventDefault()
    setIsSubmitting(true)
    let status = await submitFileActivity(
      documentpdf,
      'documentpdf',
      {
        name: name,
        chapter_id: chapterId,
        activity_type: 'TYPE_DOCUMENT',
        activity_sub_type: 'SUBTYPE_DOCUMENT_PDF',
        published_version: 1,
        version: 1,
        course_id: course.id,
      },
      chapterId
    )
    setIsSubmitting(false)
  }

  return (
    <FormLayout onSubmit={handleSubmit}>
      <FormField name="documentpdf-activity-name">
        <Flex css={{ alignItems: 'baseline', justifyContent: 'space-between' }}>
          <FormLabel>PDF Document name</FormLabel>
          <FormMessage match="valueMissing">
            Please provide a name for your PDF Document activity
          </FormMessage>
        </Flex>
        <Form.Control asChild>
          <Input onChange={handleNameChange} type="text" required />
        </Form.Control>
      </FormField>
      <FormField name="documentpdf-activity-file">
        <Flex css={{ alignItems: 'baseline', justifyContent: 'space-between' }}>
          <FormLabel>PDF Document file</FormLabel>
          <FormMessage match="valueMissing">
            Please provide a PDF Document for your activity
          </FormMessage>
        </Flex>
        <Form.Control asChild>
          <input accept={SUPPORTED_FILES} type="file" onChange={handleDocumentPdfChange} required />
        </Form.Control>
      </FormField>

      <Flex css={{ marginTop: 25, justifyContent: 'flex-end' }}>
        <Form.Submit asChild>
          <ButtonBlack type="submit" css={{ marginTop: 10 }}>
            {isSubmitting ? (
              <BarLoader
                cssOverride={{ borderRadius: 60 }}
                width={60}
                color="#ffffff"
              />
            ) : (
              'Create activity'
            )}
          </ButtonBlack>
        </Form.Submit>
      </Flex>
    </FormLayout>
  )
}

export default DocumentPdfModal



================================================
FILE: apps/web/components/Objects/Modals/Activities/Create/NewActivityModal/DynamicActivityModal.tsx
================================================
import FormLayout, {
  ButtonBlack,
  Flex,
  FormField,
  FormLabel,
  FormMessage,
  Input,
  Textarea,
} from '@components/Objects/StyledElements/Form/Form'
import React, { useState } from 'react'
import * as Form from '@radix-ui/react-form'
import BarLoader from 'react-spinners/BarLoader'

function DynamicCanvaModal({ submitActivity, chapterId, course }: any) {
  const [activityName, setActivityName] = useState('')
  const [activityDescription, setActivityDescription] = useState('')
  const [isSubmitting, setIsSubmitting] = useState(false)

  const handleActivityNameChange = (e: any) => {
    setActivityName(e.target.value)
  }

  const handleActivityDescriptionChange = (e: any) => {
    setActivityDescription(e.target.value)
  }

  const handleSubmit = async (e: any) => {
    e.preventDefault()
    setIsSubmitting(true)
    await submitActivity({
      name: activityName,
      chapter_id: chapterId,
      activity_type: 'TYPE_DYNAMIC',
      activity_sub_type: 'SUBTYPE_DYNAMIC_PAGE',
      published_version: 1,
      version: 1,
      course_id: course.id,
    })
    setIsSubmitting(false)
  }
  return (
    <FormLayout onSubmit={handleSubmit}>
      <FormField name="dynamic-activity-name">
        <Flex css={{ alignItems: 'baseline', justifyContent: 'space-between' }}>
          <FormLabel>Activity name</FormLabel>
          <FormMessage match="valueMissing">
            Please provide a name for your activity
          </FormMessage>
        </Flex>
        <Form.Control asChild>
          <Input onChange={handleActivityNameChange} type="text" required />
        </Form.Control>
      </FormField>
      <FormField name="dynamic-activity-desc">
        <Flex css={{ alignItems: 'baseline', justifyContent: 'space-between' }}>
          <FormLabel>Activity description</FormLabel>
          <FormMessage match="valueMissing">
            Please provide a description for your activity
          </FormMessage>
        </Flex>
        <Form.Control asChild>
          <Textarea onChange={handleActivityDescriptionChange}  />
        </Form.Control>
      </FormField>

      <Flex css={{ marginTop: 25, justifyContent: 'flex-end' }}>
        <Form.Submit asChild>
          <ButtonBlack type="submit" css={{ marginTop: 10 }}>
            {isSubmitting ? (
              <BarLoader
                cssOverride={{ borderRadius: 60 }}
                width={60}
                color="#ffffff"
              />
            ) : (
              'Create activity'
            )}
          </ButtonBlack>
        </Form.Submit>
      </Flex>
    </FormLayout>
  )
}

export default DynamicCanvaModal



================================================
FILE: apps/web/components/Objects/Modals/Activities/Create/NewActivityModal/VideoActivityModal.tsx
================================================
import {
  Button,
} from "@components/ui/button"
import {
  Input
} from "@components/ui/input"
import { Label } from "@components/ui/label"
import React, { useState } from 'react'
import * as Form from '@radix-ui/react-form'
import BarLoader from 'react-spinners/BarLoader'
import { Youtube, Upload } from 'lucide-react'
import { constructAcceptValue } from '@/lib/constants'

const SUPPORTED_FILES = constructAcceptValue(['mp4', 'webm'])

interface VideoDetails {
  startTime: number
  endTime: number | null
  autoplay: boolean
  muted: boolean
}

interface ExternalVideoObject {
  name: string
  type: string
  uri: string
  chapter_id: string
  details: VideoDetails
}

function VideoModal({
  submitFileActivity,
  submitExternalVideo,
  chapterId,
  course,
}: any) {
  const [video, setVideo] = React.useState<File | null>(null)
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [name, setName] = React.useState('')
  const [youtubeUrl, setYoutubeUrl] = React.useState('')
  const [selectedView, setSelectedView] = React.useState<'file' | 'youtube'>('file')
  const [videoDetails, setVideoDetails] = React.useState<VideoDetails>({
    startTime: 0,
    endTime: null,
    autoplay: false,
    muted: false
  })

  const handleVideoChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    if (event.target.files?.[0]) {
      setVideo(event.target.files[0])
    }
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setIsSubmitting(true)

    try {
      if (selectedView === 'file' && video) {
        await submitFileActivity(
          video,
          'video',
          {
            name: name,
            chapter_id: chapterId,
            activity_type: 'TYPE_VIDEO',
            activity_sub_type: 'SUBTYPE_VIDEO_HOSTED',
            published_version: 1,
            version: 1,
            course_id: course.id,
            details: videoDetails
          },
          chapterId
        )
      }
      
      if (selectedView === 'youtube') {
        const external_video_object: ExternalVideoObject = {
          name,
          type: 'youtube',
          uri: youtubeUrl,
          chapter_id: chapterId,
          details: videoDetails
        }

        await submitExternalVideo(
          external_video_object,
          'activity',
          chapterId
        )
      }
    } finally {
      setIsSubmitting(false)
    }
  }

  const VideoSettingsForm = () => {
    const convertToSeconds = (minutes: number, seconds: number) => {
      return minutes * 60 + seconds;
    };

    const convertFromSeconds = (totalSeconds: number) => {
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      return { minutes, seconds };
    };

    const startTimeParts = convertFromSeconds(videoDetails.startTime);
    const endTimeParts = videoDetails.endTime ? convertFromSeconds(videoDetails.endTime) : { minutes: 0, seconds: 0 };

    return (
      <div className="space-y-4 mt-4 p-4 bg-gray-50 rounded-lg">
        <h3 className="font-medium text-gray-900 mb-3">Video Settings</h3>
        <div className="grid grid-cols-2 gap-4">
          <div>
            <Label>Start Time</Label>
            <div className="flex gap-2 mt-1">
              <div className="flex-1">
                <Input
                  type="number"
                  min="0"
                  value={startTimeParts.minutes}
                  onChange={(e) => {
                    const minutes = Math.max(0, parseInt(e.target.value) || 0);
                    const seconds = startTimeParts.seconds;
                    setVideoDetails({
                      ...videoDetails,
                      startTime: convertToSeconds(minutes, seconds)
                    });
                  }}
                  placeholder="0"
                  className="w-full"
                />
                <span className="text-xs text-gray-500 mt-1 block">Minutes</span>
              </div>
              <div className="flex-1">
                <Input
                  type="number"
                  min="0"
                  max="59"
                  value={startTimeParts.seconds}
                  onChange={(e) => {
                    const minutes = startTimeParts.minutes;
                    const seconds = Math.max(0, Math.min(59, parseInt(e.target.value) || 0));
                    setVideoDetails({
                      ...videoDetails,
                      startTime: convertToSeconds(minutes, seconds)
                    });
                  }}
                  placeholder="0"
                  className="w-full"
                />
                <span className="text-xs text-gray-500 mt-1 block">Seconds</span>
              </div>
            </div>
          </div>

          <div>
            <Label>End Time (optional)</Label>
            <div className="flex gap-2 mt-1">
              <div className="flex-1">
                <Input
                  type="number"
                  min="0"
                  value={endTimeParts.minutes}
                  onChange={(e) => {
                    const minutes = Math.max(0, parseInt(e.target.value) || 0);
                    const seconds = endTimeParts.seconds;
                    const totalSeconds = convertToSeconds(minutes, seconds);
                    if (totalSeconds > videoDetails.startTime) {
                      setVideoDetails({
                        ...videoDetails,
                        endTime: totalSeconds
                      });
                    }
                  }}
                  placeholder="0"
                  className="w-full"
                />
                <span className="text-xs text-gray-500 mt-1 block">Minutes</span>
              </div>
              <div className="flex-1">
                <Input
                  type="number"
                  min="0"
                  max="59"
                  value={endTimeParts.seconds}
                  onChange={(e) => {
                    const minutes = endTimeParts.minutes;
                    const seconds = Math.max(0, Math.min(59, parseInt(e.target.value) || 0));
                    const totalSeconds = convertToSeconds(minutes, seconds);
                    if (totalSeconds > videoDetails.startTime) {
                      setVideoDetails({
                        ...videoDetails,
                        endTime: totalSeconds
                      });
                    }
                  }}
                  placeholder="0"
                  className="w-full"
                />
                <span className="text-xs text-gray-500 mt-1 block">Seconds</span>
              </div>
            </div>
          </div>
        </div>

        <div className="flex items-center space-x-6 mt-4">
          <label className="flex items-center space-x-2">
            <input
              type="checkbox"
              checked={videoDetails.autoplay}
              onChange={(e) => setVideoDetails({
                ...videoDetails,
                autoplay: e.target.checked
              })}
              className="rounded border-gray-300 text-black focus:ring-black"
            />
            <span className="text-sm text-gray-700">Autoplay video</span>
          </label>

          <label className="flex items-center space-x-2">
            <input
              type="checkbox"
              checked={videoDetails.muted}
              onChange={(e) => setVideoDetails({
                ...videoDetails,
                muted: e.target.checked
              })}
              className="rounded border-gray-300 text-black focus:ring-black"
            />
            <span className="text-sm text-gray-700">Start muted</span>
          </label>
        </div>
      </div>
    );
  };

  return (
    <Form.Root onSubmit={handleSubmit}>
      <div>
        <Label htmlFor="video-activity-name">Activity Name</Label>
        <Input 
          id="video-activity-name"
          value={name}
          onChange={(e) => setName(e.target.value)} 
          type="text" 
          required 
          placeholder="Enter activity name..."
        />
      </div>

      <div className="mt-4 rounded-lg border border-gray-200">
        <div className="grid grid-cols-2 gap-0">
          <button
            type="button"
            onClick={() => setSelectedView('file')}
            className={`flex items-center justify-center p-4 gap-2 ${
              selectedView === 'file'
                ? 'bg-gray-100 border-b-2 border-black'
                : 'hover:bg-gray-50 border-b border-gray-200'
            }`}
          >
            <Upload size={18} />
            <span>Upload Video</span>
          </button>
          <button
            type="button"
            onClick={() => setSelectedView('youtube')}
            className={`flex items-center justify-center p-4 gap-2 ${
              selectedView === 'youtube'
                ? 'bg-gray-100 border-b-2 border-black'
                : 'hover:bg-gray-50 border-b border-gray-200'
            }`}
          >
            <Youtube size={18} />
            <span>YouTube Video</span>
          </button>
        </div>

        <div className="p-6">
          {selectedView === 'file' && (
            <div className="space-y-4">
              <div>
                <Label htmlFor="video-activity-file">Video File</Label>
                <div className="mt-2">
                  <input
                    id="video-activity-file"
                    type="file"
                    accept={SUPPORTED_FILES}
                    onChange={handleVideoChange}
                    required
                    className="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-black file:text-white hover:file:bg-gray-800"
                  />
                </div>
              </div>
              <VideoSettingsForm />
            </div>
          )}

          {selectedView === 'youtube' && (
            <div className="space-y-4">
              <div>
                <Label htmlFor="youtube-url">YouTube URL</Label>
                <Input
                  id="youtube-url"
                  value={youtubeUrl}
                  onChange={(e) => setYoutubeUrl(e.target.value)}
                  type="text"
                  required
                  placeholder="https://youtube.com/watch?v=..."
                />
              </div>
              <VideoSettingsForm />
            </div>
          )}
        </div>
      </div>

      <div className="flex justify-end mt-6">
        <Button 
          type="submit" 
          disabled={isSubmitting}
          className="bg-black text-white hover:bg-black/90"
        >
          {isSubmitting ? (
            <BarLoader
              cssOverride={{ borderRadius: 60 }}
              width={60}
              color="#ffffff"
            />
          ) : (
            'Create Activity'
          )}
        </Button>
      </div>
    </Form.Root>
  )
}

export default VideoModal



================================================
FILE: apps/web/components/Objects/Modals/Chapters/NewChapter.tsx
================================================
import FormLayout, {
  Flex,
  FormField,
  Input,
  Textarea,
  FormLabel,
  ButtonBlack,
} from '@components/Objects/StyledElements/Form/Form'
import { FormMessage } from '@radix-ui/react-form'
import * as Form from '@radix-ui/react-form'
import React, { useState } from 'react'
import BarLoader from 'react-spinners/BarLoader'

function NewChapterModal({ submitChapter, closeModal, course }: any) {
  const [chapterName, setChapterName] = useState('')
  const [chapterDescription, setChapterDescription] = useState('')
  const [isSubmitting, setIsSubmitting] = useState(false)

  const handleChapterNameChange = (e: any) => {
    setChapterName(e.target.value)
  }

  const handleChapterDescriptionChange = (e: any) => {
    setChapterDescription(e.target.value)
  }

  const handleSubmit = async (e: any) => {
    e.preventDefault()

    setIsSubmitting(true)
    const chapter_object = {
      name: chapterName,
      description: chapterDescription,
      thumbnail_image: '',
      course_id: course.id,
      org_id: course.org_id,
    }
    await submitChapter(chapter_object)
    setIsSubmitting(false)
  }

  return (
    <FormLayout onSubmit={handleSubmit}>
      <FormField name="chapter-name">
        <Flex css={{ alignItems: 'baseline', justifyContent: 'space-between' }}>
          <FormLabel>Chapter name</FormLabel>
          <FormMessage match="valueMissing">
            Please provide a chapter name
          </FormMessage>
        </Flex>
        <Form.Control asChild>
          <Input onChange={handleChapterNameChange} type="text" required />
        </Form.Control>
      </FormField>
      <FormField name="chapter-desc">
        <Flex css={{ alignItems: 'baseline', justifyContent: 'space-between' }}>
          <FormLabel>Chapter description</FormLabel>
          <FormMessage match="valueMissing">
            Please provide a chapter description
          </FormMessage>
        </Flex>
        <Form.Control asChild>
          <Textarea onChange={handleChapterDescriptionChange} required />
        </Form.Control>
      </FormField>

      <Flex css={{ marginTop: 25, justifyContent: 'flex-end' }}>
        <Form.Submit asChild>
          <ButtonBlack type="submit" css={{ marginTop: 10 }}>
            {isSubmitting ? (
              <BarLoader
                cssOverride={{ borderRadius: 60 }}
                width={60}
                color="#ffffff"
              />
            ) : (
              'Create Chapter'
            )}
          </ButtonBlack>
        </Form.Submit>
      </Flex>
    </FormLayout>
  )
}

export default NewChapterModal



================================================
FILE: apps/web/components/Objects/Modals/Course/Create/CreateCourse.tsx
================================================
'use client'
import { Input } from "@components/ui/input"
import { Textarea } from "@components/ui/textarea"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@components/ui/select"
import FormLayout, {
  FormField,
  FormLabelAndMessage,
} from '@components/Objects/StyledElements/Form/Form'
import * as Form from '@radix-ui/react-form'
import { createNewCourse } from '@services/courses/courses'
import { getOrganizationContextInfoWithoutCredentials } from '@services/organizations/orgs'
import React, { useEffect } from 'react'
import { BarLoader } from 'react-spinners'
import { revalidateTags } from '@services/utils/ts/requests'
import { useRouter } from 'next/navigation'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import toast from 'react-hot-toast'
import { useFormik } from 'formik'
import * as Yup from 'yup'
import {  UploadCloud, Image as ImageIcon } from 'lucide-react'
import UnsplashImagePicker from "@components/Dashboard/Pages/Course/EditCourseGeneral/UnsplashImagePicker"
import FormTagInput from "@components/Objects/StyledElements/Form/TagInput"

const validationSchema = Yup.object().shape({
  name: Yup.string()
    .required('Course name is required')
    .max(100, 'Must be 100 characters or less'),
  description: Yup.string()
    .max(1000, 'Must be 1000 characters or less'),
  learnings: Yup.string(),
  tags: Yup.string(),
  visibility: Yup.boolean(),
  thumbnail: Yup.mixed().nullable()
})

function CreateCourseModal({ closeModal, orgslug }: any) {
  const router = useRouter()
  const session = useLHSession() as any
  const [orgId, setOrgId] = React.useState(null) as any
  const [showUnsplashPicker, setShowUnsplashPicker] = React.useState(false)
  const [isUploading, setIsUploading] = React.useState(false)

  const formik = useFormik({
    initialValues: {
      name: '',
      description: '',
      learnings: '',
      visibility: true,
      tags: '',
      thumbnail: null
    },
    validationSchema,
    onSubmit: async (values, { setSubmitting }) => {
      const toast_loading = toast.loading('Creating course...')

      try {
        const res = await createNewCourse(
          orgId,
          {
            name: values.name,
            description: values.description,
            learnings: values.learnings,
            tags: values.tags,
            visibility: values.visibility
          },
          values.thumbnail,
          session.data?.tokens?.access_token
        )

        if (res.success) {
          await revalidateTags(['courses'], orgslug)
          toast.dismiss(toast_loading)
          toast.success('Course created successfully')

          if (res.data.org_id === orgId) {
            closeModal()
            router.refresh()
            await revalidateTags(['courses'], orgslug)
          }
        } else {
          toast.error(res.data.detail)
        }
      } catch (error) {
        toast.error('Failed to create course')
      } finally {
        setSubmitting(false)
      }
    }
  })

  const getOrgMetadata = async () => {
    const org = await getOrganizationContextInfoWithoutCredentials(orgslug, {
      revalidate: 360,
      tags: ['organizations'],
    })
    setOrgId(org.id)
  }

  useEffect(() => {
    if (orgslug) {
      getOrgMetadata()
    }
  }, [orgslug])

  const handleFileChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0]
    if (file) {
      formik.setFieldValue('thumbnail', file)
    }
  }

  const handleUnsplashSelect = async (imageUrl: string) => {
    setIsUploading(true)
    try {
      const response = await fetch(imageUrl)
      const blob = await response.blob()
      const file = new File([blob], 'unsplash_image.jpg', { type: 'image/jpeg' })
      formik.setFieldValue('thumbnail', file)
    } catch (error) {
      toast.error('Failed to load image from Unsplash')
    }
    setIsUploading(false)
  }

  return (
    <FormLayout onSubmit={formik.handleSubmit} >
      <FormField name="name">
        <FormLabelAndMessage
          label="Course Name"
          message={formik.errors.name}
        />
        <Form.Control asChild>
          <Input
            onChange={formik.handleChange}
            value={formik.values.name}
            type="text"
            required
          />
        </Form.Control>
      </FormField>

      <FormField name="description">
        <FormLabelAndMessage
          label="Description"
          message={formik.errors.description}
        />
        <Form.Control asChild>
          <Textarea
            onChange={formik.handleChange}
            value={formik.values.description}

          />
        </Form.Control>
      </FormField>

      <FormField name="thumbnail">
        <FormLabelAndMessage
          label="Course Thumbnail"
          message={formik.errors.thumbnail}
        />
        <div className="w-auto bg-gray-50 rounded-xl outline outline-1 outline-gray-200 h-[200px] shadow-sm">
          <div className="flex flex-col justify-center items-center h-full">
            <div className="flex flex-col justify-center items-center">
              {formik.values.thumbnail ? (
                <img
                  src={URL.createObjectURL(formik.values.thumbnail)}
                  className={`${isUploading ? 'animate-pulse' : ''} shadow-sm w-[200px] h-[100px] rounded-md`}
                />
              ) : (
                <img
                  src="/empty_thumbnail.png"
                  className="shadow-sm w-[200px] h-[100px] rounded-md bg-gray-200"
                />
              )}
              <div className="flex justify-center items-center space-x-2">
                <input
                  type="file"
                  id="fileInput"
                  style={{ display: 'none' }}
                  onChange={handleFileChange}
                  accept="image/jpeg,image/png,image/webp,image/gif"
                />
                <button
                  type="button"
                  className="font-bold antialiased items-center text-gray text-sm rounded-md px-4 mt-6 flex"
                  onClick={() => document.getElementById('fileInput')?.click()}
                >
                  <UploadCloud size={16} className="mr-2" />
                  <span>Upload Image</span>
                </button>
                <button
                  type="button"
                  className="font-bold antialiased items-center text-gray text-sm rounded-md px-4 mt-6 flex"
                  onClick={() => setShowUnsplashPicker(true)}
                >
                  <ImageIcon size={16} className="mr-2" />
                  <span>Choose from Gallery</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </FormField>

			<FormField name="learnings">
				<FormLabelAndMessage
					label="Course Learnings (What will you teach?)"
					message={formik.errors.learnings}
				/>
				<FormTagInput
					placeholder="Enter to add..."
					value={formik.values.learnings}
					onChange={(value) => formik.setFieldValue('learnings', value)}
					error={formik.errors.learnings}
				/>
			</FormField>

			<FormField name="tags">
				<FormLabelAndMessage
					label="Course Tags"
					message={formik.errors.tags}
				/>
				<FormTagInput
					placeholder="Enter to add..."
					value={formik.values.tags}
					onChange={(value) => formik.setFieldValue('tags', value)}
					error={formik.errors.tags}
				/>
			</FormField>

      <FormField name="visibility">
        <FormLabelAndMessage
          label="Course Visibility"
          message={formik.errors.visibility}
        />
        <Select
          value={formik.values.visibility.toString()}
          onValueChange={(value) => formik.setFieldValue('visibility', value === 'true')}
        >
          <SelectTrigger>
            <SelectValue placeholder="Select visibility" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="true">Public (Available to see on the internet)</SelectItem>
            <SelectItem value="false">Private (Private to users)</SelectItem>
          </SelectContent>
        </Select>
      </FormField>

      <div className="flex justify-end mt-6">
        <button
          type="submit"
          disabled={formik.isSubmitting}
          className="px-4 py-2 bg-black text-white text-sm font-bold rounded-md"
        >
          {formik.isSubmitting ? (
            <BarLoader
              cssOverride={{ borderRadius: 60 }}
              width={60}
              color="#ffffff"
            />
          ) : (
            'Create Course'
          )}
        </button>
      </div>

      {showUnsplashPicker && (
        <UnsplashImagePicker
          onSelect={handleUnsplashSelect}
          onClose={() => setShowUnsplashPicker(false)}
        />
      )}
    </FormLayout>
  )
}

export default CreateCourseModal



================================================
FILE: apps/web/components/Objects/Modals/Dash/EditCourseAccess/LinkToUserGroup.tsx
================================================
'use client';
import { useCourse } from '@components/Contexts/CourseContext';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import { useOrg } from '@components/Contexts/OrgContext';
import { getAPIUrl, getUriWithOrg } from '@services/config/config';
import { linkResourcesToUserGroup } from '@services/usergroups/usergroups';
import { swrFetcher } from '@services/utils/ts/requests';
import { Info } from 'lucide-react';
import Link from 'next/link';
import React, { useEffect } from 'react'
import toast from 'react-hot-toast';
import useSWR, { mutate } from 'swr'

type LinkToUserGroupProps = {
    // React function, todo: fix types
    setUserGroupModal: any
}

function LinkToUserGroup(props: LinkToUserGroupProps) {
    const course = useCourse() as any
    const org = useOrg() as any
    const session = useLHSession() as any
    const access_token = session?.data?.tokens?.access_token;
    const courseStructure = course.courseStructure

    const { data: usergroups } = useSWR(
        courseStructure && org ? `${getAPIUrl()}usergroups/org/${org.id}` : null,
        (url) => swrFetcher(url, access_token)
    )
    const [selectedUserGroup, setSelectedUserGroup] = React.useState(null) as any


    const handleLink = async () => {
        const res = await linkResourcesToUserGroup(selectedUserGroup, courseStructure.course_uuid, access_token)
        if (res.status === 200) {
            props.setUserGroupModal(false)
            toast.success('Successfully linked to usergroup')
            mutate(`${getAPIUrl()}usergroups/resource/${courseStructure.course_uuid}`)
        }
        else {
            toast.error('Error ' + res.status + ': ' + res.data.detail)
        }
    }

    useEffect(() => {
        if (usergroups && usergroups.length > 0) {
            setSelectedUserGroup(usergroups[0].id)
        }
    }
        , [usergroups])

    return (
        <div className='flex flex-col space-y-1 '>
            <div className='flex bg-yellow-100 text-yellow-900 mx-auto w-fit mt-3 px-4 py-2 space-x-2 text-sm rounded-full items-center'>
                <Info size={19} />
                <h1 className=' font-medium'>Users that are not part of the UserGroup will no longer have access to this course</h1>
            </div>
            <div className='p-4 flex-row flex justify-between items-center'>
                {usergroups?.length >= 1 &&
                    <div className='py-1'>
                        <span className='px-3 text-gray-400 font-bold rounded-full py-1 bg-gray-100 mx-3'>UserGroup Name </span>

                        <select
                            onChange={(e) => setSelectedUserGroup(e.target.value)}
                            defaultValue={selectedUserGroup}
                        >
                            {usergroups && usergroups.map((group: any) => (
                                <option key={group.id} value={group.id}>{group.name}</option>
                            ))}

                        </select>

                    </div>}
                {usergroups?.length == 0 &&
                    <div className='flex space-x-3 items-center'>
                        <span className='px-3 text-yellow-700 font-bold rounded-full py-1 mx-3'>No UserGroups available </span>
                        <Link className='px-3 text-blue-700 font-bold rounded-full py-1 bg-blue-100 mx-1' target='_blank' href={getUriWithOrg(org.slug, '/dash/users/settings/usergroups')}>Create a UserGroup</Link>
                    </div>}
                <div className='py-3'>
                    <button onClick={() => { handleLink() }} className='bg-green-700 text-white font-bold px-4 py-2 rounded-md shadow-sm'>Link</button>
                </div>
            </div>
        </div>

    )
}

export default LinkToUserGroup


================================================
FILE: apps/web/components/Objects/Modals/Dash/OrgAccess/OrgInviteCodeGenerate.tsx
================================================
import { useOrg } from '@components/Contexts/OrgContext'
import { getAPIUrl, getUriWithOrg } from '@services/config/config'
import { createInviteCode, createInviteCodeWithUserGroup } from '@services/organizations/invites'
import { swrFetcher } from '@services/utils/ts/requests'
import { Ticket } from 'lucide-react'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import React, { useEffect } from 'react'
import toast from 'react-hot-toast'
import useSWR, { mutate } from 'swr'
import Link from 'next/link'

type OrgInviteCodeGenerateProps = {
    setInvitesModal: any
}

function OrgInviteCodeGenerate(props: OrgInviteCodeGenerateProps) {
    const org = useOrg() as any
    const session = useLHSession() as any
    const access_token = session?.data?.tokens?.access_token;
    const [usergroup_id, setUsergroup_id] = React.useState(0);

    const { data: usergroups } = useSWR(
        org ? `${getAPIUrl()}usergroups/org/${org.id}` : null,
        (url) => swrFetcher(url, access_token)
    )

    async function createInviteWithUserGroup() {
        let res = await createInviteCodeWithUserGroup(org.id, usergroup_id, session.data?.tokens?.access_token)
        if (res.status == 200) {
            mutate(`${getAPIUrl()}orgs/${org.id}/invites`)
            props.setInvitesModal(false)
        } else {
            toast.error('Error ' + res.status + ': ' + res.data.detail)
        }
    }

    async function createInvite() {
        let res = await createInviteCode(org.id, session.data?.tokens?.access_token)
        if (res.status == 200) {
            mutate(`${getAPIUrl()}orgs/${org.id}/invites`)
            props.setInvitesModal(false)
        } else {
            toast.error('Error ' + res.status + ': ' + res.data.detail)
        }
    }

    useEffect(() => {
        if (usergroups && usergroups.length > 0) {
            setUsergroup_id(usergroups[0].id)
        }
    }
        , [usergroups])
    return (
        <div className='flex space-x-2 pt-2'>
            <div className='flex bg-slate-100 w-full h-[140px] rounded-lg'>
                <div className='flex flex-col mx-auto'>
                    <h1 className='mx-auto pt-4 text-gray-600 font-medium'>Invite Code linked to a UserGroup</h1>
                    <h2 className='mx-auto text-xs text-gray-600 font-medium'>On Signup, Users will be automatically linked to a UserGroup of your choice</h2>
                    <div className='flex items-center space-x-4 pt-3 mx-auto'>
                        {usergroups?.length >= 1 &&
                            <div className='flex space-x-4 items-center'>
                                <select
                                    defaultValue={usergroup_id}
                                    className='flex p-2 w-fit  rounded-md text-sm bg-gray-100 border-2 border-slate-300'>
                                    {usergroups?.map((usergroup: any) => (
                                        <option key={usergroup.id} value={usergroup.id}>
                                            {usergroup.name}
                                        </option>
                                    ))}

                                </select>

                                <div className=''>
                                    <button
                                        onClick={createInviteWithUserGroup}
                                        className="flex space-x-2 w-fit hover:cursor-pointer p-1 px-3 bg-green-700 rounded-md font-bold items-center text-sm text-green-100"
                                    >
                                        <Ticket className="w-4 h-4" />
                                        <span> Generate </span>
                                    </button>
                                </div>
                            </div>}
                        {usergroups?.length == 0 &&
                            <div className='flex space-x-3 items-center text-xs pt-3'>
                                <span className='px-3 text-yellow-700 font-bold rounded-full py-1 mx-3'>No UserGroups available </span>
                                <Link className='px-3 text-blue-700 font-bold rounded-full py-1 bg-blue-100 mx-1' target='_blank' href={getUriWithOrg(org.slug, '/dash/users/settings/usergroups')}>Create a UserGroup </Link>
                            </div>}
                    </div>
                </div>
            </div>
            <div className='flex bg-slate-100 w-full h-[140px] rounded-lg'>
                <div className='flex flex-col mx-auto'>
                    <h1 className='mx-auto pt-4 text-gray-600 font-medium'>Normal Invite Code</h1>
                    <h2 className='mx-auto text-xs text-gray-600 font-medium'>On Signup, User will not be linked to any UserGroup</h2>
                    <div className='mx-auto pt-4'>
                        <button
                            onClick={createInvite}
                            className="flex space-x-2 w-fit hover:cursor-pointer p-1 px-3 bg-green-700 rounded-md font-bold items-center text-sm text-green-100"
                        >
                            <Ticket className="w-4 h-4" />
                            <span> Generate </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    )
}

export default OrgInviteCodeGenerate


================================================
FILE: apps/web/components/Objects/Modals/Dash/OrgRoles/AddRole.tsx
================================================
'use client'
import FormLayout, {
    FormField,
    FormLabelAndMessage,
    Input,
    Textarea,
} from '@components/Objects/StyledElements/Form/Form'
import * as Form from '@radix-ui/react-form'
import { useOrg } from '@components/Contexts/OrgContext'
import React from 'react'
import { createRole } from '@services/roles/roles'
import { mutate } from 'swr'
import { getAPIUrl } from '@services/config/config'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { useFormik } from 'formik'
import toast from 'react-hot-toast'
import { Shield, BookOpen, Users, UserCheck, FolderOpen, Building, FileText, Activity, Monitor, CheckSquare, Square } from 'lucide-react'

type AddRoleProps = {
    setCreateRoleModal: any
}

interface Rights {
    courses: {
        action_create: boolean;
        action_read: boolean;
        action_read_own: boolean;
        action_update: boolean;
        action_update_own: boolean;
        action_delete: boolean;
        action_delete_own: boolean;
    };
    users: {
        action_create: boolean;
        action_read: boolean;
        action_update: boolean;
        action_delete: boolean;
    };
    usergroups: {
        action_create: boolean;
        action_read: boolean;
        action_update: boolean;
        action_delete: boolean;
    };
    collections: {
        action_create: boolean;
        action_read: boolean;
        action_update: boolean;
        action_delete: boolean;
    };
    organizations: {
        action_create: boolean;
        action_read: boolean;
        action_update: boolean;
        action_delete: boolean;
    };
    coursechapters: {
        action_create: boolean;
        action_read: boolean;
        action_update: boolean;
        action_delete: boolean;
    };
    activities: {
        action_create: boolean;
        action_read: boolean;
        action_update: boolean;
        action_delete: boolean;
    };
    roles: {
        action_create: boolean;
        action_read: boolean;
        action_update: boolean;
        action_delete: boolean;
    };
    dashboard: {
        action_access: boolean;
    };
}

const validate = (values: any) => {
    const errors: any = {}

    if (!values.name) {
        errors.name = 'Required'
    } else if (values.name.length < 2) {
        errors.name = 'Name must be at least 2 characters'
    }

    if (!values.description) {
        errors.description = 'Required'
    } else if (values.description.length < 10) {
        errors.description = 'Description must be at least 10 characters'
    }

    return errors
}

const defaultRights: Rights = {
    courses: {
        action_create: false,
        action_read: false,
        action_read_own: false,
        action_update: false,
        action_update_own: false,
        action_delete: false,
        action_delete_own: false
    },
    users: {
        action_create: false,
        action_read: false,
        action_update: false,
        action_delete: false
    },
    usergroups: {
        action_create: false,
        action_read: false,
        action_update: false,
        action_delete: false
    },
    collections: {
        action_create: false,
        action_read: false,
        action_update: false,
        action_delete: false
    },
    organizations: {
        action_create: false,
        action_read: false,
        action_update: false,
        action_delete: false
    },
    coursechapters: {
        action_create: false,
        action_read: false,
        action_update: false,
        action_delete: false
    },
    activities: {
        action_create: false,
        action_read: false,
        action_update: false,
        action_delete: false
    },
    roles: {
        action_create: false,
        action_read: false,
        action_update: false,
        action_delete: false
    },
    dashboard: {
        action_access: false
    }
}

const predefinedRoles = {
    'Admin': {
        name: 'Admin',
        description: 'Full platform control with all permissions',
        rights: {
            courses: { action_create: true, action_read: true, action_read_own: true, action_update: true, action_update_own: true, action_delete: true, action_delete_own: true },
            users: { action_create: true, action_read: true, action_update: true, action_delete: true },
            usergroups: { action_create: true, action_read: true, action_update: true, action_delete: true },
            collections: { action_create: true, action_read: true, action_update: true, action_delete: true },
            organizations: { action_create: true, action_read: true, action_update: true, action_delete: true },
            coursechapters: { action_create: true, action_read: true, action_update: true, action_delete: true },
            activities: { action_create: true, action_read: true, action_update: true, action_delete: true },
            roles: { action_create: true, action_read: true, action_update: true, action_delete: true },
            dashboard: { action_access: true }
        }
    },
    'Course Manager': {
        name: 'Course Manager',
        description: 'Can manage courses, chapters, and activities',
        rights: {
            courses: { action_create: true, action_read: true, action_read_own: true, action_update: true, action_update_own: true, action_delete: false, action_delete_own: true },
            users: { action_create: false, action_read: true, action_update: false, action_delete: false },
            usergroups: { action_create: false, action_read: true, action_update: false, action_delete: false },
            collections: { action_create: true, action_read: true, action_update: true, action_delete: false },
            organizations: { action_create: false, action_read: false, action_update: false, action_delete: false },
            coursechapters: { action_create: true, action_read: true, action_update: true, action_delete: false },
            activities: { action_create: true, action_read: true, action_update: true, action_delete: false },
            roles: { action_create: false, action_read: false, action_update: false, action_delete: false },
            dashboard: { action_access: true }
        }
    },
    'Instructor': {
        name: 'Instructor',
        description: 'Can create and manage their own courses',
        rights: {
            courses: { action_create: true, action_read: true, action_read_own: true, action_update: false, action_update_own: true, action_delete: false, action_delete_own: true },
            users: { action_create: false, action_read: false, action_update: false, action_delete: false },
            usergroups: { action_create: false, action_read: false, action_update: false, action_delete: false },
            collections: { action_create: false, action_read: true, action_update: false, action_delete: false },
            organizations: { action_create: false, action_read: false, action_update: false, action_delete: false },
            coursechapters: { action_create: true, action_read: true, action_update: false, action_delete: false },
            activities: { action_create: true, action_read: true, action_update: false, action_delete: false },
            roles: { action_create: false, action_read: false, action_update: false, action_delete: false },
            dashboard: { action_access: true }
        }
    },
    'Viewer': {
        name: 'Viewer',
        description: 'Read-only access to courses and content',
        rights: {
            courses: { action_create: false, action_read: true, action_read_own: true, action_update: false, action_update_own: false, action_delete: false, action_delete_own: false },
            users: { action_create: false, action_read: false, action_update: false, action_delete: false },
            usergroups: { action_create: false, action_read: false, action_update: false, action_delete: false },
            collections: { action_create: false, action_read: true, action_update: false, action_delete: false },
            organizations: { action_create: false, action_read: false, action_update: false, action_delete: false },
            coursechapters: { action_create: false, action_read: true, action_update: false, action_delete: false },
            activities: { action_create: false, action_read: true, action_update: false, action_delete: false },
            roles: { action_create: false, action_read: false, action_update: false, action_delete: false },
            dashboard: { action_access: true }
        }
    },
    'Content Creator': {
        name: 'Content Creator',
        description: 'Can create and edit content but not manage users',
        rights: {
            courses: { action_create: true, action_read: true, action_read_own: true, action_update: true, action_update_own: true, action_delete: false, action_delete_own: false },
            users: { action_create: false, action_read: false, action_update: false, action_delete: false },
            usergroups: { action_create: false, action_read: false, action_update: false, action_delete: false },
            collections: { action_create: true, action_read: true, action_update: true, action_delete: false },
            organizations: { action_create: false, action_read: false, action_update: false, action_delete: false },
            coursechapters: { action_create: true, action_read: true, action_update: true, action_delete: false },
            activities: { action_create: true, action_read: true, action_update: true, action_delete: false },
            roles: { action_create: false, action_read: false, action_update: false, action_delete: false },
            dashboard: { action_access: true }
        }
    },
    'User Manager': {
        name: 'User Manager',
        description: 'Can manage users and user groups',
        rights: {
            courses: { action_create: false, action_read: true, action_read_own: true, action_update: false, action_update_own: false, action_delete: false, action_delete_own: false },
            users: { action_create: true, action_read: true, action_update: true, action_delete: true },
            usergroups: { action_create: true, action_read: true, action_update: true, action_delete: true },
            collections: { action_create: false, action_read: true, action_update: false, action_delete: false },
            organizations: { action_create: false, action_read: false, action_update: false, action_delete: false },
            coursechapters: { action_create: false, action_read: true, action_update: false, action_delete: false },
            activities: { action_create: false, action_read: true, action_update: false, action_delete: false },
            roles: { action_create: false, action_read: true, action_update: false, action_delete: false },
            dashboard: { action_access: true }
        }
    },
    'Moderator': {
        name: 'Moderator',
        description: 'Can moderate content and manage activities',
        rights: {
            courses: { action_create: false, action_read: true, action_read_own: true, action_update: false, action_update_own: false, action_delete: false, action_delete_own: false },
            users: { action_create: false, action_read: true, action_update: false, action_delete: false },
            usergroups: { action_create: false, action_read: true, action_update: false, action_delete: false },
            collections: { action_create: false, action_read: true, action_update: true, action_delete: false },
            organizations: { action_create: false, action_read: false, action_update: false, action_delete: false },
            coursechapters: { action_create: false, action_read: true, action_update: true, action_delete: false },
            activities: { action_create: false, action_read: true, action_update: true, action_delete: false },
            roles: { action_create: false, action_read: false, action_update: false, action_delete: false },
            dashboard: { action_access: true }
        }
    },
    'Analyst': {
        name: 'Analyst',
        description: 'Read-only access with analytics capabilities',
        rights: {
            courses: { action_create: false, action_read: true, action_read_own: true, action_update: false, action_update_own: false, action_delete: false, action_delete_own: false },
            users: { action_create: false, action_read: true, action_update: false, action_delete: false },
            usergroups: { action_create: false, action_read: true, action_update: false, action_delete: false },
            collections: { action_create: false, action_read: true, action_update: false, action_delete: false },
            organizations: { action_create: false, action_read: true, action_update: false, action_delete: false },
            coursechapters: { action_create: false, action_read: true, action_update: false, action_delete: false },
            activities: { action_create: false, action_read: true, action_update: false, action_delete: false },
            roles: { action_create: false, action_read: true, action_update: false, action_delete: false },
            dashboard: { action_access: true }
        }
    },
    'Guest': {
        name: 'Guest',
        description: 'Limited access for external users',
        rights: {
            courses: { action_create: false, action_read: true, action_read_own: false, action_update: false, action_update_own: false, action_delete: false, action_delete_own: false },
            users: { action_create: false, action_read: false, action_update: false, action_delete: false },
            usergroups: { action_create: false, action_read: false, action_update: false, action_delete: false },
            collections: { action_create: false, action_read: true, action_update: false, action_delete: false },
            organizations: { action_create: false, action_read: false, action_update: false, action_delete: false },
            coursechapters: { action_create: false, action_read: true, action_update: false, action_delete: false },
            activities: { action_create: false, action_read: true, action_update: false, action_delete: false },
            roles: { action_create: false, action_read: false, action_update: false, action_delete: false },
            dashboard: { action_access: false }
        }
    }
}

function AddRole(props: AddRoleProps) {
    const org = useOrg() as any;
    const session = useLHSession() as any
    const access_token = session?.data?.tokens?.access_token;
    const [isSubmitting, setIsSubmitting] = React.useState(false)
    const [rights, setRights] = React.useState<Rights>(defaultRights)

    const formik = useFormik({
        initialValues: {
            name: '',
            description: '',
            org_id: org.id,
            rights: defaultRights
        },
        validate,
        onSubmit: async (values) => {
            const toastID = toast.loading("Creating...")
            setIsSubmitting(true)
            
            // Ensure rights object is properly structured
            const formattedRights = {
                courses: {
                    action_create: rights.courses?.action_create || false,
                    action_read: rights.courses?.action_read || false,
                    action_read_own: rights.courses?.action_read_own || false,
                    action_update: rights.courses?.action_update || false,
                    action_update_own: rights.courses?.action_update_own || false,
                    action_delete: rights.courses?.action_delete || false,
                    action_delete_own: rights.courses?.action_delete_own || false
                },
                users: {
                    action_create: rights.users?.action_create || false,
                    action_read: rights.users?.action_read || false,
                    action_update: rights.users?.action_update || false,
                    action_delete: rights.users?.action_delete || false
                },
                usergroups: {
                    action_create: rights.usergroups?.action_create || false,
                    action_read: rights.usergroups?.action_read || false,
                    action_update: rights.usergroups?.action_update || false,
                    action_delete: rights.usergroups?.action_delete || false
                },
                collections: {
                    action_create: rights.collections?.action_create || false,
                    action_read: rights.collections?.action_read || false,
                    action_update: rights.collections?.action_update || false,
                    action_delete: rights.collections?.action_delete || false
                },
                organizations: {
                    action_create: rights.organizations?.action_create || false,
                    action_read: rights.organizations?.action_read || false,
                    action_update: rights.organizations?.action_update || false,
                    action_delete: rights.organizations?.action_delete || false
                },
                coursechapters: {
                    action_create: rights.coursechapters?.action_create || false,
                    action_read: rights.coursechapters?.action_read || false,
                    action_update: rights.coursechapters?.action_update || false,
                    action_delete: rights.coursechapters?.action_delete || false
                },
                activities: {
                    action_create: rights.activities?.action_create || false,
                    action_read: rights.activities?.action_read || false,
                    action_update: rights.activities?.action_update || false,
                    action_delete: rights.activities?.action_delete || false
                },
                roles: {
                    action_create: rights.roles?.action_create || false,
                    action_read: rights.roles?.action_read || false,
                    action_update: rights.roles?.action_update || false,
                    action_delete: rights.roles?.action_delete || false
                },
                dashboard: {
                    action_access: rights.dashboard?.action_access || false
                }
            }
            
            const res = await createRole({ 
                name: values.name,
                description: values.description,
                org_id: values.org_id,
                rights: formattedRights
            }, access_token)
            if (res.status === 200 || res.status === 201) {
                setIsSubmitting(false)
                mutate(`${getAPIUrl()}roles/org/${org.id}`)
                props.setCreateRoleModal(false)
                toast.success("Created new role", {id:toastID})
            } else {
                setIsSubmitting(false)
                toast.error("Couldn't create new role", {id:toastID})
            }
        },
    })

    const handleRightChange = (section: keyof Rights, action: string, value: boolean) => {
        setRights(prev => ({
            ...prev,
            [section]: {
                ...prev[section],
                [action]: value
            } as any
        }))
    }

    const handleSelectAll = (section: keyof Rights, value: boolean) => {
        setRights(prev => ({
            ...prev,
            [section]: Object.keys(prev[section]).reduce((acc, key) => ({
                ...acc,
                [key]: value
            }), {} as any)
        }))
    }

    const handlePredefinedRole = (roleKey: string) => {
        const role = predefinedRoles[roleKey as keyof typeof predefinedRoles]
        if (role) {
            formik.setFieldValue('name', role.name)
            formik.setFieldValue('description', role.description)
            setRights(role.rights as Rights)
        }
    }

    const PermissionSection = ({ title, icon: Icon, section, permissions }: { title: string, icon: any, section: keyof Rights, permissions: string[] }) => {
        const sectionRights = rights[section] as any
        const allSelected = permissions.every(perm => sectionRights[perm])
        const someSelected = permissions.some(perm => sectionRights[perm]) && !allSelected

        return (
            <div className="border border-gray-200 rounded-lg p-4 mb-4 bg-white shadow-sm">
                <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 gap-2">
                    <div className="flex items-center space-x-2">
                        <Icon className="w-4 h-4 text-gray-500" />
                        <h3 className="font-semibold text-gray-800 text-sm sm:text-base">{title}</h3>
                    </div>
                    <button
                        type="button"
                        onClick={() => handleSelectAll(section, !allSelected)}
                        className="flex items-center space-x-2 text-sm text-blue-600 hover:text-blue-700 font-medium self-start sm:self-auto transition-colors"
                    >
                        {allSelected ? <CheckSquare className="w-4 h-4" /> : someSelected ? <Square className="w-4 h-4" /> : <Square className="w-4 h-4" />}
                        <span className="hidden sm:inline">{allSelected ? 'Deselect All' : 'Select All'}</span>
                        <span className="sm:hidden">{allSelected ? 'Deselect' : 'Select'}</span>
                    </button>
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    {permissions.map((permission) => (
                        <label key={permission} className="flex items-center space-x-2 cursor-pointer p-2 rounded-md hover:bg-gray-50 transition-colors">
                            <input
                                type="checkbox"
                                checked={rights[section]?.[permission as keyof typeof rights[typeof section]] || false}
                                onChange={(e) => handleRightChange(section, permission, e.target.checked)}
                                className="rounded border-gray-300 text-blue-600 focus:ring-blue-500 focus:ring-2"
                            />
                            <span className="text-sm text-gray-700 capitalize">
                                {permission.replace('action_', '').replace('_', ' ')}
                            </span>
                        </label>
                    ))}
                </div>
            </div>
        )
    }

    return (
        <div className="py-3 max-w-6xl mx-auto px-2 sm:px-0">
            <FormLayout onSubmit={formik.handleSubmit}>
                <div className="grid grid-cols-1 xl:grid-cols-2 gap-4 sm:gap-6">
                    <div className="space-y-4 sm:space-y-6">
                        <FormField name="name">
                            <FormLabelAndMessage label="Role Name" message={formik.errors.name} />
                            <Form.Control asChild>
                                <Input
                                    onChange={formik.handleChange}
                                    value={formik.values.name}
                                    type="text"
                                    required
                                    placeholder="e.g., Course Manager"
                                    className="w-full"
                                />
                            </Form.Control>
                        </FormField>

                        <FormField name="description">
                            <FormLabelAndMessage label="Description" message={formik.errors.description} />
                            <Form.Control asChild>
                                <Textarea
                                    onChange={formik.handleChange}
                                    value={formik.values.description}
                                    required
                                    placeholder="Describe what this role can do..."
                                    className="w-full"
                                />
                            </Form.Control>
                        </FormField>

                        <div className="mt-6">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4">Predefined Rights</h3>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                {Object.keys(predefinedRoles).map((roleKey) => (
                                    <button
                                        key={roleKey}
                                        type="button"
                                        onClick={() => handlePredefinedRole(roleKey)}
                                        className="p-3 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 transition-all duration-200 text-left bg-white shadow-sm hover:shadow-md"
                                    >
                                        <div className="font-medium text-gray-900 text-sm sm:text-base">{predefinedRoles[roleKey as keyof typeof predefinedRoles].name}</div>
                                        <div className="text-xs sm:text-sm text-gray-500 mt-1">{predefinedRoles[roleKey as keyof typeof predefinedRoles].description}</div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="space-y-4">
                        <h3 className="text-lg font-semibold text-gray-800 mb-4">Permissions</h3>
                        
                        <PermissionSection
                            title="Courses"
                            icon={BookOpen}
                            section="courses"
                            permissions={['action_create', 'action_read', 'action_read_own', 'action_update', 'action_update_own', 'action_delete', 'action_delete_own']}
                        />
                        
                        <PermissionSection
                            title="Users"
                            icon={Users}
                            section="users"
                            permissions={['action_create', 'action_read', 'action_update', 'action_delete']}
                        />
                        
                        <PermissionSection
                            title="User Groups"
                            icon={UserCheck}
                            section="usergroups"
                            permissions={['action_create', 'action_read', 'action_update', 'action_delete']}
                        />
                        
                        <PermissionSection
                            title="Collections"
                            icon={FolderOpen}
                            section="collections"
                            permissions={['action_create', 'action_read', 'action_update', 'action_delete']}
                        />
                        
                        <PermissionSection
                            title="Organizations"
                            icon={Building}
                            section="organizations"
                            permissions={['action_create', 'action_read', 'action_update', 'action_delete']}
                        />
                        
                        <PermissionSection
                            title="Course Chapters"
                            icon={FileText}
                            section="coursechapters"
                            permissions={['action_create', 'action_read', 'action_update', 'action_delete']}
                        />
                        
                        <PermissionSection
                            title="Activities"
                            icon={Activity}
                            section="activities"
                            permissions={['action_create', 'action_read', 'action_update', 'action_delete']}
                        />
                        
                        <PermissionSection
                            title="Roles"
                            icon={Shield}
                            section="roles"
                            permissions={['action_create', 'action_read', 'action_update', 'action_delete']}
                        />
                        
                        <PermissionSection
                            title="Dashboard"
                            icon={Monitor}
                            section="dashboard"
                            permissions={['action_access']}
                        />
                    </div>
                </div>

                <div className="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 mt-6 pt-6 border-t border-gray-200">
                    <button
                        type="button"
                        onClick={() => props.setCreateRoleModal(false)}
                        className="px-4 py-2 text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors w-full sm:w-auto font-medium"
                    >
                        Cancel
                    </button>
                    <Form.Submit asChild>
                        <button
                            type="submit"
                            disabled={isSubmitting}
                            className="px-4 py-2 bg-black text-white rounded-md hover:bg-gray-800 transition-colors disabled:opacity-50 w-full sm:w-auto font-medium shadow-sm"
                        >
                            {isSubmitting ? 'Creating...' : 'Create Role'}
                        </button>
                    </Form.Submit>
                </div>
            </FormLayout>
        </div>
    )
}

export default AddRole 


================================================
FILE: apps/web/components/Objects/Modals/Dash/OrgRoles/EditRole.tsx
================================================
'use client'
import FormLayout, {
    FormField,
    FormLabelAndMessage,
    Input,
    Textarea,
} from '@components/Objects/StyledElements/Form/Form'
import * as Form from '@radix-ui/react-form'
import { useOrg } from '@components/Contexts/OrgContext'
import React from 'react'
import { updateRole } from '@services/roles/roles'
import { mutate } from 'swr'
import { getAPIUrl } from '@services/config/config'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { useFormik } from 'formik'
import toast from 'react-hot-toast'
import { Shield, BookOpen, Users, UserCheck, FolderOpen, Building, FileText, Activity, Monitor, CheckSquare, Square } from 'lucide-react'

type EditRoleProps = {
    role: {
        id: number,
        name: string,
        description: string,
        rights: any
    }
    setEditRoleModal: any
}

interface Rights {
    courses: {
        action_create: boolean;
        action_read: boolean;
        action_read_own: boolean;
        action_update: boolean;
        action_update_own: boolean;
        action_delete: boolean;
        action_delete_own: boolean;
    };
    users: {
        action_create: boolean;
        action_read: boolean;
        action_update: boolean;
        action_delete: boolean;
    };
    usergroups: {
        action_create: boolean;
        action_read: boolean;
        action_update: boolean;
        action_delete: boolean;
    };
    collections: {
        action_create: boolean;
        action_read: boolean;
        action_update: boolean;
        action_delete: boolean;
    };
    organizations: {
        action_create: boolean;
        action_read: boolean;
        action_update: boolean;
        action_delete: boolean;
    };
    coursechapters: {
        action_create: boolean;
        action_read: boolean;
        action_update: boolean;
        action_delete: boolean;
    };
    activities: {
        action_create: boolean;
        action_read: boolean;
        action_update: boolean;
        action_delete: boolean;
    };
    roles: {
        action_create: boolean;
        action_read: boolean;
        action_update: boolean;
        action_delete: boolean;
    };
    dashboard: {
        action_access: boolean;
    };
}

const validate = (values: any) => {
    const errors: any = {}

    if (!values.name) {
        errors.name = 'Required'
    } else if (values.name.length < 2) {
        errors.name = 'Name must be at least 2 characters'
    }

    if (!values.description) {
        errors.description = 'Required'
    } else if (values.description.length < 10) {
        errors.description = 'Description must be at least 10 characters'
    }

    return errors
}

const predefinedRoles = {
    'Admin': {
        name: 'Admin',
        description: 'Full platform control with all permissions',
        rights: {
            courses: { action_create: true, action_read: true, action_read_own: true, action_update: true, action_update_own: true, action_delete: true, action_delete_own: true },
            users: { action_create: true, action_read: true, action_update: true, action_delete: true },
            usergroups: { action_create: true, action_read: true, action_update: true, action_delete: true },
            collections: { action_create: true, action_read: true, action_update: true, action_delete: true },
            organizations: { action_create: true, action_read: true, action_update: true, action_delete: true },
            coursechapters: { action_create: true, action_read: true, action_update: true, action_delete: true },
            activities: { action_create: true, action_read: true, action_update: true, action_delete: true },
            roles: { action_create: true, action_read: true, action_update: true, action_delete: true },
            dashboard: { action_access: true }
        }
    },
    'Course Manager': {
        name: 'Course Manager',
        description: 'Can manage courses, chapters, and activities',
        rights: {
            courses: { action_create: true, action_read: true, action_read_own: true, action_update: true, action_update_own: true, action_delete: false, action_delete_own: true },
            users: { action_create: false, action_read: true, action_update: false, action_delete: false },
            usergroups: { action_create: false, action_read: true, action_update: false, action_delete: false },
            collections: { action_create: true, action_read: true, action_update: true, action_delete: false },
            organizations: { action_create: false, action_read: false, action_update: false, action_delete: false },
            coursechapters: { action_create: true, action_read: true, action_update: true, action_delete: false },
            activities: { action_create: true, action_read: true, action_update: true, action_delete: false },
            roles: { action_create: false, action_read: false, action_update: false, action_delete: false },
            dashboard: { action_access: true }
        }
    },
    'Instructor': {
        name: 'Instructor',
        description: 'Can create and manage their own courses',
        rights: {
            courses: { action_create: true, action_read: true, action_read_own: true, action_update: false, action_update_own: true, action_delete: false, action_delete_own: true },
            users: { action_create: false, action_read: false, action_update: false, action_delete: false },
            usergroups: { action_create: false, action_read: false, action_update: false, action_delete: false },
            collections: { action_create: false, action_read: true, action_update: false, action_delete: false },
            organizations: { action_create: false, action_read: false, action_update: false, action_delete: false },
            coursechapters: { action_create: true, action_read: true, action_update: false, action_delete: false },
            activities: { action_create: true, action_read: true, action_update: false, action_delete: false },
            roles: { action_create: false, action_read: false, action_update: false, action_delete: false },
            dashboard: { action_access: true }
        }
    },
    'Viewer': {
        name: 'Viewer',
        description: 'Read-only access to courses and content',
        rights: {
            courses: { action_create: false, action_read: true, action_read_own: true, action_update: false, action_update_own: false, action_delete: false, action_delete_own: false },
            users: { action_create: false, action_read: false, action_update: false, action_delete: false },
            usergroups: { action_create: false, action_read: false, action_update: false, action_delete: false },
            collections: { action_create: false, action_read: true, action_update: false, action_delete: false },
            organizations: { action_create: false, action_read: false, action_update: false, action_delete: false },
            coursechapters: { action_create: false, action_read: true, action_update: false, action_delete: false },
            activities: { action_create: false, action_read: true, action_update: false, action_delete: false },
            roles: { action_create: false, action_read: false, action_update: false, action_delete: false },
            dashboard: { action_access: true }
        }
    },
    'Content Creator': {
        name: 'Content Creator',
        description: 'Can create and edit content but not manage users',
        rights: {
            courses: { action_create: true, action_read: true, action_read_own: true, action_update: true, action_update_own: true, action_delete: false, action_delete_own: false },
            users: { action_create: false, action_read: false, action_update: false, action_delete: false },
            usergroups: { action_create: false, action_read: false, action_update: false, action_delete: false },
            collections: { action_create: true, action_read: true, action_update: true, action_delete: false },
            organizations: { action_create: false, action_read: false, action_update: false, action_delete: false },
            coursechapters: { action_create: true, action_read: true, action_update: true, action_delete: false },
            activities: { action_create: true, action_read: true, action_update: true, action_delete: false },
            roles: { action_create: false, action_read: false, action_update: false, action_delete: false },
            dashboard: { action_access: true }
        }
    },
    'User Manager': {
        name: 'User Manager',
        description: 'Can manage users and user groups',
        rights: {
            courses: { action_create: false, action_read: true, action_read_own: true, action_update: false, action_update_own: false, action_delete: false, action_delete_own: false },
            users: { action_create: true, action_read: true, action_update: true, action_delete: true },
            usergroups: { action_create: true, action_read: true, action_update: true, action_delete: true },
            collections: { action_create: false, action_read: true, action_update: false, action_delete: false },
            organizations: { action_create: false, action_read: false, action_update: false, action_delete: false },
            coursechapters: { action_create: false, action_read: true, action_update: false, action_delete: false },
            activities: { action_create: false, action_read: true, action_update: false, action_delete: false },
            roles: { action_create: false, action_read: true, action_update: false, action_delete: false },
            dashboard: { action_access: true }
        }
    },
    'Moderator': {
        name: 'Moderator',
        description: 'Can moderate content and manage activities',
        rights: {
            courses: { action_create: false, action_read: true, action_read_own: true, action_update: false, action_update_own: false, action_delete: false, action_delete_own: false },
            users: { action_create: false, action_read: true, action_update: false, action_delete: false },
            usergroups: { action_create: false, action_read: true, action_update: false, action_delete: false },
            collections: { action_create: false, action_read: true, action_update: true, action_delete: false },
            organizations: { action_create: false, action_read: false, action_update: false, action_delete: false },
            coursechapters: { action_create: false, action_read: true, action_update: true, action_delete: false },
            activities: { action_create: false, action_read: true, action_update: true, action_delete: false },
            roles: { action_create: false, action_read: false, action_update: false, action_delete: false },
            dashboard: { action_access: true }
        }
    },
    'Analyst': {
        name: 'Analyst',
        description: 'Read-only access with analytics capabilities',
        rights: {
            courses: { action_create: false, action_read: true, action_read_own: true, action_update: false, action_update_own: false, action_delete: false, action_delete_own: false },
            users: { action_create: false, action_read: true, action_update: false, action_delete: false },
            usergroups: { action_create: false, action_read: true, action_update: false, action_delete: false },
            collections: { action_create: false, action_read: true, action_update: false, action_delete: false },
            organizations: { action_create: false, action_read: true, action_update: false, action_delete: false },
            coursechapters: { action_create: false, action_read: true, action_update: false, action_delete: false },
            activities: { action_create: false, action_read: true, action_update: false, action_delete: false },
            roles: { action_create: false, action_read: true, action_update: false, action_delete: false },
            dashboard: { action_access: true }
        }
    },
    'Guest': {
        name: 'Guest',
        description: 'Limited access for external users',
        rights: {
            courses: { action_create: false, action_read: true, action_read_own: false, action_update: false, action_update_own: false, action_delete: false, action_delete_own: false },
            users: { action_create: false, action_read: false, action_update: false, action_delete: false },
            usergroups: { action_create: false, action_read: false, action_update: false, action_delete: false },
            collections: { action_create: false, action_read: true, action_update: false, action_delete: false },
            organizations: { action_create: false, action_read: false, action_update: false, action_delete: false },
            coursechapters: { action_create: false, action_read: true, action_update: false, action_delete: false },
            activities: { action_create: false, action_read: true, action_update: false, action_delete: false },
            roles: { action_create: false, action_read: false, action_update: false, action_delete: false },
            dashboard: { action_access: false }
        }
    }
}

function EditRole(props: EditRoleProps) {
    const org = useOrg() as any;
    const session = useLHSession() as any
    const access_token = session?.data?.tokens?.access_token;
    const [isSubmitting, setIsSubmitting] = React.useState(false)
    const [rights, setRights] = React.useState<Rights>(props.role.rights || {})

    const formik = useFormik({
        initialValues: {
            name: props.role.name,
            description: props.role.description,
            org_id: org.id,
            rights: props.role.rights || {}
        },
        validate,
        onSubmit: async (values) => {
            const toastID = toast.loading("Updating...")
            setIsSubmitting(true)
            
            // Ensure rights object is properly structured
            const formattedRights = {
                courses: {
                    action_create: rights.courses?.action_create || false,
                    action_read: rights.courses?.action_read || false,
                    action_read_own: rights.courses?.action_read_own || false,
                    action_update: rights.courses?.action_update || false,
                    action_update_own: rights.courses?.action_update_own || false,
                    action_delete: rights.courses?.action_delete || false,
                    action_delete_own: rights.courses?.action_delete_own || false
                },
                users: {
                    action_create: rights.users?.action_create || false,
                    action_read: rights.users?.action_read || false,
                    action_update: rights.users?.action_update || false,
                    action_delete: rights.users?.action_delete || false
                },
                usergroups: {
                    action_create: rights.usergroups?.action_create || false,
                    action_read: rights.usergroups?.action_read || false,
                    action_update: rights.usergroups?.action_update || false,
                    action_delete: rights.usergroups?.action_delete || false
                },
                collections: {
                    action_create: rights.collections?.action_create || false,
                    action_read: rights.collections?.action_read || false,
                    action_update: rights.collections?.action_update || false,
                    action_delete: rights.collections?.action_delete || false
                },
                organizations: {
                    action_create: rights.organizations?.action_create || false,
                    action_read: rights.organizations?.action_read || false,
                    action_update: rights.organizations?.action_update || false,
                    action_delete: rights.organizations?.action_delete || false
                },
                coursechapters: {
                    action_create: rights.coursechapters?.action_create || false,
                    action_read: rights.coursechapters?.action_read || false,
                    action_update: rights.coursechapters?.action_update || false,
                    action_delete: rights.coursechapters?.action_delete || false
                },
                activities: {
                    action_create: rights.activities?.action_create || false,
                    action_read: rights.activities?.action_read || false,
                    action_update: rights.activities?.action_update || false,
                    action_delete: rights.activities?.action_delete || false
                },
                roles: {
                    action_create: rights.roles?.action_create || false,
                    action_read: rights.roles?.action_read || false,
                    action_update: rights.roles?.action_update || false,
                    action_delete: rights.roles?.action_delete || false
                },
                dashboard: {
                    action_access: rights.dashboard?.action_access || false
                }
            }
            
            const res = await updateRole(props.role.id, { 
                name: values.name,
                description: values.description,
                org_id: values.org_id,
                rights: formattedRights
            }, access_token)
            if (res.status === 200) {
                setIsSubmitting(false)
                mutate(`${getAPIUrl()}roles/org/${org.id}`)
                props.setEditRoleModal(false)
                toast.success("Updated role", {id:toastID})
            } else {
                setIsSubmitting(false)
                toast.error("Couldn't update role", {id:toastID})
            }
        },
    })

    const handleRightChange = (section: keyof Rights, action: string, value: boolean) => {
        setRights(prev => ({
            ...prev,
            [section]: {
                ...prev[section],
                [action]: value
            } as any
        }))
    }

    const handleSelectAll = (section: keyof Rights, value: boolean) => {
        setRights(prev => ({
            ...prev,
            [section]: Object.keys(prev[section]).reduce((acc, key) => ({
                ...acc,
                [key]: value
            }), {} as any)
        }))
    }

    const handlePredefinedRole = (roleKey: string) => {
        const role = predefinedRoles[roleKey as keyof typeof predefinedRoles]
        if (role) {
            formik.setFieldValue('name', role.name)
            formik.setFieldValue('description', role.description)
            setRights(role.rights as Rights)
        }
    }

    const PermissionSection = ({ title, icon: Icon, section, permissions }: { title: string, icon: any, section: keyof Rights, permissions: string[] }) => {
        const sectionRights = rights[section] as any
        const allSelected = permissions.every(perm => sectionRights[perm])
        const someSelected = permissions.some(perm => sectionRights[perm]) && !allSelected

        return (
            <div className="border border-gray-200 rounded-lg p-4 mb-4 bg-white shadow-sm">
                <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 gap-2">
                    <div className="flex items-center space-x-2">
                        <Icon className="w-4 h-4 text-gray-500" />
                        <h3 className="font-semibold text-gray-800 text-sm sm:text-base">{title}</h3>
                    </div>
                    <button
                        type="button"
                        onClick={() => handleSelectAll(section, !allSelected)}
                        className="flex items-center space-x-2 text-sm text-blue-600 hover:text-blue-700 font-medium self-start sm:self-auto transition-colors"
                    >
                        {allSelected ? <CheckSquare className="w-4 h-4" /> : someSelected ? <Square className="w-4 h-4" /> : <Square className="w-4 h-4" />}
                        <span className="hidden sm:inline">{allSelected ? 'Deselect All' : 'Select All'}</span>
                        <span className="sm:hidden">{allSelected ? 'Deselect' : 'Select'}</span>
                    </button>
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    {permissions.map((permission) => (
                        <label key={permission} className="flex items-center space-x-2 cursor-pointer p-2 rounded-md hover:bg-gray-50 transition-colors">
                            <input
                                type="checkbox"
                                checked={rights[section]?.[permission as keyof typeof rights[typeof section]] || false}
                                onChange={(e) => handleRightChange(section, permission, e.target.checked)}
                                className="rounded border-gray-300 text-blue-600 focus:ring-blue-500 focus:ring-2"
                            />
                            <span className="text-sm text-gray-700 capitalize">
                                {permission.replace('action_', '').replace('_', ' ')}
                            </span>
                        </label>
                    ))}
                </div>
            </div>
        )
    }

    return (
        <div className="py-3 max-w-6xl mx-auto px-2 sm:px-0">
            <FormLayout onSubmit={formik.handleSubmit}>
                <div className="grid grid-cols-1 xl:grid-cols-2 gap-4 sm:gap-6">
                    <div className="space-y-4 sm:space-y-6">
                        <FormField name="name">
                            <FormLabelAndMessage label="Role Name" message={formik.errors.name} />
                            <Form.Control asChild>
                                <Input
                                    onChange={formik.handleChange}
                                    value={formik.values.name}
                                    type="text"
                                    required
                                    placeholder="e.g., Course Manager"
                                    className="w-full"
                                />
                            </Form.Control>
                        </FormField>

                        <FormField name="description">
                            <FormLabelAndMessage label="Description" message={formik.errors.description} />
                            <Form.Control asChild>
                                <Textarea
                                    onChange={formik.handleChange}
                                    value={formik.values.description}
                                    required
                                    placeholder="Describe what this role can do..."
                                    className="w-full"
                                />
                            </Form.Control>
                        </FormField>

                        <div className="mt-6">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4">Predefined Rights</h3>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                {Object.keys(predefinedRoles).map((roleKey) => (
                                    <button
                                        key={roleKey}
                                        type="button"
                                        onClick={() => handlePredefinedRole(roleKey)}
                                        className="p-3 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 transition-all duration-200 text-left bg-white shadow-sm hover:shadow-md"
                                    >
                                        <div className="font-medium text-gray-900 text-sm sm:text-base">{predefinedRoles[roleKey as keyof typeof predefinedRoles].name}</div>
                                        <div className="text-xs sm:text-sm text-gray-500 mt-1">{predefinedRoles[roleKey as keyof typeof predefinedRoles].description}</div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="space-y-4">
                        <h3 className="text-lg font-semibold text-gray-800 mb-4">Permissions</h3>
                        
                        <PermissionSection
                            title="Courses"
                            icon={BookOpen}
                            section="courses"
                            permissions={['action_create', 'action_read', 'action_read_own', 'action_update', 'action_update_own', 'action_delete', 'action_delete_own']}
                        />
                        
                        <PermissionSection
                            title="Users"
                            icon={Users}
                            section="users"
                            permissions={['action_create', 'action_read', 'action_update', 'action_delete']}
                        />
                        
                        <PermissionSection
                            title="User Groups"
                            icon={UserCheck}
                            section="usergroups"
                            permissions={['action_create', 'action_read', 'action_update', 'action_delete']}
                        />
                        
                        <PermissionSection
                            title="Collections"
                            icon={FolderOpen}
                            section="collections"
                            permissions={['action_create', 'action_read', 'action_update', 'action_delete']}
                        />
                        
                        <PermissionSection
                            title="Organizations"
                            icon={Building}
                            section="organizations"
                            permissions={['action_create', 'action_read', 'action_update', 'action_delete']}
                        />
                        
                        <PermissionSection
                            title="Course Chapters"
                            icon={FileText}
                            section="coursechapters"
                            permissions={['action_create', 'action_read', 'action_update', 'action_delete']}
                        />
                        
                        <PermissionSection
                            title="Activities"
                            icon={Activity}
                            section="activities"
                            permissions={['action_create', 'action_read', 'action_update', 'action_delete']}
                        />
                        
                        <PermissionSection
                            title="Roles"
                            icon={Shield}
                            section="roles"
                            permissions={['action_create', 'action_read', 'action_update', 'action_delete']}
                        />
                        
                        <PermissionSection
                            title="Dashboard"
                            icon={Monitor}
                            section="dashboard"
                            permissions={['action_access']}
                        />
                    </div>
                </div>

                <div className="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 mt-6 pt-6 border-t border-gray-200">
                    <button
                        type="button"
                        onClick={() => props.setEditRoleModal(false)}
                        className="px-4 py-2 text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors w-full sm:w-auto font-medium"
                    >
                        Cancel
                    </button>
                    <Form.Submit asChild>
                        <button
                            type="submit"
                            disabled={isSubmitting}
                            className="px-4 py-2 bg-black text-white rounded-md hover:bg-gray-800 transition-colors disabled:opacity-50 w-full sm:w-auto font-medium shadow-sm"
                        >
                            {isSubmitting ? 'Updating...' : 'Update Role'}
                        </button>
                    </Form.Submit>
                </div>
            </FormLayout>
        </div>
    )
}

export default EditRole 


================================================
FILE: apps/web/components/Objects/Modals/Dash/OrgUserGroups/AddUserGroup.tsx
================================================
'use client'
import FormLayout, {
    FormField,
    FormLabelAndMessage,
    Input,
} from '@components/Objects/StyledElements/Form/Form'
import * as Form from '@radix-ui/react-form'
import { useOrg } from '@components/Contexts/OrgContext'
import React from 'react'
import { createUserGroup } from '@services/usergroups/usergroups'
import { mutate } from 'swr'
import { getAPIUrl } from '@services/config/config'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { useFormik } from 'formik'
import toast from 'react-hot-toast'

type AddUserGroupProps = {
    setCreateUserGroupModal: any
}
const validate = (values: any) => {
    const errors: any = {}

    if (!values.name) {
        errors.name = 'Name is Required'
    }

    return errors
}

function AddUserGroup(props: AddUserGroupProps) {
    const org = useOrg() as any;
    const session = useLHSession() as any
    const access_token = session?.data?.tokens?.access_token;
    const [isSubmitting, setIsSubmitting] = React.useState(false)

    const formik = useFormik({
        initialValues: {
            name: '',
            description: '',
            org_id: org.id
        },
        validate,
        onSubmit: async (values) => {
            const toastID = toast.loading("Creating...")
            setIsSubmitting(true)
            const res = await createUserGroup(values, access_token)
            if (res.status == 200) {
                setIsSubmitting(false)
                mutate(`${getAPIUrl()}usergroups/org/${org.id}`)
                props.setCreateUserGroupModal(false)
                toast.success("Created new usergroup", {id:toastID})
            } else {
                setIsSubmitting(false)
                toast.error("Couldn't create new usergroup", {id:toastID})
            }
        },
    })

    return (
        <FormLayout onSubmit={formik.handleSubmit}>
            <FormField name="name">
                <FormLabelAndMessage
                    label="Name"
                    message={formik.errors.name}
                />
                <Form.Control asChild>
                    <Input
                        onChange={formik.handleChange}
                        value={formik.values.name}
                        type="name"
                        required
                    />
                </Form.Control>
            </FormField>
            <FormField name="description">
                <FormLabelAndMessage
                    label="Description"
                    message={formik.errors.description}
                />
                <Form.Control asChild>
                    <Input
                        onChange={formik.handleChange}
                        value={formik.values.description}
                        type="description"
                    />
                </Form.Control>
            </FormField>
            <div className="flex py-4">
                <Form.Submit asChild>
                    <button className="w-full bg-black text-white font-bold text-center p-2 rounded-md shadow-md hover:cursor-pointer">
                        {isSubmitting ? 'Loading...' : 'Create a UserGroup'}
                    </button>
                </Form.Submit>
            </div>
        </FormLayout>
    )
}

export default AddUserGroup


================================================
FILE: apps/web/components/Objects/Modals/Dash/OrgUserGroups/EditUserGroup.tsx
================================================
'use client'
import FormLayout, {
    FormField,
    FormLabelAndMessage,
    Input,
} from '@components/Objects/StyledElements/Form/Form'
import * as Form from '@radix-ui/react-form'
import { useOrg } from '@components/Contexts/OrgContext'
import React from 'react'
import { updateUserGroup } from '@services/usergroups/usergroups'
import { mutate } from 'swr'
import { getAPIUrl } from '@services/config/config'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { useFormik } from 'formik'
import toast from 'react-hot-toast'

type EditUserGroupProps = {
    usergroup: {
        id: number,
        name: string,
        description: string,
    }
}

const validate = (values: any) => {
    const errors: any = {}

    if (!values.name) {
        errors.name = 'Name is Required'
    }

    return errors
}

function EditUserGroup(props: EditUserGroupProps) {
    const org = useOrg() as any;
    const session = useLHSession() as any
    const access_token = session?.data?.tokens?.access_token;
    const [isSubmitting, setIsSubmitting] = React.useState(false)

    const formik = useFormik({
        initialValues: {
            name: props.usergroup.name,
            description: props.usergroup.description,
        },
        validate,
        onSubmit: async (values) => {
            setIsSubmitting(true)
            const res = await updateUserGroup(props.usergroup.id, access_token, values)

            if (res.status == 200) {
                setIsSubmitting(false)
                toast.success(`UserGroup saved successfully`)
                mutate(`${getAPIUrl()}usergroups/org/${org.id}`)
            } else {
                toast.error(`Error saving UserGroup, please retry later.`)
                setIsSubmitting(false)
            }
        },
    })

    console.log(formik.errors.name)

    return (
        <FormLayout onSubmit={formik.handleSubmit}>
            <FormField name="name">
                <FormLabelAndMessage
                    label="Name"
                    message={formik.errors.name}
                />
                <Form.Control asChild>
                    <Input
                        onChange={formik.handleChange}
                        value={formik.values.name}
                        type="name"
                        required
                    />
                </Form.Control>
            </FormField>
            <FormField name="description">
                <FormLabelAndMessage
                    label="Description"
                    message={formik.errors.description}
                />
                <Form.Control asChild>
                    <Input
                        onChange={formik.handleChange}
                        value={formik.values.description}
                        type="description"
                    />
                </Form.Control>
            </FormField>
            <div className="flex py-4">
                <Form.Submit asChild>
                    <button className="w-full bg-black text-white font-bold text-center p-2 rounded-md shadow-md hover:cursor-pointer">
                        {isSubmitting ? 'Loading...' : 'Save UserGroup'}
                    </button>
                </Form.Submit>
            </div>
        </FormLayout>
    )
}

export default EditUserGroup


================================================
FILE: apps/web/components/Objects/Modals/Dash/OrgUserGroups/ManageUsers.tsx
================================================
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { useOrg } from '@components/Contexts/OrgContext'
import { getAPIUrl } from '@services/config/config'
import { linkUserToUserGroup, unLinkUserToUserGroup } from '@services/usergroups/usergroups'
import { swrFetcher } from '@services/utils/ts/requests'
import { Check, Plus, X } from 'lucide-react'
import React from 'react'
import toast from 'react-hot-toast'
import useSWR, { mutate } from 'swr'


type ManageUsersProps = {
  usergroup_id: any
}

function ManageUsers(props: ManageUsersProps) {
  const org = useOrg() as any
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token;
  const { data: OrgUsers } = useSWR(
    org ? `${getAPIUrl()}orgs/${org.id}/users` : null,
    (url) => swrFetcher(url, access_token)
  )
  const { data: UGusers } = useSWR(
    org ? `${getAPIUrl()}usergroups/${props.usergroup_id}/users` : null,
    (url) => swrFetcher(url, access_token)
  )

  const isUserPartOfGroup = (user_id: any) => {
    if (UGusers) {
      return UGusers.some((user: any) => user.id === user_id)
    }
    return false
  }

  const handleLinkUser = async (user_id: any) => {
    const res = await linkUserToUserGroup(props.usergroup_id, user_id, access_token)
    if (res.status === 200) {
      toast.success('User linked successfully')
      mutate(`${getAPIUrl()}usergroups/${props.usergroup_id}/users`)
    } else {
      toast.error('Error ' + res.status + ': ' + res.data.detail)
    }
  }

  const handleUnlinkUser = async (user_id: any) => {
    const res = await unLinkUserToUserGroup(props.usergroup_id, user_id, access_token)
    if (res.status === 200) {
      toast.success('User unlinked successfully')
      mutate(`${getAPIUrl()}usergroups/${props.usergroup_id}/users`)
    } else {
      toast.error('Error ' + res.status + ': ' + res.data.detail)
    }
  }

  return (
    <div className='py-3'>
      <table className="table-auto w-full text-left whitespace-nowrap rounded-md overflow-hidden">
        <thead className="bg-gray-100 text-gray-500 rounded-xl uppercase">
          <tr className="font-bolder text-sm">
            <th className="py-3 px-4">User</th>
            <th className="py-3 px-4">Linked</th>
            <th className="py-3 px-4">Actions</th>
          </tr>
        </thead>
        <>
          <tbody className="mt-5 bg-white rounded-md">
            {OrgUsers?.map((user: any) => (
              <tr
                key={user.user.id}
                className="border-b border-gray-200 border-dashed text-sm"
              >
                <td className="py-3 px-4 flex space-x-2 items-center">
                  <span>
                    {user.user.first_name + ' ' + user.user.last_name}
                  </span>
                  <span className="text-xs bg-neutral-100 p-1 px-2 rounded-full text-neutral-400 font-semibold">
                    @{user.user.username}
                  </span>
                </td>
                <td className="py-3 px-4">
                  {isUserPartOfGroup(user.user.id) ?
                    <div className="space-x-1 flex w-fit px-4 py-1 bg-cyan-100 rounded-full items-center text-cyan-800">
                      <Check size={16} />
                      <span>Linked</span>
                    </div>
                    :
                    <div className="space-x-1 flex w-fit px-4 py-1 bg-gray-100 rounded-full items-center text-gray-800">
                      <X size={16} />
                      <span>Not linked</span>
                    </div>
                  }
                </td>
                <td className="py-3 px-4 flex space-x-2 items-end">
                  <button
                    onClick={() => handleLinkUser(user.user.id)}
                    className="flex space-x-2 hover:cursor-pointer p-1 px-3 bg-cyan-700 rounded-md font-bold items-center text-sm text-cyan-100">
                    <Plus className="w-4 h-4" />
                    <span> Link</span>
                  </button>
                  <button
                    onClick={() => handleUnlinkUser(user.user.id)}
                    className="flex space-x-2 hover:cursor-pointer p-1 px-3 bg-gray-700 rounded-md font-bold items-center text-sm text-gray-100">
                    <X className="w-4 h-4" />
                    <span> Unlink</span>
                  </button>

                </td>
              </tr>
            ))}
          </tbody>
        </>
      </table>
    </div>
  )
}

export default ManageUsers


================================================
FILE: apps/web/components/Objects/Modals/Dash/OrgUsers/RolesUpdate.tsx
================================================
'use client'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { useOrg } from '@components/Contexts/OrgContext'
import FormLayout, {
  ButtonBlack,
  Flex,
  FormField,
  FormLabel,
} from '@components/Objects/StyledElements/Form/Form'
import * as Form from '@radix-ui/react-form'
import { FormMessage } from '@radix-ui/react-form'
import { getAPIUrl } from '@services/config/config'
import { updateUserRole } from '@services/organizations/orgs'
import { swrFetcher } from '@services/utils/ts/requests'
import React, { useEffect } from 'react'
import toast from 'react-hot-toast'
import { BarLoader } from 'react-spinners'
import { mutate } from 'swr'
import useSWR from 'swr'

interface Props {
  user: any
  setRolesModal: any
  alreadyAssignedRole: any
}

function RolesUpdate(props: Props) {
  const org = useOrg() as any
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token;
  const [isSubmitting, setIsSubmitting] = React.useState(false)
  const [assignedRole, setAssignedRole] = React.useState(
    props.alreadyAssignedRole
  )
  const [error, setError] = React.useState(null) as any

  // Fetch available roles for the organization
  const { data: roles, error: rolesError } = useSWR(
    org ? `${getAPIUrl()}roles/org/${org.id}` : null,
    (url) => swrFetcher(url, access_token)
  )

  const handleAssignedRole = (event: React.ChangeEvent<any>) => {
    setError(null)
    setAssignedRole(event.target.value)
  }

  const handleSubmit = async (e: any) => {
    e.preventDefault()
    setIsSubmitting(true)
    const res = await updateUserRole(org.id, props.user.user.id, assignedRole,access_token)
    const toastId = toast.loading("Updating role...")
    if (res.status === 200) {
      await mutate(`${getAPIUrl()}orgs/${org.id}/users`)
      props.setRolesModal(false)
      toast.success("Updated role", {id:toastId})
    } else {
      setIsSubmitting(false)
      setError('Error ' + res.status + ': ' + res.data.detail)
      toast.error("Error while updating role", {id:toastId})
    }
  }

  useEffect(() => {}, [assignedRole])

  return (
    <div>
      <FormLayout onSubmit={handleSubmit}>
        <FormField name="course-visibility">
          {error ? (
            <div className="text-red-500 font-bold text-xs px-3 py-2 bg-red-100 rounded-md">
              {error}
            </div>
          ) : (
            ''
          )}
          <Flex
            css={{ alignItems: 'baseline', justifyContent: 'space-between' }}
          >
            <FormLabel>Roles</FormLabel>
            <FormMessage match="valueMissing">
              Please choose a role for the user
            </FormMessage>
          </Flex>
          <Form.Control asChild>
            <select
              onChange={handleAssignedRole}
              defaultValue={assignedRole}
              className="border border-gray-300 rounded-md p-2"
              required
              disabled={!roles || rolesError}
            >
              {!roles || rolesError ? (
                <option value="">Loading roles...</option>
              ) : (
                <>
                  <option value="">Select a role</option>
                  {roles.map((role: any) => (
                    <option key={role.id} value={role.role_uuid || role.id}>
                      {role.name}
                    </option>
                  ))}
                </>
              )}
            </select>
          </Form.Control>
        </FormField>
        <div className="h-full"></div>
        <Flex css={{ marginTop: 25, justifyContent: 'flex-end' }}>
          <Form.Submit asChild>
            <ButtonBlack type="submit" css={{ marginTop: 10 }}>
              {isSubmitting ? (
                <BarLoader
                  cssOverride={{ borderRadius: 60 }}
                  width={60}
                  color="#ffffff"
                />
              ) : (
                'Update user role'
              )}
            </ButtonBlack>
          </Form.Submit>
        </Flex>
      </FormLayout>
    </div>
  )
}

export default RolesUpdate



================================================
FILE: apps/web/components/Objects/Onboarding/Onboarding.tsx
================================================
import Modal from '@components/Objects/StyledElements/Modal/Modal';
import Image, { StaticImageData } from 'next/image';
import React, { useEffect, useState } from 'react';
import OnBoardWelcome from '@public/onboarding/OnBoardWelcome.png';
import OnBoardCourses from '@public/onboarding/OnBoardCourses.png';
import OnBoardActivities from '@public/onboarding/OnBoardActivities.png';
import OnBoardEditor from '@public/onboarding/OnBoardEditor.png';
import OnBoardAI from '@public/onboarding/OnBoardAI.png';
import OnBoardUGs from '@public/onboarding/OnBoardUGs.png';
import OnBoardAccess from '@public/onboarding/OnBoardAccess.png';
import OnBoardMore from '@public/onboarding/OnBoardMore.png';
import OnBoardAssignments from '@public/onboarding/OnBoardAssignments.png';
import OnBoardPayments from '@public/onboarding/OnBoardPayments.png';
import { ArrowRight, Book, Check, Globe, Info, PictureInPicture, Sparkle, Sprout, SquareUser, CreditCard } from 'lucide-react';
import { useRouter } from 'next/navigation';
import { getUriWithOrg } from '@services/config/config';
import { useOrg } from '@components/Contexts/OrgContext';
import useAdminStatus from '@components/Hooks/useAdminStatus';

interface OnboardingStep {
  imageSrc: StaticImageData;
  title: string;
  description: string;
  buttons?: {
    label: string;
    action: () => void;
    icon?: React.ReactNode;
  }[];
}

const Onboarding: React.FC = () => {
  const [currentStep, setCurrentStep] = useState(() => {
    // Initialize with saved step or 0
    const savedStep = localStorage.getItem('onboardingLastStep');
    return savedStep ? parseInt(savedStep) : 0;
  });
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isOnboardingComplete, setIsOnboardingComplete] = useState(true);
  const [isTemporarilyClosed, setIsTemporarilyClosed] = useState(false);
  const [isMobile, setIsMobile] = useState(false);
  const router = useRouter();
  const org = useOrg() as any;
  const isUserAdmin = useAdminStatus() as any;

  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.innerWidth < 768);
    };
    
    // Initial check
    checkMobile();

    // Add event listener for window resize
    window.addEventListener('resize', checkMobile);

    // Cleanup
    return () => window.removeEventListener('resize', checkMobile);
  }, []);

  const onboardingData: OnboardingStep[] = [
    {
      imageSrc: OnBoardWelcome,
      title: 'Teach the world!',
      description: 'Welcome to LearnHouse, a LMS engineered for simplicity, ease of use and performance, meet the new way to create, share, and engage with educational content.',
    },
    {
      imageSrc: OnBoardCourses,
      title: 'Create Courses',
      description: 'Courses are the main building blocks of LearnHouse, they always contain Chapters and Chapters contain Activities.',
      buttons: [
        {
          label: 'Create New Course',
          action: () => router.push(getUriWithOrg(org?.slug, '/courses?new=true')),
          icon: <Book size={16} />,
        },
      ],
    },
    {
      imageSrc: OnBoardActivities,
      title: 'Activities',
      description: 'Activities are elements you can add to your Courses via Chapters, they can be : Dynamic Pages, Videos, Documents, Quizz and more soon.',
      buttons: [
        {
          label: 'Learn more about activities',
          action: () => window.open('https://university.learnhouse.io/course/be89716c-9992-44bb-81df-ef3d76e355ba', '_blank'),
          icon: <Info size={16} />,
        },
      ],
    },
    {
      imageSrc: OnBoardEditor,
      title: 'Dynamic pages and The Editor',
      description: 'Dynamic pages are pages with dynamic content, like Notion pages they can contain various components like Quizzes, Images, Videos, Documents etc',
      buttons: [
        {
          label: 'Learn more about Dynamic Pages and The Editor',
          action: () => window.open('https://university.learnhouse.io/course/be89716c-9992-44bb-81df-ef3d76e355ba', '_blank'),
          icon: <Info size={16} />,
        },
      ],
    },
    {
      imageSrc: OnBoardAI,
      title: 'Artificial Intelligence',
      description: 'Tools for tought made for teachers and students alike, context aware it can reply based on your courses and the unique content you create on LearnHouse',
      buttons: [
        {
          label: 'Learn more about LearnHouse AI',
          action: () => window.open('https://docs.learnhouse.app/features/ai/students', '_blank'),
          icon: <Sparkle size={16} />,
        },
      ],
    },
    {
      imageSrc: OnBoardUGs,
      title: 'Group students and streamline access ',
      description: 'With UserGroups you can separate students by Groups and give access to Courses depending on their needs',
      buttons: [
        {
          label: 'Create UserGroups',
          action: () => router.push(getUriWithOrg(org?.slug, '/dash/users/settings/usergroups')),
          icon: <SquareUser size={16} />,
        },
      ],
    },
    {
      imageSrc: OnBoardAccess,
      title: 'Choose whether to make Courses available on the Web or not ',
      description: 'You can choose to make your Courses discoverable from search engines and accesible to non authenticated users or to only give it to authenticated Users',
      buttons: [

      ],
    },
    {
      imageSrc: OnBoardAssignments,
      title: 'Create and Grade Assignments',
      description: 'Engage students with assignments, track their progress, and provide feedback through our intuitive grading system.',
      buttons: [
        {
          label: 'Create Assignment',
          action: () => router.push(getUriWithOrg(org?.slug, '/dash/assignments?new=true')),
          icon: <Book size={16} />,
        },
      ],
    },
    {
      imageSrc: OnBoardPayments,
      title: 'Monetize Your Content',
      description: 'Set up payment plans, sell courses, and manage subscriptions with our integrated payment system.',
      buttons: [
        {
          label: 'Payment Settings',
          action: () => router.push(getUriWithOrg(org?.slug, '/dash/payments/customers')),
          icon: <CreditCard size={16} />,
        },
      ],
    },
    {
      imageSrc: OnBoardMore,
      title: 'To infinity and beyond',
      description: "To Learn more about LearnHouse, you're welcome to follow our Original courses on the LearnHouse University",
      buttons: [
        {
          label: 'LearnHouse University',
          action: () => window.open('https://university.learnhouse.io', '_blank'),
          icon: <Globe size={16} />,
        },
      ],
    },
  ];

  useEffect(() => {
    // Check both completion and temporary closure status
    const isOnboardingCompleted = localStorage.getItem('isOnboardingCompleted');
    const temporarilyClosed = localStorage.getItem('onboardingTemporarilyClosed');
    const lastClosedTime = localStorage.getItem('onboardingLastClosedTime');

    setIsOnboardingComplete(isOnboardingCompleted === 'true');
    setIsTemporarilyClosed(temporarilyClosed === 'true');

    // If temporarily closed, check if 24 hours have passed
    if (temporarilyClosed === 'true' && lastClosedTime) {
      const hoursSinceClosed = (Date.now() - parseInt(lastClosedTime)) / (1000 * 60 * 60);
      if (hoursSinceClosed >= 24) {
        // Reset temporary closure after 24 hours
        localStorage.removeItem('onboardingTemporarilyClosed');
        localStorage.removeItem('onboardingLastClosedTime');
        setIsTemporarilyClosed(false);
      }
    }

    // Show modal if onboarding is not completed and not temporarily closed
    setIsModalOpen(!isOnboardingCompleted && !temporarilyClosed);
  }, []);

  // Update stored step whenever currentStep changes
  useEffect(() => {
    localStorage.setItem('onboardingLastStep', currentStep.toString());
  }, [currentStep]);

  const handleModalClose = () => {
    // Store temporary closure status and timestamp
    localStorage.setItem('onboardingTemporarilyClosed', 'true');
    localStorage.setItem('onboardingLastClosedTime', Date.now().toString());
    // Current step is already saved via the useEffect above
    setIsTemporarilyClosed(true);
    setIsModalOpen(false);
  };

  const nextStep = () => {
    if (currentStep < onboardingData.length - 1) {
      setCurrentStep(currentStep + 1);
    } else {
      // Mark onboarding as completed in local storage
      localStorage.setItem('isOnboardingCompleted', 'true');
      localStorage.removeItem('onboardingLastStep'); // Clean up stored step
      setIsModalOpen(false);
      setIsOnboardingComplete(true);
      console.log('Onboarding completed');
    }
  };

  const skipOnboarding = () => {
    localStorage.setItem('isOnboardingCompleted', 'true');
    localStorage.removeItem('onboardingLastStep'); // Clean up stored step
    setIsModalOpen(false);
    setIsOnboardingComplete(true);
    console.log('Onboarding skipped');
  };

  const goToStep = (index: number) => {
    if (index >= 0 && index < onboardingData.length) {
      setCurrentStep(index);
    }
  };

  return (
    <div>
      {isUserAdmin.isAdmin && !isUserAdmin.loading && !isOnboardingComplete && !isMobile && <Modal
        isDialogOpen={isModalOpen}
        onOpenChange={setIsModalOpen}
        minHeight="sm"
        minWidth='md'
        dialogContent={
          <OnboardingScreen
            step={onboardingData[currentStep]}
            onboardingData={onboardingData}
            currentStep={currentStep}
            nextStep={nextStep}
            skipOnboarding={skipOnboarding}
            setIsModalOpen={handleModalClose}
            goToStep={goToStep}
          />
        }
        dialogTrigger={
          <div className='fixed pb-10 w-full bottom-0 bg-linear-to-t from-1% from-gray-950/25 to-transparent'>
            <div className='bg-gray-950 flex space-x-2 font-bold cursor-pointer hover:bg-gray-900 shadow-md items-center text-gray-200 px-5 py-2 w-fit rounded-full mx-auto'>
              <Sprout size={20} />
              <p>Onboarding</p>
              <div className='h-2 w-2 bg-green-500 animate-pulse rounded-full'></div>
              <div 
                className="ml-2 pl-2 border-l border-gray-700 cursor-pointer"
                onClick={(e) => {
                  e.stopPropagation();
                  skipOnboarding();
                }}
              >
                <Check size={16} className="hover:text-green-500" />
              </div>
            </div>
          </div>
        }
      />}
    </div>
  );
};

interface OnboardingScreenProps {
  step: OnboardingStep;
  currentStep: number;
  nextStep: () => void;
  skipOnboarding: () => void;
  goToStep: (index: number) => void;
  setIsModalOpen: (value: boolean) => void;
  onboardingData: OnboardingStep[];
}

const OnboardingScreen: React.FC<OnboardingScreenProps> = ({
  step,
  currentStep,
  nextStep,
  skipOnboarding,
  goToStep,
  onboardingData,
  setIsModalOpen,
}) => {
  const isLastStep = currentStep === onboardingData.length - 1;

  return (
    <div className='flex flex-col'>
      <div className='onboarding_screens flex-col px-4 py-4'>
        <div className='grow rounded-xl'>
          <Image 
            unoptimized 
            className='mx-auto shadow-md shadow-gray-200 rounded-lg w-[730px] h-[330px] object-cover' 
            alt='' 
            priority 
            quality={100} 
            src={step.imageSrc} 
          />
        </div>
        <div className='grid grid-flow-col justify-stretch space-x-3 mt-4'>
          {onboardingData.map((_, index) => (
            <div
              key={index}
              onClick={() => goToStep(index)}
              className={`h-[7px] w-auto ${index === currentStep ? 'bg-black' : 'bg-gray-300'} hover:bg-gray-700 rounded-lg shadow-md cursor-pointer`}
            ></div>
          ))}
        </div>
      </div>
      <div className='onboarding_text flex flex-col h-[90px] py-2 px-4 leading-tight'>
        <h2 className='text-xl font-bold'>{step.title}</h2>
        <p className='text-md font-normal'>{step.description}</p>
      </div>
      <div className='onboarding_actions flex flex-row-reverse w-full px-4'>
        <div className='flex flex-row justify-between w-full py-2'>
          <div className='utils_buttons flex flex-row space-x-2'>
            <div
              className="inline-flex items-center px-5 space-x-1 cursor-pointer py-1 rounded-full text-gray-600 antialiased font-bold bg-gray-100 hover:bg-gray-200"
              onClick={() => setIsModalOpen(false)}
            >
              <PictureInPicture size={16} />
            </div>
            <div
              className="inline-flex items-center px-5 space-x-2 cursor-pointer py-1 rounded-full text-gray-600 antialiased font-bold bg-gray-100 hover:bg-gray-200"
              onClick={skipOnboarding}
            >
              <p>End</p>
              <Check size={16} />
            </div>
          </div>
          <div className='actions_buttons flex space-x-2'>
            {step.buttons?.map((button, index) => (
              <div
                key={index}
                className="inline-flex items-center px-5 space-x-2 cursor-pointer py-1 rounded-full text-gray-200 antialiased font-bold bg-black hover:bg-gray-700 shadow-md whitespace-nowrap"
                onClick={button.action}
              >
                <p>{button.label}</p>
                {button.icon}
              </div>
            ))}
            {isLastStep ? (
              <div
                className="inline-flex items-center px-5 space-x-2 cursor-pointer py-1 rounded-full text-gray-200 antialiased font-bold bg-black hover:bg-gray-700 shadow-md whitespace-nowrap"
                onClick={nextStep}
              >
                <p>Finish Onboarding</p>
                <Check size={16} />
              </div>
            ) : (
              <div
                className="inline-flex items-center px-5 space-x-2 cursor-pointer py-1 rounded-full text-gray-200 antialiased font-bold bg-black hover:bg-gray-700 shadow-md whitespace-nowrap"
                onClick={nextStep}
              >
                <p>Next</p>
                <ArrowRight size={16} />
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

export default Onboarding;


================================================
FILE: apps/web/components/Objects/Search/SearchBar.tsx
================================================
import React, { useState, useEffect, useRef, useMemo, useCallback } from 'react';
import { Search, ArrowRight, Sparkles, Book, GraduationCap, ArrowUpRight, TextSearch, ScanSearch, Users } from 'lucide-react';
import { searchOrgContent } from '@services/search/search';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import Link from 'next/link';
import { getCourseThumbnailMediaDirectory, getUserAvatarMediaDirectory } from '@services/media/media';
import { useDebounce } from '@/hooks/useDebounce';
import { useOrg } from '@components/Contexts/OrgContext';
import { getUriWithOrg } from '@services/config/config';
import { removeCoursePrefix } from '../Thumbnails/CourseThumbnail';
import UserAvatar from '../UserAvatar';

interface User {
  username: string;
  first_name: string;
  last_name: string;
  email: string;
  avatar_image: string;
  bio: string;
  details: Record<string, any>;
  profile: Record<string, any>;
  id: number;
  user_uuid: string;
}

interface Author {
  user: User;
  authorship: string;
  authorship_status: string;
  creation_date: string;
  update_date: string;
}

interface Course {
  name: string;
  description: string;
  about: string;
  learnings: string;
  tags: string;
  thumbnail_image: string;
  public: boolean;
  open_to_contributors: boolean;
  id: number;
  org_id: number;
  authors: Author[];
  course_uuid: string;
  creation_date: string;
  update_date: string;
}

interface Collection {
  name: string;
  public: boolean;
  description: string;
  id: number;
  courses: string[];
  collection_uuid: string;
  creation_date: string;
  update_date: string;
}

interface SearchResults {
  courses: Course[];
  collections: Collection[];
  users: User[];
}

interface SearchBarProps {
  orgslug: string;
  className?: string;
  isMobile?: boolean;
  showSearchSuggestions?: boolean;
}

const CourseResultsSkeleton = () => (
  <div className="p-2 ">
    <div className="flex items-center gap-2 px-2 py-2">
      <div className="w-4 h-4 bg-black/5 rounded animate-pulse" />
      <div className="w-20 h-4 bg-black/5 rounded animate-pulse" />
    </div>
    {[1, 2].map((i) => (
      <div key={i} className="flex items-center gap-3 p-2">
        <div className="w-10 h-10 bg-black/5 rounded-lg animate-pulse" />
        <div className="flex-1">
          <div className="w-48 h-4 bg-black/5 rounded animate-pulse mb-2" />
          <div className="w-32 h-3 bg-black/5 rounded animate-pulse" />
        </div>
      </div>
    ))}
  </div>
);

export const SearchBar: React.FC<SearchBarProps> = ({ 
  orgslug, 
  className = '', 
  isMobile = false,
  showSearchSuggestions = false,
}) => {
  const org = useOrg() as any;
  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState<SearchResults>({
    courses: [],
    collections: [],
    users: []
  });
  const [isLoading, setIsLoading] = useState(false);
  const [showResults, setShowResults] = useState(false);
  const searchRef = useRef<HTMLDivElement>(null);
  const session = useLHSession() as any;
  const [isInitialLoad, setIsInitialLoad] = useState(true);

  // Debounce the search query value
  const debouncedSearch = useDebounce(searchQuery, 300);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (searchRef.current && !searchRef.current.contains(event.target as Node)) {
        setShowResults(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  useEffect(() => {
    const fetchResults = async () => {
      if (debouncedSearch.trim().length === 0) {
        setSearchResults({ courses: [], collections: [], users: [] });
        setIsLoading(false);
        return;
      }

      setIsLoading(true);
      try {
        const response = await searchOrgContent(
          orgslug,
          debouncedSearch,
          1,
          3,
          null,
          session?.data?.tokens?.access_token
        );
        
        console.log('Search API Response:', response); // Debug log

        // Type assertion and safe access
        const typedResponse = response.data as any;
        
        // Ensure we have the correct structure and handle potential undefined values
        const processedResults: SearchResults = {
          courses: Array.isArray(typedResponse?.courses) ? typedResponse.courses : [],
          collections: Array.isArray(typedResponse?.collections) ? typedResponse.collections : [],
          users: Array.isArray(typedResponse?.users) ? typedResponse.users : []
        };

        console.log('Processed Results:', processedResults); // Debug log
        
        setSearchResults(processedResults);
      } catch (error) {
        console.error('Error searching content:', error);
        setSearchResults({ courses: [], collections: [], users: [] });
      }
      setIsLoading(false);
      setIsInitialLoad(false);
    };

    fetchResults();
  }, [debouncedSearch, orgslug, session?.data?.tokens?.access_token]);

  const MemoizedEmptyState = useMemo(() => {
    if (!searchQuery.trim()) {
      return (
        <div className="py-8 px-4">
          <div className="flex flex-col items-center text-center">
            <div className="mb-4 p-3 bg-black/5 rounded-full">
              <Sparkles className="w-6 h-6 text-black/70" />
            </div>
            <h3 className="text-sm font-medium text-black/80 mb-1">
              Discover Your Next Learning Journey
            </h3>
            <p className="text-xs text-black/50 max-w-[240px]">
              Start typing to search through available content
            </p>
          </div>
        </div>
      );
    }
    return null;
  }, [searchQuery]);

  const searchTerms = useMemo(() => [
    { term: searchQuery, type: 'exact', icon: <Search size={14} className="text-black/40" /> },
    { term: `${searchQuery} courses`, type: 'courses', icon: <GraduationCap size={14} className="text-black/40" /> },
    { term: `${searchQuery} collections`, type: 'collections', icon: <Book size={14} className="text-black/40" /> },
  ], [searchQuery]);

  const MemoizedSearchSuggestions = useMemo(() => {
    if (searchQuery.trim()) {
      return (
        <div className="p-2">
          <div className="flex items-center gap-2 px-2 py-2 text-sm text-black/50">
            <ScanSearch size={16} />
            <span className="font-medium">Search suggestions</span>
          </div>
          <div className="space-y-1">
            {searchTerms.map(({ term, type, icon }) => (
              <Link
                key={`${term}-${type}`}
                href={getUriWithOrg(orgslug, `/search?q=${encodeURIComponent(term)}`)}
                className="flex items-center px-3 py-2 hover:bg-black/[0.02] rounded-lg transition-colors group"
              >
                <div className="flex items-center gap-2 flex-1">
                  {icon}
                  <span className="text-sm text-black/70">{term}</span>
                </div>
                <ArrowUpRight size={14} className="text-black/30 group-hover:text-black/50 transition-colors" />
              </Link>
            ))}
          </div>
        </div>
      );
    }
    return null;
  }, [searchQuery, searchTerms, orgslug]);

  const MemoizedQuickResults = useMemo(() => {
    const hasResults = searchResults.courses.length > 0 || 
                      searchResults.collections.length > 0 || 
                      searchResults.users.length > 0;
    
    if (!hasResults) return null;
    
    return (
      <div className="p-2">
        <div className="flex items-center gap-2 px-2 py-2 text-sm text-black/50">
          <TextSearch size={16} />
          <span className="font-medium">Quick Results</span>
        </div>

        {/* Courses Section */}
        {searchResults.courses.length > 0 && (
          <div className="mb-2">
            <div className="flex items-center gap-2 px-2 py-1 text-xs text-black/40">
              <GraduationCap size={12} />
              <span>Courses</span>
            </div>
            {searchResults.courses.map((course) => (
              <Link
                key={course.course_uuid}
                href={getUriWithOrg(orgslug, `/course/${removeCoursePrefix(course.course_uuid)}`)}
                className="flex items-center gap-3 p-2 hover:bg-black/[0.02] rounded-lg transition-colors"
              >
                <div className="relative">
                  {course.thumbnail_image ? (
                    <img
                      src={getCourseThumbnailMediaDirectory(org?.org_uuid, course.course_uuid, course.thumbnail_image)}
                      alt={course.name}
                      className="w-10 h-10 object-cover rounded-lg"
                    />
                  ) : (
                    <div className="w-10 h-10 bg-black/5 rounded-lg flex items-center justify-center">
                      <Book size={20} className="text-black/40" />
                    </div>
                  )}
                  <div className="absolute -bottom-1 -right-1 bg-white shadow-sm p-1 rounded-full">
                    <GraduationCap size={11} className="text-black/60" />
                  </div>
                </div>
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2">
                    <h3 className="text-sm font-medium text-black/80 truncate">{course.name}</h3>
                    <span className="text-[10px] font-medium text-black/40 uppercase tracking-wide whitespace-nowrap">Course</span>
                  </div>
                  <p className="text-xs text-black/50 truncate">{course.description}</p>
                </div>
              </Link>
            ))}
          </div>
        )}

        {/* Collections Section */}
        {searchResults.collections.length > 0 && (
          <div className="mb-2">
            <div className="flex items-center gap-2 px-2 py-1 text-xs text-black/40">
              <Book size={12} />
              <span>Collections</span>
            </div>
            {searchResults.collections.map((collection) => (
              <Link
                key={collection.collection_uuid}
                href={getUriWithOrg(orgslug, `/collection/${collection.collection_uuid}`)}
                className="flex items-center gap-3 p-2 hover:bg-black/[0.02] rounded-lg transition-colors"
              >
                <div className="w-10 h-10 bg-black/5 rounded-lg flex items-center justify-center">
                  <Book size={20} className="text-black/40" />
                </div>
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2">
                    <h3 className="text-sm font-medium text-black/80 truncate">{collection.name}</h3>
                    <span className="text-[10px] font-medium text-black/40 uppercase tracking-wide whitespace-nowrap">Collection</span>
                  </div>
                  <p className="text-xs text-black/50 truncate">{collection.description}</p>
                </div>
              </Link>
            ))}
          </div>
        )}

        {/* Users Section */}
        {searchResults.users.length > 0 && (
          <div className="mb-2">
            <div className="flex items-center gap-2 px-2 py-1 text-xs text-black/40">
              <Users size={12} />
              <span>Users</span>
            </div>
            {searchResults.users.map((user) => (
              <Link
                key={user.user_uuid}
                href={getUriWithOrg(orgslug, `/user/${user.username}`)}
                className="flex items-center gap-3 p-2 hover:bg-black/[0.02] rounded-lg transition-colors"
              >
                <UserAvatar
                  width={40}
                  avatar_url={user.avatar_image ? getUserAvatarMediaDirectory(user.user_uuid, user.avatar_image) : ''}
                  predefined_avatar={user.avatar_image ? undefined : 'empty'}
                  userId={user.id.toString()}
                  showProfilePopup
                  rounded="rounded-full"
                  backgroundColor="bg-gray-100"
                />
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2">
                    <h3 className="text-sm font-medium text-black/80 truncate">
                      {user.first_name} {user.last_name}
                    </h3>
                    <span className="text-[10px] font-medium text-black/40 uppercase tracking-wide whitespace-nowrap">User</span>
                  </div>
                  <p className="text-xs text-black/50 truncate">@{user.username}</p>
                </div>
              </Link>
            ))}
          </div>
        )}
      </div>
    );
  }, [searchResults, orgslug, org?.org_uuid]);

  const handleSearchChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    setSearchQuery(e.target.value);
    setShowResults(true);
  }, []);

  return (
    <div ref={searchRef} className={`relative ${className}`}>
      <div className="relative group">
        <input
          type="text"
          value={searchQuery}
          onChange={handleSearchChange}
          onFocus={() => setShowResults(true)}
          placeholder="Search courses, users, collections..."
          className="w-full h-9 pl-11 pr-4 rounded-xl nice-shadow bg-white 
                     focus:outline-none focus:ring-1 focus:ring-black/5 focus:border-black/20 
                     text-sm placeholder:text-black/40 transition-all"
        />
        <div className="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none">
          <Search className="text-black/40 group-focus-within:text-black/60 transition-colors" size={18} />
        </div>
      </div>

      <div 
        className={`absolute z-50 w-full mt-2 bg-white rounded-xl nice-shadow 
                   overflow-hidden divide-y divide-black/5
                   transition-all duration-200 ease-in-out transform
                   ${showResults ? 'opacity-100 translate-y-0' : 'opacity-0 -translate-y-2 pointer-events-none'}
                   ${isMobile ? 'max-w-full' : 'min-w-[400px]'}`}
      >
        {(!searchQuery.trim() || isInitialLoad) ? (
          MemoizedEmptyState
        ) : (
          <>
            {showSearchSuggestions && MemoizedSearchSuggestions}
            {isLoading ? (
              <CourseResultsSkeleton />
            ) : (
              <>
                {MemoizedQuickResults}
                {((searchResults.courses.length > 0 || 
                   searchResults.collections.length > 0 || 
                   searchResults.users.length > 0) || 
                   searchQuery.trim()) && (
                  <Link
                    href={getUriWithOrg(orgslug, `/search?q=${encodeURIComponent(searchQuery)}`)}
                    className="flex items-center justify-between px-4 py-2.5 text-xs text-black/50 hover:text-black/70 hover:bg-black/[0.02] transition-colors"
                  >
                    <span>View all results</span>
                    <ArrowRight size={14} />
                  </Link>
                )}
              </>
            )}
          </>
        )}
      </div>
    </div>
  );
}; 


================================================
FILE: apps/web/components/Objects/StyledElements/Buttons/NewCollectionButton.tsx
================================================
'use client'

function NewCollectionButton() {
  return (
    <button className="rounded-lg bg-black hover:scale-105 transition-all duration-100 ease-linear antialiased ring-offset-purple-800 p-2 px-5 my-auto font text-xs font-bold text-white drop-shadow-lg flex space-x-2 items-center">
      <div>New Collection </div>
      <div className="text-md bg-neutral-800 px-1 rounded-full">+</div>
    </button>
  )
}

export default NewCollectionButton



================================================
FILE: apps/web/components/Objects/StyledElements/Buttons/NewCourseButton.tsx
================================================
'use client'

function NewCourseButton() {
  return (
    <button className="rounded-lg bg-black hover:scale-105 transition-all duration-100 ease-linear antialiased ring-offset-purple-800 p-2 px-5 my-auto font text-xs font-bold text-white drop-shadow-lg flex space-x-2 items-center">
      <div>New Course </div>
      <div className="text-md bg-neutral-800 px-1 rounded-full">+</div>
    </button>
  )
}

export default NewCourseButton



================================================
FILE: apps/web/components/Objects/StyledElements/ConfirmationModal/ConfirmationModal.tsx
================================================
'use client'
import React from 'react'
import * as Dialog from '@radix-ui/react-dialog'
import { styled, keyframes } from '@stitches/react'
import { blackA } from '@radix-ui/colors'
import { AlertTriangle, Info } from 'lucide-react'

type ModalParams = {
  confirmationMessage: string
  confirmationButtonText: string
  dialogTitle: string
  functionToExecute: any
  dialogTrigger?: React.ReactNode
  status?: 'warning' | 'info'
  buttonid?: string
}

const ConfirmationModal = (params: ModalParams) => {
  const [isDialogOpen, setIsDialogOpen] = React.useState(false)
  const warningColors = 'bg-red-100 text-red-600'
  const infoColors = 'bg-blue-100 text-blue-600'
  const warningButtonColors = 'text-white bg-red-500 hover:bg-red-600'
  const infoButtonColors = 'text-white bg-blue-500 hover:bg-blue-600'

  const onOpenChange = React.useCallback(
    (open: any) => {
      setIsDialogOpen(open)
    },
    [setIsDialogOpen]
  )

  return (
    <Dialog.Root open={isDialogOpen} onOpenChange={onOpenChange}>
      {params.dialogTrigger ? (
        <Dialog.Trigger asChild>{params.dialogTrigger}</Dialog.Trigger>
      ) : null}

      <Dialog.Portal>
        <DialogOverlay />
        <DialogContent>
          <div className="flex space-x-4 tracking-tight">
            <div
              className={`icon p-6 rounded-xl flex items-center align-content-center ${
                params.status === 'warning' ? warningColors : infoColors
              }`}
            >
              {params.status === 'warning' ? (
                <AlertTriangle size={35} />
              ) : (
                <Info size={35} />
              )}
            </div>
            <div className="text pt-1 space-x-0 w-auto grow">
              <div className="text-xl font-bold text-black">
                {params.dialogTitle}
              </div>
              <div className="text-md text-gray-500 leading-tight mt-1">
                {params.confirmationMessage}
              </div>
              <div className="flex flex-row-reverse mt-4">
                <div
                  id={params.buttonid}
                  className={`rounded-md text-sm px-3 py-2 font-bold flex justify-center items-center hover:cursor-pointer ${
                    params.status === 'warning'
                      ? warningButtonColors
                      : infoButtonColors
                  }
                                hover:shadow-lg transition duration-300 ease-in-out
                                `}
                  onClick={() => {
                    params.functionToExecute()
                    setIsDialogOpen(false)
                  }}
                >
                  {params.confirmationButtonText}
                </div>
              </div>
            </div>
          </div>
        </DialogContent>
      </Dialog.Portal>
    </Dialog.Root>
  )
}

const overlayShow = keyframes({
  '0%': { opacity: 0 },
  '100%': { opacity: 1 },
})

const overlayClose = keyframes({
  '0%': { opacity: 1 },
  '100%': { opacity: 0 },
})

const contentShow = keyframes({
  '0%': { opacity: 0, transform: 'translate(-50%, -50%) scale(.96)' },
  '100%': { opacity: 1, transform: 'translate(-50%, -50%) scale(1)' },
})

const contentClose = keyframes({
  '0%': { opacity: 1, transform: 'translate(-50%, -50%) scale(1)' },
  '100%': { opacity: 0, transform: 'translate(-50%, -52%) scale(.96)' },
})

const DialogOverlay = styled(Dialog.Overlay, {
  backgroundColor: blackA.blackA9,
  position: 'fixed',
  zIndex: 500,
  inset: 0,
  animation: `${overlayShow} 150ms cubic-bezier(0.16, 1, 0.3, 1)`,
  '&[data-state="closed"]': {
    animation: `${overlayClose} 150ms cubic-bezier(0.16, 1, 0.3, 1)`,
  },
})

const DialogContent = styled(Dialog.Content, {
  backgroundColor: 'white',
  borderRadius: 18,
  zIndex: 501,
  boxShadow:
    'hsl(206 22% 7% / 35%) 0px 10px 38px -10px, hsl(206 22% 7% / 20%) 0px 10px 20px -15px',
  position: 'fixed',
  top: '50%',
  left: '50%',
  transform: 'translate(-50%, -50%)',
  width: 'auto',
  minWidth: '500px',
  maxWidth: '600px',
  overflow: 'visible',
  height: 'auto',
  maxHeight: '85vh',
  padding: '24px',
  animation: `${contentShow} 150ms cubic-bezier(0.16, 1, 0.3, 1)`,
  '&:focus': { outline: 'none' },

  '&[data-state="closed"]': {
    animation: `${contentClose} 150ms cubic-bezier(0.16, 1, 0.3, 1)`,
  },
  transition: 'max-height 0.3s ease-out',
})

export default ConfirmationModal



================================================
FILE: apps/web/components/Objects/StyledElements/Error/Error.tsx
================================================
'use client'
import { getUriWithoutOrg } from '@services/config/config'
import { AlertTriangle, HomeIcon, RefreshCcw } from 'lucide-react'
import Link from 'next/link'
import { useRouter } from 'next/navigation'
import React from 'react'

function ErrorUI(params: { message?: string, submessage?: string }) {
  const router = useRouter()

  function reloadPage() {
    router.refresh()
    window.location.reload()
  }

  return (
    <div className="flex flex-col py-10 mx-auto antialiased items-center space-y-6 bg-linear-to-b from-rose-100 to-rose-100/5 ">
      <div className="flex flex-row  items-center space-x-5  rounded-xl ">
        <AlertTriangle className="text-rose-700" size={45} />
        <div className='flex flex-col'>
          <p className="text-3xl font-bold text-rose-700">{params.message ? params.message : 'Something went wrong'}</p>
          <p className="text-lg font-bold text-rose-700">{params.submessage ? params.submessage : ''}</p>
        </div>
      </div>
      <div className='flex space-x-4'>
        <button
          onClick={() => reloadPage()}
          className="flex space-x-2 items-center rounded-full px-4 py-1 text-rose-200 bg-rose-700 hover:bg-rose-800 transition-all ease-linear shadow-lg "
        >
          <RefreshCcw className="text-rose-200" size={17} />
          <span className="text-md font-bold">Retry</span>
        </button>
        <Link
          href={getUriWithoutOrg('/home')}
          className="flex space-x-2 items-center rounded-full px-4 py-1 text-gray-200 bg-gray-700 hover:bg-gray-800 transition-all ease-linear shadow-lg "
        >
          <HomeIcon className="text-gray-200" size={17} />
          <span className="text-md font-bold">Home</span>
        </Link>
      </div>
    </div>
  )
}

export default ErrorUI



================================================
FILE: apps/web/components/Objects/StyledElements/Form/Form.tsx
================================================
import React from 'react'
import * as Form from '@radix-ui/react-form'
import { styled } from '@stitches/react'
import { blackA } from '@radix-ui/colors'
import { Info } from 'lucide-react'

interface FormLayoutProps {
  children: React.ReactNode
  onSubmit: (e: any) => void
  className?: string
}

const FormLayout = ({ children, onSubmit, className }: FormLayoutProps) => {
  return (
    <Form.Root onSubmit={onSubmit} className={className}>
      {children}
    </Form.Root>
  )
}

export const FormLabelAndMessage = (props: {
  label: string
  message?: string
}) => (
  <div className="flex items-center space-x-3">
    <FormLabel className="grow text-sm">{props.label}</FormLabel>
    {(props.message && (
      <div className="text-red-700 text-sm items-center  rounded-md flex  space-x-1">
        <Info size={10} />
        <div>{props.message}</div>
      </div>
    )) || <></>}
  </div>
)

export const FormRoot = styled(Form.Root, {
  margin: 7,
})

export const FormField = styled(Form.Field, {
  display: 'grid',
  marginBottom: 10,
})

export const FormLabel = styled(Form.Label, {
  fontWeight: 500,
  lineHeight: '35px',
  color: 'black',
})

export const FormMessage = styled(Form.Message, {
  fontSize: 13,
  color: 'white',
  opacity: 0.8,
})

export const Flex = styled('div', { display: 'flex' })

export const inputStyles = {
  all: 'unset',
  boxSizing: 'border-box',
  width: '100%',
  display: 'inline-flex',
  alignItems: 'center',
  justifyContent: 'center',
  borderRadius: 4,
  fontSize: 15,
  color: '#7c7c7c',
  background: '#fbfdff',
  boxShadow: `0 0 0 1px #edeeef`,
  '&:hover': { boxShadow: `0 0 0 1px #edeeef` },
  '&:focus': { boxShadow: `0 0 0 2px #edeeef` },
  '&::selection': { backgroundColor: blackA.blackA9, color: 'white' },
}

export const Input = styled('input', {
  ...inputStyles,
  height: 35,
  lineHeight: 1,
  padding: '0 10px',
  border: 'none',
})

export const Textarea = styled('textarea', {
  ...inputStyles,
  resize: 'none',
  padding: 10,
})

export const ButtonBlack = styled('button', {
  variants: {
    state: {
      loading: {
        pointerEvents: 'none',
        backgroundColor: '#808080',
      },
      none: {},
    },
  },
  all: 'unset',
  display: 'inline-flex',
  alignItems: 'center',
  justifyContent: 'center',
  borderRadius: 8,
  padding: '0 15px',
  fontSize: 15,
  lineHeight: 1,
  fontWeight: 500,
  height: 35,

  background: '#000000',
  color: '#FFFFFF',
  '&:hover': { backgroundColor: '#181818', cursor: 'pointer' },
  '&:focus': { boxShadow: `0 0 0 2px black` },
})

export default FormLayout



================================================
FILE: apps/web/components/Objects/StyledElements/Form/TagInput.tsx
================================================
import React, { useState, Dispatch, SetStateAction, useEffect } from 'react'
import { Tag, TagInput } from 'emblor'

interface FormTagInputProps {
  value: string
  onChange: (value: string) => void
  separator?: string
  error?: string
	placeholder?: string
}

const FormTagInput = ({
  value,
  onChange,
  separator = '|',
  error,
	placeholder,
}: FormTagInputProps) => {
  const [tags, setTags] = useState<Tag[]>(() =>
    value && typeof value === 'string'
      ? value.split(separator).filter(text => text.trim()).map((text, i) => ({
          id: i.toString(),
          text: text.trim(),
        }))
      : []
  );

  useEffect(() => {
    if (value && typeof value === 'string') {
      const newTags = value.split(separator)
        .filter(text => text.trim())
        .map((text, i) => ({
          id: i.toString(),
          text: text.trim(),
        }));
      setTags(newTags);
    } else {
      setTags([]);
    }
  }, [value, separator]);

  const [activeTagIndex, setActiveTagIndex] = useState<number | null>(null)

  const handleTagsChange: Dispatch<SetStateAction<Tag[]>> = (
    newTagsOrUpdater
  ) => {
    const newTags =
      typeof newTagsOrUpdater === 'function'
        ? newTagsOrUpdater(tags)
        : newTagsOrUpdater

    setTags(newTags)
    onChange(newTags.map((tag) => tag.text).join(separator))
  }

  return (
		<div>
			<div className="space-y-2">
				<TagInput
					tags={tags}
					setTags={handleTagsChange}
					placeholder={placeholder}
					styleClasses={{
						inlineTagsContainer:
							'border-input rounded-lg bg-background shadow-2xs transition-shadow focus-within:border-ring/40 focus-within:outline-hidden focus-within:ring-[3px] ring-ring/8 dark:ring-ring/12 p-1 gap-1',
						input:
							'w-full min-w-[80px] focus-visible:outline-hidden shadow-none px-2 h-7',
						tag: {
							body: 'h-7 relative bg-background border border-input hover:bg-background rounded-md font-medium text-xs ps-2 pe-7',
							closeButton:
								'absolute -inset-y-px -end-px p-0 rounded-e-lg flex size-7 transition-colors outline-hidden focus-visible:ring-2 focus-visible:ring-ring/30 dark:focus-visible:ring-ring/40 text-muted-foreground/80 hover:text-foreground',
						},
					}}
					activeTagIndex={activeTagIndex}
					setActiveTagIndex={setActiveTagIndex}
				/>
				{error && <p className="text-sm font-medium text-destructive">{error}</p>}
			</div>
		</div>
  )
}

export default FormTagInput



================================================
FILE: apps/web/components/Objects/StyledElements/Info/Info.tsx
================================================
'use client'
import { getUriWithoutOrg } from '@services/config/config'
import { Diamond, Home, PersonStanding } from 'lucide-react'
import Link from 'next/link'
import React from 'react'

function InfoUI(params: { message?: string, submessage?: string, cta?: string, href: string }) {
    return (
        <div className="flex flex-col py-10 mx-auto antialiased items-center space-y-6 bg-linear-to-b from-yellow-100 to-yellow-100/5 ">
            <div className="flex flex-row  items-center space-x-5  rounded-xl ">
                <Diamond className="text-yellow-700" size={45} />
                <div className='flex flex-col'>
                    <p className="text-3xl font-bold text-yellow-700">{params.message ? params.message : 'Something went wrong'}</p>
                    <p className="text-lg font-bold text-yellow-700">{params.submessage ? params.submessage : ''}</p>
                </div>
            </div>
            {params.cta && <div className='flex space-x-4'>
                <Link
                    href={params.href}
                    className="flex space-x-2 items-center rounded-full px-4 py-1 text-yellow-200 bg-yellow-700 hover:bg-yellow-800 transition-all ease-linear shadow-lg "
                >
                    <PersonStanding className="text-yellow-200" size={17} />
                    <span className="text-md font-bold">{params.cta}</span>
                </Link>
                <Link
                    href={getUriWithoutOrg('/home')}
                    className="flex space-x-2 items-center rounded-full px-4 py-1 text-gray-200 bg-gray-700 hover:bg-gray-800 transition-all ease-linear shadow-lg "
                >
                    <Home className="text-gray-200" size={17} />
                    <span className="text-md font-bold">Home</span>
                </Link>
            </div>}
        </div>
    )
}

export default InfoUI



================================================
FILE: apps/web/components/Objects/StyledElements/Modal/Modal.tsx
================================================
'use client'

import React from 'react'
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from "@components/ui/dialog"
import { ButtonBlack } from '../Form/Form'
import { cn } from "@/lib/utils"

type ModalParams = {
  dialogTitle?: string
  dialogDescription?: string
  dialogContent: React.ReactNode
  dialogClose?: React.ReactNode | null
  dialogTrigger?: React.ReactNode
  addDefCloseButton?: boolean
  onOpenChange: (open: boolean) => void
  isDialogOpen?: boolean
  minHeight?: 'sm' | 'md' | 'lg' | 'xl' | 'no-min'
  minWidth?: 'sm' | 'md' | 'lg' | 'xl' | 'no-min'
  customHeight?: string
  customWidth?: string
}

const Modal = (params: ModalParams) => {
  const getMinHeight = () => {
    switch (params.minHeight) {
      case 'sm': return 'md:min-h-[300px]'
      case 'md': return 'md:min-h-[500px]'
      case 'lg': return 'md:min-h-[700px]'
      case 'xl': return 'md:min-h-[900px]'
      default: return ''
    }
  }

  const getMinWidth = () => {
    switch (params.minWidth) {
      case 'sm': return 'md:min-w-[600px]'
      case 'md': return 'md:min-w-[800px]'
      case 'lg': return 'md:min-w-[1000px]'
      case 'xl': return 'md:min-w-[1200px]'
      default: return ''
    }
  }

  return (
    <Dialog open={params.isDialogOpen} onOpenChange={params.onOpenChange}>
      {params.dialogTrigger && (
        <DialogTrigger asChild>{params.dialogTrigger}</DialogTrigger>
      )}
      <DialogContent className={cn(
        "w-[95vw] max-w-[95vw]",
        "max-h-[90vh]",
        "p-3 sm:p-4 md:p-6",
        // Mobile-first responsive design
        "sm:w-[90vw] sm:max-w-[90vw]",
        "md:w-auto md:max-w-[90vw]",
        "lg:max-w-[85vw]",
        "xl:max-w-[80vw]",
        getMinHeight(),
        getMinWidth(),
        params.customHeight,
        params.customWidth
      )}>
        {params.dialogTitle && params.dialogDescription && (
          <DialogHeader className="text-center flex flex-col space-y-0.5 w-full">
            <DialogTitle className="text-lg sm:text-xl md:text-2xl">{params.dialogTitle}</DialogTitle>
            <DialogDescription className="text-sm sm:text-base">{params.dialogDescription}</DialogDescription>
          </DialogHeader>
        )}
        <div className="overflow-y-auto max-h-[calc(90vh-120px)] scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-transparent hover:scrollbar-thumb-gray-400">
          <div className="pr-2">
            {params.dialogContent}
          </div>
        </div>
        {(params.dialogClose || params.addDefCloseButton) && (
          <DialogFooter className="flex flex-col sm:flex-row gap-2 sm:gap-0">
            {params.dialogClose}
            {params.addDefCloseButton && (
              <ButtonBlack type="submit" aria-label="Close modal">
                Close
              </ButtonBlack>
            )}
          </DialogFooter>
        )}
      </DialogContent>
    </Dialog>
  )
}

export default Modal



================================================
FILE: apps/web/components/Objects/StyledElements/Titles/TypeOfContentTitle.tsx
================================================
import Image from 'next/image'
import CoursesLogo from 'public/svg/courses.svg'
import CollectionsLogo from 'public/svg/collections.svg'
import TrailLogo from 'public/svg/trail.svg'

function TypeOfContentTitle(props: { title: string; type: string }) {
  function getLogo() {
    if (props.type == 'col') {
      return CollectionsLogo
    } else if (props.type == 'cou') {
      return CoursesLogo
    } else if (props.type == 'tra') {
      return TrailLogo
    }
  }

  return (
    <div className="home_category_title flex my-5 items-center">
      <div className="ml-2 rounded-full ring-1 ring-slate-900/5 shadow-inner p-2 my-auto mr-4">
        <Image unoptimized className="" src={getLogo()} alt="Courses logo" />
      </div>
      <h1 className="font-bold text-2xl">{props.title}</h1>
    </div>
  )
}

export default TypeOfContentTitle



================================================
FILE: apps/web/components/Objects/StyledElements/Toast/Toast.tsx
================================================
'use client'
import React from 'react'
import { Toaster } from 'react-hot-toast'

function Toast() {
  return (
    <>
      <Toaster />
    </>
  )
}

export default Toast



================================================
FILE: apps/web/components/Objects/StyledElements/Tooltip/Tooltip.tsx
================================================
'use client'
import React from 'react'
import * as Tooltip from '@radix-ui/react-tooltip'
import { styled, keyframes } from '@stitches/react'

type TooltipProps = {
  sideOffset?: number
  content: React.ReactNode
  children: React.ReactNode
  side?: 'top' | 'right' | 'bottom' | 'left' // default is bottom
  slateBlack?: boolean
  unstyled?: boolean // new prop to remove default styling
}

const ToolTip = (props: TooltipProps) => {
  return (
    <Tooltip.Provider delayDuration={200}>
      <Tooltip.Root>
        <Tooltip.Trigger asChild>{props.children}</Tooltip.Trigger>
        <Tooltip.Portal>
          <TooltipContent
            slateBlack={props.slateBlack}
            unstyled={props.unstyled}
            side={props.side ? props.side : 'bottom'}
            sideOffset={props.sideOffset}
          >
            {props.content}
          </TooltipContent>
        </Tooltip.Portal>
      </Tooltip.Root>
    </Tooltip.Provider>
  )
}

const slideUpAndFade = keyframes({
  '0%': { opacity: 0, transform: 'translateY(2px)' },
  '100%': { opacity: 1, transform: 'translateY(0)' },
})

const slideRightAndFade = keyframes({
  '0%': { opacity: 0, transform: 'translateX(-2px)' },
  '100%': { opacity: 1, transform: 'translateX(0)' },
})

const slideDownAndFade = keyframes({
  '0%': { opacity: 0, transform: 'translateY(-2px)' },
  '100%': { opacity: 1, transform: 'translateY(0)' },
})

const slideLeftAndFade = keyframes({
  '0%': { opacity: 0, transform: 'translateX(2px)' },
  '100%': { opacity: 1, transform: 'translateX(0)' },
})

const closeAndFade = keyframes({
  '0%': { opacity: 1 },
  '100%': { opacity: 0 },
})

const TooltipContent = styled(Tooltip.Content, {
  variants: {
    slateBlack: {
      true: {
        backgroundColor: ' #0d0d0d',
        color: 'white',
      },
    },
    unstyled: {
      true: {
        padding: 0,
        backgroundColor: 'transparent',
        boxShadow: 'none',
        borderRadius: 0,
        fontSize: 'inherit',
        lineHeight: 'inherit',
        color: 'inherit',
      },
    },
  },

  borderRadius: 4,
  padding: '5px 10px',
  fontSize: 12,
  lineHeight: 1,
  color: 'black',
  backgroundColor: 'rgba(217, 217, 217, 0.50)',
  zIndex: 500,
  boxShadow:
    'hsl(206 22% 7% / 35%) 0px 10px 38px -10px, hsl(206 22% 7% / 20%) 0px 10px 20px -15px',
  userSelect: 'none',
  animationDuration: '400ms',
  animationTimingFunction: 'cubic-bezier(0.16, 1, 0.3, 1)',
  willChange: 'transform, opacity',
  '&[data-state="delayed-open"]': {
    '&[data-side="top"]': { animationName: slideDownAndFade },
    '&[data-side="right"]': { animationName: slideLeftAndFade },
    '&[data-side="bottom"]': { animationName: slideUpAndFade },
    '&[data-side="left"]': { animationName: slideRightAndFade },
  },

  // closing animation
  '&[data-state="closed"]': {
    '&[data-side="top"]': { animationName: closeAndFade },
    '&[data-side="right"]': { animationName: closeAndFade },
    '&[data-side="bottom"]': { animationName: closeAndFade },
    '&[data-side="left"]': { animationName: closeAndFade },
  },
})

export default ToolTip



================================================
FILE: apps/web/components/Objects/StyledElements/Wrappers/GeneralWrapper.tsx
================================================
function GeneralWrapperStyled({ children }: { children: React.ReactNode }) {
  return (
    <div className="max-w-(--breakpoint-2xl) mx-auto px-4 sm:px-6 lg:px-8 py-5 tracking-tight z-50">
      {children}
    </div>
  )
}

export default GeneralWrapperStyled


================================================
FILE: apps/web/components/Objects/Thumbnails/CollectionThumbnail.tsx
================================================
'use client'
import { useOrg } from '@components/Contexts/OrgContext'
import AuthenticatedClientElement from '@components/Security/AuthenticatedClientElement'
import ConfirmationModal from '@components/Objects/StyledElements/ConfirmationModal/ConfirmationModal'
import { getUriWithOrg } from '@services/config/config'
import { deleteCollection } from '@services/courses/collections'
import { getCourseThumbnailMediaDirectory } from '@services/media/media'
import { revalidateTags } from '@services/utils/ts/requests'
import { X } from 'lucide-react'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import Link from 'next/link'
import { useRouter } from 'next/navigation'
import React from 'react'

type PropsType = {
  collection: any
  orgslug: string
  org_id: string
}

const removeCollectionPrefix = (collectionid: string) => {
  return collectionid.replace('collection_', '')
}

function CollectionThumbnail(props: PropsType) {
  const org = useOrg() as any
  return (
    <div className="group relative overflow-hidden rounded-xl shadow-lg transition-all duration-300 hover:shadow-xl">
      <div className="flex h-full w-full items-center justify-between bg-indigo-600 p-4">
        <div className="flex items-center space-x-5">
          <div className="flex -space-x-3">
            {props.collection.courses.slice(0, 3).map((course: any, index: number) => (
              <div
                key={course.course_uuid}
                className="relative h-12 w-12 overflow-hidden rounded-full border-2 border-white shadow-md transition-all duration-300 hover:z-10 hover:scale-110"
                style={{
                  backgroundImage: `url(${getCourseThumbnailMediaDirectory(
                    org?.org_uuid,
                    course.course_uuid,
                    course.thumbnail_image
                  )})`,
                  backgroundSize: 'cover',
                  backgroundPosition: 'center',
                  zIndex: 3 - index,
                }}
              ></div>
            ))}
          </div>
          <div className="flex flex-col">
            <Link
              href={getUriWithOrg(
                props.orgslug,
                '/collection/' + removeCollectionPrefix(props.collection.collection_uuid)
              )}
              className="text-2xl font-bold text-white hover:underline"
            >
              {props.collection.name}
            </Link>
            <span className="mt-1 text-sm font-medium text-indigo-200">
              {props.collection.courses.length} course{props.collection.courses.length !== 1 ? 's' : ''}
            </span>
          </div>
        </div>
        <CollectionAdminEditsArea
          orgslug={props.orgslug}
          org_id={props.org_id}
          collection_uuid={props.collection.collection_uuid}
          collection={props.collection}
        />
      </div>
    </div>
  )
}

const CollectionAdminEditsArea = (props: any) => {
  const router = useRouter()
  const session = useLHSession() as any;

  const deleteCollectionUI = async (collectionId: number) => {
    await deleteCollection(collectionId, session.data?.tokens?.access_token)
    await revalidateTags(['collections'], props.orgslug)
    // reload the page
    router.refresh()
  }

  return (
    <AuthenticatedClientElement
      action="delete"
      ressourceType="collections"
      orgId={props.org_id}
      checkMethod="roles"
    >
      <div className="z-20">
        <ConfirmationModal
          confirmationMessage="Are you sure you want to delete this collection?"
          confirmationButtonText="Delete Collection"
          dialogTitle={'Delete ' + props.collection.name + '?'}
          dialogTrigger={
            <button
              className="absolute right-2 top-2 rounded-full bg-red-500 p-2 text-white transition-colors duration-300 hover:bg-red-600"
              rel="noopener noreferrer"
            >
              <X size={18} />
            </button>
          }
          functionToExecute={() => deleteCollectionUI(props.collection_uuid)}
          status="warning"
        ></ConfirmationModal>
      </div>
    </AuthenticatedClientElement>
  )
}

export default CollectionThumbnail



================================================
FILE: apps/web/components/Objects/Thumbnails/CourseThumbnail.tsx
================================================
'use client'
import { useOrg } from '@components/Contexts/OrgContext'
import AuthenticatedClientElement from '@components/Security/AuthenticatedClientElement'
import ConfirmationModal from '@components/Objects/StyledElements/ConfirmationModal/ConfirmationModal'
import { getUriWithOrg } from '@services/config/config'
import { deleteCourseFromBackend } from '@services/courses/courses'
import { getCourseThumbnailMediaDirectory, getUserAvatarMediaDirectory } from '@services/media/media'
import { revalidateTags } from '@services/utils/ts/requests'
import { BookMinus, FilePenLine, Settings2, MoreVertical } from 'lucide-react'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import Link from 'next/link'
import { useRouter } from 'next/navigation'
import React from 'react'
import toast from 'react-hot-toast'
import UserAvatar from '@components/Objects/UserAvatar'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@components/ui/dropdown-menu"

type Course = {
  course_uuid: string
  name: string
  description: string
  thumbnail_image: string
  org_id: string
  update_date: string
  authors?: Array<{
    user: {
      id: string
      user_uuid: string
      avatar_image: string
      first_name: string
      last_name: string
      username: string
    }
    authorship: 'CREATOR' | 'CONTRIBUTOR' | 'MAINTAINER' | 'REPORTER'
    authorship_status: 'ACTIVE' | 'INACTIVE' | 'PENDING'
  }>
}

type PropsType = {
  course: Course
  orgslug: string
  customLink?: string
}

export const removeCoursePrefix = (course_uuid: string) => course_uuid.replace('course_', '')

function CourseThumbnail({ course, orgslug, customLink }: PropsType) {
  const router = useRouter() 
  const org = useOrg() as any
  const session = useLHSession() as any

  const activeAuthors = course.authors?.filter(author => author.authorship_status === 'ACTIVE') || []
  const displayedAuthors = activeAuthors.slice(0, 3)
  const hasMoreAuthors = activeAuthors.length > 3
  const remainingAuthorsCount = activeAuthors.length - 3

  const deleteCourse = async () => {
    const toastId = toast.loading('Deleting course...')
    try {
      await deleteCourseFromBackend(course.course_uuid, session.data?.tokens?.access_token)
      await revalidateTags(['courses'], orgslug)
      toast.success('Course deleted successfully')
      router.refresh()
    } catch (error) {
      toast.error('Failed to delete course')
    } finally {
      toast.dismiss(toastId)
    }
  }

  const thumbnailImage = course.thumbnail_image
    ? getCourseThumbnailMediaDirectory(org?.org_uuid, course.course_uuid, course.thumbnail_image)
    : '../empty_thumbnail.png'

  return (
    <div className="relative flex flex-col bg-white rounded-xl nice-shadow overflow-hidden min-w-[280px] w-full max-w-sm shrink-0">
      <AdminEditOptions
        course={course}
        orgSlug={orgslug}
        deleteCourse={deleteCourse}
      />
      <Link prefetch href={customLink ? customLink : getUriWithOrg(orgslug, `/course/${removeCoursePrefix(course.course_uuid)}`)}>
        <div
          className="inset-0 ring-1 ring-inset ring-black/10 rounded-t-xl w-full aspect-video bg-cover bg-center"
          style={{ backgroundImage: `url(${thumbnailImage})` }}
        />
      </Link>
      <div className='flex flex-col w-full p-4 space-y-3'>
        <div className="space-y-2">
          <h2 className="font-bold text-gray-800 leading-tight text-base min-h-[2.75rem] line-clamp-2">{course.name}</h2>
          <p className='text-xs text-gray-700 leading-normal min-h-[3.75rem] line-clamp-3'>{course.description}</p>
        </div>
        
        <div className="flex flex-wrap items-center justify-between gap-2">
          {course.update_date && (
            <div className="inline-flex h-5 min-w-[140px] items-center justify-center px-2 rounded-md bg-gray-100/80 border border-gray-200">
              <span className="text-[10px] font-medium text-gray-600 truncate">
                Updated {new Date(course.update_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
              </span>
            </div>
          )}
          
          {displayedAuthors.length > 0 && (
            <div className="flex -space-x-4 items-center">
              {displayedAuthors.map((author, index) => (
                <div 
                  key={author.user.user_uuid} 
                  className="relative"
                  style={{ zIndex: displayedAuthors.length - index }}
                >
                  <UserAvatar
                    border="border-2"
                    rounded="rounded-full"
                    avatar_url={author.user.avatar_image ? getUserAvatarMediaDirectory(author.user.user_uuid, author.user.avatar_image) : ''}
                    predefined_avatar={author.user.avatar_image ? undefined : 'empty'}
                    width={32}
                    showProfilePopup={true}
                    userId={author.user.id}
                  />
                </div>
              ))}
              {hasMoreAuthors && (
                <div 
                  className="relative -ml-1"
                  style={{ zIndex: 0 }}
                >
                  <div className="flex items-center justify-center w-[32px] h-[32px] text-[11px] font-medium text-gray-600 bg-gray-100 border-2 border-white rounded-full">
                    +{remainingAuthorsCount}
                  </div>
                </div>
              )}
            </div>
          )}
        </div>

        <Link 
          prefetch 
          href={customLink ? customLink : getUriWithOrg(orgslug, `/course/${removeCoursePrefix(course.course_uuid)}`)}
          className="inline-flex items-center justify-center w-full px-3 py-1.5 bg-black text-white text-xs font-medium rounded-lg hover:bg-gray-800 transition-colors"
        >
          Start Learning
        </Link>
      </div>
    </div>
  )
}

const AdminEditOptions = ({ course, orgSlug, deleteCourse }: {
  course: Course
  orgSlug: string
  deleteCourse: () => Promise<void>
}) => {
  return (
    <AuthenticatedClientElement
      action="update"
      ressourceType="courses"
      checkMethod="roles"
      orgId={course.org_id}
    >
      <div className="absolute top-2 right-2 z-20">
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <button className="p-1 bg-white rounded-full hover:bg-gray-100 transition-colors shadow-md">
              <MoreVertical size={20} className="text-gray-700" />
            </button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end" className="w-56">
            <DropdownMenuItem asChild>
              <Link prefetch href={getUriWithOrg(orgSlug, `/dash/courses/course/${removeCoursePrefix(course.course_uuid)}/content`)}>
                <FilePenLine className="mr-2 h-4 w-4" /> Edit Content
              </Link>
            </DropdownMenuItem>
            <DropdownMenuItem asChild>
              <Link prefetch href={getUriWithOrg(orgSlug, `/dash/courses/course/${removeCoursePrefix(course.course_uuid)}/general`)}>
                <Settings2 className="mr-2 h-4 w-4" /> Settings
              </Link>
            </DropdownMenuItem>
            <DropdownMenuItem asChild>
              <ConfirmationModal
                confirmationButtonText="Delete Course"
                confirmationMessage="Are you sure you want to delete this course?"
                dialogTitle={`Delete ${course.name}?`}
                dialogTrigger={
                  <button className="w-full text-left flex items-center px-2 py-1 rounded-md text-sm bg-rose-500/10 hover:bg-rose-500/20 transition-colors text-red-600">
                    <BookMinus className="mr-4 h-4 w-4" /> Delete Course
                  </button>
                }
                functionToExecute={deleteCourse}
                status="warning"
              />
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      </div>
    </AuthenticatedClientElement>
  )
}

export default CourseThumbnail



================================================
FILE: apps/web/components/Objects/Thumbnails/CourseThumbnailLanding.tsx
================================================
'use client'
import { useOrg } from '@components/Contexts/OrgContext'
import AuthenticatedClientElement from '@components/Security/AuthenticatedClientElement'
import ConfirmationModal from '@components/Objects/StyledElements/ConfirmationModal/ConfirmationModal'
import { getUriWithOrg } from '@services/config/config'
import { deleteCourseFromBackend } from '@services/courses/courses'
import { getCourseThumbnailMediaDirectory, getUserAvatarMediaDirectory } from '@services/media/media'
import { revalidateTags } from '@services/utils/ts/requests'
import { BookMinus, FilePenLine, Settings2, MoreVertical } from 'lucide-react'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import Link from 'next/link'
import { useRouter } from 'next/navigation'
import React from 'react'
import toast from 'react-hot-toast'
import UserAvatar from '@components/Objects/UserAvatar'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@components/ui/dropdown-menu"

type Course = {
  course_uuid: string
  name: string
  description: string
  thumbnail_image: string
  org_id: string
  update_date: string
  authors?: Array<{
    user: {
      id: string
      user_uuid: string
      avatar_image: string
      first_name: string
      last_name: string
      username: string
    }
    authorship: 'CREATOR' | 'CONTRIBUTOR' | 'MAINTAINER' | 'REPORTER'
    authorship_status: 'ACTIVE' | 'INACTIVE' | 'PENDING'
  }>
}

type PropsType = {
  course: Course
  orgslug: string
  customLink?: string
}

interface AdminEditOptionsProps {
  course: Course
  orgslug: string
  deleteCourse: () => Promise<void>
}

export const removeCoursePrefix = (course_uuid: string) => course_uuid.replace('course_', '')

const AdminEditOptions: React.FC<AdminEditOptionsProps> = ({ course, orgslug, deleteCourse }) => {
  return (
    <AuthenticatedClientElement
      action="update"
      ressourceType="courses"
      checkMethod="roles"
      orgId={course.org_id}
    >
      <div className="absolute top-2 right-2 z-20">
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <button className="p-1 bg-white rounded-full hover:bg-gray-100 transition-colors shadow-md">
              <MoreVertical size={20} className="text-gray-700" />
            </button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end" className="w-56">
            <DropdownMenuItem asChild>
              <Link prefetch href={getUriWithOrg(orgslug, `/dash/courses/course/${removeCoursePrefix(course.course_uuid)}/content`)}>
                <FilePenLine className="mr-2 h-4 w-4" /> Edit Content
              </Link>
            </DropdownMenuItem>
            <DropdownMenuItem asChild>
              <Link prefetch href={getUriWithOrg(orgslug, `/dash/courses/course/${removeCoursePrefix(course.course_uuid)}/general`)}>
                <Settings2 className="mr-2 h-4 w-4" /> Settings
              </Link>
            </DropdownMenuItem>
            <DropdownMenuItem asChild>
              <ConfirmationModal
                confirmationButtonText="Delete Course"
                confirmationMessage="Are you sure you want to delete this course?"
                dialogTitle={`Delete ${course.name}?`}
                dialogTrigger={
                  <button className="w-full text-left flex items-center px-2 py-1 rounded-md text-sm bg-rose-500/10 hover:bg-rose-500/20 transition-colors text-red-600">
                    <BookMinus className="mr-4 h-4 w-4" /> Delete Course
                  </button>
                }
                functionToExecute={deleteCourse}
                status="warning"
              />
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      </div>
    </AuthenticatedClientElement>
  )
}

const CourseThumbnailLanding: React.FC<PropsType> = ({ course, orgslug, customLink }) => {
  const router = useRouter() 
  const org = useOrg() as any
  const session = useLHSession() as any

  const activeAuthors = course.authors?.filter(author => author.authorship_status === 'ACTIVE') || []
  const displayedAuthors = activeAuthors.slice(0, 3)
  const hasMoreAuthors = activeAuthors.length > 3
  const remainingAuthorsCount = activeAuthors.length - 3

  const deleteCourse = async () => {
    const toastId = toast.loading('Deleting course...')
    try {
      await deleteCourseFromBackend(course.course_uuid, session.data?.tokens?.access_token)
      await revalidateTags(['courses'], orgslug)
      toast.success('Course deleted successfully')
      router.refresh()
    } catch (error) {
      toast.error('Failed to delete course')
    } finally {
      toast.dismiss(toastId)
    }
  }

  const thumbnailImage = course.thumbnail_image
    ? getCourseThumbnailMediaDirectory(org?.org_uuid, course.course_uuid, course.thumbnail_image)
    : '../empty_thumbnail.png'

  return (
    <div className="relative flex flex-col bg-white rounded-xl nice-shadow overflow-hidden min-w-[280px] w-full max-w-sm shrink-0 m-2">
      <AdminEditOptions
        course={course}
        orgslug={orgslug}
        deleteCourse={deleteCourse}
      />
      <Link prefetch href={customLink ? customLink : getUriWithOrg(orgslug, `/course/${removeCoursePrefix(course.course_uuid)}`)}>
        <div
          className="inset-0 ring-1 ring-inset ring-black/10 rounded-t-xl w-full aspect-video bg-cover bg-center"
          style={{ backgroundImage: `url(${thumbnailImage})` }}
        />
      </Link>
      <div className='flex flex-col w-full p-4 space-y-3'>
        <div className="space-y-2">
          <h2 className="font-bold text-gray-800 leading-tight text-base min-h-[2.75rem] line-clamp-2">{course.name}</h2>
          <p className='text-xs text-gray-700 leading-normal min-h-[3.75rem] line-clamp-3'>{course.description}</p>
        </div>
        
        <div className="flex flex-wrap items-center justify-between gap-2">
          {course.update_date && (
            <div className="inline-flex h-5 min-w-[140px] items-center justify-center px-2 rounded-md bg-gray-100/80 border border-gray-200">
              <span className="text-[10px] font-medium text-gray-600 truncate">
                Updated {new Date(course.update_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
              </span>
            </div>
          )}
          
          {displayedAuthors.length > 0 && (
            <div className="flex -space-x-4 items-center">
              {displayedAuthors.map((author, index) => (
                <div 
                  key={author.user.user_uuid} 
                  className="relative"
                  style={{ zIndex: displayedAuthors.length - index }}
                >
                  <UserAvatar
                    border="border-2"
                    rounded="rounded-full"
                    avatar_url={author.user.avatar_image ? getUserAvatarMediaDirectory(author.user.user_uuid, author.user.avatar_image) : ''}
                    predefined_avatar={author.user.avatar_image ? undefined : 'empty'}
                    width={32}
                    showProfilePopup={true}
                    userId={author.user.id}
                  />
                </div>
              ))}
              {hasMoreAuthors && (
                <div 
                  className="relative -ml-1"
                  style={{ zIndex: 0 }}
                >
                  <div className="flex items-center justify-center w-[32px] h-[32px] text-[11px] font-medium text-gray-600 bg-gray-100 border-2 border-white rounded-full">
                    +{remainingAuthorsCount}
                  </div>
                </div>
              )}
            </div>
          )}
        </div>

        <Link 
          prefetch 
          href={customLink ? customLink : getUriWithOrg(orgslug, `/course/${removeCoursePrefix(course.course_uuid)}`)}
          className="inline-flex items-center justify-center w-full px-3 py-1.5 bg-black text-white text-xs font-medium rounded-lg hover:bg-gray-800 transition-colors"
        >
          Start Learning
        </Link>
      </div>
    </div>
  )
}

export default CourseThumbnailLanding



================================================
FILE: apps/web/components/OrgScripts/OrgScripts.tsx
================================================
'use client'

import React, { useEffect } from 'react'
import { useOrg } from '@/components/Contexts/OrgContext'
import DOMPurify from 'dompurify'

const OrgScripts: React.FC = () => {
  const org = useOrg() as any

  // Function to cleanup existing scripts
  const cleanupExistingScript = (scriptId: string) => {
    const existingScript = document.getElementById(scriptId)
    if (existingScript) {
      const parent = existingScript.parentNode
      if (parent) {
        let node = existingScript.previousSibling
        while (node && node.nodeType === Node.COMMENT_NODE) {
          const prevNode = node.previousSibling
          parent.removeChild(node)
          node = prevNode
        }
        node = existingScript.nextSibling
        while (node && node.nodeType === Node.COMMENT_NODE) {
          const nextNode = node.nextSibling
          parent.removeChild(node)
          node = nextNode
        }
        parent.removeChild(existingScript)
      }
    }
  }

  // Function to check if script is already loaded
  const isScriptLoaded = (scriptName: string): boolean => {
    const scripts = document.querySelectorAll(`script[data-script-name="${scriptName}"]`)
    return scripts.length > 0
  }

  // Function to sanitize script content using DOMPurify
  const sanitizeScriptContent = (content: string): string => {
    if (typeof window === 'undefined') {
      return content;
    }

    DOMPurify.addHook('afterSanitizeAttributes', function(node) {
      if (node.nodeName === 'SCRIPT') {
        node.setAttribute('type', 'text/javascript');
      }
    });

    const purifyConfig = {
      ALLOWED_TAGS: ['script'],
      ALLOWED_ATTR: [
        'src', 'async', 'defer', 'crossorigin', 
        'integrity', 'type', 'nonce', 'id',
        'data-*', 'referrerpolicy'
      ],
      ADD_TAGS: ['script'],
      WHOLE_DOCUMENT: false,
      RETURN_DOM: false,
      RETURN_DOM_FRAGMENT: false,
      FORCE_BODY: true
    }

    if (content.trim().toLowerCase().startsWith('<script')) {
      return DOMPurify.sanitize(content, purifyConfig)
    } else {
      return DOMPurify.sanitize(content, {
        ALLOWED_TAGS: [],
        ALLOWED_ATTR: [],
        WHOLE_DOCUMENT: false
      })
    }
  }

  // Function to safely load and execute a script
  const loadScript = (scriptContent: string, scriptName: string) => {
    try {
      if (isScriptLoaded(scriptName) || !scriptContent.trim()) {
        return
      }

      const safeScriptId = `learnhouse-org-script-${scriptName.toLowerCase().replace(/[^a-z0-9]+/g, '-')}-${Math.random().toString(36).substr(2, 9)}`

      cleanupExistingScript(safeScriptId)

      if (scriptContent.trim().toLowerCase().startsWith('<script')) {
        const sanitizedHtml = sanitizeScriptContent(scriptContent.trim())
        const div = document.createElement('div')
        div.innerHTML = sanitizedHtml
        const scriptTag = div.querySelector('script')

        if (!scriptTag) {
          return
        }

        const scriptElement = document.createElement('script')
        Array.from(scriptTag.attributes).forEach(attr => {
          scriptElement.setAttribute(attr.name, attr.value)
        })

        if (scriptTag.src) {
          try {
            new URL(scriptTag.src)
            scriptElement.async = true
            scriptElement.onload = () => {
              scriptElement.dataset.loaded = 'true'
            }
            scriptElement.onerror = (error) => {
              console.error(`Failed to load external script "${scriptName}":`, error)
              cleanupExistingScript(safeScriptId)
            }
          } catch (error) {
            console.error(`Invalid script URL in "${scriptName}":`, error)
            return
          }
        } else {
          const sanitizedContent = sanitizeScriptContent(scriptTag.textContent || '')
          scriptElement.textContent = `
            /* LearnHouse Organization Script - ${scriptName} */
            try {
              (function() {
                'use strict';
                ${sanitizedContent}
              })();
            } catch (error) {
              console.error("Script error in ${scriptName}:", error);
            }
          `
        }

        scriptElement.id = safeScriptId
        scriptElement.dataset.scriptName = scriptName
        scriptElement.dataset.loadTime = new Date().toISOString()
        scriptElement.dataset.type = scriptTag.src ? 'external' : 'inline'
        scriptElement.dataset.orgId = org?.id
        scriptElement.dataset.orgSlug = org?.slug

        const comment = document.createComment(` LearnHouse Organization Script - ${scriptName} (${safeScriptId}) `)
        document.body.appendChild(comment)
        document.body.appendChild(scriptElement)
      } else {
        const scriptElement = document.createElement('script')
        scriptElement.type = 'text/javascript'
        
        const sanitizedContent = sanitizeScriptContent(scriptContent)
        scriptElement.textContent = `
          /* LearnHouse Organization Script - ${scriptName} */
          try {
            (function() {
              'use strict';
              ${sanitizedContent}
            })();
          } catch (error) {
            console.error("Script error in ${scriptName}:", error)
          }
        `
        
        scriptElement.id = safeScriptId
        scriptElement.dataset.scriptName = scriptName
        scriptElement.dataset.loadTime = new Date().toISOString()
        scriptElement.dataset.type = 'raw'
        scriptElement.dataset.orgId = org?.id
        scriptElement.dataset.orgSlug = org?.slug

        const comment = document.createComment(` LearnHouse Organization Script - ${scriptName} (${safeScriptId}) `)
        document.body.appendChild(comment)
        document.body.appendChild(scriptElement)
      }
    } catch (error) {
      console.error(`Failed to load script ${scriptName}:`, error)
    }
  }

  useEffect(() => {
    if (!org || !org?.scripts?.scripts || !Array.isArray(org.scripts.scripts)) {
      return
    }

    const loadedScripts = new Map()
    
    org.scripts.scripts.forEach((script: { content: string, name: string }, index: number) => {
      const scriptName = script.name || `Script ${index + 1}`
      
      if (!loadedScripts.has(scriptName) && script.content) {
        loadedScripts.set(scriptName, true)
        loadScript(script.content, scriptName)
      }
    })

    return () => {
      const scripts = document.querySelectorAll('script[id^="learnhouse-org-script-"]')
      scripts.forEach(script => {
        cleanupExistingScript(script.id)
      })
    }
  }, [org])

  return null
}

export default OrgScripts 


================================================
FILE: apps/web/components/Pages/Activity/ActivityBreadcrumbs.tsx
================================================
import { Book, ChevronRight } from 'lucide-react'
import Link from 'next/link'
import { getUriWithOrg } from '@services/config/config'
import React from 'react'

interface ActivityBreadcrumbsProps {
  course: any
  activity: any
  orgslug: string
}

export default function ActivityBreadcrumbs({ course, activity, orgslug }: ActivityBreadcrumbsProps) {
  const cleanCourseUuid = course.course_uuid?.replace('course_', '')

  return (
    <div className="text-gray-400 tracking-tight font-medium text-sm flex space-x-1 mb-4">
      <div className="flex items-center space-x-1">
        <div className="flex space-x-2 items-center">
          <Book className="text-gray" size={14} />
          <Link href={getUriWithOrg(orgslug, '') + `/courses`}>
            Courses
          </Link>
        </div>
        <ChevronRight size={14} />
        <Link href={getUriWithOrg(orgslug, '') + `/course/${cleanCourseUuid}`}>
          {course.name}
        </Link>
        <ChevronRight size={14} />
        <div className="first-letter:uppercase">
          {activity.name}
        </div>
      </div>
    </div>
  )
} 


================================================
FILE: apps/web/components/Pages/Activity/ActivityChapterDropdown.tsx
================================================
'use client'
import { useMediaQuery } from 'usehooks-ts'
import { Check, FileText, ListTree, Video, X, StickyNote, Backpack, ArrowRight } from 'lucide-react'
import { getUriWithOrg } from '@services/config/config'
import Link from 'next/link'
import React from 'react'

interface ActivityChapterDropdownProps {
  course: any
  currentActivityId: string
  orgslug: string
  trailData?: any
}

export default function ActivityChapterDropdown(props: ActivityChapterDropdownProps): React.ReactNode {
  const [isOpen, setIsOpen] = React.useState(false);
  const dropdownRef = React.useRef<HTMLDivElement>(null);
  const isMobile = useMediaQuery('(max-width: 768px)');

  // Clean up course UUID by removing 'course_' prefix if it exists
  const cleanCourseUuid = props.course.course_uuid?.replace('course_', '');

  // Close dropdown when clicking outside
  React.useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setIsOpen(false);
      }
    }
    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, []);

  const toggleDropdown = () => {
    setIsOpen(!isOpen);
  };

  // Function to get the appropriate icon for activity type
  const getActivityTypeIcon = (activityType: string) => {
    switch (activityType) {
      case 'TYPE_VIDEO':
        return <Video size={10} />;
      case 'TYPE_DOCUMENT':
        return <FileText size={10} />;
      case 'TYPE_DYNAMIC':
        return <StickyNote size={10} />;
      case 'TYPE_ASSIGNMENT':
        return <Backpack size={10} />;
      default:
        return <FileText size={10} />;
    }
  };

  const getActivityTypeLabel = (activityType: string) => {
    switch (activityType) {
      case 'TYPE_VIDEO':
        return 'Video';
      case 'TYPE_DOCUMENT':
        return 'Document';
      case 'TYPE_DYNAMIC':
        return 'Page';
      case 'TYPE_ASSIGNMENT':
        return 'Assignment';
      default:
        return 'Learning Material';
    }
  };

  return (
    <div className="relative" ref={dropdownRef}>
      <button
        onClick={toggleDropdown}
        className="bg-white rounded-full px-5 nice-shadow flex items-center space-x-2 p-2.5 text-gray-700 hover:bg-gray-50 transition delay-150 duration-300 ease-in-out"
        aria-label="View all activities"
        title="View all activities"
      >
        <ListTree size={17} />
        <span className="text-xs font-bold">Chapters</span>
      </button>
      
      {isOpen && (
        <div className={`absolute z-50 mt-2 ${isMobile ? 'right-0 w-[90vw] sm:w-72' : 'right-0 w-72'} max-h-[70vh] cursor-pointer overflow-y-auto bg-white rounded-lg shadow-xl border border-gray-200 py-1 animate-in fade-in duration-200`}>
          <div className="px-3 py-1.5 border-b border-gray-100 flex justify-between items-center">
            <h3 className="text-sm font-semibold text-gray-800">Course Content</h3>
            <button 
              onClick={() => setIsOpen(false)}
              className="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-100 cursor-pointer"
            >
              <X size={14} />
            </button>
          </div>
          
          <div className="py-0.5">
            {props.course.chapters.map((chapter: any, index: number) => (
              <div key={chapter.id} className="mb-1">
                <div className="px-3 py-1.5 text-sm font-medium text-gray-600 bg-gray-50 border-y border-gray-100 flex items-center">
                  <div className="flex items-center space-x-1.5">
                    <div className="bg-gray-500 text-white text-[10px] font-bold rounded-full w-4 h-4 flex items-center justify-center">
                      {index + 1}
                    </div>
                    <span>{chapter.name}</span>
                  </div>
                </div>
                <div className="py-0.5">
                  {chapter.activities.map((activity: any) => {
                    const cleanActivityUuid = activity.activity_uuid?.replace('activity_', '');
                    const isCurrent = cleanActivityUuid === props.currentActivityId.replace('activity_', '');
                    
                    // Find the correct run and check if activity is complete
                    const run = props.trailData?.runs?.find(
                      (run: any) => {
                        const cleanRunCourseUuid = run.course?.course_uuid?.replace('course_', '');
                        return cleanRunCourseUuid === cleanCourseUuid;
                      }
                    );
                    
                    const isComplete = run?.steps?.find(
                      (step: any) => step.activity_id === activity.id && step.complete === true
                    );
                    
                    return (
                      <Link
                        key={activity.id}
                        href={getUriWithOrg(props.orgslug, '') + `/course/${cleanCourseUuid}/activity/${cleanActivityUuid}`}
                        prefetch={false}
                        onClick={() => setIsOpen(false)}
                      >
                        <div 
                          className={`group hover:bg-neutral-50 transition-colors px-3 py-2 ${
                            isCurrent ? 'bg-neutral-50 border-l-2 border-neutral-300 pl-2.5 font-medium' : ''
                          }`}
                        >
                          <div className="flex space-x-2 items-center">
                            <div className="flex items-center">
                              {isComplete ? (
                                <div className="relative cursor-pointer">
                                  <Check size={14} className="stroke-[2.5] text-teal-600" />
                                </div>
                              ) : (
                                <div className="text-neutral-300 cursor-pointer">
                                  <Check size={14} className="stroke-[2]" />
                                </div>
                              )}
                            </div>
                            <div className="flex flex-col grow">
                              <div className="flex items-center space-x-1.5 w-full">
                                <p className="text-sm font-medium text-neutral-600 group-hover:text-neutral-800 transition-colors">
                                  {activity.name}
                                </p>
                                {isCurrent && (
                                  <div className="flex items-center space-x-1 text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded-full text-[10px] font-medium animate-pulse">
                                    <span>Current</span>
                                  </div>
                                )}
                              </div>
                              <div className="flex items-center space-x-1 mt-0.5 text-neutral-400">
                                {getActivityTypeIcon(activity.activity_type)}
                                <span className="text-[10px] font-medium">
                                  {getActivityTypeLabel(activity.activity_type)}
                                </span>
                              </div>
                            </div>
                            <div className="text-neutral-300 group-hover:text-neutral-400 transition-colors cursor-pointer">
                              <ArrowRight size={12} />
                            </div>
                          </div>
                        </div>
                      </Link>
                    );
                  })}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
} 


================================================
FILE: apps/web/components/Pages/Activity/ActivityNavigation.tsx
================================================
'use client'
import { useRouter } from 'next/navigation'
import { useMediaQuery } from 'usehooks-ts'
import { ChevronLeft, ChevronRight } from 'lucide-react'
import { getUriWithOrg } from '@services/config/config'
import React from 'react'

interface ActivityNavigationProps {
  course: any
  currentActivityId: string
  orgslug: string
}

export default function ActivityNavigation(props: ActivityNavigationProps): React.ReactNode {
  const router = useRouter();
  const isMobile = useMediaQuery('(max-width: 768px)');
  const [isBottomNavVisible, setIsBottomNavVisible] = React.useState(true);
  const bottomNavRef = React.useRef<HTMLDivElement>(null);
  const [navWidth, setNavWidth] = React.useState<number | null>(null);
  
  // Function to find the current activity's position in the course
  const findActivityPosition = () => {
    let allActivities: any[] = [];
    let currentIndex = -1;
    
    // Flatten all activities from all chapters
    props.course.chapters.forEach((chapter: any) => {
      chapter.activities.forEach((activity: any) => {
        const cleanActivityUuid = activity.activity_uuid?.replace('activity_', '');
        allActivities.push({
          ...activity,
          cleanUuid: cleanActivityUuid,
          chapterName: chapter.name
        });
        
        // Check if this is the current activity
        if (cleanActivityUuid === props.currentActivityId.replace('activity_', '')) {
          currentIndex = allActivities.length - 1;
        }
      });
    });
    
    return { allActivities, currentIndex };
  };
  
  const { allActivities, currentIndex } = findActivityPosition();
  
  // Get previous and next activities
  const prevActivity = currentIndex > 0 ? allActivities[currentIndex - 1] : null;
  const nextActivity = currentIndex < allActivities.length - 1 ? allActivities[currentIndex + 1] : null;
  
  // Navigate to an activity
  const navigateToActivity = (activity: any) => {
    if (!activity) return;
    
    const cleanCourseUuid = props.course.course_uuid?.replace('course_', '');
    router.push(getUriWithOrg(props.orgslug, '') + `/course/${cleanCourseUuid}/activity/${activity.cleanUuid}`);
  };

  // Set up intersection observer to detect when bottom nav is out of viewport
  // and measure the width of the bottom navigation
  React.useEffect(() => {
    if (!bottomNavRef.current) return;
    
    // Update width when component mounts and on window resize
    const updateWidth = () => {
      if (bottomNavRef.current) {
        setNavWidth(bottomNavRef.current.offsetWidth);
      }
    };
    
    // Initial width measurement
    updateWidth();
    
    // Set up resize listener
    window.addEventListener('resize', updateWidth);
    
    const observer = new IntersectionObserver(
      ([entry]) => {
        setIsBottomNavVisible(entry.isIntersecting);
      },
      { threshold: 0.1 }
    );
    
    observer.observe(bottomNavRef.current);
    
    return () => {
      window.removeEventListener('resize', updateWidth);
      if (bottomNavRef.current) {
        observer.unobserve(bottomNavRef.current);
      }
    };
  }, []);

  // Navigation buttons component - reused for both top and bottom
  const NavigationButtons = ({ isFloating = false }) => (
    <div className={`${isFloating ? 'flex justify-between' : 'grid grid-cols-3'} items-center w-full`}>
      {isFloating ? (
        // Floating navigation - original flex layout
        <>
          <button
            onClick={() => navigateToActivity(prevActivity)}
            className={`flex items-center space-x-1.5 p-2 rounded-md transition-all duration-200 cursor-pointer ${
              prevActivity 
                ? 'text-gray-700' 
                : 'opacity-50 text-gray-400 cursor-not-allowed'
            }`}
            disabled={!prevActivity}
            title={prevActivity ? `Previous: ${prevActivity.name}` : 'No previous activity'}
          >
            <ChevronLeft size={20} className="text-gray-800 shrink-0" />
            <div className="flex flex-col items-start">
              <span className="text-xs text-gray-500">Previous</span>
              <span className="text-sm capitalize font-semibold text-left">
                {prevActivity ? prevActivity.name : 'No previous activity'}
              </span>
            </div>
          </button>
          
          <button
            onClick={() => navigateToActivity(nextActivity)}
            className={`flex items-center space-x-1.5 p-2 rounded-md transition-all duration-200 cursor-pointer ${
              nextActivity 
                ? 'text-gray-700' 
                : 'opacity-50 text-gray-400 cursor-not-allowed'
            }`}
            disabled={!nextActivity}
            title={nextActivity ? `Next: ${nextActivity.name}` : 'No next activity'}
          >
            <div className="flex flex-col items-end">
              <span className="text-xs text-gray-500">Next</span>
              <span className="text-sm capitalize font-semibold text-right">
                {nextActivity ? nextActivity.name : 'No next activity'}
              </span>
            </div>
            <ChevronRight size={20} className="text-gray-800 shrink-0" />
          </button>
        </>
      ) : (
        // Regular navigation - grid layout with centered counter
        <>
          <div className="justify-self-start">
            <button
              onClick={() => navigateToActivity(prevActivity)}
              className={`flex items-center space-x-1.5 px-3.5 py-2 rounded-md transition-all duration-200 cursor-pointer ${
                prevActivity 
                  ? 'bg-white nice-shadow text-gray-700' 
                  : 'bg-gray-100 text-gray-400 cursor-not-allowed'
              }`}
              disabled={!prevActivity}
              title={prevActivity ? `Previous: ${prevActivity.name}` : 'No previous activity'}
            >
              <ChevronLeft size={16} className="shrink-0" />
              <div className="flex flex-col items-start">
                <span className="text-xs text-gray-500">Previous</span>
                <span className="text-sm capitalize font-semibold text-left">
                  {prevActivity ? prevActivity.name : 'No previous activity'}
                </span>
              </div>
            </button>
          </div>
          
          <div className="text-sm text-gray-500 justify-self-center">
            {currentIndex + 1} of {allActivities.length}
          </div>
          
          <div className="justify-self-end">
            <button
              onClick={() => navigateToActivity(nextActivity)}
              className={`flex items-center space-x-1.5 px-3.5 py-2 rounded-md transition-all duration-200 cursor-pointer ${
                nextActivity 
                  ? 'bg-white nice-shadow text-gray-700' 
                  : 'bg-gray-100 text-gray-400 cursor-not-allowed'
              }`}
              disabled={!nextActivity}
              title={nextActivity ? `Next: ${nextActivity.name}` : 'No next activity'}
            >
              <div className="flex flex-col items-end">
                <span className="text-xs text-gray-500">Next</span>
                <span className="text-sm capitalize font-semibold text-right">
                  {nextActivity ? nextActivity.name : 'No next activity'}
                </span>
              </div>
              <ChevronRight size={16} className="shrink-0" />
            </button>
          </div>
        </>
      )}
    </div>
  );
  
  return (
    <>
      {/* Bottom navigation (in-place) */}
      <div ref={bottomNavRef} className="mt-6 mb-2 w-full">
        <NavigationButtons isFloating={false} />
      </div>
      
      {/* Floating bottom navigation - shown when bottom nav is not visible */}
      {!isBottomNavVisible && (
        <div className="fixed bottom-8 left-1/2 transform -translate-x-1/2 z-50 w-[85%] sm:w-auto sm:min-w-[350px] max-w-lg transition-all duration-300 ease-in-out">
          <div 
            className="bg-white/90 backdrop-blur-xl rounded-full py-1.5 px-2.5 shadow-xs animate-in fade-in slide-in-from-bottom duration-300"
          >
            <NavigationButtons isFloating={true} />
          </div>
        </div>
      )}
    </>
  );
} 


================================================
FILE: apps/web/components/Pages/Activity/CourseEndView.tsx
================================================
import React, { useMemo, useEffect, useState } from 'react';
import ReactConfetti from 'react-confetti';
import { Trophy, ArrowLeft, BookOpen, Target, Download, Shield } from 'lucide-react';
import Link from 'next/link';
import { getUriWithOrg } from '@services/config/config';
import { getCourseThumbnailMediaDirectory } from '@services/media/media';
import { useWindowSize } from 'usehooks-ts';
import { useOrg } from '@components/Contexts/OrgContext';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import { getUserCertificates } from '@services/courses/certifications';
import CertificatePreview from '@components/Dashboard/Pages/Course/EditCourseCertification/CertificatePreview';
import html2canvas from 'html2canvas';
import jsPDF from 'jspdf';
import QRCode from 'qrcode';

interface CourseEndViewProps {
  courseName: string;
  orgslug: string;
  courseUuid: string;
  thumbnailImage: string;
  course: any;
  trailData: any;
}

const CourseEndView: React.FC<CourseEndViewProps> = ({ 
  courseName, 
  orgslug, 
  courseUuid, 
  thumbnailImage, 
  course, 
  trailData 
}) => {
  const { width, height } = useWindowSize();
  const org = useOrg() as any;
  const session = useLHSession() as any;
  const [userCertificate, setUserCertificate] = useState<any>(null);
  const [isLoadingCertificate, setIsLoadingCertificate] = useState(false);
  const [certificateError, setCertificateError] = useState<string | null>(null);
  const qrCodeLink = getUriWithOrg(orgslug, `/certificates/${userCertificate?.certificate_user.user_certification_uuid}/verify`);



  // Check if course is actually completed
  const isCourseCompleted = useMemo(() => {
    if (!trailData || !course) return false;
    
    // Flatten all activities
    const allActivities = course.chapters.flatMap((chapter: any) => 
      chapter.activities.map((activity: any) => ({
        ...activity,
        chapterId: chapter.id
      }))
    );
    
    // Check if all activities are completed
    const isActivityDone = (activity: any) => {
      const cleanCourseUuid = course.course_uuid?.replace('course_', '');
      const run = trailData?.runs?.find(
        (run: any) => {
          const cleanRunCourseUuid = run.course?.course_uuid?.replace('course_', '');
          return cleanRunCourseUuid === cleanCourseUuid;
        }
      );
      
      if (run) {
        return run.steps.find(
          (step: any) => step.activity_id === activity.id && step.complete === true
        );
      }
      return false;
    };
    
    const totalActivities = allActivities.length;
    const completedActivities = allActivities.filter((activity: any) => isActivityDone(activity)).length;
    return totalActivities > 0 && completedActivities === totalActivities;
  }, [trailData, course]);

  // Fetch user certificate when course is completed
  useEffect(() => {
    const fetchUserCertificate = async () => {
      if (!isCourseCompleted) return;
      
      if (!session?.data?.tokens?.access_token) {
        setCertificateError('Authentication required to view certificate');
        return;
      }
      
      setIsLoadingCertificate(true);
      setCertificateError(null);
      try {
        const cleanCourseUuid = courseUuid.replace('course_', '');
        const result = await getUserCertificates(
          `course_${cleanCourseUuid}`,
          session.data.tokens.access_token
        );
        
        if (result.success && result.data && result.data.length > 0) {
          setUserCertificate(result.data[0]);
        } else {
          setCertificateError('No certificate found for this course');
        }
      } catch (error) {
        console.error('Error fetching user certificate:', error);
        setCertificateError('Failed to load certificate. Please try again later.');
      } finally {
        setIsLoadingCertificate(false);
      }
    };

    fetchUserCertificate();
  }, [isCourseCompleted, courseUuid, session?.data?.tokens?.access_token]);

  // Generate PDF using canvas
  const downloadCertificate = async () => {
    if (!userCertificate) return;

    try {
      // Create a temporary div for the certificate
      const certificateDiv = document.createElement('div');
      certificateDiv.style.position = 'absolute';
      certificateDiv.style.left = '-9999px';
      certificateDiv.style.top = '0';
      certificateDiv.style.width = '800px';
      certificateDiv.style.height = '600px';
      certificateDiv.style.background = 'white';
      certificateDiv.style.padding = '40px';
      certificateDiv.style.fontFamily = 'Arial, sans-serif';
      certificateDiv.style.textAlign = 'center';
      certificateDiv.style.display = 'flex';
      certificateDiv.style.flexDirection = 'column';
      certificateDiv.style.justifyContent = 'center';
      certificateDiv.style.alignItems = 'center';
      certificateDiv.style.position = 'relative';
      certificateDiv.style.overflow = 'hidden';

      // Get theme colors based on pattern
      const getPatternTheme = (pattern: string) => {
        switch (pattern) {
          case 'royal':
            return { primary: '#b45309', secondary: '#d97706', icon: '#d97706' };
          case 'tech':
            return { primary: '#0e7490', secondary: '#0891b2', icon: '#0891b2' };
          case 'nature':
            return { primary: '#15803d', secondary: '#16a34a', icon: '#16a34a' };
          case 'geometric':
            return { primary: '#7c3aed', secondary: '#9333ea', icon: '#9333ea' };
          case 'vintage':
            return { primary: '#c2410c', secondary: '#ea580c', icon: '#ea580c' };
          case 'waves':
            return { primary: '#1d4ed8', secondary: '#2563eb', icon: '#2563eb' };
          case 'minimal':
            return { primary: '#374151', secondary: '#4b5563', icon: '#4b5563' };
          case 'professional':
            return { primary: '#334155', secondary: '#475569', icon: '#475569' };
          case 'academic':
            return { primary: '#3730a3', secondary: '#4338ca', icon: '#4338ca' };
          case 'modern':
            return { primary: '#1d4ed8', secondary: '#2563eb', icon: '#2563eb' };
          default:
            return { primary: '#374151', secondary: '#4b5563', icon: '#4b5563' };
        }
      };

      const theme = getPatternTheme(userCertificate.certification.config.certificate_pattern);
      const certificateId = userCertificate.certificate_user.user_certification_uuid;
      const qrCodeData = qrCodeLink;

      // Generate QR code
      const qrCodeDataUrl = await QRCode.toDataURL(qrCodeData, {
        width: 120,
        margin: 2,
        color: {
          dark: '#000000',
          light: '#FFFFFF'
        },
        errorCorrectionLevel: 'M',
        type: 'image/png'
      });

      // Create certificate content
      certificateDiv.innerHTML = `
        <div style="
          position: absolute;
          top: 20px;
          left: 20px;
          font-size: 12px;
          color: ${theme.secondary};
          font-weight: 500;
        ">ID: ${certificateId}</div>
        
        <div style="
          position: absolute;
          top: 20px;
          right: 20px;
          width: 80px;
          height: 80px;
          border: 2px solid ${theme.secondary};
          border-radius: 8px;
          background: white;
          display: flex;
          align-items: center;
          justify-content: center;
        ">
          <img src="${qrCodeDataUrl}" alt="QR Code" style="width: 100%; height: 100%; object-fit: contain;" />
        </div>
        
        <div style="
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          margin-bottom: 30px;
          font-size: 14px;
          color: ${theme.secondary};
          font-weight: 500;
          text-transform: uppercase;
          letter-spacing: 1px;
        ">
          <div style="width: 24px; height: 1px; background: linear-gradient(90deg, transparent, ${theme.secondary}, transparent);"></div>
          Certificate
          <div style="width: 24px; height: 1px; background: linear-gradient(90deg, transparent, ${theme.secondary}, transparent);"></div>
        </div>
        
        <div style="
          width: 80px;
          height: 80px;
          background: linear-gradient(135deg, ${theme.icon}20 0%, ${theme.icon}40 100%);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          margin: 0 auto 30px;
          font-size: 40px;
          line-height: 1;
        ">ğŸ†</div>
        
        <div style="
          font-size: 32px;
          font-weight: bold;
          color: ${theme.primary};
          margin-bottom: 20px;
          line-height: 1.2;
          max-width: 600px;
        ">${userCertificate.certification.config.certification_name}</div>
        
        <div style="
          font-size: 18px;
          color: #6b7280;
          margin-bottom: 30px;
          line-height: 1.5;
          max-width: 500px;
        ">${userCertificate.certification.config.certification_description || 'This is to certify that the course has been successfully completed.'}</div>
        
        <div style="
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 4px;
          margin: 20px 0;
        ">
          <div style="width: 8px; height: 1px; background: ${theme.secondary}; opacity: 0.5;"></div>
          <div style="width: 4px; height: 4px; background: ${theme.primary}; border-radius: 50%; opacity: 0.6;"></div>
          <div style="width: 8px; height: 1px; background: ${theme.secondary}; opacity: 0.5;"></div>
        </div>
        
        <div style="
          display: inline-flex;
          align-items: center;
          gap: 8px;
          font-size: 16px;
          color: ${theme.primary};
          background: ${theme.icon}10;
          padding: 12px 24px;
          border-radius: 20px;
          border: 1px solid ${theme.icon}20;
          font-weight: 500;
          margin-bottom: 30px;
          white-space: nowrap;
        ">
          <span style="font-weight: bold; font-size: 18px;">âœ“</span>
          <span>${userCertificate.certification.config.certification_type === 'completion' ? 'Course Completion' :
            userCertificate.certification.config.certification_type === 'achievement' ? 'Achievement Based' :
            userCertificate.certification.config.certification_type === 'assessment' ? 'Assessment Based' :
            userCertificate.certification.config.certification_type === 'participation' ? 'Participation' :
            userCertificate.certification.config.certification_type === 'mastery' ? 'Skill Mastery' :
            userCertificate.certification.config.certification_type === 'professional' ? 'Professional Development' :
            userCertificate.certification.config.certification_type === 'continuing' ? 'Continuing Education' :
            userCertificate.certification.config.certification_type === 'workshop' ? 'Workshop Attendance' :
            userCertificate.certification.config.certification_type === 'specialization' ? 'Specialization' : 'Course Completion'}</span>
        </div>
        
        <div style="
          margin-top: 30px;
          padding: 24px;
          background: #f8fafc;
          border-radius: 8px;
          border: 1px solid #e2e8f0;
          max-width: 400px;
        ">
          <div style="margin: 8px 0; font-size: 14px; color: #374151;">
            <strong style="color: ${theme.primary};">Certificate ID:</strong> ${certificateId}
          </div>
          <div style="margin: 8px 0; font-size: 14px; color: #374151;">
            <strong style="color: ${theme.primary};">Awarded:</strong> ${new Date(userCertificate.certificate_user.created_at).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
          </div>
          ${userCertificate.certification.config.certificate_instructor ? 
            `<div style="margin: 8px 0; font-size: 14px; color: #374151;">
              <strong style="color: ${theme.primary};">Instructor:</strong> ${userCertificate.certification.config.certificate_instructor}
            </div>` : ''
          }
        </div>
        
        <div style="
          margin-top: 20px;
          font-size: 12px;
          color: #6b7280;
        ">
          This certificate can be verified at ${qrCodeLink}
        </div>
      `;

      // Add to document temporarily
      document.body.appendChild(certificateDiv);

      // Convert to canvas
      const canvas = await html2canvas(certificateDiv, {
        width: 800,
        height: 600,
        scale: 2, // Higher resolution
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff'
      });

      // Remove temporary div
      document.body.removeChild(certificateDiv);

      // Create PDF
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF('landscape', 'mm', 'a4');
      
      // Calculate dimensions to center the certificate
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = pdf.internal.pageSize.getHeight();
      const imgWidth = 280; // mm
      const imgHeight = 210; // mm
      
      // Center the image
      const x = (pdfWidth - imgWidth) / 2;
      const y = (pdfHeight - imgHeight) / 2;
      
      pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
      
      // Save the PDF
      const fileName = `${userCertificate.certification.config.certification_name.replace(/[^a-zA-Z0-9]/g, '_')}_Certificate.pdf`;
      pdf.save(fileName);

    } catch (error) {
      console.error('Error generating PDF:', error);
      alert('Failed to generate PDF. Please try again.');
    }
  };

  // Calculate progress for incomplete courses
  const progressInfo = useMemo(() => {
    if (!trailData || !course || isCourseCompleted) return null;
    
    const allActivities = course.chapters.flatMap((chapter: any) => 
      chapter.activities.map((activity: any) => ({
        ...activity,
        chapterId: chapter.id
      }))
    );
    
    const isActivityDone = (activity: any) => {
      const cleanCourseUuid = course.course_uuid?.replace('course_', '');
      const run = trailData?.runs?.find(
        (run: any) => {
          const cleanRunCourseUuid = run.course?.course_uuid?.replace('course_', '');
          return cleanRunCourseUuid === cleanCourseUuid;
        }
      );
      
      if (run) {
        return run.steps.find(
          (step: any) => step.activity_id === activity.id && step.complete === true
        );
      }
      return false;
    };
    
    const totalActivities = allActivities.length;
    const completedActivities = allActivities.filter((activity: any) => isActivityDone(activity)).length;
    const progressPercentage = Math.round((completedActivities / totalActivities) * 100);
    
    return {
      completed: completedActivities,
      total: totalActivities,
      percentage: progressPercentage
    };
  }, [trailData, course, isCourseCompleted]);

  if (isCourseCompleted) {
    // Show congratulations for completed course
    return (
      <div className="min-h-[70vh] flex flex-col items-center justify-center text-center px-4 relative overflow-hidden">
        <div className="fixed inset-0 pointer-events-none">
          <ReactConfetti
            width={width}
            height={height}
            numberOfPieces={200}
            recycle={false}
            colors={['#6366f1', '#10b981', '#3b82f6']}
          />
        </div>
        
        <div className="bg-white rounded-2xl p-8 nice-shadow max-w-4xl w-full space-y-6 relative z-10">
          <div className="flex flex-col items-center space-y-6">
            {thumbnailImage && (
              <img
                className="w-[200px] h-[114px] rounded-lg shadow-md object-cover"
                src={`${getCourseThumbnailMediaDirectory(
                  org?.org_uuid,
                  courseUuid,
                  thumbnailImage
                )}`}
                alt={courseName}
              />
            )}
            
            <div className="bg-emerald-100 p-4 rounded-full">
              <Trophy className="w-16 h-16 text-emerald-600" />
            </div>
          </div>
          
          <h1 className="text-4xl font-bold text-gray-900">
            Congratulations! ğŸ‰
          </h1>
          
          <p className="text-xl text-gray-600">
            You've successfully completed
            <span className="font-semibold text-gray-900"> {courseName}</span>
          </p>
          
          <p className="text-gray-500">
            Your dedication and hard work have paid off. You've mastered all the content in this course.
          </p>

          {/* Certificate Display */}
          {isLoadingCertificate ? (
            <div className="flex items-center justify-center py-8">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
              <span className="ml-3 text-gray-600">Loading your certificate...</span>
            </div>
          ) : certificateError ? (
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
              <p className="text-yellow-800">
                {certificateError}
              </p>
            </div>
          ) : userCertificate ? (
            <div className="space-y-4">
              <h2 className="text-2xl font-semibold text-gray-900">Your Certificate</h2>
              <div className="max-w-2xl mx-auto" id="certificate-preview">
                <div id="certificate-content">
                  <CertificatePreview
                    certificationName={userCertificate.certification.config.certification_name}
                    certificationDescription={userCertificate.certification.config.certification_description}
                    certificationType={userCertificate.certification.config.certification_type}
                    certificatePattern={userCertificate.certification.config.certificate_pattern}
                    certificateInstructor={userCertificate.certification.config.certificate_instructor}
                    certificateId={userCertificate.certificate_user.user_certification_uuid}
                    awardedDate={new Date(userCertificate.certificate_user.created_at).toLocaleDateString('en-US', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric'
                    })}
                    qrCodeLink={qrCodeLink}
                  />
                </div>
              </div>
              <div className="flex justify-center space-x-4">
                <button
                  onClick={downloadCertificate}
                  className="inline-flex items-center space-x-2 bg-green-600 text-white px-6 py-3 rounded-full hover:bg-green-700 transition duration-200"
                >
                  <Download className="w-5 h-5" />
                  <span>Download Certificate PDF</span>
                </button>
                <Link
                  href={getUriWithOrg(orgslug, `/certificates/${userCertificate.certificate_user.user_certification_uuid}/verify`)}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="inline-flex items-center space-x-2 bg-blue-600 text-white px-6 py-3 rounded-full hover:bg-blue-700 transition duration-200"
                >
                  <Shield className="w-5 h-5" />
                  <span>Verify Certificate</span>
                </Link>
              </div>
            </div>
          ) : (
            <div className="bg-gray-50 rounded-lg p-6">
              <p className="text-gray-600">
                No certificate is available for this course. Contact your instructor for more information.
              </p>
            </div>
          )}

          <div className="pt-6">
            <Link
              href={getUriWithOrg(orgslug, `/course/${courseUuid.replace('course_', '')}`)}
              className="inline-flex items-center space-x-2 bg-gray-800 text-white px-6 py-3 rounded-full hover:bg-gray-700 transition duration-200"
            >
              <ArrowLeft className="w-5 h-5" />
              <span>Back to Course</span>
            </Link>
          </div>
        </div>
      </div>
    );
  } else {
    // Show progress and encouragement for incomplete course
    return (
      <div className="min-h-[70vh] flex flex-col items-center justify-center text-center px-4">
        <div className="bg-white rounded-2xl p-8 nice-shadow max-w-2xl w-full space-y-6">
          <div className="flex flex-col items-center space-y-6">
            {thumbnailImage && (
              <img
                className="w-[200px] h-[114px] rounded-lg shadow-md object-cover"
                src={`${getCourseThumbnailMediaDirectory(
                  org?.org_uuid,
                  courseUuid,
                  thumbnailImage
                )}`}
                alt={courseName}
              />
            )}
            
            <div className="bg-blue-100 p-4 rounded-full">
              <Target className="w-16 h-16 text-blue-600" />
            </div>
          </div>
          
          <h1 className="text-4xl font-bold text-gray-900">
            Keep Going! ğŸ’ª
          </h1>
          
          <p className="text-xl text-gray-600">
            You're making great progress in
            <span className="font-semibold text-gray-900"> {courseName}</span>
          </p>
          
          {progressInfo && (
            <div className="bg-gray-50 rounded-lg p-6 space-y-4">
              <div className="flex items-center justify-center space-x-2">
                <BookOpen className="w-5 h-5 text-gray-600" />
                <span className="text-lg font-semibold text-gray-700">Course Progress</span>
              </div>
              
              <div className="space-y-2">
                <div className="flex justify-between items-center">
                  <span className="text-gray-600">Progress</span>
                  <span className="font-semibold text-gray-900">{progressInfo.percentage}%</span>
                </div>
                
                <div className="w-full bg-gray-200 rounded-full h-3">
                  <div 
                    className="bg-blue-600 h-3 rounded-full transition-all duration-500"
                    style={{ width: `${progressInfo.percentage}%` }}
                  ></div>
                </div>
                
                <div className="text-sm text-gray-500">
                  {progressInfo.completed} of {progressInfo.total} activities completed
                </div>
              </div>
            </div>
          )}
          
          <p className="text-gray-500">
            You're doing great! Complete the remaining activities to unlock your course completion certificate.
          </p>

          <div className="pt-6">
            <Link
              href={getUriWithOrg(orgslug, `/course/${courseUuid.replace('course_', '')}`)}
              className="inline-flex items-center space-x-2 bg-blue-600 text-white px-6 py-3 rounded-full hover:bg-blue-700 transition duration-200"
            >
              <ArrowLeft className="w-5 h-5" />
              <span>Continue Learning</span>
            </Link>
          </div>
        </div>
      </div>
    );
  }
};

export default CourseEndView; 


================================================
FILE: apps/web/components/Pages/Activity/FixedActivitySecondaryBar.tsx
================================================
'use client'
import { ChevronLeft, ChevronRight } from 'lucide-react'
import { getUriWithOrg } from '@services/config/config'
import { useRouter } from 'next/navigation'
import React, { useEffect, useState, useRef, useMemo, memo } from 'react'
import { getCourseThumbnailMediaDirectory } from '@services/media/media'
import { useOrg } from '@components/Contexts/OrgContext'

interface FixedActivitySecondaryBarProps {
  course: any
  currentActivityId: string
  orgslug: string
  activity: any
}

// Memoized navigation buttons component
const NavigationButtons = memo(({ 
  prevActivity, 
  nextActivity, 
  currentIndex, 
  allActivities, 
  navigateToActivity 
}: { 
  prevActivity: any, 
  nextActivity: any, 
  currentIndex: number, 
  allActivities: any[], 
  navigateToActivity: (activity: any) => void 
}) => (
  <div className="flex items-center space-x-2 sm:space-x-3">
    <button
      onClick={() => navigateToActivity(prevActivity)}
      className={`flex items-center space-x-1 sm:space-x-2 py-1.5 px-1.5 sm:px-2 rounded-md transition-all duration-200 ${
        prevActivity 
          ? 'text-gray-700 hover:bg-gray-100' 
          : 'text-gray-300 cursor-not-allowed'
      }`}
      disabled={!prevActivity}
      title={prevActivity ? `Previous: ${prevActivity.name}` : 'No previous activity'}
    >
      <ChevronLeft size={16} className="shrink-0 sm:w-5 sm:h-5" />
      <div className="flex flex-col items-start hidden sm:flex">
        <span className="text-xs text-gray-500">Previous</span>
        <span className="text-sm font-medium text-left truncate max-w-[100px] sm:max-w-[150px]">
          {prevActivity ? prevActivity.name : 'No previous activity'}
        </span>
      </div>
    </button>

    <span className="text-sm font-medium text-gray-500 px-1 sm:px-2">
      {currentIndex + 1} of {allActivities.length}
    </span>

    <button
      onClick={() => navigateToActivity(nextActivity)}
      className={`flex items-center space-x-1 sm:space-x-2 py-1.5 px-1.5 sm:px-2 rounded-md transition-all duration-200`}
      disabled={!nextActivity}
      title={nextActivity ? `Next: ${nextActivity.name}` : 'No next activity'}
    >
      <div className="flex flex-col items-end hidden sm:flex">
        <span className={`text-xs ${nextActivity ? 'text-gray-500' : 'text-gray-500'}`}>Next</span>
        <span className="text-sm font-medium text-right truncate max-w-[100px] sm:max-w-[150px]">
          {nextActivity ? nextActivity.name : 'No next activity'}
        </span>
      </div>
      <ChevronRight size={16} className="shrink-0 sm:w-5 sm:h-5" />
    </button>
  </div>
));

NavigationButtons.displayName = 'NavigationButtons';

// Memoized course info component
const CourseInfo = memo(({ course, org }: { course: any, org: any }) => (
  <div className="flex items-center space-x-2 sm:space-x-4 min-w-0 flex-shrink">
    <img
      className="w-[35px] sm:w-[45px] h-[20px] sm:h-[26px] rounded-md object-cover flex-shrink-0"
      src={`${getCourseThumbnailMediaDirectory(
        org?.org_uuid,
        course.course_uuid,
        course.thumbnail_image
      )}`}
      alt=""
    />
    <div className="flex flex-col -space-y-0.5 min-w-0 hidden sm:block">
      <p className="text-sm font-medium text-gray-500">Course</p>
      <h1 className="font-semibold text-gray-900 text-base truncate">
        {course.name}
      </h1>
    </div>
  </div>
));

CourseInfo.displayName = 'CourseInfo';

export default function FixedActivitySecondaryBar(props: FixedActivitySecondaryBarProps): React.ReactNode {
  const router = useRouter();
  const [isScrolled, setIsScrolled] = useState(false);
  const [shouldShow, setShouldShow] = useState(false);
  const mainActivityInfoRef = useRef<HTMLDivElement | null>(null);
  const org = useOrg() as any;

  // Memoize activity position calculation
  const { allActivities, currentIndex } = useMemo(() => {
    let allActivities: any[] = [];
    let currentIndex = -1;
    
    props.course.chapters.forEach((chapter: any) => {
      chapter.activities.forEach((activity: any) => {
        const cleanActivityUuid = activity.activity_uuid?.replace('activity_', '');
        allActivities.push({
          ...activity,
          cleanUuid: cleanActivityUuid,
          chapterName: chapter.name
        });
        
        if (cleanActivityUuid === props.currentActivityId.replace('activity_', '')) {
          currentIndex = allActivities.length - 1;
        }
      });
    });
    
    return { allActivities, currentIndex };
  }, [props.course, props.currentActivityId]);
  
  const prevActivity = currentIndex > 0 ? allActivities[currentIndex - 1] : null;
  const nextActivity = currentIndex < allActivities.length - 1 ? allActivities[currentIndex + 1] : null;
  
  const navigateToActivity = (activity: any) => {
    if (!activity) return;
    
    const cleanCourseUuid = props.course.course_uuid?.replace('course_', '');
    router.push(getUriWithOrg(props.orgslug, '') + `/course/${cleanCourseUuid}/activity/${activity.cleanUuid}`);
  };

  useEffect(() => {
    const handleScroll = () => {
      setIsScrolled(window.scrollY > 0);
    };

    const observer = new IntersectionObserver(
      ([entry]) => {
        setShouldShow(!entry.isIntersecting);
      },
      {
        threshold: [0, 0.1, 1],
        rootMargin: '-80px 0px 0px 0px'
      }
    );

    const mainActivityInfo = document.querySelector('.activity-info-section');
    if (mainActivityInfo) {
      mainActivityInfoRef.current = mainActivityInfo as HTMLDivElement;
      observer.observe(mainActivityInfo);
    }

    window.addEventListener('scroll', handleScroll);
    
    return () => {
      window.removeEventListener('scroll', handleScroll);
      if (mainActivityInfoRef.current) {
        observer.unobserve(mainActivityInfoRef.current);
      }
    };
  }, []);

  if (!shouldShow) return null;

  return (
    <div 
      className={`fixed top-[60px] left-0 right-0 z-40 bg-white/90 backdrop-blur-xl transition-all duration-300 animate-in fade-in slide-in-from-top ${
        isScrolled ? 'nice-shadow' : ''
      }`}
    >
      <div className="container mx-auto px-4">
        <div className="flex items-center justify-between h-16 py-2">
          <CourseInfo course={props.course} org={org} />
          
          <div className="flex items-center flex-shrink-0">
            <NavigationButtons
              prevActivity={prevActivity}
              nextActivity={nextActivity}
              currentIndex={currentIndex}
              allActivities={allActivities}
              navigateToActivity={navigateToActivity}
            />
          </div>
        </div>
      </div>
    </div>
  );
} 


================================================
FILE: apps/web/components/Pages/Certificate/CertificatePage.tsx
================================================
'use client';

import React, { useEffect, useState } from 'react';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import { getUserCertificates } from '@services/courses/certifications';
import CertificatePreview from '@components/Dashboard/Pages/Course/EditCourseCertification/CertificatePreview';
import { ArrowLeft, Download } from 'lucide-react';
import Link from 'next/link';
import { getUriWithOrg } from '@services/config/config';
import html2canvas from 'html2canvas';
import jsPDF from 'jspdf';
import QRCode from 'qrcode';

interface CertificatePageProps {
  orgslug: string;
  courseid: string;
  qrCodeLink: string;
}

const CertificatePage: React.FC<CertificatePageProps> = ({ orgslug, courseid, qrCodeLink }) => {
  const session = useLHSession() as any;
  const [userCertificate, setUserCertificate] = useState<any>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Fetch user certificate
  useEffect(() => {
    const fetchCertificate = async () => {
      if (!session?.data?.tokens?.access_token) {
        setError('Authentication required to view certificate');
        setIsLoading(false);
        return;
      }

      try {
        const cleanCourseId = courseid.replace('course_', '');
        const result = await getUserCertificates(
          `course_${cleanCourseId}`,
          session.data.tokens.access_token
        );

        if (result.success && result.data && result.data.length > 0) {
          setUserCertificate(result.data[0]);
        } else {
          setError('No certificate found for this course');
        }
      } catch (error) {
        console.error('Error fetching certificate:', error);
        setError('Failed to load certificate. Please try again later.');
      } finally {
        setIsLoading(false);
      }
    };

    fetchCertificate();
  }, [courseid, session?.data?.tokens?.access_token]);



  // Generate PDF using canvas
  const downloadCertificate = async () => {
    if (!userCertificate) return;

    try {
      // Create a temporary div for the certificate
      const certificateDiv = document.createElement('div');
      certificateDiv.style.position = 'absolute';
      certificateDiv.style.left = '-9999px';
      certificateDiv.style.top = '0';
      certificateDiv.style.width = '800px';
      certificateDiv.style.height = '600px';
      certificateDiv.style.background = 'white';
      certificateDiv.style.padding = '40px';
      certificateDiv.style.fontFamily = 'Arial, sans-serif';
      certificateDiv.style.textAlign = 'center';
      certificateDiv.style.display = 'flex';
      certificateDiv.style.flexDirection = 'column';
      certificateDiv.style.justifyContent = 'center';
      certificateDiv.style.alignItems = 'center';
      certificateDiv.style.position = 'relative';
      certificateDiv.style.overflow = 'hidden';

      // Get theme colors based on pattern
      const getPatternTheme = (pattern: string) => {
        switch (pattern) {
          case 'royal':
            return { primary: '#b45309', secondary: '#d97706', icon: '#d97706' };
          case 'tech':
            return { primary: '#0e7490', secondary: '#0891b2', icon: '#0891b2' };
          case 'nature':
            return { primary: '#15803d', secondary: '#16a34a', icon: '#16a34a' };
          case 'geometric':
            return { primary: '#7c3aed', secondary: '#9333ea', icon: '#9333ea' };
          case 'vintage':
            return { primary: '#c2410c', secondary: '#ea580c', icon: '#ea580c' };
          case 'waves':
            return { primary: '#1d4ed8', secondary: '#2563eb', icon: '#2563eb' };
          case 'minimal':
            return { primary: '#374151', secondary: '#4b5563', icon: '#4b5563' };
          case 'professional':
            return { primary: '#334155', secondary: '#475569', icon: '#475569' };
          case 'academic':
            return { primary: '#3730a3', secondary: '#4338ca', icon: '#4338ca' };
          case 'modern':
            return { primary: '#1d4ed8', secondary: '#2563eb', icon: '#2563eb' };
          default:
            return { primary: '#374151', secondary: '#4b5563', icon: '#4b5563' };
        }
      };

      const theme = getPatternTheme(userCertificate.certification.config.certificate_pattern);
      const certificateId = userCertificate.certificate_user.user_certification_uuid;
      const qrCodeData = qrCodeLink ;

      // Generate QR code
      const qrCodeDataUrl = await QRCode.toDataURL(qrCodeData, {
        width: 120,
        margin: 2,
        color: {
          dark: '#000000',
          light: '#FFFFFF'
        },
        errorCorrectionLevel: 'M',
        type: 'image/png'
      });

      // Create certificate content
      certificateDiv.innerHTML = `
        <div style="
          position: absolute;
          top: 20px;
          left: 20px;
          font-size: 12px;
          color: ${theme.secondary};
          font-weight: 500;
        ">ID: ${certificateId}</div>
        
        <div style="
          position: absolute;
          top: 20px;
          right: 20px;
          width: 80px;
          height: 80px;
          border: 2px solid ${theme.secondary};
          border-radius: 8px;
          background: white;
          display: flex;
          align-items: center;
          justify-content: center;
        ">
          <img src="${qrCodeDataUrl}" alt="QR Code" style="width: 100%; height: 100%; object-fit: contain;" />
        </div>
        
        <div style="
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          margin-bottom: 30px;
          font-size: 14px;
          color: ${theme.secondary};
          font-weight: 500;
          text-transform: uppercase;
          letter-spacing: 1px;
        ">
          <div style="width: 24px; height: 1px; background: linear-gradient(90deg, transparent, ${theme.secondary}, transparent);"></div>
          Certificate
          <div style="width: 24px; height: 1px; background: linear-gradient(90deg, transparent, ${theme.secondary}, transparent);"></div>
        </div>
        
        <div style="
          width: 80px;
          height: 80px;
          background: linear-gradient(135deg, ${theme.icon}20 0%, ${theme.icon}40 100%);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          margin: 0 auto 30px;
          font-size: 40px;
          line-height: 1;
        ">ğŸ†</div>
        
        <div style="
          font-size: 32px;
          font-weight: bold;
          color: ${theme.primary};
          margin-bottom: 20px;
          line-height: 1.2;
          max-width: 600px;
        ">${userCertificate.certification.config.certification_name}</div>
        
        <div style="
          font-size: 18px;
          color: #6b7280;
          margin-bottom: 30px;
          line-height: 1.5;
          max-width: 500px;
        ">${userCertificate.certification.config.certification_description || 'This is to certify that the course has been successfully completed.'}</div>
        
        <div style="
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 4px;
          margin: 20px 0;
        ">
          <div style="width: 8px; height: 1px; background: ${theme.secondary}; opacity: 0.5;"></div>
          <div style="width: 4px; height: 4px; background: ${theme.primary}; border-radius: 50%; opacity: 0.6;"></div>
          <div style="width: 8px; height: 1px; background: ${theme.secondary}; opacity: 0.5;"></div>
        </div>
        
        <div style="
          display: inline-flex;
          align-items: center;
          gap: 8px;
          font-size: 16px;
          color: ${theme.primary};
          background: ${theme.icon}10;
          padding: 12px 24px;
          border-radius: 20px;
          border: 1px solid ${theme.icon}20;
          font-weight: 500;
          margin-bottom: 30px;
          white-space: nowrap;
        ">
          <span style="font-weight: bold; font-size: 18px;">âœ“</span>
          <span>${userCertificate.certification.config.certification_type === 'completion' ? 'Course Completion' :
            userCertificate.certification.config.certification_type === 'achievement' ? 'Achievement Based' :
            userCertificate.certification.config.certification_type === 'assessment' ? 'Assessment Based' :
            userCertificate.certification.config.certification_type === 'participation' ? 'Participation' :
            userCertificate.certification.config.certification_type === 'mastery' ? 'Skill Mastery' :
            userCertificate.certification.config.certification_type === 'professional' ? 'Professional Development' :
            userCertificate.certification.config.certification_type === 'continuing' ? 'Continuing Education' :
            userCertificate.certification.config.certification_type === 'workshop' ? 'Workshop Attendance' :
            userCertificate.certification.config.certification_type === 'specialization' ? 'Specialization' : 'Course Completion'}</span>
        </div>
        
        <div style="
          margin-top: 30px;
          padding: 24px;
          background: #f8fafc;
          border-radius: 8px;
          border: 1px solid #e2e8f0;
          max-width: 400px;
        ">
          <div style="margin: 8px 0; font-size: 14px; color: #374151;">
            <strong style="color: ${theme.primary};">Certificate ID:</strong> ${certificateId}
          </div>
          <div style="margin: 8px 0; font-size: 14px; color: #374151;">
            <strong style="color: ${theme.primary};">Awarded:</strong> ${new Date(userCertificate.certificate_user.created_at).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
          </div>
          ${userCertificate.certification.config.certificate_instructor ? 
            `<div style="margin: 8px 0; font-size: 14px; color: #374151;">
              <strong style="color: ${theme.primary};">Instructor:</strong> ${userCertificate.certification.config.certificate_instructor}
            </div>` : ''
          }
        </div>
        
        <div style="
          margin-top: 20px;
          font-size: 12px;
          color: #6b7280;
        ">
          This certificate can be verified at ${qrCodeData.replace('https://', '').replace('http://', '')}
        </div>
      `;

      // Add to document temporarily
      document.body.appendChild(certificateDiv);

      // Convert to canvas
      const canvas = await html2canvas(certificateDiv, {
        width: 800,
        height: 600,
        scale: 2, // Higher resolution
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff'
      });

      // Remove temporary div
      document.body.removeChild(certificateDiv);

      // Create PDF
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF('landscape', 'mm', 'a4');
      
      // Calculate dimensions to center the certificate
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = pdf.internal.pageSize.getHeight();
      const imgWidth = 280; // mm
      const imgHeight = 210; // mm
      
      // Center the image
      const x = (pdfWidth - imgWidth) / 2;
      const y = (pdfHeight - imgHeight) / 2;
      
      pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
      
      // Save the PDF
      const fileName = `${userCertificate.certification.config.certification_name.replace(/[^a-zA-Z0-9]/g, '_')}_Certificate.pdf`;
      pdf.save(fileName);

    } catch (error) {
      console.error('Error generating PDF:', error);
      alert('Failed to generate PDF. Please try again.');
    }
  };

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-gray-600">Loading certificate...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center max-w-md mx-auto p-6">
          <div className="bg-red-50 border border-red-200 rounded-lg p-6">
            <h2 className="text-xl font-semibold text-red-800 mb-2">Certificate Not Available</h2>
            <p className="text-red-600 mb-4">{error}</p>
            <Link
              href={getUriWithOrg(orgslug, '') + `/course/${courseid}`}
              className="inline-flex items-center space-x-2 bg-blue-600 text-white px-6 py-3 rounded-full hover:bg-blue-700 transition duration-200"
            >
              <ArrowLeft className="w-5 h-5" />
              <span>Back to Course</span>
            </Link>
          </div>
        </div>
      </div>
    );
  }

  if (!userCertificate) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center max-w-md mx-auto p-6">
          <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
            <h2 className="text-xl font-semibold text-yellow-800 mb-2">No Certificate Found</h2>
            <p className="text-yellow-600 mb-4">
              No certificate is available for this course. Please contact your instructor for more information.
            </p>
            <Link
              href={getUriWithOrg(orgslug, '') + `/course/${courseid}`}
              className="inline-flex items-center space-x-2 bg-blue-600 text-white px-6 py-3 rounded-full hover:bg-blue-700 transition duration-200"
            >
              <ArrowLeft className="w-5 h-5" />
              <span>Back to Course</span>
            </Link>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-4xl mx-auto px-4">
        {/* Header */}
        <div className="flex items-center justify-between mb-8">
          <Link
            href={getUriWithOrg(orgslug, '') + `/course/${courseid}`}
            className="inline-flex items-center space-x-2 text-gray-600 hover:text-gray-900 transition duration-200"
          >
            <ArrowLeft className="w-5 h-5" />
            <span>Back to Course</span>
          </Link>
          
          <div className="flex items-center space-x-4">
            <button
              onClick={downloadCertificate}
              className="inline-flex items-center space-x-2 bg-green-600 text-white px-6 py-3 rounded-full hover:bg-green-700 transition duration-200"
            >
              <Download className="w-5 h-5" />
              <span>Download PDF</span>
            </button>
          </div>
        </div>

        {/* Certificate Display */}
        <div className="bg-white rounded-2xl shadow-lg p-8">
          <div className="max-w-2xl mx-auto">
            <CertificatePreview
              certificationName={userCertificate.certification.config.certification_name}
              certificationDescription={userCertificate.certification.config.certification_description}
              certificationType={userCertificate.certification.config.certification_type}
              certificatePattern={userCertificate.certification.config.certificate_pattern}
              certificateInstructor={userCertificate.certification.config.certificate_instructor}
              certificateId={userCertificate.certificate_user.user_certification_uuid}
              awardedDate={new Date(userCertificate.certificate_user.created_at).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              })}
              qrCodeLink={qrCodeLink}
            />
          </div>
        </div>

        {/* Instructions */}
        <div className="mt-8 text-center text-gray-600">
          <p className="mb-2">
            Click "Download PDF" to generate and download a high-quality certificate PDF.
          </p>
          <p className="text-sm">
            The PDF includes a scannable QR code for certificate verification.
          </p>
        </div>
      </div>
    </div>
  );
};

export default CertificatePage; 


================================================
FILE: apps/web/components/Pages/Certificate/CertificateVerificationPage.tsx
================================================
'use client';

import React, { useEffect, useState } from 'react';
import { getCertificateByUuid } from '@services/courses/certifications';
import CertificatePreview from '@components/Dashboard/Pages/Course/EditCourseCertification/CertificatePreview';
import { Shield, CheckCircle, XCircle, AlertTriangle, ArrowLeft } from 'lucide-react';
import Link from 'next/link';
import { getUriWithOrg } from '@services/config/config';
import { getCourseThumbnailMediaDirectory } from '@services/media/media';
import { useOrg } from '@components/Contexts/OrgContext';

interface CertificateVerificationPageProps {
  certificateUuid: string;
}

const CertificateVerificationPage: React.FC<CertificateVerificationPageProps> = ({ certificateUuid }) => {
  const [certificateData, setCertificateData] = useState<any>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [verificationStatus, setVerificationStatus] = useState<'valid' | 'invalid' | 'loading'>('loading');
  const org = useOrg() as any;

  // Fetch certificate data
  useEffect(() => {
    const fetchCertificate = async () => {
      try {
        const result = await getCertificateByUuid(certificateUuid);
        
        if (result.success && result.data) {
          setCertificateData(result.data);
          setVerificationStatus('valid');
        } else {
          setError('Certificate not found');
          setVerificationStatus('invalid');
        }
      } catch (error) {
        console.error('Error fetching certificate:', error);
        setError('Failed to verify certificate. Please try again later.');
        setVerificationStatus('invalid');
      } finally {
        setIsLoading(false);
      }
    };

    fetchCertificate();
  }, [certificateUuid]);

  const getVerificationStatusIcon = () => {
    switch (verificationStatus) {
      case 'valid':
        return <CheckCircle className="w-8 h-8 text-green-600" />;
      case 'invalid':
        return <XCircle className="w-8 h-8 text-red-600" />;
      case 'loading':
        return <AlertTriangle className="w-8 h-8 text-yellow-600" />;
      default:
        return <AlertTriangle className="w-8 h-8 text-yellow-600" />;
    }
  };

  const getVerificationStatusText = () => {
    switch (verificationStatus) {
      case 'valid':
        return 'Certificate Verified';
      case 'invalid':
        return 'Certificate Not Found';
      case 'loading':
        return 'Verifying Certificate...';
      default:
        return 'Verification Status Unknown';
    }
  };

  const getVerificationStatusColor = () => {
    switch (verificationStatus) {
      case 'valid':
        return 'text-green-600 bg-green-50 border-green-200';
      case 'invalid':
        return 'text-red-600 bg-red-50 border-red-200';
      case 'loading':
        return 'text-yellow-600 bg-yellow-50 border-yellow-200';
      default:
        return 'text-yellow-600 bg-yellow-50 border-yellow-200';
    }
  };

  if (isLoading) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50">
        <div className="bg-white rounded-2xl p-8 nice-shadow max-w-4xl w-full space-y-6">
          <div className="flex items-center justify-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
          </div>
          <div className="text-center">
            <h1 className="text-2xl font-bold text-gray-900 mb-2">Verifying Certificate</h1>
            <p className="text-gray-600">Please wait while we verify the certificate...</p>
          </div>
        </div>
      </div>
    );
  }

  if (error || verificationStatus === 'invalid') {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50">
        <div className="bg-white rounded-2xl p-8 nice-shadow max-w-2xl w-full space-y-6">
          <div className="flex flex-col items-center space-y-4">
            <div className="bg-red-100 p-4 rounded-full">
              <XCircle className="w-16 h-16 text-red-600" />
            </div>
            
            <h1 className="text-3xl font-bold text-gray-900 text-center">
              Certificate Not Found
            </h1>
            
            <p className="text-gray-600 text-center">
              The certificate with ID <span className="font-mono bg-gray-100 px-2 py-1 rounded">{certificateUuid}</span> could not be found in our system.
            </p>
            
            <div className="bg-red-50 border border-red-200 rounded-lg p-4 w-full">
              <p className="text-red-800 text-sm">
                This could mean:
              </p>
              <ul className="text-red-700 text-sm mt-2 list-disc list-inside space-y-1">
                <li>The certificate ID is incorrect</li>
                <li>The certificate has been revoked</li>
                <li>The certificate has expired</li>
                <li>The certificate was issued by a different organization</li>
              </ul>
            </div>
            
            <div className="pt-4">
              <Link
                href="/"
                className="inline-flex items-center space-x-2 bg-gray-800 text-white px-6 py-3 rounded-full hover:bg-gray-700 transition duration-200"
              >
                <ArrowLeft className="w-5 h-5" />
                <span>Go Home</span>
              </Link>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (!certificateData) {
    return null;
  }

  const qrCodeLink = getUriWithOrg(org?.org_slug || '', `/certificates/${certificateData.certificate_user.user_certification_uuid}/verify`);

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-6xl mx-auto px-4">
        {/* Header */}
        <div className="bg-white rounded-2xl p-6 mb-8 nice-shadow">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-4">
              <div className="bg-green-100 p-3 rounded-full">
                <Shield className="w-8 h-8 text-green-600" />
              </div>
              <div>
                <h1 className="text-2xl font-bold text-gray-900">Certificate Verification</h1>
                <p className="text-gray-600">Verify the authenticity of this certificate</p>
              </div>
            </div>
            
            <div className={`flex items-center space-x-3 px-4 py-2 rounded-full border ${getVerificationStatusColor()}`}>
              {getVerificationStatusIcon()}
              <span className="font-semibold">{getVerificationStatusText()}</span>
            </div>
          </div>
        </div>

        {/* Certificate Details */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Certificate Preview and Course Info */}
          <div className="lg:col-span-2 space-y-6">
            {/* Certificate Preview */}
            <div className="bg-white rounded-2xl p-6 nice-shadow">
              <h2 className="text-xl font-semibold text-gray-900 mb-4">Certificate Preview</h2>
              <div className="max-w-2xl mx-auto" id="certificate-preview">
                <CertificatePreview
                  certificationName={certificateData.certification.config.certification_name}
                  certificationDescription={certificateData.certification.config.certification_description}
                  certificationType={certificateData.certification.config.certification_type}
                  certificatePattern={certificateData.certification.config.certificate_pattern}
                  certificateInstructor={certificateData.certification.config.certificate_instructor}
                  certificateId={certificateData.certificate_user.user_certification_uuid}
                  awardedDate={new Date(certificateData.certificate_user.created_at).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                  })}
                  qrCodeLink={qrCodeLink}
                />
              </div>
            </div>

            {/* Course Information */}
            <div className="bg-white shadow-md shadow-gray-300/25 outline outline-1 outline-neutral-200/40 rounded-lg overflow-hidden p-4">
              <div className="flex items-start space-x-4">
                {/* Course Thumbnail */}
                <div className="flex-shrink-0">
                  <div className="w-20 h-12 bg-gray-100 rounded-lg overflow-hidden ring-1 ring-inset ring-black/10">
                    {certificateData.course.thumbnail_image ? (
                      <img
                        src={getCourseThumbnailMediaDirectory(
                          org?.org_uuid,
                          certificateData.course.course_uuid,
                          certificateData.course.thumbnail_image
                        )}
                        alt={`${certificateData.course.name} thumbnail`}
                        className="w-full h-full object-cover"
                      />
                    ) : (
                      <div className="w-full h-full bg-gray-200 flex items-center justify-center">
                        <svg className="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                      </div>
                    )}
                  </div>
                </div>

                {/* Course Details */}
                <div className="flex-1 min-w-0">
                  <div className="space-y-1">
                    <div>
                      <h4 className="font-semibold text-gray-900 text-base leading-tight">{certificateData.course.name}</h4>
                      {certificateData.course.description && (
                        <p className="text-sm text-gray-600 line-clamp-2 mt-1">{certificateData.course.description}</p>
                      )}
                    </div>

                    {certificateData.course.authors && certificateData.course.authors.length > 0 && (
                      <div className="flex items-center space-x-1 text-sm text-neutral-400 font-normal">
                        <span>By:</span>
                        <div className="flex items-center space-x-1">
                          {certificateData.course.authors
                            .filter((author: any) => author.authorship_status === 'ACTIVE')
                            .slice(0, 2)
                            .map((author: any, index: number) => (
                              <span key={author.user.user_uuid} className="text-neutral-600">
                                {author.user.first_name} {author.user.last_name}
                                {index < Math.min(2, certificateData.course.authors.filter((a: any) => a.authorship_status === 'ACTIVE').length - 1) && ', '}
                              </span>
                            ))}
                          {certificateData.course.authors.filter((author: any) => author.authorship_status === 'ACTIVE').length > 2 && (
                            <span className="text-neutral-400">
                              +{certificateData.course.authors.filter((author: any) => author.authorship_status === 'ACTIVE').length - 2} more
                            </span>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* View Course Link */}
                <div className="flex-shrink-0">
                  <Link
                    href={getUriWithOrg(org?.org_slug || '', `/course/${certificateData.course.course_uuid.replace('course_', '')}`)}
                    className="inline-flex items-center space-x-1 text-neutral-400 hover:text-neutral-600 transition-colors text-sm"
                  >
                    <span>View Course</span>
                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                    </svg>
                  </Link>
                </div>
              </div>
            </div>
          </div>

          {/* Certificate Details */}
          <div className="space-y-6">
            <div className="bg-white rounded-2xl p-6 nice-shadow">
              <h2 className="text-xl font-semibold text-gray-900 mb-4">Certificate Information</h2>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Certificate ID</label>
                  <div className="bg-gray-50 p-3 rounded-lg">
                    <code className="text-sm text-gray-900 break-all">
                      {certificateData.certificate_user.user_certification_uuid}
                    </code>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Course Name</label>
                  <div className="bg-gray-50 p-3 rounded-lg">
                    <span className="text-gray-900">{certificateData.course.name}</span>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Certification Type</label>
                  <div className="bg-gray-50 p-3 rounded-lg">
                    <span className="text-gray-900 capitalize">
                      {certificateData.certification.config.certification_type.replace('_', ' ')}
                    </span>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Awarded Date</label>
                  <div className="bg-gray-50 p-3 rounded-lg">
                    <span className="text-gray-900">
                      {new Date(certificateData.certificate_user.created_at).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                      })}
                    </span>
                  </div>
                </div>

                {certificateData.certification.config.certificate_instructor && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Instructor</label>
                    <div className="bg-gray-50 p-3 rounded-lg">
                      <span className="text-gray-900">{certificateData.certification.config.certificate_instructor}</span>
                    </div>
                  </div>
                )}
              </div>
            </div>

            <div className="bg-blue-50 border border-blue-200 rounded-2xl p-6">
              <div className="flex items-center space-x-3 mb-3">
                <Shield className="w-6 h-6 text-blue-600" />
                <h3 className="text-lg font-semibold text-blue-800">Security Information</h3>
              </div>
              <ul className="text-blue-700 text-sm space-y-2">
                <li>â€¢ Certificate verified against our secure database</li>
                <li>â€¢ QR code contains verification link</li>
                <li>â€¢ Certificate ID is cryptographically secure</li>
                <li>â€¢ Timestamp verified and authenticated</li>
              </ul>
            </div>
          </div>
        </div>

        {/* Footer */}
        <div className="mt-8 text-center">
          <Link
            href="/"
            className="inline-flex items-center space-x-2 bg-gray-800 text-white px-6 py-3 rounded-full hover:bg-gray-700 transition duration-200"
          >
            <ArrowLeft className="w-5 h-5" />
            <span>Go Home</span>
          </Link>
        </div>
      </div>
    </div>
  );
};

export default CertificateVerificationPage; 


================================================
FILE: apps/web/components/Pages/CourseEdit/Draggables/Activity.tsx
================================================
import React from 'react'
import Link from 'next/link'
import { Draggable } from '@hello-pangea/dnd'
import { getAPIUrl, getUriWithOrg } from '@services/config/config'
import {
  Video,
  Sparkles,
  X,
  Pencil,
  MoreVertical,
  Eye,
  Save,
  File,
} from 'lucide-react'
import { mutate } from 'swr'
import { revalidateTags } from '@services/utils/ts/requests'
import { useRouter } from 'next/navigation'
import ConfirmationModal from '@components/Objects/StyledElements/ConfirmationModal/ConfirmationModal'
import { deleteActivity, updateActivity } from '@services/courses/activities'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { useCourse } from '@components/Contexts/CourseContext'

interface ModifiedActivityInterface {
  activityId: string
  activityName: string
}

function Activity(props: any) {
  const router = useRouter()
  const session = useLHSession() as any;
  const [modifiedActivity, setModifiedActivity] = React.useState<
    ModifiedActivityInterface | undefined
  >(undefined)
  const [selectedActivity, setSelectedActivity] = React.useState<
    string | undefined
  >(undefined)
  const course = useCourse() as any;
  const withUnpublishedActivities = course ? course.withUnpublishedActivities : false

  async function removeActivity() {
    await deleteActivity(props.activity.id, session.data?.tokens?.access_token)
    mutate(`${getAPIUrl()}chapters/meta/course_${props.courseid}?with_unpublished_activities=${withUnpublishedActivities}`)
    await revalidateTags(['courses'], props.orgslug)
    router.refresh()
  }

  async function updateActivityName(activityId: string) {
    if (
      modifiedActivity?.activityId === activityId &&
      selectedActivity !== undefined
    ) {
      let modifiedActivityCopy = {
        ...props.activity,
        name: modifiedActivity.activityName,
      }
      
      await updateActivity(modifiedActivityCopy, activityId, session.data?.tokens?.access_token)
      await mutate(`${getAPIUrl()}chapters/meta/course_${props.courseid}?with_unpublished_activities=${withUnpublishedActivities}`)
      await revalidateTags(['courses'], props.orgslug)
      router.refresh()
    }
    setSelectedActivity(undefined)
  }

  return (
    <Draggable
      key={props.activity.uuid}
      draggableId={String(props.activity.uuid)}
      index={props.index}
    >
      {(provided) => (
        <div
          className="flex flex-row py-2 my-2 rounded-md bg-gray-50 text-gray-500 hover:bg-gray-100 hover:scale-102 hover:shadow-sm space-x-1 w-auto items-center ring-1 ring-inset ring-gray-400/10 shadow-xs transition-all delay-100 duration-75 ease-linear"
          key={props.activity.id}
          {...provided.draggableProps}
          {...provided.dragHandleProps}
          ref={provided.innerRef}
        >
          <div className="px-3 text-gray-300 space-x-1 w-28">
            {props.activity.type === 'video' && (
              <>
                <div className="flex space-x-2 items-center">
                  <Video size={16} />{' '}
                  <div className="text-xs bg-gray-200 text-gray-400 font-bold px-2 py-1 rounded-full mx-auto justify-center align-middle">
                    Video
                  </div>{' '}
                </div>
              </>
            )}
            {props.activity.type === 'documentpdf' && (
              <>
                <div className="flex space-x-2 items-center">
                  <div className="w-[30px]">
                    <File size={16} />{' '}
                  </div>
                  <div className="text-xs bg-gray-200 text-gray-400 font-bold px-2 py-1 rounded-full">
                    Document
                  </div>{' '}
                </div>
              </>
            )}
            {props.activity.type === 'dynamic' && (
              <>
                <div className="flex space-x-2 items-center">
                  <Sparkles size={16} />{' '}
                  <div className="text-xs bg-gray-200 text-gray-400 font-bold px-2 py-1 rounded-full">
                    Dynamic
                  </div>{' '}
                </div>
              </>
            )}
          </div>

          <div className="grow items-center space-x-2 flex mx-auto justify-center">
            {selectedActivity === props.activity.id ? (
              <div className="chapter-modification-zone text-[7px] text-gray-600 shadow-inner bg-gray-200/60 py-1 px-4 rounded-lg space-x-3">
                <input
                  type="text"
                  className="bg-transparent outline-hidden text-xs text-gray-500"
                  placeholder="Activity name"
                  value={
                    modifiedActivity
                      ? modifiedActivity?.activityName
                      : props.activity.name
                  }
                  onChange={(e) =>
                    setModifiedActivity({
                      activityId: props.activity.id,
                      activityName: e.target.value,
                    })
                  }
                />
                <button
                  onClick={() => updateActivityName(props.activity.id)}
                  className="bg-transparent text-neutral-700 hover:cursor-pointer hover:text-neutral-900"
                >
                  <Save
                    size={11}
                    onClick={() => updateActivityName(props.activity.id)}
                  />
                </button>
              </div>
            ) : (
              <p className="first-letter:uppercase"> {props.activity.name} </p>
            )}
            <Pencil
              onClick={() => setSelectedActivity(props.activity.id)}
              size={12}
              className="text-neutral-400 hover:cursor-pointer"
            />
          </div>

          <div className="flex flex-row space-x-2">
            {props.activity.type === 'TYPE_DYNAMIC' && (
              <>
                <Link
                  href={
                    getUriWithOrg(props.orgslug, '') +
                    `/course/${props.courseid
                    }/activity/${props.activity.uuid.replace(
                      'activity_',
                      ''
                    )}/edit`
                  }
                  className=" hover:cursor-pointer p-1 px-3 bg-sky-700 rounded-md items-center"
                  rel="noopener noreferrer"
                >
                  <div className="text-sky-100 font-bold text-xs">Edit </div>
                </Link>
              </>
            )}
            <Link
              href={
                getUriWithOrg(props.orgslug, '') +
                `/course/${props.courseid
                }/activity/${props.activity.uuid.replace('activity_', '')}`
              }
              className=" hover:cursor-pointer p-1 px-3 bg-gray-200 rounded-md"
              rel="noopener noreferrer"
            >
              <Eye strokeWidth={2} size={15} className="text-gray-600" />
            </Link>
          </div>
          <div className="flex flex-row pr-3 space-x-1 items-center">
            <MoreVertical size={15} className="text-gray-300" />
            <ConfirmationModal
              confirmationMessage="Are you sure you want to delete this activity ?"
              confirmationButtonText="Delete Activity"
              dialogTitle={'Delete ' + props.activity.name + ' ?'}
              dialogTrigger={
                <div
                  className=" hover:cursor-pointer p-1 px-5 bg-red-600 rounded-md"
                  rel="noopener noreferrer"
                >
                  <X size={15} className="text-rose-200 font-bold" />
                </div>
              }
              functionToExecute={() => removeActivity()}
              status="warning"
            ></ConfirmationModal>
          </div>
        </div>
      )}
    </Draggable>
  )
}

export default Activity



================================================
FILE: apps/web/components/Pages/CourseEdit/Draggables/Chapter.tsx
================================================
import React from 'react'
import styled from 'styled-components'
import { Droppable, Draggable } from '@hello-pangea/dnd'
import Activity from './Activity'
import { Hexagon, MoreVertical, Pencil, Save, Sparkles, X } from 'lucide-react'
import ConfirmationModal from '@components/Objects/StyledElements/ConfirmationModal/ConfirmationModal'
import { useRouter } from 'next/navigation'
import { updateChapter } from '@services/courses/chapters'
import { mutate } from 'swr'
import { getAPIUrl } from '@services/config/config'
import { revalidateTags } from '@services/utils/ts/requests'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { useCourse } from '@components/Contexts/CourseContext'
interface ModifiedChapterInterface {
  chapterId: string
  chapterName: string
}

function Chapter(props: any) {
  const router = useRouter()
  const session = useLHSession() as any;
  const [modifiedChapter, setModifiedChapter] = React.useState<
    ModifiedChapterInterface | undefined
  >(undefined)
  const [selectedChapter, setSelectedChapter] = React.useState<
    string | undefined
  >(undefined)
  const course = useCourse() as any;
  const withUnpublishedActivities = course ? course.withUnpublishedActivities : false

  async function updateChapterName(chapterId: string) {
    if (modifiedChapter?.chapterId === chapterId) {
      let modifiedChapterCopy = {
        name: modifiedChapter.chapterName,
      }
      await updateChapter(chapterId, modifiedChapterCopy, session.data?.tokens?.access_token)
      await mutate(`${getAPIUrl()}chapters/course/${props.course_uuid}/meta?with_unpublished_activities=${withUnpublishedActivities}`)
      await revalidateTags(['courses'], props.orgslug)
      router.refresh()
    }
    setSelectedChapter(undefined)
  }

  return (
    <Draggable
      key={props.info.list.chapter.uuid}
      draggableId={String(props.info.list.chapter.uuid)}
      index={props.index}
    >
      {(provided, snapshot) => (
        <ChapterWrapper
          {...provided.dragHandleProps}
          {...provided.draggableProps}
          ref={provided.innerRef}
          //  isDragging={snapshot.isDragging}
          className="max-w-(--breakpoint-2xl) mx-auto bg-white px-5"
          key={props.info.list.chapter.id}
        >
          <div className="flex pt-3 pr-3 font-bold text-md items-center space-x-2">
            <div className="flex grow text-lg space-x-3 items-center rounded-md px-3 py-1">
              <div className="bg-neutral-100 rounded-md p-2">
                <Hexagon
                  strokeWidth={3}
                  size={16}
                  className="text-neutral-600 "
                />
              </div>

              <div className="flex space-x-2 items-center">
                {selectedChapter === props.info.list.chapter.id ? (
                  <div className="chapter-modification-zone bg-neutral-100 py-1 px-4 rounded-lg space-x-3">
                    <input
                      type="text"
                      className="bg-transparent outline-hidden text-sm text-neutral-700"
                      placeholder="Chapter name"
                      value={
                        modifiedChapter
                          ? modifiedChapter?.chapterName
                          : props.info.list.chapter.name
                      }
                      onChange={(e) =>
                        setModifiedChapter({
                          chapterId: props.info.list.chapter.id,
                          chapterName: e.target.value,
                        })
                      }
                    />
                    <button
                      onClick={() =>
                        updateChapterName(props.info.list.chapter.id)
                      }
                      className="bg-transparent text-neutral-700 hover:cursor-pointer hover:text-neutral-900"
                    >
                      <Save
                        size={15}
                        onClick={() =>
                          updateChapterName(props.info.list.chapter.id)
                        }
                      />
                    </button>
                  </div>
                ) : (
                  <p className="text-neutral-700 first-letter:uppercase">
                    {props.info.list.chapter.name}
                  </p>
                )}
                <Pencil
                  size={15}
                  className="text-neutral-600 hover:cursor-pointer"
                  onClick={() => setSelectedChapter(props.info.list.chapter.id)}
                />
              </div>
            </div>
            <MoreVertical size={15} className="text-gray-300" />
            <ConfirmationModal
              confirmationButtonText="Delete Chapter"
              confirmationMessage="Are you sure you want to delete this chapter?"
              dialogTitle={'Delete ' + props.info.list.chapter.name + ' ?'}
              dialogTrigger={
                <div
                  className=" hover:cursor-pointer p-1 px-4 bg-red-600 rounded-md shadow-sm flex space-x-1 items-center text-rose-100 text-sm"
                  rel="noopener noreferrer"
                >
                  <X size={15} className="text-rose-200 font-bold" />
                  <p>Delete Chapter</p>
                </div>
              }
              functionToExecute={() =>
                props.deleteChapter(props.info.list.chapter.id)
              }
              status="warning"
            ></ConfirmationModal>
          </div>
          <Droppable
            key={props.info.list.chapter.id}
            droppableId={String(props.info.list.chapter.id)}
            type="activity"
          >
            {(provided) => (
              <ActivitiesList
                {...provided.droppableProps}
                ref={provided.innerRef}
              >
                <div className="flex flex-col">
                  {props.info.list.activities.map(
                    (activity: any, index: any) => (
                      <Activity
                        orgslug={props.orgslug}
                        courseid={props.courseid}
                        key={activity.id}
                        activity={activity}
                        index={index}
                      ></Activity>
                    )
                  )}
                  {provided.placeholder}

                  <div
                    onClick={() => {
                      props.openNewActivityModal(props.info.list.chapter.id)
                    }}
                    className="flex space-x-2 items-center py-5 my-3 rounded-md justify-center text-white  bg-black  hover:cursor-pointer"
                  >
                    <Sparkles className="" size={17} />
                    <div className="text-sm mx-auto my-auto  items-center font-bold">
                      Add Activity +{' '}
                    </div>
                  </div>
                </div>
              </ActivitiesList>
            )}
          </Droppable>
        </ChapterWrapper>
      )}
    </Draggable>
  )
}

const ChapterWrapper = styled.div`
  margin-bottom: 20px;
  padding: 12px;
  font-size: 15px;
  display: block;
  border-radius: 9px;
  border: 1px solid rgba(255, 255, 255, 0.19);
  box-shadow: 0px 13px 33px -13px rgb(0 0 0 / 12%);
  transition: all 0.2s ease;
  h3 {
    padding-left: 20px;
    padding-right: 20px;
  }
`

const ActivitiesList = styled.div`
  padding: 10px;
`

export default Chapter



================================================
FILE: apps/web/components/Pages/CourseEdit/Draggables/data.ts
================================================
export const initialData = {
  activities: {
    'activity-1': { id: 'activity-1', content: 'First activity' },
    'activity-2': { id: 'activity-2', content: 'Second activity' },
    'activity-3': { id: 'activity-3', content: 'Third activity' },
    'activity-4': { id: 'activity-4', content: 'Fourth activity' },
    'activity-5': { id: 'activity-5', content: 'Fifth activity' },
  },
  chapters: {
    'chapter-1': {
      id: 'chapter-1',
      name: 'Chapter 1',
      activityIds: ['activity-1', 'activity-2', 'activity-3'],
    },
    'chapter-2': {
      id: 'chapter-2',
      name: 'Chapter 2',
      activityIds: ['activity-4'],
    },
    'chapter-3': {
      id: 'chapter-3',
      name: 'Chapter 3',
      activityIds: ['activity-5'],
    },
  },

  chapterOrder: ['chapter-1', 'chapter-2', 'chapter-3'],
}

export const initialData2 = {}



================================================
FILE: apps/web/components/Pages/Courses/ActivityIndicators.tsx
================================================
'use client'
import { BookOpenCheck, Check, FileText, Layers, Video, ChevronLeft, ChevronRight, Trophy } from 'lucide-react'
import React, { useMemo, memo, useState } from 'react'
import ToolTip from '@components/Objects/StyledElements/Tooltip/Tooltip'
import { getUriWithOrg } from '@services/config/config'
import Link from 'next/link'
import { useRouter } from 'next/navigation'

interface Props {
  course: any
  orgslug: string
  course_uuid: string
  current_activity?: string
  enableNavigation?: boolean
  trailData?: any
}

// Helper functions
function getActivityTypeLabel(activityType: string): string {
  switch (activityType) {
    case 'TYPE_VIDEO':
      return 'Video'
    case 'TYPE_DOCUMENT':
      return 'Document'
    case 'TYPE_DYNAMIC':
      return 'Interactive'
    case 'TYPE_ASSIGNMENT':
      return 'Assignment'
    default:
      return 'Unknown'
  }
}

function getActivityTypeBadgeColor(activityType: string): string {
  switch (activityType) {
    case 'TYPE_VIDEO':
      return 'bg-blue-100 text-blue-700'
    case 'TYPE_DOCUMENT':
      return 'bg-purple-100 text-purple-700'
    case 'TYPE_DYNAMIC':
      return 'bg-green-100 text-green-700'
    case 'TYPE_ASSIGNMENT':
      return 'bg-orange-100 text-orange-700'
    default:
      return 'bg-gray-100 text-gray-700'
  }
}

// Memoized activity type icon component
const ActivityTypeIcon = memo(({ activityType }: { activityType: string }) => {
  switch (activityType) {
    case 'TYPE_VIDEO':
      return <Video size={16} className="text-gray-400" />
    case 'TYPE_DOCUMENT':
      return <FileText size={16} className="text-gray-400" />
    case 'TYPE_DYNAMIC':
      return <Layers size={16} className="text-gray-400" />
    case 'TYPE_ASSIGNMENT':
      return <BookOpenCheck size={16} className="text-gray-400" />
    default:
      return <FileText size={16} className="text-gray-400" />
  }
});

ActivityTypeIcon.displayName = 'ActivityTypeIcon';

// Memoized activity tooltip content
const ActivityTooltipContent = memo(({ 
  activity, 
  isDone, 
  isCurrent 
}: { 
  activity: any, 
  isDone: boolean, 
  isCurrent: boolean 
}) => (
  <div className="bg-white rounded-lg nice-shadow py-3 px-4 min-w-[200px] animate-in fade-in duration-200">
    <div className="flex items-center gap-2">
      <ActivityTypeIcon activityType={activity.activity_type} />
      <span className="text-sm text-gray-700">{activity.name}</span>
      {isDone && (
        <span className="ml-auto text-gray-400">
          <Check size={14} />
        </span>
      )}
    </div>
    <div className="flex items-center gap-2 mt-2">
      <span className={`text-xs px-2 py-0.5 rounded-full ${getActivityTypeBadgeColor(activity.activity_type)}`}>
        {getActivityTypeLabel(activity.activity_type)}
      </span>
      <span className="text-xs text-gray-400">
        {isCurrent ? 'Current Activity' : isDone ? 'Completed' : 'Not Started'}
      </span>
    </div>
  </div>
));

ActivityTooltipContent.displayName = 'ActivityTooltipContent';

// Add new memoized component for chapter tooltip
const ChapterTooltipContent = memo(({ 
  chapter,
  chapterNumber,
  totalActivities,
  completedActivities 
}: { 
  chapter: any,
  chapterNumber: number,
  totalActivities: number,
  completedActivities: number
}) => (
  <div className="bg-white rounded-lg nice-shadow py-3 px-4 min-w-[200px] animate-in fade-in duration-200">
    <div className="flex items-center gap-2">
      <span className="text-sm font-medium text-gray-900">Chapter {chapterNumber}</span>
      <span className="text-xs bg-gray-100 px-2 py-0.5 rounded-full text-gray-600">
        {completedActivities}/{totalActivities} completed
      </span>
    </div>
    <div className="mt-1">
      <span className="text-sm text-gray-700">{chapter.name}</span>
    </div>
  </div>
));

ChapterTooltipContent.displayName = 'ChapterTooltipContent';

// Add certification badge component
const CertificationBadge = memo(({ 
  courseid,
  orgslug,
  isCompleted 
}: { 
  courseid: string,
  orgslug: string,
  isCompleted: boolean 
}) => (
  <ToolTip
    sideOffset={8}
    unstyled
    content={
      <div className="bg-white rounded-lg nice-shadow py-3 px-4 min-w-[200px] animate-in fade-in duration-200">
        <div className="flex items-center gap-2">
          <Trophy size={16} className="text-yellow-500" />
          <span className="text-sm font-medium text-gray-900">
            {isCompleted ? 'Course Completed!' : 'Course Completion'}
          </span>
        </div>
        <div className="mt-1">
          <span className="text-sm text-gray-700">
            {isCompleted 
              ? 'View your completion certificate' 
              : 'Complete all activities to unlock your certificate'
            }
          </span>
        </div>
      </div>
    }
  >
    <Link
      href={`${getUriWithOrg(orgslug, '')}/course/${courseid}/activity/end`}
      prefetch={false}
      className={`mx-2 h-[20px] flex items-center cursor-pointer focus:outline-none transition-all ${
        isCompleted ? 'opacity-100' : 'opacity-50 cursor-not-allowed'
      }`}
    >
      <div className={`w-[20px] h-[20px] rounded-full flex items-center justify-center text-xs font-medium transition-colors ${
        isCompleted 
          ? 'bg-yellow-500 text-white hover:bg-yellow-600' 
          : 'bg-gray-100 text-gray-400'
      }`}>
        <Trophy size={12} />
      </div>
    </Link>
  </ToolTip>
));

CertificationBadge.displayName = 'CertificationBadge';

function ActivityIndicators(props: Props) {
  const course = props.course
  const orgslug = props.orgslug
  const courseid = props.course_uuid.replace('course_', '')
  const enableNavigation = props.enableNavigation || false
  const router = useRouter()

  const [currentIndex, setCurrentIndex] = useState(0)

  const done_activity_style = 'bg-teal-600 hover:bg-teal-700'
  const black_activity_style = 'bg-zinc-300 hover:bg-zinc-400'
  const current_activity_style = 'bg-gray-600 animate-pulse hover:bg-gray-700'

  // Flatten all activities for navigation and rendering
  const allActivities = useMemo(() => {
    return course.chapters.flatMap((chapter: any) => 
      chapter.activities.map((activity: any) => ({
        ...activity,
        chapterId: chapter.id
      }))
    )
  }, [course.chapters])

  // Find current activity index
  const currentActivityIndex = useMemo(() => {
    if (!props.current_activity) return -1
    return allActivities.findIndex((activity: any) => 
      activity.activity_uuid.replace('activity_', '') === props.current_activity
    )
  }, [allActivities, props.current_activity])

  // Memoize activity status checks
  const isActivityDone = useMemo(() => (activity: any) => {
    // Clean up course UUID by removing 'course_' prefix if it exists
    const cleanCourseUuid = course.course_uuid?.replace('course_', '');
    
    let run = props.trailData?.runs?.find(
      (run: any) => {
        const cleanRunCourseUuid = run.course?.course_uuid?.replace('course_', '');
        return cleanRunCourseUuid === cleanCourseUuid;
      }
    );

    if (run) {
      return run.steps.find(
        (step: any) => step.activity_id === activity.id && step.complete === true
      );
    }
    return false;
  }, [props.trailData, course.course_uuid]);

  const isActivityCurrent = useMemo(() => (activity: any) => {
    let activity_uuid = activity.activity_uuid.replace('activity_', '')
    if (props.current_activity && props.current_activity == activity_uuid) {
      return true
    }
    return false
  }, [props.current_activity]);

  const getActivityClass = useMemo(() => (activity: any) => {
    const isCurrent = isActivityCurrent(activity)
    if (isActivityDone(activity)) {
      return `${done_activity_style}`
    }
    if (isCurrent) {
      return `${current_activity_style} border-2 border-gray-800 animate-pulse`
    }
    return `${black_activity_style}`
  }, [isActivityDone, isActivityCurrent]);

  // Keep the allActivities array for navigation purposes only
  const navigateToPrevious = () => {
    if (currentActivityIndex > 0) {
      const prevActivity = allActivities[currentActivityIndex - 1]
      const activityId = prevActivity.activity_uuid.replace('activity_', '')
      router.push(getUriWithOrg(orgslug, '') + `/course/${courseid}/activity/${activityId}`)
    }
  }

  const navigateToNext = () => {
    if (currentActivityIndex < allActivities.length - 1) {
      const nextActivity = allActivities[currentActivityIndex + 1]
      const activityId = nextActivity.activity_uuid.replace('activity_', '')
      router.push(getUriWithOrg(orgslug, '') + `/course/${courseid}/activity/${activityId}`)
    }
  }

  // Add function to count completed activities in a chapter
  const getChapterProgress = useMemo(() => (chapterActivities: any[]) => {
    return chapterActivities.reduce((acc, activity) => {
      return acc + (isActivityDone(activity) ? 1 : 0)
    }, 0)
  }, [isActivityDone]);

  // Check if all activities are completed
  const isCourseCompleted = useMemo(() => {
    const totalActivities = allActivities.length;
    const completedActivities = allActivities.filter((activity: any) => isActivityDone(activity)).length;
    return totalActivities > 0 && completedActivities === totalActivities;
  }, [allActivities, isActivityDone]);

  return (
    <div className="flex items-center gap-4">
      {enableNavigation && (
        <button
          onClick={navigateToPrevious}
          disabled={currentActivityIndex <= 0}
          className="p-1 rounded-full hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex-shrink-0"
          aria-label="Previous activity"
        >
          <ChevronLeft size={20} className="text-gray-600" />
        </button>
      )}
      
      <div className="flex items-center w-full">
        {course.chapters.map((chapter: any, chapterIndex: number) => {
          const completedActivities = getChapterProgress(chapter.activities);
          const isChapterComplete = completedActivities === chapter.activities.length;
          const firstActivity = chapter.activities[0];
          const firstActivityId = firstActivity?.activity_uuid?.replace('activity_', '');
          const chapterLinkHref =
            firstActivityId
              ? getUriWithOrg(orgslug, '') + `/course/${courseid}/activity/${firstActivityId}`
              : undefined;

          return (
            <React.Fragment key={chapter.id}>
              <ToolTip
                sideOffset={8}
                unstyled
                content={
                  <ChapterTooltipContent 
                    chapter={chapter}
                    chapterNumber={chapterIndex + 1}
                    totalActivities={chapter.activities.length}
                    completedActivities={completedActivities}
                  />
                }
              >
                {chapterLinkHref ? (
                  <Link href={chapterLinkHref} prefetch={false} className="mx-2 h-[20px] flex items-center cursor-pointer focus:outline-none">
                    <div className={`w-[20px] h-[20px] rounded-full flex items-center justify-center text-xs font-medium transition-colors ${
                      isChapterComplete 
                        ? 'bg-teal-600 text-white' 
                        : 'bg-gray-100 text-gray-600'
                    }`}>
                      {chapterIndex + 1}
                    </div>
                  </Link>
                ) : (
                  <div className="mx-2 h-[20px] flex items-center cursor-not-allowed">
                    <div className={`w-[20px] h-[20px] rounded-full flex items-center justify-center text-xs font-medium transition-colors ${
                      isChapterComplete 
                        ? 'bg-teal-600 text-white' 
                        : 'bg-gray-100 text-gray-600'
                    }`}>
                      {chapterIndex + 1}
                    </div>
                  </div>
                )}
              </ToolTip>
              <div className="flex-1 flex items-center">
                {chapter.activities.map((activity: any) => {
                  const isDone = isActivityDone(activity)
                  const isCurrent = isActivityCurrent(activity)
                  return (
                    <ToolTip
                      sideOffset={8}
                      unstyled
                      content={
                        <ActivityTooltipContent 
                          activity={activity}
                          isDone={isDone}
                          isCurrent={isCurrent}
                        />
                      }
                      key={activity.activity_uuid}
                    >
                      <Link
                        prefetch={false}
                        href={
                          getUriWithOrg(orgslug, '') +
                          `/course/${courseid}/activity/${activity.activity_uuid.replace(
                            'activity_',
                            ''
                          )}`
                        }
                        className={`${isCurrent ? 'flex-[2]' : 'flex-1'} mx-1`}
                      >
                        <div
                          className={`h-[7px] ${getActivityClass(activity)} rounded-lg transition-all`}
                        ></div>
                      </Link>
                    </ToolTip>
                  )
                })}
              </div>
            </React.Fragment>
          )
        })}
        
        {/* Certification Badge */}
        <CertificationBadge 
          courseid={courseid}
          orgslug={orgslug}
          isCompleted={isCourseCompleted}
        />
      </div>

      {enableNavigation && (
        <button
          onClick={navigateToNext}
          disabled={currentActivityIndex >= allActivities.length - 1}
          className="p-1 rounded-full hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex-shrink-0"
          aria-label="Next activity"
        >
          <ChevronRight size={20} className="text-gray-600" />
        </button>
      )}
    </div>
  )
}

export default memo(ActivityIndicators)



================================================
FILE: apps/web/components/Pages/Courses/CourseBreadcrumbs.tsx
================================================
import { Book, ChevronRight } from 'lucide-react'
import Link from 'next/link'
import { getUriWithOrg } from '@services/config/config'
import React from 'react'

interface CourseBreadcrumbsProps {
  course: any
  orgslug: string
}

export default function CourseBreadcrumbs({ course, orgslug }: CourseBreadcrumbsProps) {
  const cleanCourseUuid = course.course_uuid?.replace('course_', '')

  return (
    <div className="text-gray-400 tracking-tight font-medium text-sm flex space-x-1 pt-2">
      <div className="flex items-center space-x-1">
        <div className="flex space-x-2 items-center">
          <Book className="text-gray" size={14} />
          <Link href={getUriWithOrg(orgslug, '') + `/courses`}>
            Courses
          </Link>
        </div>
        <ChevronRight size={14} />
        <div className="first-letter:uppercase">
          {course.name}
        </div>
      </div>
    </div>
  )
} 


================================================
FILE: apps/web/components/Pages/Payments/UnconfiguredPaymentsDisclaimer.tsx
================================================
import {  Settings, ChevronRight, CreditCard } from 'lucide-react'
import { Alert, AlertTitle, AlertDescription } from '@components/ui/alert'
import { AlertTriangle, ShoppingCart, Users } from 'lucide-react'
import React from 'react'
import Link from 'next/link'

function UnconfiguredPaymentsDisclaimer() {
  return (
    <div className="h-full w-full bg-[#f8f8f8]">
        <div className="ml-10 mr-10 mx-auto">
          <Alert className="mb-3 p-6 border-2 border-yellow-200 bg-yellow-100/50 light-shadow">
            <AlertTitle className="text-lg font-semibold mb-2 flex items-center space-x-2">
              <AlertTriangle className="h-5 w-5" />
              <span>Payments not yet properly configured</span>
            </AlertTitle>
            <AlertDescription className="space-y-5">
              <div className="pl-2">
                <ul className="list-disc list-inside space-y-1 text-gray-600 pl-2">
                  <li className="flex items-center space-x-2">
                    <CreditCard className="h-4 w-4" />
                    <span>Configure Stripe to start accepting payments</span>
                  </li>
                  <li className="flex items-center space-x-2">
                    <ShoppingCart className="h-4 w-4" />
                    <span>Create and manage products</span>
                  </li>
                  <li className="flex items-center space-x-2">
                    <Users className="h-4 w-4" />
                    <span>Start selling to your customers</span>
                  </li>
                </ul>
              </div>
              <Link
                href="./configuration" 
                className="text-yellow-900 hover:text-yellow-700 inline-flex items-center font-medium transition-colors duration-200 pl-2"
              >
                <Settings className="h-4 w-4 mr-1.5" />
                Go to Payment Configuration
                <ChevronRight className="ml-1.5 h-4 w-4" />
              </Link>
            </AlertDescription>
          </Alert>
        </div>
      </div>
  )
}

export default UnconfiguredPaymentsDisclaimer


================================================
FILE: apps/web/components/Pages/Trail/TrailCourseElement.tsx
================================================
'use client'
import { useOrg } from '@components/Contexts/OrgContext'
import { getAPIUrl, getUriWithOrg } from '@services/config/config'
import { removeCourse } from '@services/courses/activity'
import { getCourseThumbnailMediaDirectory } from '@services/media/media'
import { revalidateTags } from '@services/utils/ts/requests'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { getUserCertificates } from '@services/courses/certifications'
import Link from 'next/link'
import { useRouter } from 'next/navigation'
import { useEffect, useState } from 'react'
import { mutate } from 'swr'
import { Award, ExternalLink } from 'lucide-react'

interface TrailCourseElementProps {
  course: any
  run: any
  orgslug: string
}

function TrailCourseElement(props: TrailCourseElementProps) {
  const org = useOrg() as any
  const session = useLHSession() as any;
  const access_token = session?.data?.tokens?.access_token;
  const courseid = props.course.course_uuid.replace('course_', '')
  const course = props.course
  const router = useRouter()
  const course_total_steps = props.run.course_total_steps
  const course_completed_steps = props.run.steps.length
  const orgID = org?.id
  const course_progress = Math.round(
    (course_completed_steps / course_total_steps) * 100
  )
  
  const [courseCertificate, setCourseCertificate] = useState<any>(null)
  const [isLoadingCertificate, setIsLoadingCertificate] = useState(false)

  async function quitCourse(course_uuid: string) {
    // Close activity
    let activity = await removeCourse(course_uuid, props.orgslug,access_token)
    // Mutate course
    await revalidateTags(['courses'], props.orgslug)
    router.refresh()

    // Mutate
    mutate(`${getAPIUrl()}trail/org/${orgID}/trail`)
  }

  // Fetch certificate for this course
  useEffect(() => {
    const fetchCourseCertificate = async () => {
      if (!access_token || course_progress < 100) return;
      
      setIsLoadingCertificate(true);
      try {
        const result = await getUserCertificates(
          props.course.course_uuid,
          access_token
        );
        
        if (result.success && result.data && result.data.length > 0) {
          setCourseCertificate(result.data[0]);
        }
      } catch (error) {
        console.error('Error fetching course certificate:', error);
      } finally {
        setIsLoadingCertificate(false);
      }
    };

    fetchCourseCertificate();
  }, [access_token, course_progress, props.course.course_uuid]);

  useEffect(() => {}, [props.course, org])

  return (
    <div
      className="trailcoursebox flex p-3 bg-white rounded-xl"
      style={{ boxShadow: '0px 4px 7px 0px rgba(0, 0, 0, 0.03)' }}
    >
      <Link href={getUriWithOrg(props.orgslug, '/course/' + courseid)}>
        <div
          className="course_tumbnail inset-0 ring-1 ring-inset ring-black/10 rounded-lg relative h-[50px] w-[72px] bg-cover bg-center"
          style={{
            backgroundImage: `url(${getCourseThumbnailMediaDirectory(
              org.org_uuid,
              props.course.course_uuid,
              props.course.thumbnail_image
            )})`,
            boxShadow: '0px 4px 7px 0px rgba(0, 0, 0, 0.03)',
          }}
        ></div>
      </Link>
      <div className="course_meta pl-5 grow space-y-1">
        <div className="course_top">
          <div className="course_info flex">
            <div className="course_basic flex flex-col flex-end -space-y-2">
              <p className="p-0 font-bold text-sm text-gray-700">Course</p>
              <div className="course_progress flex items-center space-x-2">
                <h2 className="font-bold text-xl">{course.name}</h2>
                <div className="bg-slate-300 rounded-full w-[10px] h-[5px]"></div>
                <h2>{course_progress}%</h2>
              </div>
            </div>
            <div className="course_actions grow flex flex-row-reverse">
              <button
                onClick={() => quitCourse(course.course_uuid)}
                className="bg-red-200 text-red-700 hover:bg-red-300  rounded-full text-xs h-5 px-2 font-bold"
              >
                Quit Course
              </button>
            </div>
          </div>
        </div>
        <div className="course_progress indicator w-full">
          <div className="w-full bg-gray-200 rounded-full h-1.5 ">
            <div
              className={`bg-teal-600 h-1.5 rounded-full`}
              style={{ width: `${course_progress}%` }}
            ></div>
          </div>
        </div>
        
        {/* Certificate Section */}
        {course_progress === 100 && (
          <div className="mt-2 pt-2 border-t border-gray-100">
            {isLoadingCertificate ? (
              <div className="flex items-center space-x-1 text-xs text-gray-500">
                <div className="animate-spin rounded-full h-3 w-3 border-b-2 border-yellow-500"></div>
                <span>Loading...</span>
              </div>
            ) : courseCertificate ? (
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-1">
                  <Award className="w-3 h-3 text-yellow-500" />
                  <span className="text-xs font-medium text-gray-700">
                    Certificate
                  </span>
                </div>
                <Link
                  href={getUriWithOrg(props.orgslug, `/certificates/${courseCertificate.certificate_user.user_certification_uuid}/verify`)}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="inline-flex items-center space-x-1 text-blue-600 hover:text-blue-700 text-xs font-medium"
                >
                  <span>Verify</span>
                  <ExternalLink className="w-3 h-3" />
                </Link>
              </div>
            ) : (
              <div className="flex items-center space-x-1 text-xs text-gray-500">
                <Award className="w-3 h-3 text-gray-300" />
                <span>No certificate</span>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  )
}

export default TrailCourseElement



================================================
FILE: apps/web/components/Pages/Trail/UserCertificates.tsx
================================================
'use client'

import React from 'react'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { useOrg } from '@components/Contexts/OrgContext'
import { getUriWithOrg } from '@services/config/config'
import { Award, ExternalLink, Calendar, Hash, Building } from 'lucide-react'
import Link from 'next/link'
import useSWR from 'swr'
import { swrFetcher } from '@services/utils/ts/requests'
import { getAPIUrl } from '@services/config/config'

interface UserCertificatesProps {
  orgslug: string
}

const UserCertificates: React.FC<UserCertificatesProps> = ({ orgslug }) => {
  const session = useLHSession() as any
  const access_token = session?.data?.tokens?.access_token
  const org = useOrg() as any

  const { data: certificates, error, isLoading } = useSWR(
    access_token ? `${getAPIUrl()}certifications/user/all` : null,
    (url) => swrFetcher(url, access_token)
  )

  if (isLoading) {
    return (
      <div className="bg-white rounded-xl shadow-sm p-6">
        <div className="flex items-center space-x-3 mb-4">
          <Award className="w-6 h-6 text-yellow-500" />
          <h2 className="text-xl font-semibold text-gray-900">My Certificates</h2>
        </div>
        <div className="animate-pulse space-y-4">
          {[1, 2, 3].map((i) => (
            <div key={i} className="bg-gray-100 h-20 rounded-lg"></div>
          ))}
        </div>
      </div>
    )
  }

  if (error) {
    return (
      <div className="bg-white rounded-xl shadow-sm p-6">
        <div className="flex items-center space-x-3 mb-4">
          <Award className="w-6 h-6 text-yellow-500" />
          <h2 className="text-xl font-semibold text-gray-900">My Certificates</h2>
        </div>
        <div className="text-center py-8">
          <p className="text-gray-500">Failed to load certificates</p>
        </div>
      </div>
    )
  }

  // Handle the actual API response structure - certificates are returned as an array directly
  const certificatesData = Array.isArray(certificates) ? certificates : certificates?.data || []

  if (!certificatesData || certificatesData.length === 0) {
    return (
      <div className="bg-white rounded-xl shadow-sm p-6">
        <div className="flex items-center space-x-3 mb-4">
          <Award className="w-6 h-6 text-yellow-500" />
          <h2 className="text-xl font-semibold text-gray-900">My Certificates</h2>
        </div>
        <div className="text-center py-8">
          <Award className="w-12 h-12 text-gray-300 mx-auto mb-3" />
          <p className="text-gray-500">No certificates earned yet</p>
          <p className="text-sm text-gray-400 mt-1">Complete courses to earn certificates</p>
        </div>
      </div>
    )
  }

  return (
    <div className="bg-white rounded-xl shadow-sm p-6">
      <div className="flex items-center space-x-3 mb-6">
        <Award className="w-6 h-6 text-yellow-500" />
        <h2 className="text-xl font-semibold text-gray-900">My Certificates</h2>
        <span className="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
          {certificatesData.length}
        </span>
      </div>
      
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {certificatesData.map((certificate: any) => {
          const verificationLink = getUriWithOrg(orgslug, `/certificates/${certificate.certificate_user.user_certification_uuid}/verify`)
          const awardedDate = new Date(certificate.certificate_user.created_at).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          })

          return (
            <div key={certificate.certificate_user.user_certification_uuid} className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
              <div className="space-y-3">
                <div className="flex items-center space-x-2">
                  <Award className="w-4 h-4 text-yellow-500" />
                  <h3 className="font-semibold text-gray-900 text-sm truncate">
                    {certificate.certification.config.certification_name}
                  </h3>
                </div>
                
                <div className="space-y-2 text-xs text-gray-600">
                  <div className="flex items-center space-x-2">
                    <Building className="w-3 h-3" />
                    <span className="truncate">{certificate.course.name}</span>
                  </div>
                  
                  <div className="flex items-center space-x-2">
                    <Calendar className="w-3 h-3" />
                    <span>Awarded {awardedDate}</span>
                  </div>
                  
                  <div className="flex items-center space-x-2">
                    <Hash className="w-3 h-3" />
                    <span className="font-mono text-xs bg-gray-100 px-2 py-1 rounded truncate">
                      {certificate.certificate_user.user_certification_uuid}
                    </span>
                  </div>
                </div>
                
                <div className="flex items-center justify-between pt-2 border-t border-gray-100">
                  <div className="text-xs text-gray-500 capitalize">
                    {certificate.certification.config.certification_type.replace('_', ' ')}
                  </div>
                  <Link
                    href={verificationLink}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="inline-flex items-center space-x-1 text-blue-600 hover:text-blue-700 text-xs font-medium"
                  >
                    <span>Verify</span>
                    <ExternalLink className="w-3 h-3" />
                  </Link>
                </div>
              </div>
            </div>
          )
        })}
      </div>
    </div>
  )
}

export default UserCertificates 


================================================
FILE: apps/web/components/Security/AdminAuthorization.tsx
================================================
'use client';
import React, { useEffect, useState, useCallback, useMemo } from 'react';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import useAdminStatus from '@components/Hooks/useAdminStatus';
import { usePathname, useRouter } from 'next/navigation';
import PageLoading from '@components/Objects/Loaders/PageLoading';
import { getUriWithoutOrg } from '@services/config/config';
import { useOrg } from '@components/Contexts/OrgContext';

type AuthorizationProps = {
  children: React.ReactNode;
  authorizationMode: 'component' | 'page';
};

const ADMIN_PATHS = [
  '/dash/org/*',
  '/dash/org',
  '/dash/users/*',
  '/dash/users',
  '/dash/courses/*',
  '/dash/courses',
  '/dash/org/settings/general',
];

const AdminAuthorization: React.FC<AuthorizationProps> = ({ children, authorizationMode }) => {
  const session = useLHSession() as any;
  const org = useOrg() as any;
  const pathname = usePathname();
  const router = useRouter();
  const { isAdmin, loading } = useAdminStatus() as any
  const [isAuthorized, setIsAuthorized] = useState(false);

  const isUserAuthenticated = useMemo(() => session.status === 'authenticated', [session.status]);

  const checkPathname = useCallback((pattern: string, pathname: string) => {
    // Ensure the inputs are strings
    if (typeof pattern !== 'string' || typeof pathname !== 'string') {
      return false;
    }

    // Convert pattern to a regex pattern
    const regexPattern = new RegExp(`^${pattern.replace(/[\/.*+?^${}()|[\]\\]/g, '\\$&').replace(/\\\*/g, '.*')}$`);

    // Test the pathname against the regex pattern
    return regexPattern.test(pathname);
  }, []);


  const isAdminPath = useMemo(() => ADMIN_PATHS.some(path => checkPathname(path, pathname)), [pathname, checkPathname]);

  const authorizeUser = useCallback(() => {
    if (loading) {
      return; // Wait until the admin status is determined
    }

    if (!isUserAuthenticated) {
      router.push(getUriWithoutOrg('/login?orgslug=' + org.slug));
      return;
    }

    if (authorizationMode === 'page') {
      if (isAdminPath) {
        if (isAdmin) {
          setIsAuthorized(true);
        } else {
          setIsAuthorized(false);
          router.push('/dash');
        }
      } else {
        setIsAuthorized(true);
      }
    } else if (authorizationMode === 'component') {
      setIsAuthorized(isAdmin);
    }
  }, [loading, isUserAuthenticated, isAdmin, isAdminPath, authorizationMode, router]);

  useEffect(() => {
    authorizeUser();
  }, [authorizeUser]);

  if (loading) {
    return (
      <div className="flex justify-center items-center h-screen">
        <PageLoading />
      </div>
    );
  }

  if (authorizationMode === 'page' && !isAuthorized) {
    return (
      <div className="flex justify-center items-center h-screen">
        <h1 className="text-2xl">You are not authorized to access this page</h1>
      </div>
    );
  }

  return <>{isAuthorized && children}</>;
};

export default AdminAuthorization;



================================================
FILE: apps/web/components/Security/AuthenticatedClientElement.tsx
================================================
'use client'
import React from 'react'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { useOrg } from '@components/Contexts/OrgContext'

interface AuthenticatedClientElementProps {
  children: React.ReactNode
  checkMethod: 'authentication' | 'roles'
  orgId?: string
  ressourceType?:
  | 'collections'
  | 'courses'
  | 'activities'
  | 'users'
  | 'organizations'
  action?: 'create' | 'update' | 'delete' | 'read'
}

export const AuthenticatedClientElement = (
  props: AuthenticatedClientElementProps
) => {
  const [isAllowed, setIsAllowed] = React.useState(false)
  const session = useLHSession() as any
  const org = useOrg() as any

  function isUserAllowed(
    roles: any[],
    action: string,
    resourceType: string,
    org_uuid: string
  ): boolean {
    // Iterate over the user's roles
    for (const role of roles) {
      // Check if the role is for the right organization
      if (role.org.org_uuid === org_uuid) {
        // Check if the user has the role for the resource type
        if (role.role.rights && role.role.rights[resourceType]) {
          // Check if the user is allowed to execute the action
          const actionKey = `action_${action}`
          if (role.role.rights[resourceType][actionKey] === true) {
            return true
          }
        }
      }
    }

    // If no role matches the organization, resource type, and action, return false
    return false
  }

  function check() {
    if (session.status == 'unauthenticated') {
      setIsAllowed(false)
      return
    } else {
      if (props.checkMethod === 'authentication') {
        setIsAllowed(session.status == 'authenticated')
      } else if (props.checkMethod === 'roles' ) {
        return setIsAllowed(
          isUserAllowed(
            session?.data?.roles,
            props.action!,
            props.ressourceType!,
            org?.org_uuid
          )
        )
      }
    }
  }

  React.useEffect(() => {
    if (session.status == 'loading') {
      return
    }

    check()
  }, [session.data, org])

  return <>{isAllowed && props.children}</>
}

export default AuthenticatedClientElement



================================================
FILE: apps/web/components/Security/HeaderProfileBox.tsx
================================================
'use client'
import React, { useEffect, useMemo } from 'react'
import styled from 'styled-components'
import Link from 'next/link'
import { Package2, Crown, Shield, User, Users, LogOut, User as UserIcon, ChevronDown } from 'lucide-react'
import UserAvatar from '@components/Objects/UserAvatar'
import useAdminStatus from '@components/Hooks/useAdminStatus'
import { useLHSession } from '@components/Contexts/LHSessionContext'
import { useOrg } from '@components/Contexts/OrgContext'
import { getUriWithoutOrg } from '@services/config/config'
import Tooltip from '@components/Objects/StyledElements/Tooltip/Tooltip'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@components/ui/dropdown-menu"
import { signOut } from 'next-auth/react'

interface RoleInfo {
  name: string;
  icon: React.ReactNode;
  bgColor: string;
  textColor: string;
  description: string;
}

interface CustomRoleInfo {
  name: string;
  description?: string;
}

export const HeaderProfileBox = () => {
  const session = useLHSession() as any
  const { isAdmin, loading, userRoles, rights } = useAdminStatus()
  const org = useOrg() as any

  useEffect(() => { }
    , [session])

  const userRoleInfo = useMemo((): RoleInfo | null => {
    if (!userRoles || userRoles.length === 0) return null;

    // Find the highest priority role for the current organization
    const orgRoles = userRoles.filter((role: any) => role.org.id === org?.id);
    
    if (orgRoles.length === 0) return null;

    // Sort by role priority (admin > maintainer > instructor > user)
    const sortedRoles = orgRoles.sort((a: any, b: any) => {
      const getRolePriority = (role: any) => {
        if (role.role.role_uuid === 'role_global_admin' || role.role.id === 1) return 4;
        if (role.role.role_uuid === 'role_global_maintainer' || role.role.id === 2) return 3;
        if (role.role.role_uuid === 'role_global_instructor' || role.role.id === 3) return 2;
        return 1;
      };
      return getRolePriority(b) - getRolePriority(a);
    });

    const highestRole = sortedRoles[0];

    // Define role configurations based on actual database roles
    const roleConfigs: { [key: string]: RoleInfo } = {
      'role_global_admin': {
        name: 'ADMIN',
        icon: <Crown size={12} />,
        bgColor: 'bg-purple-600',
        textColor: 'text-white',
        description: 'Full platform control with all permissions'
      },
      'role_global_maintainer': {
        name: 'MAINTAINER',
        icon: <Shield size={12} />,
        bgColor: 'bg-blue-600',
        textColor: 'text-white',
        description: 'Mid-level manager with wide permissions'
      },
      'role_global_instructor': {
        name: 'INSTRUCTOR',
        icon: <Users size={12} />,
        bgColor: 'bg-green-600',
        textColor: 'text-white',
        description: 'Can manage their own content'
      },
      'role_global_user': {
        name: 'USER',
        icon: <User size={12} />,
        bgColor: 'bg-gray-500',
        textColor: 'text-white',
        description: 'Read-Only Learner'
      }
    };

    // Determine role based on role_uuid or id
    let roleKey = 'role_global_user'; // default
    if (highestRole.role.role_uuid) {
      roleKey = highestRole.role.role_uuid;
    } else if (highestRole.role.id === 1) {
      roleKey = 'role_global_admin';
    } else if (highestRole.role.id === 2) {
      roleKey = 'role_global_maintainer';
    } else if (highestRole.role.id === 3) {
      roleKey = 'role_global_instructor';
    }

    return roleConfigs[roleKey] || roleConfigs['role_global_user'];
  }, [userRoles, org?.id]);

  const customRoles = useMemo((): CustomRoleInfo[] => {
    if (!userRoles || userRoles.length === 0) return [];

    // Find roles for the current organization
    const orgRoles = userRoles.filter((role: any) => role.org.id === org?.id);
    
    if (orgRoles.length === 0) return [];

    // Filter for custom roles (not system roles)
    const customRoles = orgRoles.filter((role: any) => {
      // Check if it's a system role
      const isSystemRole = 
        role.role.role_uuid?.startsWith('role_global_') ||
        [1, 2, 3, 4].includes(role.role.id) ||
        ['Admin', 'Maintainer', 'Instructor', 'User'].includes(role.role.name);
      
      return !isSystemRole;
    });

    return customRoles.map((role: any) => ({
      name: role.role.name || 'Custom Role',
      description: role.role.description
    }));
  }, [userRoles, org?.id]);

  return (
    <ProfileArea>
      {session.status == 'unauthenticated' && (
        <UnidentifiedArea className="flex text-sm text-gray-700 font-bold p-1.5 px-2 rounded-lg">
          <ul className="flex space-x-3 items-center">
            <li>
              <Link
                href={{ pathname: getUriWithoutOrg('/login'), query: org ? { orgslug: org.slug } : null }} >Login</Link>
            </li>
            <li className="bg-black rounded-lg shadow-md p-2 px-3 text-white">
              <Link href={{ pathname: getUriWithoutOrg('/signup'), query: org ? { orgslug: org.slug } : null }}>Sign up</Link>
            </li>
          </ul>
        </UnidentifiedArea>
      )}
      {session.status == 'authenticated' && (
        <AccountArea className="space-x-0">
          <div className="flex items-center space-x-3">
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <button className="cursor-pointer flex items-center space-x-3 hover:bg-gray-50 rounded-lg p-2 transition-colors">
                  <UserAvatar border="border-2" rounded="rounded-lg" width={30} />
                  <div className="flex flex-col space-y-0">
                    <div className="flex items-center space-x-2">
                      <p className='text-sm font-semibold text-gray-900 capitalize'>{session.data.user.username}</p>
                      {userRoleInfo && userRoleInfo.name !== 'USER' && (
                        <Tooltip 
                          content={userRoleInfo.description}
                          sideOffset={15}
                          side="bottom"
                        >
                          <div className={`text-[6px] ${userRoleInfo.bgColor} ${userRoleInfo.textColor} px-1 py-0.5 font-medium rounded-full flex items-center gap-0.5 w-fit`}>
                            {userRoleInfo.icon}
                            {userRoleInfo.name}
                          </div>
                        </Tooltip>
                      )}
                      {/* Custom roles */}
                      {customRoles.map((customRole, index) => (
                        <Tooltip 
                          key={index}
                          content={customRole.description || `Custom role: ${customRole.name}`}
                          sideOffset={15}
                          side="bottom"
                        >
                          <div className="text-[6px] bg-gray-500 text-white px-1 py-0.5 font-medium rounded-full flex items-center gap-0.5 w-fit">
                            <Shield size={12} />
                            {customRole.name}
                          </div>
                        </Tooltip>
                      ))}
                    </div>
                    <p className='text-xs text-gray-500'>{session.data.user.email}</p>
                  </div>
                  <ChevronDown size={16} className="text-gray-500" />
                </button>
              </DropdownMenuTrigger>
              <DropdownMenuContent className="w-56" align="end">
                <DropdownMenuLabel>
                  <div className="flex items-center space-x-2">
                    <UserAvatar border="border-2" rounded="rounded-full" width={24} />
                    <div>
                      <p className="text-sm font-medium">{session.data.user.username}</p>
                      <p className="text-xs text-gray-500 capitalize">{session.data.user.email}</p>
                    </div>
                  </div>
                </DropdownMenuLabel>
                <DropdownMenuSeparator />
                {rights?.dashboard?.action_access && (
                  <DropdownMenuItem asChild>
                    <Link href="/dash" className="flex items-center space-x-2">
                      <Shield size={16} />
                      <span>Dashboard</span>
                    </Link>
                  </DropdownMenuItem>
                )}
                <DropdownMenuItem asChild>
                  <Link href="/dash/user-account/settings/general" className="flex items-center space-x-2">
                    <UserIcon size={16} />
                    <span>User Settings</span>
                  </Link>
                </DropdownMenuItem>
                <DropdownMenuItem asChild>
                  <Link href="/dash/user-account/owned" className="flex items-center space-x-2">
                    <Package2 size={16} />
                    <span>My Courses</span>
                  </Link>
                </DropdownMenuItem>
                <DropdownMenuSeparator />
                <DropdownMenuItem 
                  onClick={() => signOut({ callbackUrl: '/' })}
                  className="flex items-center space-x-2 text-red-600 focus:text-red-600"
                >
                  <LogOut size={16} />
                  <span>Sign Out</span>
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </div>
        </AccountArea>
      )}
    </ProfileArea>
  )
}

const AccountArea = styled.div`
  display: flex;
  place-items: center;

  img {
    width: 29px;
  }
`

const ProfileArea = styled.div`
  display: flex;
  place-items: stretch;
  place-items: center;
`

const UnidentifiedArea = styled.div`
  display: flex;
  place-items: stretch;
  grow: 1;
`



================================================
FILE: apps/web/components/ui/alert.tsx
================================================
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground [&>svg~*]:pl-7",
  {
    variants: {
      variant: {
        default: "bg-background text-foreground",
        destructive:
          "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Alert = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
>(({ className, variant, ...props }, ref) => (
  <div
    ref={ref}
    role="alert"
    className={cn(alertVariants({ variant }), className)}
    {...props}
  />
))
Alert.displayName = "Alert"

const AlertTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h5
    ref={ref}
    className={cn("mb-1 font-medium leading-none tracking-tight", className)}
    {...props}
  />
))
AlertTitle.displayName = "AlertTitle"

const AlertDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm [&_p]:leading-relaxed", className)}
    {...props}
  />
))
AlertDescription.displayName = "AlertDescription"

export { Alert, AlertTitle, AlertDescription }



================================================
FILE: apps/web/components/ui/badge.tsx
================================================
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-hidden focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground shadow-sm hover:bg-primary/80",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive:
          "border-transparent bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  )
}

export { Badge, badgeVariants }



================================================
FILE: apps/web/components/ui/button.tsx
================================================
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none hover:cursor-pointer cursor-pointer [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground shadow-sm hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground shadow-xs hover:bg-destructive/90",
        outline:
          "border border-input bg-background shadow-xs hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2",
        sm: "h-8 rounded-md px-3 text-xs",
        lg: "h-10 rounded-md px-8",
        icon: "h-9 w-9",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }



================================================
FILE: apps/web/components/ui/checkbox.tsx
================================================
"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { CheckIcon } from "@radix-ui/react-icons"

import { cn } from "@/lib/utils"

const Checkbox = React.forwardRef<
  React.ElementRef<typeof CheckboxPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      "peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow-xs focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",
      className
    )}
    {...props}
  >
    <CheckboxPrimitive.Indicator className={cn("flex items-center justify-center text-current")}>
      <CheckIcon className="h-4 w-4" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
))
Checkbox.displayName = CheckboxPrimitive.Root.displayName

export { Checkbox } 


================================================
FILE: apps/web/components/ui/dialog.tsx
================================================
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { Cross2Icon } from "@radix-ui/react-icons"

import { cn } from "@/lib/utils"

const Dialog = DialogPrimitive.Root

const DialogTrigger = DialogPrimitive.Trigger

const DialogPortal = DialogPrimitive.Portal

const DialogClose = DialogPrimitive.Close

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/50 backdrop-blur-[1px] data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
  />
))
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 sm:rounded-2xl",
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95",
        className
      )}
      {...props}
    >
      {children}
      <DialogPrimitive.Close
        className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-hidden focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground"
        aria-label="Close dialog"
      >
        <Cross2Icon className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
))
DialogContent.displayName = DialogPrimitive.Content.displayName

const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-1.5 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
DialogHeader.displayName = "DialogHeader"

const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
DialogFooter.displayName = "DialogFooter"

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DialogTitle.displayName = DialogPrimitive.Title.displayName

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DialogDescription.displayName = DialogPrimitive.Description.displayName

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogTrigger,
  DialogClose,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
}



================================================
FILE: apps/web/components/ui/dropdown-menu.tsx
================================================
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import {
  CheckIcon,
  ChevronRightIcon,
  DotFilledIcon,
} from "@radix-ui/react-icons"

import { cn } from "@/lib/utils"

const DropdownMenu = DropdownMenuPrimitive.Root

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger

const DropdownMenuGroup = DropdownMenuPrimitive.Group

const DropdownMenuPortal = DropdownMenuPrimitive.Portal

const DropdownMenuSub = DropdownMenuPrimitive.Sub

const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup

const DropdownMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-hidden focus:bg-accent data-[state=open]:bg-accent",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRightIcon className="ml-auto h-4 w-4" />
  </DropdownMenuPrimitive.SubTrigger>
))
DropdownMenuSubTrigger.displayName =
  DropdownMenuPrimitive.SubTrigger.displayName

const DropdownMenuSubContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
DropdownMenuSubContent.displayName =
  DropdownMenuPrimitive.SubContent.displayName

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md",
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
))
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-pointer select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden transition-colors focus:bg-accent focus:text-accent-foreground data-disabled:pointer-events-none data-disabled:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName

const DropdownMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-hidden transition-colors focus:bg-accent focus:text-accent-foreground data-disabled:pointer-events-none data-disabled:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <CheckIcon className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
))
DropdownMenuCheckboxItem.displayName =
  DropdownMenuPrimitive.CheckboxItem.displayName

const DropdownMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-hidden transition-colors focus:bg-accent focus:text-accent-foreground data-disabled:pointer-events-none data-disabled:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <DotFilledIcon className="h-4 w-4 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
))
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName

const DropdownMenuLabel = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName

const DropdownMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn("ml-auto text-xs tracking-widest opacity-60", className)}
      {...props}
    />
  )
}
DropdownMenuShortcut.displayName = "DropdownMenuShortcut"

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
}



================================================
FILE: apps/web/components/ui/hover-card.tsx
================================================
"use client"

import * as React from "react"
import * as HoverCardPrimitive from "@radix-ui/react-hover-card"

import { cn } from "@/lib/utils"

function HoverCard({
  ...props
}: React.ComponentProps<typeof HoverCardPrimitive.Root>) {
  return <HoverCardPrimitive.Root data-slot="hover-card" {...props} />
}

function HoverCardTrigger({
  ...props
}: React.ComponentProps<typeof HoverCardPrimitive.Trigger>) {
  return (
    <HoverCardPrimitive.Trigger data-slot="hover-card-trigger" {...props} />
  )
}

function HoverCardContent({
  className,
  align = "center",
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof HoverCardPrimitive.Content>) {
  return (
    <HoverCardPrimitive.Portal data-slot="hover-card-portal">
      <HoverCardPrimitive.Content
        data-slot="hover-card-content"
        align={align}
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-64 origin-(--radix-hover-card-content-transform-origin) rounded-md border p-4 shadow-md outline-hidden",
          className
        )}
        {...props}
      />
    </HoverCardPrimitive.Portal>
  )
}

export { HoverCard, HoverCardTrigger, HoverCardContent }



================================================
FILE: apps/web/components/ui/input.tsx
================================================
import * as React from "react"

import { cn } from "@/lib/utils"

export interface InputProps
  extends React.InputHTMLAttributes<HTMLInputElement> {}

const Input = React.forwardRef<HTMLInputElement, InputProps>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-xs transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-hidden focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }



================================================
FILE: apps/web/components/ui/label.tsx
================================================
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
)

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
))
Label.displayName = LabelPrimitive.Root.displayName

export { Label }



================================================
FILE: apps/web/components/ui/select.tsx
================================================
"use client"

import * as React from "react"
import {
  CaretSortIcon,
  CheckIcon,
  ChevronDownIcon,
  ChevronUpIcon,
} from "@radix-ui/react-icons"
import * as SelectPrimitive from "@radix-ui/react-select"

import { cn } from "@/lib/utils"

const Select = SelectPrimitive.Root

const SelectGroup = SelectPrimitive.Group

const SelectValue = SelectPrimitive.Value

const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-xs ring-offset-background placeholder:text-muted-foreground focus:outline-hidden focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
      className
    )}
    {...props}
  >
    {children}
    <SelectPrimitive.Icon asChild>
      <CaretSortIcon className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
))
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName

const SelectScrollUpButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollUpButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronUpIcon />
  </SelectPrimitive.ScrollUpButton>
))
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName

const SelectScrollDownButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollDownButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronDownIcon />
  </SelectPrimitive.ScrollDownButton>
))
SelectScrollDownButton.displayName =
  SelectPrimitive.ScrollDownButton.displayName

const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        "relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className
      )}
      position={position}
      {...props}
    >
      <SelectScrollUpButton />
      <SelectPrimitive.Viewport
        className={cn(
          "p-1",
          position === "popper" &&
            "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
        )}
      >
        {children}
      </SelectPrimitive.Viewport>
      <SelectScrollDownButton />
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
))
SelectContent.displayName = SelectPrimitive.Content.displayName

const SelectLabel = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Label
    ref={ref}
    className={cn("px-2 py-1.5 text-sm font-semibold", className)}
    {...props}
  />
))
SelectLabel.displayName = SelectPrimitive.Label.displayName

const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-2 pr-8 text-sm outline-hidden focus:bg-accent focus:text-accent-foreground data-disabled:pointer-events-none data-disabled:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute right-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <CheckIcon className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>
    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
))
SelectItem.displayName = SelectPrimitive.Item.displayName

const SelectSeparator = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
SelectSeparator.displayName = SelectPrimitive.Separator.displayName

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
  SelectScrollUpButton,
  SelectScrollDownButton,
}



================================================
FILE: apps/web/components/ui/switch.tsx
================================================
"use client"

import * as React from "react"
import * as SwitchPrimitives from "@radix-ui/react-switch"

import { cn } from "@/lib/utils"

const Switch = React.forwardRef<
  React.ElementRef<typeof SwitchPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>
>(({ className, ...props }, ref) => (
  <SwitchPrimitives.Root
    className={cn(
      "peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-xs transition-colors focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",
      className
    )}
    {...props}
    ref={ref}
  >
    <SwitchPrimitives.Thumb
      className={cn(
        "pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0"
      )}
    />
  </SwitchPrimitives.Root>
))
Switch.displayName = SwitchPrimitives.Root.displayName

export { Switch }



================================================
FILE: apps/web/components/ui/table.tsx
================================================
import * as React from "react"

import { cn } from "@/lib/utils"

const Table = React.forwardRef<
  HTMLTableElement,
  React.HTMLAttributes<HTMLTableElement>
>(({ className, ...props }, ref) => (
  <div className="relative w-full overflow-auto">
    <table
      ref={ref}
      className={cn("w-full caption-bottom text-sm", className)}
      {...props}
    />
  </div>
))
Table.displayName = "Table"

const TableHeader = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />
))
TableHeader.displayName = "TableHeader"

const TableBody = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tbody
    ref={ref}
    className={cn("[&_tr:last-child]:border-0", className)}
    {...props}
  />
))
TableBody.displayName = "TableBody"

const TableFooter = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tfoot
    ref={ref}
    className={cn(
      "border-t bg-muted/50 font-medium last:[&>tr]:border-b-0",
      className
    )}
    {...props}
  />
))
TableFooter.displayName = "TableFooter"

const TableRow = React.forwardRef<
  HTMLTableRowElement,
  React.HTMLAttributes<HTMLTableRowElement>
>(({ className, ...props }, ref) => (
  <tr
    ref={ref}
    className={cn(
      "border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",
      className
    )}
    {...props}
  />
))
TableRow.displayName = "TableRow"

const TableHead = React.forwardRef<
  HTMLTableCellElement,
  React.ThHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <th
    ref={ref}
    className={cn(
      "h-10 px-2 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
      className
    )}
    {...props}
  />
))
TableHead.displayName = "TableHead"

const TableCell = React.forwardRef<
  HTMLTableCellElement,
  React.TdHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <td
    ref={ref}
    className={cn(
      "p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
      className
    )}
    {...props}
  />
))
TableCell.displayName = "TableCell"

const TableCaption = React.forwardRef<
  HTMLTableCaptionElement,
  React.HTMLAttributes<HTMLTableCaptionElement>
>(({ className, ...props }, ref) => (
  <caption
    ref={ref}
    className={cn("mt-4 text-sm text-muted-foreground", className)}
    {...props}
  />
))
TableCaption.displayName = "TableCaption"

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}



================================================
FILE: apps/web/components/ui/tabs.tsx
================================================
"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

const Tabs = TabsPrimitive.Root

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-9 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground",
      className
    )}
    {...props}
  />
))
TabsList.displayName = TabsPrimitive.List.displayName

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",
      className
    )}
    {...props}
  />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className
    )}
    {...props}
  />
))
TabsContent.displayName = TabsPrimitive.Content.displayName

export { Tabs, TabsList, TabsTrigger, TabsContent }



================================================
FILE: apps/web/components/ui/textarea.tsx
================================================
import * as React from "react"

import { cn } from "@/lib/utils"

export interface TextareaProps
  extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {}

const Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(
  ({ className, ...props }, ref) => {
    return (
      <textarea
        className={cn(
          "flex min-h-[60px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-xs placeholder:text-muted-foreground focus-visible:outline-hidden focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Textarea.displayName = "Textarea"

export { Textarea }



================================================
FILE: apps/web/components/ui/toggle-group.tsx
================================================
"use client"

import * as React from "react"
import * as ToggleGroupPrimitive from "@radix-ui/react-toggle-group"
import { type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"
import { toggleVariants } from "@components/ui/toggle"

const ToggleGroupContext = React.createContext<
  VariantProps<typeof toggleVariants>
>({
  size: "default",
  variant: "default",
})

const ToggleGroup = React.forwardRef<
  React.ElementRef<typeof ToggleGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &
    VariantProps<typeof toggleVariants>
>(({ className, variant, size, children, ...props }, ref) => (
  <ToggleGroupPrimitive.Root
    ref={ref}
    className={cn("flex items-center justify-center gap-1", className)}
    {...props}
  >
    <ToggleGroupContext.Provider value={{ variant, size }}>
      {children}
    </ToggleGroupContext.Provider>
  </ToggleGroupPrimitive.Root>
))

ToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName

const ToggleGroupItem = React.forwardRef<
  React.ElementRef<typeof ToggleGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &
    VariantProps<typeof toggleVariants>
>(({ className, children, variant, size, ...props }, ref) => {
  const context = React.useContext(ToggleGroupContext)

  return (
    <ToggleGroupPrimitive.Item
      ref={ref}
      className={cn(
        toggleVariants({
          variant: context.variant || variant,
          size: context.size || size,
        }),
        className
      )}
      {...props}
    >
      {children}
    </ToggleGroupPrimitive.Item>
  )
})

ToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName

export { ToggleGroup, ToggleGroupItem }



================================================
FILE: apps/web/components/ui/toggle.tsx
================================================
"use client"

import * as React from "react"
import * as TogglePrimitive from "@radix-ui/react-toggle"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const toggleVariants = cva(
  "inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-hidden focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        outline:
          "border border-input bg-transparent shadow-xs hover:bg-accent hover:text-accent-foreground",
      },
      size: {
        default: "h-9 px-3",
        sm: "h-8 px-2",
        lg: "h-10 px-3",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

const Toggle = React.forwardRef<
  React.ElementRef<typeof TogglePrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &
    VariantProps<typeof toggleVariants>
>(({ className, variant, size, ...props }, ref) => (
  <TogglePrimitive.Root
    ref={ref}
    className={cn(toggleVariants({ variant, size, className }))}
    {...props}
  />
))

Toggle.displayName = TogglePrimitive.Root.displayName

export { Toggle, toggleVariants }



================================================
FILE: apps/web/components/ui/tooltip.tsx
================================================
"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"
import { cn } from "@/lib/utils"

const TooltipProvider = TooltipPrimitive.Provider

const Tooltip = TooltipPrimitive.Root

const TooltipTrigger = TooltipPrimitive.Trigger

const TooltipContent = React.forwardRef<
  React.ElementRef<typeof TooltipPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Content
    ref={ref}
    sideOffset={sideOffset}
    className={cn(
      "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
TooltipContent.displayName = TooltipPrimitive.Content.displayName

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider } 


================================================
FILE: apps/web/components/Utils/ClientComp.tsx
================================================
'use client'

function ClientComponentSkeleton({ children }: { children: React.ReactNode }) {
  return <div>{children}</div>
}

export default ClientComponentSkeleton



================================================
FILE: apps/web/components/Utils/libs/styled-registry.tsx
================================================
'use client'

import React, { useState } from 'react'
import { useServerInsertedHTML } from 'next/navigation'
import { ServerStyleSheet, StyleSheetManager } from 'styled-components'

export default function StyledComponentsRegistry({
  children,
}: {
  children: React.ReactNode
}) {
  // Only create stylesheet once with lazy initial state
  // x-ref: https://reactjs.org/docs/hooks-reference.html#lazy-initial-state
  const [styledComponentsStyleSheet] = useState(() => new ServerStyleSheet())

  useServerInsertedHTML(() => {
    const styles = styledComponentsStyleSheet.getStyleElement()
    styledComponentsStyleSheet.instance.clearTag()
    return <>{styles}</>
  })

  if (typeof window !== 'undefined') return <>{children}</>

  return (
    <StyleSheetManager sheet={styledComponentsStyleSheet.instance}>
      {children as React.ReactElement<any> | number | string}
    </StyleSheetManager>
  );
}



================================================
FILE: apps/web/hooks/useContributorStatus.ts
================================================
import { useState, useEffect, useCallback } from 'react';
import { getCourseContributors } from '@services/courses/courses';
import { useLHSession } from '@components/Contexts/LHSessionContext';
import toast from 'react-hot-toast';

export type ContributorStatus = 'NONE' | 'PENDING' | 'ACTIVE' | 'INACTIVE';

interface Contributor {
  user_id: string;
  authorship_status: ContributorStatus;
}

export function useContributorStatus(courseUuid: string) {
  const session = useLHSession() as any;
  const [contributorStatus, setContributorStatus] = useState<ContributorStatus>('NONE');
  const [isLoading, setIsLoading] = useState(true);

  const checkContributorStatus = useCallback(async () => {
    if (!session.data?.user) {
      setIsLoading(false);
      return;
    }

    try {
      const response = await getCourseContributors(
        'course_' + courseUuid,
        session.data?.tokens?.access_token
      );
      
      if (response && response.data && Array.isArray(response.data)) {
        const currentUser = response.data.find(
          (contributor: Contributor) => contributor.user_id === session.data.user.id
        );
        
        if (currentUser) {
          setContributorStatus(currentUser.authorship_status as ContributorStatus);
        } else {
          setContributorStatus('NONE');
        }
      } else {
        setContributorStatus('NONE');
      }
    } catch (error) {
      console.error('Failed to check contributor status:', error);
      toast.error('Failed to check contributor status');
      setContributorStatus('NONE');
    } finally {
      setIsLoading(false);
    }
  }, [courseUuid, session.data?.tokens?.access_token, session.data?.user]);

  useEffect(() => {
    if (session.data?.user) {
      checkContributorStatus();
    }
  }, [checkContributorStatus, session.data?.user]);

  return { contributorStatus, isLoading, refetch: checkContributorStatus };
} 


================================================
FILE: apps/web/hooks/useDebounce.ts
================================================
import { useEffect, useRef, useState } from 'react';

// Function debouncing
export function useDebounce<T extends (...args: any[]) => any>(
  callback: T,
  delay: number
): T;

// Value debouncing
export function useDebounce<T>(value: T, delay: number): T;

// Implementation
export function useDebounce<T>(valueOrCallback: T, delay: number): T {
  const [debouncedValue, setDebouncedValue] = useState<T>(valueOrCallback);
  const timeoutRef = useRef<NodeJS.Timeout | undefined>(undefined);

  useEffect(() => {
    // If it's a function, return a debounced version of it
    if (typeof valueOrCallback === 'function') {
      return () => {
        if (timeoutRef.current) {
          clearTimeout(timeoutRef.current);
        }
      };
    }

    // For values, update the debounced value after the delay
    timeoutRef.current = setTimeout(() => {
      setDebouncedValue(valueOrCallback);
    }, delay);

    return () => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
    };
  }, [valueOrCallback, delay]);

  // If it's a function, return a debounced version
  if (typeof valueOrCallback === 'function') {
    return ((...args: any[]) => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }

      timeoutRef.current = setTimeout(() => {
        (valueOrCallback as Function)(...args);
      }, delay);
    }) as T;
  }

  // For values, return the debounced value
  return debouncedValue;
} 


================================================
FILE: apps/web/lib/constants.ts
================================================
export const ACCEPTED_FILE_FORMATS = {
    video: 'video/*',
    mp4: 'video/mp4',
    webm: 'video/webm',
    // Removed 'image: image/*' to prevent SVG uploads - use specific formats instead
    jpg: 'image/jpeg',
    png: 'image/png',
    webp: 'image/webp',
    gif: 'image/gif',
    pdf: 'application/pdf',
    pptx: 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
    docx: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    zip: 'application/zip,application/x-zip-compressed'
} as const;

/**
 * Constructs the 'accept' attribute value for an input element
 */
export function constructAcceptValue(types : (keyof typeof ACCEPTED_FILE_FORMATS)[]): string {
    return types.map(type => ACCEPTED_FILE_FORMATS[type]).filter(Boolean).join(",")
}


================================================
FILE: apps/web/lib/file-validation.ts
================================================
/**
 * Frontend file validation utilities
 * Provides consistent validation across all upload components
 */

// File type configurations (matches backend)
export const FILE_TYPES = {
  image: {
    extensions: ['.jpg', '.jpeg', '.png', '.gif', '.webp'],
    mimeTypes: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
    maxSize: 10 * 1024 * 1024, // 10MB
  },
  video: {
    extensions: ['.mp4', '.webm'],
    mimeTypes: ['video/mp4', 'video/webm'],
    maxSize: 100 * 1024 * 1024, // 100MB
  },
  document: {
    extensions: ['.pdf'],
    mimeTypes: ['application/pdf'],
    maxSize: 50 * 1024 * 1024, // 50MB
  },
} as const

export type FileType = keyof typeof FILE_TYPES

/**
 * Validate a file against allowed types and size limits
 */
export function validateFile(
  file: File,
  allowedTypes: FileType[],
  customMaxSize?: number
): { valid: boolean; error?: string } {
  if (!file) {
    return { valid: false, error: 'No file selected' }
  }

  // Block SVG files explicitly for security
  if (file.name.toLowerCase().endsWith('.svg') || file.type === 'image/svg+xml') {
    return { valid: false, error: 'SVG files are not allowed for security reasons' }
  }

  // Find matching file type
  let matchedType: FileType | null = null
  for (const type of allowedTypes) {
    const config = FILE_TYPES[type]
    if ((config.mimeTypes as readonly string[]).includes(file.type)) {
      matchedType = type
      break
    }
  }

  if (!matchedType) {
    const allowedMimes = allowedTypes.flatMap(type => FILE_TYPES[type].mimeTypes)
    return { 
      valid: false, 
      error: `Invalid file type: ${file.type}. Allowed types: ${allowedMimes.join(', ')}` 
    }
  }

  // Check file size
  const maxSize = customMaxSize || FILE_TYPES[matchedType].maxSize
  if (file.size > maxSize) {
    const sizeMB = (file.size / 1024 / 1024).toFixed(1)
    const maxSizeMB = (maxSize / 1024 / 1024).toFixed(1)
    return { 
      valid: false, 
      error: `File too large (${sizeMB}MB). Maximum size: ${maxSizeMB}MB` 
    }
  }

  return { valid: true }
}

/**
 * Get accept attribute value for file inputs
 */
export function getAcceptValue(allowedTypes: FileType[]): string {
  return allowedTypes
    .flatMap(type => FILE_TYPES[type].mimeTypes)
    .join(',')
}

/**
 * Get human-readable description of allowed file types
 */
export function getFileTypeDescription(allowedTypes: FileType[]): string {
  const extensions = allowedTypes
    .flatMap(type => FILE_TYPES[type].extensions)
    .map(ext => ext.toUpperCase().slice(1))
    .join(', ')
  
  const maxSizes = Array.from(new Set(allowedTypes.map(type => FILE_TYPES[type].maxSize)))
  const maxSizeStr = maxSizes.length === 1 
    ? `${maxSizes[0] / 1024 / 1024}MB`
    : 'varies'

  return `${extensions} (max ${maxSizeStr})`
}



================================================
FILE: apps/web/lib/utils.ts
================================================
import { type ClassValue, clsx } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

export function debounce<T extends (...args: any[]) => void>(
  func: T,
  delay: number
): T {
  let timeoutId: ReturnType<typeof setTimeout>
  return function (this: any, ...args: Parameters<T>) {
    clearTimeout(timeoutId)
    timeoutId = setTimeout(() => func.apply(this, args), delay)
  } as T
}



================================================
FILE: apps/web/services/ai/ai.ts
================================================
import { getAPIUrl } from '@services/config/config'
import { RequestBodyWithAuthHeader } from '@services/utils/ts/requests'

export async function startActivityAIChatSession(
  message: string,
  access_token: string,
  activity_uuid?: string
) {
  const data = {
    message,
    activity_uuid,
  }
  const result = await fetch(
    `${getAPIUrl()}ai/start/activity_chat_session`,
    RequestBodyWithAuthHeader('POST', data, null, access_token)
  )
  const json = await result.json()
  if (result.status === 200) {
    return {
      success: true,
      data: json,
      status: result.status,
      HTTPmessage: result.statusText,
    }
  } else {
    return {
      success: false,
      data: json,
      status: result.status,
      HTTPmessage: result.statusText,
    }
  }
}

export async function sendActivityAIChatMessage(
  message: string,
  aichat_uuid: string,
  activity_uuid: string,
  access_token: string
) {
  const data = {
    aichat_uuid,
    message,
    activity_uuid,
  }
  const result = await fetch(
    `${getAPIUrl()}ai/send/activity_chat_message`,
    RequestBodyWithAuthHeader('POST', data, null, access_token)
  )

  const json = await result.json()
  if (result.status === 200) {
    return {
      success: true,
      data: json,
      status: result.status,
      HTTPmessage: result.statusText,
    }
  } else {
    return {
      success: false,
      data: json,
      status: result.status,
      HTTPmessage: result.statusText,
    }
  }
}



================================================
FILE: apps/web/services/auth/auth.ts
================================================
import { getAPIUrl } from '@services/config/config'
import { RequestBody, getResponseMetadata } from '@services/utils/ts/requests'

interface LoginAndGetTokenResponse {
  access_token: 'string'
  token_type: 'string'
}

// âš ï¸ mvp phase code
// TODO : everything in this file need to be refactored including security issues fix

export async function loginAndGetToken(
  username: any,
  password: any
): Promise<any> {
  // Request Config

  // get origin
  const HeadersConfig = new Headers({
    'Content-Type': 'application/x-www-form-urlencoded',
  })
  const urlencoded = new URLSearchParams({
    username: username,
    password: password,
  })

  const requestOptions: any = {
    method: 'POST',
    headers: HeadersConfig,
    body: urlencoded,
    redirect: 'follow',
    credentials: 'include',
  }

  // fetch using await and async
  const response = await fetch(`${getAPIUrl()}auth/login`, requestOptions)
  return response
}

export async function loginWithOAuthToken(
  email: any,
  provider: any,
  accessToken: string
): Promise<any> {
  // Request Config

  // get origin
  const HeadersConfig = new Headers({
    'Content-Type': 'application/json',
  })
  const body = {
    email: email,
    provider: provider,
    access_token: accessToken,
  }
  const jsonBody = JSON.stringify(body);

  const requestOptions: any = {
    method: 'POST',
    headers: HeadersConfig,
    body: jsonBody,
    redirect: 'follow',
    credentials: 'include',
  }

  // fetch using await and async
  const response = await fetch(`${getAPIUrl()}auth/oauth`, requestOptions)
  return response
}

export async function sendResetLink(email: string, org_id: number) {
  const result = await fetch(
    `${getAPIUrl()}users/reset_password/send_reset_code/${email}?org_id=${org_id}`,
    RequestBody('POST', null, null)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function resetPassword(
  email: string,
  new_password: string,
  org_id: number,
  reset_code: string
) {
  const result = await fetch(
    `${getAPIUrl()}users/reset_password/change_password/${email}?reset_code=${reset_code}&new_password=${new_password}&org_id=${org_id}`,
    RequestBody('POST', null, null)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function logout(): Promise<any> {
  // Request Config

  // get origin
  const HeadersConfig = new Headers({
    'Content-Type': 'application/x-www-form-urlencoded',
  })
  const urlencoded = new URLSearchParams()

  const requestOptions: any = {
    method: 'DELETE',
    headers: HeadersConfig,
    body: urlencoded,
    redirect: 'follow',
    credentials: 'include',
  }

  // fetch using await and async
  const response = await fetch(`${getAPIUrl()}auth/logout`, requestOptions)
  return response
}

export async function getUserInfo(token: string): Promise<any> {
  const origin = window.location.origin
  const HeadersConfig = new Headers({
    Authorization: `Bearer ${token}`,
    Origin: origin,
  })

  const requestOptions: any = {
    method: 'GET',
    headers: HeadersConfig,
    redirect: 'follow',
    credentials: 'include',
  }

  return fetch(`${getAPIUrl()}users/profile`, requestOptions)
    .then((result) => result.json())
    .catch((error) => console.log('error', error))
}

export async function getUserSession(token: string): Promise<any> {
  const HeadersConfig = new Headers({
    Authorization: `Bearer ${token}`,
  })

  const requestOptions: any = {
    method: 'GET',
    headers: HeadersConfig,
    redirect: 'follow',
    credentials: 'include',
  }

  return fetch(`${getAPIUrl()}users/session`, requestOptions)
    .then((result) => result.json())
    .catch((error) => console.log('error', error))
}

export async function getNewAccessTokenUsingRefreshToken(): Promise<any> {
  const requestOptions: any = {
    method: 'GET',
    redirect: 'follow',
    credentials: 'include',
  }

  return fetch(`${getAPIUrl()}auth/refresh`, requestOptions)
    .then((result) => result.json())
    .catch((error) => console.log('error', error))
}

export async function getNewAccessTokenUsingRefreshTokenServer(
  refresh_token_cookie: any
): Promise<any> {
  const requestOptions: any = {
    method: 'GET',
    redirect: 'follow',
    headers: {
      Cookie: `refresh_token_cookie=${refresh_token_cookie}`,
    },
    credentials: 'include',
  }
  return fetch(`${getAPIUrl()}auth/refresh`, requestOptions)
    .then((result) => result.json())
    .catch((error) => console.log('error', error))
}

// cookies

export async function getAccessTokenFromRefreshTokenCookie(cookieStore: any) {
  const refresh_token_cookie: any = cookieStore.get('refresh_token_cookie')
  const access_token_cookie: any =
    await getNewAccessTokenUsingRefreshTokenServer(refresh_token_cookie?.value)
  return access_token_cookie && refresh_token_cookie
    ? access_token_cookie.access_token
    : null
}

// signup

interface NewAccountBody {
  username: string
  email: string
  password: string
  org_slug: string
  org_id: string
}

export async function signup(body: NewAccountBody): Promise<any> {
  const HeadersConfig = new Headers({ 'Content-Type': 'application/json' })

  const requestOptions: any = {
    method: 'POST',
    headers: HeadersConfig,
    body: JSON.stringify(body),
    redirect: 'follow',
  }

  const res = await fetch(`${getAPIUrl()}users/${body.org_id}`, requestOptions)

  return res
}

export async function signUpWithInviteCode(
  body: NewAccountBody,
  invite_code: string
): Promise<any> {
  const HeadersConfig = new Headers({ 'Content-Type': 'application/json' })

  const requestOptions: any = {
    method: 'POST',
    headers: HeadersConfig,
    body: JSON.stringify(body),
    redirect: 'follow',
  }

  const res = await fetch(
    `${getAPIUrl()}users/${body.org_id}/invite/${invite_code}`,
    requestOptions
  )

  return res
}



================================================
FILE: apps/web/services/blocks/Image/images.ts
================================================
import { getAPIUrl } from '@services/config/config'
import {
  RequestBodyFormWithAuthHeader,
  RequestBodyWithAuthHeader,
} from '@services/utils/ts/requests'

export async function uploadNewImageFile(
  file: any,
  activity_uuid: string,
  access_token: string
) {
  // Send file thumbnail as form data
  const formData = new FormData()
  formData.append('file_object', file)
  formData.append('activity_uuid', activity_uuid)

  return fetch(
    `${getAPIUrl()}blocks/image`,
    RequestBodyFormWithAuthHeader('POST', formData, null, access_token)
  )
    .then((result) => result.json())
    .catch((error) => console.log('error', error))
}

export async function getImageFile(file_id: string, access_token: string) {
  // todo : add course id to url
  return fetch(
    `${getAPIUrl()}blocks/image?file_id=${file_id}`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  )
    .then((result) => result.json())
    .catch((error) => console.log('error', error))
}



================================================
FILE: apps/web/services/blocks/Pdf/pdf.ts
================================================
import { getAPIUrl } from '@services/config/config'
import {
  RequestBodyFormWithAuthHeader,
  RequestBodyWithAuthHeader,
} from '@services/utils/ts/requests'

export async function uploadNewPDFFile(
  file: any,
  activity_uuid: string,
  access_token: string
) {
  // Send file thumbnail as form data
  const formData = new FormData()
  formData.append('file_object', file)
  formData.append('activity_uuid', activity_uuid)

  return fetch(
    `${getAPIUrl()}blocks/pdf`,
    RequestBodyFormWithAuthHeader('POST', formData, null, access_token)
  )
    .then((result) => result.json())
    .catch((error) => console.log('error', error))
}

export async function getPDFFile(file_id: string, access_token: string) {
  // todo : add course id to url
  return fetch(
    `${getAPIUrl()}blocks/pdf?file_id=${file_id}`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  )
    .then((result) => result.json())
    .catch((error) => console.log('error', error))
}



================================================
FILE: apps/web/services/blocks/Quiz/quiz.ts
================================================
import { getAPIUrl } from '@services/config/config'
import { RequestBodyWithAuthHeader } from '@services/utils/ts/requests'

export async function submitQuizBlock(activity_id: string, data: any,access_token:string) {
  const result: any = await fetch(
    `${getAPIUrl()}blocks/quiz/${activity_id}"`,
    RequestBodyWithAuthHeader('POST', data, null,access_token)
  )
    .then((result) => result.json())
    .catch((error) => console.log('error', error))
  return result
}



================================================
FILE: apps/web/services/blocks/Video/video.ts
================================================
import { getAPIUrl } from '@services/config/config'
import {
  RequestBodyFormWithAuthHeader,
  RequestBodyWithAuthHeader,
} from '@services/utils/ts/requests'

export async function uploadNewVideoFile(
  file: any,
  activity_uuid: string,
  access_token: string
) {
  // Send file thumbnail as form data
  const formData = new FormData()
  formData.append('file_object', file)
  formData.append('activity_uuid', activity_uuid)

  return fetch(
    `${getAPIUrl()}blocks/video`,
    RequestBodyFormWithAuthHeader('POST', formData, null, access_token)
  )
    .then((result) => result.json())
    .catch((error) => console.error('error', error))
}

export async function getVideoFile(file_id: string, access_token: string) {
  return fetch(
    `${getAPIUrl()}blocks/video?file_id=${file_id}`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  )
    .then((result) => result.json())
    .catch((error) => console.error('error', error))
}



================================================
FILE: apps/web/services/config/config.ts
================================================
// Runtime configuration cache
let runtimeConfig: Record<string, string> | null = null;

// Lazy load runtime configuration
function loadRuntimeConfig(): Record<string, string> {
  if (runtimeConfig !== null) {
    return runtimeConfig;
  }

  runtimeConfig = {};

  if (typeof window !== 'undefined') {
    // Client-side: read from window.__RUNTIME_CONFIG__ if available
    if ((window as any).__RUNTIME_CONFIG__) {
      runtimeConfig = (window as any).__RUNTIME_CONFIG__;
    }
  } else {
    // Server-side: try to read from runtime-config.json
    // Try multiple possible paths for standalone mode
    try {
      const fs = require('fs');
      const path = require('path');
      
      // In standalone mode, runtime-config.json is in the same directory as server.js
      // Try common possible locations relative to the current working directory and module
      const possiblePaths = [
        path.join(process.cwd(), 'runtime-config.json'),
        path.join(__dirname || process.cwd(), 'runtime-config.json'),
        path.join(__dirname || process.cwd(), '..', 'runtime-config.json'),
      ];
      
      for (const configPath of possiblePaths) {
        try {
          if (fs.existsSync(configPath)) {
            runtimeConfig = JSON.parse(fs.readFileSync(configPath, 'utf8'));
            break;
          }
        } catch {
          // Continue to next path
        }
      }
    } catch {
      // fs/path not available (client-side bundle), skip
    }
  }

  return runtimeConfig || {};
}

// Helper function to get config value with fallback
export const getConfig = (key: string, defaultValue: string = ''): string => {
  const config = loadRuntimeConfig();
  return (config && config[key]) || process.env[key] || defaultValue;
};

// Dynamic config getters - these are functions to ensure runtime values are used
const getLEARNHOUSE_HTTP_PROTOCOL = () =>
  (getConfig('NEXT_PUBLIC_LEARNHOUSE_HTTPS') === 'true') ? 'https://' : 'http://'
const getLEARNHOUSE_API_URL = () => getConfig('NEXT_PUBLIC_LEARNHOUSE_API_URL', 'http://localhost/api/v1/')
const getLEARNHOUSE_BACKEND_URL = () => getConfig('NEXT_PUBLIC_LEARNHOUSE_BACKEND_URL', 'http://localhost/')
const getLEARNHOUSE_DOMAIN = () => getConfig('NEXT_PUBLIC_LEARNHOUSE_DOMAIN', 'localhost')
const getLEARNHOUSE_TOP_DOMAIN = () => getConfig('NEXT_PUBLIC_LEARNHOUSE_TOP_DOMAIN', 'localhost')

// Export getter functions for dynamic runtime configuration
export const getLEARNHOUSE_HTTP_PROTOCOL_VAL = getLEARNHOUSE_HTTP_PROTOCOL
export const getLEARNHOUSE_BACKEND_URL_VAL = getLEARNHOUSE_BACKEND_URL
export const getLEARNHOUSE_DOMAIN_VAL = getLEARNHOUSE_DOMAIN
export const getLEARNHOUSE_TOP_DOMAIN_VAL = getLEARNHOUSE_TOP_DOMAIN

// Export constants for backward compatibility
// These are computed once at module load, but getConfig uses runtime values
// For middleware/proxy (where runtime is critical), use the getter functions instead
export const LEARNHOUSE_HTTP_PROTOCOL = getLEARNHOUSE_HTTP_PROTOCOL()
export const LEARNHOUSE_BACKEND_URL = getLEARNHOUSE_BACKEND_URL()
export const LEARNHOUSE_DOMAIN = getLEARNHOUSE_DOMAIN()
export const LEARNHOUSE_TOP_DOMAIN = getLEARNHOUSE_TOP_DOMAIN()

// For direct usage, these call the getters
export const getAPIUrl = () => getLEARNHOUSE_API_URL()
export const getBackendUrl = () => getLEARNHOUSE_BACKEND_URL()

// Multi Organization Mode
export const isMultiOrgModeEnabled = () =>
  getConfig('NEXT_PUBLIC_LEARNHOUSE_MULTI_ORG') === 'true' ? true : false

export const getUriWithOrg = (orgslug: string, path: string) => {
  const multi_org = isMultiOrgModeEnabled()
  const protocol = getLEARNHOUSE_HTTP_PROTOCOL()
  const domain = getLEARNHOUSE_DOMAIN()
  if (multi_org) {
    return `${protocol}${orgslug}.${domain}${path}`
  }
  return `${protocol}${domain}${path}`
}

export const getUriWithoutOrg = (path: string) => {
  const multi_org = isMultiOrgModeEnabled()
  const protocol = getLEARNHOUSE_HTTP_PROTOCOL()
  const domain = getLEARNHOUSE_DOMAIN()
  if (multi_org) {
    return `${protocol}${domain}${path}`
  }
  return `${protocol}${domain}${path}`
}

export const getOrgFromUri = () => {
  const multi_org = isMultiOrgModeEnabled()
  if (multi_org) {
    getDefaultOrg()
  } else {
    if (typeof window !== 'undefined') {
      const hostname = window.location.hostname
      const domain = getLEARNHOUSE_DOMAIN()

      return hostname.replace(`.${domain}`, '')
    }
  }
}

export const getDefaultOrg = () => {
  return getConfig('NEXT_PUBLIC_LEARNHOUSE_DEFAULT_ORG', 'default')
}







================================================
FILE: apps/web/services/courses/activities.ts
================================================
import { getAPIUrl } from '@services/config/config'
import {
  RequestBodyFormWithAuthHeader,
  RequestBodyWithAuthHeader,
  getResponseMetadata,
} from '@services/utils/ts/requests'

export async function createActivity(
  data: any,
  chapter_id: any,
  org_id: any,
  access_token: string
) {
  data.content = {}
  // remove chapter_id from data
  delete data.chapterId

  const result = await fetch(
    `${getAPIUrl()}activities/?coursechapter_id=${chapter_id}&org_id=${org_id}`,
    RequestBodyWithAuthHeader('POST', data, null, access_token)
  )
  const res = await result.json()
  return res
}

export async function createFileActivity(
  file: File,
  type: string,
  data: any,
  chapter_id: any,
  access_token: string
) {
  // Send file thumbnail as form data
  const formData = new FormData()
  formData.append('chapter_id', chapter_id)

  let endpoint = ''

  if (type === 'video') {
    formData.append('name', data.name)
    formData.append('video_file', file)
    // Add video details
    if (data.details) {
      formData.append('details', JSON.stringify({
        startTime: data.details.startTime || 0,
        endTime: data.details.endTime || null,
        autoplay: data.details.autoplay || false,
        muted: data.details.muted || false
      }))
    }
    endpoint = `${getAPIUrl()}activities/video`
  } else if (type === 'documentpdf') {
    formData.append('pdf_file', file)
    formData.append('name', data.name)
    endpoint = `${getAPIUrl()}activities/documentpdf`
  } else {
    // Handle other file types here
  }

  const result: any = await fetch(
    endpoint,
    RequestBodyFormWithAuthHeader('POST', formData, null, access_token)
  )
  const res = await result.json()
  return res
}

export async function createExternalVideoActivity(
  data: any,
  activity: any,
  chapter_id: any,
  access_token: string
) {
  // add coursechapter_id to data
  data.chapter_id = chapter_id
  data.activity_id = activity.id
  
  // Add video details with null checking
  const defaultDetails = {
    startTime: 0,
    endTime: null,
    autoplay: false,
    muted: false
  }

  const videoDetails = data.details ? {
    startTime: data.details.startTime ?? defaultDetails.startTime,
    endTime: data.details.endTime ?? defaultDetails.endTime,
    autoplay: data.details.autoplay ?? defaultDetails.autoplay,
    muted: data.details.muted ?? defaultDetails.muted
  } : defaultDetails

  data.details = JSON.stringify(videoDetails)

  const result = await fetch(
    `${getAPIUrl()}activities/external_video`,
    RequestBodyWithAuthHeader('POST', data, null, access_token)
  )
  const res = await result.json()
  return res
}

export async function getActivity(
  activity_uuid: any,
  next: any,
  access_token: string
) {
  const result = await fetch(
    `${getAPIUrl()}activities/${activity_uuid}`,
    RequestBodyWithAuthHeader('GET', null, next, access_token)
  )
  const res = await result.json()
  return res
}

export async function getActivityByID(
  activity_id: any,
  next: any,
  access_token: string
) {
  const result = await fetch(
    `${getAPIUrl()}activities/id/${activity_id}`,
    RequestBodyWithAuthHeader('GET', null, next, access_token)
  )
  const res = await result.json()
  return res
}

export async function deleteActivity(activity_uuid: any, access_token: string) {
  const result = await fetch(
    `${getAPIUrl()}activities/${activity_uuid}`,
    RequestBodyWithAuthHeader('DELETE', null, null, access_token)
  )
  const res = await result.json()
  return res
}

export async function getActivityWithAuthHeader(
  activity_uuid: any,
  next: any,
  access_token: string | null | undefined
) {
  const result = await fetch(
    `${getAPIUrl()}activities/activity_${activity_uuid}`,
    RequestBodyWithAuthHeader('GET', null, next, access_token || undefined)
  )
  const res = await result.json()
  return res
}

export async function updateActivity(
  data: any,
  activity_uuid: string,
  access_token: string
) {
  const result = await fetch(
    `${getAPIUrl()}activities/${activity_uuid}`,
    RequestBodyWithAuthHeader('PUT', data, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function getUrlPreview(url: string) {
  const result = await fetch(
    `${getAPIUrl()}utils/link-preview?url=${url}`,
    RequestBodyWithAuthHeader('GET', null, null, undefined)
  )
  const res = await result.json()
  return res
}



================================================
FILE: apps/web/services/courses/activity.ts
================================================
import { RequestBodyWithAuthHeader, errorHandling } from '@services/utils/ts/requests'
import { getAPIUrl } from '@services/config/config'

/*
 This file includes only POST, PUT, DELETE requests
 GET requests are called from the frontend using SWR (https://swr.vercel.app/)
*/

export async function startCourse(course_uuid: string, org_slug: string,access_token:any) {
  const result: any = await fetch(
    `${getAPIUrl()}trail/add_course/${course_uuid}`,
    RequestBodyWithAuthHeader('POST', null, null,access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function removeCourse(course_uuid: string, org_slug: string,access_token:any) {
  const result: any = await fetch(
    `${getAPIUrl()}trail/remove_course/${course_uuid}`,
    RequestBodyWithAuthHeader('DELETE', null, null,access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function markActivityAsComplete(
  org_slug: string,
  course_uuid: string,
  activity_uuid: string,access_token:any
) {
  const result: any = await fetch(
    `${getAPIUrl()}trail/add_activity/${activity_uuid}`,
    RequestBodyWithAuthHeader('POST', null, null,access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function unmarkActivityAsComplete(
  org_slug: string,
  course_uuid: string,
  activity_uuid: string,
  access_token: any
) {
  const result: any = await fetch(
    `${getAPIUrl()}trail/remove_activity/${activity_uuid}`,
    RequestBodyWithAuthHeader('DELETE', null, null, access_token)
  )
  const res = await errorHandling(result)
  return res
}



================================================
FILE: apps/web/services/courses/assignments.ts
================================================
import { getAPIUrl } from '@services/config/config'
import {
  RequestBodyFormWithAuthHeader,
  RequestBodyWithAuthHeader,
  getResponseMetadata,
} from '@services/utils/ts/requests'

export async function createAssignment(body: any, access_token: string) {
  const result: any = await fetch(
    `${getAPIUrl()}assignments/`,
    RequestBodyWithAuthHeader('POST', body, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function updateAssignment(
  body: any,
  assignmentUUID: string,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}assignments/${assignmentUUID}`,
    RequestBodyWithAuthHeader('PUT', body, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function getAssignmentFromActivityUUID(
  activityUUID: string,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}assignments/activity/${activityUUID}`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

// Delete an assignment
export async function deleteAssignment(
  assignmentUUID: string,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}assignments/${assignmentUUID}`,
    RequestBodyWithAuthHeader('DELETE', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function deleteAssignmentUsingActivityUUID(
  activityUUID: string,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}assignments/activity/${activityUUID}`,
    RequestBodyWithAuthHeader('DELETE', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

// tasks

export async function createAssignmentTask(
  body: any,
  assignmentUUID: string,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}assignments/${assignmentUUID}/tasks`,
    RequestBodyWithAuthHeader('POST', body, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function getAssignmentTask(
  assignmentTaskUUID: string,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}assignments/task/${assignmentTaskUUID}`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function getAssignmentTaskSubmissionsMe(
  assignmentTaskUUID: string,
  assignmentUUID: string,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}assignments/${assignmentUUID}/tasks/${assignmentTaskUUID}/submissions/me`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function getAssignmentTaskSubmissionsUser(
  assignmentTaskUUID: string,
  user_id: string,
  assignmentUUID: string,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}assignments/${assignmentUUID}/tasks/${assignmentTaskUUID}/submissions/user/${user_id}`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function handleAssignmentTaskSubmission(
  body: any,
  assignmentTaskUUID: string,
  assignmentUUID: string,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}assignments/${assignmentUUID}/tasks/${assignmentTaskUUID}/submissions`,
    RequestBodyWithAuthHeader('PUT', body, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function updateAssignmentTask(
  body: any,
  assignmentTaskUUID: string,
  assignmentUUID: string,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}assignments/${assignmentUUID}/tasks/${assignmentTaskUUID}`,
    RequestBodyWithAuthHeader('PUT', body, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function deleteAssignmentTask(
  assignmentTaskUUID: string,
  assignmentUUID: string,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}assignments/${assignmentUUID}/tasks/${assignmentTaskUUID}`,
    RequestBodyWithAuthHeader('DELETE', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function updateReferenceFile(
  file: any,
  assignmentTaskUUID: string,
  assignmentUUID: string,
  access_token: string
) {
  // Send file thumbnail as form data
  const formData = new FormData()

  if (file) {
    formData.append('reference_file', file)
  }
  const result: any = await fetch(
    `${getAPIUrl()}assignments/${assignmentUUID}/tasks/${assignmentTaskUUID}/ref_file`,
    RequestBodyFormWithAuthHeader('POST', formData, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function updateSubFile(
  file: any,
  assignmentTaskUUID: string,
  assignmentUUID: string,
  access_token: string
) {
  // Send file thumbnail as form data
  const formData = new FormData()

  if (file) {
    formData.append('sub_file', file)
  }
  const result: any = await fetch(
    `${getAPIUrl()}assignments/${assignmentUUID}/tasks/${assignmentTaskUUID}/sub_file`,
    RequestBodyFormWithAuthHeader('POST', formData, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

// submissions

export async function submitAssignmentForGrading(
  assignmentUUID: string,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}assignments/${assignmentUUID}/submissions`,
    RequestBodyWithAuthHeader('POST', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function deleteUserSubmission(
  user_id: string,
  assignmentUUID: string,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}assignments/${assignmentUUID}/submissions/${user_id}`,
    RequestBodyWithAuthHeader('DELETE', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function putUserSubmission(
  body: any,
  user_id: string,
  assignmentUUID: string,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}assignments/${assignmentUUID}/submissions/${user_id}`,
    RequestBodyWithAuthHeader('PUT', body, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function putFinalGrade(
  user_id: string,
  assignmentUUID: string,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}assignments/${assignmentUUID}/submissions/${user_id}/grade`,
    RequestBodyWithAuthHeader('POST', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function getFinalGrade(
  user_id: string,
  assignmentUUID: string,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}assignments/${assignmentUUID}/submissions/${user_id}/grade`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function markActivityAsDoneForUser(
  user_id: string,
  assignmentUUID: string,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}assignments/${assignmentUUID}/submissions/${user_id}/done`,
    RequestBodyWithAuthHeader('POST', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function getAssignmentsFromACourse(
  courseUUID: string,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}assignments/course/${courseUUID}`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}



================================================
FILE: apps/web/services/courses/certifications.ts
================================================
import { getAPIUrl } from '@services/config/config'
import {
  RequestBodyWithAuthHeader,
  errorHandling,
  getResponseMetadata,
} from '@services/utils/ts/requests'

/*
 This file includes certification-related API calls
 GET requests are called from the frontend using SWR (https://swr.vercel.app/)
*/

export async function getCourseCertifications(
  course_uuid: string,
  next: any,
  access_token: string
) {
  const result = await fetch(
    `${getAPIUrl()}certifications/course/${course_uuid}`,
    RequestBodyWithAuthHeader('GET', null, next, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function createCertification(
  course_id: number,
  config: any,
  access_token: string
) {
  const result = await fetch(
    `${getAPIUrl()}certifications/`,
    RequestBodyWithAuthHeader('POST', { course_id, config }, null, access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function updateCertification(
  certification_uuid: string,
  config: any,
  access_token: string
) {
  const result = await fetch(
    `${getAPIUrl()}certifications/${certification_uuid}`,
    RequestBodyWithAuthHeader('PUT', { config }, null, access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function deleteCertification(
  certification_uuid: string,
  access_token: string
) {
  const result = await fetch(
    `${getAPIUrl()}certifications/${certification_uuid}`,
    RequestBodyWithAuthHeader('DELETE', null, null, access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function getUserCertificates(
  course_uuid: string,
  access_token: string
) {
  const result = await fetch(
    `${getAPIUrl()}certifications/user/course/${course_uuid}`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function getCertificateByUuid(
  user_certification_uuid: string
) {
  const result = await fetch(
    `${getAPIUrl()}certifications/certificate/${user_certification_uuid}`,
    {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
    }
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function getAllUserCertificates(
  access_token: string
) {
  const result = await fetch(
    `${getAPIUrl()}certifications/user/all`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
} 


================================================
FILE: apps/web/services/courses/chapters.ts
================================================
import { OrderPayload } from '@components/Dashboard/Pages/Course/EditCourseStructure/EditCourseStructure'
import { getAPIUrl } from '@services/config/config'
import {
  RequestBodyWithAuthHeader,
  errorHandling,
} from '@services/utils/ts/requests'

/*
 This file includes only POST, PUT, DELETE requests
 GET requests are called from the frontend using SWR (https://swr.vercel.app/)
*/

//TODO : depreciate this function
export async function getCourseChaptersMetadata(
  course_uuid: any,
  next: any,
  access_token: any
) {
  const result = await fetch(
    `${getAPIUrl()}chapters/meta/course_${course_uuid}`,
    RequestBodyWithAuthHeader('GET', null, next, access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function updateChaptersMetadata(
  course_uuid: any,
  data: any,
  access_token: any
) {
  const result: any = await fetch(
    `${getAPIUrl()}chapters/course/course_${course_uuid}/order`,
    RequestBodyWithAuthHeader('PUT', data, null, access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function updateChapter(
  coursechapter_id: any,
  data: any,
  access_token: any
) {
  const result: any = await fetch(
    `${getAPIUrl()}chapters/${coursechapter_id}`,
    RequestBodyWithAuthHeader('PUT', data, null, access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function updateCourseOrderStructure(
  course_uuid: any,
  data: OrderPayload,
  access_token: any
) {
  const result: any = await fetch(
    `${getAPIUrl()}chapters/course/${course_uuid}/order`,
    RequestBodyWithAuthHeader('PUT', data, null, access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function createChapter(data: any, access_token: any) {
  const result: any = await fetch(
    `${getAPIUrl()}chapters/`,
    RequestBodyWithAuthHeader('POST', data, null, access_token)
  )
  const res = await errorHandling(result)

  return res
}

export async function deleteChapter(coursechapter_id: any, access_token: any) {
  const result: any = await fetch(
    `${getAPIUrl()}chapters/${coursechapter_id}`,
    RequestBodyWithAuthHeader('DELETE', null, null, access_token)
  )
  const res = await errorHandling(result)
  return res
}



================================================
FILE: apps/web/services/courses/collections.ts
================================================
import { getAPIUrl } from '../config/config'
import {
  RequestBodyWithAuthHeader,
  errorHandling,
} from '@services/utils/ts/requests'

/*
 This file includes only POST, PUT, DELETE requests
 GET requests are called from the frontend using SWR (https://swr.vercel.app/)
*/

export async function deleteCollection(
  collection_uuid: any,
  access_token: any
) {
  const result: any = await fetch(
    `${getAPIUrl()}collections/${collection_uuid}`,
    RequestBodyWithAuthHeader('DELETE', null, null, access_token)
  )
  const res = await errorHandling(result)
  return res
}

// Create a new collection
export async function createCollection(collection: any, access_token: any) {
  const result: any = await fetch(
    `${getAPIUrl()}collections/`,
    RequestBodyWithAuthHeader('POST', collection, null, access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function getCollectionById(
  collection_uuid: any,
  access_token: string,
  next: any
) {
  const result: any = await fetch(
    `${getAPIUrl()}collections/collection_${collection_uuid}`,
    RequestBodyWithAuthHeader('GET', null, next, access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function getOrgCollections(
  org_id: string,
  access_token?: string,
  next?: any
) {
  const result: any = await fetch(
    `${getAPIUrl()}collections/org/${org_id}/page/1/limit/10`,
    RequestBodyWithAuthHeader('GET', null, next, access_token)
  )
  const res = await errorHandling(result)
  return res
}



================================================
FILE: apps/web/services/courses/courses.ts
================================================
import { getAPIUrl } from '@services/config/config'
import {
  RequestBodyFormWithAuthHeader,
  RequestBodyWithAuthHeader,
  errorHandling,
  getResponseMetadata,
} from '@services/utils/ts/requests'

/*
 This file includes only POST, PUT, DELETE requests
 GET requests are called from the frontend using SWR (https://swr.vercel.app/)
*/

export async function getOrgCourses(
  org_slug: string,
  next: any,
  access_token?: any
) {
  const result: any = await fetch(
    `${getAPIUrl()}courses/org_slug/${org_slug}/page/1/limit/10`,
    RequestBodyWithAuthHeader('GET', null, next, access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function searchOrgCourses(
  org_slug: string,
  query: string,
  page: number = 1,
  limit: number = 10,
  next: any,
  access_token?: any
) {
  const result: any = await fetch(
    `${getAPIUrl()}courses/org_slug/${org_slug}/search?query=${encodeURIComponent(query)}&page=${page}&limit=${limit}`,
    RequestBodyWithAuthHeader('GET', null, next, access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function getCourseMetadata(
  course_uuid: string,
  next: any,
  access_token: string | null | undefined
) {
  const result = await fetch(
    `${getAPIUrl()}courses/course_${course_uuid}/meta`,
    RequestBodyWithAuthHeader('GET', null, next, access_token || undefined)
  )
  const res = await errorHandling(result)
  return res
}

export async function updateCourse(course_uuid: any, data: any, access_token:any) {
  const result: any = await fetch(
    `${getAPIUrl()}courses/${course_uuid}`,
    RequestBodyWithAuthHeader('PUT', data, null,access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function getCourse(course_uuid: string, next: any, access_token:any) {
  const result: any = await fetch(
    `${getAPIUrl()}courses/${course_uuid}`,
    RequestBodyWithAuthHeader('GET', null, next,access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function getCourseById(course_id: string, next: any, access_token:any) {
  const result: any = await fetch(
    `${getAPIUrl()}courses/id/${course_id}`,
    RequestBodyWithAuthHeader('GET', null, next,access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function updateCourseThumbnail(course_uuid: any, formData: FormData, access_token:any) {
  const result: any = await fetch(
    `${getAPIUrl()}courses/${course_uuid}/thumbnail`,
    RequestBodyFormWithAuthHeader('PUT', formData, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function createNewCourse(
  org_id: string,
  course_body: any,
  thumbnail: any,
  access_token: any
) {
  // Send file thumbnail as form data
  const formData = new FormData()
  formData.append('name', course_body.name)
  formData.append('description', course_body.description)
  formData.append('public', course_body.visibility)
  formData.append('learnings', course_body.learnings)
  formData.append('tags', course_body.tags)
  formData.append('about', course_body.description)

  if (thumbnail) {
    formData.append('thumbnail', thumbnail)
  }

  const result = await fetch(
    `${getAPIUrl()}courses/?org_id=${org_id}`,
    RequestBodyFormWithAuthHeader('POST', formData, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function deleteCourseFromBackend(course_uuid: any, access_token:any) {
  const result: any = await fetch(
    `${getAPIUrl()}courses/${course_uuid}`,
    RequestBodyWithAuthHeader('DELETE', null, null,access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function getCourseContributors(course_uuid: string, access_token:string | null | undefined) {
  const result: any = await fetch(
    `${getAPIUrl()}courses/${course_uuid}/contributors`,
    RequestBodyWithAuthHeader('GET', null, null,access_token || undefined)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function editContributor(course_uuid: string, contributor_id: string, authorship: any, authorship_status: any, access_token:string | null | undefined) {
  const result: any = await fetch(
    `${getAPIUrl()}courses/${course_uuid}/contributors/${contributor_id}?authorship=${authorship}&authorship_status=${authorship_status}`,
    RequestBodyWithAuthHeader('PUT', null, null,access_token || undefined)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function applyForContributor(course_uuid: string, data: any, access_token:string | null | undefined) {
  const result: any = await fetch(
    `${getAPIUrl()}courses/${course_uuid}/apply-contributor`,
    RequestBodyWithAuthHeader('POST', data, null,access_token || undefined)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function bulkAddContributors(course_uuid: string, data: any, access_token:string | null | undefined) {
  const result: any = await fetch(
    `${getAPIUrl()}courses/${course_uuid}/bulk-add-contributors`,
    RequestBodyWithAuthHeader('POST', data, null,access_token || undefined)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function bulkRemoveContributors(course_uuid: string, data: any, access_token: string | null | undefined) {
  const result: any = await fetch(
    `${getAPIUrl()}courses/${course_uuid}/bulk-remove-contributors`,
    RequestBodyWithAuthHeader('PUT', data, null, access_token || undefined)
  )
  const res = await errorHandling(result)
  return res
}

export async function getCourseRights(course_uuid: string, access_token: string | null | undefined) {
  const result: any = await fetch(
    `${getAPIUrl()}courses/${course_uuid}/rights`,
    RequestBodyWithAuthHeader('GET', null, null, access_token || undefined)
  )
  const res = await errorHandling(result)
  return res
}


================================================
FILE: apps/web/services/courses/updates.ts
================================================
import { getAPIUrl } from '@services/config/config'
import {
  RequestBodyWithAuthHeader,
  getResponseMetadata,
} from '@services/utils/ts/requests'

export async function createCourseUpdate(body: any, access_token: string) {
  const result: any = await fetch(
    `${getAPIUrl()}courses/${body.course_uuid}/updates`,
    RequestBodyWithAuthHeader('POST', body, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function deleteCourseUpdate(
  course_uuid: string,
  update_uuid: number,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}courses/${course_uuid}/update/${update_uuid}`,
    RequestBodyWithAuthHeader('DELETE', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}



================================================
FILE: apps/web/services/media/media.ts
================================================
import { getBackendUrl, getConfig } from '@services/config/config'

function getMediaUrl() {
  const mediaUrl = getConfig('NEXT_PUBLIC_LEARNHOUSE_MEDIA_URL');
  if (mediaUrl) {
    return mediaUrl;
  } else {
    return getBackendUrl();
  }
}

export function getCourseThumbnailMediaDirectory(
  orgUUID: string,
  courseUUID: string,
  fileId: string
) {
  let uri = `${getMediaUrl()}content/orgs/${orgUUID}/courses/${courseUUID}/thumbnails/${fileId}`
  return uri
}

export function getOrgLandingMediaDirectory(orgUUID: string, fileId: string) {
  let uri = `${getMediaUrl()}content/orgs/${orgUUID}/landing/${fileId}`
  return uri
}

export function getUserAvatarMediaDirectory(userUUID: string, fileId: string) {
  let uri = `${getMediaUrl()}content/users/${userUUID}/avatars/${fileId}`
  return uri
}

export function getActivityBlockMediaDirectory(
  orgUUID: string,
  courseId: string,
  activityId: string,
  blockId: any,
  fileId: any,
  type: string
) {
  if (type == 'pdfBlock') {
    let uri = `${getMediaUrl()}content/orgs/${orgUUID}/courses/${courseId}/activities/${activityId}/dynamic/blocks/pdfBlock/${blockId}/${fileId}`
    return uri
  }
  if (type == 'videoBlock') {
    let uri = `${getMediaUrl()}content/orgs/${orgUUID}/courses/${courseId}/activities/${activityId}/dynamic/blocks/videoBlock/${blockId}/${fileId}`
    return uri
  }
  if (type == 'imageBlock') {
    let uri = `${getMediaUrl()}content/orgs/${orgUUID}/courses/${courseId}/activities/${activityId}/dynamic/blocks/imageBlock/${blockId}/${fileId}`
    return uri
  }
}

export function getTaskRefFileDir(
  orgUUID: string,
  courseUUID: string,
  activityUUID: string,
  assignmentUUID: string,
  assignmentTaskUUID: string,
  fileID : string

) {
  let uri = `${getMediaUrl()}content/orgs/${orgUUID}/courses/${courseUUID}/activities/${activityUUID}/assignments/${assignmentUUID}/tasks/${assignmentTaskUUID}/${fileID}`
  return uri
}

export function getTaskFileSubmissionDir(
  orgUUID: string,
  courseUUID: string,
  activityUUID: string,
  assignmentUUID: string,
  assignmentTaskUUID: string,
  fileSubID : string
) {
  let uri = `${getMediaUrl()}content/orgs/${orgUUID}/courses/${courseUUID}/activities/${activityUUID}/assignments/${assignmentUUID}/tasks/${assignmentTaskUUID}/subs/${fileSubID}`
  return uri
}

export function getActivityMediaDirectory(
  orgUUID: string,
  courseUUID: string,
  activityUUID: string,
  fileId: string,
  activityType: string
) {
  if (activityType == 'video') {
    let uri = `${getMediaUrl()}content/orgs/${orgUUID}/courses/${courseUUID}/activities/${activityUUID}/video/${fileId}`
    return uri
  }
  if (activityType == 'documentpdf') {
    let uri = `${getMediaUrl()}content/orgs/${orgUUID}/courses/${courseUUID}/activities/${activityUUID}/documentpdf/${fileId}`
    return uri
  }
}

export function getOrgLogoMediaDirectory(orgUUID: string, fileId: string) {
  let uri = `${getMediaUrl()}content/orgs/${orgUUID}/logos/${fileId}`
  return uri
}

export function getOrgThumbnailMediaDirectory(orgUUID: string, fileId: string) {
  let uri = `${getMediaUrl()}content/orgs/${orgUUID}/thumbnails/${fileId}`
  return uri
}

export function getOrgPreviewMediaDirectory(orgUUID: string, fileId: string) {
  let uri = `${getMediaUrl()}content/orgs/${orgUUID}/previews/${fileId}`
  return uri
}



================================================
FILE: apps/web/services/organizations/invites.ts
================================================
import { getAPIUrl } from '@services/config/config'
import {
  RequestBodyWithAuthHeader,
  getResponseMetadata,
} from '@services/utils/ts/requests'

export async function createInviteCode(org_id: any, access_token: any) {
  const result = await fetch(
    `${getAPIUrl()}orgs/${org_id}/invites`,
    RequestBodyWithAuthHeader('POST', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function createInviteCodeWithUserGroup(
  org_id: any,
  usergroup_id: number,
  access_token: any
) {
  const result = await fetch(
    `${getAPIUrl()}orgs/${org_id}/invites_with_usergroups?usergroup_id=${usergroup_id}`,
    RequestBodyWithAuthHeader('POST', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function deleteInviteCode(
  org_id: any,
  org_invite_code_uuid: string,
  access_token: any
) {
  const result = await fetch(
    `${getAPIUrl()}orgs/${org_id}/invites/${org_invite_code_uuid}`,
    RequestBodyWithAuthHeader('DELETE', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function changeSignupMechanism(
  org_id: any,
  signup_mechanism: string,
  access_token: any
) {
  const result = await fetch(
    `${getAPIUrl()}orgs/${org_id}/signup_mechanism?signup_mechanism=${signup_mechanism}`,
    RequestBodyWithAuthHeader('PUT', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function validateInviteCode(
  org_id: any,
  invite_code: string,
  access_token: any
) {
  const result = await fetch(
    `${getAPIUrl()}orgs/${org_id}/invites/code/${invite_code}`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function inviteBatchUsers(
  org_id: any,
  emails: string,
  invite_code_uuid: string,
  access_token: any
) {
  const result = await fetch(
    `${getAPIUrl()}orgs/${org_id}/invites/users/batch?emails=${emails}&invite_code_uuid=${invite_code_uuid}`,
    RequestBodyWithAuthHeader('POST', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}



================================================
FILE: apps/web/services/organizations/orgs.ts
================================================
import { getAPIUrl } from '@services/config/config'
import {
  RequestBodyFormWithAuthHeader,
  RequestBodyWithAuthHeader,
  errorHandling,
  getResponseMetadata,
} from '@services/utils/ts/requests'

/*
 This file includes only POST, PUT, DELETE requests
 GET requests are called from the frontend using SWR (https://swr.vercel.app/)
*/

export async function createNewOrganization(body: any, access_token: string) {
  const result = await fetch(
    `${getAPIUrl()}orgs/`,
    RequestBodyWithAuthHeader('POST', body, null, access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function deleteOrganizationFromBackend(
  org_id: any,
  access_token: string
) {
  const result = await fetch(
    `${getAPIUrl()}orgs/${org_id}`,
    RequestBodyWithAuthHeader('DELETE', null, null, access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function getOrganizationContextInfo(
  org_slug: any,
  next: any,
  access_token?: string
) {
  const result = await fetch(
    `${getAPIUrl()}orgs/slug/${org_slug}`,
    RequestBodyWithAuthHeader('GET', null, next, access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function getOrganizationContextInfoWithId(
  org_id: any,
  next: any,
  access_token: string
) {
  const result = await fetch(
    `${getAPIUrl()}orgs/${org_id}`,
    RequestBodyWithAuthHeader('GET', null, next, access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function getOrganizationContextInfoWithoutCredentials(
  org_slug: any,
  next: any
) {
  let HeadersConfig = new Headers({ 'Content-Type': 'application/json' })
  let options: any = {
    method: 'GET',
    headers: HeadersConfig,
    redirect: 'follow',
    // Next.js
    next: next,
  }

  const result = await fetch(`${getAPIUrl()}orgs/slug/${org_slug}`, options)
  const res = await errorHandling(result)
  return res
}

export function getOrganizationContextInfoNoAsync(
  org_slug: any,
  next: any,
  access_token: string
) {
  const result = fetch(
    `${getAPIUrl()}orgs/slug/${org_slug}`,
    RequestBodyWithAuthHeader('GET', null, next, access_token)
  )
  return result
}

export async function updateUserRole(
  org_id: any,
  user_id: any,
  role_uuid: any,
  access_token: string
) {
  const result = await fetch(
    `${getAPIUrl()}orgs/${org_id}/users/${user_id}/role/${role_uuid}`,
    RequestBodyWithAuthHeader('PUT', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function updateOrgLanding(
  org_id: any,
  landing_object: any,
  access_token: string
) {
  const result = await fetch(
    `${getAPIUrl()}orgs/${org_id}/landing`,
    RequestBodyWithAuthHeader('PUT', landing_object, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function uploadLandingContent(
  org_uuid: any,
  content_file: File,
  access_token: string
) {
  const formData = new FormData()
  formData.append('content_file', content_file)
  
  const result = await fetch(
    `${getAPIUrl()}orgs/${org_uuid}/landing/content`,
    RequestBodyFormWithAuthHeader('POST', formData, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function removeUserFromOrg(
  org_id: any,
  user_id: any,
  access_token: any
) {
  const result = await fetch(
    `${getAPIUrl()}orgs/${org_id}/users/${user_id}`,
    RequestBodyWithAuthHeader('DELETE', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function joinOrg(
  args: {
    org_id: number
    user_id: string
    invite_code?: string
  },
  next: any,
  access_token?: string
) {
  const result = await fetch(
    `${getAPIUrl()}orgs/join`,
    RequestBodyWithAuthHeader('POST', args, next, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}



================================================
FILE: apps/web/services/payments/payments.ts
================================================
'use server';
import { getAPIUrl } from '@services/config/config';
import { RequestBodyWithAuthHeader, errorHandling } from '@services/utils/ts/requests';

export async function getPaymentConfigs(orgId: number, access_token: string) {
  const result = await fetch(
    `${getAPIUrl()}payments/${orgId}/config`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  );
  const res = await errorHandling(result);
  return res;
}

export async function checkPaidAccess(courseId: number, orgId: number, access_token: string) {
  const result = await fetch(
    `${getAPIUrl()}payments/${orgId}/courses/${courseId}/access`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  );
  const res = await errorHandling(result);
  return res;
}

export async function initializePaymentConfig(orgId: number, data: any, provider: string, access_token: string) {
  const result = await fetch(
    `${getAPIUrl()}payments/${orgId}/config?provider=${provider}`,
    RequestBodyWithAuthHeader('POST', data, null, access_token)
  );
  const res = await errorHandling(result);
  return res;
}

export async function updatePaymentConfig(orgId: number, id: string, data: any, access_token: string) {
  const result = await fetch(
    `${getAPIUrl()}payments/${orgId}/config?id=${id}`,
    RequestBodyWithAuthHeader('PUT', data, null, access_token)
  );
  const res = await errorHandling(result);
  return res;
}

export async function updateStripeAccountID(orgId: number, data: any, access_token: string) {
  const result = await fetch(
    `${getAPIUrl()}payments/${orgId}/stripe/account?stripe_account_id=${data.stripe_account_id}`,
    RequestBodyWithAuthHeader('PUT', data, null, access_token)
  );
  const res = await errorHandling(result);
  return res;
}

export async function getStripeOnboardingLink(orgId: number, access_token: string, redirect_uri: string) {
  const result = await fetch(
    `${getAPIUrl()}payments/${orgId}/stripe/connect/link?redirect_uri=${redirect_uri}`,
    RequestBodyWithAuthHeader('POST', null, null, access_token)
  );
  const res = await errorHandling(result);
  return res;
}

export async function verifyStripeConnection(orgId: number, code: string, access_token: string) {
  const result = await fetch(
    `${getAPIUrl()}payments/stripe/oauth/callback?code=${code}&org_id=${orgId}`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  );
  const res = await errorHandling(result);
  return res;
}

export async function deletePaymentConfig(orgId: number, id: string, access_token: string) {
  const result = await fetch(
    `${getAPIUrl()}payments/${orgId}/config?id=${id}`,
    RequestBodyWithAuthHeader('DELETE', null, null, access_token)
  );
  const res = await errorHandling(result);
  return res;
}

export async function getOrgCustomers(orgId: number, access_token: string) {
  const result = await fetch(
    `${getAPIUrl()}payments/${orgId}/customers`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  );
  const res = await errorHandling(result);
  return res;
}

export async function getOwnedCourses(orgId: number, access_token: string) {
  const result = await fetch(
    `${getAPIUrl()}payments/${orgId}/courses/owned`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  );
  const res = await errorHandling(result);
  return res;
}


================================================
FILE: apps/web/services/payments/products.ts
================================================
'use server';
import { getAPIUrl } from '@services/config/config';
import { RequestBodyWithAuthHeader, getResponseMetadata } from '@services/utils/ts/requests';

export async function getProducts(orgId: number, access_token: string) {
  const result = await fetch(
    `${getAPIUrl()}payments/${orgId}/products`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  );
  const res = await getResponseMetadata(result);
  return res;
}

export async function createProduct(orgId: number, data: any, access_token: string) {
  const result = await fetch(
    `${getAPIUrl()}payments/${orgId}/products`,
    RequestBodyWithAuthHeader('POST', data, null, access_token)
  );
  const res = await getResponseMetadata(result);
  return res;
}

export async function updateProduct(orgId: number, productId: string, data: any, access_token: string) {
  const result = await fetch(
    `${getAPIUrl()}payments/${orgId}/products/${productId}`,
    RequestBodyWithAuthHeader('PUT', data, null, access_token)
  );
  const res = await getResponseMetadata(result);
  return res;
}

export async function archiveProduct(orgId: number, productId: string, access_token: string) {
  const result = await fetch(
    `${getAPIUrl()}payments/${orgId}/products/${productId}`,
    RequestBodyWithAuthHeader('DELETE', null, null, access_token)
  );
  const res = await getResponseMetadata(result);
  return res;
}

export async function getProductDetails(orgId: number, productId: string, access_token: string) {
  const result = await fetch(
    `${getAPIUrl()}payments/${orgId}/products/${productId}`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  );
  const res = await getResponseMetadata(result);
  return res;
}

export async function linkCourseToProduct(orgId: number, productId: string, courseId: string, access_token: string) {
  const result = await fetch(
    `${getAPIUrl()}payments/${orgId}/products/${productId}/courses/${courseId}`,
    RequestBodyWithAuthHeader('POST', null, null, access_token)
  );
  const res = await getResponseMetadata(result);
  return res;
}

export async function unlinkCourseFromProduct(orgId: number, productId: string, courseId: string, access_token: string) {
  const result = await fetch(
    `${getAPIUrl()}payments/${orgId}/products/${productId}/courses/${courseId}`,
    RequestBodyWithAuthHeader('DELETE', null, null, access_token)
  );
  const res = await getResponseMetadata(result);
  return res;
}

export async function getCoursesLinkedToProduct(orgId: number, productId: string, access_token: string) {
  const result = await fetch(
    `${getAPIUrl()}payments/${orgId}/products/${productId}/courses`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  );
  const res = await getResponseMetadata(result);
  return res;
}

export async function getProductsByCourse(orgId: number, courseId: string, access_token: string) {
  const result = await fetch(
    `${getAPIUrl()}payments/${orgId}/courses/${courseId}/products`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  );
  const res = await getResponseMetadata(result);
  return res;
}

export async function getStripeProductCheckoutSession(orgId: number, productId: number, redirect_uri: string, access_token: string) {
  const result = await fetch(
    `${getAPIUrl()}payments/${orgId}/stripe/checkout/product/${productId}?redirect_uri=${redirect_uri}`,
    RequestBodyWithAuthHeader('POST', null, null, access_token)
  );
  const res = await getResponseMetadata(result);
  return res;
}




================================================
FILE: apps/web/services/roles/roles.ts
================================================
import { getAPIUrl } from '@services/config/config'
import { RequestBodyWithAuthHeader, getResponseMetadata } from '@services/utils/ts/requests'

/*
  Roles service matching available endpoints:
  - GET    roles/org/{org_id}
  - POST   roles/org/{org_id}
  - GET    roles/{role_id}
  - PUT    roles/{role_id}
  - DELETE roles/{role_id}

  Note: GET requests are usually fetched with SWR directly from components.
*/

export type CreateOrUpdateRoleBody = {
  name: string
  description?: string
  rights: any
  org_id?: number
}

export async function createRole(body: CreateOrUpdateRoleBody, access_token: string) {
  const { org_id, ...payload } = body
  if (!org_id) throw new Error('createRole requires org_id in body')
  const result = await fetch(
    `${getAPIUrl()}roles/org/${org_id}`,
    RequestBodyWithAuthHeader('POST', payload, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function getRole(role_id: number | string, access_token?: string) {
  const result = await fetch(
    `${getAPIUrl()}roles/${role_id}`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function updateRole(
  role_id: number | string,
  body: CreateOrUpdateRoleBody,
  access_token: string
) {
  const result = await fetch(
    `${getAPIUrl()}roles/${role_id}`,
    RequestBodyWithAuthHeader('PUT', body, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function deleteRole(
  role_id: number | string,
  _org_id: number | string | undefined,
  access_token: string
) {
  const result = await fetch(
    `${getAPIUrl()}roles/${role_id}`,
    RequestBodyWithAuthHeader('DELETE', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

 


================================================
FILE: apps/web/services/search/search.ts
================================================
import { RequestBodyWithAuthHeader } from "@services/utils/ts/requests"
import { getAPIUrl } from "@services/config/config"
import { getResponseMetadata } from "@services/utils/ts/requests"

export async function searchOrgContent(
    org_slug: string,
    query: string,
    page: number = 1,
    limit: number = 10,
    next: any,
    access_token?: any
  ) {
    const result: any = await fetch(
      `${getAPIUrl()}search/org_slug/${org_slug}?query=${encodeURIComponent(query)}&page=${page}&limit=${limit}`,
      RequestBodyWithAuthHeader('GET', null, next, access_token)
    )
    const res = await getResponseMetadata(result)
    return res
  }


================================================
FILE: apps/web/services/settings/org.ts
================================================
import { getAPIUrl } from '@services/config/config'
import {
  errorHandling,
  RequestBodyWithAuthHeader,
  RequestBodyFormWithAuthHeader,
} from '@services/utils/ts/requests'

/*
 This file includes only POST, PUT, DELETE requests
 GET requests are called from the frontend using SWR (https://swr.vercel.app/)
*/

export async function updateOrganization(
  org_id: string,
  data: any,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}orgs/` + org_id,
    RequestBodyWithAuthHeader('PUT', data, null, access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function uploadOrganizationLogo(
  org_id: string,
  logo_file: any,
  access_token: string
) {
  // Send file thumbnail as form data
  const formData = new FormData()
  formData.append('logo_file', logo_file)
  const result: any = await fetch(
    `${getAPIUrl()}orgs/` + org_id + '/logo',
    RequestBodyFormWithAuthHeader('PUT', formData, null, access_token)
  )
  const res = await errorHandling(result)
  return res
}

export async function uploadOrganizationThumbnail(
  org_id: string,
  thumbnail_file: any,
  access_token: string
) {
  // Send file thumbnail as form data
  const formData = new FormData()
  formData.append('thumbnail_file', thumbnail_file)
  const result: any = await fetch(
    `${getAPIUrl()}orgs/` + org_id + '/thumbnail',
    RequestBodyFormWithAuthHeader('PUT', formData, null, access_token)
  )
  const res = await errorHandling(result)
  return res
}

export const uploadOrganizationPreview = async (orgId: string, file: File, access_token: string) => {
  const formData = new FormData();
  formData.append('preview_file', file);

  const result: any = await fetch(
    `${getAPIUrl()}orgs/` + orgId + '/preview',
    RequestBodyFormWithAuthHeader('PUT', formData, null, access_token)
  )
  const res = await errorHandling(result)
  return res
};



================================================
FILE: apps/web/services/settings/password.ts
================================================
import { getAPIUrl } from '@services/config/config'
import {
  RequestBodyWithAuthHeader,
  getResponseMetadata,
} from '@services/utils/ts/requests'

/*
 This file includes only POST, PUT, DELETE requests
 GET requests are called from the frontend using SWR (https://swr.vercel.app/)
*/

export async function updatePassword(
  user_id: string,
  data: any,
  access_token: any
) {
  const result: any = await fetch(
    `${getAPIUrl()}users/change_password/` + user_id,
    RequestBodyWithAuthHeader('PUT', data, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}



================================================
FILE: apps/web/services/settings/profile.ts
================================================
import { getAPIUrl } from '@services/config/config'
import {
  RequestBodyWithAuthHeader,
  getResponseMetadata,
} from '@services/utils/ts/requests'

/*
 This file includes only POST, PUT, DELETE requests
 GET requests are called from the frontend using SWR (https://swr.vercel.app/)
*/

export async function updateProfile(
  data: any,
  user_id: number,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}users/` + user_id,
    RequestBodyWithAuthHeader('PUT', data, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}



================================================
FILE: apps/web/services/usergroups/usergroups.ts
================================================
import { getAPIUrl } from '@services/config/config'
import {
  RequestBodyWithAuthHeader,
  getResponseMetadata,
} from '@services/utils/ts/requests'

export async function getUserGroups(org_id: any, access_token: string) {
  const result: any = await fetch(
    `${getAPIUrl()}usergroups/org/${org_id}`,
    RequestBodyWithAuthHeader('GET', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function createUserGroup(body: any, access_token: string) {
  const result: any = await fetch(
    `${getAPIUrl()}usergroups/`,
    RequestBodyWithAuthHeader('POST', body, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function linkUserToUserGroup(
  usergroup_id: any,
  user_id: any,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}usergroups/${usergroup_id}/add_users?user_ids=${user_id}`,
    RequestBodyWithAuthHeader('POST', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function unLinkUserToUserGroup(
  usergroup_id: any,
  user_id: any,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}usergroups/${usergroup_id}/remove_users?user_ids=${user_id}`,
    RequestBodyWithAuthHeader('DELETE', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function updateUserGroup(
  usergroup_id: number,
  access_token: string,
  data: any
) {
  const result: any = await fetch(
    `${getAPIUrl()}usergroups/${usergroup_id}`,
    RequestBodyWithAuthHeader('PUT', data, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function deleteUserGroup(
  usergroup_id: number,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}usergroups/${usergroup_id}`,
    RequestBodyWithAuthHeader('DELETE', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function linkResourcesToUserGroup(
  usergroup_id: any,
  resource_uuids: any,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}usergroups/${usergroup_id}/add_resources?resource_uuids=${resource_uuids}`,
    RequestBodyWithAuthHeader('POST', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}

export async function unLinkResourcesToUserGroup(
  usergroup_id: any,
  resource_uuids: any,
  access_token: string
) {
  const result: any = await fetch(
    `${getAPIUrl()}usergroups/${usergroup_id}/remove_resources?resource_uuids=${resource_uuids}`,
    RequestBodyWithAuthHeader('DELETE', null, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}



================================================
FILE: apps/web/services/users/users.ts
================================================
import { getAPIUrl } from '@services/config/config'
import {
  RequestBody,
  RequestBodyFormWithAuthHeader,
  RequestBodyWithAuthHeader,
  errorHandling,
  getResponseMetadata,
} from '@services/utils/ts/requests'

export async function getUser(user_id: string, access_token?: string) {
  const result = await fetch(
    `${getAPIUrl()}users/id/${user_id}`,
    access_token ? RequestBodyWithAuthHeader('GET', null, null, access_token) : RequestBody('GET', null, null)
  )
  const res = await errorHandling(result)
  return res
}

export async function getUserByUsername(username: string, access_token?: string) {
  const result = await fetch(
    `${getAPIUrl()}users/username/${username}`,
    access_token ? RequestBodyWithAuthHeader('GET', null, null, access_token) : RequestBody('GET', null, null)
  )
  const res = await errorHandling(result)
  return res
}

export async function getCoursesByUser(user_id: string, access_token?: string) {
  const result = await fetch(
    `${getAPIUrl()}users/${user_id}/courses`,
    access_token ? RequestBodyWithAuthHeader('GET', null, null, access_token) : RequestBody('GET', null, null)
  )
  const res = await getResponseMetadata(result)
  return res
}
export async function updateUserAvatar(
  user_uuid: any,
  avatar_file: any,
  access_token: any
) {
  const formData = new FormData()
  formData.append('avatar_file', avatar_file)
  const result: any = await fetch(
    `${getAPIUrl()}users/update_avatar/${user_uuid}`,
    RequestBodyFormWithAuthHeader('PUT', formData, null, access_token)
  )
  const res = await getResponseMetadata(result)
  return res
}



================================================
FILE: apps/web/services/utils/health.ts
================================================
import { getAPIUrl } from '@services/config/config'
import {
  RequestBody,
  getResponseMetadata,
} from '@services/utils/ts/requests'

export async function checkHealth() {
  try {
    const result = await fetch(
      `${getAPIUrl()}health`,
      RequestBody('GET', null, null)
    )
    
    if (!result.ok) {
      return {
        success: false,
        status: result.status,
        HTTPmessage: result.statusText,
        data: null
      }
    }
    
    const res = await getResponseMetadata(result)
    return res
  } catch (error) {
    return {
      success: false,
      status: 503,
      HTTPmessage: 'Service unavailable',
      data: null
    }
  }
}



================================================
FILE: apps/web/services/utils/react/middlewares/views.ts
================================================
import { AppRouterInstance } from 'next/dist/shared/lib/app-router-context.shared-runtime'

export const denyAccessToUser = (error: any, router: AppRouterInstance) => {
  if (error.status === 401) {
    router.push('/login')
  }

  if (error.status === 403) {
    router.push('/login')
    // TODO : add a message to the user to tell him he is not allowed to access this page, route to /error
  }
}



================================================
FILE: apps/web/services/utils/ts/requests.ts
================================================
import { getUriWithOrg } from '@services/config/config'

export const RequestBody = (method: string, data: any, next: any) => {
  let HeadersConfig = new Headers({ 'Content-Type': 'application/json' })
  let options: any = {
    method: method,
    headers: HeadersConfig,
    redirect: 'follow',
    credentials: 'include',
    // Next.js
    next: next,
  }
  if (data) {
    options.body = JSON.stringify(data)
  }
  return options
}

export const RequestBodyWithAuthHeader = (
  method: string,
  data: any,
  next: any,
  token?: string
) => {
  let HeadersConfig = new Headers(
    token
      ? { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` }
      : { 'Content-Type': 'application/json' }
  )
  let options: any = {
    method: method,
    headers: HeadersConfig,
    redirect: 'follow',
    credentials: 'include',
    body: (method === 'POST' || method === 'PUT' || method === 'DELETE') && data !== null ? JSON.stringify(data) : null,
    // Next.js
    next: next,
  }
  return options
}

export const RequestBodyForm = (method: string, data: any, next: any) => {
  let HeadersConfig = new Headers({})
  let options: any = {
    method: method,
    headers: HeadersConfig,
    redirect: 'follow',
    credentials: 'include',
    body: (method === 'POST' || method === 'PUT') ? JSON.stringify(data) : null,
    // Next.js
    next: next,
  }
  return options
}

export const RequestBodyFormWithAuthHeader = (
  method: string,
  data: any,
  next: any,
  access_token: string
) => {
  let HeadersConfig = new Headers({
    Authorization: `Bearer ${access_token}`,
  })
  let options: any = {
    method: method,
    headers: HeadersConfig,
    redirect: 'follow',
    credentials: 'include',
    body: data,
    // Next.js
    next: next,
  }
  return options
}

export const swrFetcher = async (url: string, token?: string) => {
  // Create the request options
  let HeadersConfig = new Headers(
    token
      ? { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` }
      : { 'Content-Type': 'application/json' }
  )
  let options: any = {
    method: 'GET',
    headers: HeadersConfig,
    redirect: 'follow',
    credentials: 'include',
  }

  try {
    // Fetch the data
    const request = await fetch(url, options)
    let res = errorHandling(request)

    // Return the data
    return res
  } catch (error: any) {
    throw error
  }
}

export const errorHandling = (res: any) => {
  if (!res.ok) {
    const error: any = new Error(`${res.statusText}`)
    error.status = res.status
    throw error
  }
  return res.json()
}

type CustomResponseTyping = {
  success: boolean
  data: any
  status: number
  HTTPmessage: string
}

export const getResponseMetadata = async (
  fetch_result: any
): Promise<CustomResponseTyping> => {
  const json = await fetch_result.json()
  if (fetch_result.status === 200) {
    return {
      success: true,
      data: json,
      status: fetch_result.status,
      HTTPmessage: fetch_result.statusText,
    }
  } else {
    return {
      success: false,
      data: json,
      status: fetch_result.status,
      HTTPmessage: fetch_result.statusText,
    }
  }
}

export const revalidateTags = async (tags: string[], orgslug: string) => {
  const url = getUriWithOrg(orgslug, '')
  tags.forEach((tag) => {
    fetch(`${url}/api/revalidate?tag=${tag}`)
  })
}



================================================
FILE: apps/web/styles/globals.css
================================================
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700;1,400;1,500&display=swap')
layer(base);
/*
  ---break---
*/
@plugin 'tailwindcss-animate';

@import 'tailwindcss';

@custom-variant dark (&:is(.dark *));

@theme {
  --radius-lg: var(--radius);
  --radius-md: calc(var(--radius) - 2px);
  --radius-sm: calc(var(--radius) - 4px);

  --color-background: hsl(var(--background));
  --color-foreground: hsl(var(--foreground));

  --color-card: hsl(var(--card));
  --color-card-foreground: hsl(var(--card-foreground));

  --color-popover: hsl(var(--popover));
  --color-popover-foreground: hsl(var(--popover-foreground));

  --color-primary: hsl(var(--primary));
  --color-primary-foreground: hsl(var(--primary-foreground));

  --color-secondary: hsl(var(--secondary));
  --color-secondary-foreground: hsl(var(--secondary-foreground));

  --color-muted: hsl(var(--muted));
  --color-muted-foreground: hsl(var(--muted-foreground));

  --color-accent: hsl(var(--accent));
  --color-accent-foreground: hsl(var(--accent-foreground));

  --color-destructive: hsl(var(--destructive));
  --color-destructive-foreground: hsl(var(--destructive-foreground));

  --color-border: hsl(var(--border));
  --color-input: hsl(var(--input));
  --color-ring: hsl(var(--ring));

  --color-chart-1: hsl(var(--chart-1));
  --color-chart-2: hsl(var(--chart-2));
  --color-chart-3: hsl(var(--chart-3));
  --color-chart-4: hsl(var(--chart-4));
  --color-chart-5: hsl(var(--chart-5));
}

/*
  The default border color has changed to `currentColor` in Tailwind CSS v4,
  so we've added these compatibility styles to make sure everything still
  looks the same as it did with Tailwind CSS v3.

  If we ever want to remove these styles, we need to add an explicit border
  color utility to any element that depends on these defaults.
*/
@layer base {
  *,
  ::after,
  ::before,
  ::backdrop,
  ::file-selector-button {
    border-color: var(--color-gray-200, currentColor);
  }
}

@layer utilities {
  .nice-shadow {
    @apply shadow-md shadow-gray-300/25 outline outline-1 outline-neutral-200/40;
  }

  .light-shadow {
    @apply shadow-lg shadow-gray-300/15 outline outline-1 outline-neutral-200/30;
  }

  /* Hide scrollbar while maintaining scroll functionality */
  .scrollbar-hide {
    -ms-overflow-style: none;  /* Internet Explorer 10+ */
    scrollbar-width: none;  /* Firefox */
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;  /* Safari and Chrome */
  }

  .custom-dots-bg {
    @apply bg-fixed;
    background-image:
      radial-gradient(#4744446b 1px, transparent 1px),
      radial-gradient(#4744446b 1px, transparent 1px);
    background-position:
      0 0,
      25px 25px;
    background-size: 50px 50px;
    background-repeat: repeat;
  }

  html,
  body {
    padding: 0;
    margin: 0;
    transition: all 0.2s ease;
    font-family:
      'DM Sans',
      -apple-system,
      BlinkMacSystemFont,
      Segoe UI,
      Roboto,
      Oxygen,
      Ubuntu,
      Cantarell,
      Fira Sans,
      Droid Sans,
      Helvetica Neue,
      sans-serif;
  }

  a {
    color: inherit;
    text-decoration: none;
  }

  button {
    @apply cursor-pointer;
  }

  * {
    box-sizing: border-box;
  }

  @media (prefers-color-scheme: dark) {
    body {
      color: black;
      background: #fbfbfb;
    }
  }

  /* Basic editor styles */
  .ProseMirror > * + * {
    margin-top: 0.75em;
  }
  /* Placeholder (at the top) */
  .ProseMirror p.is-editor-empty:first-child::before {
    color: #adb5bd;
    content: attr(data-placeholder);
    float: left;
    height: 0;
    pointer-events: none;
  }
  /* Give a remote user a caret */
  .collaboration-cursor__caret {
    border-left: 1px solid #0d0d0d;
    border-right: 1px solid #0d0d0d;
    margin-left: -1px;
    margin-right: -1px;
    pointer-events: none;
    position: relative;
    word-break: normal;
  }
  /* Render the username above the caret */
  .collaboration-cursor__label {
    border-radius: 3px 3px 3px 0;
    color: #0d0d0d;
    font-size: 12px;
    font-style: normal;
    font-weight: 600;
    left: -1px;
    line-height: normal;
    padding: 0.1rem 0.3rem;
    position: absolute;
    top: -1.4em;
    user-select: none;
    white-space: nowrap;
  }

  .fade-enter {
    opacity: 0;
    transform: translateY(-20px);
  }

  .fade-enter-active {
    opacity: 1;
    transform: translateY(0);
    transition:
      opacity 300ms,
      transform 300ms;
  }

  .fade-exit {
    opacity: 1;
    transform: translateY(0);
  }

  .fade-exit-active {
    opacity: 0;
    transform: translateY(-20px);
    transition:
      opacity 300ms,
      transform 300ms;
  }
}

@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 0 0% 3.9%;
    --card: 0 0% 100%;
    --card-foreground: 0 0% 3.9%;
    --popover: 0 0% 100%;
    --popover-foreground: 0 0% 3.9%;
    --primary: 0 0% 9%;
    --primary-foreground: 0 0% 98%;
    --secondary: 0 0% 96.1%;
    --secondary-foreground: 0 0% 9%;
    --muted: 0 0% 96.1%;
    --muted-foreground: 0 0% 45.1%;
    --accent: 0 0% 96.1%;
    --accent-foreground: 0 0% 9%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 0 0% 98%;
    --border: 0 0% 89.8%;
    --input: 0 0% 89.8%;
    --ring: 0 0% 3.9%;
    --chart-1: 12 76% 61%;
    --chart-2: 173 58% 39%;
    --chart-3: 197 37% 24%;
    --chart-4: 43 74% 66%;
    --chart-5: 27 87% 67%;
    --radius: 0.5rem;}
  .dark {
    --background: 0 0% 3.9%;
    --foreground: 0 0% 98%;
    --card: 0 0% 3.9%;
    --card-foreground: 0 0% 98%;
    --popover: 0 0% 3.9%;
    --popover-foreground: 0 0% 98%;
    --primary: 0 0% 98%;
    --primary-foreground: 0 0% 9%;
    --secondary: 0 0% 14.9%;
    --secondary-foreground: 0 0% 98%;
    --muted: 0 0% 14.9%;
    --muted-foreground: 0 0% 63.9%;
    --accent: 0 0% 14.9%;
    --accent-foreground: 0 0% 98%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 0 0% 98%;
    --border: 0 0% 14.9%;
    --input: 0 0% 14.9%;
    --ring: 0 0% 83.1%;
    --chart-1: 220 70% 50%;
    --chart-2: 160 60% 45%;
    --chart-3: 30 80% 55%;
    --chart-4: 280 65% 60%;
    --chart-5: 340 75% 55%;}}

@layer base {
  * {
    @apply border-border;}
  body {
    @apply bg-background text-foreground;}}

    /* Flipcard 3D Animation Styles */
.flipcard-container {
  perspective: 1000px;
}

.flipcard-inner {
  position: relative;
  width: 100%;
  height: 100%;
  text-align: center;
  transition: transform 0.7s ease-in-out;
  transform-style: preserve-3d;
}

.flipcard-inner.flipped {
  transform: rotateY(180deg);
}

.flipcard-front,
.flipcard-back {
  position: absolute;
  width: 100%;
  height: 100%;
  -webkit-backface-visibility: hidden;
  backface-visibility: hidden;
  border-radius: 12px;
}

.flipcard-back {
  transform: rotateY(180deg);
}

/* AI Canva Bubble Menu Styles */
.ai-canva-bubble-menu {
  position: fixed !important;
  z-index: 9999 !important;
  pointer-events: auto !important;
}

/* Ensure tippy tooltip doesn't affect layout */
.tippy-box[data-theme~='ai-canva'] {
  position: fixed !important;
  z-index: 9999 !important;
}

/* Prevent layout shifts from bubble menu */
.ProseMirror .ai-canva-bubble-menu,
.ProseMirror .tippy-box {
  position: fixed !important;
  transform: none !important;
}


================================================
FILE: apps/web/types/next-auth.d.ts
================================================
// eslint-disable-next-line unused-imports/no-unused-imports
import type { NextAuthOptions } from 'next-auth/index';

// next-auth.d.ts
declare module 'next-auth' {
  interface Session {
    user: any | undefined
    roles?: string[] | undefined
    tokens?:
      | {
          access_token?: string | undefined
          refresh_token?: string | undefined
        }
      | undefined
  }
}



================================================
FILE: apps/web/types/react-plyr.d.ts
================================================
declare module 'react-plyr' {
  import { Component } from 'react'

  interface PlyrProps {
    source: {
      type: string
      sources: Array<{
        src: string
        type: string
      }>
    }
    options?: any
    onReady?: () => void
  }

  export default class Plyr extends Component<PlyrProps> {}
} 


================================================
FILE: extra/nginx.conf
================================================
server {
    listen 80;
    server_name localhost;
    client_max_body_size 500M;

    # Increase header buffer size
    large_client_header_buffers 4 32k;

    # Increase the maximum allowed size of the client request body
    client_body_buffer_size 32k;

    # Increase the maximum allowed size of the client request header fields
    client_header_buffer_size 32k;

    # NextJS Revalidation 
    location /api/revalidate {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Next Auth
    location /api/auth {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Python Backend API
    location /api/v1 {
        proxy_pass http://localhost:9000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Backend Static Content
    location /content {
        proxy_pass http://localhost:9000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # FastAPI Docs (only available in development mode)
    location /api/v1/docs {
        proxy_pass http://localhost:9000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # FastAPI ReDoc (only available in development mode)
    location /api/v1/redoc {
        proxy_pass http://localhost:9000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Frontend 
    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}


================================================
FILE: extra/start.sh
================================================
#!/bin/sh

# Set environment variables for proper Python logging
export PYTHONUNBUFFERED=1
export PYTHONIOENCODING=utf-8

# Wait for database and redis if connection strings point to external services
# (In docker-compose, depends_on handles this, but useful for standalone)
if [ -n "$LEARNHOUSE_SQL_CONNECTION_STRING" ]; then
    DB_HOST=$(echo "$LEARNHOUSE_SQL_CONNECTION_STRING" | sed -n 's/.*@\([^:]*\):\([0-9]*\)\/.*/\1/p')
    if [ -n "$DB_HOST" ] && [ "$DB_HOST" != "localhost" ] && [ "$DB_HOST" != "127.0.0.1" ] && [ "$DB_HOST" != "db" ]; then
        echo "Waiting for external database at $DB_HOST..."
        timeout 30 sh -c 'until nc -z '"$DB_HOST"' 5432; do sleep 1; done' || true
    fi
fi

# Start the services
# Use server-wrapper.js for runtime environment variable injection
pm2 start server-wrapper.js --cwd /app/web --name learnhouse-web > /dev/null 2>&1
pm2 start uv --cwd /app/api --name learnhouse-api -- run app.py

# Check if the services are running and log the status
pm2 status

# Start Nginx in the background
nginx -g 'daemon off;' &

# Tail PM2 logs with proper formatting
pm2 logs --raw



================================================
FILE: .github/ISSUE_TEMPLATE/bug.yml
================================================
name: Bug Report
description: File a bug report
title: "[Bug]: "
labels: ["bug", "triage"]
body:
  - type: markdown
    attributes:
      value: |
        Thanks for taking the time to fill out this bug report!
  - type: input
    id: contact
    attributes:
      label: Contact Details
      description: How can we get in touch with you if we need more info?
      placeholder: ex. email@example.com
    validations:
      required: false
  - type: textarea
    id: what-happened
    attributes:
      label: What happened?
      description: Also tell us, what did you expect to happen?
      placeholder: Tell us what you see!
      value: "A bug happened!"
    validations:
      required: true
  - type: input
    id: version
    attributes:
      label: Version
      description: What version of our software are you running?
      placeholder: ex. 0.1.0
    validations:
      required: true
  - type: dropdown
    id: browsers
    attributes:
      label: What browsers are you seeing the problem on?
      multiple: true
      options:
        - Firefox
        - Chrome
        - Safari
        - Arc Browser 
  - type: textarea
    id: logs
    attributes:
      label: Relevant log output
      description: Please copy and paste any relevant log output. This will be automatically formatted into code, so no need for backticks.
      render: bash
  - type: checkboxes
    id: terms
    attributes:
      label: Code of Conduct
      description: By submitting this issue, you agree to follow our Code of Conduct.
      options:
        - label: I agree to follow this project's Code of Conduct
          required: true


================================================
FILE: .github/ISSUE_TEMPLATE/config.yml
================================================
blank_issues_enabled: false
contact_links:
  - name: Security Contact
    about: Please report security vulnerabilities to security@learnhouse.app
  - name: Question or Problem
    about: Ask a question or ask about a problem in GitHub Discussions.
    url: https://github.com/learnhouse/learnhouse/discussions/categories/questions
  - name: Feature Request
    about: To suggest an idea or ask about a feature, please start with a question saying what you would like to achieve. There might be a way to do it already.
    url: https://github.com/learnhouse/learnhouse/discussions/categories/questions
  - name: Show and tell
    about: Show what you built with LearnHouse or to be used with LearnHouse.
    url: https://github.com/learnhouse/learnhouse/discussions/categories/show-and-tell



================================================
FILE: .github/ISSUE_TEMPLATE/team.yml
================================================
name: Team
description: You are someone from the team
labels: ["team"]
body:
  - type: textarea
    id: content
    attributes:
      label: Issue Content
      description: Add the content of the issue here.
  - type: checkboxes
    attributes:
      label: Is this issue planned ?
      options:
        - label: Planned
          



================================================
FILE: .github/ISSUE_TEMPLATE/verified.yml
================================================
name: Verified
description: Someone from the team allowed you to create an issue here
body:
  - type: markdown
    attributes:
      value: |
        Thanks for your interest in LearnHouse ğŸ’–

        If you are not someone from the team or the team didn't ask you directly to create an issue here, please start the conversation in a [Question in GitHub Discussions](https://github.com/learnhouse/learnhouse/discussions/categories/questions) instead.
  - type: checkboxes
    id: verified
    attributes:
      label: Verified issue
      description: Confirm that you are allowed to create an issue here.
      options:
        - label: Someone from the team allowed me to create an issue here
          required: true
  - type: textarea
    id: content
    attributes:
      label: Issue Content
      description: Add the content of the issue here.


================================================
FILE: .github/workflows/api-lint.yaml
================================================
name: API Lint
on:
  push:
    branches:
      - dev
    paths:
      - "apps/api/**"
  pull_request:
    paths:
      - "apps/api/**"
jobs:
  ruff:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Ruff lint
        uses: chartboost/ruff-action@v1
        with:
          src: "./apps/api"



================================================
FILE: .github/workflows/api-tests.yaml
================================================
name: API Tests
permissions:
  contents: read
on:
  push:
    branches:
      - dev
    paths:
      - "apps/api/**"
  pull_request:
    paths:
      - "apps/api/**"
jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v2
        with:
          version: latest

      - name: Install dependencies
        run: |
          cd apps/api
          uv sync

      - name: Run tests
        run: |
          cd apps/api
          uv run pytest src/tests/ -v --tb=short
        env:
          TESTING: "true"

      - name: Run security tests with coverage
        run: |
          cd apps/api
          uv run pytest src/tests/security/ --cov=src.security --cov-report=html --cov-report=term-missing
        env:
          TESTING: "true"

      - name: Upload coverage report to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: apps/api/htmlcov/
          retention-days: 30



================================================
FILE: .github/workflows/docker-build.yaml
================================================
name: App Build
on:
  push:
    branches:
      - dev
    paths:
      - "**"
  pull_request:
    paths:
      - "**"

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: app

jobs:
  build:
    name: Build ${{ matrix.platform }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        platform:
          - linux/amd64
          - linux/arm64
    steps:
      - uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get short SHA and branch
        id: vars
        run: |
          SHORT=$(echo ${{ github.sha }} | cut -c1-7)
          echo "short=$SHORT" >> $GITHUB_OUTPUT
          if [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref }}" == "refs/heads/dev" ]; then
            echo "branch=dev" >> $GITHUB_OUTPUT
            echo "tag_prefix=dev" >> $GITHUB_OUTPUT
          else
            echo "branch=pr" >> $GITHUB_OUTPUT
            echo "tag_prefix=pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.vars.outputs.short }}-${{ matrix.platform == 'linux/amd64' && 'amd64' || 'arm64' }}
            type=raw,value=${{ steps.vars.outputs.tag_prefix }}-${{ matrix.platform == 'linux/amd64' && 'amd64' || 'arm64' }}
            type=raw,value=${{ steps.vars.outputs.tag_prefix }}-${{ steps.vars.outputs.short }}-${{ matrix.platform == 'linux/amd64' && 'amd64' || 'arm64' }}

      - name: Build and push platform-specific image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: ${{ matrix.platform }}
          cache-from: type=gha,scope=${{ matrix.platform }}
          cache-to: type=gha,mode=max,scope=${{ matrix.platform }}
          build-args: |
            BUILDKIT_INLINE_CACHE=1

  manifest:
    name: Create and push manifest
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      packages: write
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get short SHA and branch
        id: vars
        run: |
          echo "short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          if [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref }}" == "refs/heads/dev" ]; then
            echo "tag_prefix=dev" >> $GITHUB_OUTPUT
          else
            echo "tag_prefix=pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Extract metadata for manifest
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.vars.outputs.short }}
            type=raw,value=${{ steps.vars.outputs.tag_prefix }}
            type=raw,value=${{ steps.vars.outputs.tag_prefix }}-${{ steps.vars.outputs.short }}
            type=raw,value=latest,enable=${{ github.event_name == 'push' && github.ref == 'refs/heads/dev' }}

      - name: Create and push manifest list
        run: |
          SHORT_SHA="${{ steps.vars.outputs.short }}"
          TAG_PREFIX="${{ steps.vars.outputs.tag_prefix }}"
          IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}"

          # Create manifest list for each tag
          for TAG in "$SHORT_SHA" "$TAG_PREFIX" "${TAG_PREFIX}-${SHORT_SHA}"; do
            docker buildx imagetools create --tag "${IMAGE}:${TAG}" \
              "${IMAGE}:${TAG}-amd64" \
              "${IMAGE}:${TAG}-arm64"
          done

          # Create latest tag if on dev branch
          if [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref }}" == "refs/heads/dev" ]; then
            docker buildx imagetools create --tag "${IMAGE}:latest" \
              "${IMAGE}:${SHORT_SHA}-amd64" \
              "${IMAGE}:${SHORT_SHA}-arm64"
          fi

  dispatch:
    name: Repository Dispatch
    needs: manifest
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' && github.ref == 'refs/heads/dev') || github.event_name == 'pull_request'
    permissions:
      contents: read
    steps:
      - name: Repository Dispatch
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.TRIGGER_PAT_TOKEN }}
          repository: learnhouse/images
          event-type: build-images
          client-payload: |
            {
              "ref": "${{ github.sha }}",
              "branch": "${{ github.head_ref || github.ref_name }}"
            }



================================================
FILE: .github/workflows/web-lint.yaml
================================================
name: Web Lint
on:
  push:
    branches:
      - dev
    paths:
      - "apps/web/**"
  pull_request:
    paths:
      - "apps/web/**"
jobs:
  next-lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18]
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install
        working-directory: ./apps/web
      - name: Lint
        run: pnpm run lint
        working-directory: ./apps/web


